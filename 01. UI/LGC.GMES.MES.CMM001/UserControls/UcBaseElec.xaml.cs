/*************************************************************************************
 Created Date : 2023.03.07
      Creator : 
   Decription : 전지 5MEGA-GMES 구축 - 공정진척화면의 작업지시 공통 화면
--------------------------------------------------------------------------------------
 [Change History]
  2023.03.07  김대현 : 품질정보 탭 입력 후 Spec Out 존재시 팝업 발생
                       동별 자주검사 항목 필수 검사 항목 여부 체크된 항목에 대해 Validation 추가
  2023.03.15  김대현 : 필수값 체크시 0은 입력가능하도록 Validation 수정
  2023.03.27  이호섭 : 길이초과 부족 자동 계산 로직 보완(SLT 공정)
  2023.06.20  정재홍 : [E20230525-001029] - [Electrode] Eliminating GMES Input human error by PLC Automatic calculation [길이부족/길이초과]
  2023.08.31  신광희 : 롤프레스 공정 수불 미적용 롤맵 설비 인 경우 HOLD 조건 부합 시 롤맵 홀드 팝업 호출 적용
  2023.09.05  임재형 : 롤맵 홀드 조건 및 노트 추가 
  2023.09.07  김도형 : [E20230807-000061] speical work-LOT MERGE improvement
  2023.09.18  김도형 : [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization 
  2023.11.23  김도형 : [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청
  2023.12.12  김도형 : [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청(동별공통코드 그룹코드명 변경)
  2023.12.13  조성근 : 롤맵 코터 수불 실적 적용
  2023.12.26  유명환 : [E20231215-001691] 믹서 공정진척 메뉴 – 생산실적 저장 시 이전 배치 실적(생산량)과 300kg 이상 차이 날 시, 확인 메시지 팝업 요청
  2024.01.04  유명환 : [E20231218-000319] 롤프레스 공정진척 메뉴 – 소형 4동 NFF 4680 전극 롤프레스 착공 후 알람기능 추가 요청의 건
  2024.01.25  김영택 : 불량/LOSS/물품청구 내역에 허용비율(%) 추가, 실적확정시 허용비율 초과시 사유 기재 팝업 실행
  2024.02.19  조성근 : 롤맵 코터 수불 실적 적용 - TEST CUT 체크 추가
  2024.02.22  김영택 : 선분산믹서, 믹서 공정 - 실적확정시 허용비율 초과 사유 입력 팝업 실행 
  2024.02.26  조성근 : TEST CUT 체크관련 주석처리
  2024.02.26  김영택 : 선분산믹서, 믹서 공정 - 실적확정시 허용비율 초과 사유 입력 팝업 실행 테스트 및 수정
  2024.03.12  김영택 : 코터, 단면코터, 절연코터, 롤프레싱, 슬리터, 하프슬리터, 테이핑, 열처리, 2차슬리터 공정진척 - 실적확정시 허용비율 초과 사유 입력 팝업 실행 테스트 및 수정
  2024.03.13  김영택 : 코터 공정 일부 수정 
  2024.02.20  조범모 : [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 추가 요청 건
  2024.03.26  조성근 : 4분할 화면 코터공정 테스트컷 사용시 입력여부 체크
  2024.05.03  조범모 : [E20240428-001991] TWS 로딩량 추적관리 업무개선 요청 건
  2024.05.30  백상우 : [E20240502-001076] Mixer 원재료 Tracking 기능 개선 : Mixer 원재료 Lot 누락 Validation 기능 적용 여부
  2024.07.04  유명환 : [E20240522-001088] 코터공정진척 더블레이어 슬러리 입력 가능하도록 수정
  2024.07.04  유명환 : [E20240522-001088] 코터공정진척 더블레이어 슬러리 입력 가능하도록 수정 
  2024.07.15  조범모 : [E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
  2024.07.15  조범모 : [E20240722-000098] [소형파우치형전극기술P] TWS-GMES 연동 시스템 수정 업데이트 요청 건(3rd)
  2024.07.25  이원열 : [E20240712-001591] 공정진척 & 실적확정 투입lot 조회 validation 추가(대체자제) 
  2024.08.20  유명환 : [E20240717-000286] MES 시스템의 전극 LOT별 로딩량 데이터 연동
  2024.08.27  조성근 : [E20240827-000372] - 롤프레스 롤맵 실적 수정팝업 추가
**************************************************************************************/

using System;
using System.Collections.Generic;
using System.Data;
using System.Threading;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using C1.WPF;
using C1.WPF.DataGrid;
using C1.WPF.DateTimeEditors;
using C1.WPF.DataGrid.Summaries;
using LGC.GMES.MES.CMM001.Class;
using LGC.GMES.MES.CMM001.Models;
using LGC.GMES.MES.CMM001.Popup;
using LGC.GMES.MES.Common;
using LGC.GMES.MES.ControlsLibrary;
using System.Linq;
using LGC.GMES.MES.CMM001.Extensions;
using System.Globalization;
using System.Windows.Media.Animation;
using System.Windows.Data;

namespace LGC.GMES.MES.CMM001.UserControls
{
    /// <summary>
    /// UcBaseElec.xaml에 대한 상호 작용 논리
    /// </summary>
    public partial class UcBaseElec
    {
        #region Fields  
        string procId;
        
        C1DataGrid dgLotInfo;

        string _RemarkHoldUseFlag = "N"; // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization

        private readonly DispatcherTimer _rollPressTimer = new DispatcherTimer();
        #endregion Fields

        #region Properties
        public string PROCID
        {
            get
            {
                return procId;
            }
            set
            {
                procId = value;

                if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) )
                {
                    // _RemarkHoldUseFlag = GetProcRemarkHoldUseFlag(); // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
                    _RemarkHoldUseFlag = "Y";  // 비고 HOLD 사용여부 (REMARK_HOLD_USE_FLAG) 미적용 - 전법인 일괄 적용(2023.09.22)
                }

                SetComboBox();
                SetGrids();
                SetTabItems();
                SetResultDetail();
                SetTextBox();
                SetEvents();
                SetStatus();
                SetSingleCoaterControl();
                SetVisible();
                SetIdentInfo();
                SetRollMapEquipment();

                if (procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.MIXING) || procId.Equals(Process.SRS_MIXING))
                {
                    (grdCommand.Children[0] as UcCommand).btnBarcodeLabel.Visibility = Visibility.Collapsed;
                    (grdCommand.Children[0] as UcCommand).btnHistoryCard.Visibility = Visibility.Collapsed;
                    //(grdCommand.Children[0] as UcCommand).btnPrintLabel.Visibility = Visibility.Collapsed;
                    (grdCommand.Children[0] as UcCommand).btnMixConfirm.Visibility = Visibility.Visible;
                    (grdCommand.Children[0] as UcCommand).btnCancelFCut.Visibility = Visibility.Visible;
                    (grdCommand.Children[0] as UcCommand).btnInvoiceMaterial.Visibility = Visibility.Visible;
                    CHECK_WAIT.Visibility = Visibility.Collapsed;
                    grdWorkOrder.Children.Clear();
                    grdWorkOrder.Children.Add(new UC_WORKORDER_MX());
                }

                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING)) /* COATER 임의 CUT 생성 메뉴 추가 */
                {
                    (grdCommand.Children[0] as UcCommand).btnCleanLot.Visibility = Visibility.Visible;
                    (grdCommand.Children[0] as UcCommand).btnCancelFCut.Visibility = Visibility.Visible;
                    (grdCommand.Children[0] as UcCommand).btnStartCoaterCut.Visibility = Visibility.Visible;
                    (grdCommand.Children[0] as UcCommand).btnInvoiceMaterial.Visibility = Visibility.Visible;
                }

                if (string.Equals(procId, Process.HALF_SLITTING) || string.Equals(procId, Process.ROLL_PRESSING))   /* HALF SLITTING, ROLL PRESS CUT메뉴 추가 */
                    (grdCommand.Children[0] as UcCommand).btnCut.Visibility = Visibility.Visible;

                # region [Sampling]
                // R/P공정이고 자동차 1,2동일 경우 해당 제품 SAMPLING 등록 메뉴 사용 [2017-07-17]
                // 슬리터2차 추가 2021-09-15 by 오화백
                // 2022-12-29  EP 동추가
                if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING)) || string.Equals(procId,"E4200") && (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6")|| string.Equals(LoginInfo.CFG_AREA_ID, "EP")))
                    (grdCommand.Children[0] as UcCommand).btnSamplingProdT1.Visibility = Visibility.Visible;
                #endregion

                // 슬리터 공정 Port별 Skid Type 설정 팝업추가
                // 소형동 출하모델 팝업 추가
                // 슬리터2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                {
                    // 적용대상 동은 오창 자동차 전극
                    // 2022-12-29 EP 동추가
                    if (LoginInfo.CFG_AREA_ID.Equals("E6") || LoginInfo.CFG_AREA_ID.Equals("E5") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                    {
                        (grdCommand.Children[0] as UcCommand).btnSlBatch.Visibility = Visibility.Visible;
                    }
                    // 적용대상 동은 CNB 전극1동, CWA 전극2동
                    if (LoginInfo.CFG_AREA_ID.Equals("EC") || LoginInfo.CFG_AREA_ID.Equals("ED"))
                    {
                        (grdCommand.Children[0] as UcCommand).btnSkidTypeSettingByPort.Visibility = Visibility.Visible;
                    }

                    // 적용대상 동
                    if (IsCommoncodeUse("SHIPMENTMODEL", LoginInfo.CFG_AREA_ID))
                    {
                        (grdCommand.Children[0] as UcCommand).btnShipmentModel.Visibility = Visibility.Visible;
                    }
                }

                // R/P공정 이동 기능 추가 [2017-08-04]
                if (string.Equals(procId, Process.ROLL_PRESSING))
                {
                    (grdCommand.Children[0] as UcCommand).btnProcReturn.Visibility = Visibility.Visible;

                    if (string.Equals(LoginInfo.CFG_AREA_ID, "EB") || string.Equals(LoginInfo.CFG_AREA_ID, "ED"))
                        (grdCommand.Children[0] as UcCommand).btnMixConfirm.Visibility = Visibility.Visible;

                    //롤프레스 공정 착공 후 특정시간 이상 미 포장시 팝업 
                    CheckRollPressAlarm();
                }

                // 믹서, 절연코터, INS코터 PC는 생산량 입력못하게 변경 [2017-02-09]
                // 하프슬리터도 변경 못하게 추가 [2017-05-23]
                // 열처리공정 추가 [2018-05-31]
                //if (string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.SRS_MIXING) ||
                if (string.Equals(procId, Process.BACK_WINDER) || string.Equals(procId, Process.INS_SLIT_COATING) || string.Equals(procId, Process.HALF_SLITTING) ||
                    string.Equals(procId, Process.SRS_MIXING) || String.Equals(procId, Process.HEAT_TREATMENT))
                    txtInputQty.IsReadOnly = true;

                //if ((!isSingleCoater && procId.Equals(Process.COATING)) || procId.Equals(Process.SRS_COATING) || (isSingleCoater && procId.Equals(Process.COATING) && COATTYPE_COMBO.SelectedValue.Equals("T")))
                if (procId.Equals(Process.COATING) || procId.Equals(Process.SRS_COATING))
                    CHECK_WAIT.Visibility = Visibility.Collapsed;

                CHECK_WOPRODUCT.Visibility = Visibility.Collapsed;

                // 투입량의 초과입력률 체크하기 위하여 추가
                string sConvRate = GetCommonCode("INPUTQTY_OVER_RATE", "ELEC_OVER_RATE");
                inputOverrate = string.IsNullOrEmpty(sConvRate) ? -1 : (Util.NVC_Decimal(sConvRate) * Util.NVC_Decimal(0.01));

                // 변환률 기본값 설정
                convRate = 1;

                // 롤프레스 평균값
                if (!string.Equals(procId, Process.ROLL_PRESSING))
                    (grdDataCollect.Children[0] as UcDataCollect).dgQuality.BottomRows.Clear();

                // 슬리터 기본 설정 (소형 체크로직을 Setting에서 불러와서 사용)
                // 슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING) || string.Equals(procId, "E4200"))
                    if (LoginInfo.CFG_ETC != null && LoginInfo.CFG_ETC.Rows.Count > 0)
                        (grdDataCollect.Children[0] as UcDataCollect).chkSum.IsChecked = Convert.ToBoolean(LoginInfo.CFG_ETC.Rows[0][CustomConfig.CONFIGTABLE_ETC_SMALLTYPE]);

                // 코터 공정인 경우 슬러리 정보 팝업 기능 추가.
                if (procId.Equals(Process.COATING))
                {
                    (grdCommand.Children[0] as UcCommand).btnMixerTankInfo.Visibility = Visibility.Visible;

                    if (string.Equals(LoginInfo.CFG_AREA_ID, "EB") || string.Equals(LoginInfo.CFG_AREA_ID, "ED"))
                        (grdCommand.Children[0] as UcCommand).btnMixConfirm.Visibility = Visibility.Visible;
                }

                // 믹서공정슬러리 물성정보 팝업
                if (string.Equals(procId, Process.MIXING))
                {
                    (grdCommand.Children[0] as UcCommand).btnSlurryConf.Visibility = Visibility.Visible;

                    // 믹스 실적 확정 메시지 Timer CSR[C20201014-000233] 2020.11.27
                    //Mix_Timer.Interval = TimeSpan.FromSeconds(20d); //TEST
                    Mix_Timer.Interval = TimeSpan.FromMinutes(5d); //5분 간격으로 설정
                    Mix_Timer.Tick += MixTimer_Tick;
                }

                //2021.05.27 무지부 방향 설정
                isManageSlittingSide = IsAreaCommonCodeUse("MNG_SLITTING_SIDE_AREA", procId);

                if (isManageSlittingSide)
                {
                    (grdCommand.Children[0] as UcCommand).btnWorkHalfSlitSide.Visibility = Visibility.Visible;
                }

                if (procId.Equals(Process.COATING))
                {
                    isEQPTDoubleLayer = GetisEQPTDoubleLayer();
                }
            }
        }

        bool isRefresh;
        public bool REFRESH
        {
            get
            {
                return isRefresh;
            }
            set
            {
                isRefresh = value;

                if (isRefresh)
                {
                    if (isConfirm && LOTINFO_GRID.GetRowCount() > 0)
                    {
                        txtEndLotId.Text = Util.NVC((LOTINFO_GRID.ItemsSource as DataView).Table.Rows[0]["LOTID"]);
                        txtEndLotId.Tag = _CUTID;

                        //[E20230116-000362] 소형3동 하프슬리터 공정 이력카드 출력 기능 개선 건(이력카드 LOT별 출력) 
                        DataTable ConfirmDT = new DataTable();
                        ConfirmDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                        // INOUT LOT이 수량 연계되는 문제가 발생할 여지가 있어서 저장된 수량 초기화 [2017-04-22]
                        SetInitProductQty();

                        // W/O 자동 변경을 위한 BIZ 호출 [MO등록해서 쓰는것들은 이제 사용 안함 2017-10-13]
                        string confirmMsg = string.Empty;   // 실적확정 INFORM MESSAGE
                        if (string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.SRS_MIXING) || 
                            string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING))
                            confirmMsg = IsAutoChangeWorkOrder();

                        // W/O 계획수량 대비 생산수량 체크 [요청으로 인하여 주석 처리]
                        /*
                        bool isWorkValid = ValidaWorkOrderPlanQty();

                        if (string.IsNullOrEmpty(confirmMsg) && isWorkValid == true)
                            confirmMsg = MessageDic.Instance.GetMessage("SFU3360");
                        */

                        confirmMsg += string.IsNullOrEmpty(confirmMsg) ? MessageDic.Instance.GetMessage("SFU1275") : ("\n\n" + MessageDic.Instance.GetMessage("SFU1275"));

                        #region [Samplin용 라벨 발행]
                        // SAMPLING용 발행 매수 추가
                        int iSamplingCount;

                        DataTable LabelDT = new DataTable();
                        LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                        if (LoginInfo.CFG_LABEL_AUTO.Equals("Y"))
                        {
                            //슬리터 2차 추가 2021-09-15 by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                            {
                                DataTable sampleDT = new DataTable();
                                sampleDT.Columns.Add("CUT_ID", typeof(string));
                                sampleDT.Columns.Add("LOTID", typeof(string));
                                sampleDT.Columns.Add("COMPANY", typeof(string));
                                DataRow dRow = null;

                                foreach (DataRow _iRow in LabelDT.Rows)
                                {
                                    iSamplingCount = 0;
                                    string[] sCompany = null;
                                    foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                    {
                                        //iSamplingCount = Util.NVC_Int(items.Key);
                                        if (string.Equals(procId, Process.SLITTING))  //  C20221212-000326 
                                        {
                                            if (string.Equals(getQAInspectFlag(Util.NVC(_iRow["LOTID"])), "Y"))
                                            {
                                                iSamplingCount = Util.NVC_Int(items.Key) + GetProcSmplBarPrtFlagAttribute3(); // C20221212-000326 슬리터 샘플링 시 바코드 추가 발행건수
                                            }
                                            else
                                            {
                                                iSamplingCount = Util.NVC_Int(items.Key);
                                            }
                                        }
                                        else
                                        {
                                            iSamplingCount = Util.NVC_Int(items.Key);
                                        }
                                        sCompany = Util.NVC(items.Value).Split(',');
                                    }
                                    for (int i = 0; i < iSamplingCount; i++)
                                    {
                                        dRow = sampleDT.NewRow();
                                        dRow["CUT_ID"] = _iRow["CUT_ID"];
                                        dRow["LOTID"] = _iRow["LOTID"];
                                        dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                        sampleDT.Rows.Add(dRow);
                                    }
                                }

                                var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                                for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                                    for (int i = 0; i < sortdt.Rows.Count; i++)
                                        Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                            }
                            else
                            {
                                //C20210415-000402 [2021-06-22]
                                int iFirstCutCNT = 0;

                                if (string.Equals(procId, Process.COATING) && (_CUT == "1"))
                                    iFirstCutCNT = LoginInfo.CFG_LABEL_FIRST_CUT_COPIES;
                                                              

                                for (int ii = 0; ii < (LoginInfo.CFG_LABEL_COPIES + iFirstCutCNT); ii++)
                                    foreach (DataRow _iRow in LabelDT.Rows)
                                    {
                                        iSamplingCount = 0;
                                        string[] sCompany = null;
                                        foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                        {
                                            iSamplingCount = Util.NVC_Int(items.Key);
                                            sCompany = Util.NVC(items.Value).Split(',');
                                        }

                                        for (int i = 0; i < iSamplingCount; i++)
                                            Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId, i > sCompany.Length - 1 ? "" : sCompany[i]);
                                    }
                            }
                        }

                        #endregion

                        LGC.GMES.MES.ControlsLibrary.MessageBox.Show(confirmMsg, null, "Info", MessageBoxButton.OK, MessageBoxIcon.None, (vResult) =>
                        {
                            if (vResult == MessageBoxResult.OK)
                            {
                                if (!string.Equals(procId, Process.SRS_MIXING) && !string.Equals(procId, Process.PRE_MIXING))
                                {
                                    // 열처리공정 추가로 인하여 아래와 같이 자동발행 변경처리 [2018-06-05]
                                    if (string.Equals(procId, Process.HEAT_TREATMENT))
                                    {
                                        if (IsHeatProcessPrintOutCheck(txtEndLotId.Text) == true)
                                            if (string.Equals(LoginInfo.CFG_CARD_POPUP, "Y") || string.Equals(LoginInfo.CFG_CARD_AUTO, "Y"))
                                                OnClickHistoryCard(null, null);
                                    }
                                    else
                                    {
                                        if (string.Equals(LoginInfo.CFG_CARD_POPUP, "Y") || string.Equals(LoginInfo.CFG_CARD_AUTO, "Y"))
                                        {
                                            //[E20230116-000362] 소형3동 하프슬리터 공정 이력카드 출력 기능 개선 건(이력카드 LOT별 출력)
                                            if (string.Equals(procId, Process.HALF_SLITTING))
                                            {
                                                foreach (DataRow _iRow in ConfirmDT.Rows)
                                                {
                                                    txtEndLotId.Text = Util.NVC(_iRow["LOTID"]);
                                                    OnClickHistoryCard(null, null);
                                                }
                                            }
                                            else
                                            {
                                                OnClickHistoryCard(null, null);
                                            }
                                        }
                                    }
                                }
                            }

                            // 실적 확정 후 저장되였습니다. 완료 후 실행
                            // CSR : [C20211216-000385] - Coater slurry replacement and MMD conversion management
                            // 코터 공정만 실행
                            if (isSlurryPopup && string.Equals(procId, Process.COATING))
                                GetCoaterSlurryPopup(txtEndLotId.Text);

                        });
                        isConfirm = false;
                    }
                    if (CHECK_WAIT.Visibility == Visibility.Collapsed || WIPSTATUS.Equals(Wip_State.WAIT))
                        CHECK_RUN.IsChecked = true;

                    Thread.Sleep(500);

                    if (LARGELOT_GRID.Visibility == Visibility.Visible)
                    {
                        GetLargeLot();

                        if (LARGELOT_GRID.Rows.Count > 0)
                        {
                            DataTableConverter.SetValue(LARGELOT_GRID.Rows[0].DataItem, "CHK", true);
                            LARGELOT_GRID.SelectedIndex = 0;
                            LARGELOTID = Util.NVC(DataTableConverter.GetValue(LARGELOT_GRID.Rows[0].DataItem, "LOTID_LARGE"));
                        }
                        else
                        {
                            // 대lot Clear 2016.12.06 **********
                            LARGELOTID = string.Empty;
                            //**********************************
                        }
                    }

                    if (LARGELOT_GRID.Visibility == Visibility.Visible && LARGELOT_GRID.Rows.Count > 0 && LARGELOT_GRID.SelectedIndex > -1)
                        GetProductLot(LARGELOT_GRID.Rows[LARGELOT_GRID.SelectedIndex].DataItem as DataRowView);
                    else if (LARGELOT_GRID.Visibility != Visibility.Visible)
                        GetProductLot();

                    // SHIFT_CODE, SHIFT_USER 자동 SET
                    GetWrkShftUser();

                    // (C20200423-000245) 단면코더 작업지시 변경 시 Core 자동탈착(PRDT_CLSS_CODE : APC, INPUT_LOTID : B1으로 끝나는 LOTID)
                    if (isSingleCoater && string.Equals(Util.NVC(COATTYPE_COMBO.SelectedValue), "B"))
                    {
                        if (_FINDWOID != GetEioAttr(Util.NVC(EQUIPMENT_COMBO.SelectedValue)))
                        {
                            DataTable dt = GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
                            if (dt.Rows.Count > 0)
                            {
                                foreach (DataRow _iRow in dt.Select("PRDT_CLSS_CODE = 'APC'"))
                                    if (string.Equals(_Util.Right(Util.NVC(_iRow["INPUT_LOTID"]),2),"B1"))
                                        SetUnMountTopCore(Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]));
                            }
                            _FINDWOID = Util.NVC(DataTableConverter.GetValue(WORKORDER_GRID.Rows[0].DataItem, "WOID"));
                        }
                    }

                    // COATER공정에서 CORE, SLURRY 조회, SRS코터에서 BATCH ID 자동 조회 및 SETUP
                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                    {
                        if (isSingleCoater)
                            GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));
                        else
                            GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), "");
                    }
                    else if (string.Equals(procId, Process.SRS_COATING))
                    {
                        GetSlurry();
                    }

                    // CSR : C20210720-000108
                    if (isRollDirCtn)
                        GetRollDir();
                }
            }
        }
        bool isEQPTDoubleLayer;
        bool isDoubleLayer = false;
        public bool DOUBLELAYER
        {
            get
            {
                return isDoubleLayer;
            }
            set
            {
                isDoubleLayer = value;
            }
        }


        bool isSingleCoater;
        public bool SINGLECOATER
        {
            get
            {
                return isSingleCoater;
            }
            set
            {
                isSingleCoater = value;
            }
        }

        public string LOTID { get; set; }
        public string LARGELOTID { get; set; }
        public string PRLOTID { get; set; }
        public string WO_DETL_ID { get; set; }
        public Button STARTBUTTON { get; set; }
        public Button SEARCHBUTTON { get; set; }
        public Button INVOICEBUTTON { get; set; }
        public string WIPSTATUS { get; set; }
        public C1ComboBox EQUIPMENT_COMBO { get; set; }
        public C1ComboBox EQUIPMENTSEGMENT_COMBO { get; set; }
        public C1ComboBox COATTYPE_COMBO { get; set; }
        public C1ComboBox LANENUM_COMBO { get; set; }
        public C1ComboBox COLOR_COMBO { get; set; }
        public CheckBox CHECK_WAIT { get; set; }
        public CheckBox CHECK_RUN { get; set; }
        public CheckBox CHECK_END { get; set; }
        public CheckBox CHECK_WOPRODUCT { get; set; }
        public object WORKORDER { get; set; }
        public C1DataGrid LARGELOT_GRID { get; set; }
        public C1DataGrid PRODLOT_GRID { get; set; }
        public C1DataGrid LOTINFO_GRID
        {
            get { return dgLotInfo; }
            set { dgLotInfo = value; }
        }
        public C1DataGrid WIPREASON_GRID { get; set; }
        public C1DataGrid WIPREASON2_GRID { get; set; }
        public C1DataGrid QUALITY_GRID { get; set; }
        public C1DataGrid QUALITY2_GRID { get; set; }
        public C1DataGrid INPUTMTRL_GRID { get; set; }
        public C1DataGrid INPUTMTRLHIST_GRID { get; set; }
        public C1DataGrid SLURRY_GRID { get; set; }
        public C1DataGrid REMARK_GRID { get; set; }
        public C1DataGrid REMARK_HIST_GRID { get; set; }
        public C1DataGrid COLORTAG_GRID { get; set; }
        public C1DataGrid COLOR_GRID { get; set; }
        public C1DataGrid DEFECT_TAG_GRID { get; set; }
        public C1DataGrid MERGE_GRID { get; set; }
        public C1DataGrid MERGE2_GRID { get; set; }
        public C1DataGrid WORKORDER_GRID { get; set; }
        public C1DataGrid COTTON_GRID { get; set; }
        public C1DataGrid EQPT_DFCT_GRID { get; set; }

        public string _LDR_LOT_IDENT_BAS_CODE { get; set; }
        public string _UNLDR_LOT_IDENT_BAS_CODE { get; set; }
        public DataTable WIPCOLORLEGEND { get; set; }


        #region [POSTACTION]
        public C1DataGrid POSTHOLD_GRID { get; set; }
        #endregion

        #region [Cancel Delete Lot]
        public Button CANCELDELETE { get; set; }
        #endregion

        #region Coater Slurry
        public LGCDatePicker DTPFROM { get; set; }
        public LGCDatePicker DTPTO { get; set; }
        public C1DataGrid SLURRY_INPUT_GRID { get; set; }
        #endregion
        //[CR-128] MIXER Consume Material (2017.01.18)
        public C1DataGrid INPUTMTRLSUMMARY_GRID { get; set; }

        private const string ITEM_CODE_LEN_LACK = "LENGTH_LACK";
        private const string ITEM_CODE_LEN_EXCEED = "LENGTH_EXCEED";

        Util _Util = new Util();

        string _ValueWOID = string.Empty;
        string _LargeLOTID = string.Empty;
        string _LOTID = string.Empty;
        string _EQPTID = string.Empty;
        string _LOTIDPR = string.Empty;
        string _CUTID = string.Empty;
        string _WIPSTAT = string.Empty;
        string _INPUTQTY = string.Empty;
        string _OUTPUTQTY = string.Empty;
        string _CTRLQTY = string.Empty;
        string _GOODQTY = string.Empty;
        string _LOSSQTY = string.Empty;
        string _CHARGEQTY = string.Empty;
        string _WORKORDER = string.Empty;
        string _WORKDATE = string.Empty;
        string _VERSION = string.Empty;
        string _PRODID = string.Empty;
        string _WIPDTTM_ST = string.Empty;
        string _WIPDTTM_ED = string.Empty;
        string _REMARK = string.Empty;
        string _CONFIRMUSER = string.Empty;
        string _FINALCUT = string.Empty;
        string _WIPSTAT_NAME = string.Empty;
        string _LANEQTY = string.Empty;
        string sEQPTID = string.Empty;
        string cut = string.Empty;
        string _PTNQTY = string.Empty;
        string _WIPSEQ = string.Empty;
        string _CLCTSEQ = string.Empty;
        string _WRKDTTM_ST = string.Empty;
        string _WRKDTTM_ED = string.Empty;
        string _CSTID = string.Empty;
        string _IS_POSTING_HOLD = string.Empty;
        string _LABEL_PASS_HOLD_FLAG = string.Empty;
        string _FINDWOID = string.Empty;
        string _WSEQ = string.Empty;
        string _CUT = string.Empty;
        string _sLotType = string.Empty;
        string _sLotTypeName = string.Empty;
        string _RollPressStartIntervalDays = string.Empty;
        string _RollPressEndIntervalMinutes = string.Empty;

        string _ProNameMerge = string.Empty;              // [E20230807-000061] speical work-LOT MERGE improvement

        TextBox txtVersion;
        C1NumericBox txtLaneQty = new C1NumericBox();
        C1NumericBox txtLanePatternQty = new C1NumericBox();
        C1NumericBox txtGoodQty;
        C1NumericBox txtLossQty;
        TextBox txtShift;
        TextBox txtWorker;
        TextBox txtShiftDateTime;
        TextBox txtShiftStartTime;
        TextBox txtShiftEndTime;
        TextBox txtStartDateTime;
        TextBox txtEndDateTime;
        //TextBox txtBackWorker;
        //TextBox txtRewinderWorker;

        //TextBox txtWorkStartDateTime;
        //C1DateTimePicker txtWorkEndDateTime;
        C1DateTimePicker dtpEndDateTime;
        //C1DateTimePicker dtpWorkDate;
        C1NumericBox txtWorkTime;
        TextBox txtWorkDate;
        TextBox txtWipNote;
        TextBox txtUnit;
        TextBox txtMergeInputLot;
        C1NumericBox txtInputQty;
        C1NumericBox txtParentQty;
        C1NumericBox txtRemainQty;
        C1NumericBox txtBeadMillCount;
        CheckBox chkFinalCut;
        CheckBox chkExtraPress;
        Button targetWorker;
        TextBox txtEndLotId;
        C1NumericBox txtSrs1Qty;
        C1NumericBox txtSrs2Qty;
        C1NumericBox txtSrs3Qty;
        C1ComboBox cboPet;
        TextBox txtBatchId;
        TextBox txtTank;

        TextBox txtCore1;
        TextBox txtCore2;
        TextBox txtSlurry1;
        TextBox txtSlurry2;
        TextBox txtSlurry11;
        TextBox txtSlurry22;
        Button btnMtrlChange;
        Button btnMtrlChange2;

        CheckBox chkInOut;

        DataTable dtWoAll;
        DataTable dtWoCheck;
        private DataTable dtWipReasonBak;       // WIPREASONCOLLECT의 이전값을 보관하기 위한 DataTable(C20190404_67447) [2019-04-11]

        private System.Windows.Threading.DispatcherTimer Mix_Timer = new System.Windows.Threading.DispatcherTimer();  //CSR[C20201014-000233] 믹스 공정 Timer 메시지 팝업

        string eqptMountPositionCode;
        string sBarCodeTagChk;

        decimal inputOverrate;
        decimal exceedLengthQty;
        decimal convRate;

        double LossLackQty;

        int lanePtnQty;
        GridLength ExpandFrame;

        DataSet inDataSet;
        DataTable procResnDt;

        bool isChangeWipReason = false;
        //bool isChangeDefect = false;
        //bool isChangeLoss = false;
        //bool isChangeCharge = false;
        bool isChangeQuality = false;
        bool isChangeMaterial = false;
        bool isChangeColorTag = false;
        bool isChagneDefectTag = false;
        bool isChangeRemark = false;
        bool isCoaterAfterProcess = false;
        bool isConfirm = false;
        bool isChangeInputFocus = false;
        bool isDupplicatePopup = false;
        bool isChangeCotton = false;
        bool isChangePostAction = false;
        bool isResnCountUse = false;
        bool isManageSlittingSide = false;
        
        //2020.11.27 Timer
        bool isTimerCheck = false;
        bool isTimerPopup = false;
        bool isTimerTabCk = false;

        //2024.01.04 RollPress Timer
        bool isTimerPopupRollPress = false;
        bool isTimerTabCkRollPress = false;

        //2021.08.13 CSR : C20210720-000108
        bool isRollDirCtn = false;

        SolidColorBrush redBrush = new SolidColorBrush(Colors.Red);

        // Roll Map
        bool isOriginRollMapEquipment = false;
        bool isRollMapEquipment = false;
        bool isRollMapResultLink = false;   // 동별 공정별 롤맵 실적 연계 여부
        bool isRollMapMixCotLinkSite = false; // 믹서 코터 배치 연계 고도화 사이트 여부
        bool _isTestCutApply = true;       //nathan 2024.03.26 4분할 화면 코터공정 테스트컷 사용시 입력여부 체크

        //2021.10.07 CSR : C20210914-000159
        bool isChangeQaSample = false;

        //C20210928-000558 2021.10.29
        bool isRemarkNgTag = false;

        //C20211216-000385 2022.01.19
        bool isSlurryPopup = false;

        //C20220117-000411 2022.03.30
        bool isLengthLack = false;

        //C20220406-000241 2022.06.08
        bool isBarCodePrint = false;

        //C20220224-000116 2022.07.07
        bool isSampBarPrt = false;

        private DataTable _dtWipReasonDefectBack;

        // 코터 롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////
        Dictionary<string, string> holdLotClassCode = new Dictionary<string, string>();
        // 코터 롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////

        //허용비율 초과 사유 처리 관련 변수
        DataTable dtPermitRateReturn = new DataTable();
        string permitRateUerReturn = string.Empty;
        string permitRateDeptReturn = string.Empty;

        //[E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
        bool isTWS_LOADING_TRACKING = false;
        bool isSaveTWS_Loading = false;
        bool isSaveTWS_LOADING_TRACKING = false;
        bool isPassSaveTWS_LOADING_TRACKING = true;

        //[E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
        bool isAutoSetRollDir = false;
        bool isSilentlySave   = false;


        // [E20240502-001076] Mixer 원재료 Tracking 기능 개선 : Mixer 원재료 Lot 누락 Validation 기능 적용 여부
        private bool _isELEC_MTRL_LOT_VALID_YN = false;

        #endregion Properties

        #region Constructor
        public UcBaseElec()
        {
            InitializeComponent();
            InitControls();
        }
        #endregion Constructor

        #region Events

        protected virtual void OnCheckBoxChecked(object sender, RoutedEventArgs e)
        {
            if (isCoaterAfterProcess == false)
            {
                e.Handled = false;
                CHECK_RUN.IsChecked = true;
                CHECK_END.IsChecked = true;
                return;
            }

            CheckBox cb = sender as CheckBox;

            switch (cb.Name)
            {
                case "chkWait":
                    if (cb.IsChecked == true)
                    {
                        CHECK_WOPRODUCT.Visibility = Visibility.Visible;

                        CHECK_RUN.IsChecked = false;
                        CHECK_END.IsChecked = false;
                    }
                    else
                    {
                        CHECK_WOPRODUCT.Visibility = Visibility.Collapsed;

                        CHECK_RUN.IsChecked = true;
                        CHECK_END.IsChecked = true;
                    }
                    break;

                case "chkRun":
                case "chkEqpEnd":
                    if (cb.IsChecked == true)
                    {
                        CHECK_WOPRODUCT.Visibility = Visibility.Collapsed;

                        CHECK_WAIT.IsChecked = false;
                        CHECK_RUN.IsChecked = true;
                        CHECK_END.IsChecked = true;
                    }
                    else
                    {
                        CHECK_WOPRODUCT.Visibility = Visibility.Visible;

                        CHECK_WAIT.IsChecked = true;
                        CHECK_RUN.IsChecked = false;
                        CHECK_END.IsChecked = false;
                    }
                    break;

                case "chkWoProduct":
                    if (cb.IsChecked == true)
                    {
                        if (LARGELOT_GRID.Visibility == Visibility.Visible)
                        {
                            if (LARGELOT_GRID.Rows.Count < 1)
                                return;
                        }
                        else
                        {
                            if (PRODLOT_GRID.Rows.Count < 1)
                                return;
                        }

                        try
                        {
                            string prodId = procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.MIXING) || procId.Equals(Process.SRS_MIXING) ? (grdWorkOrder.Children[0] as UC_WORKORDER_MX).PRODID : (grdWorkOrder.Children[0] as UC_WORKORDER).PRODID;

                            if (LARGELOT_GRID.Visibility == Visibility.Visible)
                            {
                                dtWoAll = (LARGELOT_GRID.ItemsSource as DataView).Table;
                                dtWoCheck = (LARGELOT_GRID.ItemsSource as DataView).Table.Select("PRODID='" + prodId + "'").CopyToDataTable();
                                Util.GridSetData(LARGELOT_GRID, dtWoCheck, FrameOperation, true);
                            }
                            else
                            {
                                dtWoAll = (PRODLOT_GRID.ItemsSource as DataView).Table;
                                dtWoCheck = (PRODLOT_GRID.ItemsSource as DataView).Table.Select("PRODID='" + prodId + "'").CopyToDataTable();
                                Util.GridSetData(PRODLOT_GRID, dtWoCheck, FrameOperation, true);
                            }
                        }
                        catch
                        {
                            if (LARGELOT_GRID.Visibility == Visibility.Visible)
                                LARGELOT_GRID.ItemsSource = null;
                            else
                                PRODLOT_GRID.ItemsSource = null;

                            return;
                        }
                    }
                    else
                    {
                        if (dtWoAll != null)
                        {
                            if (LARGELOT_GRID.Visibility == Visibility.Visible)
                                Util.GridSetData(LARGELOT_GRID, dtWoAll, FrameOperation, true);
                            else
                                Util.GridSetData(PRODLOT_GRID, dtWoAll, FrameOperation, true);
                        }
                    }
                    break;
            }

            if (!cb.Name.Equals("chkWoProduct"))
            {
                SetStatus();

                if (string.Equals(cb.Name, "chkEqpEnd"))    // PROC, EQPT_END가 동시에 체크되기 떄문에 하나만 체크하도록 변경
                    return;

                //if (!string.IsNullOrEmpty(WIPSTATUS))
                if (((string.Equals(WIPSTATUS, Wip_State.WAIT) || string.Equals(WIPSTATUS, Wip_State.PROC + "," + Wip_State.EQPT_END)) && cb.IsChecked == true))
                {
                    OnClickSearch(SEARCHBUTTON, null);
                }
            }

            if (cb.Name.Equals("chkWait"))
                CHECK_WOPRODUCT.IsChecked = true;
        }

        private void SetExtraPress()
        {
            try
            {
                int roll_count; //압연 횟수
                int roll_Seq;   //압연 차수

                DataTable dt = new DataTable();
                dt.Columns.Add("LOTID", typeof(string));

                DataRow row = dt.NewRow();
                row["LOTID"] = _LOTID;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_ROLLPRESS_COUNT", "INDATA", "RSLTDT", dt);// 압연 횟수 차수 가져오기

                if (result.Rows.Count > 0)
                {
                    roll_count = Int32.Parse(result.Rows[0]["ROLLPRESS_COUNT"].ToString().Equals("") ? 0.ToString() : result.Rows[0]["ROLLPRESS_COUNT"].ToString());
                    roll_Seq = Int32.Parse(result.Rows[0]["ROLLPRESS_SEQNO"].ToString().Equals("") ? 0.ToString() : result.Rows[0]["ROLLPRESS_SEQNO"].ToString());

                    if (roll_count <= roll_Seq)
                    {
                        chkExtraPress.IsEnabled = true;
                        chkExtraPress.IsChecked = false;
                    }
                    else
                    {
                        chkExtraPress.IsEnabled = false;
                        chkExtraPress.IsChecked = true;
                    }
                }
                else
                {
                    roll_count = 0;
                    roll_Seq = 0;

                    chkExtraPress.IsEnabled = true;
                    chkExtraPress.IsChecked = false;
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void SetFirstProductionInspection()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LOTID", typeof(string));

                DataRow row = dt.NewRow();
                row["LOTID"] = _LOTID;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIP_FOR_ALL", "RQSTDT", "RSLTDT", dt);

                if (result != null && result.Rows.Count > 0)
                    if (string.Equals(result.Rows[0]["FRST_PRDT_INSP_AREA"], "Y") && string.Equals(result.Rows[0]["FRST_PRDT_INSP_FLAG"], "Y") &&
                        string.Equals(result.Rows[0]["WIP_TYPE_CODE"], "OUT"))
                        Util.MessageInfo("101435", new object[] { _LOTID });
            }
            catch (Exception ex) {}
        }

        private void SetRollMapLotAttribute(string sLotID)
        {
            try
            {
                bool isRollMapModeChange = false;

                if (isOriginRollMapEquipment == true)
                {
                    DataTable dt = new DataTable();
                    dt.Columns.Add("LOTID", typeof(string));

                    DataRow row = dt.NewRow();
                    row["LOTID"] = sLotID;
                    dt.Rows.Add(row);

                    DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR", "RQSTDT", "RSLTDT", dt);

                    if (result != null && result.Rows.Count > 0)
                    {
                        // 실적 연계 여부에 따라 처리 변경 [2021-10-18]
                        if (isRollMapResultLink == true)
                        {
                            if (string.Equals(result.Rows[0]["ROLLMAP_APPLY_FLAG"], "Y"))
                            {
                                if (isRollMapEquipment == false)
                                    isRollMapModeChange = true;

                                isRollMapEquipment = true;
                            }
                            else
                            {
                                if (isRollMapEquipment == true)
                                    isRollMapModeChange = true;

                                isRollMapEquipment = false;
                            }

                            if (isRollMapModeChange == true)
                                VisibleRollMapMode();
                        }
                        else
                        {
                            isRollMapEquipment = false;
                            VisibleRollMapMode();

                            if (string.Equals(result.Rows[0]["ROLLMAP_APPLY_FLAG"], "Y"))
                                (grdSearch.Children[0] as UcSearch).btnRollMap.Visibility = Visibility.Visible;
                        }
                    }
                }
                setRollmapResultLinkBtn();  //nathan 2023.12.13 롤맵 코터 수불 실적 적용
            }
            catch (Exception ex) { }
        }

        void SetStatus()
        {
            var status = new List<string>();

            if (CHECK_WAIT.IsChecked == true)
                status.Add(CHECK_WAIT.Tag.ToString());

            if (CHECK_RUN.IsChecked == true)
                status.Add(CHECK_RUN.Tag.ToString());

            if (CHECK_END.IsChecked == true)
                status.Add(CHECK_END.Tag.ToString());

            WIPSTATUS = string.Join(",", status);
        }

        protected virtual void OnClickSearch(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENTSEGMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1223");  //라인을 선택하세요.
                return;
            }

            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            if (string.IsNullOrEmpty(WIPSTATUS))
            {
                Util.MessageValidation("SFU1438");  //WIP 상태를 선택하세요.
                return;
            }

            InitClear();
            InitWorkOrderCheck();

            //C20210527-000015, ESWA Mixing 공정 Work Order 자동 변경 로직 적용 요청의 건
            if (grdWorkOrder.Children[0] is UC_WORKORDER)
                Util.gridClear(((UC_WORKORDER)grdWorkOrder.Children[0]).dgWorkOrder);
            else
                Util.gridClear(((UC_WORKORDER_MX)grdWorkOrder.Children[0]).dgWorkOrder);

            GetWorkOrder();

            if (LARGELOT_GRID.Visibility == Visibility.Visible)
                GetLargeLot();
            else
                GetProductLot();

            // WAIT 상태 일때는 수량 입력 금지
            if (string.Equals(WIPSTATUS, Wip_State.WAIT))
            {
                CHECK_WOPRODUCT.IsChecked = true;
                txtInputQty.IsEnabled = false;
            }
            else
            {
                txtInputQty.IsEnabled = true;
            }

            // SHIFT_CODE, SHIFT_USER 자동 SET
            GetWrkShftUser();

            // COATER공정에서 CORE, SLURRY 조회, SRS코터에서 BATCH ID 자동 조회 및 SETUP
            if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
            {
                if (isSingleCoater)
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));
                else
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), "");
            }
            else if ( string.Equals(procId, Process.SRS_COATING))
            {
                GetSlurry();
            }
            // 자동선택 추가
            SetLotAutoSelected();

            //Pilot Mode
            GetPilotProdMode();

            //C20210928-000558 Slitter Process adds NG TAG columns in remark
            GetRemarkNgTagSelect();

        }

        #region # Roll Map
        protected virtual void OnClickRollMap(object sender, RoutedEventArgs e)
        {
            // 버전정보 체크
            if (!ValidVersion()) return;

            // Roll Map 호출 
            string mainFormPath = "LGC.GMES.MES.COM001";
            string mainFormName = string.Empty;
            string processCode = string.Empty;
            string equipmentCode = string.Empty;
            string equipmentName = string.Empty;
            string lotCode = string.Empty;
            string wipSeq = string.Empty;
            string lotUnitCode = string.Empty;

            // LOT 단위 ID -> EA : 원통형 롤맵 UI 팝업 호출 , M 기존 롤맵 UI 팝업 호출
            lotUnitCode = GetLotUnitCode();

            if (string.Equals(procId, Process.ROLL_PRESSING))
            {
                if (string.Equals(WIPSTATUS, Wip_State.PROC))
                {
                    //mainFormName = "COM001_ROLLMAP_COATER";
                    mainFormName = lotUnitCode == "EA" ? "COM001_ROLLMAP_MOBILE_COATER" : "COM001_RM_CHART_CT";
                    lotCode = string.Empty;
                    wipSeq = "1";
                    processCode = Process.COATING;
                    equipmentName = string.Empty;

                    DataTable dtRollMapInputLot = GetRollMapInputLotCode(_LOTID);

                    if (CommonVerify.HasTableRow(dtRollMapInputLot))
                    {
                        lotCode = dtRollMapInputLot.Rows[0]["INPUT_LOTID"].GetString();

                        DataTable dtEquipment = GetEquipmentCode(lotCode, wipSeq);
                        equipmentCode = CommonVerify.HasTableRow(dtEquipment) ? dtEquipment.Rows[0]["EQPTID"].GetString() : string.Empty;
                    }
                    else
                    {
                        return;
                    }
                }
                else
                {
                    //mainFormName = "COM001_ROLLMAP_ROLLPRESS_NEW";
                    mainFormName = lotUnitCode == "EA" ? "COM001_ROLLMAP_MOBILE_ROLLPRESS" : "COM001_RM_CHART_RP";
                    lotCode = _LOTID;
                    wipSeq = _WIPSEQ;
                    processCode = procId;
                    equipmentCode = _EQPTID;
                    equipmentName = EQUIPMENT_COMBO.Text;
                }
            }
            else if (string.Equals(procId, Process.COATING))
            {
                //CWA 전극 코터공정진척의 경우 ELEC002_002 파일을 사용함. 
                //mainFormName = "COM001_ROLLMAP_COATER";
                mainFormName = lotUnitCode == "EA" ? "COM001_ROLLMAP_MOBILE_COATER" : "COM001_RM_CHART_CT";
                lotCode = _LOTID;
                wipSeq = _WIPSEQ;
                processCode = procId;
                equipmentCode = _EQPTID;
                equipmentName = EQUIPMENT_COMBO.Text;
            }
            else if (string.Equals(procId, Process.SLITTING))
            {
                //mainFormName = "COM001_ROLLMAP_SLITTING";
                mainFormName = lotUnitCode == "EA" ? "COM001_ROLLMAP_MOBILE_SLITTING" : "COM001_RM_CHART_SL";
                lotCode = _LOTID;
                wipSeq = _WIPSEQ;
                processCode = procId;
                equipmentCode = _EQPTID;
                equipmentName = EQUIPMENT_COMBO.Text;
            }
            else if (string.Equals(procId, Process.SLIT_REWINDING) || string.Equals(procId, Process.REWINDING))
            {
                mainFormName = "COM001_RM_CHART_RW";
                lotCode = _LOTID;
                wipSeq = _WIPSEQ;
                processCode = procId;
                equipmentCode = _EQPTID;
                equipmentName = EQUIPMENT_COMBO.Text;
            }
            else if (string.Equals(procId, Process.HALF_SLITTING))
            {
                mainFormName = "COM001_ROLLMAP_MOBILE_HALFSLITTING";
                lotCode = _LOTID;
                wipSeq = _WIPSEQ;
                processCode = procId;
                equipmentCode = _EQPTID;
                equipmentName = EQUIPMENT_COMBO.Text;
            }
            else if (string.Equals(procId, Process.TWO_SLITTING))
            {
                mainFormName = "COM001_ROLLMAP_TWOSLITTING";
                lotCode = _LOTID;
                wipSeq = _WIPSEQ;
                processCode = procId;
                equipmentCode = _EQPTID;
                equipmentName = EQUIPMENT_COMBO.Text;
            }
            else
            {
                return;
            }


            System.Reflection.Assembly asm = System.Reflection.Assembly.LoadFrom("ClientBin\\" + mainFormPath + ".dll");
            Type targetType = asm.GetType(mainFormPath + "." + mainFormName);
            object obj = Activator.CreateInstance(targetType);

            IWorkArea workrollmap = obj as IWorkArea;
            workrollmap.FrameOperation = FrameOperation;

            object[] Parameters = new object[10];
            Parameters[0] = processCode;
            Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
            Parameters[2] = equipmentCode;
            Parameters[3] = lotCode;
            Parameters[4] = wipSeq;
            Parameters[5] = txtLaneQty.Value;
            Parameters[6] = equipmentName;
            Parameters[7] = txtVersion.Text.Trim();

            C1Window popup = obj as C1Window;
            popup.Closed += new EventHandler(OnCloseRollmap);
            C1WindowExtension.SetParameters(popup, Parameters);
            if (popup != null)
            {
                popup.ShowModal();
                popup.CenterOnScreen();
            }
        }

        private DataTable GetRollMapHold(string processCode)
        {
            string bizRuleName = string.Equals(processCode, Process.ROLL_PRESSING) ? "DA_PRD_SEL_ROLLMAP_RP_HOLD" : "DA_PRD_SEL_ROLLMAP_CT_HOLD";

            DataTable inTable = new DataTable { TableName = "RQSTDT" };
            inTable.Columns.Add("AREAID", typeof(string));
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("WIPSEQ", typeof(decimal));
            
            decimal dcmWIPSEQ;
            decimal.TryParse(_WIPSEQ, out dcmWIPSEQ);
            DataRow dr = inTable.NewRow();
            dr["AREAID"] = LoginInfo.CFG_AREA_ID;
            dr["LOTID"] = _LOTID;
            dr["WIPSEQ"] = dcmWIPSEQ;
            inTable.Rows.Add(dr);

            return new ClientProxy().ExecuteServiceSync(bizRuleName, "RQSTDT", "RSLTDT", inTable);
        }

        private void OnCloseRollmap(object sender, EventArgs e)
        {
            //REFRESH = true;
        }

        private void OnBeginningEdit(object sender, C1.WPF.DataGrid.DataGridBeginningEditEventArgs e)
        {
            if (!isRollMapEquipment) return;

            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                if (string.Equals(e.Column.Name, "COUNTQTY") &&
                    !string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y"))
                    e.Cancel = true;

                if ((string.Equals(e.Column.Name, "COUNTQTY") || string.Equals(e.Column.Name, "DFCT_TAG_QTY") || string.Equals(e.Column.Name, "RESN_TOT_CHK") || string.Equals(e.Column.Name, "RESNQTY")) &&
                        (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "DFCT_QTY_CHG_BLOCK_FLAG"), "Y") || string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "TOP_LOSS_BAS_DFCT_APPLY_FLAG"), "Y")))
                    e.Cancel = true;

                if (string.Equals(e.Column.Name, "RESN_TOT_CHK") && string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "CHARGE_PROD_LOT"))
                    e.Cancel = true;
            }
        }

        private bool IsRollMapEquipment()
        {
            try
            {
                const string bizRuleName = "DA_BAS_SEL_LOTATTR";
                DataTable inTable = new DataTable("RQSTDT");
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow row = inTable.NewRow();
                row["LOTID"] = _LOTID;
                inTable.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync(bizRuleName, "RQSTDT", "RSLTDT", inTable);

                if (CommonVerify.HasTableRow(result))
                {
                    if (Equals(result.Rows[0]["ROLLMAP_APPLY_FLAG"], "Y"))
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
                else
                {
                    return false;
                }
            }
            catch (Exception)
            {
                return false;
            }
        }
        #endregion

        protected virtual void OnClickStart(object sender, RoutedEventArgs e)
        {
        }

        protected virtual void OnClickStartCancel(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = PRODLOT_GRID;

            DataRow[] dr = Util.gridGetChecked(ref dg, "CHK");

            if (dr == null || dr.Length < 1 || dg == null)
            {
                Util.MessageValidation("SFU1938");  //취소할 LOT을 선택하세요.
                return;
            }

            StartCancelProcess();
        }

        protected virtual void OnClickEqptEndCancel(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = PRODLOT_GRID;

            DataRow[] dr = Util.gridGetChecked(ref dg, "CHK");

            if (dr == null || dr.Length < 1 || dg == null)
            {
                Util.MessageValidation("SFU1938");  //취소할 LOT을 선택하세요.
                return;
            }

            EqptEndCancelProcess();
        }

        protected virtual void OnClickConfirm(object sender, RoutedEventArgs e)
        {
            if (txtInputQty.Value > 0)
                return;

            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count)
            {
                Util.MessageValidation("SFU1707");  //실적 확정할 대상이 없습니다.
                return;
            }

            // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
            if (ValidConfirmLotCheck() == false)
                return;

            // 설비완공 상태에서만 실적확정 가능하도록 변경 [2017-03-02]
            if (!string.Equals(_WIPSTAT, "EQPT_END"))
            {
                Util.MessageValidation("SFU3194");  //실적확정 Lot 선택 오류 [선택한 Lot이 장비완료상태 인지 확인 후 처리]
                return;
            }
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (procId.Equals(Process.SLITTING) || procId.Equals(Process.SRS_SLITTING) || string.Equals(procId, "E4200"))
            {
                if (!ValidateConfirmSlitter())
                    return;
            }
            else
            {
                // [E20240502-001076] Mixer 원재료 Tracking 기능 개선 : Mixer 원재료 Lot 누락 Validation 기능 적용 여부 Start
                if (procId == Process.MIXING ||
                    procId == Process.PRE_MIXING ||
                    procId == Process.BS ||
                    procId == Process.CMC ||
                    procId == Process.InsulationMixing ||
                    procId == Process.DAM_MIXING)
                {
                    // 원재료 Lot 누락 Validation 기능 적용 Check
                    CheckUseElecMtrlLotValidation();

                    if (_isELEC_MTRL_LOT_VALID_YN)
                    {
                        //미 투입자재 존재 유무 Check
                        if (CheckMissedElecMtrlLot())
                        {
                            //미투입 자재 PopUp
                            PopupInputMaterial();
                            return;
                        }
                    }
                }
                // [E20240502-001076] Mixer 원재료 Tracking 기능 개선 : Mixer 원재료 Lot 누락 Validation 기능 적용 여부 End

                if (!ValidateConfirm())
                    return;
            }

            //
            Dictionary<string, object[]> warningMsgId = new Dictionary<string, object[]>();
            WarningVerLaneQty(warningMsgId, Util.NVC(txtVersion.Text), Util.NVC_Int(txtLaneQty.Value));
            WarningSingleCoaterDefectCount(warningMsgId);

            //C20220713-000423 상/하한 초과하여 측정값 입력시 알람 팝업 생성 (오창 자동차) : 강호운 책임
            WarningQualitySpecChk(warningMsgId);
            WarningQualitySpec(warningMsgId);
            WarningQualitySpecExists(warningMsgId);
            //C20210518-000221 2021-09-28 코팅공정 투입슬리러 LOT 유형에 대한 Validation
            //if (procId.Equals(Process.COATING) || procId.Equals(Process.SRS_COATING))
            //    WarningQualityLotType(warningMsgId);



            MessageWarning(warningMsgId, () => {
                CheckGoodQty(() =>
                {
                    CheckLabelPassHold(() =>
                    {
                        CheckAuthValidation(() =>
                        {
                            ConfirmCheck();
                        });
                    });
                });
            });
        }

        private void ConfirmCheck()
        {
            //nathan 2023.12.13 롤맵 코터 수불 실적 적용 - start
            if (isRollMapResultLink == true && isRollMapEquipment == true)
            {
                if (!ValidationRollMapLotNextProcessMove()) return;   //롤맵 LOT 공정이동시 불량,LOSS 코드 입력 여부 체크
            }
            //nathan 2023.12.13 롤맵 코터 수불 실적 적용 - end

                // LOSS는 자동 등록 한번 해줌
                SaveDefect(WIPREASON_GRID);

            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                SaveDefect(WIPREASON2_GRID);

            isChangeWipReason = false;

            if (string.Equals(procId, Process.MIXING))
            {
                LGC.GMES.MES.CMM001.CMM_ELEC_MIXER_BATCH mixerConfirm = new CMM_ELEC_MIXER_BATCH();
                mixerConfirm.FrameOperation = FrameOperation;
                if (mixerConfirm != null)
                {
                    int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");
                    if (iRow < 0)
                        iRow = 0;

                    object[] Parameters = new object[4];
                    Parameters[0] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "PRJT_NAME"));
                    Parameters[1] = Util.NVC(txtVersion.Text);
                    // 2019-08-28 오화백  LOTID, EQPTID 정보 파라미터 추가
                    Parameters[2] = _LOTID;
                    Parameters[3] = _EQPTID;
                    C1WindowExtension.SetParameters(mixerConfirm, Parameters);

                    mixerConfirm.Closed += new EventHandler(OnCloseMixerConfirm);
                    this.Dispatcher.BeginInvoke(new Action(() => mixerConfirm.ShowModal()));
                }
            }
            else if (procId.Equals(Process.COATING) || procId.Equals(Process.SRS_COATING))
            {
                // 2023.10.10 조성근- 롤맵 홀드는 수동 선택이 아닌, 자동 선택 ( E20231005-000782 )
                //DataTable dtHold = GetRollMapHold(procId);
                // 
                //if (IsRollMapEquipment() && CommonVerify.HasTableRow(dtHold))
                //{

                //    //롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////
                //    holdLotClassCode.Clear();
                //    if (dtHold.Columns.Contains("ADJ_LOTID") && dtHold.Columns.Contains("HOLD_CLASS_CODE"))
                //    {
                //        holdLotClassCode.Add(dtHold.Rows[0]["ADJ_LOTID"].ToString(), dtHold.Rows[0]["HOLD_CLASS_CODE"].ToString());
                //    }
                //    //롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////

                //    #region # Roll Map
                //    CMM_ROLLMAP_HOLD wndPopup = new CMM_ROLLMAP_HOLD();
                //    wndPopup.FrameOperation = FrameOperation;

                //    if (wndPopup != null)
                //    {
                //        object[] parameters = new object[10];
                //        parameters[0] = procId;
                //        parameters[1] = _EQPTID;
                //        parameters[2] = _LOTID;
                //        parameters[3] = _WIPSEQ;
                //        parameters[4] = Util.NVC(EQUIPMENT_COMBO.Text);
                //        parameters[5] = txtVersion.Text.Trim();
                //        C1WindowExtension.SetParameters(wndPopup, parameters);

                //        wndPopup.Closed += new EventHandler(wndHoldRollmap_Closed);
                //        this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
                //    }
                //    #endregion
                //}
                //else
                {
                    if (!isSingleCoater)
                    {
                        CMM_ELEC_HOLD_YN wndPopup = new CMM_ELEC_HOLD_YN();
                        wndPopup.FrameOperation = FrameOperation;

                        if (wndPopup != null)
                        {
                            object[] Parameters = new object[2];
                            Parameters[0] = _LOTID;

                            C1WindowExtension.SetParameters(wndPopup, Parameters);

                            wndPopup.Closed += new EventHandler(wndHoldChk_Closed);
                            this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
                        }
                    }
                    else
                    {
                        ValidateCarrierCTUnloader();
                    }
                }
            }
            else if (procId.Equals(Process.ROLL_PRESSING))
            {
                // 2023.10.10 조성근- 롤맵 홀드는 수동 선택이 아닌, 자동 선택 ( E20231005-000782 )
                //DataTable dtHold = GetRollMapHold(procId);

                //if (IsRollMapEquipment() && CommonVerify.HasTableRow(dtHold))
                //{
                //    //롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////
                //    holdLotClassCode.Clear();
                //    if (dtHold.Columns.Contains("ADJ_LOTID") && dtHold.Columns.Contains("HOLD_CLASS_CODE"))
                //    {
                //        holdLotClassCode.Add(dtHold.Rows[0]["ADJ_LOTID"].ToString(), "E3000");
                //    }
                //    //롤맵 Hold 기능 추가/////////////////////////////////////////////////////////////

                //    #region # Roll Map
                //    CMM_ROLLMAP_HOLD wndPopup = new CMM_ROLLMAP_HOLD();
                //    wndPopup.FrameOperation = FrameOperation;

                //    if (wndPopup != null)
                //    {
                //        object[] parameters = new object[10];
                //        parameters[0] = procId;
                //        parameters[1] = _EQPTID;
                //        parameters[2] = _LOTID;
                //        parameters[3] = _WIPSEQ;
                //        parameters[4] = Util.NVC(EQUIPMENT_COMBO.Text);
                //        parameters[5] = txtVersion.Text.Trim();
                //        C1WindowExtension.SetParameters(wndPopup, parameters);

                //        wndPopup.Closed += new EventHandler(wndHoldRollmap_Closed);
                //        this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
                //    }
                //    #endregion
                //}
                //else
                {
                    ConfirmProcess();
                }
            }
            else
            {
                ConfirmProcess();
            }
        }

        private void ValidateCarrierCTUnloader()
        {
            try
            {
                if (_UNLDR_LOT_IDENT_BAS_CODE == "CST_ID" || _UNLDR_LOT_IDENT_BAS_CODE == "RF_ID")
                {
                    DataTable IndataTable = new DataTable();
                    IndataTable.Columns.Add("LOTID", typeof(string));

                    DataRow Indata = IndataTable.NewRow();
                    Indata["LOTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOTID"));
                    IndataTable.Rows.Add(Indata);

                    DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIPATTR", "INDATA", "RSLTDT", IndataTable);

                    if (result.Rows.Count > 0)
                    {
                        if (string.IsNullOrEmpty(result.Rows[0]["CSTID"].ToString()))
                        {
                            CMM_ELEC_CST_RELATION cst = new CMM_ELEC_CST_RELATION();
                            cst.FrameOperation = FrameOperation;

                            if (cst != null)
                            {
                                object[] Parameters = new object[2];
                                Parameters[0] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOTID"));
                                Parameters[1] = _EQPTID;

                                C1WindowExtension.SetParameters(cst, Parameters);

                                cst.Closed += new EventHandler(wndCst_Closed);
                                this.Dispatcher.BeginInvoke(new Action(() => cst.ShowModal()));
                            }
                        }
                        else
                        {
                            ConfirmProcess();
                        }
                    }

                }
                else
                {
                    ConfirmProcess();
                }
            }
            catch (Exception e)
            {
                Util.MessageException(e);
                return;
            }
            return;
        }

        private void OnCloseAuthConfirm(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_COM_AUTH_CONFIRM window = sender as LGC.GMES.MES.CMM001.CMM_COM_AUTH_CONFIRM;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                CheckSpecOutHold(() => { ConfirmCheck(); });
            }
        }

        private void OnCloseMixerConfirm(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_MIXER_BATCH window = sender as LGC.GMES.MES.CMM001.CMM_ELEC_MIXER_BATCH;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                string sRemark = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                DataTableConverter.SetValue(REMARK_GRID.Rows[1].DataItem, "REMARK", window._ConfirmMsg + sRemark);
                ConfirmProcess(window._IsLastBatch);
            }
        }

        private void wndCst_Closed(object sender, EventArgs e)
        {
            CMM_ELEC_CST_RELATION window = sender as CMM_ELEC_CST_RELATION;

            if (window.DialogResult == MessageBoxResult.OK)
            {
                ConfirmProcess();
            }
        }
        #region # Coating Hold (C20200306-000088)
        private void wndHoldChk_Closed(object sender, EventArgs e)
        {
            CMM_ELEC_HOLD_YN window = sender as CMM_ELEC_HOLD_YN;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                _IS_POSTING_HOLD = window.HOLDYNCHK;
                ValidateCarrierCTUnloader();
            }
        }
        #endregion

        #region # Roll Map
        private void wndHoldRollmap_Closed(object sender, EventArgs e)
        {
            CMM_ROLLMAP_HOLD window = sender as CMM_ROLLMAP_HOLD;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                _IS_POSTING_HOLD = window.HoldCheck;
                ConfirmProcess();
            }
        }
        #endregion

        protected virtual void OnClickEqptEnd(object sender, RoutedEventArgs e)
        {

            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1381");  //Lot을 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            if (!Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSTAT")).Equals("PROC"))
            {
                Util.MessageValidation("SFU2957");  //진행중인 작업을 선택하세요.
                return;
            }

            LGC.GMES.MES.CMM001.CMM_COM_EQPT_END wndEqpComment = new LGC.GMES.MES.CMM001.CMM_COM_EQPT_END();
            wndEqpComment.FrameOperation = FrameOperation;

            string endLotID = "";

            for (int i = 0; i < dgLotInfo.Rows.Count; i++)
            {
                if (dgLotInfo.Rows[i].DataItem != null)
                {
                    if (!DataTableConverter.GetValue(dgLotInfo.Rows[i].DataItem, "LOTID").Equals(""))  //_Shift
                    {
                        endLotID = DataTableConverter.GetValue(dgLotInfo.Rows[i].DataItem, "LOTID").ToString() + "," + endLotID;
                    }
                }
            }

            if (wndEqpComment != null)
            {
                object[] Parameters = new object[7];
                Parameters[0] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = procId;
                Parameters[2] = endLotID; /*iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));*/
                Parameters[3] = txtInputQty.Value.ToString();
                Parameters[4] = Util.NVC(txtStartDateTime.Text);    // 시작시간 추가
                Parameters[5] = _CUTID;
                Parameters[6] = Util.NVC(txtParentQty.Value);

                C1WindowExtension.SetParameters(wndEqpComment, Parameters);

                wndEqpComment.Closed += new EventHandler(OnCloseEqptEnd);
                this.Dispatcher.BeginInvoke(new Action(() => wndEqpComment.ShowModal()));
            }
        }

        private void OnCloseEqptEnd(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_COM_EQPT_END window = sender as LGC.GMES.MES.CMM001.CMM_COM_EQPT_END;
            if (window.DialogResult == MessageBoxResult.OK)
                REFRESH = true;
        }

        protected virtual void OnClickBarcode(object sender, RoutedEventArgs e)
        {
            // 상태 관계없이 OUTLOT 기준으로 BARCODE 발행 [2017-01-31]
            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1559");  //발행할 LOT을 선택하십시오.
                return;
            }

            // 코터설비의 경우 공정 라벨 발행 시 버전 저장 안되었을 경우 버전 저장 후 바코드 발행 할 수 있게 변경 처리 [2018-03-08]
            if (string.Equals(procId, Process.COATING))
            {
                if (string.IsNullOrEmpty(GetLotProdVerCode(_LOTID)))
                {
                    Util.MessageValidation("SFU4561"); // 생산실적 화면의 저장버튼 클릭 후(버전 정보 저장) 바코드 출력 하시기 바랍니다.
                    return;
                }
            }

            if (LoginInfo.CFG_SERIAL_PRINT == null || LoginInfo.CFG_SERIAL_PRINT.Rows.Count < 1)
            {
                Util.MessageValidation("SFU2003"); // 프린트 환경 설정값이 없습니다.
                return;
            }

            // C20220406-000241 - 자동차 1, 2동 전극 슬리터 바코드 불량수, Tag수 표시 
            if (isBarCodePrint)
            {
                //장비완료 체크, 불량/Loss/물품청구 저장 여부 
                if ((!string.Equals(WIPSTATUS, Wip_State.EQPT_END) || GetLotPetLinkFlag(_LOTID) == "N"))
                {
                    // 바코드 발행 진행여부
                    if (Convert.ToString(sBarCodeTagChk).ToUpper() == "Y")
                    {
                        Util.MessageValidation("SFU8499"); // 장비완료와 불량/Loss/물품청구 저장을 먼저 진행하세요.
                        return;
                    }
                }
            }

            // C20220224-000116 - GMES 슬리터 공정진척 샘플링 팝업 요청 건
            if (isSampBarPrt)
            {
                if (GetSlitSampChk(_CUTID))
                {
                    Util.MessageConfirm("SFU8506", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            GetBarCodePrint();
                        }
                    });
                }
                else
                {
                    GetBarCodePrint();
                }
            }
            else
            {
                GetBarCodePrint();
            } 

            // 바코드 발행 실행 구문을 호출 함수로 변경 [2022.07.07]
            #region 바코드 발행 실행 [주석처리]
            /*
            DataTable printDT = GetPrintCount(_LOTID, procId);

            if (printDT.Rows.Count > 0 && Util.NVC_Decimal(printDT.Rows[0]["PRT_COUNT1"]) > 0)
            {
                // 이미 해당 공정에서 발행된 Lot인데 재 발행하시겠습니까?
                Util.MessageConfirm("SFU3463", (sresult) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        try
                        {
                            #region [샘플링 출하거래처 추가]
                            // SAMPLING용 발행 매수 추가
                            int iSamplingCount;

                            DataTable LabelDT = new DataTable();
                            LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                            //슬리터2차 추가  2021-09-15  by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                            {
                                DataTable sampleDT = new DataTable();
                                sampleDT.Columns.Add("CUT_ID", typeof(string));
                                sampleDT.Columns.Add("LOTID", typeof(string));
                                sampleDT.Columns.Add("COMPANY", typeof(string));
                                DataRow dRow = null;

                                foreach (DataRow _iRow in LabelDT.Rows)
                                {
                                    iSamplingCount = 0;
                                    string[] sCompany = null;
                                    foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                    {
                                        iSamplingCount = Util.NVC_Int(items.Key);
                                        sCompany = Util.NVC(items.Value).Split(',');
                                    }
                                    for (int i = 0; i < iSamplingCount; i++)
                                    {
                                        dRow = sampleDT.NewRow();
                                        dRow["CUT_ID"] = _iRow["CUT_ID"];
                                        dRow["LOTID"] = _iRow["LOTID"];
                                        dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                        sampleDT.Rows.Add(dRow);
                                    }
                                }
                                var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                                for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                                    for (int i = 0; i < sortdt.Rows.Count; i++)
                                        Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                            }
                            else
                            {
                                //C20210415-000402 [2021-06-22]
                                int iFirstCutCNT = 0;

                                if (string.Equals(procId, Process.COATING) && (_CUT == "1"))
                                    iFirstCutCNT = LoginInfo.CFG_LABEL_FIRST_CUT_COPIES;

                                for (int ii = 0; ii < (LoginInfo.CFG_LABEL_COPIES + iFirstCutCNT); ii++)
                                    foreach (DataRow _iRow in LabelDT.Rows)
                                    {
                                        iSamplingCount = 0;
                                        string[] sCompany = null;
                                        foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                        {
                                            iSamplingCount = Util.NVC_Int(items.Key);
                                            sCompany = Util.NVC(items.Value).Split(',');
                                        }

                                        for (int i = 0; i < iSamplingCount; i++)
                                            Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId, i > sCompany.Length - 1 ? "" : sCompany[i]);
                                    }
                            }
                            #endregion
                        }
                        catch (Exception ex) { Util.MessageException(ex); }
                    }
                });
            }
            else
            {
                try
                {
                    DataTable LabelDT = new DataTable();
                    LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                    // S/L공정은 Default 라벨 발행 매수 포함해서 출력해달라고 자동차2동 요청 [2018-07-10]
                    // 슬리터 2차 추가  2021-09-15 by 오화백
                    if ( string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                    {
                        #region [샘플링 출하거래처 추가]
                        // SAMPLING용 발행 매수 추가
                        int iSamplingCount;
                        DataTable sampleDT = new DataTable();
                        sampleDT.Columns.Add("CUT_ID", typeof(string));
                        sampleDT.Columns.Add("LOTID", typeof(string));
                        sampleDT.Columns.Add("COMPANY", typeof(string));
                        DataRow dRow = null;

                        foreach (DataRow _iRow in LabelDT.Rows)
                        {
                            iSamplingCount = 0;
                            string[] sCompany = null;
                            foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                            {
                                iSamplingCount = Util.NVC_Int(items.Key);
                                sCompany = Util.NVC(items.Value).Split(',');
                            }
                            for (int i = 0; i < iSamplingCount; i++)
                            {
                                dRow = sampleDT.NewRow();
                                dRow["CUT_ID"] = _iRow["CUT_ID"];
                                dRow["LOTID"] = _iRow["LOTID"];
                                dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                sampleDT.Rows.Add(dRow);
                            }
                        }
                        //sampleDT.DefaultView.Sort = "CUT_ID ASC, COMPANY ASC";
                        var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                        for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                            for (int i = 0; i < sortdt.Rows.Count; i++)
                                Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                        #endregion
                    }
                    else
                    {
                        //foreach (DataRow _iRow in LabelDT.Rows)
                        //    Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId);

                        //C20210415-000402 [2021-06-22]
                        int iFirstCutCNT = 0;

                        if (string.Equals(procId, Process.COATING) && (_CUT == "1"))
                            iFirstCutCNT = LoginInfo.CFG_LABEL_FIRST_CUT_COPIES;

                        int iSamplingCount;
                        for (int ii = 0; ii < (LoginInfo.CFG_LABEL_COPIES + iFirstCutCNT); ii++)
                            foreach (DataRow _iRow in LabelDT.Rows)
                            {
                                iSamplingCount = 0;
                                string[] sCompany = null;
                                foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                {
                                    iSamplingCount = Util.NVC_Int(items.Key);
                                    sCompany = Util.NVC(items.Value).Split(',');
                                }

                                for (int i = 0; i < iSamplingCount; i++)
                                    Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId, i > sCompany.Length - 1 ? "" : sCompany[i]);
                            }
                    }
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
            */
            #endregion 
        }

        protected virtual void OnClickHistoryCard(object sender, RoutedEventArgs e)
        {
            if (string.Equals(procId, Process.MIXING))
            {
                LGC.GMES.MES.CMM001.CMM_ELEC_REPORT3 wndPopup1 = new LGC.GMES.MES.CMM001.CMM_ELEC_REPORT3();
                wndPopup1.FrameOperation = FrameOperation;

                if (wndPopup1 != null)
                {
                    (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                    object[] Parameters = new object[3];
                    Parameters[0] = txtEndLotId.Text; //LOT ID
                    Parameters[1] = procId; //PROCESS ID
                    Parameters[2] = "Y";    // 실적확정 여부

                    C1WindowExtension.SetParameters(wndPopup1, Parameters);

                    this.Dispatcher.BeginInvoke(new Action(() => wndPopup1.ShowModal()));
                }
            }
            else
            {
                LGC.GMES.MES.CMM001.CMM_ELEC_REPORT2 wndPopup2 = new LGC.GMES.MES.CMM001.CMM_ELEC_REPORT2();
                wndPopup2.FrameOperation = FrameOperation;

                if (wndPopup2 != null)
                {
                    (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;

                    object[] Parameters = new object[4];
                    Parameters[0] = txtEndLotId.Text; //LOT ID
                    Parameters[1] = procId; //PROCESS ID

                    // SKIDID
                    // 슬리터 2차 추가  2021-09-15 by 오화백
                    if ((string.Equals(procId, Process.SLITTING)|| string.Equals(procId, "E4200"))&& !string.IsNullOrEmpty(Util.NVC(txtEndLotId.Tag)))
                        Parameters[2] = Util.NVC(txtEndLotId.Tag);
                    else
                        Parameters[2] = string.Empty;

                    Parameters[3] = "Y";    // 실적확정 여부

                    C1WindowExtension.SetParameters(wndPopup2, Parameters);

                    this.Dispatcher.BeginInvoke(new Action(() => wndPopup2.ShowModal()));
                }
            }
            // RTLS (Only 자동차 2동)
            //if (LoginInfo.CFG_AREA_ID == "E6")
            //    RunRTLS(txtEndLotId.Text, PROCID);
        }

        protected virtual void OnClickCleanLot(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrEmpty(LARGELOTID))
                return;

            string ValuetoLotID = string.Empty;

            DataTable dt = DataTableConverter.Convert(LARGELOT_GRID.ItemsSource);

            foreach (DataRow dRow in dt.Rows)
                if (Convert.ToBoolean(dRow["CHK"]) == true)
                    ValuetoLotID = dRow["LOTID_LARGE"].ToString();

            if (string.IsNullOrEmpty(ValuetoLotID))
            {
                Util.MessageValidation("SFU1490");  //대LOT을 선택하십시오.
                return;
            }
            SetDeleteLargeLot(ValuetoLotID);
        }

        protected virtual void OnClickCancelFLot(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_FCUT wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_FCUT();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[2];
                Parameters[0] = procId; //PROCESS ID
                Parameters[1] = isSingleCoater ? "Y" : "N";

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        protected virtual void OnClickEqptIssue(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            LGC.GMES.MES.CMM001.CMM_COM_EQPCOMMENT wndEqpComment = new LGC.GMES.MES.CMM001.CMM_COM_EQPCOMMENT();
            wndEqpComment.FrameOperation = FrameOperation;

            if (wndEqpComment != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[2] = procId;
                Parameters[3] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
                Parameters[4] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                Parameters[5] = EQUIPMENT_COMBO.Text;
                Parameters[6] = Util.NVC(txtShift.Text);
                Parameters[7] = Util.NVC(txtShift.Tag);
                Parameters[8] = Util.NVC(txtWorker.Text);
                Parameters[9] = Util.NVC(txtWorker.Tag);

                C1WindowExtension.SetParameters(wndEqpComment, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndEqpComment.ShowModal()));
            }
        }

        protected virtual void OnClickLotCut(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_LOTCUT wndPopup = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_LOTCUT();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[1];
                Parameters[0] = procId;

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        private void OnClickSlBatch(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_SLBATCH wndPopup = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_SLBATCH();
            wndPopup.FrameOperation = FrameOperation;
            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[1];
                Parameters[0] = procId;

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        protected virtual void OnClickEqptCond(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            if (iRow < 0)
            {
                Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                return;
            }

            CMM_ELEC_EQPT_COND wndPopup = new CMM_ELEC_EQPT_COND();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[6];
                Parameters[0] = EQUIPMENT_COMBO.SelectedValue;
                Parameters[1] = EQUIPMENT_COMBO.Text;
                Parameters[2] = procId;
                Parameters[3] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        protected virtual void OnClickPrintLabel(object sender, RoutedEventArgs e)
        {
            if(EQUIPMENTSEGMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1223");  //라인을 선택하세요.
                return;
            }

            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            if (LoginInfo.CFG_LABEL_AUTO == "Y" && IsAreaCommonCodeUse("BARCODE_PRINT_PWD", procId))
            {
                CMM_ELEC_BARCODE_AUTH authConfirm = new CMM_ELEC_BARCODE_AUTH();
                authConfirm.FrameOperation = FrameOperation;
                if (authConfirm != null)
                {
                    object[] Parameters = new object[1];
                    Parameters[0] = procId;

                    C1WindowExtension.SetParameters(authConfirm, Parameters);
                    authConfirm.Closed += new EventHandler(OnCloseAuthConfirm_Delete);

                    foreach (Grid tmp in Util.FindVisualChildren<Grid>(Application.Current.MainWindow))
                    {
                        if (tmp.Name == "grdMain")
                        {
                            tmp.Children.Add(authConfirm);
                            authConfirm.BringToFront();
                            break;
                        }
                    }
                }
            }
            else
            {
                CMM_ELEC_BARCODE wndPopup = new CMM_ELEC_BARCODE();
                wndPopup.FrameOperation = FrameOperation;

                if (wndPopup != null)
                {
                    (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                    object[] Parameters = new object[3];
                    Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue;
                    Parameters[1] = procId;
                    Parameters[2] = EQUIPMENT_COMBO.SelectedValue;

                    C1WindowExtension.SetParameters(wndPopup, Parameters);

                    this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
                }
            }
        }

        private void OnCloseAuthConfirm_Delete(object sender, EventArgs e)
        {
            CMM_ELEC_BARCODE wndPopup = new CMM_ELEC_BARCODE();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[3];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue;
                Parameters[1] = procId;
                Parameters[2] = EQUIPMENT_COMBO.SelectedValue;

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }

            foreach (Grid tmp in Util.FindVisualChildren<Grid>(Application.Current.MainWindow))
            {
                if (tmp.Name == "grdMain")
                {
                    tmp.Children.Remove(wndPopup);
                    break;
                }
            }
        }

        protected virtual void OnClickLotIssue(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            if (iRow < 0)
            {
                Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                return;
            }
            String sLOTID = String.Empty;
            if (Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID_PR")).Equals(""))
            {
                sLOTID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
            }
            else
            {
                sLOTID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID_PR"));
            }

            LGC.GMES.MES.CMM001.CMM_COM_ELEC_LOT_ISSUE wndLotIssue = new LGC.GMES.MES.CMM001.CMM_COM_ELEC_LOT_ISSUE();
            wndLotIssue.FrameOperation = FrameOperation;

            if (wndLotIssue != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[6];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[2] = procId;
                Parameters[3] = iRow < 0 ? "" : sLOTID;
                Parameters[4] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                Parameters[5] = EQUIPMENT_COMBO.Text;

                C1WindowExtension.SetParameters(wndLotIssue, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndLotIssue.ShowModal()));
            }
        }

        protected virtual void OnClickMixConfirm(object sender, RoutedEventArgs e)
        {
            if (!(string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING)))
            {
                if (EQUIPMENT_COMBO.SelectedIndex < 1)
                {
                    Util.MessageValidation("SFU1673"); //설비를 선택하세요.
                    return;
                }
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            //if (iRow < 0)
            //{
            //    Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
            //    return;
            //}

            LGC.GMES.MES.CMM001.CMM_COM_ELEC_MIXCONFIRM wndLotIssue = new LGC.GMES.MES.CMM001.CMM_COM_ELEC_MIXCONFIRM();
            wndLotIssue.FrameOperation = FrameOperation;

            if (wndLotIssue != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[6];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[2] = procId;
                Parameters[3] = ""; // iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
                Parameters[4] = ""; //iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                Parameters[5] = EQUIPMENT_COMBO.Text;

                C1WindowExtension.SetParameters(wndLotIssue, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndLotIssue.ShowModal()));
            }
        }

        protected virtual void OnClickSamplingProd( object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_RP_SAMPLING wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_RP_SAMPLING();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;

                C1WindowExtension.SetParameters(wndPopup, null);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }
        #region [Sampling]
        protected virtual void OnClickSamplingProdT1(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_SAMPLING wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_SAMPLING();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;

                object[] Parameters = new object[1];
                Parameters[0] = procId;

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }
        #endregion

        protected virtual void OnClickProcReturn( object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_RP_RETURN wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_RP_RETURN();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;

                C1WindowExtension.SetParameters(wndPopup, null);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        // 코터Cut 임의 생성 [2018-11-15]
        protected virtual void OnStartCoaterCut( object sender, RoutedEventArgs e )
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            DataTable dt = DataTableConverter.Convert(LARGELOT_GRID.ItemsSource);
            string ValuetoLotID = string.Empty;

            foreach (DataRow dRow in dt.Rows)
                if (Convert.ToBoolean(dRow["CHK"]) == true)
                    ValuetoLotID = dRow["LOTID_LARGE"].ToString();

            if (string.IsNullOrEmpty(ValuetoLotID))
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                Util.MessageValidation("SFU1490");  //대LOT을 선택하십시오.
                return;
            }

            LGC.GMES.MES.CMM001.CMM_ELEC_START_COAT_LOT wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_START_COAT_LOT();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[5];
                Parameters[0] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.Text;
                Parameters[2] = ValuetoLotID;
                Parameters[3] = isSingleCoater;
                Parameters[4] = COATTYPE_COMBO.Visibility == Visibility.Visible ? Util.NVC(COATTYPE_COMBO.SelectedValue) : string.Empty;

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                wndPopup.Closed += new EventHandler(OnCloseStartCoaterCut);
                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        // 코터Cut 임의 생성 후 처리 [2018-11-15]
        private void OnCloseStartCoaterCut(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_START_COAT_LOT window = sender as LGC.GMES.MES.CMM001.CMM_ELEC_START_COAT_LOT;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                GetProductLot(LARGELOT_GRID.Rows[LARGELOT_GRID.SelectedIndex].DataItem as DataRowView);

                DataTable dt = DataTableConverter.Convert(LARGELOT_GRID.ItemsSource);

                for ( int i = 0; i < dt.Rows.Count; i++)
                {
                    if ( string.Equals(dt.Rows[i]["LOTID_LARGE"], window.returnLargeLotID ))
                    {
                        DataTableConverter.SetValue(LARGELOT_GRID.Rows[i].DataItem, "CHK", true);
                        LARGELOT_GRID.SelectedIndex = i;
                        return;
                    }
                }
            }
        }

        protected virtual void OnExtraMouseLeave(object sender, MouseEventArgs e)
        {
            (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
        }

        protected virtual void OnClickMixerTankInfo(object sender, RoutedEventArgs e)
        {
            string sPRODID = string.Empty;

            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");
            int iRow2 = new Util().GetDataGridCheckFirstRowIndex(LARGELOT_GRID, "CHK");

            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_MIXER_TANK_INFO wndMixerTankInfo = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_MIXER_TANK_INFO();
            wndMixerTankInfo.FrameOperation = FrameOperation;

            if (wndMixerTankInfo != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[2] = procId;
                Parameters[3] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
                Parameters[4] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                //CSR : [C20211216-000385] - 코터 장착된 Slurry Lot 양품량과 코터 생산실적 총량을 비교하여 팝업 실행 여부
                UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;
                int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");
                if (idx > -1 && string.Equals(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "EIO_WO_SEL_STAT"), "Y"))
                {
                    sPRODID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "PRODID"));
                }
                Parameters[5] = (sPRODID == "" || sPRODID == null) ? null : Util.NVC(sPRODID);
                Parameters[6] = txtSlurry1.Tag;
                /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                C1WindowExtension.SetParameters(wndMixerTankInfo, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndMixerTankInfo.ShowModal()));
            }
        }

        protected virtual void OnClickMixerSlurryConfInfo(object sender, RoutedEventArgs e)
        {
            //if (EQUIPMENT_COMBO.SelectedIndex < 1)
            //{
            //    Util.MessageValidation("SFU1673");  //설비를 선택하세요.
            //    return;
            //}

            LGC.GMES.MES.CMM001.CMM_ELEC_SLURRY_CONF wndMixerSlurryConfInfo = new LGC.GMES.MES.CMM001.CMM_ELEC_SLURRY_CONF();
            wndMixerSlurryConfInfo.FrameOperation = FrameOperation;

            if (wndMixerSlurryConfInfo != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                Parameters[0] = LoginInfo.CFG_AREA_ID;

                C1WindowExtension.SetParameters(wndMixerSlurryConfInfo, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndMixerSlurryConfInfo.ShowModal()));
            }
        }

        protected virtual void OnClickSkidTypeSettingByPort(object sender, RoutedEventArgs e)
        {
            CMM_ELEC_SKIDTYPE_SETTING_PORT popSkidTypeSettingByPort = new CMM_ELEC_SKIDTYPE_SETTING_PORT { FrameOperation = FrameOperation };
            object[] parameters = new object[6];
            parameters[0] = LoginInfo.CFG_AREA_ID;
            C1WindowExtension.SetParameters(popSkidTypeSettingByPort, parameters);

            popSkidTypeSettingByPort.Closed += popSkidTypeSettingByPort_Closed;
            Dispatcher.BeginInvoke(new Action(() => popSkidTypeSettingByPort.ShowModal()));
        }

        protected virtual void OnClickRollMapInputMaterial(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_MTRL_INPUT_INFO window = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_MTRL_INPUT_INFO();
            window.FrameOperation = FrameOperation;

            if (window != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                Parameters[0] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[2] = procId;
                Parameters[3] = iRow < 0 ? "" : Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));

                C1WindowExtension.SetParameters(window, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => window.ShowModal()));
            }
        }

        protected virtual void OnClickSlurryManualOutput(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_MANUAL_DRANE window = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_MANUAL_DRANE();
            window.FrameOperation = FrameOperation;

            if (window != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                //Parameters[0] = Util.GetCondition(cboAreaSupply);
                //Parameters[1] = "A1ECOT001";
                //popupSlurryMove.Closed += new EventHandler(PopupRollMapUpdate_Closed);
                C1WindowExtension.SetParameters(window, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => window.ShowModal()));
            }
        }

        protected virtual void OnClickSlurryManualInput(object sender, RoutedEventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_MANUAL_INPUT window = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_MANUAL_INPUT();
            window.FrameOperation = FrameOperation;

            if (window != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[10];
                //Parameters[0] = Util.GetCondition(cboAreaSupply);
                //Parameters[1] = "A1ECOT001";
                //popupSlurryMove.Closed += new EventHandler(PopupRollMapUpdate_Closed);
                C1WindowExtension.SetParameters(window, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => window.ShowModal()));
            }
        }

        protected virtual void OnClickSlurryBufferManualInit(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_SLURRY_BUFFER_INIT window = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_COATER_SLURRY_BUFFER_INIT();
            window.FrameOperation = FrameOperation;

            if (window != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[2];
                Parameters[0] = EQUIPMENT_COMBO.SelectedValue.ToString();
                Parameters[1] = LoginInfo.CFG_AREA_ID;

                C1WindowExtension.SetParameters(window, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => window.ShowModal()));
            }
        }


        private void popSkidTypeSettingByPort_Closed(object sender, EventArgs e)
        {
            CMM_ELEC_SKIDTYPE_SETTING_PORT popup = sender as CMM_ELEC_SKIDTYPE_SETTING_PORT;
            if (popup != null && popup.IsUpdated)
            {
                //OnClickSearch(null, null);
            }
        }
        
        private void SetDeleteLargeLot(string LargeLotId)
        {
            //대LOT 정리를 하시겠습니까?
            Util.MessageConfirm("SFU1488", (sresult) =>
            {
                if (sresult == MessageBoxResult.OK)
                {
                    DataTable inTable = new DataTable();
                    inTable.Columns.Add("SRCTYPE", typeof(string));
                    inTable.Columns.Add("IFMODE", typeof(string));
                    inTable.Columns.Add("EQPTID", typeof(string));
                    inTable.Columns.Add("LOTID", typeof(string));
                    inTable.Columns.Add("USERID", typeof(string));
                    inTable.Columns.Add("COATING_SIDE_TYPE_CODE", typeof(string));

                    DataRow indata = inTable.NewRow();
                    indata["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                    indata["IFMODE"] = IFMODE.IFMODE_OFF;
                    indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                    indata["LOTID"] = LargeLotId;
                    indata["USERID"] = LoginInfo.USERID;
                    indata["COATING_SIDE_TYPE_CODE"] = COATTYPE_COMBO.Visibility == Visibility.Visible ? COATTYPE_COMBO.SelectedValue : null;
                    inTable.Rows.Add(indata);

                    new ClientProxy().ExecuteService("BR_PRD_REG_TERM_LARGE_LOT", "INDATA", null, inTable, (result, searchException) =>
                    {
                        try
                        {
                            if (searchException != null)
                            {
                                Util.MessageException(searchException);
                                return;
                            }
                            Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.

                            OnClickSearch(SEARCHBUTTON, null);
                        }
                        catch (Exception ex) { Util.MessageException(ex); }
                    });
                    LARGELOTID = string.Empty;
                }
            });
        }

        protected virtual void OnClickSaveWipReason(object sender, RoutedEventArgs e)
        {
            // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
            if (ValidConfirmLotCheck() == false)
                return;

            try
            {
                SaveDefect(WIPREASON_GRID);

                if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                    SaveDefect(WIPREASON2_GRID);

                // C20220406-000241 - 자동차 1, 2동 전극 슬리터 바코드 불량수, Tag수 표시
                if (isBarCodePrint)
                {
                    SaveDefectCheckUpDate("Y");
                }

                /*
                if (isRollMapEquipment && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING)))
                {
                    //최재철 책임 요청으로 현재 [저장] 버튼 클릭 후 호출하는 DA_PRD_REG_ADJ_LOGIC_01_CT_RM 는 호출하지 않도록 수정 함(2021.04.26)
                    // 보정로직 호출
                    //SaveAdjustmentDefect();
                    SaveDefectForRollMap();

                    isChangeWipReason = false;
                    Util.MessageInfo("SFU1270");    //저장되었습니다.

                    GetDefectList();
                }
                else
                {
                    isChangeWipReason = false;
                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                }
                */

                if (isRollMapEquipment)
                {
                    SaveDefectForRollMap();
                    isChangeWipReason = false;
                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                    GetDefectList();
                }
                else
                {
                    //C20210928-000558 Slitter Process adds NG TAG columns in remark
                    if (isRemarkNgTag)
                        GetResultInfo();
                    ////////////////////////////////////////////////////////////////

                    isChangeWipReason = false;
                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        protected virtual void OnClickProcReason(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            if (iRow < 0)
            {
                Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                return;
            }

            // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
            if (ValidConfirmLotCheck() == false)
                return;

            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN wndPopup = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                object[] Parameters = new object[5];
                Parameters[0] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[1] = procId;
                Parameters[2] = _CUTID;
                Parameters[3] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                Parameters[4] = GetUnitFormatted();

                C1WindowExtension.SetParameters(wndPopup, Parameters);

                wndPopup.Closed += new EventHandler(OnCloseProcReason);
                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        private void OnCloseProcReason(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN window = sender as LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN;
            if (window.DialogResult == MessageBoxResult.OK)
                SetProcWipReasonData();
        }

        protected virtual void OnSumReasonGridChecked(object sender, RoutedEventArgs e)
        {
            CheckBox cb = sender as CheckBox;

            if (cb != null && (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count)
            {
                WIPREASON_GRID.Refresh(false);

                if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectList();
                else if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectListMultiLane();

                //WIPREASON_GRID.UpdateLayout();
                //WIPREASON_GRID.Refresh(true);
            }
        }

        protected virtual void OnLaneSelectionItemChanged(object sender, PropertyChangedEventArgs<object> e)
        {
            LANENUM_COMBO.Text = ObjectDic.Instance.GetObjectName("Lane선택");
        }

        protected virtual void OnLaneChecked(object sender, RoutedEventArgs e)
        {
            CheckBox checkBox = sender as CheckBox;

            if (checkBox != null)
            {
                if (string.Equals(checkBox.Tag, "ALL"))
                {
                    foreach (CheckBox _checkBox in LANENUM_COMBO.Items)
                        _checkBox.IsChecked = checkBox.IsChecked;
                }
                else
                {
                    SetVisibilityWipReasonGrid(Util.NVC(checkBox.Tag), checkBox.IsChecked);
                }
            }
        }
        #region [Cancel Delete Lot]
        protected virtual void OnCancelDeleteLot(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENTSEGMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1223");  //라인을 선택하세요.
                return;
            }

            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_DELETE_LOT wndPopup = new LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_DELETE_LOT();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;
                object[] Parameters = new object[3];
                Parameters[0] = procId; //PROCESS ID
                Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[2] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);

                C1WindowExtension.SetParameters(wndPopup, Parameters);
                wndPopup.Closed += new EventHandler(OnCloseCancelDeleteLot);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }
        private void OnCloseCancelDeleteLot(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_DELETE_LOT window = sender as LGC.GMES.MES.CMM001.CMM_ELEC_CANCEL_DELETE_LOT;
            if (window.DialogResult == MessageBoxResult.OK)
                REFRESH = true;
        }
        #endregion
        private void SetVisibilityWipReasonGrid(string sLotID, bool? isVisibility)
        {
            for (int i = WIPREASON_GRID.Columns["TAG_CONV_RATE"].Index; i < WIPREASON_GRID.Columns.Count; i++)
            {
                // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                if (string.Equals(sLotID, WIPREASON_GRID.Columns[i].Name) ||
                    ((grdDataCollect.Children[0] as UcDataCollect).chkSum.IsChecked == false &&
                        (string.Equals(sLotID + "NUM", WIPREASON_GRID.Columns[i].Name) || string.Equals(sLotID + "CNT", WIPREASON_GRID.Columns[i].Name))))
                    WIPREASON_GRID.Columns[i].Visibility = isVisibility == true ? Visibility.Visible : Visibility.Collapsed;
            }
        }

        // cnszhftm15
        private void SaveCotton(C1DataGrid dg)
        {


            string[] SLIT_CHK = new string[5];
            SLIT_CHK[0] = "SLIT_CHK_001";
            SLIT_CHK[1] = "SLIT_CHK_002";
            SLIT_CHK[2] = "SLIT_CHK_003";
            SLIT_CHK[3] = "SLIT_CHK_004";
            SLIT_CHK[4] = "SLIT_CHK_005";

            DataSet inDataSet = new DataSet();
            DataTable dtCotton = (dg.ItemsSource as DataView).Table;

            DataRow inDataRow = null;
            DataTable IndataTable = inDataSet.Tables.Add("INDATA");
            IndataTable.Columns.Add("WIPSEQ", typeof(string));
            IndataTable.Columns.Add("NOTE", typeof(string));
            IndataTable.Columns.Add("USERID", typeof(string));

            inDataRow = IndataTable.NewRow();
            inDataRow["WIPSEQ"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[0].DataItem, "WIPSEQ"));
            inDataRow["NOTE"] = "";
            inDataRow["USERID"] = LoginInfo.USERID;

            IndataTable.Rows.Add(inDataRow);

            DataRow inDataRow2 = null;
            DataTable IndataTable2 = inDataSet.Tables.Add("IN_LOT");
            IndataTable2.Columns.Add("LOTID", typeof(string));
            IndataTable2.Columns.Add("SLIT_CHK_ITEM_CODE", typeof(string));
            IndataTable2.Columns.Add("CHK_RSLT", typeof(string));


            for (int k = 0; k< dtCotton.Rows.Count; k++) {

                for (int i = 0; i < SLIT_CHK.Length; i++)
                {

                    inDataRow2 = IndataTable2.NewRow();
                    string schk = dtCotton.Rows[k][SLIT_CHK[i]].ToString();
                    if (schk.Equals("True"))
                    {
                        schk = "Y";
                    }
                    else
                    {
                        if (schk.Equals("False"))
                        {
                            schk = "";
                        }
                    }

                    inDataRow2["LOTID"] = dtCotton.Rows[k]["LOTID"].ToString();
                    inDataRow2["SLIT_CHK_ITEM_CODE"] = SLIT_CHK[i].ToString();
                    inDataRow2["CHK_RSLT"] = schk;
                    IndataTable2.Rows.Add(inDataRow2);
                }

            }

            try
            {
                DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_SLIT_CHK_DATA", "INDATA,IN_LOT", null, inDataSet);
                COTTON_GRID.EndEdit(true);
                isChangeCotton = false;
                Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
            }
            catch (Exception ex) { Util.MessageException(ex); }




        }
        #region[POSTACTION]
        private void SavePostHold()
        {
            if (POSTHOLD_GRID.GetRowCount() < 1)
                return;
            DataTable dt = ((DataView)POSTHOLD_GRID.ItemsSource).Table;

            int idx = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");
            string wipseq = string.Empty;
            if (idx >= 0)
                wipseq = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[idx].DataItem, "WIPSEQ"));
            else
                return;
            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIP_NOTE", typeof(string));
                inTable.Columns.Add("USERID", typeof(string));

                DataRow inData = null;
                for (int i = 1; i < dt.Rows.Count; i++)
                {
                    inData = inTable.NewRow();

                    inData["LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);

                    if (POSTHOLD_GRID.Rows[0].Visibility == Visibility.Visible)
                        inData["WIP_NOTE"] = Util.NVC(dt.Rows[i]["REMARK"]) + "|" + Util.NVC(dt.Rows[0]["REMARK"]);
                    else
                        inData["WIP_NOTE"] = Util.NVC(dt.Rows[i]["REMARK"]);

                    inData["USERID"] = LoginInfo.USERID;
                    inTable.Rows.Add(inData);
                }

                new ClientProxy().ExecuteService("BR_PRD_REG_WIPHISTORY_NOTE", "INDATA", null, inTable, (result, ex) =>
                {
                    if (ex != null)
                    {
                        Util.MessageException(ex);
                        return;
                    }
                    string[] HOLD_CHK = new string[1];
                    HOLD_CHK[0] = "POST_HOLD_001";

                    DataSet inDataSet = new DataSet();
                    DataTable dtpostHold = (POSTHOLD_GRID.ItemsSource as DataView).Table;

                    DataRow inDataRow = null;
                    DataTable IndataTable = inDataSet.Tables.Add("INDATA");
                    IndataTable.Columns.Add("WIPSEQ", typeof(string));
                    IndataTable.Columns.Add("USERID", typeof(string));

                    inDataRow = IndataTable.NewRow();
                    inDataRow["WIPSEQ"] = wipseq;
                    inDataRow["USERID"] = LoginInfo.USERID;

                    IndataTable.Rows.Add(inDataRow);

                    DataRow inDataRow2 = null;
                    DataTable IndataTable2 = inDataSet.Tables.Add("IN_LOT");
                    IndataTable2.Columns.Add("LOTID", typeof(string));
                    IndataTable2.Columns.Add("HOLD_CHK_ITEM_CODE", typeof(string));
                    IndataTable2.Columns.Add("CHK_RSLT", typeof(string));
                    IndataTable2.Columns.Add("HOLD", typeof(string));
                    IndataTable2.Columns.Add("NOTE", typeof(string));
                    for (int k = 0; k < dtpostHold.Rows.Count; k++)
                    {
                        if (!string.Equals(Util.NVC(dtpostHold.Rows[k]["LOTID"]), ObjectDic.Instance.GetObjectName("공통특이사항")))
                        {
                            for (int i = 0; i < HOLD_CHK.Length; i++)
                            {
                                inDataRow2 = IndataTable2.NewRow();
                                inDataRow2["LOTID"] = Util.NVC(dtpostHold.Rows[k]["LOTID"]);
                                inDataRow2["HOLD_CHK_ITEM_CODE"] = HOLD_CHK[i].ToString();
                                inDataRow2["CHK_RSLT"] = "N";
                                inDataRow2["HOLD"] = string.Equals(Util.NVC(dtpostHold.Rows[k]["POST_HOLD"]), "True") ? "Y" : "N";

                                if (POSTHOLD_GRID.Rows[0].Visibility == Visibility.Visible)
                                    inDataRow2["NOTE"] = Util.NVC(dtpostHold.Rows[k]["REMARK"]) + "|" + Util.NVC(dtpostHold.Rows[0]["REMARK"]);
                                else
                                    inDataRow2["NOTE"] = Util.NVC(dtpostHold.Rows[k]["REMARK"]);

                                IndataTable2.Rows.Add(inDataRow2);
                            }
                        }
                    }
                    DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_POST_HOLD", "INDATA,IN_LOT", null, inDataSet);
                    POSTHOLD_GRID.EndEdit(true);
                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                    isChangePostAction = false;

                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        #endregion

        private DataTable dtDataCollectOfChildDefect(C1DataGrid dg)
        {
            DataTable IndataTable = inDataSet.Tables.Add("INRESN");

            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("WIPSEQ", typeof(Int32));
            IndataTable.Columns.Add("ACTID", typeof(string));
            IndataTable.Columns.Add("RESNCODE", typeof(string));
            IndataTable.Columns.Add("RESNQTY", typeof(double));
            IndataTable.Columns.Add("DFCT_TAG_QTY", typeof(Int32));
            IndataTable.Columns.Add("LANE_QTY", typeof(Int32));
            IndataTable.Columns.Add("LANE_PTN_QTY", typeof(Int32));
            IndataTable.Columns.Add("COST_CNTR_ID", typeof(string));

            // if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
            // 횟수 전 공정 추가로 수정 (C20190416_75868) [2019-04-16]

            // 슬리터2차 추가  2021-09-15 by 오화백 
            if (isResnCountUse == true && (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING)))
                IndataTable.Columns.Add("WRK_COUNT", typeof(Int16));

            DataRow inDataRow = null;
            DataTable dtTop = (dg.ItemsSource as DataView).Table;

            foreach (DataRow _iRow in dtTop.Rows)
            {
                inDataRow = IndataTable.NewRow();
                inDataRow["LOTID"] = _LOTID;
                inDataRow["WIPSEQ"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "WIPSEQ");
                inDataRow["ACTID"] = _iRow["ACTID"];
                inDataRow["RESNCODE"] = _iRow["RESNCODE"];
                inDataRow["RESNQTY"] = _iRow["RESNQTY"].ToString().Equals("") ? 0 : _iRow["RESNQTY"];
                inDataRow["DFCT_TAG_QTY"] = string.IsNullOrEmpty(Util.NVC(_iRow["DFCT_TAG_QTY"])) ? 0 : _iRow["DFCT_TAG_QTY"];

                // SLITTING 공정에서 Deffec 저장 시 LANE수량 1로 변경 요청 [2017-01-17]
                // 슬리터 2차 추가  2021-09-15 by 오화백 
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                {
                    inDataRow["LANE_QTY"] = 1; //txtLaneQty.Value;
                    inDataRow["LANE_PTN_QTY"] = 1; //txtLanePatternQty.Value;
                }
                else
                {
                    inDataRow["LANE_QTY"] = txtLaneQty == null ? 0 : txtLaneQty.Value;
                    inDataRow["LANE_PTN_QTY"] = txtLanePatternQty == null ? 0 : txtLanePatternQty.Value;
                }
                inDataRow["COST_CNTR_ID"] = _iRow["COSTCENTERID"];

                //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                // 횟수 전 공정 추가로 수정 (C20190416_75868) [2019-04-16]
                // 슬리터2차 추가 2021-09-15 by 오화백
                if (isResnCountUse == true && (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING)))
                    inDataRow["WRK_COUNT"] = _iRow["COUNTQTY"].ToString() == "" ? DBNull.Value : _iRow["COUNTQTY"];

                IndataTable.Rows.Add(inDataRow);
            }
            return IndataTable;
        }

        private DataTable dtDataCollectOfChildrenDefect(C1DataGrid dg)
        {
            DataTable IndataTable = inDataSet.Tables.Add("INRESN");

            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("WIPSEQ", typeof(Int32));
            IndataTable.Columns.Add("ACTID", typeof(string));
            IndataTable.Columns.Add("RESNCODE", typeof(string));
            IndataTable.Columns.Add("RESNQTY", typeof(double));
            IndataTable.Columns.Add("DFCT_TAG_QTY", typeof(Int32));
            IndataTable.Columns.Add("LANE_QTY", typeof(Int32));
            IndataTable.Columns.Add("LANE_PTN_QTY", typeof(Int32));
            IndataTable.Columns.Add("COST_CNTR_ID", typeof(string));

            //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
            // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
            if (isResnCountUse == true)
                IndataTable.Columns.Add("WRK_COUNT", typeof(Int16));

            int iCount = isResnCountUse == true ? 1 : 0;

            DataTable dt = (dg.ItemsSource as DataView).Table;
            DataRow inData = null;
            int iLotCount = 0;

            for (int iCol = dg.Columns["ALL"].Index + (2 + iCount); iCol < dg.Columns["COSTCENTERID"].Index; iCol += (2 + iCount))
            {
                string sublotid = dg.Columns[iCol].Name;

                foreach (DataRow _iRow in dt.Rows)
                {
                    inData = IndataTable.NewRow();

                    inData["LOTID"] = sublotid;
                    inData["WIPSEQ"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "WIPSEQ");
                    inData["ACTID"] = _iRow["ACTID"];
                    inData["RESNCODE"] = _iRow["RESNCODE"];
                    inData["RESNQTY"] = _iRow[sublotid].ToString().Equals("") ? 0 : _iRow[sublotid];
                    inData["DFCT_TAG_QTY"] = _iRow[sublotid + "CNT"].ToString().Equals("") ? 0 : _iRow[sublotid + "CNT"];

                    // SLITTING 공정에서 Deffec 저장 시 LANE수량 1로 변경 요청 [2017-01-17]
                    // 슬리터 2차 추가  2021-09-15 by 오화백 
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                    {
                        inData["LANE_QTY"] = 1; //txtLaneQty.Value;
                        inData["LANE_PTN_QTY"] = 1; //txtLanePatternQty.Value;
                    }
                    else if ( string.Equals(procId, Process.HALF_SLITTING))
                    {
                        inData["LANE_QTY"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count + iLotCount].DataItem, "LANE_QTY");
                        inData["LANE_PTN_QTY"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count + iLotCount].DataItem, "LANE_PTN_QTY");
                    }
                    else
                    {
                        inData["LANE_QTY"] = txtLaneQty.Value;
                        inData["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                    }
                    inData["COST_CNTR_ID"] = _iRow["COSTCENTERID"];

                    //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                    //    inData["WRK_COUNT"] = _iRow["COUNTQTY"].ToString() == "" ? DBNull.Value : _iRow["COUNTQTY"];
                    if (isResnCountUse == true)
                        inData["WRK_COUNT"] = string.IsNullOrEmpty(_iRow[sublotid + "NUM"].ToString()) ? 0 : _iRow[sublotid + "NUM"];

                    IndataTable.Rows.Add(inData);
                }
                iLotCount++;
            }
            return IndataTable;
        }

        /// <summary>
        /// 다중 자LOT용
        /// </summary>
        private void SaveDefect(C1DataGrid dg)
        {
            if (dg.GetRowCount() <= 0)
            {
                Util.MessageValidation("SFU1578");  //불량 항목이 없습니다.
                return;
            }

            #region SAVE DEFECT
            inDataSet = new DataSet();

            DataTable inDataTable = inDataSet.Tables.Add("INDATA");
            inDataTable.Columns.Add("SRCTYPE", typeof(string));
            inDataTable.Columns.Add("IFMODE", typeof(string));
            inDataTable.Columns.Add("EQPTID", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));
            inDataTable.Columns.Add("AREAID", typeof(string));
            inDataTable.Columns.Add("PROCID", typeof(string));

            DataRow inDataRow = null;

            inDataRow = inDataTable.NewRow();
            inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
            inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
            inDataRow["EQPTID"] = _EQPTID;
            inDataRow["USERID"] = LoginInfo.USERID;
            inDataRow["AREAID"] = LoginInfo.CFG_AREA_ID;
            inDataRow["PROCID"] = procId;
            inDataTable.Rows.Add(inDataRow);

            DataTable inDefectLot = (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1 ? dtDataCollectOfChildrenDefect(dg) : dtDataCollectOfChildDefect(dg);
            #endregion
            try
            {
                new ClientProxy().ExecuteServiceSync_Multi("BR_QCA_REG_WIPREASONCOLLECT_ALL", "INDATA,INRESN", null, inDataSet);
                dg.EndEdit(true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void SaveAdjustmentDefect()
        {
            string bizRuleName = string.Equals(procId, Process.COATING) ? "DA_PRD_REG_ADJ_LOGIC_01_CT_RM" : "DA_PRD_REG_ADJ_LOGIC_01_RP_UI_RM";

            DataSet inDataSet = new DataSet();
            DataTable inDataTable = inDataSet.Tables.Add("INDATA");
            inDataTable.Columns.Add("EQPTID", typeof(string));
            inDataTable.Columns.Add("LOTID", typeof(string));
            inDataTable.Columns.Add("WIPSEQ", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));

            DataRow inDataRow = null;
            inDataRow = inDataTable.NewRow();
            inDataRow["EQPTID"] = _EQPTID;
            inDataRow["LOTID"] = _LOTID;
            inDataRow["WIPSEQ"] = _WIPSEQ;
            inDataRow["USERID"] = LoginInfo.USERID;
            inDataTable.Rows.Add(inDataRow);

            try
            {
                new ClientProxy().ExecuteServiceSync_Multi(bizRuleName, "INDATA", null, inDataSet);
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void SaveDefectForRollMap()
        {
            string bizRuleName = string.Equals(procId, Process.COATING) ? "BR_PRD_REG_DATACOLLECT_DEFECT_CT" : "BR_PRD_REG_DATACOLLECT_DEFECT_RP";
            DataSet inDataSet = new DataSet();

            DataTable inDataTable = inDataSet.Tables.Add("IN_EQP");
            inDataTable.Columns.Add("SRCTYPE", typeof(string));
            inDataTable.Columns.Add("IFMODE", typeof(string));
            inDataTable.Columns.Add("EQPTID", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));

            DataRow inDataRow = null;
            inDataRow = inDataTable.NewRow();
            inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
            inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
            inDataRow["EQPTID"] = _EQPTID;
            inDataRow["USERID"] = LoginInfo.USERID;
            inDataTable.Rows.Add(inDataRow);

            DataTable IndataTable = inDataSet.Tables.Add("IN_LOT");
            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("WIPSEQ", typeof(Int32));

            inDataRow = IndataTable.NewRow();
            inDataRow["LOTID"] = _LOTID;
            inDataRow["WIPSEQ"] = _WIPSEQ;
            IndataTable.Rows.Add(inDataRow);

            try
            {
                new ClientProxy().ExecuteServiceSync_Multi(bizRuleName, "IN_EQP,IN_LOT", null, inDataSet);
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void SaveDefectCheckUpDate(string sFlag)
        {

            if (REMARK_GRID.GetRowCount() < 1)
                return;

            DataTable dtLot = new DataTable();
            dtLot.Columns.Add("LOTID", typeof(string));
            dtLot.Columns.Add("PET_LINK_FLAG", typeof(string));

            DataTable dt = ((DataView)REMARK_GRID.ItemsSource).Table;
            DataRow drLot = null;
            for (int i = 1; i < dt.Rows.Count; i++)
            {
                if (!string.Equals(Util.NVC(dt.Rows[i]["LOTID"]), ObjectDic.Instance.GetObjectName("공통특이사항")))
                {
                    drLot = dtLot.NewRow();
                    drLot["LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);
                    drLot["PET_LINK_FLAG"] = sFlag;
                    dtLot.Rows.Add(drLot);
                }
            }

            try
            {
                new ClientProxy().ExecuteServiceSync("DA_PRD_UPD_PET_LINK_FLAG", "RQSTDT", null, dtLot);
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private bool ValidateSpecOut(DataView dv)
        {
            bool isValid = true;

            for(int idx = 0; idx < dv.Table.Rows.Count; idx++)
            {
                if (!string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["USL"])) && !Util.NVC(dv.Table.Rows[idx]["USL"]).Equals(Double.NaN.ToString()) && !Util.NVC(dv.Table.Rows[idx]["USL"]).Equals("0")
                    && !string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["LSL"])) && !Util.NVC(dv.Table.Rows[idx]["LSL"]).Equals(Double.NaN.ToString()) && !Util.NVC(dv.Table.Rows[idx]["LSL"]).Equals("0")
                    && !string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["CLCTVAL01"])) && !Util.NVC(dv.Table.Rows[idx]["CLCTVAL01"]).Equals(Double.NaN.ToString()))
                {
                    if (Util.NVC_Decimal(dv.Table.Rows[idx]["CLCTVAL01"]) > Util.NVC_Decimal(dv.Table.Rows[idx]["USL"])
                       || Util.NVC_Decimal(dv.Table.Rows[idx]["CLCTVAL01"]) < Util.NVC_Decimal(dv.Table.Rows[idx]["LSL"]))
                    {
                        Util.MessageValidation("SFU9002");  //Spec Out 대상이 존재합니다. 확인바랍니다.
                        isValid = false;
                        break;
                    }
                }
            }
            
            return isValid;
        }

        private bool ValidateMandatory(DataView dv)
        {
            bool isValid = true;
            DataTable inTable = new DataTable();
            inTable.Columns.Add("PROCID", typeof(string));
            inTable.Columns.Add("AREAID", typeof(string));

            DataRow newRow = inTable.NewRow();
            newRow["PROCID"] = procId;
            newRow["AREAID"] = LoginInfo.CFG_AREA_ID;

            inTable.Rows.Add(newRow);

            DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_QCA_COM_SEL_SELF_INSP_MANDATORY", "RQSTDT", "RSLTDT", inTable);

            if(dtResult != null && dtResult.Rows.Count > 0)
            {
                for (int idx = 0; idx < dv.Table.Rows.Count; idx++)
                {
                    DataRow[] dr = dtResult.Select("INSP_ITEM_ID='" + Util.NVC(dv.Table.Rows[idx]["INSP_ITEM_ID"]) + "'");

                    if (Util.NVC(dr[0]["MAND_INSP_ITEM_FLAG"]).Equals("Y") 
                        && (string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["CLCTVAL01"])) || Util.NVC(dv.Table.Rows[idx]["CLCTVAL01"]).Equals(Double.NaN.ToString())))
                    {
                        string item = Util.NVC(dv.Table.Rows[idx]["CLSS_NAME1"]);
                        if (!string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["CLSS_NAME2"])))
                        {
                            item += "_" + Util.NVC(dv.Table.Rows[idx]["CLSS_NAME2"]);
                        }
                        if (!string.IsNullOrEmpty(Util.NVC(dv.Table.Rows[idx]["CLSS_NAME3"])))
                        {
                            item += "_" + Util.NVC(dv.Table.Rows[idx]["CLSS_NAME3"]);
                        }
                        Util.MessageValidation("SFU9003", new object[] { item });  //필수항목(xxxx)의 측정값이 누락되었습니다. 확인바랍니다.
                        isValid = false;
                        break;
                    }
                }
            }

            return isValid;
        }

        protected virtual void OnClickSaveQuality(object sender, RoutedEventArgs e)
        {
            // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
            if (ValidConfirmLotCheck() == false)
                return;
            //2023.03.07 김대현
            DataView dvData = QUALITY_GRID.ItemsSource as DataView;
            if (!ValidateSpecOut(dvData))
            {
                //return;
            }

            if (!ValidateMandatory(dvData))
            {
                //return;
            }

            // 롤프레스 자주검사 저장 시 복사해서 붙여넣다가 실수하는 경우 방어를 위하여 로직 추가 (자동차1,2동 요청사항) [2019-01-07]
            // 인터락이 아니기 때문에 현 시점에서는 알림만 띄어달라는 요청 -> 추후에 변경 될 수 있음 (OnClickSaveQuality에 구현은 해놨음)
            if (ValidInspectionDataCheck(QUALITY_GRID) == false)
                Util.MessageInfo("SFU6005");    // 동일한 데이터가 연속으로 입력 되었습니다.

            /*            
            if (ValidInspectionDataCheck(QUALITY_GRID) == false)
            {
                Util.MessageConfirm("SFU6005", (result) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, Process.SRS_SLITTING))
                        {
                            SaveCutQuality(QUALITY_GRID);
                        }
                        else
                        {
                            SaveQuality(QUALITY_GRID);
                        }
                    }
                });
            }
            else
            {
                // 품질정보 SLITTER, SRS SLITTER는 CUT단위로 관리 [2017-02-01]
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, Process.SRS_SLITTING))
                {
                    SaveCutQuality(QUALITY_GRID);
                }
                else
                {
                    SaveQuality(QUALITY_GRID);
                }
            }
            */

            // 품질정보 SLITTER, SRS SLITTER는 CUT단위로 관리 [2017-02-01]
            // 슬리터 2차 추가  2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
            {
                SaveCutQuality(QUALITY_GRID);
            }
            else
            {
                SaveQuality(QUALITY_GRID);

                //if (QUALITY2_GRID.Visibility == Visibility.Visible)
                //    SaveQuality(QUALITY2_GRID);
            }
        }

        protected virtual void OnClickSaveCarrier(object sender, RoutedEventArgs e)
        {
            if (string.Equals(procId, Process.COATING))
            {
                if (_UNLDR_LOT_IDENT_BAS_CODE == "CST_ID" || _UNLDR_LOT_IDENT_BAS_CODE == "RF_ID")
                {
                    if (LOTINFO_GRID.GetRowCount() == 0)
                    {
                        Util.MessageValidation("SFU3552");  //저장 할 DATA가 없습니다.
                        return;
                    }

                    //if (string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[0].DataItem, "OUT_CSTID"))))
                    //{
                    //    Util.MessageValidation("SFU6051");  //입력오류 : Carrier ID를 입력 하세요.
                    //    return;
                    //}

                    DataTable inTable = new DataTable();
                    inTable.Columns.Add("LOTID", typeof(string));
                    inTable.Columns.Add("CSTID", typeof(string));
                    inTable.Columns.Add("USERID", typeof(string));
                    inTable.Columns.Add("SRCTYPE", typeof(string));

                    for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                    {
                        DataRow newRow = inTable.NewRow();
                        newRow["LOTID"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID").ToString();
                        newRow["CSTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "OUT_CSTID"));
                        newRow["USERID"] = LoginInfo.USERID;
                        newRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;

                        inTable.Rows.Add(newRow);

                        if (string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "OUT_CSTID"))))
                        {
                            Util.MessageValidation("SFU6051");  //입력오류 : Carrier ID를 입력 하세요.
                            return;
                        }

                        if (!CheckCstID(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID").ToString(), Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "OUT_CSTID"))))
                        {
                            return;
                        }
                        else
                        {
                            if (!CheckLotID(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID").ToString(), Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "OUT_CSTID"))))
                                return;
                        }
                    }

                    //저장하시겠습니까?
                    Util.MessageConfirm("SFU1241", (result) =>
                    {
                        if (result == MessageBoxResult.OK)
                        {
                            //SaveMappingInfo(DataTableConverter.GetValue(LOTINFO_GRID.Rows[0].DataItem, "LOTID").ToString(), Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[0].DataItem, "OUT_CSTID")));
                            new ClientProxy().ExecuteService("BR_PRD_REG_CSTID_USING_UI", "INDATA", null, inTable, (searchResult, searchException) =>
                            {
                                try
                                {
                                    if (searchException != null)
                                    {
                                        Util.MessageException(searchException);
                                        return;
                                    }

                                    Util.MessageInfo("SFU1275");//정상 처리 되었습니다.

                                }
                                catch (Exception ex)
                                {
                                    Util.MessageException(ex);
                                }
                                finally
                                {
                                }
                            });
                        }
                    });

                }
            }
        }

        protected virtual void OnClickWIPHistory(object sender, RoutedEventArgs e)
        {
            try
            {
                if (EQUIPMENT_COMBO.SelectedIndex < 1)
                {
                    Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                    return;
                }

                // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
                if (ValidConfirmLotCheck() == false)
                    return;

                // 믹서 공정진척 화면에서 생산실적 저장 시 이전 배치 실적(생산량)과 동별공통코드에 설정된 값 이상 차이나면 확인 메시지 팝업 요청
                if (procId.Equals(Process.MIXING) && ValidBeforeQtyCurrQty() == false)
                    return;

                //if (!string.IsNullOrEmpty(txtShiftStartTime.Text) && !string.IsNullOrEmpty(txtShiftEndTime.Text))
                //    SaveWRKHistory();

                if (LOTINFO_GRID.GetRowCount() > 0)
                {
                    if (txtInputQty.Value <= 0)
                    {
                        if (IsCoaterProdVersion() == true && !string.Equals(GetCoaterMaxVersion(), txtVersion.Text))
                        {
                            // 작업지시 최신 Version과 상이합니다! 그래도 저장하시겠습니까?
                            Util.MessageConfirm("SFU4462", (sResult) =>
                            {
                                if (sResult == MessageBoxResult.OK)
                                {
                                    SaveWIPHistory();
                                    System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default;
                                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                                }
                            }, new object[] { GetCoaterMaxVersion(), txtVersion.Text });
                        }
                        else
                        {
                            SaveWIPHistory();
                            System.Windows.Forms.Cursor.Current = System.Windows.Forms.Cursors.Default;
                            Util.MessageInfo("SFU1270");    //저장되었습니다.
                        }
                    }
                }
            }
            catch (Exception ex) { Util.MessageException(ex);}
        }

        private bool IsCoaterProdVersion()
        {
            // 1. 공정체크
            if (!string.Equals(procId, Process.COATING))
                return false;

            // 2. 입력된 VERSION 체크
            if (string.IsNullOrEmpty(txtVersion.Text))
                return false;

            // 3. 양산버전 이외는 체크 안함
            System.Text.RegularExpressions.Regex engRegex = new System.Text.RegularExpressions.Regex(@"[a-zA-Z]");
            if (engRegex.IsMatch(txtVersion.Text.Substring(0, 1)) == true)
                return false;

            // 4. 1번 CUT인지 확인
            string sCut = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "CUT"));
            if (string.IsNullOrEmpty(sCut) || !string.Equals(sCut, "1"))
                return false;

            return true;
        }

        private string GetCoaterMaxVersion()
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                IndataTable.Rows.Add(Indata);

                DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE_MAX_VERSION", "INDATA", "RSLTDT", IndataTable);

                if (dtMain != null && dtMain.Rows.Count > 0)
                    return Util.NVC(dtMain.Rows[0][0]);

            }
            catch (Exception ex) {}

            return "";
        }

        private bool ValidVerLaneQty(string selectedVer, int selectedLaneQty)
        {
            bool bRet = true;
            List<int> checkResult = CheckLaneQty(Util.NVC(txtVersion.Text), Util.NVC_Int(txtLaneQty.Value));
            if (checkResult.Count == 2)
            {
                bRet = false;
                Util.MessageConfirm("SFU8342", (msgResult) =>
                {
                    if (msgResult == MessageBoxResult.OK)
                    {
                        CheckGoodQty(() =>
                        {
                            CheckLabelPassHold(() =>
                            {
                                CheckAuthValidation(() =>
                                {
                                    CheckSpecOutHold(() =>
                                    {
                                        ConfirmCheck();
                                    });
                                });
                            });
                        });
                    }
                }, new object[] { checkResult[0], checkResult[1] });
            }
            return bRet;
        }

        private void WarningVerLaneQty(Dictionary<string, object[]> msgId, string selectedVer, int selectedLaneQty)
        {
            string result = string.Empty;
            if (string.IsNullOrEmpty(selectedVer))
            {
                return;
            }

            //코터만 적용
            if (!procId.Equals(Process.COATING))
            {
                return;
            }

            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("PROD_VER_CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Indata["PROD_VER_CODE"] = Util.NVC(selectedVer);
                IndataTable.Rows.Add(Indata);

                DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE_VER", "INDATA", "RSLTDT", IndataTable);
                if (dtMain.Rows.Count == 0)
                {
                    return;
                }

                int verLaneQty = Util.NVC_Int(dtMain.Rows[0]["LANE_QTY"]);
                if (selectedLaneQty != verLaneQty)
                {
                    msgId.Add("SFU8342", new object[] { selectedLaneQty, verLaneQty });
                }
            }
            catch(Exception ex)
            {
            }
        }

        private void WarningSingleCoaterDefectCount(Dictionary<string, object[]> msgId)
        {
            // C20210722-000438  실적 오기입 방지를 위한 기능 추가 건 2021.08.03
            string result = string.Empty;
            decimal iResnQty = 0;
            if (procId.Equals(Process.COATING) && isSingleCoater)
            {
                for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                {
                    iResnQty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY"));
                    //불량수량이 1000 이상 또는 소숫점여부 확인
                    if (iResnQty > 1000 || (!(iResnQty == (int)iResnQty)))
                    {
                        //SFU8390
                        msgId.Add("SFU8390", null);
                        break;
                    }
                }
            }
        }

        private void WarningQualitySpec(Dictionary<string, object[]> msgId)
        {
            if (!ValidQualitySpec("Hold"))
            {
                msgId.Add("SFU8185", null);
            }
        }

        private void WarningQualitySpecExists(Dictionary<string, object[]> msgId)
        {
            if (!ValidQualitySpecExists())
            {
                msgId.Add("SFU8186", null);
            }
        }

        private void WarningQualityLotType(Dictionary<string, object[]> msgId)
        {
            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
            string result = string.Empty;
            string sPLType = string.Empty;
            string sPLTypeNAME = string.Empty;

            UcProdLot ProdLot = grdProdLot.Children[0] as UcProdLot;

            int idx = new Util().GetDataGridCheckFirstRowIndex(ProdLot.dgProductLot, "CHK");

            if (idx > -1 && Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx].DataItem, "CHK")).Equals("1"))
            {
                sPLType = Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx].DataItem, "LOTTYPE"));
                sPLTypeNAME = Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx].DataItem, "LOTYNAME"));
            }

            if (_sLotType != sPLType)
            {
                msgId.Add("SFU8399", new object[] { sPLTypeNAME, _sLotTypeName });
            }
            
        }

        private List<int> CheckLaneQty(string selectedVer, int selectedLaneQty)
        {
            List<int> result = new List<int>();
            if (string.IsNullOrEmpty(selectedVer))
            {
                return result;
            }

            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("PROD_VER_CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Indata["PROD_VER_CODE"] = Util.NVC(selectedVer);
                IndataTable.Rows.Add(Indata);

                DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE_VER", "INDATA", "RSLTDT", IndataTable);
                if(dtMain.Rows.Count == 0)
                {
                    return result;
                }

                int verLaneQty = Util.NVC_Int(dtMain.Rows[0]["LANE_QTY"]);
                if(selectedLaneQty != verLaneQty)
                {
                    result.Add(selectedLaneQty);
                    result.Add(verLaneQty);
                }
            }
            catch (Exception ex) {
                result.Clear();
                return result;
            }

            return result;
        }

        private void SaveWIPHistory()
        {

            DataTable inDataTable = new DataTable();
            inDataTable.Columns.Add("LOTID", typeof(string));
            inDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
            inDataTable.Columns.Add("SHIFT", typeof(string));
            inDataTable.Columns.Add("WIPNOTE", typeof(string));
            inDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
            inDataTable.Columns.Add("WRK_USERID", typeof(string));
            inDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
            inDataTable.Columns.Add("LANE_QTY", typeof(decimal));
            inDataTable.Columns.Add("PROD_QTY", typeof(decimal));
            inDataTable.Columns.Add("SRS1QTY", typeof(decimal));
            inDataTable.Columns.Add("SRS2QTY", typeof(decimal));
            inDataTable.Columns.Add("SRS3QTY", typeof(decimal));
            inDataTable.Columns.Add("PROTECT_FILM_TYPE_CODE", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));
            
            for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
            {
                DataRow inLotDetailDataRow = null;
                inLotDetailDataRow = inDataTable.NewRow();
                inLotDetailDataRow["LOTID"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID").ToString();
                inLotDetailDataRow["PROD_VER_CODE"] = txtVersion != null ? Util.NVC(txtVersion.Text) : null;
                inLotDetailDataRow["SHIFT"] = Util.NVC(txtShift.Tag);
                inLotDetailDataRow["WIPNOTE"] = txtWipNote != null ? Util.NVC(txtWipNote.Text) : null;
                inLotDetailDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text);
                inLotDetailDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag);

                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING))
                {
                    inLotDetailDataRow["LANE_PTN_QTY"] = Util.NVC_Decimal(txtLanePatternQty.Value);
                    inLotDetailDataRow["LANE_QTY"] = Util.NVC_Decimal(txtLaneQty.Value);
                }

                if (string.IsNullOrEmpty(Util.NVC(txtInputQty.Tag)))
                    inLotDetailDataRow["PROD_QTY"] = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                else
                    inLotDetailDataRow["PROD_QTY"] = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));

                // SRS코터 요구사항으로 추가 정보 저장 [2017-11-30]
                if( string.Equals(procId, Process.SRS_COATING))
                {
                    inLotDetailDataRow["SRS1QTY"] = Util.NVC_Decimal(txtSrs1Qty.Value);
                    inLotDetailDataRow["SRS2QTY"] = Util.NVC_Decimal(txtSrs2Qty.Value);
                    inLotDetailDataRow["SRS3QTY"] = Util.NVC_Decimal(txtSrs3Qty.Value);
                    inLotDetailDataRow["PROTECT_FILM_TYPE_CODE"] = Util.NVC(cboPet.Text);
                }

                inLotDetailDataRow["USERID"] = LoginInfo.USERID;
                inDataTable.Rows.Add(inLotDetailDataRow);
            }

            new ClientProxy().ExecuteService("BR_ACT_REG_SAVE_LOT", "INDATA", null, inDataTable, (result, Returnex) =>
            {
                try
                {
                    if (Returnex != null)
                    {
                        Util.MessageException(Returnex);
                        return;
                    }

                    // 코터 공정에서 Product Lot 버전 정보 갱신
                    if (string.Equals(procId, Process.COATING) && !string.IsNullOrEmpty(txtVersion.Text))
                    {
                        int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");
                        if (iRow >= 0)
                            DataTableConverter.SetValue(PRODLOT_GRID.Rows[iRow].DataItem, "COATERVER", Util.NVC(txtVersion.Text));
                    }

                    SaveDefect(WIPREASON_GRID);

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                        SaveDefect(WIPREASON2_GRID);

                    isChangeWipReason = false;
                }
                catch (Exception ex) { Util.MessageException(ex); }
            });
        }

        private bool CheckCstID(string sLotID, string sCstID)
        {
            bool bCheck = true;

            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("CSTID", typeof(string));

                DataRow newRow = inTable.NewRow();
                newRow["CSTID"] = sCstID.Trim();
                inTable.Rows.Add(newRow);

                DataTable searchResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_CARRIER", "RQSTDT", "RSLTDT", inTable);

                if (searchResult.Rows.Count == 0)
                {
                    //CSTID[%1]에 해당하는 CST가 없습니다.
                    Util.MessageValidation("SFU7001", sCstID);
                    return false;
                }

                //캐리어 상태 Check
                if (Util.NVC(searchResult.Rows[0]["CSTSTAT"]).Equals("U"))
                {
                    if (Util.NVC(searchResult.Rows[0]["CURR_LOTID"]) == sLotID)
                    {
                        //Carrier[%1]가 이미 할당되어 있습니다[LOT : %2].
                        Util.MessageValidation("SFU5126", sCstID, sLotID);
                        return false;
                    }
                    else
                    {
                        //CSTID[%1] 이 상태가 %2 입니다.
                        Util.MessageValidation("SFU7002", Util.NVC(searchResult.Rows[0]["CSTID"]), Util.NVC(searchResult.Rows[0]["CSTSNAME"]));
                        return false;
                    }
                }

            }
            catch (Exception e)
            {
                bCheck = false;
                Util.MessageException(e);
            }
            return bCheck;

        }

        private bool CheckLotID(string sLotID, string sCstID)
        {
            bool bCheck = true;

            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow newRow = inTable.NewRow();
                newRow["LOTID"] = sLotID.Trim();
                inTable.Rows.Add(newRow);

                DataTable searchResult = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_VW_WIP", "RQSTDT", "RSLTDT", inTable);

                if (searchResult.Rows.Count == 0)
                {
                    //LOTID[%1]에 해당하는 LOT이 없습니다.
                    Util.MessageValidation("SFU7000", sLotID);
                    return false;
                }

                if (!string.IsNullOrEmpty(Util.NVC(searchResult.Rows[0]["CSTID"])))
                {
                    //Carrier[%1]가 이미 할당되어 있습니다[LOT : %2].
                    Util.MessageValidation("SFU5126", Util.NVC(searchResult.Rows[0]["CSTID"]), sLotID);
                    return false;
                }

            }
            catch (Exception e)
            {
                bCheck = false;
                Util.MessageException(e);
            }
            return bCheck;

        }

        private void SaveWRKHistory()
        {
            DataTable inDataTable = new DataTable();
            inDataTable.Columns.Add("WRK_STRT_DTTM", typeof(DateTime));
            inDataTable.Columns.Add("WRK_END_DTTM", typeof(DateTime));
            inDataTable.Columns.Add("WRK_USERID", typeof(string));
            inDataTable.Columns.Add("EQPTID", typeof(string));
            inDataTable.Columns.Add("SHFT_ID", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));

            DataRow inLotDetailDataRow = null;
            inLotDetailDataRow = inDataTable.NewRow();
            inLotDetailDataRow["WRK_STRT_DTTM"] = Convert.ToDateTime(txtShiftStartTime.Text);
            inLotDetailDataRow["WRK_END_DTTM"] = Convert.ToDateTime(txtShiftEndTime.Text);
            inLotDetailDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag);
            inLotDetailDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            inLotDetailDataRow["SHFT_ID"] = Util.NVC(txtShift.Tag);
            inLotDetailDataRow["USERID"] = LoginInfo.USERID;
            inDataTable.Rows.Add(inLotDetailDataRow);

            new ClientProxy().ExecuteService("DA_BAS_REG_TB_SFC_EQPT_WRK_INFO", "INDATA", null, inDataTable, (result, Returnex) =>
            {
                try
                {
                    if (Returnex != null)
                    {
                        Util.MessageException(Returnex);
                        return;
                    }
                }
                catch (Exception ex) { Util.MessageException(ex); }
            });
        }

        private void SaveQuality(C1DataGrid dg)
        {
            if (dg.Rows.Count < 1)
            {
                Util.MessageValidation("SFU2002");  //품질정보가 없습니다.
                return;
            }

            DataTable inEDCLot = dtDataCollectOfChildQuality(dg);

            // TOP/BACK을 동시 적용하기 위하여 해당 방식으로 변경 (SPLUNK문제로 CMI요청사항) [2018-05-24]
            if (QUALITY2_GRID.Visibility == Visibility.Visible)
                inEDCLot.Merge(dtDataCollectOfChildQuality(QUALITY2_GRID));            

            new ClientProxy().ExecuteService("BR_QCA_REG_WIP_DATA_CLCT", "INDATA", null, inEDCLot, (result, ex) =>
            {
                if (ex != null)
                {
                    //Util.AlertByBiz("BR_QCA_REG_WIP_DATA_CLCT", ex.Message, ex.ToString());
                    Util.MessageException(ex);
                    return;
                }

                //if ((dg.Name.Equals("dgQuality") && QUALITY2_GRID.Visibility != Visibility.Visible) || (dg.Name.Equals("dgQuality2") && QUALITY2_GRID.Visibility == Visibility.Visible) || dg.Name.Equals("dgColor") || dg.Name.Equals("dgDefectTag"))
                //{
                    if (!dg.Name.Equals("dgColor") && !dg.Name.Equals("dgDefectTag"))
                        isChangeQuality = false;

                    if (dg.Name.Equals("dgColor"))
                        Util.MessageInfo("SFU3272");    //색지정보가 저장되었습니다.
                    else if (dg.Name.Equals("dgDefectTag"))
                        Util.MessageInfo("SFU3271");    //불량태그정보가 저장되었습니다.
                    else
                        Util.MessageInfo("SFU1998");    //품질 정보가 저장되었습니다.
                //}
            });
        }

        //롤플레스 전체저장 
        private void SavePublicQuality(C1DataGrid dg)
        {
            
            //if (dg.Rows.Count < 1)
            //{
            //    Util.MessageValidation("SFU2002");  //품질정보가 없습니다.
            //    return;
            //}

            DataTable inEDCLot = dtDataCollectOfChildQuality(dg);

            // TOP/BACK을 동시 적용하기 위하여 해당 방식으로 변경 (SPLUNK문제로 CMI요청사항) [2018-05-24]
            if (QUALITY2_GRID.Visibility == Visibility.Visible)
                inEDCLot.Merge(dtDataCollectOfChildQuality(QUALITY2_GRID));

            new ClientProxy().ExecuteService("BR_QCA_REG_WIP_DATA_CLCT", "INDATA", null, inEDCLot, (result, ex) =>
            {
                if (ex != null)
                {
                    Util.MessageException(ex);
                    return;
                }

                //if ((dg.Name.Equals("dgQuality") && QUALITY2_GRID.Visibility != Visibility.Visible) || (dg.Name.Equals("dgQuality2") && QUALITY2_GRID.Visibility == Visibility.Visible) || dg.Name.Equals("dgColor") || dg.Name.Equals("dgDefectTag"))
                //{
                    if (!dg.Name.Equals("dgColor") && !dg.Name.Equals("dgDefectTag"))
                        isChangeQuality = false;

                //}
            });
        }

        private void SaveCutQuality(C1DataGrid dg)
        {
            if (dg.Rows.Count < 1)
            {
                Util.MessageValidation("SFU2002");  //품질정보가 없습니다.
                return;
            }

            DataSet inCollectLot = dtDataCollectOfChildrenQuality(dg);

            new ClientProxy().ExecuteService_Multi("BR_QCA_REG_WIPDATACOLLECT_CUTID", "INDATA,IN_DATA", null, (result, ex) =>
            {
                if (ex != null)
                {
                    //Util.AlertByBiz("BR_QCA_REG_WIPDATACOLLECT_CUTID", ex.Message, ex.ToString());
                    Util.MessageException(ex);
                    return;
                }

                Util.MessageInfo("SFU1998");    //품질 정보가 저장되었습니다.
                isChangeQuality = false;
            }, inCollectLot);
        }

        private void SavePublicCutQuality(C1DataGrid dg)
        {
            if (dg.Rows.Count < 1)
            {
                Util.MessageValidation("SFU2002");  //품질정보가 없습니다.
                return;
            }

            DataSet inCollectLot = dtDataCollectOfChildrenQuality(dg);

            new ClientProxy().ExecuteService_Multi("BR_QCA_REG_WIPDATACOLLECT_CUTID", "INDATA,IN_DATA", null, (result, ex) =>
            {
                if (ex != null)
                {
                    //Util.AlertByBiz("BR_QCA_REG_WIPDATACOLLECT_CUTID", ex.Message, ex.ToString());
                    Util.MessageException(ex);
                    return;
                }

                isChangeQuality = false;
            }, inCollectLot);
        }

        private DataTable dtDataCollectOfChildQuality(C1DataGrid dg)
        {
            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("SRCTYPE", typeof(string));
            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("EQPTID", typeof(string));
            IndataTable.Columns.Add("USERID", typeof(string));
            IndataTable.Columns.Add("CLCTITEM", typeof(string));
            IndataTable.Columns.Add("CLCTVAL01", typeof(string));
            IndataTable.Columns.Add("WIPSEQ", typeof(string));
            IndataTable.Columns.Add("CLCTSEQ", typeof(string));

            DataTable dt = (dg.ItemsSource as DataView).Table;
            DataRow inData = null;

            if (dg.Name.Equals("dgColor"))
            {
                GetWipSeq(_LOTID, string.Empty);

                foreach (DataRow _iRow in dt.Rows)
                {
                    inData = IndataTable.NewRow();

                    inData["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                    inData["LOTID"] = _LOTID;
                    inData["EQPTID"] = _EQPTID;
                    inData["USERID"] = LoginInfo.USERID;
                    inData["CLCTITEM"] = _iRow["CLCTITEM"];
                    inData["CLCTVAL01"] = inData["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]) == Double.NaN.ToString() ? "" : Util.NVC(_iRow["CLCTVAL01"]).Trim();
                    inData["WIPSEQ"] = string.IsNullOrEmpty(_WIPSEQ) ? null : _WIPSEQ;
                    inData["CLCTSEQ"] = 1;
                    IndataTable.Rows.Add(inData);
                }
            }
            else
            {
                int i = 0;
                double p1 = 0F;

                GetWipSeq(_LOTID, string.Empty);

                foreach (DataRow _iRow in dt.Rows)
                {
                    inData = IndataTable.NewRow();

                    inData["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                    inData["LOTID"] = _LOTID;
                    inData["EQPTID"] = _EQPTID;
                    inData["USERID"] = LoginInfo.USERID;
                    inData["CLCTITEM"] = _iRow["CLCTITEM"];
                    //inData["CLCTVAL01"] = _iRow["CLCTVAL01"].ToString().Equals("") ? 0 : _iRow["CLCTVAL01"];
                    inData["WIPSEQ"] = string.IsNullOrEmpty(_WIPSEQ) ? null : _WIPSEQ;
                    //inData["CLCTSEQ"] = string.IsNullOrEmpty(_CLCTSEQ) ? null : _CLCTSEQ;
                    inData["CLCTSEQ"] = 1;
                    //inData["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]) == Double.NaN.ToString() ? "" : Util.NVC(_iRow["CLCTVAL01"]).Trim();
                    if (_iRow["INSP_VALUE_TYPE_CODE"].ToString().Equals("NUM"))
                    {
                        bool canConvert = double.TryParse(_iRow["CLCTVAL01"].ToString(), out p1);
                        if (!canConvert || double.IsNaN(Convert.ToDouble(_iRow["CLCTVAL01"])))
                        {
                            inData["CLCTVAL01"] = "";
                            DataTableConverter.SetValue(dg.Rows[i].DataItem, "CLCTVAL01", "");
                        }
                        else inData["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]).Trim();
                    }
                    else inData["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]) == Double.NaN.ToString() ? "" : Util.NVC(_iRow["CLCTVAL01"]).Trim();
                    IndataTable.Rows.Add(inData);
                    i++;
                }
                dg.UpdateLayout();
            }
            return IndataTable;
        }

        private DataSet dtDataCollectOfChildrenQuality(C1DataGrid dg)
        {
            // 사용안하는 메서드라 SLITTER CUT의 BINDING메서드로 용도 변경 사용 [2017-02-01]
            DataSet inDataSet = new DataSet();

            int i = 0;
            double p1 = 0F;

            DataTable IndataTable = inDataSet.Tables.Add("INDATA");
            IndataTable.Columns.Add("SRCTYPE", typeof(string));
            IndataTable.Columns.Add("PROCID", typeof(string));
            IndataTable.Columns.Add("EQPTID", typeof(string));
            IndataTable.Columns.Add("CUT_ID", typeof(string));
            IndataTable.Columns.Add("USERID", typeof(string));

            DataRow inDataRow = null;
            inDataRow = IndataTable.NewRow();
            inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
            inDataRow["PROCID"] = procId;
            inDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            inDataRow["CUT_ID"] = Util.NVC(_CUTID);
            inDataRow["USERID"] = LoginInfo.USERID;
            IndataTable.Rows.Add(inDataRow);

            DataTable IndataDetailTable = inDataSet.Tables.Add("IN_DATA");
            IndataDetailTable.Columns.Add("CLCTITEM", typeof(string));
            IndataDetailTable.Columns.Add("VERSION", typeof(string));
            IndataDetailTable.Columns.Add("CLCTVAL01", typeof(string));

            DataTable dt = (dg.ItemsSource as DataView).Table;
            foreach (DataRow _iRow in dt.Rows)
            {
                DataRow inDetailDataRow = null;
                inDetailDataRow = IndataDetailTable.NewRow();
                inDetailDataRow["CLCTITEM"] = _iRow["CLCTITEM"];
                inDetailDataRow["VERSION"] = 0;
                //inDetailDataRow["CLCTVAL01"] = _iRow["CLCTVAL01"].ToString().Equals("") ? 0 : _iRow["CLCTVAL01"];
                //inDetailDataRow["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]); 20211223 수정 이전 버전
                if (_iRow["INSP_VALUE_TYPE_CODE"].ToString().Equals("NUM"))
                {
                    bool canConvert = double.TryParse(_iRow["CLCTVAL01"].ToString(), out p1);
                    if (!canConvert || double.IsNaN(Convert.ToDouble(_iRow["CLCTVAL01"])))
                    {
                        inDetailDataRow["CLCTVAL01"] = "";
                        DataTableConverter.SetValue(dg.Rows[i].DataItem, "CLCTVAL01", "");
                    }
                    else inDetailDataRow["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]).Trim();
                }
                else inDetailDataRow["CLCTVAL01"] = Util.NVC(_iRow["CLCTVAL01"]);

                IndataDetailTable.Rows.Add(inDetailDataRow);
                i++;
            }
            dg.UpdateLayout();
            return inDataSet;
        }

        private void GetWipSeq(string sLotID, string sCLCTITEM)
        {
            _WIPSEQ = string.Empty;
            _CLCTSEQ = string.Empty;

            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("PROCID", typeof(string));
            IndataTable.Columns.Add("CLCTITEM", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LOTID"] = sLotID;
            Indata["PROCID"] = procId;
            Indata["CLCTITEM"] = sCLCTITEM;
            IndataTable.Rows.Add(Indata);

            DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_WIPDATACOLLECT_WIPSEQ_SL", "INDATA", "RSLTDT", IndataTable);

            if (dtResult.Rows.Count == 0)
            {
                _WIPSEQ = string.Empty;
                _CLCTSEQ = string.Empty;
            }
            else
            {
                _WIPSEQ = dtResult.Rows[0]["WIPSEQ"].ToString();
                _CLCTSEQ = dtResult.Rows[0]["CLCTSEQ"].ToString();
            }
        }

        protected virtual void OnClickAddMaterial(object sender, RoutedEventArgs e)
        {
            if (INPUTMTRL_GRID.ItemsSource == null || INPUTMTRL_GRID.Rows.Count < 0)
                return;

            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1381");  //Lot을 선택하세요.
                return;
            }

            DataTable dt = ((DataView)INPUTMTRL_GRID.ItemsSource).Table;

            for (int i = 0; i < dt.Rows.Count; i++)
                dt.Rows[i]["CHK"] = true;

            DataRow dr = dt.NewRow();
            dr["CHK"] = true;
            dr["INPUT_DTTM"] = string.Format("{0:yyyy-MM-dd hh:mm}", DateTime.Now);
            dt.Rows.Add(dr);
        }

        protected virtual void OnClickRemoveMaterial(object sender, RoutedEventArgs e)
        {
            if (INPUTMTRL_GRID.ItemsSource == null || INPUTMTRL_GRID.Rows.Count < 0)
                return;

            DataTable dt = (INPUTMTRL_GRID.ItemsSource as DataView).Table;

            dt.Rows[INPUTMTRL_GRID.CurrentRow.Index].Delete();

            Util.GridSetData(INPUTMTRL_GRID, dt, FrameOperation, true);
        }

        protected virtual void OnClickAddMaterialHistory(object sender, RoutedEventArgs e)
        {
            if (INPUTMTRLHIST_GRID.ItemsSource == null || INPUTMTRLHIST_GRID.Rows.Count < 0)
                return;

            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1381");  //Lot을 선택하세요.
                return;
            }

            Util.MessageInfo("작업중 입니다.");

            /*
            DataTable dt = ((DataView)INPUTMTRL_GRID.ItemsSource).Table;

            for (int i = 0; i < dt.Rows.Count; i++)
                dt.Rows[i]["CHK"] = true;

            DataRow dr = dt.NewRow();
            dr["CHK"] = true;
            dr["INPUT_DTTM"] = string.Format("{0:yyyy-MM-dd hh:mm}", DateTime.Now);
            dt.Rows.Add(dr);
            */
        }

        protected virtual void OnClickRemoveMaterialHistory(object sender, RoutedEventArgs e)
        {
            if (INPUTMTRLHIST_GRID.ItemsSource == null || INPUTMTRLHIST_GRID.Rows.Count < 0)
                return;

            DataTable dt = (INPUTMTRLHIST_GRID.ItemsSource as DataView).Table;

            dt.Rows[INPUTMTRLHIST_GRID.CurrentRow.Index].Delete();

            Util.GridSetData(INPUTMTRLHIST_GRID, dt, FrameOperation, true);
        }

        protected virtual void OnClickDeleteMaterial(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = (grdDataCollect.Children[0] as UcDataCollect).dgMaterial;
            DataRow[] drs = Util.gridGetChecked(ref dg, "CHK");

            if (drs != null)
            {
                //입력한 데이터가 삭제됩니다. 계속 하시겠습니까?
                Util.MessageConfirm("SFU1815", (sResult) =>
                {
                    if (sResult == MessageBoxResult.OK)
                        SetMaterial(_LOTID, "D");
                });
            }
        }

        protected virtual void OnClickDeleteMaterialHistory(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = (grdDataCollect.Children[0] as UcDataCollect).dgMaterialHistory;
            DataRow[] drs = Util.gridGetChecked(ref dg, "CHK");

            Util.MessageInfo("작업중 입니다.");
            /*
            if (drs != null)
            {
                //입력한 데이터가 삭제됩니다. 계속 하시겠습니까?
                Util.MessageConfirm("SFU1815", (sResult) =>
                {
                    if (sResult == MessageBoxResult.OK)
                        SetMaterial(_LOTID, "D");
                });
            }
            */
        }

        protected virtual void OnClickSaveMaterial(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = INPUTMTRL_GRID;
            DataRow[] drs = Util.gridGetChecked(ref dg, "CHK");

            if (drs == null)
            {
                Util.MessageValidation("SFU1662");  //선택한 자재가 없습니다.
                return;
            }

            foreach (DataRow dr in drs)
            {
                if (string.IsNullOrEmpty(dr["INPUT_LOTID"].ToString()))
                {
                    Util.MessageValidation("SFU1984");  //투입자재 LOT ID를 입력하세요.
                    return;
                }

                if (!string.Equals(procId, Process.SRS_COATING))
                {
                    if (string.IsNullOrEmpty(dr["INPUT_QTY"].ToString()) || dr["INPUT_QTY"].ToString().Equals("0.00000"))
                    {
                        Util.MessageValidation("SFU1953");  //투입 수량을 입력하세요.
                        return;
                    }
                }
            }
            SetMaterial(_LOTID, "A");
        }

        protected virtual void OnClickSaveMaterialHistory(object sender, RoutedEventArgs e)
        {
            C1DataGrid dg = INPUTMTRLHIST_GRID;
            DataRow[] drs = Util.gridGetChecked(ref dg, "CHK");

            if (drs == null)
            {
                Util.MessageValidation("SFU1662");  //선택한 자재가 없습니다.
                return;
            }

            Util.MessageInfo("작업중 입니다.");

            /*
            foreach (DataRow dr in drs)
            {
                if (string.IsNullOrEmpty(dr["INPUT_LOTID"].ToString()))
                {
                    Util.MessageValidation("SFU1984");  //투입자재 LOT ID를 입력하세요.
                    return;
                }

                if (!string.Equals(procId, Process.SRS_COATING))
                {
                    if (string.IsNullOrEmpty(dr["INPUT_QTY"].ToString()) || dr["INPUT_QTY"].ToString().Equals("0.00000"))
                    {
                        Util.MessageValidation("SFU1953");  //투입 수량을 입력하세요.
                        return;
                    }
                }
            }
            SetMaterial(_LOTID, "A");
            */
        }

        protected virtual void OnClickCottonSave(object sender, RoutedEventArgs e)
        {
            SaveCotton(COTTON_GRID);
        }
        protected virtual void OnClickSolidContRate(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }
            CMM_HOPR_SCLE_SOLD_CONT_RATE _popUpSolid = new CMM_HOPR_SCLE_SOLD_CONT_RATE();
            _popUpSolid.FrameOperation = FrameOperation;

            if (_popUpSolid != null)
            {
                object[] Parameters = new object[2];
                Parameters[0] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[1] = procId;

                C1WindowExtension.SetParameters(_popUpSolid, Parameters);

                _popUpSolid.Closed += new EventHandler(popUpSolid_Closed);
                _popUpSolid.ShowModal();
                _popUpSolid.CenterOnScreen();
            }
        }
        private void popUpSolid_Closed(object sender, EventArgs e)
        {
            CMM_HOPR_SCLE_SOLD_CONT_RATE runStartWindow = sender as CMM_HOPR_SCLE_SOLD_CONT_RATE;
            if (runStartWindow.DialogResult == MessageBoxResult.Cancel)
            {
                OnClickSearch(null, null);
            }
        }

        #region[POSTACTION]
        protected virtual void OnClickPostHoldSave(object sender, RoutedEventArgs e)
        {
            if (!ValidPostAction())
                return;

            DataTable postHold = DataTableConverter.Convert(POSTHOLD_GRID.ItemsSource);
            if (postHold.Select("POST_HOLD = 'True'").Length > 0 && postHold != null)
            {
                Util.MessageConfirm("SFU1345", (result) =>
                {
                    if (result == MessageBoxResult.OK)
                        SavePostHold();
                    else
                        return;
                });
            }
            else
            {
                SavePostHold();
            }
            
        }
        #endregion

        protected virtual void OnClickPublicSave(object sender, RoutedEventArgs e)
        {
            // 진행LOT이 실적 확정 완료이면, 실적확정, 불량/Loss저장, 품질검사 저장 전체 방어 [2018-11-16]
            if (ValidConfirmLotCheck() == false)
                return;

            // 롤프레스 자주검사 저장 시 복사해서 붙여넣다가 실수하는 경우 방어를 위하여 로직 추가 (자동차1,2동 요청사항) [2019-01-07]
            // 인터락이 아니기 때문에 현 시점에서는 알림만 띄어달라는 요청 -> 추후에 변경 될 수 있음 (OnClickSaveQuality에 구현은 해놨음)
            if (ValidInspectionDataCheck(QUALITY_GRID) == false)
                Util.MessageInfo("SFU6005");    // 동일한 데이터가 연속으로 입력 되었습니다.

            try
            {
                SaveDefect(WIPREASON_GRID);

                if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                    SaveDefect(WIPREASON2_GRID);

                // C20220406-000241 - 자동차 1, 2동 전극 슬리터 바코드 불량수, Tag수 표시
                if (isBarCodePrint)
                {
                    SaveDefectCheckUpDate("Y");
                }

                if (isRollMapEquipment)
                {
                    //if (string.Equals(procId, Process.COATING))
                    //{
                    //    SaveDefectForRollMap();
                    //}
                    //else if (string.Equals(procId, Process.ROLL_PRESSING))
                    //{
                    //    SaveAdjustmentDefect();
                    //}
                    SaveDefectForRollMap();
                    GetDefectList();
                }

                isChangeWipReason = false;

                //C20210928-000558 Slitter Process adds NG TAG columns in remark
                if (isRemarkNgTag)
                    GetRemarkNgTagSelect();

               // Util.MessageInfo("SFU1270");    //저장되었습니다.
            }
            catch (Exception ex) { Util.MessageException(ex); }

            // 슬리터 2차 추가 2021-09-15 by 오화백 
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
            {
                SavePublicCutQuality(QUALITY_GRID);
            }
            else if (string.Equals(procId, Process.HEAT_TREATMENT)) { } // 열 처리 공정은 품질정보 저장 안함 [2018-06-05]
            else
            {
                string status = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK")].DataItem, "WIPSTAT"));
                if (string.Equals(procId, Process.ROLL_PRESSING))
                {
                    if (status.Equals(Wip_State.PROC) || status.Equals(Wip_State.EQPT_END))
                    {
                        SavePublicQuality(COLOR_GRID);
                        isChangeColorTag = false;
                    }

                }
                SavePublicQuality(QUALITY_GRID);
                //if (QUALITY2_GRID.Visibility == Visibility.Visible)
                //    SavePublicQuality(QUALITY2_GRID);
            }

            #region [POSTACTION]
            // 슬리터 2차 추가  2021-09-15 by 오화백
            // 2022-12-29 EP 동 추가
            if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) )
            {
                if (!ConfirmdPostAction())
                    return;
                SavePostHold();
            }
            else
            {
                SetWipNote();
            }                
            #endregion

        }


        protected virtual void OnClickSaveRemark(object sender, RoutedEventArgs e)
        {
            SetWipNote();
        }


        private void GetMaterialSummary(string sLotID, string sWOID)
        {
            try
            {
                Util.gridClear(INPUTMTRLSUMMARY_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("WOID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["LOTID"] = sLotID;
                Indata["WOID"] = sWOID;
                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONSUME_MATERIAL_SUMMARY", "INDATA", "RSLTDT", IndataTable);

                Util.GridSetData(INPUTMTRLSUMMARY_GRID, dtResult, FrameOperation, true);

                // 믹서공정은 투입자재 총사용량 = 생산량 [2017-03-02]
                double inputMtrlSumQty = 0;
                foreach (DataRow row in dtResult.Rows)
                {
                    inputMtrlSumQty += string.IsNullOrEmpty(Util.NVC(row["INPUT_QTY"])) ? 0 : (Convert.ToDouble(row["INPUT_QTY"]) * (string.Equals(row["UNIT"], "TO") ? 1000 : 1));
                }

                if (inputMtrlSumQty > 0)
                {
                    txtInputQty.Value = inputMtrlSumQty;
                    SetInputQty();
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private DateTime GetCurrentTime()
        {
            try
            {
                DataTable dt = new ClientProxy().ExecuteServiceSync("BR_CUS_GET_SYSTIME", null, "OUTDATA", null);
                return (DateTime)dt.Rows[0]["SYSTIME"];
            }
            catch (Exception ex) { }

            return DateTime.Now;
        }

        private void GetRemarkHistory(int iRow)
        {
            try
            {
                Util.gridClear(REMARK_HIST_GRID);

                String sLotID = String.Empty;
                if (Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID_PR")).Equals(""))
                    sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
                else
                    sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID_PR"));

                DataTable inDataTable = new DataTable();
                inDataTable.Columns.Add("LANGID", typeof(string));
                inDataTable.Columns.Add("LOTID", typeof(string));

                DataRow inData = inDataTable.NewRow();
                inData["LANGID"] = LoginInfo.LANGID;
                inData["LOTID"] = sLotID;
                inDataTable.Rows.Add(inData);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_LOT_HISTORY_WIPNOTE", "INDATA", "RSLTDT", inDataTable);

                // 필요정보 변환
                System.Text.StringBuilder strBuilder = new System.Text.StringBuilder();
                foreach ( DataRow row in dtResult.Rows)
                {
                    strBuilder.Clear();
                    string[] wipNotes = Util.NVC(row["WIPNOTE"]).Split('|');

                    for (int i = 0; i < wipNotes.Length; i++)
                    {
                        if (!string.IsNullOrEmpty(wipNotes[i]))
                        {
                            if (i == 0)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("특이사항") + " : " + wipNotes[i]);
                            else if (i == 1)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("공통특이사항") + " : " + wipNotes[i]);
                            else if (i == 2)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("조정횟수") + " : " + wipNotes[i]);
                            else if (i == 3)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("압연횟수") + " : " + wipNotes[i]);
                            else if (i == 4)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("색지정보") + " : " + wipNotes[i]);
                            else if (i == 5)
                                strBuilder.Append(ObjectDic.Instance.GetObjectName("합권이력") + " : " + wipNotes[i]);
                            strBuilder.Append("\n");
                        }
                    }
                    row["WIPNOTE"] = strBuilder.ToString();
                }
                Util.GridSetData(REMARK_HIST_GRID, dtResult, FrameOperation, true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        protected virtual void OnClickEqptMaterialList(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            CMM001.Popup.CMM_EQPT_MATERIAL wndPopup = new CMM001.Popup.CMM_EQPT_MATERIAL();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                object[] Parameters = new object[4];
                Parameters[0] = _LOTID;
                Parameters[1] = _WORKORDER;
                Parameters[2] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[3] = Util.NVC(EQUIPMENT_COMBO.Text);
                C1WindowExtension.SetParameters(wndPopup, Parameters);

                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }
        protected virtual void OnClickInputMaterial(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1702");  //실적 Lot을 선택 해 주세요.
                return;
            }

            if (!(string.Equals(procId, Process.SRS_MIXING) || string.Equals(procId, Process.PRE_MIXING)) && string.IsNullOrEmpty(txtVersion.Text))
            {
                Util.MessageValidation("SFU1218");  //Version 정보를 입력 하세요.
                return;
            }

            CMM001.Popup.CMM_INPUT_MATERIAL wndPopup = new CMM001.Popup.CMM_INPUT_MATERIAL();
            wndPopup.FrameOperation = FrameOperation;

            if (wndPopup != null)
            {
                object[] Parameters = new object[8];
                Parameters[0] = _LOTID;
                Parameters[1] = _WORKORDER;
                Parameters[2] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[3] = Util.NVC(EQUIPMENT_COMBO.Text);
                Parameters[4] = procId;
                Parameters[5] = _PRODID;
                Parameters[6] = Util.NVC(txtVersion.Text);
                Parameters[7] = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                C1WindowExtension.SetParameters(wndPopup, Parameters);

                wndPopup.Closed += new EventHandler(Material_Closed);
                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        private void Material_Closed(object sender, EventArgs e)
        {
            CMM001.Popup.CMM_INPUT_MATERIAL window = sender as CMM001.Popup.CMM_INPUT_MATERIAL;
            GetMaterialSummary(_LOTID, _WORKORDER);
        }

        private void SetWipNote()
        {
            try
            {
                if (REMARK_GRID.GetRowCount() < 1)
                    return;

                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIP_NOTE", typeof(string));
                inTable.Columns.Add("USERID", typeof(string));

                DataTable dt = ((DataView)REMARK_GRID.ItemsSource).Table;
                DataRow inData = null;
                for (int i = 1; i < dt.Rows.Count; i++)
                {
                    inData = inTable.NewRow();

                    inData["LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);

                    if (REMARK_GRID.Rows[0].Visibility == Visibility.Visible)
                        inData["WIP_NOTE"] = Util.NVC(dt.Rows[i]["REMARK"]) + "|" + Util.NVC(dt.Rows[0]["REMARK"]);
                    else
                        inData["WIP_NOTE"] = Util.NVC(dt.Rows[i]["REMARK"]);

                    inData["USERID"] = LoginInfo.USERID;
                    inTable.Rows.Add(inData);
                }

                new ClientProxy().ExecuteService("BR_PRD_REG_WIPHISTORY_NOTE", "INDATA", null, inTable, (result, ex) =>
                {
                    if (ex != null)
                    {
                        //Util.AlertByBiz("BR_PRD_REG_WIPHISTORY_NOTE", ex.Message, ex.ToString());
                        Util.MessageException(ex);
                        return;
                    }

                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                    isChangeRemark = false;
                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        protected virtual void OnClickSearchSlurry(object sender, RoutedEventArgs e)
        {
            GetSlurryData();
        }

        protected virtual void OnClickDeleteSlurry(object sender, RoutedEventArgs e)
        {
            SetSlurry(_LOTID, "D");
        }

        protected virtual void OnClickSaveSlurry(object sender, RoutedEventArgs e)
        {
            SetSlurry(_LOTID, "A");
        }

        protected virtual void OnGridMouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            string vLotID = Util.NVC(DataTableConverter.GetValue(SLURRY_GRID.CurrentRow.DataItem, "LOTID"));
            string vPRODID = Util.NVC(DataTableConverter.GetValue(SLURRY_GRID.CurrentRow.DataItem, "PRODID"));

            if (SLURRY_INPUT_GRID.GetRowCount() > 1)
            {
                Util.MessageValidation("SFU1634");  //선택된 Slurry가 있습니다. 취소/삭제 후 작업하십시오
                return;
            }

            DataTable dt = ((DataView)SLURRY_INPUT_GRID.ItemsSource).Table;

            DataRow dr = dt.NewRow();
            dr["CHK"] = true;
            dr["INPUT_LOTID"] = vLotID;
            dr["PRODID"] = vPRODID;
            dr["INPUT_DTTM"] = string.Format("{0:yyyy-MM-dd hh:mm}", DateTime.Now);
            dt.Rows.Add(dr);
        }

        protected virtual void OnClickCellMouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            if (!string.Equals(procId, Process.COATING))
                return;

            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if ( string.Equals( dataGrid.CurrentColumn.Name, "COUNTQTY"))
                    {
                        string sLinKCode = Util.NVC(DataTableConverter.GetValue(dataGrid.CurrentRow.DataItem, "LINK_DETL_RSN_CODE_TYPE"));

                        if(!string.IsNullOrEmpty(sLinKCode))
                        {
                            // POPUP 생성
                            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                            if (iRow < 0)
                            {
                                Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                                return;
                            }

                            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN_COATING wndPopup = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN_COATING();
                            wndPopup.FrameOperation = FrameOperation;

                            if (wndPopup != null)
                            {
                                object[] Parameters = new object[8];
                                Parameters[0] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                                Parameters[1] = procId;
                                Parameters[2] = _LOTID;
                                Parameters[3] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));
                                Parameters[4] = string.Equals(dataGrid.Name, "dgWipReason") ? "DEFECT_TOP" : "DEFECT_BACK";
                                Parameters[5] = Util.NVC(DataTableConverter.GetValue(dataGrid.CurrentRow.DataItem, "LINK_DETL_RSN_CODE_TYPE"));
                                Parameters[6] = Util.NVC(DataTableConverter.GetValue(dataGrid.CurrentRow.DataItem, "RESNCODE"));
                                Parameters[7] = GetUnitFormatted();

                                C1WindowExtension.SetParameters(wndPopup, Parameters);

                                wndPopup.Closed += new EventHandler(OnCloseProcReasonCoating);
                                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
                            }
                        }
                    }
                }));
            }
        }

        private void OnDataCollectGridLoadedCellPresenter(object sender, DataGridCellEventArgs e)
        {
            if (!isRollMapEquipment) return;

            C1DataGrid dataGrid = sender as C1DataGrid;
            if (e == null || e.Cell == null || e.Cell.Presenter == null) return;

            dataGrid?.Dispatcher.BeginInvoke(new Action(() =>
            {
                var convertFromString = System.Windows.Media.ColorConverter.ConvertFromString("#FFE9E9E9");

                if (e.Cell.Row.Type == DataGridRowType.Item)
                {
                    // Refresh시 에러 발생으로 추가 [2022-04-06]
                    if (e.Cell.Presenter == null) return;
                    
                    if (string.Equals(e.Cell.Column.Name, "COUNTQTY") && !string.Equals((string)DataTableConverter.GetValue(dataGrid.Rows[e.Cell.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y"))
                    {
                        if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);
                    }

                    if ((string.Equals(e.Cell.Column.Name, "COUNTQTY") ||
                         string.Equals(e.Cell.Column.Name, "DFCT_TAG_QTY") ||
                         string.Equals(e.Cell.Column.Name, "RESN_TOT_CHK") ||
                         string.Equals(e.Cell.Column.Name, "RESNQTY")) &&
                        (string.Equals((string)DataTableConverter.GetValue(e.Cell.Row.DataItem, "DFCT_QTY_CHG_BLOCK_FLAG"), "Y") || string.Equals((string)DataTableConverter.GetValue(e.Cell.Row.DataItem, "TOP_LOSS_BAS_DFCT_APPLY_FLAG"), "Y")))
                    {
                        if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);
                    }

                    if (string.Equals(e.Cell.Column.Name, "RESN_TOT_CHK") && string.Equals((string)DataTableConverter.GetValue(e.Cell.Row.DataItem, "ACTID"), "CHARGE_PROD_LOT"))
                    {
                        if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);
                    }

                    #region # RollMap ActivityReason
                    // RollMap용 수량 변경 금지 처리 [2021-07-27]
                    if (string.Equals(e.Cell.Column.Name, "RESNQTY") && string.Equals(DataTableConverter.GetValue(e.Cell.Row.DataItem, "DFCT_QTY_UI_CHG_BLOCK_FLAG"), "Y"))
                        if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);

                    /*
                    if (string.Equals(procId, Process.COATING))
                    {
                        // 미확정-미확정-기타 (Top) : 수정불가 배경색 적용
                        if (string.Equals(e.Cell.Column.Name, "RESNQTY") && string.Equals((string)DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNCODE"), "MZZ01Z01E61"))
                        {
                            if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);
                        }
                    }
                    else if (string.Equals(procId, Process.ROLL_PRESSING))
                    {
                        // 미확정-미확정-기타(MZZ01Z01999), Sample-자주검사(PL08L29), Sample-QA검사(PS01S04) 아닌경우 수정불가
                        string[] targetarray = new string[] { "MZZ01Z01999", "PL08L29", "PS01S04" };
                        if (string.Equals(e.Cell.Column.Name, "RESNQTY") && targetarray.Contains(DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNCODE").GetString()))
                        {
                            e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                        }

                        else if (string.Equals(e.Cell.Column.Name, "RESNQTY"))
                        {
                            if (convertFromString != null) e.Cell.Presenter.Background = new SolidColorBrush((Color)convertFromString);
                        }
                    }
                    */
                    #endregion
                }

            }));
        }

        private void OnDataCollectGridUnLoadedCellPresenter(object sender, DataGridCellEventArgs e)
        {
            if (!isRollMapEquipment) return;

            C1DataGrid dataGrid = sender as C1DataGrid;
            dataGrid?.Dispatcher.BeginInvoke(new Action(() =>
            {
                if (e != null && e.Cell != null && e.Cell.Presenter != null)
                {
                    if (e.Cell.Row.Type == DataGridRowType.Item)
                    {
                        e.Cell.Presenter.Background = null;
                    }
                }
            }));
        }

        private void dgWipReason2_BeganEdit(object sender, DataGridBeganEditEventArgs e)
        {
            if (!isRollMapEquipment) return;

            this.Dispatcher.BeginInvoke(new Action(() =>
            {
                if (e.Column is C1.WPF.DataGrid.DataGridCheckBoxColumn)
                {
                    C1DataGrid dataGrid = sender as C1DataGrid;

                    C1.WPF.DataGrid.DataGridCell cell = ((C1DataGrid)sender).GetCell(e.Row.Index, e.Column.Index);
                    CheckBox cb = cell.Presenter.Content as CheckBox;

                    int idx = ((DataGridCellPresenter)cb.Parent).Row.Index;

                    if (dataGrid != null)
                    {
                        if (cb.IsChecked == true)
                        {
                            Util.MessageConfirm("SFU5128", (vResult) =>         // %1에 전체 수량을 등록 하시겠습니까?
                            {
                                if (vResult == MessageBoxResult.OK)
                                {
                                    for (int i = 0; i < dataGrid.Rows.Count; i++)
                                    {
                                        if (i != idx)
                                        {
                                            DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESN_TOT_CHK", false);
                                            DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESNQTY", 0);
                                        }
                                    }
                                }
                                else
                                {
                                    cb.IsChecked = false;
                                    DataTableConverter.SetValue(dataGrid.Rows[e.Row.Index].DataItem, "RESN_TOT_CHK", false);
                                }

                            }, new object[] { DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "RESNNAME") });
                        }
                        else
                        {
                            DataTableConverter.SetValue(dataGrid.Rows[idx].DataItem, "RESNQTY", 0);
                        }
                    }
                }
            }));
        }

        private void OnCloseProcReasonCoating(object sender, EventArgs e)
        {
            LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN_COATING window = sender as LGC.GMES.MES.CMM001.Popup.CMM_ELEC_PROC_RESN_COATING;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                if (!string.IsNullOrEmpty(window._ReturnResnCode) && !string.IsNullOrEmpty(window._ReturnPosition))
                {
                    C1DataGrid dataGrid = null; 
                    if (string.Equals(window._ReturnPosition, "DEFECT_TOP"))
                        dataGrid = WIPREASON_GRID;
                    else if (string.Equals(window._ReturnPosition, "DEFECT_BACK"))
                        dataGrid = WIPREASON2_GRID;

                    if ( dataGrid != null)
                    {
                        for ( int i = 0; i < dataGrid.GetRowCount(); i++)
                        {
                            if (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[i].DataItem, "RESNCODE"), window._ReturnResnCode))
                            {
                                DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "COUNTQTY", window._ReturnDefectCount);
                                DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESNQTY", window._ReturnSumQty);
                                break;
                            }
                        }
                        GetSumDefectQty();
                        dataGrid.Refresh(false);
                        LOTINFO_GRID.Refresh(false);
                    }
                }
            }
        }

        protected virtual void OnClickbtnExpandFrame(object sender, RoutedEventArgs e)
        {
            if(grdWorkOrder.ActualHeight != 0)
                ExpandFrame = Content.RowDefinitions[1].Height;
            if ((grdDataCollect.Children[0] as UcDataCollect).btnExpandFrame.IsChecked == true)
            {
                Content.RowDefinitions[1].Height = new GridLength(0);
            }
            else
            {
                Content.RowDefinitions[1].Height = ExpandFrame;
            }
        }

        protected virtual void OnClickbtnLeftExpandFrame(object sender, RoutedEventArgs e)
        {
            if (grdWorkOrder.ActualWidth != 0)
                ExpandFrame = Content.ColumnDefinitions[0].Width;
            if ((grdDataCollect.Children[0] as UcDataCollect).btnLeftExpandFrame.IsChecked == true)
            {
                Content.ColumnDefinitions[0].Width = new GridLength(0);
            }
            else
            {
                Content.ColumnDefinitions[0].Width = ExpandFrame;
            }
        }

        protected virtual void OnClickSearchMergeData(object sender, RoutedEventArgs e)
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1381");    //Lot을 선택 하세요
                return;
            }

            GetMergeList();
            GetMergeEndList();
        }

        protected virtual void OnClickSaveMergeData(object sender, RoutedEventArgs e)
        {

            string sLotid = "F";                        // [E20230807-000061] speical work-LOT MERGE improvement
            string sProceChkMsg = string.Empty;         // [E20230807-000061] speical work-LOT MERGE improvement 
            sLotid = Util.NVC(txtMergeInputLot.Text);   // [E20230807-000061] speical work-LOT MERGE improvement 

            if (MERGE_GRID.Rows.Count == 0)
            {
                Util.MessageValidation("SFU3628");   //합권취 진행할 대상 Lot들이 선택되지 않았습니다.
                return;
            }

            DataTable dt2 = new DataTable();
            dt2.Columns.Add("LOTID", typeof(string));
            dt2.Columns.Add("PR_LOTID", typeof(string));

            DataRow dataRow2 = dt2.NewRow();
            dataRow2["LOTID"] = Util.NVC(txtMergeInputLot.Text);

            dt2.Rows.Add(dataRow2);

            DataTable prodLotresult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR", "RQSTDT", "RSLTDT", dt2);
            
            DataTable dt = ((DataView)MERGE_GRID.ItemsSource).Table;

            for (int i = 0; i < dt.Rows.Count; i++)
            {
                if (dt.Rows[i]["CHK"].ToString().Equals("1"))
                {
                    if (prodLotresult.Rows[0]["LANE_QTY"].ToString() != dt.Rows[i]["LANE_QTY"].ToString())
                    {
                        Util.MessageInfo("SFU5081");
                        return;
                    }
                    if (prodLotresult.Rows[0]["MKT_TYPE_CODE"].ToString() != dt.Rows[i]["MKT_TYPE_CODE"].ToString())
                    {
                        Util.MessageInfo("SFU4271");
                        return;
                    }
                    if (!string.IsNullOrEmpty(dt.Rows[i]["WH_ID"].ToString()))
                    {
                        Util.MessageInfo("SFU2963");


                        return;
                    }

                    // [E20230807-000061] speical work-LOT MERGE improvement
                    if (Util.NVC(sLotid).Equals("F"))
                    {
                        sLotid = Util.NVC(dt.Rows[i]["LOTID"].ToString());
                    }
                    else
                    {
                        sLotid = sLotid + "," + Util.NVC(dt.Rows[i]["LOTID"].ToString());
                    }

                }
 
            }

            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1381");   //Lot을 선택 하세요
                return;
            }

            if (!string.Equals(_WIPSTAT, "PROC"))
            {
                Util.MessageValidation("SFU3627");  //합권취는 진행 상태에서만 가능합니다.
                return;
            }

            if ( string.IsNullOrEmpty(txtMergeInputLot.Text))
            {
                Util.MessageValidation("SFU1945");  //투입 LOT이 없습니다.
                return;
            }

                        
            
            C1DataGrid dg = MERGE_GRID;
            if ( Util.gridGetChecked(ref dg, "CHK").Length <= 0 )
            {
                Util.MessageValidation("SFU3628");  //합권취 진행할 대상 Lot들이 선택되지 않았습니다.
                return;
            }

            // [E20230807-000061] speical work-LOT MERGE improvement
            sProceChkMsg = GetMergeLotProcIDChk(procId, sLotid);
            if (!Util.NVC(sProceChkMsg).Equals("Y"))
            {
                if (!Util.NVC(sProceChkMsg).Equals("E"))
                {
                    Util.MessageValidation("SFU9205", _ProNameMerge, sProceChkMsg); //  동일공정의 LOT이 아닙니다.
                    GetMergeList();
                }
                return ;
            }

            SaveMergeData();

        }

        protected virtual void OnTabSelectionChange(object sender, SelectionChangedEventArgs e)
        {
            if (e != null)
            {
                C1TabItem olditem = e.RemovedItems[0] as C1TabItem;
                if ( olditem != null)
                {
                    if ( string.Equals(olditem.Name, "tiWipReason"))
                    {
                        WIPREASON_GRID.EndEdit(true);
                        if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            WIPREASON2_GRID.EndEdit(true);
                    }
                }
                #region [POSTACTION]
                // 슬리터 2차 추가  2021-09-15  by 오화백 
                // 2022-12-29 EP동 추가 
                //if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) && (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP") || string.Equals(LoginInfo.CFG_AREA_ID, "EA")))
                // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
                if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) && (string.Equals(_RemarkHoldUseFlag, "Y")))
                {
                    if (!isChagneDefectTag || !isChangeWipReason || !isChangeQuality)
                    {
                        C1TabItem selitem = e.AddedItems[0] as C1TabItem;
                        if (string.Equals(selitem.Name, "tiPostHold"))
                        {
                            if (PRODLOT_GRID.ItemsSource != null && PRODLOT_GRID.Rows.Count > 0)
                            {
                                int idx = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                                if (idx >= 0)                                   
                                     BindPostHold(Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[idx].DataItem, "LOTID")), Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[idx].DataItem, "CUT_ID")));
                            }
                        }
                    }
                }
                #endregion
            }
        }

        private void GetMergeList()
        {
            try
            {

                DataTable dt = new DataTable();
                dt.Columns.Add("LANGID", typeof(string));
                dt.Columns.Add("EQSGID", typeof(string));
                dt.Columns.Add("PROCID", typeof(string));
                dt.Columns.Add("PRODID", typeof(string));

                DataRow dataRow = dt.NewRow();
                dataRow["LANGID"] = LoginInfo.LANGID;
                dataRow["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                dataRow["PROCID"] = procId;
                dataRow["PRODID"] = _PRODID;
                dt.Rows.Add(dataRow);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_MERGE_LOT_LIST_V01", "INDATA", "RSLTDT", dt);

                Util.GridSetData(MERGE_GRID, result, FrameOperation, true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetMergeEndList()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LANGID", typeof(string));
                dt.Columns.Add("EQSGID", typeof(string));
                dt.Columns.Add("PROCID", typeof(string));
                dt.Columns.Add("LOTID", typeof(string));

                DataRow dataRow = dt.NewRow();
                dataRow["LANGID"] = LoginInfo.LANGID;
                dataRow["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                dataRow["PROCID"] = procId;
                //dataRow["LOTID"] = txtMergeInputLot;
                dataRow["LOTID"] = Util.NVC(txtMergeInputLot.Text); //[E20230306-000137] 전극 합권취 유효기간 로직 수정
                dt.Rows.Add(dataRow);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_MERGE_LOT_END_LIST", "INDATA", "RSLTDT", dt);

                Util.GridSetData(MERGE2_GRID, result, FrameOperation, true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        // [E20230807-000061] speical work-LOT MERGE improvement
        private string GetMergeLotProcIDChk(string sProcid, string sLotid)
        {
            string sChkResult = "Y";

            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("PROCID_MERGE", typeof(string));
                RQSTDT.Columns.Add("LOTID", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["PROCID_MERGE"] = sProcid;
                dr["LOTID"] = sLotid;

                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PROD_SEL_MERGE_LOT_PROCID_CHK", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    _ProNameMerge = Util.NVC(dtResult.Rows[0]["PROCNAME_MERGE"].ToString());

                    for (int i = 0; i < dtResult.Rows.Count; i++)
                    {
                        if (Util.NVC(sChkResult).Equals("Y"))
                        {
                            sChkResult = Util.NVC(dtResult.Rows[i]["CHK_MSG"].ToString());
                        }
                        else
                        {
                            sChkResult = sChkResult + "\r\n" + Util.NVC(dtResult.Rows[i]["CHK_MSG"].ToString());
                        }
                    }
                }
                else
                {
                    sChkResult = "Y";
                }

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                sChkResult = "E";
            }

            return sChkResult;
        }

        private void SaveMergeData()
        {
            Util.MessageConfirm("SFU1241", (result) =>
            {
                if (result == MessageBoxResult.OK)
                {
                    try
                    {
                        DataSet indataSet = new DataSet();
                        DataTable inData = indataSet.Tables.Add("INDATA");
                        inData.Columns.Add("SRCTYPE", typeof(string));
                        inData.Columns.Add("LOTID", typeof(string));
                        inData.Columns.Add("NOTE", typeof(string));
                        inData.Columns.Add("USERID", typeof(string));

                        DataRow row = inData.NewRow();
                        row["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        row["LOTID"] = Util.NVC(txtMergeInputLot.Text);
                        row["NOTE"] = string.Empty;
                        row["USERID"] = LoginInfo.USERID;
                        indataSet.Tables["INDATA"].Rows.Add(row);

                        DataTable formLotID = indataSet.Tables.Add("IN_FROMLOT");
                        formLotID.Columns.Add("FROM_LOTID", typeof(string));

                        DataTable dt = ((DataView)MERGE_GRID.ItemsSource).Table;
                        decimal iAddSumQty = 0;

                        foreach (DataRow inRow in dt.Rows)
                        {
                            if (Convert.ToBoolean(inRow["CHK"]))
                            {
                                row = formLotID.NewRow();

                                iAddSumQty += Util.NVC_Decimal(inRow["WIPQTY"]);
                                row["FROM_LOTID"] = Util.NVC(inRow["LOTID"]);
                                indataSet.Tables["IN_FROMLOT"].Rows.Add(row);
                            }
                        }

                        new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_MERGE_LOT", "INDATA,IN_FROMLOT", null, indataSet);

                        //Util.AlertInfo("SFU2009");  //합권되었습니다.
                        Util.MessageInfo("SFU2009");    //합권되었습니다.
                        REFRESH = true;
                    }
                    catch (Exception ex)
                    {
                        Util.MessageException(ex);
                    }
                }
            });
        }

        private void GetSlurryData()
        {
            try
            {
                DataTable _SlurryDT = new DataTable();
                Util.gridClear(SLURRY_GRID);

                DataTable topTable = new DataTable();
                topTable.Columns.Add("LANGID", typeof(string));
                topTable.Columns.Add("PROCID", typeof(string));
                topTable.Columns.Add("EQSGID", typeof(string));
                topTable.Columns.Add("WO_DETL_ID", typeof(string));
                topTable.Columns.Add("STDT", typeof(string));
                topTable.Columns.Add("EDDT", typeof(string));

                DataRow topdata = topTable.NewRow();
                topdata["LANGID"] = LoginInfo.LANGID;
                topdata["PROCID"] = Process.COATING;
                topdata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                topdata["WO_DETL_ID"] = WO_DETL_ID;
                topdata["STDT"] = DTPFROM.SelectedDateTime.ToString("yyyyMMdd");
                topdata["EDDT"] = DTPTO.SelectedDateTime.ToString("yyyyMMdd");
                topTable.Rows.Add(topdata);

                _SlurryDT = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_SLURRY_WIP", "INDATA", "RSLTDT", topTable);

                Util.GridSetData(SLURRY_GRID, _SlurryDT, FrameOperation, true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetInputSlurry(string LotID)
        {
            try
            {
                DataTable _SlurryDT = new DataTable();
                Util.gridClear(SLURRY_INPUT_GRID);

                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow indata = inTable.NewRow();
                indata["LOTID"] = LotID;
                inTable.Rows.Add(indata);

                _SlurryDT = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_WIPMTRL_CT", "INDATA", "RSLTDT", inTable);

                Util.GridSetData(SLURRY_INPUT_GRID, _SlurryDT, FrameOperation, true);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
        private string GetProcRemarkHoldUseFlag()
        {
            string sRemarkHoldUseFlag = "N";
            string sCodeType;
            string sCmCode;
            string[] sAttribute = null;

            sCodeType = "COM_TYPE_CODE";
            sCmCode = "REMARK_HOLD_USE_FLAG"; // 비고 HOLD 사용여부 

            try
            {
                string[] sColumnArr = { "ATTR1", "ATTR2", "ATTR3", "ATTR4", "ATTR5" };

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("AREAID", typeof(string));
                RQSTDT.Columns.Add("COM_TYPE_CODE", typeof(string));
                RQSTDT.Columns.Add("COM_CODE", typeof(string));
                RQSTDT.Columns.Add("USE_FLAG", typeof(string));

                for (int i = 0; i < sColumnArr.Length; i++)
                    RQSTDT.Columns.Add(sColumnArr[i], typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["AREAID"] = LoginInfo.CFG_AREA_ID;
                dr["COM_TYPE_CODE"] = sCodeType;
                dr["COM_CODE"] = (sCmCode == string.Empty ? null : sCmCode);
                dr["USE_FLAG"] = "Y";

                if (sAttribute != null)
                {
                    for (int i = 0; i < sAttribute.Length; i++)
                        dr[sColumnArr[i]] = string.IsNullOrEmpty(sAttribute[i]) ? (object)DBNull.Value : sAttribute[i];
                }
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_ATTR", "RQSTDT", "RSLTDT", RQSTDT);


                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    sRemarkHoldUseFlag = "Y";

                }
                else
                {
                    sRemarkHoldUseFlag = "N";
                } 
            }
            catch (Exception ex)
            {
                // Util.MessageException(ex); 
                sRemarkHoldUseFlag = "N";
            }

            return sRemarkHoldUseFlag;
 
        }

        private void SetSlurry(string LotID, string PROC_TYPE)
        {
            if (SLURRY_GRID.Rows.Count < 1)
                return;

            try
            {
                DataTable inDataTable = new DataTable();
                inDataTable.Columns.Add("SRCTYPE", typeof(string));
                inDataTable.Columns.Add("EQPTID", typeof(string));
                inDataTable.Columns.Add("LOTID", typeof(string));
                inDataTable.Columns.Add("INPUT_LOTID", typeof(string));
                inDataTable.Columns.Add("MTRLID", typeof(string));
                inDataTable.Columns.Add("PROD_LOTID", typeof(string));
                inDataTable.Columns.Add("INPUT_QTY", typeof(decimal));
                inDataTable.Columns.Add("USERID", typeof(string));
                inDataTable.Columns.Add("PROC_TYPE", typeof(string));
                inDataTable.Columns.Add("INPUT_SEQNO", typeof(Int64));

                DataRow inData = null;

                DataTable dt = ((DataView)SLURRY_INPUT_GRID.ItemsSource).Table;

                foreach (DataRow row in dt.Rows)
                {
                    if (Convert.ToBoolean(row["CHK"]))
                    {
                        inData = inDataTable.NewRow();
                        inData["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inData["EQPTID"] = _EQPTID;
                        inData["LOTID"] = LotID;
                        inData["INPUT_LOTID"] = Util.NVC(row["INPUT_LOTID"]);
                        inData["MTRLID"] = Util.NVC(row["PRODID"]);
                        inData["PROD_LOTID"] = LotID;
                        inData["INPUT_QTY"] = 0;
                        inData["USERID"] = LoginInfo.USERID;
                        inData["PROC_TYPE"] = PROC_TYPE;
                        inData["INPUT_SEQNO"] = Util.NVC_Int(row["INPUT_SEQNO"]);
                        inDataTable.Rows.Add(inData);
                    }
                }

                new ClientProxy().ExecuteService("BR_PRD_REG_MODIFY_IN_LOT", "INDATA", null, inDataTable, (result, ex) =>
                {
                    if (ex != null)
                    {
                        //Util.AlertByBiz("BR_PRD_REG_MODIFY_IN_LOT", ex.Message, ex.ToString());
                        Util.MessageException(ex);
                        return;
                    }

                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                    GetInputSlurry(LotID);
                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        protected virtual void OnSelectedItemChangedEquipmentCombo(object sender, PropertyChangedEventArgs<object> e)
        {
            DataRowView drv = e.NewValue as DataRowView;

            if (drv != null)
            {
                if (Util.NVC(DataTableConverter.GetValue(drv, "PROCID")).Equals(Process.INS_COATING))
                {
                    procId = Process.INS_COATING;
                    txtInputQty.IsReadOnly = false;
                }
                else if (Util.NVC(DataTableConverter.GetValue(drv, "PROCID")).Equals(Process.INS_SLIT_COATING))
                {
                    procId = Process.INS_SLIT_COATING;
                    txtInputQty.IsReadOnly = true;
                }

                if (procId.Equals(Process.COATING))
                {
                    isEQPTDoubleLayer = GetisEQPTDoubleLayer();
                }

                // 코터 설비 선택 시 대lot Clear  [2016.12.06]
                if (procId.Equals(Process.SRS_COATING) || procId.Equals(Process.COATING))
                    LARGELOTID = string.Empty;

                // 요청으로 설비 선택 시 초기화 추가 [2017-03-17]
                ClearControls();
                InitWorkOrderCheck();

                if (grdWorkOrder.Children[0] is UC_WORKORDER)
                    Util.gridClear(((UC_WORKORDER)grdWorkOrder.Children[0]).dgWorkOrder);
                else
                    Util.gridClear(((UC_WORKORDER_MX)grdWorkOrder.Children[0]).dgWorkOrder);

                Util.gridClear(LARGELOT_GRID);
                Util.gridClear(PRODLOT_GRID);

                // ON SEARCH
                GetWorkOrder();

                if (LARGELOT_GRID.Visibility == Visibility.Visible)
                    GetLargeLot();
                else
                    GetProductLot();

                // SHIFT_CODE, SHIFT_USER 자동 SET
                GetWrkShftUser();

                // COATER공정에서 CORE, SLURRY 조회, SRS코터에서 BATCH ID 자동 조회 및 SETUP
                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                {
                    if (isSingleCoater)
                        GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));
                    else
                        GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), "");
                }
                else if (string.Equals(procId, Process.SRS_COATING))
                {
                    GetSlurry();
                }

                SetIdentInfo();
                // --- Add : 2019-06-26 PR_LOTID R/Press, Slitter 공정에서만 보이도록 수정
                (grdResult.Children[0] as UcResult).dgLotInfo.Columns["PR_LOTID"].Visibility = Visibility.Collapsed;

                // 슬리터 2차 추가  2021-09-15 by 오화백
                if (string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                {
                    (grdResult.Children[0] as UcResult).dgLotInfo.Columns["PR_LOTID"].Visibility = Visibility.Visible;
                }

                if (isManageSlittingSide)
                {
                    (grdSearch.Children[0] as UcSearch).txtWorkHalfSlittingSide.Text = string.Empty;
                    (grdSearch.Children[0] as UcSearch).txtWorkHalfSlittingSide.Tag = string.Empty;

                    if ((EQUIPMENT_COMBO.SelectedValue != null && EQUIPMENT_COMBO.SelectedValue.GetString() != "SELECT"))
                    {
                        GetWorkHalfSlittingSide();
                    }
                }

                // 자동선택 추가
                SetLotAutoSelected();

                // Roll Map 대상 설비에 버튼 컨트롤 속성 설정
                SetRollMapEquipment();

                //Pilot Mode
                GetPilotProdMode();

                if (isRollDirCtn)
                    GetRollDir();

                //C20210928-000558 Slitter Process adds NG TAG columns in remark
                GetRemarkNgTagSelect();
            }
        }

        private bool GetisEQPTDoubleLayer()
        {
            bool rtnFlag = false;

            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.Columns.Add("EQPTID", typeof(string));
                RQSTDT.Columns.Add("PRDT_CLSS_CODE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                dr["PRDT_CLSS_CODE"] = "ASL";
                RQSTDT.Rows.Add(dr);

                DataTable dt = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_SFC_EQPT_CURR_MOUNT_MTRL", "RQSTDT", "RSLTDT", RQSTDT);
                
                if (dt.Rows.Count > 3)
                {
                    rtnFlag = true;
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }

            return rtnFlag;
        }

        private void GetSlurry()
        {
            try
            {
                txtTank.Text = string.Empty;
                txtTank.Tag = string.Empty;
                txtBatchId.Text = string.Empty;
                txtBatchId.Tag = string.Empty;

                DataTable SlurryTable = new DataTable();
                SlurryTable.Columns.Add("EQPTID", typeof(string));

                DataRow Slurrydata = SlurryTable.NewRow();
                Slurrydata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                SlurryTable.Rows.Add(Slurrydata);

                DataTable _dt = new ClientProxy().ExecuteServiceSync("DA_PRD_GET_SRSTANK_CURR_MOUNT", "INDATA", "RSLTDT", SlurryTable);

                if (_dt.Rows.Count > 0)
                {
                    txtTank.Text = _dt.Rows[0]["EQPTNAME"].ToString();
                    txtTank.Tag = _dt.Rows[0]["EQPTID"].ToString();
                    txtBatchId.Text = _dt.Rows[0]["INPUT_LOTID"].ToString();
                }
                else
                {
                    txtTank.Text = string.Empty;
                    txtTank.Tag = string.Empty;
                    txtBatchId.Text = string.Empty;
                    txtBatchId.Tag = string.Empty;
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }
        void SetSingleCoaterControl()
        {
            if (isSingleCoater)
            {
                if (COATTYPE_COMBO.SelectedValue.Equals("B"))
                {
                    //isCoaterAfterProcess = true;
                    //(grdResult.Children[0] as UcResult).lblInputQty.Text = ObjectDic.Instance.GetObjectName("생산량");
                    //txtInputQty.Tag = "";

                    txtInputQty = (grdResult.Children[0] as UcResult).txtInputQty;

                    for (int i = 0; i < (grdResult.Children[0] as UcResult).ResultDetail2.Children.Count; i++)
                    {
                        Panel p = (grdResult.Children[0] as UcResult).ResultDetail2.Children[i] as Panel;

                        if (p == null)  // Border추가
                            continue;

                        if (p.Children[1] is C1NumericBox)
                        {
                            C1NumericBox t = p.Children[1] as C1NumericBox;

                            if (t.Name.Equals("txtInputQty"))   // 추가
                                txtInputQty = t;
                            else if (t.Name.Equals("txtGoodQty"))   // 추가
                                txtGoodQty = t;
                            else if (t.Name.Equals("txtLossQty"))   // 추가
                                txtLossQty = t;

                            else if (t.Name.Equals("txtLaneQty"))
                                txtLaneQty = t;
                            else if (t.Name.Equals("txtWorkTime"))
                                txtWorkTime = t;
                        }
                        else if (p.Children[1] is TextBox)
                        {
                            TextBox t = p.Children[1] as TextBox;
                            if (t.Name.Equals("txtVersion"))
                                txtVersion = t;
                            else if (t.Name.Equals("txtWorkDate"))
                                txtWorkDate = t;
                            else if (t.Name.Equals("txtStartDateTime"))
                                txtStartDateTime = t;
                            else if (t.Name.Equals("txtEndDateTime"))
                                txtEndDateTime = t;
                        }
                        else if (p.Children[1] is CheckBox)
                        {
                            CheckBox t = p.Children[1] as CheckBox;
                            if (t.Name.Equals("chkFinalCut"))
                                chkFinalCut = t;
                        }
                        /*
                        else if (p.Children[1] is C1DateTimePicker)
                        {
                            C1DateTimePicker t = p.Children[1] as C1DateTimePicker;
                            if (t.Name.Equals("dtpWorkDate"))
                                dtpWorkDate = t;
                        }
                        */
                    }

                    // 하단으로 추가로 인하여 위치 변경 [2017-01-19]
                    for (int i = 0; i < (grdResult.Children[0] as UcResult).CoaterSlurry2.Children.Count; i++)
                    {
                        Panel p = (grdResult.Children[0] as UcResult).CoaterSlurry2.Children[i] as Panel;

                        if (p == null)  // Border추가
                            continue;

                        if (p.Children[1] is TextBox)
                        {
                            TextBox t = p.Children[1] as TextBox;

                            if (t.Name.Equals("txtCore1")) // Core, Slurry 추가 [2017-01-12]
                                txtCore1 = t;
                            else if (t.Name.Equals("txtCore2"))
                                txtCore2 = t;
                            else if (t.Name.Equals("txtSlurry1"))
                            {
                                txtSlurry1 = t;

                                ((TextBlock)p.Children[0]).Text = "Slurry";
                            }
                            else if (t.Name.Equals("txtSlurry2"))
                            {
                                txtSlurry2 = t;
                                txtSlurry2.Visibility = Visibility.Collapsed;

                                ((TextBlock)p.Children[0]).Visibility = Visibility.Collapsed;
                                ((Button)p.Children[2]).Visibility = Visibility.Collapsed;
                            }
                        }
                    }
                }
                else
                {
                    //isCoaterAfterProcess = false;
                    //(grdResult.Children[0] as UcResult).lblInputQty.Text = ObjectDic.Instance.GetObjectName("양품량");
                    //txtInputQty.Tag = "C";

                    for (int i = 0; i < (grdResult.Children[0] as UcResult).ResultDetail.Children.Count; i++)
                    {
                        Panel p = (grdResult.Children[0] as UcResult).ResultDetail.Children[i] as Panel;

                        if (p == null)  // Border추가
                            continue;

                        if (p.Children[1] is C1NumericBox)
                        {
                            C1NumericBox t = p.Children[1] as C1NumericBox;

                            if (t.Name.Equals("txtInputQty"))
                                txtInputQty = t;
                            else if (t.Name.Equals("txtGoodQty"))   // 추가
                                txtGoodQty = t;
                            else if (t.Name.Equals("txtLossQty"))   // 추가
                                txtLossQty = t;
                            else if (t.Name.Equals("txtLaneQty"))
                                txtLaneQty = t;
                            else if (t.Name.Equals("txtWorkTime"))
                                txtWorkTime = t;
                        }
                        else if (p.Children[1] is TextBox)
                        {
                            TextBox t = p.Children[1] as TextBox;
                            if (t.Name.Equals("txtVersion"))
                                txtVersion = t;
                            else if (t.Name.Equals("txtWorkDate"))
                                txtWorkDate = t;
                            else if (t.Name.Equals("txtStartDateTime"))
                                txtStartDateTime = t;
                            else if (t.Name.Equals("txtEndDateTime"))
                                txtEndDateTime = t;
                        }
                        else if (p.Children[1] is CheckBox)
                        {
                            CheckBox t = p.Children[1] as CheckBox;
                            if (t.Name.Equals("chkFinalCut"))
                                chkFinalCut = t;
                        }
                        /*
                        else if (p.Children[1] is C1DateTimePicker)
                        {
                            C1DateTimePicker t = p.Children[1] as C1DateTimePicker;
                            if (t.Name.Equals("dtpWorkDate"))
                                dtpWorkDate = t;
                        }
                        */
                    }

                    // 하단으로 추가로 인하여 위치 변경 [2017-01-19]
                    for (int i = 0; i < (grdResult.Children[0] as UcResult).CoaterSlurry.Children.Count; i++)
                    {
                        Panel p = (grdResult.Children[0] as UcResult).CoaterSlurry.Children[i] as Panel;

                        if (p == null)  // Border추가
                            continue;

                        if (p.Children[1] is TextBox)
                        {
                            TextBox t = p.Children[1] as TextBox;

                            if (t.Name.Equals("txtCore1")) // Core, Slurry 추가 [2017-01-12]
                                txtCore1 = t;
                            else if (t.Name.Equals("txtCore2"))
                                txtCore2 = t;
                            else if (t.Name.Equals("txtSlurry1"))
                            {
                                txtSlurry1 = t;

                                ((TextBlock)p.Children[0]).Text = "Slurry";
                            }
                            else if (t.Name.Equals("txtSlurry2"))
                            {
                                txtSlurry2 = t;
                                txtSlurry2.Visibility = Visibility.Collapsed;

                                ((TextBlock)p.Children[0]).Visibility = Visibility.Collapsed;
                                ((Button)p.Children[2]).Visibility = Visibility.Collapsed;
                            }
                        }
                    }
                }
            }
        }

        protected virtual void OnSelectedItemChangedCoatSideTypeCombo(object sender, PropertyChangedEventArgs<object> e)
        {
            if (isSingleCoater)
            {
                // 단면코터 조회 시 COAT SIDE 선택으로 나누어짐
                GetWorkOrder();

                DataRowView drv = e.NewValue as DataRowView;
                Grid grdWipReason = (grdDataCollect.Children[0] as UcDataCollect).grdWipReason as Grid;
                TextBlock tbWipReasonBack = (grdDataCollect.Children[0] as UcDataCollect).lblBack;
                grdWipReason.ColumnDefinitions.Clear();
                LARGELOTID = string.Empty;

                if (Util.NVC(DataTableConverter.GetValue(drv, "CBO_CODE")).Equals("B"))
                {
                    //LARGELOT_GRID.Visibility = Visibility.Collapsed;
                    //CHECK_WAIT.Visibility = Visibility.Visible;
                    (grdResult.Children[0] as UcResult).ResultDetail.Visibility = Visibility.Collapsed;
                    (grdResult.Children[0] as UcResult).ResultDetail2.Visibility = Visibility.Visible;
                    //(grdResult.Children[0] as UcResult).grdSummary.Visibility = Visibility.Visible;

                    // 단면코터 TOP이 아닐시 2개로 구분 (2017-01-09)
                    WIPREASON2_GRID.Visibility = Visibility.Visible;
                    tbWipReasonBack.Visibility = Visibility.Visible;

                    ColumnDefinition cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);

                    // 하단부로 변경되면서 Visible 처리 [2017-01-19]
                    (grdResult.Children[0] as UcResult).CoaterSlurry.Visibility = Visibility.Collapsed;
                    (grdResult.Children[0] as UcResult).CoaterSlurry2.Visibility = Visibility.Visible;
                    //(grdDataCollect.Children[0] as UcDataCollect).tiRemarkHistory.Visibility = Visibility.Visible;

                    SetSingleCoaterControl();

                    // BACK일때 LOTID SET 안함 
                    //if (!string.IsNullOrEmpty(LOTID))
                    //    LOTID = string.Empty;
                }
                else
                {
                    //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                    //    LARGELOT_GRID.Visibility = Visibility.Visible;

                    //CHECK_WAIT.Visibility = Visibility.Collapsed;
                    (grdResult.Children[0] as UcResult).ResultDetail.Visibility = Visibility.Visible;
                    (grdResult.Children[0] as UcResult).ResultDetail2.Visibility = Visibility.Collapsed;
                    //(grdResult.Children[0] as UcResult).grdSummary.Visibility = Visibility.Collapsed;

                    // 단면코터 TOP일시 초기화 및 Lable 표시안함 [2017-01-09]
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    tbWipReasonBack.Visibility = Visibility.Collapsed;

                    // 하단부로 변경되면서 Visible 처리 [2017-01-19]
                    (grdResult.Children[0] as UcResult).CoaterSlurry.Visibility = Visibility.Visible;
                    (grdResult.Children[0] as UcResult).CoaterSlurry2.Visibility = Visibility.Collapsed;
                    (grdDataCollect.Children[0] as UcDataCollect).tiRemarkHistory.Visibility = Visibility.Collapsed;

                    SetSingleCoaterControl();
                }
            }
            else
            {
                DataRowView drv = e.NewValue as DataRowView;
                Grid grdWipReason = (grdDataCollect.Children[0] as UcDataCollect).grdWipReason as Grid;
                TextBlock tbWipReasonBack = (grdDataCollect.Children[0] as UcDataCollect).lblBack;
                grdWipReason.ColumnDefinitions.Clear();

                if (Util.NVC(DataTableConverter.GetValue(drv, "CBO_CODE")).Equals("B"))
                {
                    WIPREASON2_GRID.Visibility = Visibility.Visible;
                    tbWipReasonBack.Visibility = Visibility.Visible;

                    ColumnDefinition cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);
                }
                else
                {
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    tbWipReasonBack.Visibility = Visibility.Collapsed;
                }
            }
            ClearDetailControls();

            // Foil, Slurry 추가 [2017-01-12]
            if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
            {
                txtCore1.Text = string.Empty;
                txtCore1.Tag = null;
                txtCore2.Text = string.Empty;
                txtCore2.Tag = null;
                txtSlurry1.Text = string.Empty;
                txtSlurry1.Tag = null;
                txtSlurry2.Text = string.Empty;
                txtSlurry2.Tag = null;
                if (isDoubleLayer)
                {
                    txtSlurry11.Text = string.Empty;
                    txtSlurry11.Tag = null;
                    txtSlurry22.Text = string.Empty;
                    txtSlurry22.Tag = null;
                }
            }
            LARGELOT_GRID.ItemsSource = null;
            PRODLOT_GRID.ItemsSource = null;

            if (string.Equals(procId, Process.COATING))
                GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));

            // 자동선택 추가
            if (LARGELOT_GRID.Visibility == Visibility.Visible)
                GetLargeLot();
            else
                GetProductLot();

            SetLotAutoSelected();
        }
        protected virtual void On_rdoTop_Checked(object sender, RoutedEventArgs e)
        {
            COATTYPE_COMBO.SelectedValue = "T";
        }
        protected virtual void On_rdoBack_Checked(object sender, RoutedEventArgs e)
        {
            COATTYPE_COMBO.SelectedValue = "B";
        }
        protected virtual void OnGridCurrentCellChanged(object sender, DataGridCellEventArgs e)
        {
            switch ((sender as C1DataGrid).Name)
            {
                case "dgLargeLot":
                    this.Dispatcher.BeginInvoke(new Action(() =>
                    {
                        C1DataGrid dg = sender as C1DataGrid;

                        if (e.Cell != null && e.Cell.Presenter != null && e.Cell.Presenter.Content != null)
                        {
                            CheckBox chk = e.Cell.Presenter.Content as CheckBox;

                            if (chk != null)
                            {
                                switch (Convert.ToString(e.Cell.Column.Name))
                                {
                                    case "CHK":
                                        if (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter != null &&
                                           dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox) != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked.HasValue &&
                                           !(bool)(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked)
                                        {
                                            DataTableConverter.SetValue(dg.Rows[e.Cell.Row.Index].DataItem, "CHK", true);
                                            chk.IsChecked = true;

                                            LARGELOTID = Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "LOTID_LARGE"));
                                            WO_DETL_ID = Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "WO_DETL_ID"));

                                            for (int i = 0; i < dg.Rows.Count; i++)
                                            {
                                                if (!i.Equals(e.Cell.Row.Index))
                                                {
                                                    DataTableConverter.SetValue(dg.Rows[i].DataItem, "CHK", false);

                                                    if (dg.GetCell(i, e.Cell.Column.Index).Presenter != null)
                                                    {
                                                        chk = dg.GetCell(i, e.Cell.Column.Index).Presenter.Content as CheckBox;
                                                        chk.IsChecked = false;
                                                    }
                                                }
                                            }

                                            ClearDetailControls();

                                            GetProductLot(LARGELOT_GRID.Rows[e.Cell.Row.Index].DataItem as DataRowView);

                                            //SetEnabled(dg.Rows[e.Cell.Row.Index].DataItem);
                                        }
                                        else if (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter != null &&
                                                 dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content != null &&
                                                 (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox) != null &&
                                                 (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked.HasValue &&
                                                 (bool)(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked)
                                        {
                                            ClearDetailControls();
                                            PRODLOT_GRID.ItemsSource = null;

                                            LARGELOTID = string.Empty;
                                            WO_DETL_ID = string.Empty;

                                            DataTableConverter.SetValue(dg.Rows[e.Cell.Row.Index].DataItem, "CHK", false);
                                            chk.IsChecked = false;
                                        }

                                        break;
                                }

                                if (LARGELOT_GRID.CurrentCell != null)
                                    LARGELOT_GRID.CurrentCell = LARGELOT_GRID.GetCell(LARGELOT_GRID.CurrentCell.Row.Index, LARGELOT_GRID.Columns.Count - 1);
                                else if (LARGELOT_GRID.Rows.Count > 0)
                                    LARGELOT_GRID.CurrentCell = LARGELOT_GRID.GetCell(LARGELOT_GRID.Rows.Count, LARGELOT_GRID.Columns.Count - 1);
                            }
                        }
                    }));
                    break;

                case "dgProductLot":
                    this.Dispatcher.BeginInvoke(new Action(() =>
                    {
                        C1DataGrid dg = sender as C1DataGrid;

                        if (e.Cell != null && e.Cell.Presenter != null && e.Cell.Presenter.Content != null)
                        {
                            CheckBox chk = e.Cell.Presenter.Content as CheckBox;

                            if (chk != null)
                            {
                                switch (Convert.ToString(e.Cell.Column.Name))
                                {
                                    case "CHK":
                                        if (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter != null &&
                                           dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox) != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked.HasValue &&
                                           !(bool)(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked)
                                        {
                                            DataTableConverter.SetValue(dg.Rows[e.Cell.Row.Index].DataItem, "CHK", true);
                                            chk.IsChecked = true;

                                            ClearDetailControls();

                                            if (!SetCheckProdListSameChildSeq(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Row))
                                                return;

                                            WIPSTATUS = Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "WIPSTAT"));
                                            LOTID = Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "LOTID"));

                                            if (procId.Equals(Process.HALF_SLITTING))
                                                PRLOTID = Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "LOTID_PR"));

                                            PRODLOT_GRID.SelectedIndex = e.Cell.Row.Index;

                                            // LOT별 ROLLMAP 속성 구분 (2021-08-18)
                                            //SetRollMapLotAttribute(LOTID);

                                            SelectRollMapLot(LOTID);

                                            if (!WIPSTATUS.Equals("WAIT"))
                                            {
                                                GetLotInfo(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem);

                                                if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
                                                    GetDefectList();
                                                else if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
                                                    GetDefectListMultiLane();

                                                GetQualityList(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem);

                                                //전극 설비불량정보 탭 추가
                                                GetEqptDfctData(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem);

                                                //슬리터2차 추가  2021-09-15 by 오화백
                                                if (procId.Equals(Process.SLITTING) || procId.Equals("E4200"))
                                                {
                                                    GetCottonList(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem);
                                                }
                                                // 색지정보 T/P공정 추가 [2017-07-11]
                                                if (procId.Equals(Process.ROLL_PRESSING) || string.Equals(procId, Process.TAPING))
                                                {
                                                    GetColorList(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem);
                                                    GetMaterialHistory();
                                                }

                                                // NISSAN용 전용 기능 [2017년 4월 말까지]
                                                // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
                                                if (string.Equals(LoginInfo.CFG_AREA_ID, "E6") && (string.Equals(procId, Process.REWINDER) || string.Equals(procId, Process.LASER_ABLATION)) ||
                                                    string.Equals(LoginInfo.CFG_AREA_ID, "E6") && string.Equals(procId, Process.BACK_WINDER))
                                                    GetDefectTagList(_LOTID);

                                                // 코터 이후 설비에서는 BOTTOM ROW 추가 [2017-06-13]
                                                if (!string.Equals(procId, Process.PRE_MIXING) && !string.Equals(procId, Process.MIXING) && !string.Equals(procId, Process.SRS_MIXING))
                                                    if (string.Equals(txtUnit.Text, "EA") && LOTINFO_GRID.BottomRows.Count == 0)
                                                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                                                            if (LOTINFO_GRID.Rows[i].Visibility == Visibility.Visible)
                                                                LOTINFO_GRID.BottomRows.Add(new C1.WPF.DataGrid.DataGridRow());

                                                // FPI 초도 Lot 알람 표시
                                                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING))
                                                    SetFirstProductionInspection();
                                            }

                                            // CSR : C20220713-000401 - 테이핑 공정과 공통코드 등록된 동만 실행
                                            if (procId.Equals(Process.COATING) || procId.Equals(Process.SRS_COATING) || procId.Equals(Process.TAPING))
                                                GetMaterial(Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "LOTID")));
                                            else if (procId.Equals(Process.MIXING) || procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.SRS_MIXING))  //MIXER전체공정 적용 확인 
                                                GetMaterialSummary(Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "LOTID")), Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "WOID")));

                                            if (!procId.Equals(Process.MIXING) && !procId.Equals(Process.PRE_MIXING) && !procId.Equals(Process.SRS_MIXING))
                                                GetRemarkHistory(e.Cell.Row.Index);

                                            #region # Roll Map
                                            //if (string.Equals(WIPSTATUS, Wip_State.EQPT_END))
                                            //    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                                            //else
                                            //    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;

                                            //YSH76. 폴란드 정보와 동일한 슬리팅일 경우 롤맵데이터 활성화. _ 2022.08.08
                                            if (string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING))
                                            {
                                                if (string.Equals(WIPSTATUS, Wip_State.EQPT_END) || string.Equals(WIPSTATUS, Wip_State.PROC))
                                                {
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                                                }
                                                else
                                                {
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
                                                }
                                            }
                                            else if (string.Equals(procId, Process.COATING))
                                            {
                                                if (string.Equals(WIPSTATUS, Wip_State.EQPT_END))
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                                                else
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
                                            }
                                            // 20230919 조성진, 하프슬리팅 공정진척 롤맵 버튼 활성화
                                            else if (string.Equals(procId, Process.HALF_SLITTING))
                                            {
                                                if (string.Equals(WIPSTATUS, Wip_State.EQPT_END))
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                                                else
                                                    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
                                            }

                                            #endregion

                                            // CSR : [C20220117-000411] - 불량/loss 정합화를 위한 시스템 개선 요청 건
                                            // 신규 길이초과 & 부족 자동 계산 적용 
                                            if (isLengthLack && string.Equals(WIPSTATUS, Wip_State.EQPT_END) && string.Equals(procId, Process.ROLL_PRESSING))
                                                SetExcessDeficiency(false);
                                            else if (isLengthLack && string.Equals(WIPSTATUS, Wip_State.EQPT_END) && string.Equals(procId, Process.SLITTING))
                                                SetExcessDeficiency(false);

                                            PRODLOT_GRID.SelectedIndex = e.Cell.Row.Index;

                                            SetControlTestCut();        //nathan 2023.12.13 롤맵 코터 수불 실적 적용
                                            SelectTestCut((grdDataCollect.Children[0] as UcDataCollect).dgTestCut);   //nathan 2023.12.13 롤맵 코터 수불 실적 적용

                                            #region [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
                                            if ((grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility == Visibility.Visible)
                                                GetTWS_Load(_LOTID);

                                            if (isTWS_LOADING_TRACKING == true)
                                            {
                                                String sLotID = String.Empty;
                                                if (WIPSTATUS.Equals("WAIT") == true)
                                                {
                                                    sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "LOTID_PR"));
                                                    GetTWS_LOADING_TRACKING(sLotID, true);
                                                }
                                                else
                                                {
                                                    sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "LOTID"));
                                                    GetTWS_LOADING_TRACKING(sLotID, false);

                                                    //투입랏의 롤 Lane 방향은 이전랏의 배출Lane방향으로 정의
                                                    if ((grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneForward.IsChecked == false
                                                       && (grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneReverse.IsChecked == false)
                                                    {
                                                        sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[e.Cell.Row.Index].DataItem, "LOTID_PR"));
                                                        GetTWS_LOADING_TRACKING(sLotID, true);
                                                    }
                                                }

                                                // [E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
                                                SetTWS_RULE_PROCESS_EQPT_ROLL_DIR(procId, sLotID);
                                            }
                                            #endregion

                                        }
                                        else if (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter != null &&
                                                 dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content != null &&
                                                 (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox) != null &&
                                                 (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked.HasValue &&
                                                 (bool)(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked)
                                        {
                                            ClearDetailControls();

                                            DataTableConverter.SetValue(dg.Rows[e.Cell.Row.Index].DataItem, "CHK", false);
                                            chk.IsChecked = false;

                                            SetCheckProdListSameChildSeq(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Row, true);
                                        }
                                        break;
                                }

                                if (PRODLOT_GRID.CurrentCell != null)
                                    PRODLOT_GRID.CurrentCell = PRODLOT_GRID.GetCell(PRODLOT_GRID.CurrentCell.Row.Index, PRODLOT_GRID.Columns.Count - 1);
                                else if (PRODLOT_GRID.Rows.Count > 0)
                                    PRODLOT_GRID.CurrentCell = PRODLOT_GRID.GetCell(PRODLOT_GRID.Rows.Count, PRODLOT_GRID.Columns.Count - 1);
                            }
                        }
                    }));
                    break;
            }
        }

        protected virtual void OnDataCollectGridCottonTagCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            if (e.Cell.Row != null && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, COTTON_GRID.Columns[e.Cell.Column.Index].Name)).Equals("")) { 
                isChangeCotton = true;
            }
        }

        protected virtual void OnDataCollectGridQualityCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid caller = sender as C1DataGrid;

            string sValue = String.Empty;
            string sUSL = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "USL"));
            string sLSL = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "LSL"));

            string sCLCTVALUE = string.Empty;
            string sCLCNAME = String.Empty;
            string sCLCITEM = String.Empty;

            if (string.Equals(e.Cell.Column.Name, "CLCTVAL02"))
            {
                sValue = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL02"));
                //sCLCITEM = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTITEM")).ToString().Split('-')[0];
                //[E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                if (Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTITEM")).ToString().Split('-').Count() == 3)
                {
                    sCLCITEM = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTITEM")).ToString().Split('-')[0] + "-" +
                        Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTITEM")).ToString().Split('-')[1];              
                }
                else
                {
                    sCLCITEM = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTITEM")).ToString().Split('-')[0];
                }
                sCLCNAME = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLSS_NAME1")).ToString() +
                    Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLSS_NAME2")).ToString() +
                    Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLSS_NAME3")).ToString();
                    //Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTNAME")).ToString().Replace("Back", "");
            }
            else
            {
                sValue = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01"));
            }
            string sCode = Util.NVC(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "INSP_VALUE_TYPE_CODE"));

            if (!sValue.Equals("") && e.Cell.Presenter != null)
            {
                if (sCode.Equals("NUM"))
                {
                    if (sLSL != "" && Util.NVC_Decimal(sValue) < Util.NVC_Decimal(sLSL))
                    {
                        //Util.MessageValidation("SFU1806");  //입력값이 하한값 보다 작습니다
                        //DataTableConverter.SetValue(dgQualityTop.Rows[dgQualityTop.CurrentRow.Index].DataItem, "CLCTVAL01", null);
                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.Red);
                        e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                        e.Cell.Presenter.FontWeight = FontWeights.Bold;
                    }

                    else if (sUSL != "" && Util.NVC_Decimal(sValue) > Util.NVC_Decimal(sUSL))
                    {
                        //Util.MessageValidation("SFU1805");  //입력값이 상한값 보다 큽니다
                        //DataTableConverter.SetValue(dgQualityTop.Rows[dgQualityTop.CurrentRow.Index].DataItem, "CLCTVAL01", null);
                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.Red);
                        e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                        e.Cell.Presenter.FontWeight = FontWeights.Bold;
                    }
                    else
                    {
                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                        e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                        e.Cell.Presenter.FontWeight = FontWeights.Normal;
                    }
                    isChangeQuality = true;

                    // RP공정에서 범위 알림 기능 추가 [2017-06-06]
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                    {
                        DataTable dataCollect = DataTableConverter.Convert(caller.ItemsSource);
                        int iHGCount1 = 0;  // H/G
                        int iHGCount2 = 0;  // M/S
                        int iHGCount3 = 0;  // 1차 H/G
                        int iHGCount4 = 0;  // 1차 M/S
                        decimal sumValue1 = 0;
                        decimal sumValue2 = 0;
                        decimal sumValue3 = 0;
                        decimal sumValue4 = 0;
                        foreach (DataRow row in dataCollect.Rows)
                        {
                            //[E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                            if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue1 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount1++;
                                }
                            }
                            else if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount2++;
                                }
                            }

                            else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue1 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount1++;
                                }
                            }
                            else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount2++;
                                }
                            }
                            else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue3 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount3++;
                                }
                            }
                            else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                {
                                    sumValue4 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    iHGCount4++;
                                }
                            }
                        }

                        if (iHGCount1 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue1 / iHGCount1)) > 4)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", 4);
                        else if (iHGCount2 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue2 / iHGCount2)) > 4)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), 4);
                        else if (iHGCount1 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue1 / iHGCount1)) > 2)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", 2);
                        else if (iHGCount2 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue2 / iHGCount2)) > 2)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), 2);
                        else if (iHGCount3 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue3 / iHGCount3)) > 4)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", 4);
                        else if (iHGCount4 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue4 / iHGCount4)) > 4)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), 4);
                        else if (iHGCount3 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue3 / iHGCount3)) > 2)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", 2);
                        else if (iHGCount4 > 0 && Math.Abs(Util.NVC_Decimal(e.Cell.Value) - (sumValue4 / iHGCount4)) > 2)
                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), 2);
                    }
                }

                if (string.Equals(e.Cell.Column.Name, "CLCTVAL02") && (procId.Equals(Process.COATING) || procId.Equals(Process.INS_COATING) || procId.Equals(Process.SRS_COATING)))
                {
                    if (QUALITY2_GRID.Visibility == Visibility.Visible)
                    {
                        // 로직 변환율로 계산하도록 변경 [2019-02-28] (C20190214_23432)
                        e.Cell.Presenter.Background = null;
                        e.Cell.Presenter.Foreground = null;

                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL02", null);

                        if (string.Equals(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "INSP_VALUE_TYPE_CODE"), "NUM") && Convert.ToDouble(sValue) != Double.NaN)
                        {
                            double inputRate = Convert.ToDouble(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "INSP_CONV_RATE"));
                            double input = Convert.ToDouble(GetUnitFormatted(sValue)) * inputRate;

                            // Unloading량은 원래 BACK로딩량 - TOP로딩량임, 하지만 현재 요청한 구조로는 처리가 어려워서 오창 자동차동만 하기 LOGIC을 사용한다고 하여 하기와 같은 로직을 내부적으로 반영
                            // TOP 로딩량 존재 시 : BACK LOADING - (TOP LOADING INPUT VALUE * 환산값 * 2) [소수점을 사용안하고 반을 감안하기 위하여 하기와 같이 적용 [2019-03-18]
                            bool isValueComplete = false;

                            //[E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                            if (string.Equals(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "INSP_ITEM_ID"), "E2000-0002"))
                            {
                                DataRow[] rows = (QUALITY_GRID.ItemsSource as DataView).Table.Select(string.Format("INSP_ITEM_ID = '{0}' AND CLSS_NAME2 = '{1}'",
                                    new object[] { "E2000-0001", DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLSS_NAME2") }));

                                if (rows != null && rows.Length > 0 && !string.IsNullOrWhiteSpace(Util.NVC(rows[0]["CLCTVAL01"])) && Convert.ToDouble(rows[0]["CLCTVAL01"]) > 0)
                                {
                                    if (inputRate.ToString().Contains("5"))
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", (input * 2) - Convert.ToDouble(rows[0]["CLCTVAL01"]));
                                    else
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input - Convert.ToDouble(rows[0]["CLCTVAL01"]));

                                    isValueComplete = true;
                                }
                            }

                            else if (string.Equals(DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "INSP_ITEM_ID"), "SI017"))
                            {
                                DataRow[] rows = (QUALITY_GRID.ItemsSource as DataView).Table.Select(string.Format("INSP_ITEM_ID = '{0}' AND CLSS_NAME2 = '{1}'",
                                    new object[] { "SI016", DataTableConverter.GetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLSS_NAME2") }));

                                if (rows != null && rows.Length > 0 && !string.IsNullOrWhiteSpace(Util.NVC(rows[0]["CLCTVAL01"])) && Convert.ToDouble(rows[0]["CLCTVAL01"]) > 0)
                                {
                                    if (inputRate.ToString().Contains("5"))
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", (input * 2) - Convert.ToDouble(rows[0]["CLCTVAL01"]));
                                    else
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input - Convert.ToDouble(rows[0]["CLCTVAL01"]));

                                    isValueComplete = true;
                                }
                            }

                            if (isValueComplete == false)
                                DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input);

                            C1.WPF.DataGrid.DataGridCell inputCell = QUALITY2_GRID.GetCell(caller.CurrentRow.Index, caller.Columns["CLCTVAL01"].Index);

                            if (sLSL != "" && Util.NVC_Decimal(input) < Util.NVC_Decimal(sLSL))
                            {
                                inputCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                inputCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                inputCell.Presenter.FontWeight = FontWeights.Bold;
                            }

                            else if (sUSL != "" && Util.NVC_Decimal(input) > Util.NVC_Decimal(sUSL))
                            {
                                inputCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                inputCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                inputCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                inputCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                inputCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                inputCell.Presenter.FontWeight = FontWeights.Normal;
                            }
                            isChangeQuality = true;
                        }
                        /*
                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.LightGray);
                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL02", null);
                        for (int i = 0; i < QUALITY_GRID.Rows.Count; i++)
                        {
                            if (DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTITEM").ToString().Split('-')[0].Equals("SI016") || DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTITEM").ToString().Split('-')[0].Equals("SI017"))
                            {
                               if ((DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLSS_NAME1").ToString() + DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLSS_NAME2").ToString() + DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLSS_NAME3").ToString()).Equals(sCLCNAME))
                               {
                                    if (DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTVAL01").Equals(""))
                                        DataTableConverter.SetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTVAL01", "0");
                                    if (Convert.ToDouble(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTVAL01")) == 0)
                                    {
                                        double input = Convert.ToDouble(GetUnitFormatted(sValue)) * 0.5;
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input);
                                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL02", sValue);
                                        for (int j = 0; j < QUALITY_GRID.Rows.Count; j++)
                                        {
                                            if (DataTableConverter.GetValue(QUALITY_GRID.Rows[j].DataItem, "CLCTITEM").ToString().Equals(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTITEM").ToString()))
                                            {
                                                Util.SetDataGridCurrentCell(QUALITY_GRID, QUALITY_GRID[j, 1]);
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                    else
                                    {
                                        double input = Convert.ToDouble(GetUnitFormatted(sValue)) - Convert.ToDouble(GetUnitFormatted(Convert.ToDouble(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTVAL01"))));
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input);
                                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL02", sValue);
                                        for (int j = 0; j < QUALITY_GRID.Rows.Count; j++)
                                        {
                                            if (DataTableConverter.GetValue(QUALITY_GRID.Rows[j].DataItem, "CLCTITEM").ToString().Equals(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTITEM").ToString()))
                                            {
                                                Util.SetDataGridCurrentCell(QUALITY_GRID, QUALITY_GRID[j, 1]);
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                            else
                            {
                                double input = Convert.ToDouble(GetUnitFormatted(sValue)) * 0.5;
                                DataTableConverter.SetValue(caller.Rows[caller.CurrentRow.Index].DataItem, "CLCTVAL01", input);
                            }
                        }
                        */
                    }
                }
            }
            else if (e.Cell.Presenter != null)
            {
            }
        }

        protected virtual void OnDataCollectGridFocusChanged(object sender, DependencyPropertyChangedEventArgs e)
        {
            try
            {
                // 자동차 2동 요구사항으로 인하여 Event재 정의를 함으로써 Focus가 정확히 이동 안하는 현상 때문에 해당 이벤트 추가 [2019-05-01]
                if (Convert.ToBoolean(e.NewValue) == true)
                {
                    C1NumericBox item = sender as C1NumericBox;
                    StackPanel panel = item.Parent as StackPanel;
                    C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                    int iRowIdx = p.Cell.Row.Index;
                    int iColIdx = p.Cell.Column.Index;
                    C1.WPF.DataGrid.C1DataGrid grid = p.DataGrid;

                    if (grid.CurrentCell.Column.Index != iColIdx)
                        grid.CurrentCell = grid.GetCell(iRowIdx, iColIdx);
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }


        protected virtual void OnDataCollectGridPreviewItmeKeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.Key == Key.Down || e.Key == Key.Up || e.Key == Key.Enter)
                {
                    int iRowIdx = 0;
                    int iColIdx = 0;
                    C1.WPF.DataGrid.C1DataGrid grid;

                    if (sender.GetType().Name == "C1NumericBox")
                    {
                        C1NumericBox item = sender as C1NumericBox;
                        StackPanel panel = item.Parent as StackPanel;
                        C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                        iRowIdx = p.Cell.Row.Index;
                        iColIdx = p.Cell.Column.Index;
                        grid = p.DataGrid;
                    }

                    else if (sender.GetType().Name == "ComboBox")
                    {
                        ComboBox item = sender as ComboBox;
                        StackPanel panel = item.Parent as StackPanel;
                        C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                        iRowIdx = p.Cell.Row.Index;
                        iColIdx = p.Cell.Column.Index;
                        grid = p.DataGrid;
                    }
                    else
                        return;

                    if (e.Key == Key.Down || e.Key == Key.Enter)
                    {
                        if ((iRowIdx + 1) < (grid.GetRowCount() - 1))
                            grid.ScrollIntoView(iRowIdx + 2, grid.Columns["CLCTVAL01"].Index);

                        if (grid.GetRowCount() > ++iRowIdx)
                        {
                            grid.CurrentCell = grid.GetCell(iRowIdx, iColIdx);

                            C1.WPF.DataGrid.DataGridCellPresenter p = grid.GetCell(iRowIdx, iColIdx).Presenter;

                            if (p != null)
                            {
                                StackPanel panel = p.Content as StackPanel;

                                for (int cnt = 0; cnt < panel.Children.Count; cnt++)
                                {
                                    if (panel.Children[cnt].Visibility == Visibility.Visible)
                                        panel.Children[cnt].Focus();
                                }
                            }                           
                        }
                    }
                    else if (e.Key == Key.Up)
                    {
                        if (grid.GetRowCount() > --iRowIdx)
                        {
                            if (iRowIdx > 0)
                                grid.ScrollIntoView(iRowIdx - 1, grid.Columns["CLCTVAL01"].Index);

                            if (iRowIdx < 0)
                            {
                                e.Handled = true;
                                return;
                            }

                            grid.CurrentCell = grid.GetCell(iRowIdx, iColIdx);
                            C1.WPF.DataGrid.DataGridCellPresenter p = grid.GetCell(iRowIdx, iColIdx).Presenter;

                            if (p != null)
                            {
                                StackPanel panel = p.Content as StackPanel;

                                for (int cnt = 0; cnt < panel.Children.Count; cnt++)
                                {
                                    if (panel.Children[cnt].Visibility == Visibility.Visible)
                                        panel.Children[cnt].Focus();
                                }
                            }
                        }
                    }
                    /*
                    else if (e.Key == Key.Left) // Left Shift시 신규 로직 적용 [2019-02-19]
                    {
                        // Left Shift Change
                        for (int c = (iColIdx - 1); 0 < c; c--)
                        {
                            if (grid.GetCell(iRowIdx, c) != null && grid.GetCell(iRowIdx, c).Column.Visibility == Visibility.Visible && grid.GetCell(iRowIdx, c).Column.Name.Contains("CLCTVAL") == true)
                            {
                                iColIdx = c;
                                break;
                            }
                        }

                        grid.CurrentCell = grid.GetCell(iRowIdx, iColIdx);
                        C1.WPF.DataGrid.DataGridCellPresenter p = grid.GetCell(iRowIdx, iColIdx).Presenter;

                        if (p != null)
                        {
                            StackPanel panel = p.Content as StackPanel;

                            if (panel != null)
                            {
                                for (int cnt = 0; cnt < panel.Children.Count; cnt++)
                                {
                                    if (panel.Children[cnt].Visibility == Visibility.Visible)
                                        panel.Children[cnt].Focus();
                                }
                            }
                            else
                            {
                                p.MoveFocus(new TraversalRequest(FocusNavigationDirection.Left));
                                p.IsSelected = true;
                            }
                        }
                    }
                    else if (e.Key == Key.Right)  // Right Shift시 신규 로직 적용 [2019-02-19]
                    {
                        for (int c = (iColIdx + 1); c < grid.Columns.Count; c++)
                        {
                            if (grid.GetCell(iRowIdx, c) != null && grid.GetCell(iRowIdx, c).Column.Visibility == Visibility.Visible && grid.GetCell(iRowIdx, c).Column.Name.Contains("CLCTVAL") == true)
                            {
                                iColIdx = c;
                                break;
                            }
                        }

                        grid.CurrentCell = grid.GetCell(iRowIdx, iColIdx);
                        C1.WPF.DataGrid.DataGridCellPresenter p = grid.GetCell(iRowIdx, iColIdx).Presenter;

                        if (p != null)
                        {
                            StackPanel panel = p.Content as StackPanel;

                            if (panel != null)
                            {
                                for (int cnt = 0; cnt < panel.Children.Count; cnt++)
                                {
                                    if (panel.Children[cnt].Visibility == Visibility.Visible)
                                        panel.Children[cnt].Focus();
                                }
                            }
                            else
                            {
                                p.MoveFocus(new TraversalRequest(FocusNavigationDirection.Right));
                                p.IsSelected = true;
                            }
                        }
                    }
                    */
                    e.Handled = true;
                }
                else if (e.Key == Key.Delete)
                {
                    if (sender.GetType().Name == "C1NumericBox")
                    {
                        int iRowIdx = 0;
                        int iColIdx = 0;
                        C1.WPF.DataGrid.C1DataGrid grid;

                        C1NumericBox item = sender as C1NumericBox;
                        StackPanel panel = item.Parent as StackPanel;
                        C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                        iRowIdx = p.Cell.Row.Index;
                        iColIdx = p.Cell.Column.Index;
                        grid = p.DataGrid;
                        item.Value = double.NaN;

                        C1.WPF.DataGrid.DataGridCell currentCell = grid.GetCell(iRowIdx, iColIdx);
                        currentCell.Presenter.Background = new SolidColorBrush(Colors.White);
                        currentCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                        currentCell.Presenter.FontWeight = FontWeights.Normal;
                    }

                    else if (sender.GetType().Name == "ComboBox")
                    {
                        ComboBox item = sender as ComboBox;
                        item.Text = string.Empty;
                        item.SelectedIndex = -1;
                    }
                    e.Handled = true;
                }
                else if (e.Key == Key.V && (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control)
                {
                    if (sender.GetType().Name == "C1NumericBox")
                    {
                        int iRowIdx = 0;
                        C1.WPF.DataGrid.C1DataGrid grid;

                        C1NumericBox item = sender as C1NumericBox;
                        StackPanel panel = item.Parent as StackPanel;
                        C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                        iRowIdx = p.Cell.Row.Index;
                        grid = p.DataGrid;

                        // 액셀파일 PASTE시 공란PASS없이 전체 붙여넣기 추가 [2019-01-28]
                        string[] stringSeparators = new string[] { "\r\n" };
                        string[] lines = Clipboard.GetText().Split(stringSeparators, StringSplitOptions.None);

                        foreach (string line in lines)
                        {
                            if (iRowIdx < grid.GetRowCount())
                                if (string.Equals(DataTableConverter.GetValue(grid.Rows[iRowIdx].DataItem, "INSP_VALUE_TYPE_CODE"), "NUM"))
                                    DataTableConverter.SetValue(grid.Rows[iRowIdx].DataItem, "CLCTVAL01", line.Trim());

                            iRowIdx++;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        protected virtual void OnDataCollectGridGotKeyboardLost(object sender, KeyboardFocusChangedEventArgs e)
        {
            try
            {
                if (isDupplicatePopup == true)
                {
                    e.Handled = false;
                    return;
                }

                isDupplicatePopup = true;
                int iRowIdx = 0;
                int iColIdx = 0;
                int iMeanColldx = 0;
                C1.WPF.DataGrid.C1DataGrid grid;

                if (sender.GetType().Name == "C1NumericBox")
                {
                    C1NumericBox item = sender as C1NumericBox;
                    StackPanel panel = item.Parent as StackPanel;
                    C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;

                    if (p.Cell == null)
                        return;

                    iRowIdx = p.Cell.Row.Index;
                    iColIdx = p.Cell.Column.Index;
                    iMeanColldx = QUALITY_GRID.Columns["MEAN"].Index;

                    grid = p.DataGrid;

                    C1.WPF.DataGrid.DataGridCell currentCell = grid.GetCell(iRowIdx, iColIdx);

                    // 자주검사 자동입력 기능 추가 [2020-12-19]
                    if (item != null && !string.IsNullOrEmpty(Util.NVC(item.Value)) && item.Value != 0 && !string.Equals(Util.NVC(item.Value), Double.NaN.ToString()) && currentCell != null)
                    {
                        DataRow[] searchRow = DataTableConverter.Convert(grid.ItemsSource).Select(string.Format("TARGET_INSP_ID = '{0}' AND INSP_PRDT_TYPE_CODE = '{1}' AND INQ_LANE_NO = {2}",
                            new object[] { DataTableConverter.GetValue(currentCell.Row.DataItem, "INSP_ITEM_ID"),
                                DataTableConverter.GetValue(currentCell.Row.DataItem, "INSP_PRDT_TYPE_CODE"),
                                DataTableConverter.GetValue(currentCell.Row.DataItem, "INQ_LANE_NO") }));

                        if (searchRow != null && searchRow.Length > 0)
                        {
                            string sTargetID   = Util.NVC(searchRow[0]["TARGET_INSP_ID"]);
                            string sExpression = Util.NVC(searchRow[0]["FUNC_EXP"]);
                            string sCondition  = Util.NVC(searchRow[0]["FUNC_COND"]);

                            DataRow[] targetRow = DataTableConverter.Convert(grid.ItemsSource).Select(string.Format("INSP_ITEM_ID = '{0}' AND INSP_PRDT_TYPE_CODE = '{1}' AND INQ_LANE_NO = {2}",
                                new object[] { sTargetID, DataTableConverter.GetValue(currentCell.Row.DataItem, "INSP_PRDT_TYPE_CODE"), DataTableConverter.GetValue(currentCell.Row.DataItem, "INQ_LANE_NO") }));

                            if (targetRow.Length > 0)
                                DataTableConverter.SetValue(grid.Rows[Util.getGridDataRowIndex(grid, searchRow[0])].DataItem, "CLCTVAL01", Util.GetSelfInspectionValue(targetRow, sExpression, sCondition));
                        }
                    }

                    string sLSL = Util.NVC(DataTableConverter.GetValue(currentCell.Row.DataItem, "LSL"));
                    string sCSL = Util.NVC(DataTableConverter.GetValue(currentCell.Row.DataItem, "CSL"));
                    string sUSL = Util.NVC(DataTableConverter.GetValue(currentCell.Row.DataItem, "USL"));

                    if (item != null && !string.IsNullOrEmpty(Util.NVC(item.Value)) && item.Value != 0 && !string.Equals(Util.NVC(item.Value), Double.NaN.ToString()))
                    {
                        if (sLSL != "" && Util.NVC_Decimal(item.Value) < Util.NVC_Decimal(sLSL))
                        {
                            currentCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                            currentCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                            currentCell.Presenter.FontWeight = FontWeights.Bold;
                        }

                        else if (sUSL != "" && Util.NVC_Decimal(item.Value) > Util.NVC_Decimal(sUSL))
                        {
                            currentCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                            currentCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                            currentCell.Presenter.FontWeight = FontWeights.Bold;
                        }
                        else
                        {
                            currentCell.Presenter.Background = new SolidColorBrush(Colors.White);
                            currentCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                            currentCell.Presenter.FontWeight = FontWeights.Normal;
                        }
                        isChangeQuality = true;
                    }

                    if (string.Equals(procId, Process.ROLL_PRESSING) && !string.IsNullOrEmpty(Util.NVC(item.Value)) && !string.Equals(Util.NVC(item.Value), Double.NaN.ToString()))
                    {
                        DataTable dataCollect = DataTableConverter.Convert(grid.ItemsSource);
                        int iHGCount1 = 0;  // H/G
                        int iHGCount2 = 0;  // M/S
                        int iHGCount3 = 0;  // 1차 H/G
                        int iHGCount4 = 0;  // 1차 M/S
                        int meancount1 = 0;  // 1차 M/S
                        int meancount2 = 0;  // 1차 M/S
                        int meancount3 = 0;  // 1차 M/S
                        int meancount4 = 0;  // 1차 M/S
                        decimal cslValue1 = 0;
                        decimal cslValue2 = 0;
                        decimal cslValue3 = 0;
                        decimal cslValue4 = 0;
                        decimal sumValue1 = 0;
                        decimal sumValue2 = 0;
                        decimal sumValue3 = 0;
                        decimal sumValue4 = 0;
                        decimal sumCslValue1 = 0;
                        decimal sumCslValue2 = 0;
                        decimal sumCslValue3 = 0;
                        decimal sumCslValue4 = 0;

                        if (item != null && !string.IsNullOrEmpty(Util.NVC(item.Value)) && item.Value != 0 && !string.Equals(Util.NVC(item.Value), Double.NaN.ToString()))
                        {
                            foreach (DataRow row in dataCollect.Rows)
                            {
                                // [E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                                if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount1++;
                                    sumCslValue1 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue1 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue1 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount1++;

                                        }
                                    }
                                }
                                else if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount2++;
                                    sumCslValue2 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue2 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount2++;

                                        }
                                    }
                                }
                                else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount1++;
                                    sumCslValue1 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue1 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue1 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount1++;

                                        }
                                    }
                                }
                                else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount2++;
                                    sumCslValue2 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue2 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount2++;

                                        }
                                    }
                                }
                                else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount3++;
                                    sumCslValue3 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue3 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue3 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount3++;
                                        }
                                    }
                                }
                                else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                                {
                                    meancount4++;
                                    sumCslValue4 += Util.NVC_Decimal(row["CSL"]);
                                    if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                                    {
                                        if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                        {
                                            sumValue4 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                            cslValue4 += Util.NVC_Decimal(row["CSL"]);
                                            iHGCount4++;
                                        }
                                    }
                                }
                            }
                        }
                        String iHGCountS1 = iHGCount1.ToString();
                        String iHGCountS2 = iHGCount2.ToString();
                        String iHGCountS3 = iHGCount3.ToString();
                        String iHGCountS4 = iHGCount4.ToString();
                        String sumValueS1 = sumValue1.ToString();
                        String sumValueS2 = sumValue2.ToString();
                        String sumValueS3 = sumValue3.ToString();
                        String sumValueS4 = sumValue4.ToString();
                        String sumCslValueS1 = sumCslValue1.ToString();
                        String sumCslValueS2 = sumCslValue2.ToString();
                        String sumCslValueS3 = sumCslValue3.ToString();
                        String sumCslValueS4 = sumCslValue4.ToString();
                        int mean1 = meancount1;
                        int mean2 = meancount2;
                        int mean3 = meancount3;
                        int mean4 = meancount4;


                        //추가개발 cys   
                        //롤프레스 두께측정 평균상한 하한체크
                        int roll_avg1 = 0;
                        int roll_avg2 = 0;
                        int iRowChk = p.Cell.Row.Index;
                        C1.WPF.DataGrid.DataGridCell currentAvgCell = grid.GetCell(iRowChk, iMeanColldx);

                        try
                        {

                            DataTable RQSTDT = new DataTable();
                            RQSTDT.TableName = "RQSTDT";
                            RQSTDT.Columns.Add("LANGID", typeof(string));
                            RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                            RQSTDT.Columns.Add("CMCODE", typeof(string));

                            DataRow dr = RQSTDT.NewRow();
                            dr["LANGID"] = LoginInfo.LANGID;
                            dr["CMCDTYPE"] = "ELEC_ROLLPRESS_MEAN";
                            dr["CMCODE"] = LoginInfo.CFG_AREA_ID;
                            RQSTDT.Rows.Add(dr);

                            DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

                            roll_avg1 = Int16.Parse(dtResult.Rows[0]["ATTRIBUTE1"].ToString());
                            roll_avg2 = Int16.Parse(dtResult.Rows[0]["ATTRIBUTE2"].ToString());
                        }
                        catch (Exception ex)
                        {

                        }

                        if (item != null && !string.IsNullOrEmpty(Util.NVC(item.Value)) && item.Value != 0 && !string.Equals(Util.NVC(item.Value), Double.NaN.ToString()))
                        {
                            // [E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                            if (iHGCount1 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "E3000-0001") && Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue1 > 0 && roll_avg1 > 0)
                                {
                                    if ((((Util.NVC_Decimal(cslValue1) / iHGCount1)) + roll_avg1 < (sumValue1 / iHGCount1)) && sumValue1 > 0 && iHGCount1 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue1) / iHGCount1)) - roll_avg2 > (sumValue1 / iHGCount1)) && sumValue1 > 0 && iHGCount1 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;

                                    if (mean1 == iHGCount1)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue1) / mean1)) + roll_avg1 < (sumValue1 / mean1)) || (((Util.NVC_Decimal(sumCslValue1) / mean1)) - roll_avg2 > (sumValue1 / mean1)))
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", roll_avg1);
                                    }
                                }
                            }

                            else if (iHGCount2 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "E3000-0001") && !Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue2 > 0 && roll_avg1 > 0)
                                {

                                    if ((((Util.NVC_Decimal(cslValue2) / iHGCount2)) + roll_avg1 < (sumValue2 / iHGCount2)) && sumValue1 > 0 && iHGCount2 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue2) / iHGCount2)) - roll_avg2 > (sumValue2 / iHGCount2)) && sumValue2 > 0 && iHGCount2 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;

                                    if (mean2 == iHGCount2)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue2) / mean2)) + roll_avg1 < (sumValue2 / mean2)) || (((Util.NVC_Decimal(sumCslValue2) / mean2)) - roll_avg2 > (sumValue2 / mean2)))
                                        {
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), roll_avg1);
                                        }
                                    }
                                }
                            }

                            else if (iHGCount1 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "SI022") && Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue1 > 0 && roll_avg1 > 0)
                                {
                                    if ((((Util.NVC_Decimal(cslValue1) / iHGCount1)) + roll_avg1 < (sumValue1 / iHGCount1)) && sumValue1 > 0 && iHGCount1 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue1) / iHGCount1)) - roll_avg2 > (sumValue1 / iHGCount1)) && sumValue1 > 0 && iHGCount1 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;

                                    if (mean1 == iHGCount1)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue1) / mean1)) + roll_avg1 < (sumValue1 / mean1)) || (((Util.NVC_Decimal(sumCslValue1) / mean1)) - roll_avg2 > (sumValue1 / mean1)))
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", roll_avg1);
                                    }
                                }
                            }

                            else if (iHGCount2 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "SI022") && !Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue2 > 0 && roll_avg1 > 0)
                                {

                                    if ((((Util.NVC_Decimal(cslValue2) / iHGCount2)) + roll_avg1 < (sumValue2 / iHGCount2)) && sumValue1 > 0 && iHGCount2 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue2) / iHGCount2)) - roll_avg2 > (sumValue2 / iHGCount2)) && sumValue2 > 0 && iHGCount2 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;

                                    if (mean2 == iHGCount2)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue2) / mean2)) + roll_avg1 < (sumValue2 / mean2)) || (((Util.NVC_Decimal(sumCslValue2) / mean2)) - roll_avg2 > (sumValue2 / mean2)))
                                        {
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), roll_avg1);
                                        }
                                    }
                                }
                            }

                            else if (iHGCount3 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "SI516") && Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue3 > 0 && roll_avg1 > 0)
                                {
                                    if ((((Util.NVC_Decimal(cslValue3) / iHGCount3)) + roll_avg1 < (sumValue3 / iHGCount3)) && sumValue3 > 0 && iHGCount3 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue3) / iHGCount3)) - roll_avg2 > (sumValue3 / iHGCount3)) && sumValue3 > 0 && iHGCount3 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;

                                    if (mean3 == iHGCount3)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue3) / mean3)) + roll_avg1 < (sumValue3 / mean3)) || (((Util.NVC_Decimal(sumCslValue3) / mean3)) - roll_avg2 > (sumValue3 / mean3)))
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께") + "(HG)", roll_avg1);
                                    }
                                }
                            }

                            else if (iHGCount4 > 0 && string.Equals(Util.NVC(dataCollect.Rows[iRowIdx]["INSP_ITEM_ID"]), "SI516") && !Util.NVC(dataCollect.Rows[iRowIdx]["CLSS_NAME1"]).Contains("HG"))
                            {
                                if (sumCslValue4 > 0 && roll_avg1 > 0)
                                {
                                    if ((((Util.NVC_Decimal(cslValue4) / iHGCount4)) + roll_avg1 < (sumValue4 / iHGCount4)) && sumValue4 > 0 && iHGCount4 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else if ((((Util.NVC_Decimal(cslValue4) / iHGCount4)) - roll_avg2 > (sumValue4 / iHGCount4)) && sumValue4 > 0 && iHGCount4 > 0 && sCSL != "")
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                                    }
                                    else
                                    {
                                        currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                        currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                        currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                    }
                                    isChangeQuality = true;
                                    if (mean4 == iHGCount4)
                                    {
                                        if ((((Util.NVC_Decimal(sumCslValue4) / mean4)) + roll_avg1 < (sumValue4 / mean4)) || (((Util.NVC_Decimal(sumCslValue4) / mean4)) - roll_avg2 > (sumValue4 / mean4)))
                                            Util.MessageValidation("SFU3519", ObjectDic.Instance.GetObjectName("두께"), roll_avg1);
                                    }
                                }
                            }
                        }
                        if (grid.BottomRows.Count > 0)
                            grid.BottomRows[0].Refresh(false);
                    }
                }

                else if (sender.GetType().Name == "ComboBox")
                {
                    ComboBox item = sender as ComboBox;
                    StackPanel panel = item.Parent as StackPanel;
                    C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                    iRowIdx = p.Cell.Row.Index;
                    iColIdx = p.Cell.Column.Index;
                    grid = p.DataGrid;

                    isChangeQuality = true;
                }
                else
                    return;

                e.Handled = true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
            finally
            {
                isDupplicatePopup = false;
            }
        }

        protected virtual void OnDataCollectGridPreviewKeyDown(object sender, KeyEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;
            if (dataGrid != null && dataGrid.CurrentCell != null && dataGrid.CurrentCell.Presenter != null)
            {
                // CLCTVAL02 ACTION 재 정의 [2019-03-27]
                if (string.Equals(dataGrid.CurrentCell.Column.Name, "CLCTVAL02"))
                {
                    if (e.Key == Key.Enter)
                    {
                        e.Handled = true;

                        int iRowIdx = dataGrid.CurrentCell.Row.Index;
                        if ((dataGrid.CurrentCell.Row.Index + 1) < dataGrid.GetRowCount())
                            iRowIdx++;

                        //dataGrid.SelectedItem = dataGrid.Rows[iRowIdx].DataItem;
                        //dataGrid.ScrollIntoView(iRowIdx, dataGrid.CurrentCell.Column.Index);
                        C1.WPF.DataGrid.DataGridCell currentCell = dataGrid.GetCell(iRowIdx, dataGrid.CurrentCell.Column.Index);
                        Util.SetDataGridCurrentCell(dataGrid, currentCell);
                        dataGrid.CurrentCell = currentCell;
                        dataGrid.Focus();

                        //if (currentCell.Presenter != null)
                        //{
                        //currentCell.Presenter.Background = new SolidColorBrush((Color)System.Windows.Media.ColorConverter.ConvertFromString("#FFFFD0DA"));
                        //dataGrid.CurrentCell = currentCell;
                        //dataGrid.SelectedIndex = iRowIdx;
                        //dataGrid.Focus();
                        //}
                    }
                    else if (e.Key == Key.Delete)
                    {
                        if (dataGrid.CurrentCell.Column.IsReadOnly == false)
                        {
                            // 이동중 DEL키 입력 시는 측정값 초기화하도록 변경 [2019-04-22]
                            if (dataGrid.GetCell(dataGrid.CurrentCell.Row.Index, dataGrid.CurrentCell.Column.Index).Presenter != null && dataGrid.GetCell(dataGrid.CurrentCell.Row.Index, dataGrid.CurrentCell.Column.Index).Presenter.Content != null &&
                                dataGrid.GetCell(dataGrid.CurrentCell.Row.Index, dataGrid.CurrentCell.Column.Index).Value != null)
                            {
                                ((C1NumericBox)dataGrid.GetCell(dataGrid.CurrentCell.Row.Index, dataGrid.CurrentCell.Column.Index).Presenter.Content).Value = 0;
                            }
                            else
                            {
                                DataTableConverter.SetValue(dataGrid.CurrentCell.Row.DataItem, "CLCTVAL01", null);
                            }
                            //DataTableConverter.SetValue(dataGrid.CurrentCell.Row.DataItem, dataGrid.CurrentCell.Column.Name, 0);
                        }
                    }
                }
                else
                {
                    if (e.Key == Key.Down || e.Key == Key.Up || e.Key == Key.Left || e.Key == Key.Right)
                    {
                        dataGrid.EndEdit(true);
                    }
                    else if (e.Key == Key.Delete)
                    {
                        // RollMap 수정 불가 Cell 삭제 방지 [2021-07-28]
                        //ysh76. 폴란드 정보와 동일하게 변경. _ 2022.08.08
                        if (isRollMapEquipment == true && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING)))
                            if (dataGrid.Name.Contains("WipReason") && string.Equals(DataTableConverter.GetValue(dataGrid.CurrentCell.Row.DataItem, "DFCT_QTY_UI_CHG_BLOCK_FLAG"), "Y"))
                                return;

                        if (dataGrid.CurrentCell.Column.IsReadOnly == false)
                        {
                            DataTableConverter.SetValue(dataGrid.CurrentCell.Row.DataItem, dataGrid.CurrentCell.Column.Name, 0);
                            dataGrid.BeginEdit(dataGrid.CurrentCell);
                            dataGrid.EndEdit(true);

                            if (!isRollMapEquipment)
                            {
                                DataTableConverter.SetValue(dataGrid.CurrentCell.Row.DataItem, dataGrid.CurrentCell.Column.Name, DBNull.Value);
                            }

                            if (dataGrid.CurrentCell != null && dataGrid.CurrentCell.Presenter != null)
                            {
                                dataGrid.CurrentCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                dataGrid.CurrentCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                dataGrid.CurrentCell.Presenter.FontWeight = FontWeights.Normal;
                            }
                        }
                        //삭제시 길이초과 재산출
                        SetExceedLength();
                    }
                    else if (!char.IsControl((char)e.Key) && !char.IsDigit((char)e.Key))
                    {
                        if (dataGrid.CurrentCell.Column.IsReadOnly == false && dataGrid.CurrentCell.IsEditable == false)
                            dataGrid.BeginEdit(dataGrid.CurrentCell.Row.Index, dataGrid.CurrentCell.Column.Index);
                    }
                }
            }
        }

        private void DefectChange(C1DataGrid dg, int iRow, int iCol)
        {
            // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
            int iCount = isResnCountUse == true ? 1 : 0;

            if (iCol == dg.Columns["ALL"].Index)
            {
                // 소형 전극은 SUM으로 분배 [2017-01-24]
                int iLaneQty = 0;

                for (int i = 1; i < LANENUM_COMBO.Items.Count; i++)
                    if (((CheckBox)LANENUM_COMBO.Items[i]).IsChecked == true)
                        iLaneQty++;

                if (iLaneQty == 0)
                    return;

                decimal iTarget = Util.NVC_Decimal(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol].Name));
                decimal iLastCol = iTarget % iLaneQty;

                for (int i = dg.Columns["ALL"].Index + (2 + iCount); i < dg.Columns["COSTCENTERID"].Index; i++)
                {
                    if ((i + iCol) % (2 + iCount) == 0)
                    {
                        if (dg.Columns[i].Visibility == Visibility.Collapsed)
                            continue;

                        string _ValueToFind = string.Empty;

                        // 길이초과, 길이부족의 경우는 SUM도 분배가 아닌 일괄 등록
                        if (string.Equals(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK") ||
                            string.Equals(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                        {
                            _ValueToFind = Util.NVC(iTarget);
                        }
                        else
                        {
                            if (string.Equals(dg.Columns["ALL"].GetColumnText(), ObjectDic.Instance.GetObjectName("SUM")))
                                _ValueToFind = Util.NVC(Math.Truncate(iTarget / iLaneQty) + (iLastCol > 1 ? 1 : iLastCol));
                            else
                                _ValueToFind = Util.NVC(iTarget);
                        }

                        // 공정 진행 중 불량은 ALL/SUM SETUP시 포함하여 저장 [2017-07-21]
                        if (procResnDt != null && procResnDt.Rows.Count > 0)
                        {
                            DataRow[] rows = procResnDt.Select("LOTID = '" + dg.Columns[i].Name + "' AND RESNCODE = '" + Util.NVC(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "RESNCODE")) + "'");
                            if (rows != null && rows.Length > 0)
                                _ValueToFind = Util.NVC(Util.NVC_Decimal(_ValueToFind) + Util.NVC_Decimal(rows[0]["RESNQTY"]));
                        }

                        DataTableConverter.SetValue(dg.Rows[iRow].DataItem, dg.Columns[i].Name, _ValueToFind);

                        bool isDefectValid = true;
                        // 슬리터 2차 추가  2021-09-15 by 오화백
                        if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                            isDefectValid = GetSumCutDefectQty(dg, iRow, i);
                        else
                            isDefectValid = GetSumDefectQty(dg, iRow, i);

                        if (isDefectValid == false)
                            continue;

                        iLastCol = iLastCol > 1 ? iLastCol - 1 : 0;
                    }
                }
            }
            //else if (iCol >= dg.Columns["ALL"].Index + 1 && iCol % 2 != 0)
            else if (iCol >= dg.Columns["ALL"].Index + 1 && (iCol - (dg.Columns["ALL"].Index -  1)) % (2 + iCount) == 1)
            {
                //슬리터 2차 추가  2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                    GetSumCutDefectQty(dg, iRow, iCol);
                else
                    GetSumDefectQty(dg, iRow, iCol);
            }
            //else if (iCol >= dg.Columns["ALL"].Index + 1  && iCol % 2 == 0)
            else if (iCol >= dg.Columns["ALL"].Index + 1 && (iCol - (dg.Columns["ALL"].Index - 1)) % (2 + iCount) == 0)
            {
                // 태그 수 불량/LOSS 자동 반영 로직 적용(C20190404_67447) [2019-04-11]
                // 슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                {
                    decimal dConvertValue = Util.NVC_Decimal(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "TAG_CONV_RATE")); 
                    if (dConvertValue > 0)
                    {
                        decimal dInputTagValue = Util.NVC_Decimal(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol].Name));
                        decimal dInputDefectValue = Util.NVC_Decimal(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol + 1].Name));
                        decimal dPreInputDefectValue = Util.NVC_Decimal(dtWipReasonBak.Rows[iRow][dg.Columns[iCol].Name]) * dConvertValue;
                        //bool isSumValue = dInputDefectValue == 0 ? true : false;
                        bool isSumValue = true;

                        if (string.Equals(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "TAG_ALL_APPLY_FLAG"), "Y"))
                        {
                            for (int i = dg.Columns["ALL"].Index + (2 + iCount); i < dg.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                            {
                                if (Util.NVC_Decimal(Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[i].Name))) != 0 &&
                                    Util.NVC_Decimal(Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[i].Name))) != dPreInputDefectValue)
                                {
                                    isSumValue = false;
                                    break;
                                }
                            }
                        }
                        else
                        {
                            if (dInputDefectValue != 0 &&  dInputDefectValue != dPreInputDefectValue)
                                isSumValue = false;
                        }

                        /*
                        if ( string.Equals(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "TAG_ALL_APPLY_FLAG"), "Y") && isSumValue == false)
                        {                           
                            for (int i = dg.Columns["ALL"].Index + 2; i < dg.Columns["COSTCENTERID"].Index; i +=2)
                            {
                                if (Convert.ToDouble(Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[i].Name))) != 0)
                                {
                                    isSumValue = false;
                                    break;
                                }
                            }
                        }
                        */

                        if ( isSumValue == true)
                        {
                            if (string.Equals(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "TAG_ALL_APPLY_FLAG"), "Y"))
                            {
                                for (int i = dg.Columns["ALL"].Index + (2 + iCount); i < dg.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                                {
                                    DataTableConverter.SetValue(dg.Rows[iRow].DataItem, dg.Columns[i].Name, (dInputTagValue * dConvertValue));
                                    DataTableConverter.SetValue(dg.Rows[iRow].DataItem, dg.Columns[i - 1].Name, (dInputTagValue));
                                }
                            }
                            else
                            {
                                DataTableConverter.SetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol + 1].Name, (dInputTagValue * dConvertValue));
                            }
                            GetSumCutDefectQty(dg, iRow, iCol + 1);
                        }
                    }
                }

                /*
                double dTagValue = Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol].Name));
                double dPitch = Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[iRow].DataItem, "TAG_CONV_RATE"));

                DataTableConverter.SetValue(dg.Rows[iRow].DataItem, dg.Columns[iCol + 1].Name, dTagValue * dPitch);

                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, Process.SRS_SLITTING))
                    GetSumCutDefectQty(dg, iRow, iCol + 1);
                else
                    GetSumDefectQty(dg, iRow, iCol + 1);
                */
            }
            //SetParentRemainQty();

            // 값 변환때마다 갱신(C20190404_67447) [2019-04-11]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if ( string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                dtWipReasonBak = DataTableConverter.Convert(dg.ItemsSource);
        }

        private void SetWipReasonCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;
            if (dataGrid != null)
            {
                if (e.Cell.Column.Index == dataGrid.Columns["RESNQTY"].Index)
                {
                    // 전체 체크가 없어서 주석 처리
                    /* for (int i = 0; i < dataGrid.Rows.Count; i++)
                    {
                        if (Convert.ToBoolean(DataTableConverter.GetValue(dataGrid.Rows[i].DataItem, "RESN_TOT_CHK")) == true)
                        {
                            DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESN_TOT_CHK", false);

                            if (e.Cell.Row.Index != i)
                                DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESNQTY", 0);
                        }
                    } */

                    // 재 조건 조정 배분 로직 추가 [2021-07-27]
                    DataRow[] row = DataTableConverter.Convert(dataGrid.ItemsSource).Select("DFCT_CODE='" +
                        Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "DFCT_CODE")) + "' AND PRCS_ITEM_CODE='GRP_QTY_DIST'");

                    if ( row.Length > 0)
                    {
                        decimal iCurrQty = 0;
                        decimal iResQty = 0;
                        decimal iInitQty = row.Sum(g => g.GetValue("FRST_AUTO_RSLT_RESNQTY").GetDecimal());

                        decimal iDistQty = DataTableConverter.Convert(dataGrid.ItemsSource).AsEnumerable()
                                                .Where(g => g.Field<string>("DFCT_CODE") == Util.NVC(row[0]["DFCT_CODE"]) &&
                                                                   g.Field<string>("PRCS_ITEM_CODE") != "GRP_QTY_DIST" &&
                                                                   g.Field<string>("RESNCODE") != Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNCODE")))
                                                .Sum(g => Util.NVC_Decimal(g.Field<string>("RESNQTY")));

                        if ( iInitQty < (iDistQty + Util.NVC_Decimal(e.Cell.Value)))
                            DataTableConverter.SetValue(e.Cell.Row.DataItem , "RESNQTY", iInitQty - iDistQty);

                        for (int i = 0; i < dataGrid.Rows.Count; i++)
                        {
                            iCurrQty = 0;
                            if (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[i].DataItem, "DFCT_CODE"), row[0]["DFCT_CODE"]) &&
                                string.Equals(DataTableConverter.GetValue(dataGrid.Rows[i].DataItem, "PRCS_ITEM_CODE"), "GRP_QTY_DIST"))
                            {
                                iCurrQty = Util.NVC_Decimal(DataTableConverter.GetValue(dataGrid.Rows[i].DataItem, "FRST_AUTO_RSLT_RESNQTY"));

                                if (iCurrQty <= (iDistQty + Util.NVC_Decimal(e.Cell.Value) - iResQty))
                                {
                                    DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESNQTY", 0);
                                    iResQty += iCurrQty;
                                }
                                else
                                {
                                    DataTableConverter.SetValue(dataGrid.Rows[i].DataItem, "RESNQTY",iCurrQty - (iDistQty + Util.NVC_Decimal(e.Cell.Value) - iResQty));
                                    iResQty = iDistQty + Util.NVC_Decimal(e.Cell.Value);
                                }
                            }
                        }
                    } 

                    #region # Coater Back
                    if (string.Equals(procId, Process.COATING))
                    {
                        // 해당 로직 주석 처리
                        /*
                        // 기타 BACK 집계된 수량보다 작은경우 집계수량 적용
                        DataRow[] dr = _dtWipReasonDefectBack.Select("RESNCODE ='MZZ01Z01E60'");
                        if (dr?.Length > 0)
                        {
                            if (string.Equals(DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNCODE"), "MZZ01Z01E60"))
                            {
                                if (Util.NVC_Decimal(DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNQTY")) < Util.NVC_Decimal(dr[0]["RESNQTY"]))
                                {
                                    DataTableConverter.SetValue(e.Cell.Row.DataItem, "RESNQTY", Util.NVC_Decimal(dr[0]["RESNQTY"]));
                                    //Util.MessageValidation("SFU1500");
                                }
                            }
                        }
                        
                        decimal sumResonQty = 0;
                        //DataRow[] drLoad = (dgWipReason2.ItemsSource as DataView).Table.Select("RESNCODE = 'PL19LA1'"); // 재조건조정 Loading 
                        DataRow[] drCondition = (WIPREASON2_GRID.ItemsSource as DataView).Table.Select("RESNCODE IN ('PL19LA2','PL19LD5','PL19LD7','PL19LD9','PL19LE1')");

                        foreach (DataRow row in drCondition)
                            sumResonQty += Util.NVC_Decimal(row["RESNQTY"]);

                        //재조건조정-(Back)-Mismatch PL19LA2, 재조건조정-표면(Back) PL19LD5, 재조건조정-접힘(Back) PL19LD7, 재조건조정-절연(Back) PL19LD9, 재조건조정-폭(Back) PL19LE1
                        string[] targetarray = new string[] { "PL19LA2", "PL19LD5", "PL19LD7", "PL19LD9", "PL19LE1" };

                        if (targetarray.Contains(DataTableConverter.GetValue(e.Cell.Row.DataItem, "RESNCODE").GetString()))
                        {
                            DataRow[] dr1 = _dtWipReasonDefectBack.Select("RESNCODE = 'PL19LA1'"); // 재조건조정 Loading 
                            if (dr1.Length > 0)
                            {
                                for (int i = 0; i < WIPREASON2_GRID.Rows.Count; i++)
                                {
                                    if (string.Equals(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "RESNCODE"), "PL19LA1"))
                                    {
                                        DataTableConverter.SetValue(WIPREASON2_GRID.Rows[i].DataItem, "RESNQTY", sumResonQty + Util.NVC_Decimal(dr1[0]["RESNQTY"]));
                                        break;
                                    }
                                }
                            }
                        }
                        */
                    }

                    #endregion

                    #region # RollPress

                    #endregion
                }

                dataGrid.EndEdit();
            }
        }

        private void GetSumDefectQty()
        {
            double defectQty = 0;
            double LossQty = 0;
            double chargeQty = 0;
            double totalSum = 0;
            double laneqty = 0;

            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
            {
                defectQty = SumDefectQty("DEFECT_LOT");
                LossQty = SumDefectQty("LOSS_LOT");
                chargeQty = SumDefectQty("CHARGE_PROD_LOT");

                totalSum = defectQty + LossQty + chargeQty;

                DataTable dt = (LOTINFO_GRID.ItemsSource as DataView).Table;

                for (int i = LOTINFO_GRID.TopRows.Count; i < dt.Rows.Count + LOTINFO_GRID.TopRows.Count; i++)
                {
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_DEFECT", defectQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_LOSS", LossQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_CHARGEPRD", chargeQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY", totalSum);

                    if (isRollMapEquipment)
                    {
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY")) - totalSum);
                    }
                    else
                    {
                        if (string.IsNullOrEmpty(Util.NVC(txtInputQty.Tag)))
                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY")) - totalSum);
                        else
                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) + totalSum);
                    }

                    laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));

                    if (txtLaneQty != null && !string.Equals(procId, Process.HALF_SLITTING))
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * txtLaneQty.Value);
                    else
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * laneqty);
                }

                if (isCoaterAfterProcess)
                    SetParentRemainQty();
            }
        }

        private void GetSumDefectQty(C1DataGrid dg)
        {
            double defectQty = 0;
            double LossQty = 0;
            double chargeQty = 0;
            double totalSum = 0;
            double laneqty = 0;

            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
            {
                defectQty = SumDefectQty("DEFECT_LOT");
                LossQty = SumDefectQty("LOSS_LOT");
                chargeQty = SumDefectQty("CHARGE_PROD_LOT");

                totalSum = defectQty + LossQty + chargeQty;

                DataTable dt = (LOTINFO_GRID.ItemsSource as DataView).Table;

                for (int i = LOTINFO_GRID.TopRows.Count; i < dt.Rows.Count + LOTINFO_GRID.TopRows.Count; i++)
                {
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_DEFECT", defectQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_LOSS", LossQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_CHARGEPRD", chargeQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY", totalSum);

                    if (string.IsNullOrEmpty(Util.NVC(txtInputQty.Tag)))
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY")) - totalSum);
                    else
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) + totalSum);

                    laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));

                    if (txtLaneQty != null && !string.Equals(procId, Process.HALF_SLITTING))
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * txtLaneQty.Value);
                    else
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * laneqty);
                }
            }
        }

        private bool GetSumDefectQty(C1DataGrid dg, int rowIdx, int colIdx)
        {
            string subLotId = dg.Columns[colIdx].Name;
            string actId = Util.NVC(DataTableConverter.GetValue(dg.Rows[rowIdx].DataItem, "ACTID"));
            double inputQty = 0;
            double actSum = 0;
            double rowSum = 0;
            double totalSum = 0;
            int iLotIdx = Util.gridFindDataRow(ref dgLotInfo, "LOTID", subLotId, false);

            // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
            int iCount = isResnCountUse == true ? 1 : 0;

            inputQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "INPUTQTY"));

            for (int i = dg.Columns["ALL"].Index + (2 + iCount); i < dg.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                rowSum += Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[rowIdx].DataItem, dg.Columns[i].Name));

            actSum = SumDefectQty(dg, colIdx, subLotId, actId);

            totalSum = actSum;
            if (!string.Equals(actId, "DEFECT_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "DTL_DEFECT"));
            if (!string.Equals(actId, "LOSS_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "DTL_LOSS"));
            if (!string.Equals(actId, "CHARGE_PROD_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "DTL_CHARGEPRD"));

            /*
            if (inputQty < totalSum)
            {
                ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1608"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.Warning);  //생산량 보다 불량이 크게 입력될 수 없습니다.
                DataTableConverter.SetValue(dg.Rows[rowIdx].DataItem, dg.Columns[colIdx].Name, null);
                return false;
            }
            */

            DataTableConverter.SetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, string.Equals(actId, "DEFECT_LOT") ? "DTL_DEFECT" : string.Equals(actId, "LOSS_LOT") ? "DTL_LOSS" : "DTL_CHARGEPRD", actSum);
            DataTableConverter.SetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "LOSSQTY", totalSum);
            DataTableConverter.SetValue(LOTINFO_GRID.Rows[iLotIdx].DataItem, "GOODQTY", inputQty - totalSum);

            DataTableConverter.SetValue(dg.Rows[rowIdx].DataItem, "RESNTOTQTY", rowSum);

            return true;
        }

        private bool GetSumCutDefectQty(C1DataGrid dg, int rowIdx, int colIdx)
        {
            string actId = Util.NVC(DataTableConverter.GetValue(dg.Rows[rowIdx].DataItem, "ACTID"));
            double inputQty = 0;
            double actSum = 0;
            double totalSum = 0;
            double rowSum = 0;
            double laneQty = 0;

            // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
            int iCount = isResnCountUse == true ? 1 : 0;

            laneQty = (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) - LOTINFO_GRID.TopRows.Count;
            inputQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

            for (int i = dg.Columns["ALL"].Index + (2 + iCount); i < dg.Columns["COSTCENTERID"].Index; i += (2 + iCount))
            {
                /*
                if (inputQty < SumDefectQty(dg, dg.Columns[i].Name))
                {
                    ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1608"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.Warning);  //생산량 보다 불량이 크게 입력될 수 없습니다.
                    DataTableConverter.SetValue(dg.Rows[rowIdx].DataItem, dg.Columns[colIdx].Name, null);
                    return false;
                }
                */

                rowSum += Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[rowIdx].DataItem, dg.Columns[i].Name));
                actSum += SumDefectQty(dg, i, dg.Columns[i].Name, actId);
            }

            totalSum = actSum;
            if (!string.Equals(actId, "DEFECT_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_DEFECT"));
            if (!string.Equals(actId, "LOSS_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_LOSS"));
            if (!string.Equals(actId, "CHARGE_PROD_LOT"))
                totalSum += Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_CHARGEPRD"));

            DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, string.Equals(actId, "DEFECT_LOT") ? "DTL_DEFECT" : string.Equals(actId, "LOSS_LOT") ? "DTL_LOSS" : "DTL_CHARGEPRD", actSum);
            DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY", totalSum);
            DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY", (inputQty * laneQty) - totalSum);

            DataTableConverter.SetValue(dg.Rows[rowIdx].DataItem, "RESNTOTQTY", rowSum);

            return true;

         }

        protected virtual void OnDateTimeChanged(object sender, NullablePropertyChangedEventArgs<DateTime> e)
        {
            //if (txtWorkTime != null && !string.IsNullOrEmpty(txtStartDateTime.Text))
            //    txtWorkTime.Value = (Convert.ToDateTime(txtEndDateTime.Text) - Convert.ToDateTime(txtStartDateTime.Text)).TotalMinutes;
        }

        protected virtual void OnMouseWheelAction(object sender, MouseWheelEventArgs e)
        {
            e.Handled = true;
        }

        private void SetCauseTitle()
        {
            int causeqty = 0;

            if (WIPREASON_GRID.ItemsSource != null)
            {
                DataTable dt = (WIPREASON_GRID.ItemsSource as DataView).Table;
                for (int i = WIPREASON_GRID.TopRows.Count; i < dt.Rows.Count + WIPREASON_GRID.TopRows.Count; i++)
                {
                    string resnname = DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNNAME").ToString();
                    if (resnname.IndexOf("*") == 1)
                        causeqty++;
                }
                if (causeqty > 0)
                {
                    if (procId.Equals("E1000"))
                    {
                        TextBlock tbTop = (grdDataCollect.Children[0] as UcDataCollect).lblTop;
                        tbTop.Margin = new Thickness(300, 0, 8, 0);
                        tbTop.Visibility = Visibility.Collapsed;
                    }
                    if ((grdDataCollect.Children[0] as UcDataCollect).lblTop.Visibility == Visibility.Visible)
                    {
                        (grdDataCollect.Children[0] as UcDataCollect).lblTop.Text = ObjectDic.Instance.GetObjectName("Top(*는 타공정 귀속)");
                    }
                    else
                    {
                        (grdDataCollect.Children[0] as UcDataCollect).lblTop.Visibility = Visibility.Visible;
                        (grdDataCollect.Children[0] as UcDataCollect).lblTop.Text = ObjectDic.Instance.GetObjectName("(*는 타공정 귀속)");
                    }
                }
            }
            if (WIPREASON2_GRID.ItemsSource != null)
            {
                DataTable dt = (WIPREASON2_GRID.ItemsSource as DataView).Table;
                for (int i = WIPREASON2_GRID.TopRows.Count; i < dt.Rows.Count + WIPREASON2_GRID.TopRows.Count; i++)
                {
                    string resnname = DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "RESNNAME").ToString();
                    if (resnname.IndexOf("*") == 1)
                        causeqty++;
                }
                if (causeqty > 0)
                    (grdDataCollect.Children[0] as UcDataCollect).lblBack.Text = ObjectDic.Instance.GetObjectName("Back(*는 타공정 귀속)");
            }
        }

        private bool ValidateDefect(C1DataGrid datagrid)
        {
            if (datagrid.GetRowCount() < 1)
            {
                Util.MessageValidation("SFU1578");  //불량 항목이 없습니다.
                return false;
            }

            // 길이초과 입력 시 반영 안해줌
            if (isCoaterAfterProcess)
            {
                //슬리터 공정진척 길이초과 값이 존재하면 길이부족 입력 불가 처리
                //슬리터 2차 추가 2021-09-15 by 오화백 
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                {
                    if (string.Equals(DataTableConverter.GetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                    {
                        int iCount = isResnCountUse == true ? 1 : 0;
                        decimal iLackQty = 0;

                        iLackQty = Util.NVC_Decimal(DataTableConverter.GetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "ALL"));

                        if (iLackQty > 0)
                        {
                            for (int i = 0; i < datagrid.Rows.Count; i++)
                            {
                                if (string.Equals(DataTableConverter.GetValue(datagrid.Rows[i].DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                                {
                                    if (Util.NVC_Decimal(DataTableConverter.GetValue(datagrid.Rows[i].DataItem, "RESNTOTQTY")) > 0)
                                    {
                                        Util.MessageValidation("SFU8315");  // 길이초과와 길이부족을 동시 입력 불가
                                        DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "ALL", 0);
                                        
                                        return true ;
                                    }
                                }
                            }
                        }    
                    }
                }

                if (string.Equals(DataTableConverter.GetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                {
                    // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                    int iCount = isResnCountUse == true ? 1 : 0;

                    decimal inputQty = 0;
                    decimal inputLengthQty = 0;
                    //슬리터 2차 추가  2021-09-15 by 오화백
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                        inputLengthQty = Util.NVC_Decimal(DataTableConverter.GetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "ALL"));
                    else
                        inputLengthQty = Util.NVC_Decimal(DataTableConverter.GetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, "RESNQTY"));

                    if (inputLengthQty > 0)
                    {
                        inputQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

                        if (Util.NVC_Decimal(txtParentQty.Value) > inputQty)
                        {
                            Util.MessageValidation("SFU3424");  // FINAL CUT이 아닌 경우 길이초과 입력 불가
                            DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, datagrid.CurrentCell.Column.Name, null);
                            //슬리터 2차 추가 2021-09-15 by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                                for (int i = WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount); i < WIPREASON_GRID.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                                    DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, datagrid.Columns[i].Name, 0);

                            exceedLengthQty = 0;
                            return false;
                        }

                        if (inputLengthQty > (inputQty - Util.NVC_Decimal(txtParentQty.Value)))
                        {
                            Util.MessageValidation("SFU3422", (inputQty - Util.NVC_Decimal(txtParentQty.Value)) + txtUnit.Text);    // 길이초과수량을 초과하였습니다.[현재 실적에서 길이초과는 %1까지 입력 가능합니다.] 
                            DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, datagrid.CurrentCell.Column.Name, null);

                            //슬리터 2차 추가 2021-09-15 by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                                for (int i = WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount); i < WIPREASON_GRID.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                                    DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, datagrid.Columns[i].Name, 0);

                            exceedLengthQty = 0;
                            return false;
                        }
                    }

                    //길이부족 입력 후 길이초과 입력되면 길이부족 초기화
                    //슬리터 2차 추가 2021-09-15 by 오화백
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                    {
                        for (int k = 0; k < datagrid.Rows.Count; k++)
                        {
                            if (string.Equals(DataTableConverter.GetValue(datagrid.Rows[k].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                            {
                                if (Util.NVC_Decimal(DataTableConverter.GetValue(datagrid.Rows[k].DataItem, "RESNTOTQTY")) > 0)
                                {
                                    if (SetLossLot(datagrid, ITEM_CODE_LEN_LACK, 0) == false)
                                        return true;
                                    DataTableConverter.SetValue(datagrid.Rows[k].DataItem, "ALL", 0);
                                }
                            }
                        }
                    }
                }
            }


            /*
            if (string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"))) || Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) == 0 || string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"))))
            {
                Util.MessageValidation("SFU1607");  //생산량 또는 양품량부터 입력하세요.
                DataTableConverter.SetValue(datagrid.Rows[datagrid.SelectedIndex].DataItem, datagrid.CurrentCell.Column.Name, null);  // 입력횟수 추가로 동적컬럼 초기화로 변경
  
                txtInputQty.Focus();

                return false;
            }
            */
            return true;
        }

        protected virtual void OnKeyDownInputQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                if (LOTINFO_GRID.GetRowCount() < 1)
                    return;

                // 청주 소형전극에서만 패턴에서만 변환해서 값 입력 [COATER에서만 사용]
                if (string.Equals(txtUnit.Text, "EA") && string.Equals(LoginInfo.CFG_AREA_ID, "E1") && string.Equals(procId, Process.COATING))
                    txtInputQty.Value = Convert.ToDouble(GetIntFormatted(Util.NVC_Decimal(txtInputQty.Value) / GetPatternLength(_PRODID)));

                //길이부족 입력 후 길이초과 입력되면 길이부족 초기화
                //슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") ||string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                {
                    for (int k = 0; k < WIPREASON_GRID.Rows.Count; k++)
                    {
                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                        {
                            if (Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "RESNTOTQTY")) > 0)
                            {
                                if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, 0) == false)
                                    return;
                                DataTableConverter.SetValue(WIPREASON_GRID.Rows[k].DataItem, "ALL", 0);
                            }
                        }
                    }
                }

                if (isCoaterAfterProcess)
                {
                    isChangeInputFocus = true;
                    if (IsFinalProcess())
                    {
                        // CSR : [C20220117-000411] - 불량/loss 정합화를 위한 시스템 개선 요청 건
                        // 신규 길이초과 & 부족 자동 계산 적용 
                        if (isLengthLack == true)
                        {
                            SetExcessDeficiency(true);
                        }
                        else
                        {
                            if (Convert.ToDouble(txtInputQty.Value) > Convert.ToDouble(txtParentQty.Value))
                            {
                                decimal diffQty = Math.Abs(Util.NVC_Decimal(txtParentQty.Value) - Util.NVC_Decimal(txtInputQty.Value));

                                // 투입량의 제한률 이상 초과하면 입력 금지, 단 INPUT_OVER_RATE가 등록되어있지 않으면 SKIP [2017-03-02]
                                decimal inputRateQty = Util.NVC_Decimal(Util.NVC_Decimal(txtParentQty.Value) * inputOverrate);

                                if (inputRateQty > 0 && diffQty > inputRateQty)
                                {
                                    Util.MessageValidation("SFU3195", new object[] { Util.NVC(inputOverrate * 100) + "%" });    //투입량의 %1를 초과하여 입력 불가 [생산량 재 입력 후 진행]
                                    return;
                                }

                                //  차이수량(생산량-투입량) %1 만큼 길이초과로 등록 하시겠습니까?
                                Util.MessageConfirm("SFU1921", (vResult) =>
                                {
                                    if (vResult == MessageBoxResult.OK)
                                    {
                                        if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_EXCEED, diffQty) == false)
                                            return;

                                        exceedLengthQty = diffQty;
                                    //txtRemainQty.Value = 0;
                                    //SaveDefect(WIPREASON_GRID);

                                    if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                                        {
                                            if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_EXCEED, diffQty) == false)
                                                return;

                                        //SaveDefect(WIPREASON2_GRID);
                                    }

                                        isChangeWipReason = true;
                                        SetInputQty();
                                        WIPREASON_GRID.Refresh();
                                        LOTINFO_GRID.Refresh(false);
                                    }
                                }, new object[] { diffQty + txtUnit.Text });

                            }
                            // 2022-12-29 오화백  EP 동 추가
                            else if (Convert.ToDouble(txtInputQty.Value) < Convert.ToDouble(txtParentQty.Value) && (LoginInfo.CFG_AREA_ID == "E5" || LoginInfo.CFG_AREA_ID == "EP"))
                            {
                                double DefaltValue = Convert.ToDouble(txtParentQty.Value) - Convert.ToDouble(txtInputQty.Value);
                                if (DefaltValue < 50 && DefaltValue > 0)
                                {
                                    decimal DfatValue = Convert.ToDecimal(DefaltValue);
                                    Util.MessageConfirm("SFU8169", (vResult) =>
                                    {
                                        if (vResult == MessageBoxResult.OK)
                                        {
                                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, DfatValue) == false)
                                                return;

                                            exceedLengthQty = DfatValue;
                                            //txtRemainQty.Value = 0;
                                            //SaveDefect(WIPREASON_GRID);

                                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                                            {
                                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, DfatValue) == false)
                                                    return;

                                            //SaveDefect(WIPREASON2_GRID);
                                            }

                                            isChangeWipReason = true;
                                            SetInputQty();
                                            WIPREASON_GRID.Refresh();
                                            LOTINFO_GRID.Refresh(false);
                                        }
                                    }, new object[] { DefaltValue + txtUnit.Text });
                                }
                                else
                                {
                                    SetInputQty();
                                }
                            }
                            else
                            {
                                SetInputQty();
                            }
                        }
                    }
                    else
                    {
                        // Rollmap용은 불량 실적 수정 불가로 투입량 + 길이초과 까지 입력가능하도록 수정
                        if (isRollMapEquipment == true)
                        {
                            if (Convert.ToDouble(txtInputQty.Value)  > (Convert.ToDouble(txtParentQty.Value) + Convert.ToDouble(exceedLengthQty)))
                            {
                                Util.MessageValidation("SFU1614");  //생산량이 투입량을 초과할 수 없습니다.
                                return;
                            }
                            else
                            {
                                SetInputQty();
                            }
                        }
                        else
                        {
                            if (Convert.ToDouble(txtInputQty.Value) > Convert.ToDouble(txtParentQty.Value))
                            {
                                Util.MessageValidation("SFU1614");  //생산량이 투입량을 초과할 수 없습니다.
                                return;
                            }
                            else
                            {
                                SetInputQty();
                            }
                        }                    
                    }
                    isChangeInputFocus = false; // FOCUS 초기화
                }
                else
                {
                    SetInputQty();
                }
                //슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                    WIPREASON_GRID.Refresh(false);

                LOTINFO_GRID.Refresh(false);
            }
        }

        protected virtual void OnKeyLostInputQty(object sender, System.Windows.RoutedEventArgs e)
        {
            if (isChangeInputFocus == false && txtInputQty.Value > 0)
                OnKeyDownInputQty(txtInputQty, new KeyEventArgs(Keyboard.PrimaryDevice, Keyboard.PrimaryDevice.ActiveSource, 0, Key.Enter));
        }

        protected virtual void OnKeyDownMesualQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                if (LOTINFO_GRID.GetRowCount() < 1)
                    return;

                C1NumericBox numericBox = sender as C1NumericBox;
                if (numericBox != null)
                {
                    for (int i = 0; i < QUALITY_GRID.Rows.Count; i++)
                    {
                        DataTableConverter.SetValue(QUALITY_GRID.Rows[i].DataItem, "CLCTVAL01", numericBox.Value);

                        decimal iUSL = Util.NVC_Decimal(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "USL"));
                        decimal iLSL = Util.NVC_Decimal(DataTableConverter.GetValue(QUALITY_GRID.Rows[i].DataItem, "LSL"));

                        if (iLSL == 0 && iUSL == 0)
                            continue;

                        if (QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter != null)
                        {
                            if (iLSL > Util.NVC_Decimal(numericBox.Value) || (iUSL >  0 && iUSL < Util.NVC_Decimal(numericBox.Value)))
                            {
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.Background = new SolidColorBrush(Colors.Red);
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.Foreground = new SolidColorBrush(Colors.White);
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.Background = new SolidColorBrush(Colors.White);
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                QUALITY_GRID.GetCell(i, QUALITY_GRID.Columns["CLCTVAL01"].Index).Presenter.FontWeight = FontWeights.Normal;
                            }
                        }
                    }
                    isChangeQuality = true;
                    numericBox.Value = 0;
                }
            }
        }

        protected virtual void OnKeyLostMesualQty(object sender, System.Windows.RoutedEventArgs e)
        {
            C1NumericBox numericBox = sender as C1NumericBox;

            if (numericBox != null)
                if (numericBox.Value > 0)
                    OnKeyDownMesualQty(numericBox, new KeyEventArgs(Keyboard.PrimaryDevice, Keyboard.PrimaryDevice.ActiveSource, 0, Key.Enter));
        }

        protected virtual void OnKeyDownOutputQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                if (txtInputQty.Value <= 0)
                {
                    Util.MessageValidation("SFU1611");  //생산량을 확인하십시오.
                    txtInputQty.Value = 0;
                    txtInputQty.Focus();
                    return;
                }
                txtGoodQty.Value = txtInputQty.Value - txtLossQty.Value;
                SetInputQty();
            }
        }

        protected virtual void OnKeyDownInOutQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                C1NumericBox numericBox = sender as C1NumericBox;

                // SRS 수량입력 시 10000단위 밑으로 입력 가능하게 요청[2017-11-28]
                if ((txtSrs1Qty.Value + txtSrs2Qty.Value + txtSrs3Qty.Value) >= 10000)
                {
                    Util.MessageInfoAutoClosing("SFU4304"); //SRS코터 공정에서 IN/MID/OUT수량의 합이 10000을 초과할 수 없습니다.
                    numericBox.Value = 0;
                    e.Handled = true;
                    return;
                }

                if (numericBox.Value > 0)
                {
                    txtInputQty.Value = txtSrs1Qty.Value + txtSrs2Qty.Value + txtSrs3Qty.Value;
                    OnKeyDownInputQty(txtInputQty, e);
                }
            }
        }

        private void OnKeyLostFocusInOutQty(object sender, System.Windows.RoutedEventArgs e)
        {
            C1NumericBox numericBox = sender as C1NumericBox;

            // SRS 수량입력 시 10000단위 밑으로 입력 가능하게 요청[2017-11-28]
            if ((txtSrs1Qty.Value + txtSrs2Qty.Value + txtSrs3Qty.Value) >= 10000)
            {
                Util.MessageInfoAutoClosing("SFU4304"); //SRS코터 공정에서 IN/MID/OUT수량의 합이 10000을 초과할 수 없습니다.
                numericBox.Value = 0;
                e.Handled = true;
                return;
            }

            if (numericBox.Value > 0)
            {
                txtInputQty.Value = txtSrs1Qty.Value + txtSrs2Qty.Value + txtSrs3Qty.Value;
                OnKeyDownInputQty(txtInputQty, new KeyEventArgs(Keyboard.PrimaryDevice, Keyboard.PrimaryDevice.ActiveSource, 0, Key.Enter));
            }
        }

        protected virtual void OnKeyDownGoodQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                if (string.IsNullOrEmpty(txtVersion.Text) || string.IsNullOrEmpty(txtLaneQty.Value.ToString()) || string.IsNullOrEmpty(txtLanePatternQty.Value.ToString()))
                {
                    Util.MessageValidation("SFU1563");  //버전 정보를 지정하세요.
                    txtGoodQty.Value = 0;
                    return;
                }

                if (txtGoodQty.Value <= 0)
                {
                    Util.MessageValidation("SFU1611");  //생산량을 확인하십시오.
                    txtGoodQty.Value = 0;
                    txtGoodQty.Focus();
                    return;
                }
                txtInputQty.Value = txtGoodQty.Value + txtLossQty.Value;
                SetGoodQty();
            }
        }

        protected virtual void OnKeyDownLaneQty(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                if (LOTINFO_GRID.GetRowCount() > 0)
                {
                    if(Util.NVC_Decimal(_LANEQTY) != Util.NVC_Decimal(txtLaneQty.Value))
                    {
                        if (WIPREASON_GRID.Rows.Count > 0)
                            SaveDefect(WIPREASON_GRID);

                        if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Rows.Count > 0)
                            SaveDefect(WIPREASON2_GRID);

                        _LANEQTY = Util.NVC(txtLaneQty.Value);

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY", txtLaneQty.Value);

                        GetSumDefectQty();
                    }
                }
            }
        }

        protected virtual void OnKeyLostFocusLaneQty(object sender, RoutedEventArgs e)
        {
            if (LOTINFO_GRID.GetRowCount() > 0)
            {
                if (Util.NVC_Decimal(_LANEQTY) != Util.NVC_Decimal(txtLaneQty.Value))
                {
                    if (WIPREASON_GRID.Rows.Count > 0)
                        SaveDefect(WIPREASON_GRID);

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Rows.Count > 0)
                        SaveDefect(WIPREASON2_GRID);

                    _LANEQTY = Util.NVC(txtLaneQty.Value);

                    for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY", txtLaneQty.Value);

                    GetSumDefectQty();
                }
            }
        }

        protected virtual void OnClickVersion(object sender, EventArgs e)
        {
            CMM_ELECRECIPE wndPopup = new CMM_ELECRECIPE();
            wndPopup.FrameOperation = this.FrameOperation;

            if (wndPopup != null && PRODLOT_GRID.SelectedIndex > -1 && (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count)
            {
                object[] Parameters = new object[5];
                Parameters[0] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Parameters[1] = procId;
                Parameters[2] = LoginInfo.CFG_AREA_ID;
                Parameters[3] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[4] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "LOTID"));
                C1WindowExtension.SetParameters(wndPopup, Parameters);

                wndPopup.Closed += new EventHandler(OnCloseVersion);
                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        protected virtual void OnCloseVersion(object sender, EventArgs e)
        {
            CMM_ELECRECIPE window = sender as CMM_ELECRECIPE;

            if (window.DialogResult == MessageBoxResult.OK)
            {
                if (Util.NVC_Decimal(txtLaneQty.Value) != Util.NVC_Decimal(window._ReturnLaneQty))
                {
                    txtVersion.Text = window._ReturnRecipeNo;
                    txtLaneQty.Value = Convert.ToDouble(window._ReturnLaneQty);
                    txtLanePatternQty.Value = Convert.ToDouble(window._ReturnPtnQty);

                    if (WIPREASON_GRID.Rows.Count > 0)
                        SaveDefect(WIPREASON_GRID);

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Rows.Count > 0)
                        SaveDefect(WIPREASON2_GRID);

                    _LANEQTY = Util.NVC(txtLaneQty.Value);
                }
                else
                {
                    txtVersion.Text = window._ReturnRecipeNo;
                    txtLaneQty.Value = Convert.ToDouble(window._ReturnLaneQty);
                    txtLanePatternQty.Value = Convert.ToDouble(window._ReturnPtnQty);
                }

                if (LOTINFO_GRID.GetRowCount() > 0)
                {
                    for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                    {
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY", txtLaneQty.Value);
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_PTN_QTY", txtLanePatternQty.Value);
                    }
                }
                GetSumDefectQty();
            }
        }

        protected virtual void OnClickShift(object sender, EventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");
                return;
            }

            CMM_SHIFT_USER2 wndPopup = new CMM_SHIFT_USER2();
            wndPopup.FrameOperation = this.FrameOperation;

            if (wndPopup != null)
            {
                object[] Parameters = new object[8];
                Parameters[0] = LoginInfo.CFG_SHOP_ID;
                Parameters[1] = LoginInfo.CFG_AREA_ID;
                Parameters[2] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[3] = procId;
                Parameters[4] = Util.NVC(txtShift.Tag);
                Parameters[5] = Util.NVC(txtWorker.Tag);
                Parameters[6] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[7] = "Y"; // 저장 플로그 "Y" 일때만 저장.
                C1WindowExtension.SetParameters(wndPopup, Parameters);

                wndPopup.Closed += new EventHandler(OnCloseShift);
                this.Dispatcher.BeginInvoke(new Action(() => wndPopup.ShowModal()));
            }
        }

        protected virtual void OnCloseShift(object sender, EventArgs e)
        {
            CMM_SHIFT_USER2 wndPopup = sender as CMM_SHIFT_USER2;

            if (wndPopup.DialogResult == MessageBoxResult.OK)
            {
                txtShift.Text = Util.NVC(wndPopup.SHIFTNAME);
                txtShift.Tag = Util.NVC(wndPopup.SHIFTCODE);
                txtWorker.Text = Util.NVC(wndPopup.USERNAME);
                txtWorker.Tag = Util.NVC(wndPopup.USERID);
                txtShiftDateTime.Text = Util.NVC(wndPopup.WRKSTRTTIME) + " ~ " + Util.NVC(wndPopup.WRKENDTTIME);
                txtShiftStartTime.Text = Util.NVC(wndPopup.WRKSTRTTIME);
                txtShiftEndTime.Text = Util.NVC(wndPopup.WRKENDTTIME);
            }
        }
        protected virtual void OnClickBatchId(object sender, EventArgs e)
        {
            CMM_SRSTANK _Tank = new CMM_SRSTANK();
            _Tank.FrameOperation = FrameOperation;

            if (_Tank != null)
            {
                object[] Parameters = new object[1];
                Parameters[0] = Util.NVC(EQUIPMENT_COMBO.SelectedValue.ToString());
                C1WindowExtension.SetParameters(_Tank, Parameters);

                _Tank.Closed += new EventHandler(OnCloseBatchId);
                _Tank.ShowModal();
                _Tank.CenterOnScreen();
            }
        }

        protected virtual void OnCloseBatchId(object sender, EventArgs e)
        {
            CMM_SRSTANK window = sender as CMM_SRSTANK;

            if (window.DialogResult == MessageBoxResult.OK)
            {
                txtTank.Text = window._ReturnTankName;
                txtTank.Tag = window._ReturnTank;
                txtBatchId.Text = window._ReturnLotID;
            }
        }

        protected virtual void OnClickSaveColorTag(object sender, EventArgs e)
        {
            string status = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK")].DataItem, "WIPSTAT"));

            if (status.Equals(Wip_State.PROC) || status.Equals(Wip_State.EQPT_END))
            {
                SaveQuality(COLOR_GRID);
                isChangeColorTag = false;
            }
        }

        protected virtual void OnClickSaveDefectTag(object sender, EventArgs e)
        {
            if (LOTINFO_GRID.GetRowCount() < 1 || DEFECT_TAG_GRID.Rows.Count == 0)
                return;

            SaveQuality(DEFECT_TAG_GRID);
            isChagneDefectTag = false;
        }

        // FOIL ACTIVE CORE 한 쪽만 표시하기 위하여 설정 [ 2017-02-14 ]
        protected virtual void OnCheckFoilChecked(object sender, EventArgs e)
        {
            RadioButton radBtn = sender as RadioButton;

            if (radBtn != null)
            {
                if (EQUIPMENT_COMBO.SelectedIndex < 1)
                {
                    radBtn.IsChecked = false;
                    return;
                }

                Grid grid = null;
                if (string.Equals(radBtn.Name, "radFoil1"))
                    grid = txtCore2.Parent as Grid;
                else if (string.Equals(radBtn.Name, "radFoil2"))
                    grid = txtCore1.Parent as Grid;

                if (grid == null)
                    return;

                RadioButton unFoilBtn = grid.Children[grid.Children.Count - 1] as RadioButton;

                if (unFoilBtn != null)
                    unFoilBtn.IsChecked = false;
            }
        }

        // SLURRY 장착 팝업 화면 호출 [ 2017-01-12 ]
        protected virtual void OnClickSlurryOpen(object sender, EventArgs e)
        {
            string sWOID = string.Empty;
            string sLLType = string.Empty;
            string sLLTypeNAME = string.Empty;
            string sPLType = string.Empty;
            string sPLTypeNAME = string.Empty;

            if ((((Button)sender).Name == "btnSlurry11" || ((Button)sender).Name == "btnSlurry22") && !isEQPTDoubleLayer)
            {
                Util.MessageValidation("SFU2094");  //해당 설비는 더블레이어 설비가 아닙니다. 설비 투입 위치 확인바랍니다.
                return;
            }

            UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;

            int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");

            if (idx > -1 && string.Equals(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "EIO_WO_SEL_STAT"), "Y"))
                sWOID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "WOID"));

            if (string.IsNullOrEmpty(sWOID))
            {
                Util.MessageValidation("SFU1635");  //선택된 W/O가 없습니다.
                return;
            }

            ///////////////////////////////////////////////////////
            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
            //대LOT LOTTYPE 
            /*
            UcProdLot ProdLot = grdProdLot.Children[0] as UcProdLot;

            int idx_LL = new Util().GetDataGridCheckFirstRowIndex(ProdLot.dgLargeLot, "CHK");

            if (idx_LL > -1 && Util.NVC(DataTableConverter.GetValue(ProdLot.dgLargeLot.Rows[idx_LL].DataItem, "CHK")).Equals("1"))
            {
                sLLType = Util.NVC(DataTableConverter.GetValue(ProdLot.dgLargeLot.Rows[idx_LL].DataItem, "LOTTYPE"));
                sLLTypeNAME = Util.NVC(DataTableConverter.GetValue(ProdLot.dgLargeLot.Rows[idx_LL].DataItem, "LOTYNAME"));
            }

            //생산LOT LOTTYPE 
            int idx_PL = new Util().GetDataGridCheckFirstRowIndex(ProdLot.dgProductLot, "CHK");

            if (idx_PL > -1 && Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx_PL].DataItem, "CHK")).Equals("1"))
            {
                sPLType = Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx_PL].DataItem, "LOTTYPE"));
                sPLTypeNAME = Util.NVC(DataTableConverter.GetValue(ProdLot.dgProductLot.Rows[idx_PL].DataItem, "LOTYNAME"));
            }
            */
            ///////////////////////////////////////////////////////

            CMM_ELEC_SLURRY popup = new CMM_ELEC_SLURRY();
            popup.FrameOperation = FrameOperation;

            if (EQUIPMENT_COMBO.SelectedIndex > 0 && !string.IsNullOrEmpty(sWOID))
            {
                int iPosition = 0;
                string sSlurryId = "";

                if (((Button)sender).Name == "btnSlurry1")
                {
                    iPosition = 0;
                    sSlurryId = txtSlurry1.Text;
                }
                else if (((Button)sender).Name == "btnSlurry2")
                {
                    iPosition = 1;
                    sSlurryId = txtSlurry2.Text;
                }
                else if (((Button)sender).Name == "btnSlurry11")
                {
                    iPosition = 2;
                    sSlurryId = txtSlurry11.Text;
                }
                else if (((Button)sender).Name == "btnSlurry22")
                {
                    iPosition = 3;
                    sSlurryId = txtSlurry22.Text;
                }

                object[] Parameters = new object[8];
                Parameters[0] = procId;
                Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[2] = Util.NVC(sWOID);
                Parameters[3] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[4] = iPosition;
                Parameters[5] = sSlurryId;
                Parameters[6] = isSingleCoater == true ? "Y" : "N";
                Parameters[7] = Util.NVC(DataTableConverter.GetValue(EQUIPMENT_COMBO.SelectedItem, "WIDE_ROLL_FLAG"));
                //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                //Type코드와 명칭
                //Parameters[8] = Util.NVC(sPLType) != string.Empty ? Util.NVC(sPLType) : Util.NVC(sLLType);
                //Parameters[9] = Util.NVC(sPLType) != string.Empty ? Util.NVC(sPLTypeNAME) : Util.NVC(sLLTypeNAME);

                C1WindowExtension.SetParameters(popup, Parameters);

                popup.Closed += new EventHandler(OnClickSlurryClose);
                Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                popup.CenterOnScreen();
            }
        }

        protected void OnClickSlurryClose(object sender, EventArgs e)
        {
            CMM_ELEC_SLURRY popup = sender as CMM_ELEC_SLURRY;
            Button btn = sender as Button;

            if (popup.DialogResult == MessageBoxResult.OK)
            {
                if (popup._ReturnPosition == 0)
                {
                    txtSlurry1.Text = popup._ReturnLotID;
                    txtSlurry1.Tag = popup._ReturnPRODID;

                    if (popup._IsAllConfirm == true)
                    {
                        txtSlurry2.Text = popup._ReturnLotID;
                        txtSlurry2.Tag = popup._ReturnPRODID;
                    }
                }
                else if (popup._ReturnPosition == 1)
                {
                    txtSlurry2.Text = popup._ReturnLotID;
                    txtSlurry2.Tag = popup._ReturnPRODID;

                    if (popup._IsAllConfirm == true)
                    {
                        txtSlurry1.Text = popup._ReturnLotID;
                        txtSlurry1.Tag = popup._ReturnPRODID;
                    }
                }
                else if (popup._ReturnPosition == 2)
                {
                    txtSlurry11.Text = popup._ReturnLotID;
                    txtSlurry11.Tag = popup._ReturnPRODID;

                    if (popup._IsAllConfirm == true)
                    {
                        txtSlurry22.Text = popup._ReturnLotID;
                        txtSlurry22.Tag = popup._ReturnPRODID;
                    }
                }
                else if (popup._ReturnPosition == 3)
                {
                    txtSlurry22.Text = popup._ReturnLotID;
                    txtSlurry22.Tag = popup._ReturnPRODID;

                    if (popup._IsAllConfirm == true)
                    {
                        txtSlurry11.Text = popup._ReturnLotID;
                        txtSlurry11.Tag = popup._ReturnPRODID;
                    }
                }

                // Slurry만 장착 처리
                if (popup._IsAllConfirm == true)
                {
                    if (popup._ReturnPosition == 0 || popup._ReturnPosition == 1)
                    {
                        SaveMountChange(false, popup._IsSlurryTerm, false, true, true, true, true, false, false);
                    }
                    else if (popup._ReturnPosition == 2 || popup._ReturnPosition == 3)
                    {
                        SaveMountChange(false, popup._IsSlurryTerm, false, false, false, true, true, true, true);
                    }
                }
                else
                {
                    SaveMountChange(false, popup._IsSlurryTerm, false, popup._ReturnPosition == 0 ? true : false, popup._ReturnPosition == 1 ? true : false, true, true, popup._ReturnPosition == 2 ? true : false, popup._ReturnPosition == 3 ? true : false);
                }

                    // CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                    // Slurry LotType
                    //_sLotType = popup._ReturnSLotType;
                    //_sLotTypeName = popup._sReturnSLotTypeName;
            }
        }

        protected virtual void OnClickTopLotOpen(object sender, EventArgs e)
        {
            string sWOID = string.Empty;

            UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;

            int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");

            if (idx > -1 && string.Equals(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "EIO_WO_SEL_STAT"), "Y"))
                sWOID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "WOID"));

            if (string.IsNullOrEmpty(sWOID))
            {
                Util.MessageValidation("SFU1635");  //선택된 W/O가 없습니다.
                return;
            }

            CMM_ELEC_TOPLOT popup = new CMM_ELEC_TOPLOT();
            popup.FrameOperation = FrameOperation;
            
            if (EQUIPMENT_COMBO.SelectedIndex > 0 && !string.IsNullOrEmpty(sWOID))
            {
                object[] Parameters = new object[5];
                Parameters[0] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[1] = procId;
                Parameters[2] = Util.NVC(sWOID);
                Parameters[3] = ((Button)sender).Name == "btnFoil1" ? 0 : 1;
                Parameters[4] = ((Button)sender).Name == "btnFoil1" ? txtCore1.Text : txtCore2.Text;

                C1WindowExtension.SetParameters(popup, Parameters);

                popup.Closed += new EventHandler(OnClickTopLotClose);
                Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                popup.CenterOnScreen();
            }
        }

        protected void OnClickTopLotClose(object sender, EventArgs e)
        {
            CMM_ELEC_TOPLOT popup = sender as CMM_ELEC_TOPLOT;
            Button btn = sender as Button;

            if (popup.DialogResult == MessageBoxResult.OK)
            {
                Grid grid = null;
                if (popup._ReturnPosition == 0)
                {
                    txtCore1.Text = popup._ReturnLotID;
                    grid = txtCore1.Parent as Grid;
                }
                else
                {
                    txtCore2.Text = popup._ReturnLotID;
                    grid = txtCore2.Parent as Grid;
                }

                // 자동선택처리
                if (grid != null)
                    ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked = true;

                // 자동탈착처리
                if ( string.Equals(txtCore1.Text, txtCore2.Text))
                    SetUnMountCore(popup._ReturnPosition);

                //SaveMountChange(true, false, popup._IsCoreTerm, false, false, popup._ReturnPosition == 0 ? true : false, popup._ReturnPosition == 1 ? true : false);
                SaveMountChange(true, false, popup._IsCoreTerm, false, false);
            }
        }

        protected virtual void OnClickMtrlChange(object sender, EventArgs e)
        {
            string sWOID = WO_DETL_ID;

            if (string.IsNullOrEmpty(WO_DETL_ID))
            {
                UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;
                int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");
                sWOID = idx > -1 ? Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "WO_DETL_ID")) : string.Empty;
            }

            if (EQUIPMENT_COMBO.SelectedIndex > 0 && !string.IsNullOrEmpty(sWOID))
            {
                SetMountChange();
            }
        }

        protected virtual void OnClickMtrlChange2(object sender, EventArgs e)
        {
            //return; // 개발중.

            string sWOID = string.Empty;

            UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;

            int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");

            if (idx > -1 && string.Equals(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "EIO_WO_SEL_STAT"), "Y"))
                sWOID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "WO_DETL_ID"));

            //if (string.IsNullOrEmpty(sWOID))
            //{
            //    Util.MessageValidation("SFU1635");  //선택된 W/O가 없습니다.
            //    return;
            //}

            CMM_ELEC_SLURRY_TERM popup = new CMM_ELEC_SLURRY_TERM();
            popup.FrameOperation = FrameOperation;

            if (EQUIPMENT_COMBO.SelectedIndex > 0) //&& !string.IsNullOrEmpty(sWOID)
            {
                object[] Parameters = new object[7];
                Parameters[0] = procId;
                Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[2] = Util.NVC(sWOID);
                Parameters[3] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                Parameters[4] = ((Button)sender).Name == "btnSlurry1" ? 0 : 1;
                Parameters[5] = ((Button)sender).Name == "btnSlurry1" ? txtSlurry1.Text : txtSlurry2.Text;
                Parameters[6] = isSingleCoater == true ? "Y" : "N";

                C1WindowExtension.SetParameters(popup, Parameters);

                popup.Closed += new EventHandler(OnClickMtrlChange2Close);
                Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                popup.CenterOnScreen();
            }
        }

        protected void OnClickMtrlChange2Close(object sender, EventArgs e)
        {
            CMM_ELEC_SLURRY_TERM popup = sender as CMM_ELEC_SLURRY_TERM;
            Button btn = sender as Button;
            if (popup.DialogResult == MessageBoxResult.OK)
            {
                if (isSingleCoater)
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));
                else
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), "");
            }
        }

        protected void OnClickShipmentModel(object sender, EventArgs e)
        {
            //if (EQUIPMENT_COMBO.SelectedIndex < 1)
            //{
            //    Util.MessageValidation("SFU1673");  //설비를 선택하세요.
            //    return;
            //}

            CMM_ELEC_SHIPMENTMODEL popup = new CMM_ELEC_SHIPMENTMODEL();
            popup.FrameOperation = FrameOperation;

            //if (EQUIPMENT_COMBO.SelectedIndex > 0) //&& !string.IsNullOrEmpty(sWOID)
            {
                object[] Parameters = new object[1];
                Parameters[0] = procId;
                
                C1WindowExtension.SetParameters(popup, Parameters);
                
                Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                popup.CenterOnScreen();
            }
        }

        protected virtual void OnClickWorkHalfSlitSide(object sender, RoutedEventArgs e)
        {
            if (EQUIPMENT_COMBO.SelectedIndex < 1)
            {
                Util.MessageValidation("SFU1673");  //설비를 선택하세요.
                return;
            }

            CMM_ELEC_WORK_HALF_SLITTING popupWorkHalfSlitting = new CMM_ELEC_WORK_HALF_SLITTING();
            popupWorkHalfSlitting.FrameOperation = FrameOperation;
            (grdCommand.Children[0] as UcCommand).btnExtra.IsDropDownOpen = false;

            object[] parameters = new object[2];
            parameters[0] = EQUIPMENT_COMBO.SelectedValue.ToString();
            parameters[1] = (grdSearch.Children[0] as UcSearch).txtWorkHalfSlittingSide.Tag;   // 무지부 방향
            C1WindowExtension.SetParameters(popupWorkHalfSlitting, parameters);

            popupWorkHalfSlitting.Closed += popupWorkHalfSlitting_Closed;
            this.Dispatcher.BeginInvoke(new Action(() => popupWorkHalfSlitting.ShowModal()));

        }

        private void popupWorkHalfSlitting_Closed(object sender, EventArgs e)
        {
            CMM_ELEC_WORK_HALF_SLITTING window = sender as CMM_ELEC_WORK_HALF_SLITTING;
            if (window.DialogResult == MessageBoxResult.OK)
            {
                GetWorkHalfSlittingSide();
            }
        }

        private void GetWorkHalfSlittingSide()
        {
            try
            {
                const string bizRuleName = "DA_PRD_SEL_WRK_HALF_SLIT_SIDE";

                DataTable inDataTable = new DataTable("INDATA");
                inDataTable.Columns.Add("LANGID", typeof(string));
                inDataTable.Columns.Add("EQPTID", typeof(string));
                DataRow dr = inDataTable.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["EQPTID"] = EQUIPMENT_COMBO.SelectedValue;
                inDataTable.Rows.Add(dr);

                new ClientProxy().ExecuteService(bizRuleName, "RQSTDT", "RSLTDT", inDataTable, (bizResult, bizException) =>
                {
                    if (bizException != null)
                    {
                        Util.MessageException(bizException);
                        return;
                    }

                    if (CommonVerify.HasTableRow(bizResult))
                    {
                        (grdSearch.Children[0] as UcSearch).txtWorkHalfSlittingSide.Text = bizResult.Rows[0]["WRK_HALF_SLIT_SIDE_NAME"].GetString();
                        (grdSearch.Children[0] as UcSearch).txtWorkHalfSlittingSide.Tag = bizResult.Rows[0]["WRK_HALF_SLIT_SIDE"].GetString();
                    }
                });

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }
        #endregion Events

        #region Methods

        private void SetIdentInfo()
        {
            try
            {
                if (EQUIPMENTSEGMENT_COMBO.SelectedIndex < 0 || EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString().Trim().Equals("SELECT"))
                {
                    _LDR_LOT_IDENT_BAS_CODE = string.Empty;
                    _UNLDR_LOT_IDENT_BAS_CODE = string.Empty;

                    (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["CSTID"].Visibility = Visibility.Collapsed;
                    (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["OUT_CSTID"].Visibility = Visibility.Collapsed;

                    (grdResult.Children[0] as UcResult).dgLotInfo.Columns["CSTID"].Visibility = Visibility.Collapsed;
                    (grdResult.Children[0] as UcResult).dgLotInfo.Columns["OUT_CSTID"].Visibility = Visibility.Collapsed;

                    return;
                }

                DataTable dt = new DataTable("INDATA");
                dt.Columns.Add("LANGID", typeof(string));
                dt.Columns.Add("PROCID", typeof(string));
                dt.Columns.Add("EQSGID", typeof(string));

                DataRow row = dt.NewRow();
                row["LANGID"] = LoginInfo.LANGID;
                row["PROCID"] = PROCID;
                row["EQSGID"] = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_EQP_SEL_LOT_IDENT_BAS_CODE", "INDATA", "RSLTDT", dt);

                if (result.Rows.Count > 0)
                {
                    _LDR_LOT_IDENT_BAS_CODE = result.Rows[0]["LDR_LOT_IDENT_BAS_CODE"].ToString();
                    _UNLDR_LOT_IDENT_BAS_CODE = result.Rows[0]["UNLDR_LOT_IDENT_BAS_CODE"].ToString();

                    switch (_LDR_LOT_IDENT_BAS_CODE)
                    {
                        case "CST_ID":
                        case "RF_ID":
                            (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["CSTID"].Visibility = Visibility.Visible;
                            (grdResult.Children[0] as UcResult).dgLotInfo.Columns["CSTID"].Visibility = Visibility.Visible;
                            break;
                        default:
                            (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["CSTID"].Visibility = Visibility.Collapsed;
                            (grdResult.Children[0] as UcResult).dgLotInfo.Columns["CSTID"].Visibility = Visibility.Collapsed;
                            break;
                    }

                    switch (_UNLDR_LOT_IDENT_BAS_CODE)
                    {
                        case "CST_ID":
                        case "RF_ID":
                            (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["OUT_CSTID"].Visibility = Visibility.Visible;
                            (grdResult.Children[0] as UcResult).dgLotInfo.Columns["OUT_CSTID"].Visibility = Visibility.Visible;

                            if (string.Equals(procId, Process.COATING))
                            {
                                (grdResult.Children[0] as UcResult).dgLotInfo.Columns["OUT_CSTID"].IsReadOnly = false;
                                (grdResult.Children[0] as UcResult).btnSaveCarrier.Visibility = Visibility.Visible;
                            }

                            break;
                        default:
                            (grdProdLot.Children[0] as UcProdLot).dgProductLot.Columns["OUT_CSTID"].Visibility = Visibility.Collapsed;
                            (grdResult.Children[0] as UcResult).dgLotInfo.Columns["OUT_CSTID"].Visibility = Visibility.Collapsed;
                            break;
                    }
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void SetRollMapEquipment()
        {
            isRollMapResultLink = IsRollMapResultApply();
            isRollMapEquipment = IsEquipmentAttr(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
            isRollMapMixCotLinkSite = IsMixCotLinkedAdvanceSite();
            isOriginRollMapEquipment = isRollMapEquipment;
     
            // # Roll Map 대상설비에 따른 컨트롤 정의
            VisibleRollMapMode();

            // 롤맵 설비는 롤 방향 Tab 안보이도록 해달라는 요청 반영 [2021-10-18]
            if (isRollMapEquipment)
                (grdDataCollect.Children[0] as UcDataCollect).tiRollDirection.Visibility = Visibility.Collapsed;
            else
                (grdDataCollect.Children[0] as UcDataCollect).tiRollDirection.Visibility = Visibility.Visible;

            //nathan 2023.12.13 롤맵 코터 수불 실적 적용 start
            setRollmapResultLinkBtn();

            // TEST CUT 사용 사이트만 TEST CUT Tab 보이도록 함

            _isTestCutApply = true;

            bool bTestCutUse = IsCommoncodeUse("TEST_CUT_HIST_AREA", LoginInfo.CFG_AREA_ID);

            if (bTestCutUse && string.Equals(procId, Process.COATING))  //nathan 2024.03.26 4분할 화면 코터공정 테스트컷 사용시 입력여부 체크
                (grdDataCollect.Children[0] as UcDataCollect).tiTestcut.Visibility = Visibility.Visible;
            else
                (grdDataCollect.Children[0] as UcDataCollect).tiTestcut.Visibility = Visibility.Collapsed;

            //nathan 2023.12.13 롤맵 코터 수불 실적 적용 end

        }

        private void VisibleRollMapMode()
        {
            (grdCommand.Children[0] as UcCommand).btnSlurryManualOutput.Visibility = Visibility.Collapsed;
            (grdCommand.Children[0] as UcCommand).btnSlurryManualInput.Visibility = Visibility.Collapsed;
            (grdCommand.Children[0] as UcCommand).btnSlurryBufferManualInit.Visibility = Visibility.Collapsed;

            if (isRollMapEquipment)
            {
                (grdSearch.Children[0] as UcSearch).btnRollMap.Visibility = Visibility.Visible;

                if (string.Equals(procId, Process.COATING))
                {
                    (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["REMAIN_QTY"].Visibility = Visibility.Collapsed;  // 숨김처리 06.06
                    (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["STRT_PSTN"].Visibility = Visibility.Collapsed;   // 숨김처리 06.06
                    (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["END_PSTN"].Visibility = Visibility.Collapsed;    // 숨김처리 06.06
                    (grdDataCollect.Children[0] as UcDataCollect).tiInputMaterialHistory.Visibility = Visibility.Collapsed;

                    (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial.Visibility = Visibility.Collapsed;
                    (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial.Visibility = Visibility.Collapsed;
                    (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial.Visibility = Visibility.Collapsed;
                    (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.IsReadOnly = true;
                    (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["CHK"].Visibility = Visibility.Collapsed;

                    (grdCommand.Children[0] as UcCommand).btnRollMapInputMaterial.Visibility = Visibility.Visible; // 2021.08.10 Visible 처리

                    if (isRollMapMixCotLinkSite) // 2024.03.22 믹서코터배치연계고도화
                    {
                        (grdCommand.Children[0] as UcCommand).btnSlurryManualOutput.Visibility = Visibility.Visible;
                        (grdCommand.Children[0] as UcCommand).btnSlurryManualInput.Visibility = Visibility.Visible;
                        (grdCommand.Children[0] as UcCommand).btnSlurryBufferManualInit.Visibility = Visibility.Visible;
                    }
                }
                else if (string.Equals(procId, Process.ROLL_PRESSING))
                {
                    (grdDataCollect.Children[0] as UcDataCollect).tiInputMaterialHistory.Visibility = Visibility.Visible;
                }
            }
            else
            {
                (grdSearch.Children[0] as UcSearch).btnRollMap.Visibility = Visibility.Collapsed;

                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["REMAIN_QTY"].Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["STRT_PSTN"].Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["END_PSTN"].Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.IsReadOnly = false;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Columns["CHK"].Visibility = Visibility.Visible;

                (grdDataCollect.Children[0] as UcDataCollect).tiInputMaterialHistory.Visibility = Visibility.Collapsed;
            }
        }

        #region [Pilot Mode]
        private void HidePilotProdMode()
        {
            this.Dispatcher.BeginInvoke(new Action(() =>
            {
                (grdCommand.Children[0] as UcCommand).grdPilotProd.Visibility = Visibility.Collapsed;
                //ColorAnimationInredRectangle(recPilotProdMode);
            }));
        }

        private void ShowPilotProdMode()
        {
            this.Dispatcher.BeginInvoke(new Action(() =>
            {
                (grdCommand.Children[0] as UcCommand).grdPilotProd.Visibility = Visibility.Visible;
                ColorAnimationInredRectangle((grdCommand.Children[0] as UcCommand).recPilotProdMode);
            }));
        }

        private void ColorAnimationInredRectangle(System.Windows.Shapes.Rectangle rect)
        {
            if(this.FindName("redBrush") == null)
            {
                this.RegisterName("redBrush", redBrush);
            }
            rect.Fill = redBrush;

            DoubleAnimation opacityAnimation = new DoubleAnimation();
            opacityAnimation.From = 1.0;
            opacityAnimation.To = 0.0;
            opacityAnimation.Duration = TimeSpan.FromSeconds(0.8);
            opacityAnimation.AutoReverse = true;
            opacityAnimation.RepeatBehavior = RepeatBehavior.Forever;
            Storyboard.SetTargetName(opacityAnimation, "redBrush");
            Storyboard.SetTargetProperty(
                opacityAnimation, new PropertyPath(SolidColorBrush.OpacityProperty));
            Storyboard mouseLeftButtonDownStoryboard = new Storyboard();
            mouseLeftButtonDownStoryboard.Children.Add(opacityAnimation);

            mouseLeftButtonDownStoryboard.Begin(this);
        }

        private void OnClickPilotProdMode_Click(object sender, RoutedEventArgs e)
        {
            if (!CanPilotProdMode()) return;

            string sMsg = string.Empty;
            bool bMode = GetPilotProdMode();

            if (bMode)
                sMsg = "SFU2875";
            else
                sMsg = "SFU2875";

            Util.MessageConfirm(sMsg, (result) =>
            {
                if (result == MessageBoxResult.OK)
                {
                    SetPilotProdMode(!bMode);
                    GetPilotProdMode();

                    this.Dispatcher.BeginInvoke(new Action(() => OnClickSearch(null, null)));
                }
            });
        }

        private bool CanPilotProdMode()
        {
            bool bRet = false;

            if (EQUIPMENTSEGMENT_COMBO.SelectedIndex < 0 || EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString().Trim().Equals("SELECT"))
            {
                //Util.Alert("라인을 선택 하세요.");
                Util.MessageValidation("SFU1223");
                return bRet;
            }

            if (EQUIPMENT_COMBO.SelectedIndex < 0 || EQUIPMENT_COMBO.SelectedValue.ToString().Trim().Equals("SELECT"))
            {
                //Util.Alert("설비를 선택 하세요.");
                Util.MessageValidation("SFU1673");
                return bRet;
            }

            //string sProcLotID = string.Empty;
            //if (CheckProcWip(out sProcLotID))
            //{
            //    Util.MessageValidation("SFU3199", sProcLotID); // 진행중인 LOT이 있습니다. LOT ID : {% 1}
            //    return bRet;
            //}

            bRet = true;
            return bRet;
        }

        private bool GetPilotProdMode()
        {
            try
            {
                bool bRet = false;

                if (EQUIPMENT_COMBO == null || EQUIPMENT_COMBO.SelectedIndex < 0 || Util.NVC(EQUIPMENT_COMBO.SelectedValue).Trim().Equals("SELECT"))
                {
                    HidePilotProdMode();
                    return bRet;
                }

                DataTable inTable = new DataTable();
                inTable.Columns.Add("EQPTID", typeof(string));

                DataRow dr = inTable.NewRow();
                dr["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);

                inTable.Rows.Add(dr);

                DataTable dtRslt = new ClientProxy().ExecuteServiceSync("DA_EQP_SEL_UI_TESTMODE_INFO", "INDATA", "OUTDATA", inTable);

                if (dtRslt != null && dtRslt.Rows.Count > 0 && dtRslt.Columns.Contains("PILOT_PROD_MODE"))
                {
                    if (Util.NVC(dtRslt.Rows[0]["PILOT_PROD_MODE"]).Equals("Y"))
                    {
                        ShowPilotProdMode();
                        bRet = true;
                    }
                    else
                    {
                        HidePilotProdMode();
                    }
                }

                return bRet;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        private bool SetPilotProdMode(bool bMode)
        {
            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("SRCTYPE", typeof(string));
                inTable.Columns.Add("IFMODE", typeof(string));
                inTable.Columns.Add("EQPTID", typeof(string));
                inTable.Columns.Add("PILOT_PRDC_MODE", typeof(string));
                inTable.Columns.Add("USERID", typeof(string));

                DataRow newRow = inTable.NewRow();
                newRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                newRow["IFMODE"] = IFMODE.IFMODE_OFF;
                newRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                newRow["PILOT_PRDC_MODE"] = bMode ? "PILOT" : "";
                newRow["USERID"] = LoginInfo.USERID;

                inTable.Rows.Add(newRow);

                DataTable bizResult = new ClientProxy().ExecuteServiceSync("BR_PRD_REG_EIOATTR_PILOT_PRODUCTION_MODE", "INDATA", null, inTable);

                Util.MessageInfo("PSS9097");    // 변경되었습니다.

                return true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }
        #endregion

        void InitControls()
        {
            SetButtons();
            SetCheckBox();

        }

        void SetComboBox()
        {
            EQUIPMENT_COMBO = (grdSearch.Children[0] as UcSearch).cboEquipment;
            EQUIPMENTSEGMENT_COMBO = (grdSearch.Children[0] as UcSearch).cboEquipmentSegment;
            COATTYPE_COMBO = (grdSearch.Children[0] as UcSearch).cboCoatType;
            LANENUM_COMBO = (grdDataCollect.Children[0] as UcDataCollect).cboLaneNum;
            COLOR_COMBO = (grdProdLot.Children[0] as UcProdLot).cboColor;

            CommonCombo _combo = new CommonCombo();

            String[] sFilter = { LoginInfo.CFG_AREA_ID };
            C1ComboBox[] cboLineChild = { EQUIPMENT_COMBO };
            _combo.SetCombo(EQUIPMENTSEGMENT_COMBO, CommonCombo.ComboStatus.SELECT, cbChild: cboLineChild, sFilter: sFilter);

            String[] sFilter2 = { procId.Equals(Process.INS_COATING) ? "E2300,E4500" : procId, isSingleCoater ? "SSC" : (procId.Equals(Process.COATING) ? "DSC" : null) };
            C1ComboBox[] cboEquipmentParent = { EQUIPMENTSEGMENT_COMBO };
            _combo.SetCombo(EQUIPMENT_COMBO, CommonCombo.ComboStatus.SELECT, cbParent: cboEquipmentParent, sFilter: sFilter2);
            
            if (isSingleCoater || procId.Equals(Process.INS_COATING))
            {
                if (procId.Equals(Process.INS_COATING) && LoginInfo.CFG_AREA_ID.Equals("E1"))
                {
                    (grdSearch.Children[0] as UcSearch).rdoTop.Visibility = Visibility.Visible;
                    (grdSearch.Children[0] as UcSearch).rdoBack.Visibility = Visibility.Visible;
                    (grdSearch.Children[0] as UcSearch).cboCoatType.Visibility = Visibility.Collapsed;
                    (grdSearch.Children[0] as UcSearch).rdoTop.IsChecked = true;
                }
                String[] sFilter3 = { "COAT_SIDE_TYPE" };
                _combo.SetCombo(COATTYPE_COMBO, CommonCombo.ComboStatus.NONE, sFilter: sFilter3, sCase: "COMMCODE");
            }
            else
            {
                (grdSearch.Children[0] as UcSearch).spSingleCoater.Visibility = Visibility.Collapsed;
                (grdSearch.Children[0] as UcSearch).cboCoatType.Visibility = Visibility.Collapsed;
            }


            // 2020.06.30 공정 Interlock - 명암 속성에 대한 범레 추가
            COLOR_COMBO.Visibility = Visibility.Collapsed;
            // 슬리터 2차 추가  2021-09-15 by 오화백
            if (procId.Equals(Process.COATING) || procId.Equals(Process.ROLL_PRESSING) || procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.TAPING))
            {
                // 2020.07.06 공정 Interlock - 범례 속성 공통코드로 조회
                SetWipColorLegendCombo();
            }

            if (isRollDirCtn)
                GetRollDir();
        }
        
        void SetButtons()
        {
            //SEARCHBUTTON = (grdCommand.Children[0] as UcSearch).btnSearch;
            STARTBUTTON = (grdCommand.Children[0] as UcCommand).btnStart;
            INVOICEBUTTON = (grdCommand.Children[0] as UcCommand).btnInvoiceMaterial;

            #region [Cancel Delete Lot]
            CANCELDELETE = (grdProdLot.Children[0] as UcProdLot).btnCancelDelete;
            #endregion
        }

        void SetCheckBox()
        {
            CHECK_WAIT = (grdSearch.Children[0] as UcSearch).chkWait;
            CHECK_WAIT.Checked += OnCheckBoxChecked;
            CHECK_WAIT.Unchecked += OnCheckBoxChecked;

            CHECK_RUN = (grdSearch.Children[0] as UcSearch).chkRun;
            CHECK_RUN.Checked += OnCheckBoxChecked;
            CHECK_RUN.Unchecked += OnCheckBoxChecked;

            CHECK_END = (grdSearch.Children[0] as UcSearch).chkEqpEnd;
            CHECK_END.Checked += OnCheckBoxChecked;
            CHECK_END.Unchecked += OnCheckBoxChecked;

            CHECK_WOPRODUCT = (grdProdLot.Children[0] as UcProdLot).chkWoProduct;
            CHECK_WOPRODUCT.Checked += OnCheckBoxChecked;
            CHECK_WOPRODUCT.Unchecked += OnCheckBoxChecked;
        }

        void SetTextBox()
        {
            //믹서와 코터는 상단 생산량/모LOT투입량/잔량을 보여줄 필요가 없다.
            if (PROCID.Equals(Process.PRE_MIXING) || PROCID.Equals(Process.MIXING) || PROCID.Equals(Process.COATING) || PROCID.Equals(Process.SRS_MIXING) || PROCID.Equals(Process.SRS_COATING))
            {
                //(grdResult.Children[0] as UcResult).grdSummary.Visibility = Visibility.Collapsed;
                isCoaterAfterProcess = false;

                //if (isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                //    isCoaterAfterProcess = true;
            }
            else
            {
                //(grdResult.Children[0] as UcResult).grdSummary.Visibility = Visibility.Visible;
                isCoaterAfterProcess = true;
            }

            //if (!PROCID.Equals(Process.PRE_MIXING) && !PROCID.Equals(Process.MIXING) && !PROCID.Equals(Process.COATING) && !PROCID.Equals(Process.SRS_MIXING) && !PROCID.Equals(Process.SRS_COATING))

            txtInputQty = (grdResult.Children[0] as UcResult).txtInputQty;

            if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING))
            {
                (grdResult.Children[0] as UcResult).lblInputQty.Text = ObjectDic.Instance.GetObjectName("양품량");
                txtInputQty.Tag = "C";
            }

            txtParentQty = (grdResult.Children[0] as UcResult).txtParentQty;
            txtRemainQty = (grdResult.Children[0] as UcResult).txtRemainQty;

            chkInOut = (grdResult.Children[0] as UcResult).chkInOut;    //체크박스이지만 이쪽에서 처리
            txtUnit = (grdResult.Children[0] as UcResult).txtUnit;
            txtEndLotId = (grdCommand.Children[0] as UcCommand).txtEndLotId;

            // SHIFT USER, WOREKER 하단에 추가
            txtShift = (grdShift.Children[0] as UcShift).txtShift;
            txtWorker = (grdShift.Children[0] as UcShift).txtWorker;
            txtShiftDateTime = (grdShift.Children[0] as UcShift).txtShiftDateTime;
            txtShiftStartTime = (grdShift.Children[0] as UcShift).txtShiftStartTime;
            txtShiftEndTime = (grdShift.Children[0] as UcShift).txtShiftEndTime;
            
            // 합권취용 투입 LOT ID
            txtMergeInputLot = (grdDataCollect.Children[0] as UcDataCollect).txtMergeInputLot;
        }

        void SetEvents()
        {
            (grdSearch.Children[0] as UcSearch).btnSearch.Click += OnClickSearch;
            (grdCommand.Children[0] as UcCommand).btnBarcodeLabel.Click += OnClickBarcode;
            (grdCommand.Children[0] as UcCommand).btnCancel.Click += OnClickStartCancel;
            (grdCommand.Children[0] as UcCommand).btnEqptEnd.Click += OnClickEqptEnd;
            (grdCommand.Children[0] as UcCommand).btnEqptEndCancel.Click += OnClickEqptEndCancel;
            (grdCommand.Children[0] as UcCommand).btnConfirm.Click += OnClickConfirm;
            //(grdCommand.Children[0] as UcCommand).btnFinalCut.Click += OnClickFinalCut;
            (grdCommand.Children[0] as UcCommand).btnHistoryCard.Click += OnClickHistoryCard;
            (grdCommand.Children[0] as UcCommand).btnCleanLot.Click += OnClickCleanLot;
            (grdCommand.Children[0] as UcCommand).btnCancelFCut.Click += OnClickCancelFLot;
            (grdCommand.Children[0] as UcCommand).btnEqptIssue.Click += OnClickEqptIssue;
            //(grdCommand.Children[0] as UcCommand).btnInvoiceMaterial.Click += OnClickInvoiceMaterial;
            (grdCommand.Children[0] as UcCommand).btnCut.Click += OnClickLotCut;
            (grdCommand.Children[0] as UcCommand).btnEqptCond.Click += OnClickEqptCond;
            (grdCommand.Children[0] as UcCommand).btnPrintLabel.Click += OnClickPrintLabel;
            //(grdCommand.Children[0] as UcCommand).btnLotIssue.Click += OnClickLotIssue;
            (grdCommand.Children[0] as UcCommand).btnMixConfirm.Click += OnClickMixConfirm;
            (grdCommand.Children[0] as UcCommand).btnSamplingProd.Click += OnClickSamplingProd;
            #region [Sampling]
            (grdCommand.Children[0] as UcCommand).btnSamplingProdT1.Click += OnClickSamplingProdT1;
            #endregion

            (grdCommand.Children[0] as UcCommand).btnProcReturn.Click += OnClickProcReturn;
            (grdCommand.Children[0] as UcCommand).btnStartCoaterCut.Click += OnStartCoaterCut;      // 코터 임의 Cut 생성 버튼 추가 [2018-11-14]
            (grdCommand.Children[0] as UcCommand).btnExtra.MouseLeave += OnExtraMouseLeave;
            (grdCommand.Children[0] as UcCommand).btnSlBatch.Click += OnClickSlBatch;
            //(grdCommand.Children[0] as UcCommand).btnReservation.Click += BtnReservation_Click;

            // Mixer Slurry 정보 조회 Event 추가. 2018.06.01
            (grdCommand.Children[0] as UcCommand).btnMixerTankInfo.Click += OnClickMixerTankInfo;

            // Mixer Slurry 물성정보 조회 Event 추가. 2018.10.26
            (grdCommand.Children[0] as UcCommand).btnSlurryConf.Click += OnClickMixerSlurryConfInfo;

            // Port별 Skid Type 설정 Evnet
            (grdCommand.Children[0] as UcCommand).btnSkidTypeSettingByPort.Click += OnClickSkidTypeSettingByPort;

            //Pilot Mode
            (grdCommand.Children[0] as UcCommand).btnPilotProdMode.Click += OnClickPilotProdMode_Click;

            // 출하모델 NG TAG 유출 방지 Event 추가. 2021.03.23
            (grdCommand.Children[0] as UcCommand).btnShipmentModel.Click += OnClickShipmentModel;

            //2021.05.27 무지부 방향 설정
            (grdCommand.Children[0] as UcCommand).btnWorkHalfSlitSide.Click += OnClickWorkHalfSlitSide;

            // RollMap 코터 설비 투입자재 조회 [2021.08.10]
            (grdCommand.Children[0] as UcCommand).btnRollMapInputMaterial.Click += OnClickRollMapInputMaterial;
            (grdCommand.Children[0] as UcCommand).btnSlurryManualOutput.Click += OnClickSlurryManualOutput;
            (grdCommand.Children[0] as UcCommand).btnSlurryManualInput.Click += OnClickSlurryManualInput;
            (grdCommand.Children[0] as UcCommand).btnSlurryBufferManualInit.Click += OnClickSlurryBufferManualInit;

            (grdSearch.Children[0] as UcSearch).cboEquipment.SelectedItemChanged += OnSelectedItemChangedEquipmentCombo;
            (grdSearch.Children[0] as UcSearch).cboCoatType.SelectedItemChanged += OnSelectedItemChangedCoatSideTypeCombo;
            (grdSearch.Children[0] as UcSearch).rdoTop.Checked += On_rdoTop_Checked;
            (grdSearch.Children[0] as UcSearch).rdoBack.Checked += On_rdoBack_Checked;
            (grdProdLot.Children[0] as UcProdLot).dgLargeLot.CurrentCellChanged += OnGridCurrentCellChanged;
            (grdProdLot.Children[0] as UcProdLot).dgProductLot.CurrentCellChanged += OnGridCurrentCellChanged;
            (grdProdLot.Children[0] as UcProdLot).dgProductLot.LoadedCellPresenter += OnLoadedProdLotCellPresenter;
            (grdProdLot.Children[0] as UcProdLot).dgProductLot.UnloadedCellPresenter += OnUnloadedProdLotCellPresenter;

            #region [Cancel Delete Lot]
            (grdProdLot.Children[0] as UcProdLot).btnCancelDelete.Click += OnCancelDeleteLot;
            #endregion

            (grdResult.Children[0] as UcResult).txtInputQty.KeyDown += OnKeyDownInputQty;
            (grdResult.Children[0] as UcResult).txtInputQty.LostFocus += OnKeyLostInputQty;
            (grdResult.Children[0] as UcResult).btnSaveWipHistory.Click += OnClickWIPHistory;
            (grdResult.Children[0] as UcResult).btnSaveCarrier.Click += OnClickSaveCarrier;

            (grdResult.Children[0] as UcResult).dgLotInfo.LoadedCellPresenter += OnLoadedLotInfoCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.CommittedEdit += OnDataCollectGridCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.BeginningEdit += OnDataCollectGridBeginningEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.PreviewKeyDown += OnDataCollectGridPreviewKeyDown;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.MouseDoubleClick += OnClickCellMouseDoubleClick;

            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.LoadedCellPresenter += OnDataCollectGridLoadedCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.UnloadedCellPresenter += OnDataCollectGridUnLoadedCellPresenter;

            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.BeginningEdit += OnDataCollectGridBeginningEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.CommittedEdit += OnDataCollectGridCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.PreviewKeyDown += OnDataCollectGridPreviewKeyDown;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.MouseDoubleClick += OnClickCellMouseDoubleClick;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.LoadedCellPresenter += OnDataCollectGridLoadedCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.UnloadedCellPresenter += OnDataCollectGridUnLoadedCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.BeganEdit += dgWipReason2_BeganEdit;

            //(grdDataCollect.Children[0] as UcDataCollect).dgRemark.CommittedEdit += OnDataCollectGridRemarkCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgRemark.LoadedCellPresenter += OnLoadedRemarkCellPresenter;
            #region [POSTACTION]
            (grdDataCollect.Children[0] as UcDataCollect).dgPostHold.LoadedCellPresenter += OnLoadedPostHoldCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgPostHold.CommittedEdit += OnDataCollectGridPostHoldCommittedEdit;
            #endregion
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality.CommittedEdit += OnDataCollectGridQualityCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality.PreviewKeyDown += OnDataCollectGridPreviewKeyDown;
            //(grdDataCollect.Children[0] as UcDataCollect).dgQuality.KeyDown += OnDataGridKeyDown;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality.LoadedCellPresenter += OnLoadedDgQualitynCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality.UnloadedCellPresenter += OnUnLoadedDgQualitynCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality2.CommittedEdit += OnDataCollectGridQualityCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality2.PreviewKeyDown += OnDataCollectGridPreviewKeyDown;
            //(grdDataCollect.Children[0] as UcDataCollect).dgQuality2.KeyDown += OnDataGridKeyDown;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality2.LoadedCellPresenter += OnLoadedDgQualitynCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgQuality2.UnloadedCellPresenter += OnUnLoadedDgQualitynCellPresenter;
            (grdDataCollect.Children[0] as UcDataCollect).dgDefectTag.CommittedEdit += OnDataCollectGridDefectTagComittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgColor.CommittedEdit += OnDataCollectGridColorTagCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgCotton.CommittedEdit += OnDataCollectGridCottonTagCommittedEdit;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveWipReason.Click += OnClickSaveWipReason;
            (grdDataCollect.Children[0] as UcDataCollect).btnProcResn.Click += OnClickProcReason;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveQuality.Click += OnClickSaveQuality;
            (grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterial.Visibility = Visibility.Hidden;            

            (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial.Click += OnClickSaveMaterial;
            (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial.Click += OnClickDeleteMaterial;
            (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial.Click += OnClickAddMaterial;
            (grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterial.Click += OnClickRemoveMaterial;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterialHistory.Click += OnClickSaveMaterialHistory;
            (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterialHistory.Click += OnClickDeleteMaterialHistory;
            (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterialHistory.Click += OnClickAddMaterialHistory;
            (grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterialHistory.Click += OnClickRemoveMaterialHistory;

            (grdDataCollect.Children[0] as UcDataCollect).btnSaveRemark.Click += OnClickSaveRemark;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveColor.Click += OnClickSaveColorTag;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveTag.Click += OnClickSaveDefectTag;
            //전체저장 2018-01-09
            (grdDataCollect.Children[0] as UcDataCollect).btnPublicWipSave.Click += OnClickPublicSave; 
            (grdDataCollect.Children[0] as UcDataCollect).btnSearchSlurry.Click += OnClickSearchSlurry;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveSlurry.Click += OnClickSaveSlurry;
            (grdDataCollect.Children[0] as UcDataCollect).btnDelSlurry.Click += OnClickDeleteSlurry;
            (grdDataCollect.Children[0] as UcDataCollect).dgSearchSlurry.MouseDoubleClick += OnGridMouseDoubleClick;
            (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.CommittedEdit += OnMaterialCommittedEdit;
            //면상태일지 2018-04-06
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveCotton.Click += OnClickCottonSave;
            //고형분 비율 2023-03-27
            (grdDataCollect.Children[0] as UcDataCollect).btnSolidContRate.Click += OnClickSolidContRate;


            #region[POSTACTION]
            (grdDataCollect.Children[0] as UcDataCollect).btnSavePostHold.Click += OnClickPostHoldSave;
            #endregion

            // COATER전용 이벤트 추가 ( 2017-01-09 )
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.BeginningEdit += OnDataGridBeginningEdit;
            (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.BeginningEdit += OnDataGridBeginningEdit;

            //[CR-128] MIXER Consume Materail(2017.01.18)
            (grdDataCollect.Children[0] as UcDataCollect).btnEqptMaterial.Click += OnClickEqptMaterialList;
            (grdDataCollect.Children[0] as UcDataCollect).btnInputMaterial.Click += OnClickInputMaterial;

            // MULTI LANE 소형/자동차를 나눠서 기능을 사용하기 위하여 추가 [2017-01-24] -CR-56-
            (grdDataCollect.Children[0] as UcDataCollect).chkSum.Click += OnSumReasonGridChecked;
            (grdDataCollect.Children[0] as UcDataCollect).cboLaneNum.SelectedItemChanged += OnLaneSelectionItemChanged;

            // 해당 SUMMARYROW의 CELL표시 및 양품량 계산을 위하여 해당 EVENT 추가 [2017-02-17]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
            {
                (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.LoadedCellPresenter += OnLoadedWipReasonCellPresenter;
                (grdDataCollect.Children[0] as UcDataCollect).txtMesualQty.KeyDown += OnKeyDownMesualQty;
                (grdDataCollect.Children[0] as UcDataCollect).txtMesualQty.LostFocus += OnKeyLostMesualQty;
            }

            // SHIFT USER, WORKER 정보를 사용하기 위하여 BUTTON 이벤트 추가 [2017-02-24]
            (grdShift.Children[0] as UcShift).btnShift.Click += OnClickShift;

            // 공정진척 창확장 버튼 EVENT추가 [2017-03-24]
            (grdDataCollect.Children[0] as UcDataCollect).btnExpandFrame.Click += OnClickbtnExpandFrame;
            (grdDataCollect.Children[0] as UcDataCollect).btnLeftExpandFrame.Click += OnClickbtnLeftExpandFrame;

            // 합권취 버튼 이벤트 추가 [2017-07-06]
            (grdDataCollect.Children[0] as UcDataCollect).btnSearchMerge.Click += OnClickSearchMergeData;
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveMerge.Click += OnClickSaveMergeData;

            // CNA에서 불량 실적 반영안되는 괴현상 발생으로 불량값 입력 하다 TAB이동 후 다시 돌아오면 소수점 클리어되는 현상으로 하기 이벤트 추가 [2017-09-03]
            (grdDataCollect.Children[0] as UcDataCollect).tcDataCollect.SelectionChanged += OnTabSelectionChange;

            (grdDataCollect.Children[0] as UcDataCollect).btnSaveRollDir.Click += OnClickSaveRollDir;

            #region # Roll Map
            (grdSearch.Children[0] as UcSearch).btnRollMap.Click += OnClickRollMap;
            //(grdDataCollect.Children[0] as UcDataCollect).dgWipReason.BeginningEdit += OnBeginningEdit;
            //(grdDataCollect.Children[0] as UcDataCollect).dgWipReason2.BeginningEdit += OnBeginningEdit;
            #endregion

            (grdDataCollect.Children[0] as UcDataCollect).btnRollMapUpdate.Click += btnRollMapUpdate_Click; //nathan 2023.12.13 롤맵 코터 수불 실적 적용
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveTestCut.Click += btnSaveTestCut_Click;     //nathan 2023.12.13 롤맵 코터 수불 실적 적용
            (grdDataCollect.Children[0] as UcDataCollect).dgTestCut.LoadedCellPresenter += dgTestCut_LoadedCellPresenter;//nathan 2023.12.13 롤맵 코터 수불 실적 적용
            (grdDataCollect.Children[0] as UcDataCollect).dgTestCut.CurrentCellChanged += dgTestCut_CurrentCellChanged; //nathan 2023.12.13 롤맵 코터 수불 실적 적용

            #region [E20240206-000574] 로딩 인라인 데이터(TWS) 연동
            (grdDataCollect.Children[0] as UcDataCollect).btnSaveTWS_Loading.Click += OnClickSaveTWS_Loading;

            (grdDataCollect.Children[0] as UcDataCollect).rbRolloutUp.Checked += rbRollDirectCheck;
            (grdDataCollect.Children[0] as UcDataCollect).rbRolloutDown.Checked += rbRollDirectCheck;
            (grdDataCollect.Children[0] as UcDataCollect).rbRollinUp.Checked += rbRollDirectCheck;
            (grdDataCollect.Children[0] as UcDataCollect).rbRollinDown.Checked += rbRollDirectCheck;
            (grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneForward.Checked += rbRollDirectCheck;
            (grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneReverse.Checked += rbRollDirectCheck;

            cboEquipmentSegment_SelectedValueChanged(EQUIPMENTSEGMENT_COMBO, null);
            EQUIPMENTSEGMENT_COMBO.SelectedValueChanged += cboEquipmentSegment_SelectedValueChanged; 
            #endregion
        }

        void SetVisible()
        {
            // GRID LOT
            if (procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.MIXING) || procId.Equals(Process.SRS_MIXING))
            {
                PRODLOT_GRID.Columns["LOTID_PR"].Visibility = Visibility.Collapsed;
                PRODLOT_GRID.Columns["INPUTQTY"].Visibility = Visibility.Collapsed;
                PRODLOT_GRID.Columns["COATER_PRJT_NAME"].Visibility = Visibility.Visible;

                if (procId.Equals(Process.PRE_MIXING))
                {
                    PRODLOT_GRID.Columns["PRJT_NAME"].Visibility = Visibility.Collapsed;
                    PRODLOT_GRID.Columns["PRODDESC"].DisplayIndex = PRODLOT_GRID.Columns["PRJT_NAME"].DisplayIndex;
                }

                LOTINFO_GRID.Columns["GOODQTY"].Header = "양품수량";
                LOTINFO_GRID.Columns["GOODPTNQTY"].Header = "양품수량";
                LOTINFO_GRID.Columns["GOODPTNQTY"].Visibility = Visibility.Collapsed;

            }
            // 슬리터2차 추가 2021-09-15 by 오화백
            else if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
            {
                LOTINFO_GRID.Columns["GOODQTY"].Header = "양품수량" + "(S/Roll)";
                LOTINFO_GRID.Columns["GOODPTNQTY"].Visibility = Visibility.Collapsed;

                string sHeader = "불량수량" + "(S/Roll)";
                LOTINFO_GRID.Columns["LOSSQTY"].Header = new List<string>() { sHeader, "합계" };
                LOTINFO_GRID.Columns["DTL_DEFECT"].Header = new List<string>() { sHeader, "LOT불량" };
                LOTINFO_GRID.Columns["DTL_LOSS"].Header = new List<string>() { sHeader, "LOSS" };
                LOTINFO_GRID.Columns["DTL_CHARGEPRD"].Header = new List<string>() { sHeader, "물품청구" };
            }
            else
            {
                List<string> sHeader = new List<string>() { "양품수량", "C/Roll" };
                LOTINFO_GRID.Columns["GOODQTY"].Header = sHeader;
                LOTINFO_GRID.Columns["GOODPTNQTY"].Visibility = Visibility.Visible;

                // HALF SLITTING 공정에서 LANE수 LOT_GRID에 추가 [2017-01-05]
                if (procId.Equals(Process.HALF_SLITTING))
                {
                    LOTINFO_GRID.Columns["LANE_QTY"].Visibility = Visibility.Visible;
                }

                // COATER 공정에서 횟수 입력 추가 [2017-01-09]
                /*
                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                {
                    WIPREASON_GRID.Columns["COUNTQTY"].Visibility = Visibility.Visible;
                    WIPREASON2_GRID.Columns["COUNTQTY"].Visibility = Visibility.Visible;
                }
                */

                if (procId.Equals(Process.ROLL_PRESSING))
                    PRODLOT_GRID.Columns["PRESSCOUNT"].Visibility = Visibility.Visible;
            }

            // 횟수를 COMMONCODE로 관리하도록 변경 (C20190416_75868) [2019-04-16]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            isResnCountUse = IsAreaCommonCodeUse("RESN_COUNT_USE_YN", procId);
            if (isResnCountUse == true && (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING)))
            {
                WIPREASON_GRID.Columns["COUNTQTY"].Visibility =Visibility.Visible;

                if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                    WIPREASON2_GRID.Columns["COUNTQTY"].Visibility = Visibility.Visible;
            }

            //[CR-128] MIXER Consume Material(2017.01.18)
            if (procId.Equals(Process.MIXING))
            {
                (grdDataCollect.Children[0] as UcDataCollect).btnEqptMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).btnInputMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterialList.Visibility = Visibility.Visible;

                (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Visibility = Visibility.Collapsed;
            }
            else if (procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.SRS_MIXING))
            {
                (grdDataCollect.Children[0] as UcDataCollect).btnInputMaterial.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterialList.Visibility = Visibility.Visible;

                (grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial.Visibility = Visibility.Collapsed;
                (grdDataCollect.Children[0] as UcDataCollect).dgMaterial.Visibility = Visibility.Collapsed;
            }
            else if (procId.Equals(Process.BACK_WINDER))
            {
                (grdCommand.Children[0] as UcCommand).btnCancel.Visibility = Visibility.Collapsed;
            }

            // MULTI LANE은 수동으로 ALL/SUM 구분하여 사용할 수 있게 변경 [2017-01-21] -CR-56-
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
            {
                WIPREASON_GRID.Columns["RESNTOTQTY"].Visibility = Visibility.Visible;

                (grdDataCollect.Children[0] as UcDataCollect).chkSum.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).cboLaneNum.Visibility = Visibility.Visible;

                (grdDataCollect.Children[0] as UcDataCollect).lblMesualQty.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).txtMesualQty.Visibility = Visibility.Visible;

                //(grdDataCollect.Children[0] as UcDataCollect).dgRemark.Columns["REMARK_ALL"].Visibility = Visibility.Visible;
                //DataTableConverter.SetValue(WIPREASON_GRID, "FrozenBottomRowsCount", 2); // slitting 일때 하단 2 rows 고정
            }

            if (string.Equals(procId, Process.ROLL_PRESSING))
            {
                WIPREASON_GRID.Columns["DFCT_TAG_QTY"].Visibility = Visibility.Visible;
                DataTableConverter.SetValue(QUALITY_GRID, "FrozenBottomRowsCount", 1);
            }
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                DataTableConverter.SetValue(WIPREASON_GRID, "FrozenBottomRowsCount", 2);
            else
                (grdDataCollect.Children[0] as UcDataCollect).dgWipReason.BottomRows.Clear();

            if (string.Equals(LoginInfo.CFG_AREA_ID, "E1") && string.Equals(procId, Process.COATING))
            {
                WIPREASON_GRID.Columns["CONVRESNQTY"].Visibility = Visibility.Visible;
                WIPREASON2_GRID.Columns["CONVRESNQTY"].Visibility = Visibility.Visible;
            }

            // SRS코터 투입자재란에 실제수량이 아닌 1BATCH수량이라 입력값 보여주지 않음 [2017-05-23]
            if (string.Equals(procId, Process.SRS_COATING))
                INPUTMTRL_GRID.Columns["INPUT_QTY"].Visibility = Visibility.Collapsed;

            // SRS SLITTER에는 체크박스 보여줌 [2017-06-07]
            if (string.Equals(procId, Process.SRS_SLITTING) && chkInOut != null)
                chkInOut.Visibility = Visibility.Visible;

            // CNA 코터공정 CUT 표기 요청 [2017-07-12]
            if (string.Equals(procId, Process.COATING))
                PRODLOT_GRID.Columns["CUT"].Visibility = Visibility.Visible;

            // SLITTING 공정만 생산 중 불량 기능 추가 [2017-07-18]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                (grdDataCollect.Children[0] as UcDataCollect).btnProcResn.Visibility = Visibility.Visible;

            // C20220308-000577 - 절연 자주검사 설비값 [2022-04-27]
            if (string.Equals(procId, Process.COATING))
            {
                string[] sEqptAttr = { LoginInfo.CFG_AREA_ID, procId };
                if (IsCommoncodeAttrUse("COATER_QLTY_EQPT_VISIBLE", null, sEqptAttr))
                {
                    QUALITY_GRID.Columns["EQPT_VALUE"].Visibility = Visibility.Visible;

                    if (QUALITY2_GRID.Visibility == Visibility.Visible)
                        QUALITY2_GRID.Columns["EQPT_VALUE"].Visibility = Visibility.Visible;
                }
            }

            if (IsAreaCommonCodeUse("SOLID_CONT_AUTO_CALC_PROC", procId))
                (grdDataCollect.Children[0] as UcDataCollect).btnSolidContRate.Visibility = Visibility.Visible;
            else
                (grdDataCollect.Children[0] as UcDataCollect).btnSolidContRate.Visibility = Visibility.Collapsed;
        }

        public void SetApplyPermissions()
        {
            List<Button> listAuth = new List<Button>();
            listAuth.Add((grdCommand.Children[0] as UcCommand).btnStart);
            listAuth.Add((grdCommand.Children[0] as UcCommand).btnCancel);
            listAuth.Add((grdCommand.Children[0] as UcCommand).btnEqptEnd);
            listAuth.Add((grdCommand.Children[0] as UcCommand).btnConfirm);

            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnProcResn);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveWipReason);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveQuality);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterial);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterial);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnAddMaterial);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterial);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveMaterialHistory);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnDeleteMaterialHistory);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnAddMaterialHistory);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnRemoveMaterialHistory);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveRemark);
            listAuth.Add((grdDataCollect.Children[0] as UcDataCollect).btnSaveColor);
            listAuth.Add((grdResult.Children[0] as UcResult).btnSaveWipHistory);
            listAuth.Add((grdShift.Children[0] as UcShift).btnShift);

            listAuth.Add((grdProdLot.Children[0] as UcProdLot).btnCancelDelete);

            Util.pageAuth(listAuth, FrameOperation.AUTHORITY);
        }

        private void CboEquipment_SelectedItemChanged(object sender, PropertyChangedEventArgs<object> e)
        {
            throw new NotImplementedException();
        }

        void SetGrids()
        {
            LARGELOT_GRID = (grdProdLot.Children[0] as UcProdLot).dgLargeLot;
            PRODLOT_GRID = (grdProdLot.Children[0] as UcProdLot).dgProductLot;
            LOTINFO_GRID = (grdResult.Children[0] as UcResult).dgLotInfo;
            WIPREASON_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgWipReason;
            WIPREASON2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgWipReason2;
            //DEFECT_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgDefect;
            //DEFECT2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgDefect2;
            //LOSS_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgLoss;
            //LOSS2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgLoss2;
            //CHARGE_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgCharge;
            //CHARGE2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgCharge2;
            QUALITY_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgQuality;
            QUALITY2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgQuality2;
            COLOR_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgColor;
            DEFECT_TAG_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgDefectTag;
            INPUTMTRL_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgMaterial;
            INPUTMTRLHIST_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgMaterialHistory;
            SLURRY_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgSearchSlurry;
            SLURRY_INPUT_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgSlurry;
            REMARK_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgRemark;
            REMARK_HIST_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgRemarkHistory;
            //[CR-128] MIXER Consume Material (2017.01.18)
            INPUTMTRLSUMMARY_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgMaterialList;
            MERGE_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgWipMerge;
            MERGE2_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgWipMerge2;
            COTTON_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgCotton;
            EQPT_DFCT_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgEqptDefect;

            #region[POSTACTION]
            POSTHOLD_GRID = (grdDataCollect.Children[0] as UcDataCollect).dgPostHold;
            #endregion
            switch (procId)
            {
                case "E2000":
                case "E2300":
                    //if (procId.Equals(Process.INS_COATING))
                    //    isSingleCoater = true;
                    if (procId.Equals(Process.COATING))
                        LARGELOT_GRID.Visibility = Visibility.Visible;
                    else
                        LARGELOT_GRID.Visibility = Visibility.Collapsed;

                    WIPREASON2_GRID.Visibility = Visibility.Visible;
                    //DEFECT2_GRID.Visibility = Visibility.Visible;
                    //LOSS2_GRID.Visibility = Visibility.Visible;

                    // 단면코터 TOP일시 TOP만 표시 (2017-01-09)
                    if ((isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "T")) || (string.Equals(procId, Process.INS_COATING) && string.Equals(COATTYPE_COMBO.SelectedValue, "T")))
                        WIPREASON2_GRID.Visibility = Visibility.Collapsed;

                    // Modify 2016.12.19 : 물청 TOP/BACK 없음 *********
                    //CHARGE2_GRID.Visibility = Visibility.Collapsed;
                    //*************************************************
                    QUALITY2_GRID.Visibility = Visibility.Visible;

                    Grid grdWipReason = (grdDataCollect.Children[0] as UcDataCollect).grdWipReason as Grid;
                    //Grid grdDefect = (grdDataCollect.Children[0] as UcDataCollect).grdDefectGrid as Grid;
                    //Grid grdLoss = (grdDataCollect.Children[0] as UcDataCollect).grdLossGrid as Grid;
                    //Grid grdCharge = (grdDataCollect.Children[0] as UcDataCollect).grdChargeGrid as Grid;
                    Grid grdQuality = (grdDataCollect.Children[0] as UcDataCollect).grdQualityGrid as Grid;

                    grdWipReason.ColumnDefinitions.Clear();
                    //grdDefect.ColumnDefinitions.Clear();
                    //grdLoss.ColumnDefinitions.Clear();
                    //grdCharge.ColumnDefinitions.Clear();
                    grdQuality.ColumnDefinitions.Clear();

                    ColumnDefinition cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdWipReason.ColumnDefinitions.Add(cd);

                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdLoss.ColumnDefinitions.Add(cd);

                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdLoss.ColumnDefinitions.Add(cd);

                    // 단면코터 TOP일시 초기화 및 Lable 표시안함 (2017-01-09)
                    if ((isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "T")) || (string.Equals(procId, Process.INS_COATING) && string.Equals(COATTYPE_COMBO.SelectedValue, "T")))
                        grdWipReason.ColumnDefinitions.Clear();

                    // Modify 2016.12.19 : 물청 TOP/BACK 없음 *********
                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdCharge.ColumnDefinitions.Add(cd);

                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdCharge.ColumnDefinitions.Add(cd);
                    //*************************************************

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdQuality.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    grdQuality.ColumnDefinitions.Add(cd);
                    break;

                case "S2000":
                    LARGELOT_GRID.Visibility = Visibility.Visible;
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    QUALITY2_GRID.Visibility = Visibility.Collapsed;
                    break;

                case "E3000":
                    LARGELOT_GRID.Visibility = Visibility.Collapsed;
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    QUALITY_GRID.Visibility = Visibility.Visible;
                    QUALITY2_GRID.Visibility = Visibility.Collapsed;
                    COLOR_GRID.Visibility = Visibility.Visible;

                    grdQuality = (grdDataCollect.Children[0] as UcDataCollect).grdQualityGrid as Grid;
                    grdQuality.ColumnDefinitions.Clear();

                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdQuality.ColumnDefinitions.Add(cd);

                    //cd = new ColumnDefinition();
                    //cd.Width = new GridLength(1, GridUnitType.Star);
                    //grdQuality.ColumnDefinitions.Add(cd);
                    break;

                case "E3500":
                    LARGELOT_GRID.Visibility = Visibility.Collapsed;
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    QUALITY2_GRID.Visibility = Visibility.Collapsed;
                    COLOR_GRID.Visibility = Visibility.Visible;
                    break;

                case "E4600":
                    LARGELOT_GRID.Visibility = Visibility.Collapsed;
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    QUALITY_GRID.Visibility = Visibility.Collapsed;
                    QUALITY2_GRID.Visibility = Visibility.Collapsed;
                    break;

                default:
                    LARGELOT_GRID.Visibility = Visibility.Collapsed;
                    WIPREASON2_GRID.Visibility = Visibility.Collapsed;
                    QUALITY2_GRID.Visibility = Visibility.Collapsed;
                    break;
            }
        }
        void SetMixLossClean()
        {
            RadioButton rbManual = new RadioButton();
            rbManual.Content = ObjectDic.Instance.GetObjectName("수동");
            rbManual.Name = "rbManual";
            rbManual.Click += new RoutedEventHandler(OnClickMixLoss);

            RadioButton rbSimpClean = new RadioButton();
            rbSimpClean.Content = ObjectDic.Instance.GetObjectName("간이세정");
            rbSimpClean.Name = "rbSimpClean";
            rbSimpClean.Click += new RoutedEventHandler(OnClickMixLoss);

            RadioButton rbFullClean = new RadioButton();
            rbFullClean.Content = ObjectDic.Instance.GetObjectName("Full세정");
            rbFullClean.Name = "rbFullClean";
            rbFullClean.Click += new RoutedEventHandler(OnClickMixLoss);

            rbManual.IsChecked = true;
            rbSimpClean.IsChecked = false;
            rbFullClean.IsChecked = false;

            Grid wGrid = (grdDataCollect.Children[0] as UcDataCollect).grdWipReasonHeader;
            wGrid.ColumnDefinitions.Clear();

            wGrid.ColumnDefinitions.Add(new ColumnDefinition());
            StackPanel sPanel = new StackPanel();
            Border sBoard = new Border();
            sBoard.Width = 50;
            sPanel.Orientation = Orientation.Horizontal;
            sPanel.HorizontalAlignment = HorizontalAlignment.Left;
            sPanel.Children.Add(sBoard);
            sPanel.Children.Add(rbManual);
            sBoard = new Border();
            sBoard.Width = 8;
            sPanel.Children.Add(sBoard);
            sPanel.Children.Add(rbSimpClean);
            sBoard = new Border();
            sBoard.Width = 8;
            sPanel.Children.Add(sBoard);
            sPanel.Children.Add(rbFullClean);

            wGrid.Children.Add(sPanel);
        }
        protected virtual void OnClickMixLoss(object sender, RoutedEventArgs e)
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
                return;

            RadioButton rb = sender as RadioButton;
            string sCode = string.Empty;

            switch (rb.Name)
            {
                case "rbSimpClean":
                    sCode = "SIMP";
                    break;

                case "rbFullClean":
                    sCode = "FULL";
                    break;

                default:
                    sCode = "BAS";
                    break;
            }

            try
            {
                DataTable IndataTable = new DataTable("INDATA");
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["LOTID"] = LOTID;
                Indata["CODE"] = sCode;
                IndataTable.Rows.Add(Indata);

                //C20210222-000365 불량/Loss항목 표준화 적용 DA_PRD_SEL_ACTIVITYREASON_ELEC -> BR_PRD_SEL_ACTIVITYREASON_ELEC 변경
                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_SEL_ACTIVITYREASON_ELEC", "INDATA", "RSLTDT", IndataTable);
                Util.GridSetData(WIPREASON_GRID, dtResult, FrameOperation, true);
                GetSumDefectQty();
                SetCauseTitle();
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        void SetTabItems()
        {
            C1TabItem tabDefect = (grdDataCollect.Children[0] as UcDataCollect).tiDefect;
            C1TabItem tabLoss = (grdDataCollect.Children[0] as UcDataCollect).tiLoss;
            C1TabItem tabCharge = (grdDataCollect.Children[0] as UcDataCollect).tiCharge;
            C1TabItem tabQuality = (grdDataCollect.Children[0] as UcDataCollect).tiQuality;
            C1TabItem tabColor = (grdDataCollect.Children[0] as UcDataCollect).tiColor;
            C1TabItem tabDefectTag = (grdDataCollect.Children[0] as UcDataCollect).tiDefectTag;
            C1TabItem tabInputMaterial = (grdDataCollect.Children[0] as UcDataCollect).tiInputMaterial;
            //C1TabItem tabInputMaterialHistory = (grdDataCollect.Children[0] as UcDataCollect).tiInputMaterialHistory;
            C1TabItem tabSlurry = (grdDataCollect.Children[0] as UcDataCollect).tiSlurry;
            C1TabItem tabRemark = (grdDataCollect.Children[0] as UcDataCollect).tiRemark;
            C1TabItem tabRemarkHistory = (grdDataCollect.Children[0] as UcDataCollect).tiRemarkHistory;
            C1TabItem tabMerge = (grdDataCollect.Children[0] as UcDataCollect).tiMerge;
            C1TabItem tabCotton = (grdDataCollect.Children[0] as UcDataCollect).tiCotton;
            C1TabItem tabRollDir = (grdDataCollect.Children[0] as UcDataCollect).tiRollDirection;
            C1TabItem tabEqptDfct = (grdDataCollect.Children[0] as UcDataCollect).tiEqptDefect;
            

            #region [POSTACTION]
            C1TabItem tabPostHold = (grdDataCollect.Children[0] as UcDataCollect).tiPostHold;
            #endregion
            TextBlock tbTop = (grdDataCollect.Children[0] as UcDataCollect).lblTop;
            TextBlock tbBack = (grdDataCollect.Children[0] as UcDataCollect).lblBack;
            TextBlock tbQualityTop = (grdDataCollect.Children[0] as UcDataCollect).lblQualityTop;
            TextBlock tbQualityBack = (grdDataCollect.Children[0] as UcDataCollect).lblQualityBack;
            Button btnPublicWipSave = (grdDataCollect.Children[0] as UcDataCollect).btnPublicWipSave;
            Button btnSaveCotton = (grdDataCollect.Children[0] as UcDataCollect).btnSaveCotton;

         

            switch (procId)
            {
                case "E0500":
                case "E1000":
                case "S1000":
                    tabDefect.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tabRemark.Visibility = Visibility.Visible;
                    //tabColor.Visibility = Visibility.Visible;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    tabRemarkHistory.Visibility = Visibility.Collapsed;
                    tabMerge.Visibility = Visibility.Collapsed;
              


                    if (procId.Equals(Process.MIXING))
                        SetMixLossClean();
                    break;

                case "E2000": 
                    tabRemark.Visibility = Visibility.Visible;
                    tabMerge.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Visible;
                    tbBack.Visibility = Visibility.Visible;
               

                    // 단면코터 TOP일시 초기화 및 Lable 표시안함 (2017-01-09)
                    if (isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "T"))
                        tbBack.Visibility = Visibility.Collapsed;

                    // 단면코터일 경우만 합권취 표시 [2017-07-06]
                    if (isSingleCoater)
                        tabMerge.Visibility = Visibility.Visible;

                    tbQualityTop.Visibility = Visibility.Visible;
                    tbQualityBack.Visibility = Visibility.Visible;

                    tabSlurry.Visibility = Visibility.Collapsed;

                    //if (isSingleCoater == false || (isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "T")))
                        tabRemarkHistory.Visibility = Visibility.Collapsed;

                    break;

                case "E2300":
                    tabRemark.Visibility = Visibility.Visible;
                    tbTop.Visibility = Visibility.Visible;
                    tbBack.Visibility = Visibility.Visible;
                 

                    //TOP일시 Lable 표시안함
                    if (string.Equals(COATTYPE_COMBO.SelectedValue, "T"))
                        tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Visible;
                    tbQualityBack.Visibility = Visibility.Visible;
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                 

                    break;

                case "S2000":
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tabRemark.Visibility = Visibility.Visible;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    tabRemarkHistory.Visibility = Visibility.Collapsed;                  
                    break;

                case "E3000":
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tabRemark.Visibility = Visibility.Visible;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    tabColor.Visibility = Visibility.Visible;
                    //tbQualityTop.Text = "M/U";
                    // tbQualityBack.Text = "H/G";
                    #region [POSTACTION]
                    //2022-12-29 오화백  EP 동추가
                    //if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EA") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                    //{
                    //    tabRemark.Visibility = Visibility.Collapsed;
                    //    tabPostHold.Visibility = Visibility.Visible;
                    //    POSTHOLD_GRID.Columns[1].Visibility = Visibility.Collapsed;
                    //}

                    // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
                    if (string.Equals(_RemarkHoldUseFlag, "Y"))
                    {
                         tabRemark.Visibility = Visibility.Collapsed;
                         tabPostHold.Visibility = Visibility.Visible;
                         POSTHOLD_GRID.Columns[1].Visibility = Visibility.Collapsed;
                    }

                    #endregion
                    break;

                case "E3500":
                    // CSR : C20220713-000401
                    if (IsCommoncodeUse("INPUT_MTRL_TAPING_AREA", LoginInfo.CFG_AREA_ID))
                        tabInputMaterial.Visibility = Visibility.Visible;
                    else
                        tabInputMaterial.Visibility = Visibility.Collapsed;

                    tabSlurry.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    tabColor.Visibility = Visibility.Visible;            
                    break;

                case "E3300": //LASER ABLITION
                case "E3800":
                case "E3900":
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    btnPublicWipSave.Visibility = Visibility.Collapsed;

                    // NISSAN향 표면검사 전용 기능 : 2017-05월 이후 해당 기능 삭제해도 OK!!!
                    if (string.Equals(LoginInfo.CFG_AREA_ID, "E6"))
                        tabDefectTag.Visibility = Visibility.Visible;
                    break;

                case "E4000":
                case "E4200":  //슬리터 2차 추가  2021-09-15 by 오화백
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    //2022 12 29  오화백 EP 동 추가
                    if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                    { 
                        tabCotton.Visibility = Visibility.Visible;
                    }
                    #region [POSTACTION]
                    // if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EA") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                    // {
                    //     tabRemark.Visibility = Visibility.Collapsed;
                    //     tabPostHold.Visibility = Visibility.Visible;
                    //     POSTHOLD_GRID.Columns[1].Visibility = Visibility.Visible;
                    // }

                    // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
                    if (string.Equals(_RemarkHoldUseFlag, "Y"))
                    {
                        tabRemark.Visibility = Visibility.Collapsed;
                        tabPostHold.Visibility = Visibility.Visible;
                        POSTHOLD_GRID.Columns[1].Visibility = Visibility.Visible;
                    }

                    #endregion

                    break;

                #region [Heat Treatment]
                case "E4600":
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tabQuality.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    tabColor.Visibility = Visibility.Collapsed;
                    tabMerge.Visibility = Visibility.Collapsed;
                    break;
                #endregion

                default:
                    tabInputMaterial.Visibility = Visibility.Collapsed;
                    tabSlurry.Visibility = Visibility.Collapsed;
                    tbTop.Visibility = Visibility.Collapsed;
                    tbBack.Visibility = Visibility.Collapsed;
                    tbQualityTop.Visibility = Visibility.Collapsed;
                    tbQualityBack.Visibility = Visibility.Collapsed;
                    break;
            }

            if (IsAreaCommonCodeUse("MNG_ROLL_DIR_AREA", procId))
            {
                if (LoginInfo.CFG_AREA_ID.Equals("E7") && !EQUIPMENTSEGMENT_COMBO.SelectedValue.Equals("E7D01"))
                {
                    tabRollDir.Visibility = Visibility.Collapsed;
                    isRollDirCtn = false;
                }
                else
                {
                    tabRollDir.Visibility = Visibility.Visible;
                    isRollDirCtn = true;
                }
            }

            if (IsAreaCommonCodeUse("MNG_EQPT_DFCT_AREA", procId))
            {
                tabEqptDfct.Visibility = Visibility.Visible;
                (grdDataCollect.Children[0] as UcDataCollect).dgEqptDefect.Visibility = Visibility.Visible;
            }
        }

        public bool ClearControls()
        {
            bool bRet = false;

            try
            {
                Util.gridClear(PRODLOT_GRID);
                ClearDetailControls();

                bRet = true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                bRet = false;
            }
            return bRet;
        }

        private void ClearDetailControls()
        {
            Util.gridClear(LOTINFO_GRID);
            Util.gridClear(WIPREASON_GRID);
            Util.gridClear(WIPREASON2_GRID);
            Util.gridClear(QUALITY_GRID);
            Util.gridClear(QUALITY2_GRID);
            Util.gridClear(INPUTMTRL_GRID);
            Util.gridClear(SLURRY_GRID);
            Util.gridClear(SLURRY_INPUT_GRID);
            Util.gridClear(COLOR_GRID);
            Util.gridClear(DEFECT_TAG_GRID);
            Util.gridClear(INPUTMTRLSUMMARY_GRID);
            Util.gridClear(REMARK_GRID);
            Util.gridClear(REMARK_HIST_GRID);
            Util.gridClear(MERGE_GRID);
            Util.gridClear(MERGE2_GRID);
            Util.gridClear(COTTON_GRID);
            Util.gridClear(INPUTMTRLHIST_GRID);
            #region[POSTACTION]
            Util.gridClear(POSTHOLD_GRID);
            #endregion

            LOTINFO_GRID.BottomRows.Clear();

            if (procResnDt != null)
                procResnDt.Clear();

            #region [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
            Util.gridClear((grdDataCollect.Children[0] as UcDataCollect).dgTWS_Loading);
            (grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneForward.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbInputRollLaneReverse.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbOutputRollLaneForward.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbOutputRollLaneReverse.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbRollinUp.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbRollinDown.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbRolloutUp.IsChecked = false;
            (grdDataCollect.Children[0] as UcDataCollect).rbRolloutDown.IsChecked = false;
            #endregion

            InitClear();
        }

        private void InitClear()
        {
            // INIT VARIABLE
            _ValueWOID = string.Empty;
            _LargeLOTID = string.Empty;
            _LOTID = string.Empty;
            _EQPTID = string.Empty;
            _LOTIDPR = string.Empty;
            _CUTID = string.Empty;
            _WIPSTAT = string.Empty;
            _INPUTQTY = string.Empty;
            _OUTPUTQTY = string.Empty;
            _CTRLQTY = string.Empty;
            _GOODQTY = string.Empty;
            _LOSSQTY = string.Empty;
            _WORKORDER = string.Empty;
            _WORKDATE = string.Empty;
            _VERSION = string.Empty;
            _PRODID = string.Empty;
            _WIPDTTM_ST = string.Empty;
            _WIPDTTM_ED = string.Empty;
            _REMARK = string.Empty;
            _CONFIRMUSER = string.Empty;
            sEQPTID = string.Empty;
            _FINALCUT = string.Empty;
            _WIPSTAT_NAME = string.Empty;
            _LANEQTY = string.Empty;
            _PTNQTY = string.Empty;
            exceedLengthQty = 0;
            convRate = 1;
            cut = "Y";  // Cut

            InitTextBox();

            //LARGELOTID = string.Empty;

            isChangeWipReason = false;
            //isChangeDefect = false;
            //isChangeLoss = false;
            //isChangeCharge = false;
            isChangeQuality = false;
            isChangeMaterial = false;
            isChangeColorTag = false;
            isChagneDefectTag = false;
            isChangeRemark = false;
            isChangeCotton = false;

            LANENUM_COMBO.Items.Clear();

            #region # Roll Map
            (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
            setRollmapResultLinkBtn();  //nathan 2023.12.13 롤맵 코터 수불 실적 적용
            #endregion

            #region [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
            isSaveTWS_Loading = false;
            isSaveTWS_LOADING_TRACKING = false;
            isAutoSetRollDir = false;
            isSilentlySave = false;
            #endregion
        }

        void InitWorkOrderCheck()
        {
            CHECK_WOPRODUCT.IsChecked = false;           
            dtWoAll = null;
            dtWoCheck = null;
        }

        void InitTextBox()
        {
            txtUnit.Text = string.Empty;
            txtInputQty.Value = 0;

            if (txtGoodQty != null)
                txtGoodQty.Value = 0;

            if (txtLossQty != null)
                txtLossQty.Value = 0;

            if (txtParentQty != null)
            {
                txtParentQty.Value = 0;
                txtRemainQty.Value = 0;
            }

            if (txtVersion != null)
                txtVersion.Text = string.Empty;

            if (txtLaneQty != null)
                txtLaneQty.Value = 0;

            if (txtLanePatternQty != null)
                txtLanePatternQty.Value = 0;

            txtStartDateTime.Text = string.Empty;
            txtEndDateTime.Text = string.Empty;

            /*
            if (dtpWorkDate != null)
            {
                dtpWorkDate.MinDate = DateTime.Now.AddDays(-1);
                dtpWorkDate.MaxDate = DateTime.Now.AddDays(1);
                dtpWorkDate.DateTime = DateTime.Now;
            }
            */

            if (txtWorkDate != null)
                txtWorkDate.Text = string.Empty;

            if (txtWipNote != null)
                txtWipNote.Text = string.Empty;

            if (txtWorkTime != null)
                txtWorkTime.Value = 0;

            if (txtSrs1Qty != null)
                txtSrs1Qty.Value = 0;

            if (txtSrs2Qty != null)
                txtSrs2Qty.Value = 0;

            if (txtSrs3Qty != null)
                txtSrs3Qty.Value = 0;

            if (chkFinalCut != null)
                chkFinalCut.IsChecked = false;

            /*
            if (txtTank != null)
                txtTank.Text = string.Empty;

            if (txtBatchId != null)
                txtBatchId.Text = string.Empty;
             */
            txtMergeInputLot.Text = string.Empty;

            if (txtBeadMillCount != null)
                txtBeadMillCount.Value = 0;

            if (cboPet != null)
                cboPet.SelectedValue = string.Empty;

            if (!string.IsNullOrEmpty(txtShiftEndTime.Text) && txtShiftEndTime.Text.Length == 19)
            {
                // 현재시간보다 근무종료 시간이 작으면 클리어
                string sShiftTime = System.DateTime.Now.ToString("yyyy-MM-dd") + " " + txtShiftEndTime.Text.Substring(txtShiftEndTime.Text.IndexOf(' ') + 1, 8);

                //if (Convert.ToDateTime(txtShiftEndTime.Text) < System.DateTime.Now)
                if (Convert.ToDateTime(sShiftTime) < System.DateTime.Now)
                {
                    //txtWorkStartDateTime.Text = string.Empty;
                    //txtWorkEndDateTime.DateTime = null;
                    txtShift.Text = string.Empty;
                    txtShift.Tag = string.Empty;
                    txtWorker.Text = string.Empty;
                    txtWorker.Tag = string.Empty;
                    txtShiftDateTime.Text = string.Empty;
                    txtShiftStartTime.Text = string.Empty;
                    txtShiftEndTime.Text = string.Empty;
                }
            }
        }

        private void SetWipColorLegendCombo()
        {
            COLOR_COMBO.Visibility = Visibility.Visible;

            COLOR_COMBO.Items.Clear();
            C1ComboBoxItem cbItemTiTle = new C1ComboBoxItem { Content = ObjectDic.Instance.GetObjectName("범례") };
            COLOR_COMBO.Items.Add(cbItemTiTle);

            DataTable inTable = new DataTable("RQSTDT");
            inTable.Columns.Add("LANGID", typeof(string));
            inTable.Columns.Add("CMCDTYPE", typeof(string));
            inTable.Columns.Add("PROCID", typeof(string));

            DataRow inRow = inTable.NewRow();
            inRow["LANGID"] = LoginInfo.LANGID;
            inRow["CMCDTYPE"] = "WIP_COLOR_LEGEND";
            inRow["PROCID"] = procId;

            inTable.Rows.Add(inRow);

            DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIP_COLOR_LEGEND_CBO", "RQSTDT", "RSLTDT", inTable);

            foreach (DataRow row in dtResult.Rows)
            {
                if (row["COLOR_BACK"].ToString().IsNullOrEmpty() || row["COLOR_FORE"].ToString().IsNullOrEmpty())
                {
                    continue;
                }

                C1ComboBoxItem cbItem = new C1ComboBoxItem
                {
                    Content = row["NAME"].ToString(),
                    Background = new BrushConverter().ConvertFromString(row["COLOR_BACK"].ToString()) as SolidColorBrush,
                    Foreground = new BrushConverter().ConvertFromString(row["COLOR_FORE"].ToString()) as SolidColorBrush
                };
                COLOR_COMBO.Items.Add(cbItem);
            }
            COLOR_COMBO.SelectedIndex = 0;

            WIPCOLORLEGEND = dtResult;
        }

        void SetResultDetail()
        {
            int elementCountPerRow = 3;
            int totalRowCount = 0;
            int rowIndex = 0;
            int colIndex = 0;
            int rowIndex2 = 0;
            int colIndex2 = 0;

            List<ResultElement> elemList;
            List<ResultElement> elemList2 = new List<ResultElement>();
            List<ResultElement> elemList3 = new List<ResultElement>();
            List<ResultElement> elemList4 = new List<ResultElement>();

            switch (procId)
            {
                case "E0500": //PRE MIX
                    elemList = ResultElementList.PreMixerList(elementCountPerRow);
                    break;

                case "E1000": //MIX
                case "S1000": //SRS MIX
                    elemList = ResultElementList.MixerList(elementCountPerRow);
                    break;

                case "E2000": //COAT
                    if (isSingleCoater)
                    {
                        elemList = ResultElementList.SingleCoaterTopList(elementCountPerRow);
                        elemList2 = ResultElementList.SingleCoaterBackList(elementCountPerRow);
                        elemList3 = ResultElementList.SlurryAndCoreList(elementCountPerRow);
                        elemList4 = ResultElementList.BackSlurryAndCoreList(elementCountPerRow);
                    }
                    else
                    {
                        elemList = ResultElementList.CoaterList(elementCountPerRow);
                        if (isDoubleLayer) //더블레이어 일때 적용
                        {
                            elemList3 = ResultElementList.SlurryAndCoreListDL(elementCountPerRow); 
                        }
                        else
                        {
                            elemList3 = ResultElementList.SlurryAndCoreList(elementCountPerRow);
                        }
                    }
                    break;

                case "S2000": //SRS COAT
                    elemList = ResultElementList.SrsCoaterList(elementCountPerRow);
                    break;

                case "E3000": //ROLL PRESS
                    elemList = ResultElementList.RollPressList(elementCountPerRow);
                    break;

                case "E2500": //HALF SLITTING
                case "E3500": //TAPING
                case "E3300": //LASER ABLITION
                case "E3800": //표면검사
                case "E3900": //BACK WINDER
                case "E4000": //SLIT
                case "E4200":  //슬리터 2차 추가  2021-09-15 by 오화백
                    elemList = ResultElementList.SlitterList(elementCountPerRow);
                    break;

                case "S4000": //SRS SLIT
                    elemList = ResultElementList.SrsSlitterList(elementCountPerRow);
                    break;

                default:
                    elemList = ResultElementList.CommonList(elementCountPerRow);
                    break;
            }

            totalRowCount = elemList.Count + 2; //(elemList[elemList.Count - 1].Title.Equals("특이사항") ? 2 : (elemList[elemList.Count - 1].Title.Equals(string.Empty) ? 2 : 1));

            Grid grdElement = (grdResult.Children[0] as UcResult).ResultDetail;
            grdElement.Children.Clear();

            int mod = totalRowCount / elementCountPerRow;
            int rem = totalRowCount % elementCountPerRow;

            for (int i = 0; i < mod; i++)
            {
                var rowDef = new RowDefinition();

                //if (elemList.FindIndex(x => x.Control.Name.Equals("dgColorTag")) > 0 || elemList.FindIndex(x => x.Control.Name.Equals("txtWipNote")) > 0)
                //    rowDef.Height = new GridLength(1, GridUnitType.Star);
                //else
                //    rowDef.Height = new GridLength(30);

                if (elemList[elemList.Count - 2].Control.Name.Equals("dgColorTag") || elemList[elemList.Count - 1].Control.Name.Equals("dgColorTag") || elemList[elemList.Count - 1].Control.Name.Equals("txtNote"))
                    rowDef.Height = new GridLength(1, GridUnitType.Star);
                else
                    rowDef.Height = new GridLength(30);

                grdElement.RowDefinitions.Add(rowDef);
            }

            if (rem > 0 && elemList[elemList.Count - 1].SpaceInCharge > 1)
            {
                var rowDef = new RowDefinition();
                rowDef.Height = elemList[elemList.Count - 1].SpaceInCharge > 1 ? new GridLength(1, GridUnitType.Star) : new GridLength(30);
                grdElement.RowDefinitions.Add(rowDef);
            }

            for (int i = 0; i < elementCountPerRow; i++)
            {
                var colDef = new ColumnDefinition();
                colDef.Width = new GridLength(1, GridUnitType.Star);
                grdElement.ColumnDefinitions.Add(colDef);
            }

            foreach (ResultElement re in elemList)
            {
                if (re.Control.Name.Equals("txtVersion"))
                {
                    txtVersion = re.Control as TextBox;

                    if (re.PopupButton != null)
                        re.PopupButton.Click += OnClickVersion;
                }
                else if (re.Control.Name.Equals("txtLaneQty"))
                {
                    txtLaneQty = re.Control as C1NumericBox;

                    if (txtLaneQty.IsEnabled)
                    {
                        txtLaneQty.KeyDown += OnKeyDownLaneQty;
                        txtLaneQty.LostFocus += OnKeyLostFocusLaneQty;
                    }
                }
                else if (re.Control.Name.Equals("txtLanePatternQty"))
                {
                    txtLanePatternQty = re.Control as C1NumericBox;
                }
                else if (re.Control.Name.Equals("txtInputQty"))
                {
                    txtInputQty = re.Control as C1NumericBox;
                    txtInputQty.KeyDown += OnKeyDownOutputQty;
                }
                else if (re.Control.Name.Equals("txtGoodQty"))
                {
                    txtGoodQty = re.Control as C1NumericBox;
                    txtGoodQty.KeyDown += OnKeyDownGoodQty;
                }
                else if (re.Control.Name.Equals("txtLossQty"))
                {
                    txtLossQty = re.Control as C1NumericBox;
                }
                else if (re.Control.Name.Equals("txtWorkTime"))
                {
                    txtWorkTime = re.Control as C1NumericBox;
                }
                else if (re.Control.Name.Equals("txtWorkDate"))
                {
                    txtWorkDate = re.Control as TextBox;
                }
                else if (re.Control.Name.Equals("txtNote"))
                {
                    txtWipNote = re.Control as TextBox;
                }
                else if (re.Control.Name.Equals("txtStartDateTime"))
                {
                    txtStartDateTime = re.Control as TextBox;
                }
                else if (re.Control.Name.Equals("txtEndDateTime"))
                {
                    txtEndDateTime = re.Control as TextBox;
                }
                //else if (re.Control.Name.Equals("dtpWorkDate"))
                //{
                //    dtpWorkDate = re.Control as C1DateTimePicker;
                //    dtpWorkDate.DateTimeChanged += OnDateTimeChanged;
                //    dtpWorkDate.PreviewMouseWheel += OnMouseWheelAction;
                //}
                //else if (re.Control.Name.Equals("dtpEndDateTime"))
                //{
                //    dtpEndDateTime = re.Control as C1DateTimePicker;
                //    dtpEndDateTime.DateTimeChanged += OnDateTimeChanged;
                //}
                else if (re.Control.Name.Equals("chkFinalCut"))
                {
                    chkFinalCut = re.Control as CheckBox;
                }
                else if (re.Control.Name.Equals("chkExtraPress"))
                {
                    chkExtraPress = re.Control as CheckBox;
                }
                else if (re.Control.Name.Equals("txtSrs1Qty"))
                {
                    txtSrs1Qty = re.Control as C1NumericBox;
                    if (txtSrs1Qty.IsEnabled)
                    {
                        txtSrs1Qty.KeyDown += OnKeyDownInOutQty;
                        txtSrs1Qty.LostFocus += OnKeyLostFocusInOutQty;
                    }
                }
                else if (re.Control.Name.Equals("txtSrs2Qty"))
                {
                    txtSrs2Qty = re.Control as C1NumericBox;
                    if (txtSrs2Qty.IsEnabled)
                    {
                        txtSrs2Qty.KeyDown += OnKeyDownInOutQty;
                        txtSrs2Qty.LostFocus += OnKeyLostFocusInOutQty;
                    }
                }
                else if (re.Control.Name.Equals("txtSrs3Qty"))
                {
                    txtSrs3Qty = re.Control as C1NumericBox;
                    if (txtSrs3Qty.IsEnabled)
                    {
                        txtSrs3Qty.KeyDown += OnKeyDownInOutQty;
                        txtSrs3Qty.LostFocus += OnKeyLostFocusInOutQty;
                    }
                }
                else if (re.Control.Name.Equals("cboPet"))
                {
                    cboPet = re.Control as C1ComboBox;
                    GetPet();
                }
                else if (re.Control.Name.Equals("txtBatchId"))
                {
                    txtBatchId = re.Control as TextBox;
                    re.PopupButton.Click += OnClickBatchId;
                }
                else if (re.Control.Name.Equals("txtTank"))
                {
                    txtTank = re.Control as TextBox;
                }
                //else if (re.Control.Name.Equals("txtWorkStartDateTime"))
                //{
                //    txtWorkStartDateTime = re.Control as TextBox;
                //}
                //else if (re.Control.Name.Equals("txtWorkEndDateTime"))
                //{
                //    txtWorkEndDateTime = re.Control as C1DateTimePicker;
                //    txtWorkEndDateTime.DateTimeChanged += OnDateTimeChanged2;
                //}
                else if (re.Control.Name.Equals("txtBeadMillCount"))
                {
                    txtBeadMillCount = re.Control as C1NumericBox;
                }

                if (re.Control is C1NumericBox)
                    re.Control.Style = Application.Current.Resources["C1NumericBoxStyle"] as Style;

                if (re.PopupButton != null)
                {
                    if (re.Control.Name.Equals("txtShift"))
                    {
                        //txtShift = re.Control as TextBox;
                        //re.PopupButton.Click += OnClickShift;
                    }
                    else if (re.Control.Name.Equals("txtWorker"))
                    {
                        //txtWorker = re.Control as TextBox;
                        //re.PopupButton.Click += OnClickWorker;
                    }
                    //else if (re.Control.Name.Equals("txtBackWorker"))
                    //{
                    //    txtBackWorker = re.Control as TextBox;
                    //    re.PopupButton.Click += OnClickWorker;
                    //}
                    //else if (re.Control.Name.Equals("txtRewinderWorker"))
                    //{
                    //    txtRewinderWorker = re.Control as TextBox;
                    //    re.PopupButton.Click += OnClickWorker;
                    //}
                    else if (re.Control.Name.Equals("dgColorTag"))
                    {
                        COLORTAG_GRID = re.Control as C1DataGrid;
                        re.PopupButton.Click += OnClickSaveColorTag;
                    }

                    re.PopupButton.Style = re.Control.Name.Equals("dgColorTag") ? Application.Current.Resources["Content_SaveButtonStyle"] as Style : Application.Current.Resources["Content_SearchButtonStyle"] as Style;
                    re.PopupButton.SetValue(Grid.ColumnProperty, 2);
                }

                var panel = new Grid();

                ColumnDefinition cd = new ColumnDefinition();
                cd.Width = new GridLength(70);
                panel.ColumnDefinitions.Add(cd);

                cd = new ColumnDefinition();
                cd.Width = new GridLength(1, GridUnitType.Star);
                panel.ColumnDefinitions.Add(cd);

                //if (!re.Control.GetType().Name.Equals("C1DateTimePicker"))
                //{
                cd = new ColumnDefinition();
                cd.Width = new GridLength(23);
                panel.ColumnDefinitions.Add(cd);
                //}

                TextBlock title = new TextBlock { Text = ObjectDic.Instance.GetObjectName(re.Title), HorizontalAlignment = HorizontalAlignment.Right, VerticalAlignment = VerticalAlignment.Center };
                title.SetValue(Grid.ColumnProperty, 0);
                panel.Children.Add(title);

                re.Control.SetValue(Grid.ColumnProperty, 1);
                panel.Children.Add(re.Control);

                if (re.PopupButton != null)
                    panel.Children.Add(re.PopupButton);

                if (re.Control.Name.Equals("dgColorTag"))
                {
                    RowDefinition rd = new RowDefinition();
                    rd.Height = new GridLength(1, GridUnitType.Star);
                    panel.RowDefinitions.Add(rd);

                    (re.Control as C1DataGrid).Height = 60;
                    (re.Control as C1DataGrid).VerticalAlignment = VerticalAlignment.Top;
                    (re.Control as C1DataGrid).VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;
                }
                else if (re.Control.Name.Equals("txtNote"))
                {
                    RowDefinition rd = new RowDefinition();
                    rd.Height = new GridLength(1, GridUnitType.Star);
                    panel.RowDefinitions.Add(rd);

                    (re.Control as TextBox).TextWrapping = TextWrapping.WrapWithOverflow;
                    (re.Control as TextBox).Height = 60;
                    (re.Control as TextBox).AcceptsReturn = true;
                    (re.Control as TextBox).VerticalAlignment = VerticalAlignment.Top;
                    (re.Control as TextBox).VerticalScrollBarVisibility = ScrollBarVisibility.Auto;
                }

                if (re.Control is C1DateTimePicker)
                {
                    (re.Control as C1DateTimePicker).TimeFormat = C1TimeEditorFormat.Custom;
                    (re.Control as C1DateTimePicker).DateFormat = C1DatePickerFormat.Short;
                    (re.Control as C1DateTimePicker).CustomDateFormat = "yyyy-MM-dd";
                    (re.Control as C1DateTimePicker).CustomTimeFormat = "HH:mm";
                    (re.Control as C1DateTimePicker).EditMode = C1DateTimePickerEditMode.Date;
                    (re.Control as C1DateTimePicker).MinDate = DateTime.Now.AddDays(-1);
                    (re.Control as C1DateTimePicker).MaxDate = DateTime.Now.AddDays(1);
                    (re.Control as C1DateTimePicker).Margin = new Thickness(3, 0, 0, 0);
                }

                if (re.Control is C1NumericBox || re.Control is CheckBox)
                    re.Control.Margin = new Thickness(3, 0, 0, 0);

                if (re.SpaceInCharge.Equals(elementCountPerRow))
                {
                    if (!colIndex.Equals(0))
                        rowIndex++;

                    colIndex = 0;
                    panel.SetValue(Grid.ColumnSpanProperty, grdElement.ColumnDefinitions.Count);
                }

                panel.SetValue(Grid.RowProperty, rowIndex);
                panel.SetValue(Grid.ColumnProperty, colIndex);

                grdElement.Children.Add(panel);

                colIndex += re.SpaceInCharge;

                if (colIndex % elementCountPerRow == 0)
                    rowIndex++;

                colIndex = colIndex % elementCountPerRow == 0 ? 0 : colIndex;
            }

            if (elemList2.Count > 0)
            {
                totalRowCount = elemList2.Count + 2; //(elemList[elemList.Count - 1].Title.Equals("특이사항") ? 2 : (elemList[elemList.Count - 1].Title.Equals(string.Empty) ? 2 : 1));

                grdElement = (grdResult.Children[0] as UcResult).ResultDetail2;
                grdElement.Children.Clear();

                mod = totalRowCount / elementCountPerRow;
                rem = totalRowCount % elementCountPerRow;

                for (int i = 0; i < mod; i++)
                {
                    var rowDef = new RowDefinition();

                    if (elemList2[elemList2.Count - 1].Control.Name.Equals("txtNote"))
                        rowDef.Height = new GridLength(1, GridUnitType.Star);
                    else
                        rowDef.Height = new GridLength(30);

                    grdElement.RowDefinitions.Add(rowDef);
                }

                if (rem > 0 && elemList2[elemList2.Count - 1].SpaceInCharge > 1)
                {
                    var rowDef = new RowDefinition();
                    rowDef.Height = elemList2[elemList2.Count - 1].SpaceInCharge > 1 ? new GridLength(90) : new GridLength(30);
                    grdElement.RowDefinitions.Add(rowDef);
                }

                for (int i = 0; i < elementCountPerRow; i++)
                {
                    var colDef = new ColumnDefinition();
                    colDef.Width = new GridLength(1, GridUnitType.Star);
                    grdElement.ColumnDefinitions.Add(colDef);
                }

                foreach (ResultElement re in elemList2)
                {
                    if (re.Control.Name.Equals("txtVersion"))
                    {
                        txtVersion = re.Control as TextBox;

                        if (re.PopupButton != null)
                            re.PopupButton.Click += OnClickVersion;
                    }
                    else if (re.Control.Name.Equals("txtLaneQty"))
                    {
                        txtLaneQty = re.Control as C1NumericBox;

                        if (txtLaneQty.IsEnabled)
                        {
                            txtLaneQty.KeyDown += OnKeyDownLaneQty;
                            txtLaneQty.LostFocus += OnKeyLostFocusLaneQty;
                        }
                    }
                    else if (re.Control.Name.Equals("txtLanePatternQty"))
                    {
                        txtLanePatternQty = re.Control as C1NumericBox;
                    }
                    else if (re.Control.Name.Equals("txtInputQty"))
                    {
                        txtInputQty = re.Control as C1NumericBox;
                        txtInputQty.KeyDown += OnKeyDownOutputQty;
                    }
                    else if (re.Control.Name.Equals("txtGoodQty"))
                    {
                        txtGoodQty = re.Control as C1NumericBox;
                        txtGoodQty.KeyDown += OnKeyDownGoodQty;
                    }
                    else if (re.Control.Name.Equals("txtLossQty"))
                    {
                        txtLossQty = re.Control as C1NumericBox;
                    }
                    else if (re.Control.Name.Equals("txtWorkTime"))
                    {
                        txtWorkTime = re.Control as C1NumericBox;
                    }
                    else if (re.Control.Name.Equals("txtWorkDate"))
                    {
                        txtWorkDate = re.Control as TextBox;
                    }
                    else if (re.Control.Name.Equals("txtNote"))
                    {
                        txtWipNote = re.Control as TextBox;
                    }
                    else if (re.Control.Name.Equals("txtStartDateTime"))
                    {
                        txtStartDateTime = re.Control as TextBox;
                    }
                    else if (re.Control.Name.Equals("txtEndDateTime"))
                    {
                        txtEndDateTime = re.Control as TextBox;
                    }
                    //else if (re.Control.Name.Equals("dtpWorkDate"))
                    //{
                    //    dtpWorkDate = re.Control as C1DateTimePicker;
                    //    dtpWorkDate.DateTimeChanged += OnDateTimeChanged;
                    //    dtpWorkDate.PreviewMouseWheel += OnMouseWheelAction;
                    //}
                    //else if (re.Control.Name.Equals("dtpEndDateTime"))
                    //{
                    //    dtpEndDateTime = re.Control as C1DateTimePicker;
                    //    dtpEndDateTime.DateTimeChanged += OnDateTimeChanged;
                    //}
                    else if (re.Control.Name.Equals("chkFinalCut"))
                    {
                        chkFinalCut = re.Control as CheckBox;
                    }
                    else if (re.Control.Name.Equals("chkExtraPress"))
                    {
                        chkExtraPress = re.Control as CheckBox;
                    }
                    else if (re.Control.Name.Equals("txtSrs1Qty"))
                    {
                        txtSrs1Qty = re.Control as C1NumericBox;
                        if (txtSrs1Qty.IsEnabled)
                        {
                            txtSrs1Qty.KeyDown += OnKeyDownInOutQty;
                            txtSrs1Qty.LostFocus += OnKeyLostFocusInOutQty;
                        }
                    }
                    else if (re.Control.Name.Equals("txtSrs2Qty"))
                    {
                        txtSrs2Qty = re.Control as C1NumericBox;
                        if (txtSrs2Qty.IsEnabled)
                        {
                            txtSrs2Qty.KeyDown += OnKeyDownInOutQty;
                            txtSrs2Qty.LostFocus += OnKeyLostFocusInOutQty;
                        }
                    }
                    else if (re.Control.Name.Equals("txtSrs3Qty"))
                    {
                        txtSrs3Qty = re.Control as C1NumericBox;
                        if (txtSrs3Qty.IsEnabled)
                        {
                            txtSrs3Qty.KeyDown += OnKeyDownInOutQty;
                            txtSrs3Qty.LostFocus += OnKeyLostFocusInOutQty;
                        }
                    }
                    else if (re.Control.Name.Equals("cboPet"))
                    {
                        cboPet = re.Control as C1ComboBox;
                        GetPet();
                    }
                    else if (re.Control.Name.Equals("txtBatchId"))
                    {
                        txtBatchId = re.Control as TextBox;
                        re.PopupButton.Click += OnClickBatchId;
                    }
                    else if (re.Control.Name.Equals("txtTank"))
                    {
                        txtTank = re.Control as TextBox;
                    }

                    if (re.Control is C1NumericBox)
                        re.Control.Style = Application.Current.Resources["C1NumericBoxStyle"] as Style;

                    if (re.PopupButton != null)
                    {
                        if (re.Control.Name.Equals("txtShift"))
                        {
                            //txtShift = re.Control as TextBox;
                            //re.PopupButton.Click += OnClickShift;
                        }
                        else if (re.Control.Name.Equals("txtWorker"))
                        {
                            //txtWorker = re.Control as TextBox;
                            //re.PopupButton.Click += OnClickWorker;
                        }
                        //else if (re.Control.Name.Equals("txtBackWorker"))
                        //{
                        //    txtBackWorker = re.Control as TextBox;
                        //    re.PopupButton.Click += OnClickWorker;
                        //}
                        //else if (re.Control.Name.Equals("txtRewinderWorker"))
                        //{
                        //    txtRewinderWorker = re.Control as TextBox;
                        //    re.PopupButton.Click += OnClickWorker;
                        //}
                        else if (re.Control.Name.Equals("dgColorTag"))
                        {
                            COLORTAG_GRID = re.Control as C1DataGrid;
                            re.PopupButton.Click += OnClickSaveColorTag;
                        }

                        re.PopupButton.Style = re.Control.Name.Equals("dgColorTag") ? Application.Current.Resources["Content_SaveButtonStyle"] as Style : Application.Current.Resources["Content_SearchButtonStyle"] as Style;
                        re.PopupButton.SetValue(Grid.ColumnProperty, 2);
                    }

                    var panel = new Grid();

                    ColumnDefinition cd = new ColumnDefinition();
                    cd.Width = new GridLength(70);
                    panel.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(1, GridUnitType.Star);
                    panel.ColumnDefinitions.Add(cd);

                    //if (!re.Control.GetType().Name.Equals("C1DateTimePicker"))
                    //{
                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(23);
                    panel.ColumnDefinitions.Add(cd);
                    //}

                    TextBlock title = new TextBlock { Text = ObjectDic.Instance.GetObjectName(re.Title), HorizontalAlignment = HorizontalAlignment.Right, VerticalAlignment = VerticalAlignment.Center };
                    title.SetValue(Grid.ColumnProperty, 0);
                    panel.Children.Add(title);

                    re.Control.SetValue(Grid.ColumnProperty, 1);
                    panel.Children.Add(re.Control);

                    if (re.PopupButton != null)
                        panel.Children.Add(re.PopupButton);

                    if (re.Control.Name.Equals("dgColorTag"))
                    {
                        RowDefinition rd = new RowDefinition();
                        rd.Height = new GridLength(1, GridUnitType.Star);
                        panel.RowDefinitions.Add(rd);

                        (re.Control as C1DataGrid).Height = 60;
                        (re.Control as C1DataGrid).VerticalAlignment = VerticalAlignment.Top;
                        (re.Control as C1DataGrid).VerticalScrollBarVisibility = ScrollBarVisibility.Hidden;
                    }
                    else if (re.Control.Name.Equals("txtNote"))
                    {
                        RowDefinition rd = new RowDefinition();
                        rd.Height = new GridLength(1, GridUnitType.Star);
                        panel.RowDefinitions.Add(rd);

                        (re.Control as TextBox).TextWrapping = TextWrapping.WrapWithOverflow;
                        (re.Control as TextBox).Height = 60;
                        (re.Control as TextBox).AcceptsReturn = true;
                        (re.Control as TextBox).VerticalAlignment = VerticalAlignment.Top;
                        (re.Control as TextBox).VerticalScrollBarVisibility = ScrollBarVisibility.Auto;
                    }

                    if (re.Control is C1DateTimePicker)
                    {
                        (re.Control as C1DateTimePicker).TimeFormat = C1TimeEditorFormat.Custom;
                        (re.Control as C1DateTimePicker).DateFormat = C1DatePickerFormat.Custom;
                        (re.Control as C1DateTimePicker).CustomDateFormat = "yyyy-MM-dd";
                        (re.Control as C1DateTimePicker).CustomTimeFormat = "HH:mm";
                        (re.Control as C1DateTimePicker).EditMode = C1DateTimePickerEditMode.Date;
                        (re.Control as C1DateTimePicker).MinDate = DateTime.Now.AddDays(-1);
                        (re.Control as C1DateTimePicker).MaxDate = DateTime.Now.AddDays(1);
                        (re.Control as C1DateTimePicker).Margin = new Thickness(3, 0, 0, 0);
                    }

                    if (re.Control is C1NumericBox || re.Control is CheckBox)
                        re.Control.Margin = new Thickness(3, 0, 0, 0);

                    if (re.SpaceInCharge.Equals(elementCountPerRow))
                    {
                        if (!colIndex2.Equals(0))
                            rowIndex2++;

                        colIndex2 = 0;
                        panel.SetValue(Grid.ColumnSpanProperty, grdElement.ColumnDefinitions.Count);
                    }

                    panel.SetValue(Grid.RowProperty, rowIndex2);
                    panel.SetValue(Grid.ColumnProperty, colIndex2);

                    grdElement.Children.Add(panel);

                    colIndex2 += re.SpaceInCharge;

                    if (colIndex2 % elementCountPerRow == 0)
                        rowIndex2++;

                    colIndex2 = colIndex2 % elementCountPerRow == 0 ? 0 : colIndex2;
                }

                (grdResult.Children[0] as UcResult).ResultDetail2.Visibility = Visibility.Collapsed;
            }

            // 좌측 하단 Grid에 Coater Foil, Slurry 추가 (2017-01-11) CR-42
            if (elemList3.Count > 0)
            {
                //SetCoaterResult(elemList3, (grdResult.Children[0] as UcResult).ResultDetail, elementCountPerRow, rowIndex, colIndex);                
                SetCoaterResult(elemList3, (grdResult.Children[0] as UcResult).CoaterSlurry, elementCountPerRow);

                if (elemList2.Count > 0)
                {
                    //SetCoaterResult(ResultElementList.SlurryAndCoreList(elementCountPerRow), (grdResult.Children[0] as UcResult).ResultDetail2, elementCountPerRow, rowIndex2, colIndex2);
                    //SetCoaterResult(ResultElementList.SlurryAndCoreList(elementCountPerRow), (grdResult.Children[0] as UcResult).CoaterSlurry2, elementCountPerRow);
                    SetCoaterResult(elemList4, (grdResult.Children[0] as UcResult).CoaterSlurry2, elementCountPerRow);
                    (grdResult.Children[0] as UcResult).CoaterSlurry2.Visibility = Visibility.Collapsed;
                }
            }
        }

        //void SetCoaterResult(List<ResultElement> elementList, Grid gridEelement, int elementCountRow, int rowIndex, int colIndex)
        void SetCoaterResult(List<ResultElement> elementList, Grid grid, int elementCountRow)
        {
            // 좌측 하단 Grid에 Coater Foil, Slurry 추가 (2017-01-11) CR-42
            /*
            Grid grid = new Grid();
            grid.Name = "dgCoater";
            grid.SetValue(Grid.RowProperty, 5);
            grid.SetValue(Grid.ColumnProperty, 1);
            */
            //grid.SetValue(Grid.ColumnSpanProperty, elementCountRow);
            grid.SetValue(Grid.VerticalAlignmentProperty, VerticalAlignment.Bottom);

            int rowIndex = 0;
            int colIndex = 0;
            int totalRowCount = elementList.Count;

            int mod = (totalRowCount / elementCountRow) + 1;

            for (int i = 0; i < mod; i++)
            {
                var rowDef = new RowDefinition();
                rowDef.Height = new GridLength(30);
                grid.RowDefinitions.Add(rowDef);
            }

            for (int i = 1; i <= elementCountRow; i++)
            {
                var colDef = new ColumnDefinition();
                if (i == 3)
                {
                    colDef.Width = new GridLength(160);
                }
                else
                {
                    colDef.Width = new GridLength(1, GridUnitType.Star);
                }
                grid.ColumnDefinitions.Add(colDef);
            }

            // BOARDER 추가
            Border border = new Border();
            border.SetValue(Grid.RowProperty, rowIndex);
            border.SetValue(Grid.ColumnProperty, colIndex);
            border.SetValue(Grid.ColumnSpanProperty, elementCountRow);
            border.SetValue(Grid.VerticalAlignmentProperty, VerticalAlignment.Top);
            border.SetValue(Border.BorderThicknessProperty, new Thickness(0, 2, 0, 0));
            //border.SetValue(Border.BorderBrushProperty, Brushes.Red);
            BrushConverter converter = new BrushConverter();
            border.BorderBrush = converter.ConvertFromString("#ee5283") as Brush;
            grid.Children.Add(border);

            foreach (ResultElement re in elementList)
            {
                if (re.Control.Name.Equals("txtCore1"))
                {
                    txtCore1 = re.Control as TextBox;

                    if (re.radButton != null)
                        re.radButton.Checked += OnCheckFoilChecked;
                    if (re.PopupButton != null)
                        re.PopupButton.Click += OnClickTopLotOpen;
                }
                else if (re.Control.Name.Equals("txtCore2"))
                {
                    txtCore2 = re.Control as TextBox;

                    if (re.radButton != null)
                        re.radButton.Checked += OnCheckFoilChecked;
                    if (re.PopupButton != null)
                        re.PopupButton.Click += OnClickTopLotOpen;
                }
                else if (re.Control.Name.Equals("txtSlurry1"))
                {
                    txtSlurry1 = re.Control as TextBox;
                    txtSlurry11 = re.Control2 as TextBox;

                    if (re.PopupButton != null)
                        re.PopupButton.Click += OnClickSlurryOpen;

                    if (re.PopupButton2 != null)
                        re.PopupButton2.Click += OnClickSlurryOpen;

                }
                else if (re.Control.Name.Equals("txtSlurry2"))
                {
                    txtSlurry2 = re.Control as TextBox;
                    txtSlurry22 = re.Control2 as TextBox;

                    if (re.PopupButton != null)
                        re.PopupButton.Click += OnClickSlurryOpen;

                    if (re.PopupButton2 != null)
                        re.PopupButton2.Click += OnClickSlurryOpen;
                }
                else if (re.Control.Name.Equals("btnMtrlChange"))
                {
                    btnMtrlChange = re.Control as Button;
                    btnMtrlChange.Click += OnClickMtrlChange;
                }
                else if (re.Control.Name.Equals("btnMtrlChange2"))
                {
                    btnMtrlChange2 = re.Control as Button;
                    btnMtrlChange2.Click += OnClickMtrlChange2;
                }

                if (re.PopupButton != null)
                {
                    re.PopupButton.Style = Application.Current.Resources["Content_SearchButtonStyle"] as Style;
                    re.PopupButton.SetValue(Grid.ColumnProperty, 2);
                }

                if (re.PopupButton2 != null)
                {
                    re.PopupButton2.Style = Application.Current.Resources["Content_SearchButtonStyle"] as Style;
                    re.PopupButton2.SetValue(Grid.ColumnProperty, 4);
                }

                if (re.radButton != null)
                {
                    re.radButton.SetValue(Grid.ColumnProperty, 2);
                }

                var panel = new Grid();

                ColumnDefinition cd = new ColumnDefinition();
                cd.Width = new GridLength(70);
                panel.ColumnDefinitions.Add(cd);

                cd = new ColumnDefinition();
                cd.Width = new GridLength(1, GridUnitType.Star);
                panel.ColumnDefinitions.Add(cd);

                cd = new ColumnDefinition();
                cd.Width = new GridLength(23);
                panel.ColumnDefinitions.Add(cd);

                if (!re.Control.GetType().Name.Equals("Button"))
                {
                    cd = new ColumnDefinition();
                    if (isDoubleLayer) //더블레이어 일때 적용
                    {
                        cd.Width = new GridLength(1, GridUnitType.Star);
                    }
                    else
                    {
                        cd.Width = new GridLength(23);
                    }
                    panel.ColumnDefinitions.Add(cd);

                    cd = new ColumnDefinition();
                    cd.Width = new GridLength(23);
                    panel.ColumnDefinitions.Add(cd);
                }
                else
                {
                    re.Control.Style = Application.Current.Resources["Content_MainButtonNoMinWidthSpecialStyle"] as Style;
                }

                TextBlock title = new TextBlock { Text = re.Title, HorizontalAlignment = HorizontalAlignment.Right, VerticalAlignment = VerticalAlignment.Center };
                title.SetValue(Grid.ColumnProperty, 0);
                panel.Children.Add(title);

                int seq = 1;
                re.Control.SetValue(Grid.ColumnProperty, seq);
                panel.Children.Add(re.Control);
                seq++;

                if (re.PopupButton != null && re.radButton != null)
                {
                    re.PopupButton.SetValue(Grid.ColumnProperty, seq);
                    panel.Children.Add(re.PopupButton);
                    seq++;

                    re.radButton.SetValue(Grid.ColumnProperty, seq);
                    panel.Children.Add(re.radButton);
                    seq++;
                }
                else
                {
                    if (re.PopupButton != null)
                    {
                        re.PopupButton.SetValue(Grid.ColumnProperty, seq);
                        re.PopupButton.SetValue(Grid.ColumnSpanProperty, seq);
                        panel.Children.Add(re.PopupButton);
                        seq++;
                    }
                    else if (re.radButton != null)
                    {
                        re.radButton.SetValue(Grid.ColumnProperty, seq);
                        re.radButton.SetValue(Grid.ColumnSpanProperty, seq);
                        panel.Children.Add(re.radButton);
                        seq++;
                    }
                }

                if (re.Control2 != null)
                {
                    //seq--;
                    re.Control2.SetValue(Grid.ColumnProperty, seq);
                    panel.Children.Add(re.Control2);
                    seq++;
                }

                if (re.PopupButton2 != null)
                {
                    re.PopupButton2.SetValue(Grid.ColumnProperty, seq);
                    panel.Children.Add(re.PopupButton2);
                    seq++;
                }

                if (re.IsNewLine)
                {
                    rowIndex++;
                    colIndex = 0;
                }

                panel.SetValue(Grid.RowProperty, rowIndex);
                panel.SetValue(Grid.ColumnProperty, colIndex);

                grid.Children.Add(panel);

                colIndex += re.SpaceInCharge;
            }

            //(grdResult.Children[0] as UcResult).dgResultMain.Children.Add(grid);
        }

        void SetColorTagInfo()
        {
            DataTable dtIn = new DataTable();
            dtIn.Columns.Add("LANGID", typeof(string));
            dtIn.Columns.Add("AREAID", typeof(string));
            dtIn.Columns.Add("EQPTID", typeof(string));

            DataRow drIn = dtIn.NewRow();
            drIn["LANGID"] = LoginInfo.LANGID;
            drIn["AREAID"] = LoginInfo.CFG_AREA_ID;
            drIn["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
            dtIn.Rows.Add(drIn);

            DataTable dtColorTag = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_COLORTAG", "RQSTDT", "RSLTDT", dtIn);

            if (dtColorTag.Rows.Count > 0)
            {
                COLORTAG_GRID.Columns.Clear();

                DataTable dtTag = new DataTable();

                for (int i = 0; i < dtColorTag.Rows.Count; i++)
                {
                    Util.SetGridColumnNumeric(COLORTAG_GRID, dtColorTag.Rows[i]["CLCTITEM"].ToString(), null, dtColorTag.Rows[i]["CLCTNAME"].ToString(), false, false, false, false, -1, HorizontalAlignment.Right, Visibility.Visible, GetUnitFormatted());
                    dtTag.Columns.Add(dtColorTag.Rows[i]["CLCTITEM"].ToString());
                }

                DataRow dr = dtTag.NewRow();
                dtTag.Rows.Add(dr);
                Util.GridSetData(COLORTAG_GRID, dtTag, FrameOperation, true);
            }
        }

        private void GetWorkOrder()
        {
            UC_WORKORDER wo1;
            UC_WORKORDER_MX wo2;

            ClearControls();

            if (grdWorkOrder.Children[0] is UC_WORKORDER)
            {
                wo1 = grdWorkOrder.Children[0] as UC_WORKORDER;

                wo1.FrameOperation = FrameOperation;
                wo1._UCElec = this;
                wo1.EQPTSEGMENT = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                wo1.EQPTID = EQUIPMENT_COMBO.SelectedValue.ToString();
                wo1.PROCID = procId;

                if (string.Equals(procId, Process.COATING) && isSingleCoater == true)
                    wo1.COATSIDETYPE = Util.NVC(COATTYPE_COMBO.SelectedValue);

                wo1.GetWorkOrder();
            }
            else
            {
                wo2 = grdWorkOrder.Children[0] as UC_WORKORDER_MX;

                wo2.FrameOperation = FrameOperation;
                wo2._UCElec = this;
                wo2.EQPTSEGMENT = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                wo2.EQPTID = EQUIPMENT_COMBO.SelectedValue.ToString();
                wo2.PROCID = procId;
                wo2.GetWorkOrder();
            }

            if ((string.Equals(procId, Process.MIXING)|| string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.SRS_MIXING)) && (grdWorkOrder.Children[0] as UC_WORKORDER_MX) != null)
            {
                WORKORDER_GRID = (grdWorkOrder.Children[0] as UC_WORKORDER_MX).dgWorkOrder;
            }
            else
            {
                WORKORDER_GRID = (grdWorkOrder.Children[0] as UC_WORKORDER).dgWorkOrder;
            }

            // (C20200423-000245) 단면코더 작업지시 변경 시 Core 자동탈착(PRDT_CLSS_CODE : APC, INPUT_LOTID : B1으로 끝나는 LOTID)
            if (isSingleCoater && string.Equals(Util.NVC(COATTYPE_COMBO.SelectedValue), "B"))
            {
                if (CommonVerify.HasDataGridRow(WORKORDER_GRID))
                {
                    _FINDWOID = GetEioAttr(Util.NVC(EQUIPMENT_COMBO.SelectedValue));

                    DataTable dt = new DataTable();
                    dt = (WORKORDER_GRID.ItemsSource as DataView).Table;

                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        if (string.Equals(Util.NVC(dt.Rows[i]["EIO_WO_SEL_STAT"]), "Y"))
                        {
                            _FINDWOID = Util.NVC(dt.Rows[i]["WOID"]);
                            break;
                        }
                    }
                }
            }
        }

        private void GetWorkOrderNotClear()
        {
            UC_WORKORDER wo1;
            UC_WORKORDER_MX wo2;

            if (grdWorkOrder.Children[0] is UC_WORKORDER)
            {
                wo1 = grdWorkOrder.Children[0] as UC_WORKORDER;

                wo1.FrameOperation = FrameOperation;
                wo1._UCElec = this;
                wo1.EQPTSEGMENT = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                wo1.EQPTID = EQUIPMENT_COMBO.SelectedValue.ToString();
                wo1.PROCID = procId;

                if (string.Equals(procId, Process.COATING) && isSingleCoater == true)
                    wo1.COATSIDETYPE = Util.NVC(COATTYPE_COMBO.SelectedValue);

                wo1.GetWorkOrder();
            }
            else
            {
                wo2 = grdWorkOrder.Children[0] as UC_WORKORDER_MX;

                wo2.FrameOperation = FrameOperation;
                wo2._UCElec = this;
                wo2.EQPTSEGMENT = EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString();
                wo2.EQPTID = EQUIPMENT_COMBO.SelectedValue.ToString();
                wo2.PROCID = procId;
                wo2.GetWorkOrder();
            }

            if ((string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.SRS_MIXING)) && (grdWorkOrder.Children[0] as UC_WORKORDER_MX) != null)
            {
                WORKORDER_GRID = (grdWorkOrder.Children[0] as UC_WORKORDER_MX).dgWorkOrder;
            }
            else
            {
                WORKORDER_GRID = (grdWorkOrder.Children[0] as UC_WORKORDER).dgWorkOrder;
            }
        }

        private void GetLargeLot()
        {
            try
            {
                // 다른화면 갔다가 다시 오는 경우.. combobox 등 모두 Reset 되는 문제로 조회 가능 여부 체크...
                if (!CanSearch())
                    return;

                //loadingIndicator.Visibility = Visibility.Visible;

                string sPrvLot = string.Empty;

                if (PRODLOT_GRID.ItemsSource != null && PRODLOT_GRID.Rows.Count > 0)
                {
                    int idx = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                    if (idx >= 0)
                        sPrvLot = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[idx].DataItem, "LOTID"));
                }

                ClearControls();

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("COAT_SIDE_TYPE", typeof(string));
                IndataTable.Columns.Add("LANGID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["PROCID"] = procId;
                Indata["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();

                if (isSingleCoater)
                    Indata["COAT_SIDE_TYPE"] = Util.NVC(COATTYPE_COMBO.SelectedValue);

                Indata["LANGID"] = LoginInfo.LANGID;

                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync(GetLargeLotBizRuleName(), "INDATA", "RSLTDT", IndataTable);
                Util.GridSetData(LARGELOT_GRID, dtResult, FrameOperation, true);

                //loadingIndicator.Visibility = Visibility.Collapsed;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void GetProductLot(DataRowView drv = null)
        {
            try
            {
                string ValueToCondition = string.Empty;
                var sCond = new List<string>();

                SetStatus();

                if (string.IsNullOrEmpty(WIPSTATUS))
                {
                    //Util.AlertInfo("SFU1438");      //WIP 상태를 선택하세요.
                    Util.MessageValidation("SFU1438");  //WIP 상태를 선택하세요.
                    return;
                }

                if (procId.Equals(Process.ROLL_PRESSING))
                    chkExtraPress.Visibility = Visibility.Visible;

                // SLITTER CUT기준으로 변경으로 인하여 LOT ID -> CUT ID로 표기 ( 2017-01-21 ) CR-53
                // 슬리터 2차 추가 2021-09-15 by 오화백
                if ((string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING)) && !string.Equals(WIPSTATUS, Wip_State.WAIT))
                {
                    PRODLOT_GRID.Columns["CUT_ID"].Visibility = Visibility.Visible;
                    PRODLOT_GRID.Columns["LOTID"].Visibility = Visibility.Collapsed;
                }
                else
                {
                    PRODLOT_GRID.Columns["CUT_ID"].Visibility = Visibility.Collapsed;
                    PRODLOT_GRID.Columns["LOTID"].Visibility = Visibility.Visible;
                }

                // 다른화면 갔다가 다시 오는 경우.. combobox 등 모두 Reset 되는 문제로 조회 가능 여부 체크...
                if (!CanSearch())
                    return;

                //loadingIndicator.Visibility = Visibility.Visible;

                string sPrvLot = string.Empty;

                if (PRODLOT_GRID.ItemsSource != null && PRODLOT_GRID.Rows.Count > 0)
                {
                    int idx = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                    if (idx >= 0)
                        sPrvLot = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[idx].DataItem, "LOTID"));
                }

                ClearControls();

                Util.gridClear(PRODLOT_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("LOTID_LARGE", typeof(string));
                IndataTable.Columns.Add("WIPSTAT", typeof(string));
                IndataTable.Columns.Add("EQSGID", typeof(string));
                IndataTable.Columns.Add("COATSIDE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["PROCID"] = procId;
                Indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);

                if (drv != null)
                    Indata["LOTID_LARGE"] = drv["LOTID_LARGE"].ToString();

                Indata["WIPSTAT"] = WIPSTATUS;

                //Indata["EQSGID"] = LoginInfo.CFG_EQSG_ID;
                Indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);  // 자동차 전극은 EQSG가 2개라서 변경 가능하기 때문에 선택된 걸로 변경 ( 2017-01-20 )

                if (isSingleCoater || procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING))
                    Indata["COATSIDE"] = COATTYPE_COMBO.SelectedValue;

                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync(GetProdLotBizRuleName(), "INDATA", "RSLTDT", IndataTable);
                Util.GridSetData(PRODLOT_GRID, dtResult, FrameOperation, true);

                //2019.08.20 김대근 LoadedCellPresenter 이벤트로 이동.
                //loadingIndicator.Visibility = Visibility.Collapsed;

                // 믹스 실적 확정 메시지 Timer CSR[C20201014-000233]
                if (string.Equals(procId, Process.MIXING) && dtResult.Rows.Count > 0 )
                {
                    MixTimer_Start();
                }              
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void MixTimer_Start()
        {
            //팝업 설정 Area 조회
            DataTable InData = new DataTable();
            InData.TableName = "RQSTDT";
            InData.Columns.Add("LANGID", typeof(string));
            InData.Columns.Add("CMCDTYPE", typeof(string));
            InData.Columns.Add("CMCODE", typeof(string));

            DataRow dr = InData.NewRow();
            dr["LANGID"] = LoginInfo.LANGID;
            dr["CMCDTYPE"] = "MIX_TIMER_POPUP";
            dr["CMCODE"] = LoginInfo.CFG_AREA_ID;
            InData.Rows.Add(dr);

            DataTable dtMsgArea = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", InData);

            if (dtMsgArea.Rows.Count == 0)
                return;

            //Timer 중복 Start 방지위함
            if (isTimerCheck == false)
            {
                Mix_Timer.Start();
                isTimerCheck = true;
            }
        }

        private void MixTimer_Tick(object sender, EventArgs e)
        {
            if (sender == null)
                return;

            if (PRODLOT_GRID.ItemsSource == null || PRODLOT_GRID.Rows.Count <= 0)
                return;

            isTimerTabCk = false;
            //Menuid 값 가져오기
            string MENUID = Convert.ToString(DataTableConverter.GetValue(DataContext, "MENUID"));
            //Tab중 믹서 공정 UI화면 존재 확인
            foreach (Grid tmp in Util.FindVisualChildren<System.Windows.Controls.Grid>(Application.Current.MainWindow))
            {
                if (tmp.Name == "grdMain")
                {
                    foreach (UIElement ui in tmp.Children)
                    {
                        C1TabControl tabCtrl = ui as C1TabControl;

                        if (tabCtrl != null)
                        {
                            for (int i = 0; i < tabCtrl.Items.Count; i++)
                            {
                                C1TabItem tabItem = tabCtrl.Items[i] as C1TabItem;

                                if (MENUID.Equals(DataTableConverter.GetValue(tabItem.DataContext, "MENUID")))
                                {
                                    isTimerTabCk = true;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
           
            //믹서 공정진척 UI 종료되면 Timer Stop처리
            if (isTimerTabCk == false)
            {
                Mix_Timer.Stop();
                return;
            }

            // DB 서버 시간 조회
            DataTable dtResult = new ClientProxy().ExecuteServiceSync_Multi("BR_CUS_GET_SYSTIME", "", "OUTDATA", new DataSet()).Tables["OUTDATA"];
            string cutTime = Convert.ToDateTime(dtResult.Rows[0]["SYSTIME"]).ToString("HH:mm").Replace(":", "");

            #region TEST용 쿼리
            /*
            //TEST용 쿼리
            //팝업 설정 시간 조회
            DataTable RQSTDT = new DataTable();
            RQSTDT.TableName = "RQSTDT";
            RQSTDT.Columns.Add("LANGID", typeof(string));
            RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
            RQSTDT.Columns.Add("CMCODE", typeof(string));

            DataRow dr = RQSTDT.NewRow();
            dr["LANGID"] = LoginInfo.LANGID;
            dr["CMCDTYPE"] = "MIX_TIMER_POPUP";
            dr["CMCODE"] = "MIX_TIME";
            RQSTDT.Rows.Add(dr);

            DataTable dtResult2 = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

            if (dtResult2.Rows.Count == 0)
                return;

            string sTime = dtResult2.Rows[0]["ATTRIBUTE1"].ToString();
            string eTime = dtResult2.Rows[0]["ATTRIBUTE2"].ToString();
            
            */
            #endregion

            //Area별 CutOff 시간 조회
            DataTable RQSTDT = new DataTable();
            RQSTDT.TableName = "RQSTDT";
            RQSTDT.Columns.Add("AREAID", typeof(string));

            DataRow dr = RQSTDT.NewRow();
            dr["AREAID"] = LoginInfo.CFG_AREA_ID;
            RQSTDT.Rows.Add(dr);

            DataTable dtResult2 = new ClientProxy().ExecuteServiceSync("CUS_SEL_AREAATTR", "RQSTDT", "RSLTDT", RQSTDT);

            if (dtResult2.Rows.Count == 0)
                return;

            //CutOff 시간보다 15분 전 부터 시작
            string sTime = Convert.ToString(Convert.ToInt16(Util.NVC(dtResult2.Rows[0]["S02"]).Substring(0, 4)) - 17); 
            string eTime = Util.NVC(dtResult2.Rows[0]["S02"]).Substring(0, 4);

            //Cutoff 시간 15분전 부터 메시지 실행
            if (Convert.ToInt16(cutTime) >= Convert.ToInt32(sTime) && Convert.ToInt16(cutTime) <= Convert.ToInt32(eTime))
            {
                //믹스 공정UI 존재하지만 비활성화 이면 Tab 활성화 처리
                foreach (Grid tmp in Util.FindVisualChildren<System.Windows.Controls.Grid>(Application.Current.MainWindow))
                {
                    if (tmp.Name == "grdMain")
                    {
                        foreach (UIElement ui in tmp.Children)
                        {
                            C1TabControl tabCtrl = ui as C1TabControl;

                            if (tabCtrl != null)
                            {
                                for (int i = 0; i < tabCtrl.Items.Count; i++)
                                {
                                    C1TabItem tabItem = tabCtrl.Items[i] as C1TabItem;

                                    if (MENUID.Equals(DataTableConverter.GetValue(tabItem.DataContext, "MENUID")))
                                    {
                                        tabCtrl.SelectedIndex = i;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                for (int j = 0; j < PRODLOT_GRID.Rows.Count; j++)
                {
                    if (Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[j].DataItem, "WIPSTAT")).Equals("EQPT_END"))
                    {
                        //메시지 팝업 이중 처리 방지
                        if (isTimerPopup == true)
                            return;

                        Util.MessageInfo("SFU8293", (result) =>     //실적 확정 요청 메시지
                        {
                            if (result == MessageBoxResult.OK)
                            {
                                isTimerPopup = false;
                            }
                        }, isTimerPopup = true);
                        break;       
                    }
                }
            }
        }


        private bool CanSearch()
        {
            bool bRet = false;

            if (EQUIPMENTSEGMENT_COMBO.SelectedIndex < 0 || EQUIPMENTSEGMENT_COMBO.SelectedValue.ToString().Trim().Equals("SELECT"))
            {
                Util.MessageValidation("SFU1223");  //라인을 선택 하세요.
                return bRet;
            }

            if (EQUIPMENT_COMBO.SelectedIndex < 0 || EQUIPMENT_COMBO.SelectedValue.ToString().Trim().Equals("SELECT"))
            {
                Util.MessageValidation("SFU1673");  //설비를 선택 하세요.
                return bRet;
            }
            bRet = true;
            return bRet;
        }

        private bool SetCheckProdListSameChildSeq(C1.WPF.DataGrid.DataGridRow dataitem, bool bUncheckAll = false)
        {
            if (dataitem == null || dataitem.Index < 0 || dataitem.DataItem == null)
                return false;

            DataRowView drv = dataitem.DataItem as DataRowView;
            string sInputLot;
            string sChildSeq;
            string sLot;

            try
            {
                sInputLot = drv["LOTID_PR"].ToString().Equals(string.Empty) ? drv["LOTID"].ToString() : drv["LOTID_PR"].ToString();
            }
            catch
            {
                sInputLot = string.Empty;
            }

            try
            {
                sChildSeq = string.IsNullOrEmpty(drv["CUT_ID"].ToString()) ? "1" : drv["CUT_ID"].ToString();
            }
            catch
            {
                sChildSeq = "1";
            }

            try
            {
                sLot = drv["LOTID"].ToString();
            }
            catch
            {
                sLot = string.Empty;
            }

            if (!string.IsNullOrEmpty(sInputLot) && !string.IsNullOrEmpty(sChildSeq))
            {
                // 모두 Uncheck 처리 및 동일 자LOT의 경우는 Check 처리.
                for (int i = 0; i < PRODLOT_GRID.Rows.Count; i++)
                {
                    if (dataitem.Index != i)
                    {
                        if (sInputLot == Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[i].DataItem, "LOTID_PR")) &&
                            sChildSeq == Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[i].DataItem, "CUT_ID")))
                        {
                            if (sInputLot.Equals(""))
                            {
                                if (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter != null &&
                                    PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content != null &&
                                    (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox) != null)
                                    (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox).IsChecked = false;

                                DataTableConverter.SetValue(PRODLOT_GRID.Rows[i].DataItem, "CHK", false);
                            }
                            else
                            {
                                if (bUncheckAll)
                                {
                                    if (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter != null &&
                                    PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content != null &&
                                    (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox) != null)
                                        (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox).IsChecked = false;

                                    DataTableConverter.SetValue(PRODLOT_GRID.Rows[i].DataItem, "CHK", false);
                                }
                                else
                                {
                                    // CNA에 같은 대LOT에 같은 GR_SEQ로 COATER LOT이 2개씩 생성되어 SLITTER계열만 동일 선택 처리 [2017-07-05]
                                    // 슬리터2차 추가 2021-09-15 by 오화백
                                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                                    {
                                        if (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter != null &&
                                            PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content != null &&
                                            (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox) != null)
                                            (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox).IsChecked = true;

                                        DataTableConverter.SetValue(PRODLOT_GRID.Rows[i].DataItem, "CHK", true);
                                    }
                                    else if(!string.Equals(sLot, Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[i].DataItem, "LOTID"))))
                                    {
                                        if (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter != null &&
                                            PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content != null &&
                                            (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox) != null)
                                            (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox).IsChecked = false;

                                        DataTableConverter.SetValue(PRODLOT_GRID.Rows[i].DataItem, "CHK", false);
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter != null &&
                                PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content != null &&
                                (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox) != null)
                                (PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index).Presenter.Content as CheckBox).IsChecked = false;

                            DataTableConverter.SetValue(PRODLOT_GRID.Rows[i].DataItem, "CHK", false);
                        }
                    }
                }
            }
            return true;
        }

        public void RunProcess(string ValueToLotID)
        {
            if (procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING))
            {
                try
                {
                    Util.MessageConfirm("SFU1240", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            DataTable eqpt_mount = new DataTable();
                            eqpt_mount.Columns.Add("EQPTID", typeof(string));

                            DataRow eqpt_mount_row = eqpt_mount.NewRow();
                            eqpt_mount_row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            eqpt_mount.Rows.Add(eqpt_mount_row);

                            DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                            if (EQPT_PSTN_ID.Rows.Count > 0)
                            {
                                eqptMountPositionCode = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"].ToString();
                            }
                            else
                            {
                                Util.MessageValidation("SFU1397");  //MMD에 설비 투입 위치를 입력해 주세요.
                                return;
                            }

                            DataSet inDataSet = new DataSet();
                            DataRow inLotDataRow;
                            DataRow inMtrlDataRow;

                            #region MESSAGE SET
                            DataTable inLotDataTable = inDataSet.Tables.Add("IN_EQP");

                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            inLotDataTable.Columns.Add("USERID", typeof(string));
                            inLotDataTable.Columns.Add("COAT_SIDE_TYPE", typeof(string));

                            inLotDataRow = inLotDataTable.NewRow();

                            inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inLotDataRow["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            inLotDataRow["USERID"] = LoginInfo.USERID;
                            inLotDataRow["COAT_SIDE_TYPE"] = COATTYPE_COMBO.SelectedValue;

                            inLotDataTable.Rows.Add(inLotDataRow);

                            DataTable InMtrldataTable = inDataSet.Tables.Add("IN_INPUT");
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                            InMtrldataTable.Columns.Add("INPUT_LOTID", typeof(string));

                            inMtrlDataRow = InMtrldataTable.NewRow();
                            inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = eqptMountPositionCode;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                            inMtrlDataRow["INPUT_LOTID"] = ValueToLotID;

                            InMtrldataTable.Rows.Add(inMtrlDataRow);
                            #endregion

                            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_START_LOT_IC", "IN_EQP,IN_INPUT", "OUT_LOT", (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_START_LOT_IC", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }

                                Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                REFRESH = true;
                            }, inDataSet);
                        }
                    });
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
            else if (procId.Equals(Process.HALF_SLITTING))
            {
                try
                {
                    Util.MessageConfirm("SFU1240", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            DataTable eqpt_mount = new DataTable();
                            eqpt_mount.Columns.Add("EQPTID", typeof(string));

                            DataRow eqpt_mount_row = eqpt_mount.NewRow();
                            eqpt_mount_row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            eqpt_mount.Rows.Add(eqpt_mount_row);

                            DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                            if (EQPT_PSTN_ID.Rows.Count > 0)
                            {
                                eqptMountPositionCode = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"].ToString();
                            }
                            else
                            {
                                Util.MessageValidation("SFU1397");  //MMD에 설비 투입 위치를 입력해 주세요.
                                return;
                            }

                            DataSet inDataSet = new DataSet();
                            DataRow inLotDataRow;
                            DataRow inMtrlDataRow;

                            #region MESSAGE SET
                            DataTable inLotDataTable = inDataSet.Tables.Add("IN_EQP");

                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            inLotDataTable.Columns.Add("USERID", typeof(string));

                            inLotDataRow = inLotDataTable.NewRow();

                            inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inLotDataRow["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            inLotDataRow["USERID"] = LoginInfo.USERID;

                            inLotDataTable.Rows.Add(inLotDataRow);

                            DataTable InMtrldataTable = inDataSet.Tables.Add("IN_INPUT");
                            InMtrldataTable.Columns.Add("INPUT_LOTID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));

                            inMtrlDataRow = InMtrldataTable.NewRow();
                            inMtrlDataRow["INPUT_LOTID"] = ValueToLotID;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = eqptMountPositionCode;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";

                            InMtrldataTable.Rows.Add(inMtrlDataRow);
                            #endregion

                            new ClientProxy().ExecuteService_Multi(GetStartLotBizRuleName(), "IN_EQP,IN_INPUT", "RSLTDT", (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz(GetStartLotBizRuleName(), ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }

                                Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                REFRESH = true;

                            }, inDataSet);
                        }
                    });
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
            else if (procId.Equals(Process.SLITTING))
            {
                try
                {
                    bool isQCPopUp = true;

                    Util.MessageConfirm("SFU1240", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            DataSet inDataSet = new DataSet();

                            #region MESSAGE SET
                            DataTable inLotDataTable = inDataSet.Tables.Add("IN_EQP");
                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            //inLotDataTable.Columns.Add("LANE_QTY", typeof(Int32));
                            inLotDataTable.Columns.Add("USERID", typeof(string));

                            DataRow inLotDataRow = null;
                            inLotDataRow = inLotDataTable.NewRow();
                            inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inLotDataRow["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            //inLotDataRow["LANE_QTY"] = string.IsNullOrEmpty(_LANEQTY) ? "0" : _LANEQTY;
                            inLotDataRow["USERID"] = LoginInfo.USERID;
                            inLotDataTable.Rows.Add(inLotDataRow);

                            DataTable InMtrldataTable = inDataSet.Tables.Add("IN_INPUT");
                            InMtrldataTable.Columns.Add("INPUT_LOTID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));

                            DataRow inMtrlDataRow = null;

                            inMtrlDataRow = InMtrldataTable.NewRow();
                            inMtrlDataRow["INPUT_LOTID"] = ValueToLotID;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(EQUIPMENT_COMBO.SelectedValue.ToString());
                            inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";

                            InMtrldataTable.Rows.Add(inMtrlDataRow);
                            #endregion

                            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_START_LOT_SL", "IN_EQP,IN_INPUT", "RSLTDT", (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_START_LOT_SL", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }

                                #region QC 샘플 PopUp
                                DataTable dtCutTable = result.Tables["RSLTDT"];

                                string strCutid = dtCutTable.Rows[0]["CUT_ID"].ToString();

                                //2020.12.23 Slitter QC 샘플 화면 POPUP 
                                //PROCESSEQUIPMENTSEGMENT.GQMS_SMPLG_POPUP_APPLY_FLAG 값이 'Y'이면 실행
                                DataTable InTable = new DataTable();
                                InTable.Columns.Add("PROCID", typeof(string));
                                InTable.Columns.Add("EQSGID", typeof(string));

                                DataRow dtRow = InTable.NewRow();
                                dtRow["PROCID"] = Process.SLITTING;
                                dtRow["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                                InTable.Rows.Add(dtRow);

                                DataTable dtProcEqst = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_PROCESSEQUIPMENTSEGMENT", "INDATA", "OUTDATA", InTable);

                                if (Convert.ToString(dtProcEqst.Rows[0]["GQMS_SMPLG_POPUP_APPLY_FLAG"]) == "Y")
                                {
                                    DataSet inDataSet2 = new DataSet();

                                    //Slitter QC 샘플 POPUP 실행 비즈 호출
                                    DataTable InEqpTable = inDataSet2.Tables.Add("IN_EQP");
                                    InEqpTable.Columns.Add("SRCTYPE", typeof(string));
                                    InEqpTable.Columns.Add("IFMODE", typeof(string));
                                    InEqpTable.Columns.Add("EQPTID", typeof(string));
                                    InEqpTable.Columns.Add("USERID", typeof(string));
                                    InEqpTable.Columns.Add("SMPL_REG_YN", typeof(string));

                                    DataRow drEqp = null;
                                    drEqp = InEqpTable.NewRow();
                                    drEqp["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                                    drEqp["IFMODE"] = IFMODE.IFMODE_OFF;
                                    drEqp["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                                    drEqp["USERID"] = LoginInfo.USERID;
                                    drEqp["SMPL_REG_YN"] = dtProcEqst.Rows[0]["GQMS_SMPLG_POPUP_APPLY_FLAG"].ToString();
                                    InEqpTable.Rows.Add(drEqp);

                                    DataTable dtLotTable = inDataSet2.Tables.Add("IN_LOT");
                                    dtLotTable.Columns.Add("LOTID", typeof(string));

                                    DataRow drLot = null;
                                    drLot = dtLotTable.NewRow();
                                    drLot["LOTID"] = strCutid;

                                    dtLotTable.Rows.Add(drLot);

                                    DataSet dsInfoRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_CHK_LOT_SAMPLING_SL", "IN_EQP,IN_LOT", "OUTDATA", inDataSet2);

                                    DataTable dtInfo = dsInfoRslt.Tables["OUTDATA"];

                                    if (dtInfo.Rows[0]["MSGTYPE"].Equals("INFO"))
                                    {
                                        //Message 등록 여부 확인
                                        DataTable dtCode = new DataTable();
                                        dtCode.Columns.Add("LANGID", typeof(string));
                                        dtCode.Columns.Add("MSGID", typeof(string));

                                        DataRow dtRowMsg = dtCode.NewRow();
                                        dtRowMsg["LANGID"] = LoginInfo.LANGID;
                                        dtRowMsg["MSGID"] = "1" + dtInfo.Rows[0]["MSGCODE"].ToString(); //기존 메시지 변경 불가로 신규 메시지로 처리

                                        dtCode.Rows.Add(dtRowMsg);

                                        DataTable dtMessage = new ClientProxy().ExecuteServiceSync("DA_SEL_MESSAGE_LOT_START_RP", "INDATA", "RSLTDT", dtCode);

                                        if (dtMessage == null || dtMessage.Rows.Count == 0)
                                        {
                                            Util.MessageValidation("SFU1392");  //MESSAGE 테이블에 메세지를 등록해주세요
                                            return;
                                        }

                                        if (string.Equals(dtInfo.Rows[0]["MSGCODE"], "95000")) // 해당BIZ에서 95000번을 샘플링으로 리턴
                                        {
                                            LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU2960", new object[] { Convert.ToString(dtMessage.Rows[0]["MSGNAME"]) })
                                                , true, true, ObjectDic.Instance.GetObjectName("바코드발행"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.None, (Barresult, isBarCode) =>
                                                {
                                                    if (isBarCode == true)
                                                    {
                                                        if (LoginInfo.CFG_SERIAL_PRINT == null || LoginInfo.CFG_SERIAL_PRINT.Rows.Count < 1)
                                                        {
                                                            Util.MessageValidation("SFU2003"); // 프린트 환경 설정값이 없습니다.
                                                                return;
                                                        }

                                                        #region [샘플링 출하거래처 추가]
                                                        // SAMPLING용 발행 매수 추가
                                                        int iSamplingCount;

                                                        DataTable LabelDT = new DataTable();
                                                        LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                                                        DataTable sampleDT = new DataTable();
                                                        sampleDT.Columns.Add("CUT_ID", typeof(string));
                                                        sampleDT.Columns.Add("LOTID", typeof(string));
                                                        sampleDT.Columns.Add("COMPANY", typeof(string));
                                                        DataRow dRow = null;

                                                        foreach (DataRow _iRow in LabelDT.Rows)
                                                        {
                                                            iSamplingCount = 0;
                                                            string[] sCompany = null;
                                                            foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                                            {
                                                                iSamplingCount = Util.NVC_Int(items.Key);
                                                                sCompany = Util.NVC(items.Value).Split(',');
                                                            }
                                                            for (int i = 0; i < iSamplingCount; i++)
                                                            {
                                                                dRow = sampleDT.NewRow();
                                                                dRow["CUT_ID"] = _iRow["CUT_ID"];
                                                                dRow["LOTID"] = _iRow["LOTID"];
                                                                dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                                                sampleDT.Rows.Add(dRow);
                                                            }
                                                        }
                                                        var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                                                        for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                                                            for (int i = 0; i < sortdt.Rows.Count; i++)
                                                                Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                                                        #endregion
                                                    }
                                                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                                    });
                                        }
                                        else
                                        {
                                            Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                        }
                                    }
                                    else
                                    {
                                        Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                    }
                                }
                                else
                                {
                                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                }
                                #endregion

                                //Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                REFRESH = true;
                            }, inDataSet);

                            #region RTLS (2동 Only)
                            /*
                            if (LoginInfo.CFG_AREA_ID == "E6")
                            {
                                DataTable IndataTable = new DataTable("INDATA");
                                IndataTable.Columns.Add("CONDITION", typeof(string));
                                IndataTable.Columns.Add("CART_NO", typeof(string));
                                IndataTable.Columns.Add("LOTID", typeof(string));
                                IndataTable.Columns.Add("USERID", typeof(string));
                                IndataTable.Columns.Add("ZONE_ID", typeof(string));

                                DataRow Indata = IndataTable.NewRow();
                                Indata["CONDITION"] = "INPUT_LOT";
                                Indata["CART_NO"] = "";
                                Indata["LOTID"] = ValueToLotID;
                                Indata["USERID"] = "MES";
                                Indata["ZONE_ID"] = "";
                                IndataTable.Rows.Add(Indata);

                                new ClientProxy().ExecuteService("BR_RTLS_REG_MAPPING_BY_CONDITION", "INDATA", null, IndataTable, (dtRTLS, searchException) =>
                                {
                                    if (searchException != null)
                                    {
                                        Util.MessageException(searchException);
                                        return;
                                    }
                                });

                            }
                            */
                            #endregion
                        }
                    });
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
            //슬리터 2차 추가  2021-09-15  by 오화백
            else if (procId.Equals("E4200"))
            {
                try
                {
                    bool isQCPopUp = true;

                    Util.MessageConfirm("SFU1240", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            DataSet inDataSet = new DataSet();

                            #region MESSAGE SET
                            DataTable inLotDataTable = inDataSet.Tables.Add("IN_EQP");
                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            //inLotDataTable.Columns.Add("LANE_QTY", typeof(Int32));
                            inLotDataTable.Columns.Add("USERID", typeof(string));

                            DataRow inLotDataRow = null;
                            inLotDataRow = inLotDataTable.NewRow();
                            inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inLotDataRow["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            //inLotDataRow["LANE_QTY"] = string.IsNullOrEmpty(_LANEQTY) ? "0" : _LANEQTY;
                            inLotDataRow["USERID"] = LoginInfo.USERID;
                            inLotDataTable.Rows.Add(inLotDataRow);

                            DataTable InMtrldataTable = inDataSet.Tables.Add("IN_INPUT");
                            InMtrldataTable.Columns.Add("INPUT_LOTID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));

                            DataRow inMtrlDataRow = null;

                            inMtrlDataRow = InMtrldataTable.NewRow();
                            inMtrlDataRow["INPUT_LOTID"] = ValueToLotID;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(EQUIPMENT_COMBO.SelectedValue.ToString());
                            inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";

                            InMtrldataTable.Rows.Add(inMtrlDataRow);
                            #endregion

                            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_START_LOT_SL", "IN_EQP,IN_INPUT", "RSLTDT", (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_START_LOT_SL", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }

                                #region QC 샘플 PopUp
                                DataTable dtCutTable = result.Tables["RSLTDT"];

                                string strCutid = dtCutTable.Rows[0]["CUT_ID"].ToString();

                                //2020.12.23 Slitter QC 샘플 화면 POPUP 
                                //PROCESSEQUIPMENTSEGMENT.GQMS_SMPLG_POPUP_APPLY_FLAG 값이 'Y'이면 실행
                                DataTable InTable = new DataTable();
                                InTable.Columns.Add("PROCID", typeof(string));
                                InTable.Columns.Add("EQSGID", typeof(string));

                                DataRow dtRow = InTable.NewRow();
                                dtRow["PROCID"] = "E4200";
                                dtRow["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                                InTable.Rows.Add(dtRow);

                                DataTable dtProcEqst = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_PROCESSEQUIPMENTSEGMENT", "INDATA", "OUTDATA", InTable);

                                if (Convert.ToString(dtProcEqst.Rows[0]["GQMS_SMPLG_POPUP_APPLY_FLAG"]) == "Y")
                                {
                                    DataSet inDataSet2 = new DataSet();

                                    //Slitter QC 샘플 POPUP 실행 비즈 호출
                                    DataTable InEqpTable = inDataSet2.Tables.Add("IN_EQP");
                                    InEqpTable.Columns.Add("SRCTYPE", typeof(string));
                                    InEqpTable.Columns.Add("IFMODE", typeof(string));
                                    InEqpTable.Columns.Add("EQPTID", typeof(string));
                                    InEqpTable.Columns.Add("USERID", typeof(string));
                                    InEqpTable.Columns.Add("SMPL_REG_YN", typeof(string));

                                    DataRow drEqp = null;
                                    drEqp = InEqpTable.NewRow();
                                    drEqp["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                                    drEqp["IFMODE"] = IFMODE.IFMODE_OFF;
                                    drEqp["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                                    drEqp["USERID"] = LoginInfo.USERID;
                                    drEqp["SMPL_REG_YN"] = dtProcEqst.Rows[0]["GQMS_SMPLG_POPUP_APPLY_FLAG"].ToString();
                                    InEqpTable.Rows.Add(drEqp);

                                    DataTable dtLotTable = inDataSet2.Tables.Add("IN_LOT");
                                    dtLotTable.Columns.Add("LOTID", typeof(string));

                                    DataRow drLot = null;
                                    drLot = dtLotTable.NewRow();
                                    drLot["LOTID"] = strCutid;

                                    dtLotTable.Rows.Add(drLot);

                                    DataSet dsInfoRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_CHK_LOT_SAMPLING_SL", "IN_EQP,IN_LOT", "OUTDATA", inDataSet2);

                                    DataTable dtInfo = dsInfoRslt.Tables["OUTDATA"];

                                    if (dtInfo.Rows[0]["MSGTYPE"].Equals("INFO"))
                                    {
                                        //Message 등록 여부 확인
                                        DataTable dtCode = new DataTable();
                                        dtCode.Columns.Add("LANGID", typeof(string));
                                        dtCode.Columns.Add("MSGID", typeof(string));

                                        DataRow dtRowMsg = dtCode.NewRow();
                                        dtRowMsg["LANGID"] = LoginInfo.LANGID;
                                        dtRowMsg["MSGID"] = "1" + dtInfo.Rows[0]["MSGCODE"].ToString(); //기존 메시지 변경 불가로 신규 메시지로 처리

                                        dtCode.Rows.Add(dtRowMsg);

                                        DataTable dtMessage = new ClientProxy().ExecuteServiceSync("DA_SEL_MESSAGE_LOT_START_RP", "INDATA", "RSLTDT", dtCode);

                                        if (dtMessage == null || dtMessage.Rows.Count == 0)
                                        {
                                            Util.MessageValidation("SFU1392");  //MESSAGE 테이블에 메세지를 등록해주세요
                                            return;
                                        }

                                        if (string.Equals(dtInfo.Rows[0]["MSGCODE"], "95000")) // 해당BIZ에서 95000번을 샘플링으로 리턴
                                        {
                                            LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU2960", new object[] { Convert.ToString(dtMessage.Rows[0]["MSGNAME"]) })
                                                , true, true, ObjectDic.Instance.GetObjectName("바코드발행"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.None, (Barresult, isBarCode) =>
                                                {
                                                    if (isBarCode == true)
                                                    {
                                                        if (LoginInfo.CFG_SERIAL_PRINT == null || LoginInfo.CFG_SERIAL_PRINT.Rows.Count < 1)
                                                        {
                                                            Util.MessageValidation("SFU2003"); // 프린트 환경 설정값이 없습니다.
                                                            return;
                                                        }

                                                        #region [샘플링 출하거래처 추가]
                                                        // SAMPLING용 발행 매수 추가
                                                        int iSamplingCount;

                                                        DataTable LabelDT = new DataTable();
                                                        LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                                                        DataTable sampleDT = new DataTable();
                                                        sampleDT.Columns.Add("CUT_ID", typeof(string));
                                                        sampleDT.Columns.Add("LOTID", typeof(string));
                                                        sampleDT.Columns.Add("COMPANY", typeof(string));
                                                        DataRow dRow = null;

                                                        foreach (DataRow _iRow in LabelDT.Rows)
                                                        {
                                                            iSamplingCount = 0;
                                                            string[] sCompany = null;
                                                            foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                                            {
                                                                iSamplingCount = Util.NVC_Int(items.Key);
                                                                sCompany = Util.NVC(items.Value).Split(',');
                                                            }
                                                            for (int i = 0; i < iSamplingCount; i++)
                                                            {
                                                                dRow = sampleDT.NewRow();
                                                                dRow["CUT_ID"] = _iRow["CUT_ID"];
                                                                dRow["LOTID"] = _iRow["LOTID"];
                                                                dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                                                sampleDT.Rows.Add(dRow);
                                                            }
                                                        }
                                                        var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                                                        for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                                                            for (int i = 0; i < sortdt.Rows.Count; i++)
                                                                Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                                                        #endregion
                                                    }
                                                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                                });
                                        }
                                        else
                                        {
                                            Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                        }
                                    }
                                    else
                                    {
                                        Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                    }
                                }
                                else
                                {
                                    Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                }
                                #endregion

                                //Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                REFRESH = true;
                            }, inDataSet);

                            #region RTLS (2동 Only)
                            /*
                            if (LoginInfo.CFG_AREA_ID == "E6")
                            {
                                DataTable IndataTable = new DataTable("INDATA");
                                IndataTable.Columns.Add("CONDITION", typeof(string));
                                IndataTable.Columns.Add("CART_NO", typeof(string));
                                IndataTable.Columns.Add("LOTID", typeof(string));
                                IndataTable.Columns.Add("USERID", typeof(string));
                                IndataTable.Columns.Add("ZONE_ID", typeof(string));

                                DataRow Indata = IndataTable.NewRow();
                                Indata["CONDITION"] = "INPUT_LOT";
                                Indata["CART_NO"] = "";
                                Indata["LOTID"] = ValueToLotID;
                                Indata["USERID"] = "MES";
                                Indata["ZONE_ID"] = "";
                                IndataTable.Rows.Add(Indata);

                                new ClientProxy().ExecuteService("BR_RTLS_REG_MAPPING_BY_CONDITION", "INDATA", null, IndataTable, (dtRTLS, searchException) =>
                                {
                                    if (searchException != null)
                                    {
                                        Util.MessageException(searchException);
                                        return;
                                    }
                                });

                            }
                            */
                            #endregion
                        }
                    });
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }


            else if (procId.Equals(Process.SRS_SLITTING))
            {
                try
                {
                    Util.MessageConfirm("SFU1240", (sresult) =>
                    {
                        if (sresult == MessageBoxResult.OK)
                        {
                            DataSet inDataSet = null;

                            inDataSet = new DataSet();

                            #region MESSAGE SET
                            DataTable inLotDataTable = inDataSet.Tables.Add("IN_EQP");
                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            //inLotDataTable.Columns.Add("LANE_QTY", typeof(Int32));
                            inLotDataTable.Columns.Add("USERID", typeof(string));

                            DataRow inLotDataRow = null;
                            inLotDataRow = inLotDataTable.NewRow();
                            inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inLotDataRow["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                            //inLotDataRow["LANE_QTY"] = _LANEQTY;  
                            inLotDataRow["USERID"] = LoginInfo.USERID;
                            inLotDataTable.Rows.Add(inLotDataRow);

                            DataTable InMtrldataTable = inDataSet.Tables.Add("IN_INPUT");
                            InMtrldataTable.Columns.Add("INPUT_LOTID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            InMtrldataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));

                            DataRow inMtrlDataRow = null;

                            inMtrlDataRow = InMtrldataTable.NewRow();
                            inMtrlDataRow["INPUT_LOTID"] = ValueToLotID;
                            inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(EQUIPMENT_COMBO.SelectedValue.ToString());
                            inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";

                            InMtrldataTable.Rows.Add(inMtrlDataRow);
                            #endregion

                            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_START_LOT_SS", "IN_EQP,IN_INPUT", "RSLTDT", (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_START_LOT_SS", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }

                                Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                                REFRESH = true;
                            }, inDataSet);
                        }
                    });
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
        }

        private void GetLotInfo(Object SelectedItem)
        {
            DataRowView rowview = SelectedItem as DataRowView;

            if (rowview == null)
                return;

            LOTID = Util.NVC(rowview["LOTID"]);
            _LOTID = Util.NVC(rowview["LOTID"]);
            _WIPSEQ = Util.NVC(rowview["WIPSEQ"]);

            if (!procId.Equals(Process.PRE_MIXING) && !procId.Equals(Process.MIXING) && !procId.Equals(Process.SRS_MIXING))
            {
                if (LARGELOT_GRID.Visibility == Visibility.Visible)
                    _LOTIDPR = Util.NVC(DataTableConverter.GetValue(rowview, "LOTID_LARGE"));
                else
                    _LOTIDPR = Util.NVC(rowview["LOTID_PR"]);
            }

            _WIPSTAT = Util.NVC(rowview["WIPSTAT"]);
            _WIPDTTM_ST = Util.NVC(rowview["WIPDTTM_ST"]);
            _WIPDTTM_ED = Util.NVC(rowview["WIPDTTM_ED"]);
            _REMARK = Util.NVC(rowview["REMARK"]);
            _PRODID = Util.NVC(rowview["PRODID"]);
            _EQPTID = Util.NVC(rowview["EQPTID"]);
            _WORKORDER = Util.NVC(rowview["WOID"]);
            //_PTNQTY = Util.NVC(rowview["LANE_PTN_QTY"]);
            _LANEQTY = "0"; // LANE수 디폴트 0 SET
            _PTNQTY = "1"; // 패턴 사용을 안하지만 다른곳에서 패턴을 사용할 것을 대비하여 1로 SET
            _CSTID = (DataTableConverter.Convert(rowview.DataView).Columns["CSTID"] == null) ? "" : Util.NVC(rowview["CSTID"]);

            if (isCoaterAfterProcess)
                _CUTID = (procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING)) ? "1" : Util.NVC(rowview["CUT_ID"]);

            // 버전 공통으로 입력 하는 부분 추가 [2017-02-17]
            DataTable versionDt = GetProcessVersion(_LOTID, _PRODID);
            if (versionDt.Rows.Count > 0)
            {
                _VERSION = Util.NVC(versionDt.Rows[0]["PROD_VER_CODE"]);
                _LANEQTY = string.IsNullOrEmpty(Util.NVC(versionDt.Rows[0]["LANE_QTY"])) ? "0" : Util.NVC(versionDt.Rows[0]["LANE_QTY"]);
            }

            // MIXER공정에서 CONVRATE에 버전정보 1개만 존재 시 해당 버전 SETUP [2017-05-10]
            if ((string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.SRS_MIXING)) && string.IsNullOrEmpty(_VERSION))
                _VERSION = GetProdVerCode(_PRODID);

            //C20210415-000402 [2021-06-22] 
            //코터 공정중 CUT 정보 확인( 바코드 발행시 사용)
            if (string.Equals(procId, Process.COATING))
                _CUT = Util.NVC(rowview["CUT"]);

            if (_WIPSTAT != "WAIT")
            {
                txtVersion.Text = _VERSION;
                txtLaneQty.Value = string.IsNullOrEmpty(_LANEQTY) ? 0 : Convert.ToDouble(_LANEQTY);
                txtLanePatternQty.Value = string.IsNullOrEmpty(_PTNQTY) ? 0 : Convert.ToDouble(_PTNQTY);
                if (string.IsNullOrEmpty(_WIPDTTM_ST))
                   txtStartDateTime.Text = DateTime.Now.ToString("yyyy-MM-dd HH:mm");
                else
                   txtStartDateTime.Text = Convert.ToDateTime(_WIPDTTM_ST).ToString("yyyy-MM-dd HH:mm");

                if (string.IsNullOrEmpty(_WIPDTTM_ED))
                    txtEndDateTime.Text = DateTime.Now.ToString("yyyy-MM-dd HH:mm");
                else
                    txtEndDateTime.Text = Convert.ToDateTime(_WIPDTTM_ED).ToString("yyyy-MM-dd HH:mm");

                if (txtWorkTime != null && (string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.SRS_MIXING)))
                    txtWorkTime.Value = (Convert.ToDateTime(txtEndDateTime.Text) - Convert.ToDateTime(txtStartDateTime.Text)).TotalMinutes;

                /*
                if (string.IsNullOrEmpty(_WIPDTTM_ED))
                {
                    dtpEndDateTime.DateTime = System.DateTime.Now;
                    dtpEndDateTime.IsEnabled = true;
                }
                else
                {
                    dtpEndDateTime.DateTime = Util.StringToDateTime(_WIPDTTM_ED);
                    dtpEndDateTime.IsEnabled = false;
                }
                */

                WIPSTATUS = _WIPSTAT;
                _WORKDATE = Util.NVC(rowview["WORKDATE"]);

                /*
                if (dtpWorkDate != null)
                {
                    dtpWorkDate.MinDate = Convert.ToDateTime(_WORKDATE).AddDays(-1);
                    dtpWorkDate.MaxDate = Convert.ToDateTime(_WORKDATE).AddDays(1);
                    dtpWorkDate.DateTime = Convert.ToDateTime(string.IsNullOrEmpty(_WORKDATE) ? DateTime.Now.ToString("yyyy-MM-dd") : _WORKDATE);
                }
                */

                if (txtWorkDate != null)
                    SetCalDate();

                if (!procId.Equals(Process.PRE_MIXING) && !procId.Equals(Process.MIXING) && !procId.Equals(Process.SRS_MIXING))
                    LOTID = WIPSTATUS == "EQPT_END" ? _LOTIDPR : _LOTID;

                txtUnit.Text = rowview["UNIT"].ToString();

                // SRS코터 임시저장 자동SET 로직 추가[2017-11-30]
                if (string.Equals(procId, Process.SRS_COATING))
                    SetSRSLotHistoryInfo(_LOTID);

                if (string.Equals(procId, Process.SRS_SLITTING))
                    cboPet.SelectedValue = Util.NVC(rowview["PROTECT_FILM_TYPE_CODE"]);

                // 합권취용 투입 LOT SET
                if (LARGELOT_GRID.Visibility == Visibility.Visible)
                    txtMergeInputLot.Text = _LOTID;
                else
                    txtMergeInputLot.Text = string.IsNullOrEmpty(_LOTIDPR) ? _LOTID : _LOTIDPR;

                // 청주 소형전극에서만 패턴에서만 변환해서 값 입력 [COATER에서만 사용]
                //if (string.Equals(txtUnit.Text, "EA") && string.Equals(LoginInfo.CFG_AREA_ID, "E1") && string.Equals(procId, Process.COATING))
                if (string.Equals(txtUnit.Text, "EA") && (!string.Equals(procId, Process.PRE_MIXING) && !string.Equals(procId, Process.MIXING) && !string.Equals(procId, Process.SRS_MIXING)))
                    convRate = GetPatternLength(_PRODID);

                // 코터 & SRS코터 자동 FINAL CUT 처리 [2017-05-30]
                if ((string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING)) && chkFinalCut != null && string.Equals(rowview["FINAL_CUT_FLAG"], "Y"))
                    chkFinalCut.IsChecked = true;
                else if ((string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING)) && chkFinalCut != null && !string.Equals(rowview["FINAL_CUT_FLAG"], "Y"))
                    chkFinalCut.IsChecked = false;

                SetUnitFormatted(); // UNIT별로 FORMAT을 별도로 해달라는 요청이 있어서 해당 기능 적용 [2017-02-21]
                GetResultInfo();
            }
        }
        // 실적 임시저장 조회 : 실적수량, 불량수량 적용?

        private void SetUnitFormatted()
        {
            if (!string.IsNullOrEmpty(txtUnit.Text))
            {
                string sFormatted = string.Empty;
                switch (txtUnit.Text)
                {
                    case "KG":
                        sFormatted = "F3";
                        break;

                    case "M":
                        sFormatted = "F2";
                        break;

                    case "EA":
                    default:
                        sFormatted = "F0";
                        break;
                }

                // 단면코터 BACK작업 시 패턴일 경우 생산량 소수점 조절을 위해 F1 고정
                if (string.Equals(txtUnit.Text, "EA") && isSingleCoater == true && string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                    txtInputQty.Format = "F1";
                else
                    txtInputQty.Format = sFormatted;

                txtParentQty.Format = sFormatted;
                txtRemainQty.Format = sFormatted;

                if (string.Equals(procId, Process.SRS_COATING))
                {
                    txtSrs1Qty.Format = sFormatted;
                    txtSrs2Qty.Format = sFormatted;
                    txtSrs3Qty.Format = sFormatted;
                }
                //슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")|| string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                {
                    if (string.Equals(txtUnit.Text, "EA"))
                        (grdDataCollect.Children[0] as UcDataCollect).txtMesualQty.Format = "F1";
                    else
                        (grdDataCollect.Children[0] as UcDataCollect).txtMesualQty.Format = sFormatted;
                }

                if (LOTINFO_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < LOTINFO_GRID.Columns.Count; i++)
                        if (LOTINFO_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(LOTINFO_GRID.Columns[i].Tag, "N"))
                            // 코터공정중에 EA인것은 BACK작업시 TOP의 1/2로직으로 인하여 수정될 여지가 있어서 해당 로직 고정
                            if(string.Equals(txtUnit.Text, "EA") && string.Equals(procId, Process.COATING))
                                ((DataGridNumericColumn)LOTINFO_GRID.Columns[i]).Format = "F1";
                            else
                                ((DataGridNumericColumn)LOTINFO_GRID.Columns[i]).Format = sFormatted;

                if (WIPREASON_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < WIPREASON_GRID.Columns.Count; i++)
                        if (WIPREASON_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(WIPREASON_GRID.Columns[i].Tag, "N"))
                            ((DataGridNumericColumn)WIPREASON_GRID.Columns[i]).Format = sFormatted;

                if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < WIPREASON2_GRID.Columns.Count; i++)
                        if (WIPREASON2_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(WIPREASON2_GRID.Columns[i].Tag, "N"))
                            ((DataGridNumericColumn)WIPREASON2_GRID.Columns[i]).Format = sFormatted;

                if (QUALITY_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < QUALITY_GRID.Columns.Count; i++)
                        if (QUALITY_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(QUALITY_GRID.Columns[i].Tag, "N"))
                            if (string.Equals(txtUnit.Text, "EA"))
                                ((DataGridNumericColumn)QUALITY_GRID.Columns[i]).Format = "F1";
                            else
                                ((DataGridNumericColumn)QUALITY_GRID.Columns[i]).Format = sFormatted;

                if (QUALITY2_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < QUALITY2_GRID.Columns.Count; i++)
                        if (QUALITY2_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(QUALITY2_GRID.Columns[i].Tag, "N"))
                            if (string.Equals(txtUnit.Text, "EA"))
                                ((DataGridNumericColumn)QUALITY2_GRID.Columns[i]).Format = "F1";
                            else
                                ((DataGridNumericColumn)QUALITY2_GRID.Columns[i]).Format = sFormatted;

                if (INPUTMTRL_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < INPUTMTRL_GRID.Columns.Count; i++)
                        if (INPUTMTRL_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(INPUTMTRL_GRID.Columns[i].Tag, "N"))
                            if (string.Equals(txtUnit.Text, "EA"))
                                ((DataGridNumericColumn)INPUTMTRL_GRID.Columns[i]).Format = "F1";
                            else
                                ((DataGridNumericColumn)INPUTMTRL_GRID.Columns[i]).Format = sFormatted;

                if (INPUTMTRLSUMMARY_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < INPUTMTRLSUMMARY_GRID.Columns.Count; i++)
                        if (INPUTMTRLSUMMARY_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(INPUTMTRLSUMMARY_GRID.Columns[i].Tag, "N"))
                            if (string.Equals(txtUnit.Text, "EA"))
                                ((DataGridNumericColumn)INPUTMTRLSUMMARY_GRID.Columns[i]).Format = "F1";
                            else
                                ((DataGridNumericColumn)INPUTMTRLSUMMARY_GRID.Columns[i]).Format = sFormatted;

                // NISSAN용 입력용도로 추가
                if (DEFECT_TAG_GRID.Visibility == Visibility.Visible)
                    for (int i = 0; i < DEFECT_TAG_GRID.Columns.Count; i++)
                        if (DEFECT_TAG_GRID.Columns[i].GetType() == typeof(DataGridNumericColumn) && !string.Equals(DEFECT_TAG_GRID.Columns[i].Tag, "N"))
                            ((DataGridNumericColumn)DEFECT_TAG_GRID.Columns[i]).Format = sFormatted;
            }
        }

        private string GetUnitFormatted()
        {
            string sFormatted = "0";
            if (!string.IsNullOrEmpty(txtUnit.Text))
            {
                switch (txtUnit.Text)
                {
                    case "KG":
                        sFormatted = "F3";
                        break;

                    case "M":
                        sFormatted = "F2";
                        break;

                    case "EA":
                    default:
                        sFormatted = "F0";
                        break;
                }
            }
            return sFormatted;
        }

        private string GetUnitFormatted(object obj)
        {
            string sValue = Util.NVC(obj);
            string sFormatted = string.Empty;
            double dFormat = 0;

            switch (txtUnit.Text)
            {
                case "KG":
                    sFormatted = "{0:#,##0.000}";
                    break;

                case "M":
                    sFormatted = "{0:#,##0.00}";
                    break;

                case "EA":
                default:
                    sFormatted = "{0:#,##0}";
                    break;
            }

            if (string.IsNullOrEmpty(sValue))
                return String.Format(sFormatted, 0);

            if (Double.TryParse(sValue, out dFormat))
                return String.Format(sFormatted, dFormat);

            return String.Format(sFormatted, 0);
        }

        private string GetUnitFormatted(object obj, string pattern)
        {
            string sValue = Util.NVC(obj);
            string sFormatted = string.Empty;
            double dFormat = 0;

            switch (pattern)
            {
                case "KG":
                    sFormatted = "{0:###0.000}";
                    break;

                case "M":
                    sFormatted = "{0:###0.00}";
                    break;

                case "EA":
                default:
                    sFormatted = "{0:###0.0}";
                    break;
            }

            if (string.IsNullOrEmpty(sValue))
                return String.Format(sFormatted, 0);

            if (Double.TryParse(sValue, out dFormat))
                return String.Format(sFormatted, dFormat);

            return String.Format(sFormatted, 0);
        }

        private string GetIntFormatted(object obj)
        {
            string sValue = Util.NVC(obj);
            string sFormatted = "{0:#,##0}";
            double dFormat = 0;

            if (string.IsNullOrEmpty(sValue))
                return String.Format(sFormatted, 0);

            if (Double.TryParse(sValue, out dFormat))
                return String.Format(sFormatted, dFormat);

            return String.Format(sFormatted, 0);
        }

        void GetWipHistory(string sLotID)
        {
            DataTable IndataTable = new DataTable("INDATA");
            IndataTable.Columns.Add("LANGID", typeof(string));
            IndataTable.Columns.Add("LOTID", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LANGID"] = LoginInfo.LANGID;
            Indata["LOTID"] = sLotID;
            IndataTable.Rows.Add(Indata);

            new ClientProxy().ExecuteService("DA_PRD_SEL_SAVED_LOT_INFO", "INDATA", "RSLTDT", IndataTable, (result, searchException) =>
            {
                try
                {
                    if (searchException != null)
                        throw searchException;
                    //if (!Util.NVC(result.Rows[0]["PROD_VER_CODE"]).Equals("")) // 빈값일때 GetLotInfo 에서 넣은 버전유지 20170110 유관수
                    //    txtVersion.Text = Util.NVC(result.Rows[0]["PROD_VER_CODE"]);
                    if (txtWipNote != null)
                        txtWipNote.Text = Util.NVC(result.Rows[0]["WIP_NOTE"]);

                    // 설비별 저장 현황에서 SET하기 때문에 하단 주석 처리 ( 2017-02-11 )
                    /*
                    txtWorker.Text = Util.NVC(result.Rows[0]["WRK_USER_NAME"]);
                    txtWorker.Tag = Util.NVC(result.Rows[0]["WRK_USERID"]);
                    txtShift.Tag = Util.NVC(result.Rows[0]["SHIFT"]);
                    txtShift.Text = Util.NVC(result.Rows[0]["SHFT_NAME"]);
                    */

                    // 추후 적용 *************************************************************** (LANEQTY,PATTEN없을시 오류나는 문제 있어 값 없을 시 아래의 처리 해놨음)
                    //txtLaneQty.Value = result.Rows[0]["LANE_QTY"].ToString() == "" ? txtLaneQty.Value : Convert.ToDouble(result.Rows[0]["LANE_QTY"]);
                    //txtLanePatternQty.Value = result.Rows[0]["LANE_PTN_QTY"].ToString() == "" ? txtLanePatternQty.Value : Convert.ToDouble(result.Rows[0]["LANE_PTN_QTY"]);
                    /*
                    double dLaneQty = result.Rows[0]["LANE_QTY"].ToString() == "" ? 0: Convert.ToDouble(result.Rows[0]["LANE_QTY"]);
                    double dLaneptnQty = result.Rows[0]["LANE_PTN_QTY"].ToString() == "" ? 0 : Convert.ToDouble(result.Rows[0]["LANE_PTN_QTY"]);
                    if (LOTINFO_GRID.GetRowCount() > 0)
                    {
                        for (int i = LOTINFO_GRID.TopRows.Count; i < LOTINFO_GRID.Rows.Count; i++)
                        {
                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY", dLaneQty);
                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_PTN_QTY", dLaneptnQty);
                        }
                    }
                    */
                }
                catch (Exception ex)
                {
                    throw ex;
                }

            });
        }

        void GetWrkShftUser()
        {
            DataTable IndataTable = new DataTable("RQSTDT");
            IndataTable.Columns.Add("LANGID", typeof(string));
            IndataTable.Columns.Add("EQPTID", typeof(string));
            IndataTable.Columns.Add("SHOPID", typeof(string));
            IndataTable.Columns.Add("AREAID", typeof(string));
            IndataTable.Columns.Add("EQSGID", typeof(string));
            IndataTable.Columns.Add("PROCID", typeof(string));
            //IndataTable.Columns.Add("LOTID", typeof(string));
            //IndataTable.Columns.Add("PROCID", typeof(string));
            //IndataTable.Columns.Add("WIPSTAT", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LANGID"] = LoginInfo.LANGID;
            Indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            Indata["SHOPID"] = LoginInfo.CFG_SHOP_ID;
            Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
            Indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
            Indata["PROCID"] = procId;

            //Indata["LOTID"] = sLotID;
            //Indata["PROCID"] = procId;
            //Indata["WIPSTAT"] = WIPSTATUS;
            IndataTable.Rows.Add(Indata);

            new ClientProxy().ExecuteService("DA_BAS_SEL_TB_SFC_EQPT_WRK_INFO", "RQSTDT", "RSLTDT", IndataTable, (result, searchException) =>
            {
                try
                {
                    if (searchException != null)
                    {
                        Util.MessageException(searchException);
                        return;
                    }

                    if (result.Rows.Count > 0)
                    {
                        if (!result.Rows[0].ItemArray[0].ToString().Equals(""))
                        {
                            //txtWorkStartDateTime.Text = Util.NVC(result.Rows[0]["WRK_STRT_DTTM"]);
                            txtShiftStartTime.Text = Util.NVC(result.Rows[0]["WRK_STRT_DTTM"]);
                        }
                        else
                        {
                            //txtWorkStartDateTime.Text = string.Empty;
                            txtShiftStartTime.Text = string.Empty;
                        }

                        if (!result.Rows[0].ItemArray[1].ToString().Equals(""))
                        {
                            //txtWorkEndDateTime.DateTime = Convert.ToDateTime(result.Rows[0]["WRK_END_DTTM"]);
                            txtShiftEndTime.Text = Util.NVC(result.Rows[0]["WRK_END_DTTM"]);
                        }
                        else
                        {
                            //txtWorkEndDateTime.DateTime = null; //System.DateTime.Now;
                            txtShiftEndTime.Text = string.Empty;
                        }

                        if (!string.IsNullOrEmpty(txtShiftStartTime.Text) && !string.IsNullOrEmpty(txtShiftEndTime.Text))
                        {
                            txtShiftDateTime.Text = txtShiftStartTime.Text + " ~ " + txtShiftEndTime.Text;
                        }
                        else
                        {
                            txtShiftDateTime.Text = string.Empty;
                        }

                        if (Util.NVC(result.Rows[0]["WRK_USERID"]).Equals(""))
                        {
                            txtWorker.Text = string.Empty;
                            txtWorker.Tag = string.Empty;
                        }
                        else
                        {
                            txtWorker.Text = Util.NVC(result.Rows[0]["WRK_USERNAME"]);
                            txtWorker.Tag = Util.NVC(result.Rows[0]["WRK_USERID"]);
                        }

                        if (Util.NVC(result.Rows[0]["SHFT_ID"]).Equals(""))
                        {
                            txtShift.Tag = string.Empty;
                            txtShift.Text = string.Empty;
                        }
                        else
                        {
                            txtShift.Text = Util.NVC(result.Rows[0]["SHFT_NAME"]);
                            txtShift.Tag = Util.NVC(result.Rows[0]["SHFT_ID"]);
                        }
                    }
                    else
                    {
                        //txtWorkStartDateTime.Text = string.Empty;
                        //txtWorkEndDateTime.DateTime = null;
                        txtWorker.Text = string.Empty;
                        txtWorker.Tag = string.Empty;
                        txtShift.Text = string.Empty;
                        txtShift.Tag = string.Empty;
                        txtShiftStartTime.Text = string.Empty;
                        txtShiftEndTime.Text = string.Empty;
                        txtShiftDateTime.Text = string.Empty;
                    }
                }
                catch (Exception ex)
                {
                    Util.MessageException(ex);
                }
            });
        }

        void GetResultInfo()
        {
            try
            {
                Util.gridClear(LOTINFO_GRID);

                DataRowView rowView = PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem as DataRowView;

                //if ((grdResult.Children[0] as UcResult).grdSummary.Visibility != Visibility.Visible)
                if (isCoaterAfterProcess == false || isSingleCoater == true)
                {
                    DataTable _dtLotInfo = new DataTable();
                    _dtLotInfo.Columns.Add("LOTID", typeof(string));
                    _dtLotInfo.Columns.Add("WIPSEQ", typeof(Int32));
                    _dtLotInfo.Columns.Add("INPUTQTY", typeof(double));
                    _dtLotInfo.Columns.Add("GOODQTY", typeof(double));
                    _dtLotInfo.Columns.Add("GOODPTNQTY", typeof(double));
                    _dtLotInfo.Columns.Add("LOSSQTY", typeof(double));
                    _dtLotInfo.Columns.Add("DTL_DEFECT", typeof(double));
                    _dtLotInfo.Columns.Add("DTL_LOSS", typeof(double));
                    _dtLotInfo.Columns.Add("DTL_CHARGEPRD", typeof(double));

                    _dtLotInfo.Columns.Add("EQPT_END_QTY", typeof(double)); //장비 완료 수량 추가
                    _dtLotInfo.Columns.Add("LANE_QTY", typeof(Int32)).DefaultValue = 1;
                    _dtLotInfo.Columns.Add("LANE_PTN_QTY", typeof(Int32)).DefaultValue = 1;

                    // --- Add : 2019-06-24 Coater 공정 RFID 적용에 따른 OUT_CSTID 추가
                    _dtLotInfo.Columns.Add("OUT_CSTID", typeof(string));
                    // ---

                    DataRow dRow = _dtLotInfo.NewRow();
                    dRow["LOTID"] = Util.NVC(rowView["LOTID"]);
                    dRow["WIPSEQ"] = Util.NVC(rowView["WIPSEQ"]);

                    dRow["EQPT_END_QTY"] = Util.NVC(rowView["EQPT_END_QTY"]);   //장비 수량 추가

                    // --- Add : 2019-06-24 Coater 공정 RFID 적용에 따른 OUT_CSTID 추가
                    dRow["OUT_CSTID"] = (DataTableConverter.Convert(rowView.DataView).Columns["OUT_CSTID"] == null) ? "" : Util.NVC(rowView["OUT_CSTID"]);
                    // ---
                    _dtLotInfo.Rows.Add(dRow);

                    Util.GridSetData(LOTINFO_GRID, _dtLotInfo, FrameOperation);

                    SetParentQty(_LOTID, WIPSTATUS);

                    // BEACMILL 횟수 SET
                    if (string.Equals(procId, Process.PRE_MIXING))
                        txtBeadMillCount.Value = Util.NVC_Int(rowView["MILL_COUNT"]);

                    // 특이사항 SET
                    DataTable dtCopy = _dtLotInfo.Copy();
                    BindingWipNote(dtCopy);
                }
                else
                {
                    string lotId = Util.NVC(DataTableConverter.GetValue(rowView, "LOTID"));

                    DataTable inTable = new DataTable();
                    inTable.Columns.Add("LOTID_PR", typeof(string));
                    inTable.Columns.Add("LOTID", typeof(string));
                    inTable.Columns.Add("LANGID", typeof(string));
                    inTable.Columns.Add("PROCID", typeof(string));
                    inTable.Columns.Add("WIPSTAT", typeof(string));

                    // Add : 2016.12.14, Slitting, SRS Slitting Cut ID 추가 ********************
                    // 슬리터 2차 추가 2021-09-15 by 오화백
                    if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
                        inTable.Columns.Add("CUT_ID", typeof(string));
                    //**************************************************************************

                    DataRow indata = inTable.NewRow();

                    if (WIPSTATUS == "EQPT_END")
                    {
                        indata["LOTID_PR"] = null;
                        indata["LOTID"] = lotId;
                    }
                    else
                    {
                        indata["LOTID_PR"] = lotId;
                        indata["LOTID"] = null;
                    }

                    // Add : 2016.12.14, Slitting, SRS Slitting Cut ID 추가 ******************** // CUTID PROC, EQTP_END 동일하게 입력하게 처리
                    // 슬리터 2차 추가 2021-09-15 by 오화백
                    if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
                        indata["CUT_ID"] = _CUTID;
                    //**************************************************************************
                    // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
                    if (procId.Equals(Process.ROLL_PRESSING) || procId.Equals(Process.REWINDER) || 
                        procId.Equals(Process.LASER_ABLATION) || procId.Equals(Process.TAPING) || 
                        PROCID.Equals(Process.BACK_WINDER) || PROCID.Equals(Process.HALF_SLITTING) || 
                        procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING) || 
                        procId.Equals(Process.HEAT_TREATMENT))
                    {
                        indata["LOTID"] = lotId;
                    }
                    //슬리터 2차 추가  2021-09-15 by 오화백
                    else if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
                    {
                        indata["LOTID_PR"] = _LOTIDPR;
                        indata["LOTID"] = null;
                    }

                    // R/P 공정에서 추가 압연은 자기 차수에서는 체크 가능하게 하고, 그 외는 자동 체크로 진행 [2017-02-16]
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                        SetExtraPress();
                    
                    // 수정 2016.12.21: 단면코터 Back *******************
                    if (isSingleCoater)
                    {
                        if (COATTYPE_COMBO.SelectedValue.Equals("B"))
                        {
                            indata["LOTID_PR"] = _LOTIDPR;
                            indata["LOTID"] = null;
                        }
                    }
                    //***************************************************

                    // SLITTING CUTID 기준 변경으로 LOTID 추가에 SLITTER 추가 ( 2017-01-21 ) CR-53
                    // 슬리터 2차 추가 2021-09-15 by 오화백
                    if ((string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING)) && !string.Equals(WIPSTATUS, Wip_State.WAIT))
                    {
                        LOTINFO_GRID.Columns["CUT_ID"].Visibility = Visibility.Visible;
                        LOTINFO_GRID.Columns["LOTID"].Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        LOTINFO_GRID.Columns["CUT_ID"].Visibility = Visibility.Collapsed;
                        LOTINFO_GRID.Columns["LOTID"].Visibility = Visibility.Visible;
                    }

                    indata["WIPSTAT"] = WIPSTATUS;
                    indata["LANGID"] = LoginInfo.LANGID;
                    indata["PROCID"] = procId;

                    inTable.Rows.Add(indata);

                    DataTable dt = new ClientProxy().ExecuteServiceSync(GetResultLotBizRuleName(), "INDATA", "RSLTDT", inTable);

                     Util.GridSetData(LOTINFO_GRID, dt, FrameOperation);

                    // Modify : 2016.12.13, Slitter | SRS Slitter 모투입수량 설정 추가 ******************** 
                    // 슬리터 2차 추가 2021-09-15 by 오화백
                    if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
                    {
                        // 첫 번째 CUT만 VISIBLE하고 그 외는 숨김 ( 2017-01-21 ) CR-53
                        for (int i = LOTINFO_GRID.TopRows.Count + 1; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                            LOTINFO_GRID.Rows[i].Visibility = Visibility.Collapsed;

                        // LOTINFO GRID 불량수량 GRAY 표시 (CR54)
                        //LOTINFO_GRID.LoadedCellPresenter += OnLoadedCellPresenter;

                        //SetParentQty(WIPSTATUS.Equals(Wip_State.EQPT_END) ? _LOTIDPR : _LOTID, WIPSTATUS);
                        SetParentQty(_LOTIDPR, WIPSTATUS); // OUTLOT 기준으로 변경 (CR54) 

                    }
                    else
                    {
                        SetParentQty(_LOTID, WIPSTATUS);
                    }
                    //*************************************************************************************
                    // Roll Press, Slitter 특이사항 Setting
                    DataTable dtCopy = dt.Copy();
                    BindingWipNote(dtCopy);

                    #region[POSTACTION]
                    BindPostHold(_LOTID, _CUTID);
                    #endregion
                }

                // 해당 설비 완공 시점에서는 설비완공 시점에서 투입량을 수량으로 변경한다 [2017-02-14]
                if (string.Equals(WIPSTATUS, Wip_State.EQPT_END) && txtInputQty.IsReadOnly == false)
                    txtInputQty.Value = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "EQPT_END_QTY"));

                // 절연코터, BACK WINDER는 자동 입력 후 수정 못하게 변경 (믹서는 투입자재 총수량 = 생산량)
                // 믹서 공정 다시 설비완공수량을 생산량으로 자동입력하게 변경, 또한 표면검사는 투입량 -> 생산량 자동입력 및 수정 가능하게 변경 요청
                // 백와인더, INS슬리터 코터는 모LOT 투입 기준 수정X, 나머지 공정들은 모LOT 투입 기준 수정 O
                //if (txtInputQty.IsReadOnly == true && (!string.Equals(procId, Process.PRE_MIXING) && !string.Equals(procId, Process.MIXING) && !string.Equals(procId, Process.SRS_MIXING)))
                // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
                if (txtInputQty.IsReadOnly == true || 
                    string.Equals(procId, Process.REWINDER) || string.Equals(procId, Process.LASER_ABLATION) ||
                    string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.INS_COATING) ||
                    string.Equals(procId, Process.HALF_SLITTING) || string.Equals(procId, Process.TAPING))
                {
                    if(!isRollMapEquipment) txtInputQty.Value = txtParentQty.Value;
                }

                // SRS코터는 기본수량 2000으로 고정해달라는 요청 [2017-03-30]
                if (string.Equals(procId, Process.SRS_COATING))
                    txtInputQty.Value = 2000;

                // SRS슬리터는 COATER IN/OUT수량에 따라 자동 SET [2017-06-07]
                if (string.Equals(procId, Process.SRS_SLITTING))
                    SetSlitterInOutQty();

                // 저장되어 있는 수량이 있으면 그 수량을 최선책으로 지정 [2017-04-21]
                SetSaveProductQty();

                // Rollmap 적용 설비의 경우 투입량을 Input
                if (isRollMapEquipment == true && isCoaterAfterProcess == true )
                    txtInputQty.Value = txtParentQty.Value + Convert.ToDouble(exceedLengthQty);

                SetInputQty();

                // CSR : [C20220117-000411] - 불량/loss 정합화를 위한 시스템 개선 요청 건
                // 신규 길이초과 & 부족 자동 계산 적용 
                string[] sAttrbute = null;

                if (string.Equals(procId, Process.ROLL_PRESSING))
                {
                    sAttrbute = new string[] { LoginInfo.CFG_AREA_ID, procId };
                    isLengthLack = IsCommoncodeAttrUse("PROD_QTY_DEFAULT_AREA_PROC", null, sAttrbute);
                }
                else if (string.Equals(procId, Process.SLITTING))
                {
                    sAttrbute = new string[] { LoginInfo.CFG_AREA_ID, procId, _EQPTID };
                    isLengthLack = IsCommoncodeAttrUse("PROD_QTY_DEFAULT_AREA_PROC", null, sAttrbute);
                }

                // C20220406-000241 - 자동차 1, 2동 전극 슬리터 바코드 불량수, Tag수 표시 
                string[] sBarCode = { LoginInfo.CFG_AREA_ID, procId };
                isBarCodePrint = IsCommoncodeAttrUse("DEFECT_COLUMN_VISIBILITY", null, sBarCode);

                // C20220224-000116 - GMES 슬리터 공정진척 샘플링 팝업 요청 건
                string[] sSlitBarPrt = { LoginInfo.CFG_AREA_ID, procId };
                isSampBarPrt = IsCommoncodeAttrUse("PROC_SMPL_BAR_PRT_FLAG", null, sSlitBarPrt);

                // 공통코드 미등록이면 기존 길이부족 & 길이초과 계산 로직 처리
                if (!isLengthLack)
                    SetInputQtyByEqptEndQty(Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "EQPT_END_QTY")));

            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetPet()
        {
            try
            {
                DataTable _dt = new DataTable();

                DataTable inTable = new DataTable();
                inTable.Columns.Add("LANGID", typeof(string));
                inTable.Columns.Add("CMCDTYPE", typeof(string));

                DataRow indata = inTable.NewRow();
                indata["LANGID"] = LoginInfo.LANGID;
                indata["CMCDTYPE"] = "PROTECT_FILM_TYPE";
                inTable.Rows.Add(indata);

                _dt = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE", "INDATA", "RSLTDT", inTable);

                if (_dt.Rows.Count > 0)
                {
                    cboPet.DisplayMemberPath = "CBO_NAME";
                    cboPet.SelectedValuePath = "CBO_CODE";
                    cboPet.ItemsSource = DataTableConverter.Convert(_dt);
                    cboPet.SelectedIndex = 0;
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetDefectList()
        {
            try
            {
                Util.gridClear(WIPREASON_GRID);
                Util.gridClear(WIPREASON2_GRID);

                if(_dtWipReasonDefectBack != null)
                    _dtWipReasonDefectBack.Clear();

                DataTable inDataTable = new DataTable();
                inDataTable.Columns.Add("LANGID", typeof(string));
                inDataTable.Columns.Add("AREAID", typeof(string));
                inDataTable.Columns.Add("PROCID", typeof(string));
                inDataTable.Columns.Add("LOTID", typeof(string));
                inDataTable.Columns.Add("RESNPOSITION", typeof(string));
                inDataTable.Columns.Add("CODE", typeof(string));

                //Modify 2016.12.19 물청 TOP/BACK 구분 없음(CHARGE2_GRID 삭제) *************************************************************
                List<C1DataGrid> lst = new List<C1DataGrid> { WIPREASON_GRID, WIPREASON2_GRID };
                //**************************************************************************************************************************
                foreach (C1DataGrid dg in lst)
                {
                    DataRow Indata = inDataTable.NewRow();
                    Indata["LANGID"] = LoginInfo.LANGID;
                    Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                    Indata["PROCID"] = procId;
                    Indata["LOTID"] = _LOTID; // LOTID -> _LOTID로 변경, 아니면 위에 MIXER일때 EQPT_END시점에서 PR_LOTID를 LOTID로 넣어주는것때문에 제대로 조회 불가 ( 2017-01-26 )

                    // DEFECT 통합으로 아래와  같이 변경
                    if (procId.Equals(Process.COATING) || procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING))
                        Indata["RESNPOSITION"] = string.Equals(dg.Name, "dgWipReason") ? "DEFECT_TOP" : "DEFECT_BACK";
                    else
                        Indata["RESNPOSITION"] = null;
                    //***********************************************************************************************

                    if (string.Equals(LoginInfo.CFG_AREA_ID, "E6"))
                        Indata["CODE"] = "BAS";

                    inDataTable.Rows.Clear();
                    inDataTable.Rows.Add(Indata);

                    //C20210222-000365 불량/Loss항목 표준화 적용 DA_PRD_SEL_ACTIVITYREASON_ELEC -> BR_PRD_SEL_ACTIVITYREASON_ELEC 변경
                    DataTable dt = new ClientProxy().ExecuteServiceSync("BR_PRD_SEL_ACTIVITYREASON_ELEC", "INDATA", "RSLTDT", inDataTable);

                    if (dg.Visibility == Visibility.Visible)
                        Util.GridSetData(dg, dt, FrameOperation, true);

                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                    {
                        dg.LoadedCellPresenter -= OnLoadedCellPresenter;
                        dg.LoadedCellPresenter += OnLoadedCellPresenter;
                    }

                    // C20210914-000159 GMES 시스템의 QA 샘플대상 LOT 설비 LOSS 자동입력 기능 추가 - 2021.10.07
                    if (string.Equals(procId, Process.ROLL_PRESSING) && dg.Rows.Count > 0)
                    {
                        for (int i = 0; i < dg.Rows.Count; i++)
                        {
                            if (string.Equals(DataTableConverter.GetValue(dg.Rows[i].DataItem, "PRCS_ITEM_CODE"), "RP_QA_BAS_QTY") &&
                                Util.NVC_Decimal(DataTableConverter.GetValue(dg.Rows[i].DataItem, "RESNQTY")) == 0  &&
                                string.Equals(getQAInspectFlag(_LOTID), "Y"))
                            {
                                DataTableConverter.SetValue(dg.Rows[i].DataItem, "RESNQTY", "1");
                            }
                        }
                    }
                }

                // Back 불량 보관
                _dtWipReasonDefectBack = Util.MakeDataTable(WIPREASON2_GRID, true);

                GetSumDefectQty();
                SetCauseTitle();
                SetExceedLength();

                // NISSAN 전용 기능 [2017년 4월까지만 사용] => 사용안함
                //if (string.Equals(LoginInfo.CFG_AREA_ID, "E6") && string.Equals(procId, Process.BACK_WINDER))
                //    SetDefectTagInfo(_LOTIDPR);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetDefectListMultiLane()
        {
            try
            {
                string childLotId;

                // 소형/자동차 전극 사용을 체크박스로 분리 [2017-01-23] CR-55
                bool isElecProdType = (grdDataCollect.Children[0] as UcDataCollect).chkSum.IsChecked == true ? true : false;

                Util.gridClear(WIPREASON_GRID);

                // SET LANE COMBO 설정
                LANENUM_COMBO.Items.Clear();

                CheckBox allCheck = new CheckBox();
                allCheck.IsChecked = true;
                allCheck.Content = Util.NVC("-ALL-");
                allCheck.Tag = "ALL";
                allCheck.Checked += OnLaneChecked;
                allCheck.Unchecked += OnLaneChecked;
                LANENUM_COMBO.Items.Add(allCheck);

                for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                {
                    CheckBox checkBox = new CheckBox();
                    checkBox.IsChecked = true;
                    checkBox.Content = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_NUM"));
                    checkBox.Tag = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                    checkBox.Checked += OnLaneChecked;
                    checkBox.Unchecked += OnLaneChecked;
                    LANENUM_COMBO.Items.Add(checkBox);
                }
                LANENUM_COMBO.Text = ObjectDic.Instance.GetObjectName("Lane선택");

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PROCID"] = procId;
                Indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                IndataTable.Rows.Add(Indata);

                //C20210222-000365 불량/Loss항목 표준화 적용 DA_PRD_SEL_DEFECT -> BR_PRD_SEL_DEFECT 변경
                new ClientProxy().ExecuteService("BR_PRD_SEL_DEFECT", "INDATA", "OUTDATA", IndataTable, (searchResult, searchException) =>
                {
                    try
                    {
                        if (searchException != null)
                        {
                            Util.MessageException(searchException);
                            return;
                        }

                        DataTable totalWipReason = searchResult.DataSet.Tables["OUTDATA"];
                        // 2024.03.08 물청/LOSS 탭 데이터 조회 수정 
                        DataTable dsWipReason = totalWipReason.DefaultView.ToTable(false, "RESNCODE", "ACTID", "ACTNAME", "RESNNAME", "PRCS_ITEM_CODE", "RSLT_EXCL_FLAG", "RESNTOTQTY", "PARTNAME", "TAG_CONV_RATE", "PERMIT_RATE");

                        Util.GridSetData(WIPREASON_GRID, dsWipReason, FrameOperation);

                        if (WIPREASON_GRID.Rows.Count > 0)
                        {
                            if (LOTINFO_GRID.GetRowCount() > 0)
                            {
                                // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                                int iCount = isResnCountUse == true ? 1 : 0;

                                // CONV_RATE기준으로 반영된 컬럼 삭제 [2017-02-15], 
                                //for (int i = WIPREASON_GRID.Columns.Count - 1; i > WIPREASON_GRID.Columns["TAG_CONV_RATE"].Index; i--)
                                //    WIPREASON_GRID.Columns.RemoveAt(i);

                                // 2024.03.08 물청/LOSS 탭 데이터 조회 수정 
                                for (int i = WIPREASON_GRID.Columns.Count - 1; i > WIPREASON_GRID.Columns["TAG_CONV_RATE"].Index; i--)
                                {
                                    if (!WIPREASON_GRID.Columns[i].Name.Equals("PERMIT_RATE")) // 2024-02-07 허용비율(%) 추가 
                                        WIPREASON_GRID.Columns.RemoveAt(i);
                                }

                                if (LOTINFO_GRID.GetRowCount() > 0)
                                {
                                    string sMessageDic = ObjectDic.Instance.GetObjectName("태그수");
                                    string sMessageNum = ObjectDic.Instance.GetObjectName("횟수");
                                    double defectQty = 0;
                                    double lossQty = 0;
                                    double chargeQty = 0;

                                    for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                                    {
                                        childLotId = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));

                                        // 소형 ( SUM, 태그수 X ), 자동차 ( ALL, 태그수 O ) (2017-01-23) CR-54
                                        if (i == LOTINFO_GRID.TopRows.Count)
                                        {
                                            if (isElecProdType)
                                                Util.SetGridColumnNumeric(WIPREASON_GRID, "ALL", null, "SUM", true, true, false, false, 50, HorizontalAlignment.Right, Visibility.Visible, GetUnitFormatted(), false, false);
                                            else
                                                Util.SetGridColumnNumeric(WIPREASON_GRID, "ALL", null, "ALL", true, true, false, false, 50, HorizontalAlignment.Right, Visibility.Visible, GetUnitFormatted(), false, false);
                                        }

                                        if (isResnCountUse == true)
                                        {
                                            Util.SetGridColumnNumeric(WIPREASON_GRID, childLotId + "NUM", null, sMessageNum,
                                                true, true, false, false, 60, HorizontalAlignment.Right, isElecProdType == false ? Visibility.Visible : Visibility.Collapsed, "F0", false, false);
                                        }

                                        Util.SetGridColumnNumeric(WIPREASON_GRID, childLotId + "CNT", null, sMessageDic,
                                            true, true, false, false, 60, HorizontalAlignment.Right, isElecProdType == false ? Visibility.Visible : Visibility.Collapsed, "F0", false, false);

                                        // HALF SLITTING의 경우 8번째 자리 값으로 표시해달라는 요청으로 추가 [2017-05-08]
                                        if (string.Equals(procId, Process.HALF_SLITTING))
                                        {
                                            Util.SetGridColumnNumeric(WIPREASON_GRID, childLotId, null, childLotId.Length > 8 ? childLotId.Substring(7, 1) : Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_NUM")),
                                                true, true, false, false, 50, HorizontalAlignment.Right, Visibility.Visible, GetUnitFormatted(), false, false);
                                        }
                                        else
                                        {
                                            Util.SetGridColumnNumeric(WIPREASON_GRID, childLotId, null, Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_NUM")),
                                                true, true, false, false, 50, HorizontalAlignment.Right, Visibility.Visible, GetUnitFormatted(), false, false);
                                        }
                                        DataGridAggregate.SetAggregateFunctions(WIPREASON_GRID.Columns[childLotId], new DataGridAggregatesCollection {
                                            new DataGridAggregateSum { ResultTemplate = this.Resources["ResultTemplate"] as DataTemplate  }});

                                        if (WIPREASON_GRID.Rows.Count == 0)
                                            continue;

                                        DataTable dt = GetDefectDataByLot(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID")));

                                        if (dt != null)
                                        {
                                            if (isResnCountUse == true)
                                            {
                                                for (int j = 0; j < dt.Rows.Count; j++)
                                                {
                                                    if (dt.Rows[j]["COUNTQTY"].ToString().Equals(""))
                                                        BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count - 2, null);
                                                    else
                                                        BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count - 2, dt.Rows[j]["COUNTQTY"]);
                                                }
                                            }

                                            for (int j = 0; j < dt.Rows.Count; j++)
                                            {
                                                if (dt.Rows[j]["DFCT_TAG_QTY"].ToString().Equals(""))
                                                    BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count - 1, 0);
                                                else
                                                    BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count - 1, dt.Rows[j]["DFCT_TAG_QTY"]);
                                            }

                                            for (int j = 0; j < dt.Rows.Count; j++)
                                            {
                                                if (dt.Rows[j]["RESNQTY"].ToString().Equals(""))
                                                    BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count, 0);
                                                else
                                                    BindingDataGrid(WIPREASON_GRID, j, WIPREASON_GRID.Columns.Count, dt.Rows[j]["RESNQTY"]);
                                            }
                                        }

                                        // SLITTER는 CUT단위로 변경되면서 CUT단위는 합산수량, 그 외는 개별로 처리 [2017-01-21] CR-53
                                        // 슬리터 2차 추가  2021-09-15 by 오화백
                                        if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
                                        {
                                            DataTable distinctDt = DataTableConverter.Convert(WIPREASON_GRID.ItemsSource).DefaultView.ToTable(true, "ACTID");
                                            foreach (DataRow _row in distinctDt.Rows)
                                            {
                                                if (string.Equals(_row["ACTID"], "DEFECT_LOT"))
                                                    defectQty += SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                                else if (string.Equals(_row["ACTID"], "LOSS_LOT"))
                                                    lossQty += SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                                else if (string.Equals(_row["ACTID"], "CHARGE_PROD_LOT"))
                                                    chargeQty += SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                            }

                                            if (i == ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) - 1))
                                            {
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_DEFECT", defectQty);
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_LOSS", lossQty);
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "DTL_CHARGEPRD", chargeQty);
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY", (defectQty + lossQty + chargeQty));
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY", (Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) * LOTINFO_GRID.GetRowCount()) - Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY")));
                                                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY")) * Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LANE_QTY")));
                                            }
                                        }
                                        else
                                        {
                                            defectQty = 0;
                                            lossQty = 0;
                                            chargeQty = 0;

                                            DataTable distinctDt = DataTableConverter.Convert(WIPREASON_GRID.ItemsSource).DefaultView.ToTable(true, "ACTID");
                                            foreach (DataRow _row in distinctDt.Rows)
                                            {
                                                if (string.Equals(_row["ACTID"], "DEFECT_LOT"))
                                                    defectQty = SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                                else if (string.Equals(_row["ACTID"], "LOSS_LOT"))
                                                    lossQty = SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                                else if (string.Equals(_row["ACTID"], "CHARGE_PROD_LOT"))
                                                    chargeQty = SumDefectQty(WIPREASON_GRID, i, childLotId, Util.NVC(_row["ACTID"]));
                                            }

                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_DEFECT", defectQty);
                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_LOSS", lossQty);
                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "DTL_CHARGEPRD", chargeQty);
                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY", (defectQty + lossQty + chargeQty));
                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY")) - Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY")));
                                            DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY")));
                                        }
                                    }
                                }

                                // COST CENTER 컬럼 맨 뒤로 오게하는 요청으로 해당 컬럼 제일 하위에서 생성 [2017-02-07]
                                // 전 공정 횟수 관리를 위하여 컬럼 추가 (C20190416_75868 ) [2019-04-17]
                                Util.SetGridColumnText(WIPREASON_GRID, "COSTCENTERID", null, "COSTCENTERID", true, true, true, true, C1.WPF.DataGrid.DataGridLength.Auto, HorizontalAlignment.Center, Visibility.Collapsed);
                                Util.SetGridColumnText(WIPREASON_GRID, "COSTCENTER", null, "COSTCENTER", true, true, true, true, C1.WPF.DataGrid.DataGridLength.Auto, HorizontalAlignment.Center, Visibility.Collapsed);
                                Util.SetGridColumnText(WIPREASON_GRID, "TAG_ALL_APPLY_FLAG", null, "TAG_ALL_APPLY_FLAG", true, true, true, true, C1.WPF.DataGrid.DataGridLength.Auto, HorizontalAlignment.Center, Visibility.Collapsed);

                                if (isResnCountUse == true)
                                {
                                    Util.SetGridColumnText(WIPREASON_GRID, "WRK_COUNT_MNGT_FLAG", null, "WRK_COUNT_MNGT_FLAG", true, true, true, true, C1.WPF.DataGrid.DataGridLength.Auto, HorizontalAlignment.Center, Visibility.Collapsed);
                                    Util.SetGridColumnText(WIPREASON_GRID, "LINK_DETL_RSN_CODE_TYPE", null, "LINK_DETL_RSN_CODE_TYPE", true, true, true, true, C1.WPF.DataGrid.DataGridLength.Auto, HorizontalAlignment.Center, Visibility.Collapsed);
                                }

                                for (int i = 0; i < totalWipReason.Rows.Count; i++)
                                {
                                    BindingDataGrid(WIPREASON_GRID, i, WIPREASON_GRID.Columns["COSTCENTERID"].Index + 1, totalWipReason.Rows[i]["COSTCENTERID"]);
                                    BindingDataGrid(WIPREASON_GRID, i, WIPREASON_GRID.Columns["COSTCENTER"].Index + 1, totalWipReason.Rows[i]["COSTCENTER"]);
                                    BindingDataGrid(WIPREASON_GRID, i, WIPREASON_GRID.Columns["TAG_ALL_APPLY_FLAG"].Index + 1, totalWipReason.Rows[i]["TAG_ALL_APPLY_FLAG"]);

                                    if (isResnCountUse == true)
                                    {
                                        BindingDataGrid(WIPREASON_GRID, i, WIPREASON_GRID.Columns["WRK_COUNT_MNGT_FLAG"].Index + 1, totalWipReason.Rows[i]["WRK_COUNT_MNGT_FLAG"]);
                                        BindingDataGrid(WIPREASON_GRID, i, WIPREASON_GRID.Columns["LINK_DETL_RSN_CODE_TYPE"].Index + 1, totalWipReason.Rows[i]["LINK_DETL_RSN_CODE_TYPE"]);
                                    }
                                }

                                // ROW별 합산 수량 반영 [2017-02-15]
                                double rowSum = 0;
                                for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                                {
                                    rowSum = 0;
                                    for (int j = WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount); j < WIPREASON_GRID.Columns["COSTCENTERID"].Index; j += (2 + iCount))
                                        rowSum += Convert.ToDouble(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, WIPREASON_GRID.Columns[j].Name));

                                    DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNTOTQTY", rowSum);
                                }
                                Util.GridSetData(WIPREASON_GRID, DataTableConverter.Convert(WIPREASON_GRID.ItemsSource), FrameOperation, true);
                                SetExceedLength();
                                WIPREASON_GRID.Refresh(false);
                                WIPREASON_GRID.FrozenColumnCount = WIPREASON_GRID.Columns["ALL"].Index + 1;

                                // S/L공정의 경우 TAG 불량/LOSS 자동 반영을 위하여 하기와 같이 이전 값을 DataTable로 보관(C20190404_67447)  [2019-04-11]
                                dtWipReasonBak = DataTableConverter.Convert(WIPREASON_GRID.ItemsSource);
                            }
                        }
                    }
                    catch (Exception ex) { Util.MessageException(ex); }
                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

    

        private double SumDefectQty(string actId)
        {
            double sum = 0;

            if (WIPREASON_GRID.Rows.Count > 0)
                for (int i = 0; i < WIPREASON_GRID.GetRowCount(); i++)
                    if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY"))))
                        if (!string.Equals(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RSLT_EXCL_FLAG")), "Y"))
                                if (DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "ACTID").ToString().Equals(actId))
                                    sum += (Convert.ToDouble(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY")) *
                                        (WIPREASON2_GRID.Visibility == Visibility.Visible && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING)) ? 0.5 : 1));

            if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Rows.Count > 0)
                for (int i = 0; i < WIPREASON2_GRID.GetRowCount(); i++)
                    if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "RESNQTY"))))
                        if (!string.Equals(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "RSLT_EXCL_FLAG")), "Y"))
                                if (DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "ACTID").ToString().Equals(actId))
                                    sum += Convert.ToDouble(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[i].DataItem, "RESNQTY"));

            return sum;
        }

        private double SumDefectQty(C1DataGrid dg, string lotId)
        {
            double sum = 0;

            if (dg.Rows.Count > 0)
                for (int i = 0; i < dg.GetRowCount(); i++)
                    if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(dg.Rows[i].DataItem, lotId))))
                        if (!string.Equals(Util.NVC(DataTableConverter.GetValue(dg.Rows[i].DataItem, "RSLT_EXCL_FLAG")), "Y"))
                                sum += (Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[i].DataItem, lotId)) *
                                ((string.Equals(dg.Name, "dgWipReason") && WIPREASON2_GRID.Visibility == Visibility.Visible && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING))) ? 0.5 : 1));

            return sum;
        }
        private double SumDefectQty(C1DataGrid dg, int index, string lotId, string actId)
        {
            double sum = 0;

            if (dg.Rows.Count > 0)
                for (int i = 0; i < dg.GetRowCount(); i++)
                    if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(dg.Rows[i].DataItem, lotId))))
                        if (!string.Equals(Util.NVC(DataTableConverter.GetValue(dg.Rows[i].DataItem, "RSLT_EXCL_FLAG")), "Y"))
                                if (DataTableConverter.GetValue(dg.Rows[i].DataItem, "ACTID").ToString().Equals(actId))
                                sum += (Convert.ToDouble(DataTableConverter.GetValue(dg.Rows[i].DataItem, lotId)) *
                                    ((string.Equals(dg.Name, "dgWipReason") && WIPREASON2_GRID.Visibility == Visibility.Visible && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.SRS_COATING))) ? 0.5 : 1));

            return sum;
        }

        private void BindingDataGrid(C1DataGrid dg, int iRow, int iCol, object sValue)
        {
            try
            {
                if (dg.ItemsSource == null)
                {
                    return;
                }
                else
                {
                    DataTable dt = DataTableConverter.Convert(dg.ItemsSource);

                    if (dt.Columns.Count < dg.Columns.Count)
                        for (int i = dt.Columns.Count; i < dg.Columns.Count; i++)
                            dt.Columns.Add(dg.Columns[i].Name);

                    if (sValue.Equals("") || sValue.Equals(null))
                        sValue = 0;

                    dt.Rows[iRow][iCol - 1] = sValue;

                    dg.BeginEdit();
                    Util.GridSetData(dg, dt, FrameOperation, false);
                    dg.EndEdit();
                }
            }
            catch { }
        }

        void SetGridComboItem(C1.WPF.DataGrid.DataGridColumn col, string sWOID)
        {
            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("LANGID", typeof(string));
            IndataTable.Columns.Add("WOID", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LANGID"] = LoginInfo.LANGID;
            Indata["WOID"] = sWOID;
            IndataTable.Rows.Add(Indata);

            DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_COM_SEL_TB_SFC_WO_MTRL2", "INDATA", "RSLTDT", IndataTable);

            (col as C1.WPF.DataGrid.DataGridComboBoxColumn).ItemsSource = DataTableConverter.Convert(dtMain);
        }

        private void SetGridComboItemTP(C1.WPF.DataGrid.DataGridColumn col, string sLotID)
        {
            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("LANGID", typeof(string));
            IndataTable.Columns.Add("LOTID", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LANGID"] = LoginInfo.LANGID;
            Indata["LOTID"] = sLotID;
            IndataTable.Rows.Add(Indata);

            DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_COM_SEL_TB_SFC_WO_MTRL_MO", "INDATA", "RSLTDT", IndataTable);

            (col as C1.WPF.DataGrid.DataGridComboBoxColumn).ItemsSource = DataTableConverter.Convert(dtMain);
        }

        private void SetMaterial(string LotID, string PROC_TYPE)
        {
            if (INPUTMTRL_GRID.Rows.Count < 1)
                return;

            try
            {
                DataSet inDataSet = new DataSet();

                DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                inDataTable.Columns.Add("SRCTYPE", typeof(string));
                inDataTable.Columns.Add("EQPTID", typeof(string));
                inDataTable.Columns.Add("LOTID", typeof(string));
                inDataTable.Columns.Add("USERID", typeof(string));

                DataRow inDataRow = null;

                inDataRow = inDataTable.NewRow();
                inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                inDataRow["EQPTID"] = _EQPTID;
                inDataRow["LOTID"] = _LOTID;
                inDataRow["USERID"] = LoginInfo.USERID;
                inDataTable.Rows.Add(inDataRow);

                DataRow inLotDataRow = null;

                DataTable InLotdataTable = inDataSet.Tables.Add("IN_INPUT");
                InLotdataTable.Columns.Add("INPUT_LOTID", typeof(string));
                InLotdataTable.Columns.Add("MTRLID", typeof(string));
                InLotdataTable.Columns.Add("INPUT_QTY", typeof(decimal));
                InLotdataTable.Columns.Add("PROC_TYPE", typeof(string));
                InLotdataTable.Columns.Add("INPUT_SEQNO", typeof(Int32));

                DataTable dt = ((DataView)INPUTMTRL_GRID.ItemsSource).Table;

                foreach (DataRow row in dt.Rows)
                {
                    if (Convert.ToBoolean(row["CHK"]))
                    {
                        if (!Util.NVC(row["MTRLID"]).Equals(""))
                        {
                            inLotDataRow = InLotdataTable.NewRow();
                            inLotDataRow["INPUT_LOTID"] = Util.NVC(row["INPUT_LOTID"]);
                            inLotDataRow["MTRLID"] = Util.NVC(row["MTRLID"]);
                            inLotDataRow["INPUT_QTY"] = Util.NVC_Decimal(row["INPUT_QTY"]);
                            inLotDataRow["PROC_TYPE"] = PROC_TYPE;
                            inLotDataRow["INPUT_SEQNO"] = Util.NVC_Int(row["INPUT_SEQNO"]);
                            InLotdataTable.Rows.Add(inLotDataRow);
                        }
                    }
                }

                DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_INPUT_LOT_HIST_MX", "INDATA,IN_INPUT", null, inDataSet);

                Thread.Sleep(500);

                GetMaterial(LotID);
                isChangeMaterial = false;
                Util.MessageInfo("SFU1270");    //저장되었습니다.
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        string GetStartCancelBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E0500":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_PM";
                    break;

                case "E1000":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_MX";
                    break;

                case "E2000":
                case "S2000":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_CT";
                    break;

                case "E2300":
                case "E4500":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_IC"; //INS코터 
                    break;

                case "E2500":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_HS";
                    break;

                case "E3000":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_RP";
                    break;

                case "E3500":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_TP";
                    break;

                case "E3300": //LASER ABLITION
                case "E3800":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_SI";
                    break;

                case "E3900":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_BW";
                    break;

                case "E4000":
                case "E4200":  //슬리터 2차 추가  2021-09-15 by 오화백
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_SL";
                    break;

                case "E4600":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_HT_UI";
                    break;

                case "S1000":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_SX";
                    break;

                case "S4000":
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_SS";
                    break;

                default:
                    bizRuleName = "BR_PRD_REG_CANCEL_START_LOT_CT";
                    break;
            }

            return bizRuleName;
        }

        private void StartCancelProcess()
        {
            try
            {
                if (_WIPSTAT.Equals("WAIT"))
                    return;

                if (_WIPSTAT.Equals("EQPT_END"))
                {
                    Util.MessageValidation("SFU1671");  //설비 완공 LOT은 취소할 수 없습니다.
                    return;
                }

                // [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청
                // 1. 해당 동 적용 여부 체크
                // 2. 적용 동 버튼 적용 여부 체크
                string[] sAttrbute = { null, procId, "CANCEL_LOTSTART_W" };      
                                           
                if (IsAreaCommoncodeAttrUse("PERMISSIONS_PER_BUTTON", "", sAttrbute))
                    if (!CheckButtonPermissionGroupByBtnGroupID("CANCEL_LOTSTART_W")) return; 

                //선택된 LOT을 작업 취소하시겠습니까?
                Util.MessageConfirm("SFU3151", (sResult) =>
                {
                    if (sResult == MessageBoxResult.OK)
                    {
                        #region Lot Info
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("LOTID", typeof(string));
                        inDataTable.Columns.Add("CSTID", typeof(string));
                        inDataTable.Columns.Add("OUT_CSTID", typeof(string));
                        inDataTable.Columns.Add("USERID", typeof(string));
                        inDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inDataRow = null;

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            inDataRow = null;
                            inDataRow = inDataTable.NewRow();

                            inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                            inDataRow["EQPTID"] = _EQPTID;
                            inDataRow["LOTID"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID").ToString();
                            //inDataRow["CSTID"] = _LDR_LOT_IDENT_BAS_CODE;
                            if (_LDR_LOT_IDENT_BAS_CODE == "CST_ID" || _LDR_LOT_IDENT_BAS_CODE == "RF_ID")
                            {
                                if (LOTINFO_GRID.Columns["CSTID"] != null)
                                {
                                    //CSTID가 NULL인 경우에는 오류가 발생하여 Util.NVC를 사용함.
                                    inDataRow["CSTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "CSTID"));
                                }
                            }
                            //inDataRow["OUT_CSTID"] = _UNLDR_LOT_IDENT_BAS_CODE;
                            if (_UNLDR_LOT_IDENT_BAS_CODE == "CST_ID" || _UNLDR_LOT_IDENT_BAS_CODE == "RF_ID")
                            {
                                if (LOTINFO_GRID.Columns["OUT_CSTID"] != null)
                                {
                                    inDataRow["OUT_CSTID"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "OUT_CSTID").ToString();
                                }
                            }
                            inDataRow["USERID"] = LoginInfo.USERID;
                            inDataRow["INPUT_LOTID"] = _LOTIDPR; ;
                            inDataTable.Rows.Add(inDataRow);
                        }
                        #endregion

                        // Add : 2016.12.10, Slitter, SRS Slitter 작업시작 취소 추가 *******************************
                        // 슬리터 2차  추가  2021-09-15 by 오화백
                        if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING))
                        {
                            #region Parent Lot
                            DataRow inLotDataRow = null;

                            DataTable InLotdataTable = inDataSet.Tables.Add("IN_PRLOT");
                            InLotdataTable.Columns.Add("PR_LOTID", typeof(string));
                            InLotdataTable.Columns.Add("CUT_ID", typeof(string));
                            InLotdataTable.Columns.Add("CSTID", typeof(string));

                            inLotDataRow = InLotdataTable.NewRow();
                            inLotDataRow["PR_LOTID"] = _LOTIDPR;
                            inLotDataRow["CUT_ID"] = _CUTID;
                            if (_LDR_LOT_IDENT_BAS_CODE == "CST_ID" || _LDR_LOT_IDENT_BAS_CODE == "RF_ID")
                            {
                                inLotDataRow["CSTID"] = _CSTID;
                            }

                            InLotdataTable.Rows.Add(inLotDataRow);
                            #endregion
                        }
                        // 슬리터 2차 추가  2021-09-15 by 오화백 
                        new ClientProxy().ExecuteService_Multi(GetStartCancelBizRuleName(), procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING) ? "INDATA,IN_PRLOT" : "INDATA", null, (result, ex) =>
                        {
                            if (ex != null)
                            {
                                //Util.AlertByBiz(GetStartCancelBizRuleName(), ex.Message, ex.ToString());
                                Util.MessageException(ex);
                                return;
                            }

                            Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                            REFRESH = true;
                        }, inDataSet);
                    }
                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void EqptEndCancelProcess()
        {
            try
            {
                if (_WIPSTAT.Equals("WAIT"))
                    return;

                if (_WIPSTAT.Equals("PROC"))
                {
                    Util.MessageValidation("SFU3464");  //진행중인 LOT은 장비완료취소 할 수 없습니다. [진행중인 LOT은 시작취소 버튼으로 작업취소 바랍니다.]
                    return;
                }

                // [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청
                // 1. 해당 동 적용 여부 체크
                // 2. 적용 동 버튼 적용 여부 체크
                string[] sAttrbute = { null, procId, "CANCEL_EQPT_END_W" };

                if (IsAreaCommoncodeAttrUse("PERMISSIONS_PER_BUTTON", "", sAttrbute))
                       if (!CheckButtonPermissionGroupByBtnGroupID("CANCEL_EQPT_END_W")) return;
                
                //선택된 LOT을 작업 취소하시겠습니까?
                Util.MessageConfirm("SFU3151", (sResult) =>
                {
                    if (sResult == MessageBoxResult.OK)
                    {
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("PROCID", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("USERID", typeof(string));

                        DataRow inDataRow = inDataTable.NewRow();
                        inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inDataRow["PROCID"] = procId;
                        inDataRow["EQPTID"] = _EQPTID;
                        inDataRow["USERID"] = LoginInfo.USERID;
                        inDataTable.Rows.Add(inDataRow);

                        DataTable InLotdataTable = inDataSet.Tables.Add("INLOT");
                        InLotdataTable.Columns.Add("LOTID", typeof(string));
                        InLotdataTable.Columns.Add("CUT_ID", typeof(string));
                        InLotdataTable.Columns.Add("WIPNOTE", typeof(string));

                        DataRow inLotDataRow = InLotdataTable.NewRow();
                        // 슬리터 2차 추가  2021-09-15 by 오화백 
                        if (procId.Equals(Process.SLITTING) || procId.Equals("E4200") || procId.Equals(Process.SRS_SLITTING) || procId.Equals(Process.HALF_SLITTING))
                            inLotDataRow["CUT_ID"] = _CUTID;
                        else
                            inLotDataRow["LOTID"] = _LOTID;

                        InLotdataTable.Rows.Add(inLotDataRow);

                        new ClientProxy().ExecuteService_Multi("BR_PRD_REG_CANCEL_EQPT_END_LOT_ELTR", "INDATA,INLOT", null, (result, ex) =>
                        {
                            if (ex != null)
                            {
                                //Util.AlertByBiz("BR_PRD_REG_CANCEL_EQPT_END_LOT_ELTR", ex.Message, ex.ToString());
                                Util.MessageException(ex);
                                return;
                            }

                            Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.
                            REFRESH = true;
                        }, inDataSet);
                    }
                });
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        string GetParentQtyBizRuleName()
        {
            string bizRuleName;

            if (isSingleCoater)
            {
                if (COATTYPE_COMBO.SelectedValue.Equals("B"))
                    bizRuleName = "DA_PRD_SEL_QTY";
                else
                    bizRuleName = "DA_PRD_SEL_PRLOT_QTY";
            }
            else
            {
                switch (procId)
                {
                    case "E2300":
                    case "E2500":
                    case "E3000":
                    case "E3500":
                    case "E3300": //LASER ABLITION
                    case "E3800":
                    case "E3900":
                        bizRuleName = "DA_PRD_SEL_QTY";
                        break;

                    default:
                        bizRuleName = "DA_PRD_SEL_PRLOT_QTY";
                        break;
                }
            }
            return bizRuleName;
        }

        private void SetParentQty(string lotid, string status)
        {
            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIPSTAT", typeof(string));

                DataRow indata = inTable.NewRow();
                indata["LOTID"] = lotid;
                indata["WIPSTAT"] = status;

                inTable.Rows.Add(indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync(GetParentQtyBizRuleName(), "INDATA", "RSLTDT", inTable);

                if (dt.Rows.Count > 0)
                {
                    if (status.Equals(Wip_State.EQPT_END))
                        txtInputQty.Value = Convert.ToDouble(dt.Rows[0]["WIPQTY_OUT"]);

                    txtParentQty.Value = Convert.ToDouble(dt.Rows[0]["WIPQTY_IN"].ToString());
                    SetParentRemainQty();

                    // 절연코터는 투입량 = 생산량이어야 해서 자동 입력 후 수정 못하게 변경
                    if (string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.INS_SLIT_COATING))
                    {
                        txtInputQty.Value = Convert.ToDouble(dt.Rows[0]["WIPQTY_IN"].ToString());
                        SetInputQty();
                    }
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        void SetInputQty()
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
                return;

            decimal inputQty = Util.NVC_Decimal(txtInputQty.Value);
            double defectQty = 0;
            double LossQty = 0;
            double chargeQty = 0;
            decimal totalQty = 0;
            int laneqty = 0;
            
            // 슬리터 2차 추가 2021-09-15 by 오화백 
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
            {
                totalQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LANE_QTY"));

                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY", inputQty);
                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY", (inputQty * LOTINFO_GRID.GetRowCount()) - totalQty);
            }
            else
            {
                
                for (int i = 0 + LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                {
                    //LOSS QTY 재계산하여 가져옴
                    if (isLengthLack)
                    {
                        defectQty = SumDefectQty("DEFECT_LOT");
                        LossQty = SumDefectQty("LOSS_LOT");
                        chargeQty = SumDefectQty("CHARGE_PROD_LOT");
                        totalQty = Convert.ToDecimal( defectQty + LossQty + chargeQty);
                    }
                    else
                        totalQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                    laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));

                    if (string.IsNullOrEmpty(Util.NVC(txtInputQty.Tag)))
                    {
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", inputQty);
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", inputQty - totalQty);
                    }
                    else
                    {
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", inputQty + totalQty);
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", inputQty);
                    }

                    if (txtLaneQty != null && !string.Equals(procId, Process.HALF_SLITTING))
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * Util.NVC_Decimal(txtLaneQty.Value));
                    else
                        DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * laneqty);
                }
            }

            //if ((grdResult.Children[0] as UcResult).grdSummary.Visibility == Visibility.Visible)
            if (isCoaterAfterProcess)
                SetParentRemainQty();
            else
                txtInputQty.Value = 0;
        }

        /// <summary>
        /// CSR : [E20230525-001029] - 길이초과/길이부족 자동계산 Refresh 
        /// SetInputQty 수량 계산은 슬리터 공정이 조건문으로 되여 있어 계산 차이가 발생
        /// LotInfo Top/Bottom 차이를 동일하게 적용계산
        /// Form Loading시에만 사용
        /// </summary>
        void SetCalcAutoRefresh()
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
                return;

            decimal inputQty = Util.NVC_Decimal(txtInputQty.Value);
            decimal totalQty = 0;
            int laneqty = 0;

            for (int i = 0 + LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
            {
                totalQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));

                if (string.IsNullOrEmpty(Util.NVC(txtInputQty.Tag)))
                {
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", inputQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", inputQty - totalQty);
                }
                else
                {
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", inputQty + totalQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", inputQty);
                }

                if (txtLaneQty != null && !string.Equals(procId, Process.HALF_SLITTING))
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * Util.NVC_Decimal(txtLaneQty.Value));
                else
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * laneqty);
            }

            // 슬리터는 TOP 수량 계산을 한번더 실행
            if (string.Equals(procId, Process.SLITTING))
            {
                totalQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LANE_QTY"));

                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY", inputQty);
                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY", (inputQty * LOTINFO_GRID.GetRowCount()) - totalQty);
            }

            if (isCoaterAfterProcess)
                SetParentRemainQty();
            else
                txtInputQty.Value = 0;
        }

        void SetLengthLackQty(double LackQty)
        {
            // [C20220117-000411] - 불량/loss 정합화를 위한 시스템 개선 요청 건
            if (LOTINFO_GRID.GetRowCount() < 1)
                return;

            decimal inputQty = Util.NVC_Decimal(LackQty);
            decimal lossQty = 0;
            int laneqty = 0;

            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
            {
                lossQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LANE_QTY"));

                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY", inputQty);
                DataTableConverter.SetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY", (inputQty * LOTINFO_GRID.GetRowCount()) - lossQty);
            }
            else
            {
                for (int i = 0 + LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                {
                    lossQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                    laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));

                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", inputQty - lossQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", inputQty);
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY")) * Util.NVC_Decimal(txtLaneQty.Value));
                }
            }

            txtInputQty.Value = 0;
        }

        void SetGoodQty()
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
                return;

            double goodQty = txtGoodQty.Value;
            double lossQty = 0;
            int laneqty = 1;
            int laneptnqty = 1;

            if ((grdResult.Children[0] as UcResult).grdSummary.Visibility == Visibility.Visible)
            {
                if (txtParentQty != null)
                {
                    if (goodQty > double.Parse(string.IsNullOrEmpty(txtParentQty.Value.ToString()) ? "0" : txtParentQty.Value.ToString()))
                    {
                        Util.MessageValidation("SFU1612");  //생산량이 모LOT 투입량 보다 클 수 없습니다.
                        return;
                    }
                }
            }

            for (int i = 0 + LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
            {
                lossQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                laneqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY"));
                laneptnqty = Util.NVC_Int(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_PTN_QTY"));

                DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY", goodQty);
                DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY", goodQty + lossQty);

                DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", laneqty * laneptnqty * goodQty);

                if (txtLaneQty != null)
                    DataTableConverter.SetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODPTNQTY", txtLaneQty.Value * txtLanePatternQty.Value * goodQty);
            }

            if ((grdResult.Children[0] as UcResult).grdSummary.Visibility == Visibility.Visible)
                SetParentRemainQty();
        }

        private void SetParentRemainQty()
        {
            decimal parentQty = 0;
            decimal inputQty = 0;

            parentQty = Util.NVC_Decimal(string.IsNullOrEmpty(txtParentQty.Value.ToString()) ? "0" : txtParentQty.Value.ToString());
            inputQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
            //inputQty = Convert.ToDouble(string.IsNullOrEmpty(txtInputQty.Value.ToString()) ? "0" : txtInputQty.Value.ToString());

            // 믹서공정 기준으로는 투입량이 따로 없어 0으로 표시
            if (isCoaterAfterProcess == false)
                txtRemainQty.Value = 0;
            else
                txtRemainQty.Value = Convert.ToDouble(parentQty - (inputQty - exceedLengthQty));

            txtInputQty.Value = 0;
        }

        /// <summary>
        /// CSR : [C20220117-000411] - 불량/loss 정합화를 위한 시스템 개선 요청 건
        /// 불량/LOSS Grid 길이초과 및 길이부족 계산 및 적용
        /// </summary>
        private void SetExcessDeficiency(bool isKeyInput = false)
        {
            try
            {
                decimal LossUW_Qty = 0;
                double LackQty = 0;

                if (LOTINFO_GRID.GetRowCount() < 1)
                    return;

                int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                // WIPATTR.FINL_CUT_FLAG 값이 'Y' 이면 진행
                if (Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "FINAL_CUT_FLAG")) != "Y" && isKeyInput == false)
                    return;
                

                // 길이부족과 길이초과 초기화
                if (string.Equals(procId, Process.ROLL_PRESSING) && isKeyInput == true)
                {
                    for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                    {
                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                        {
                            if (Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY")) > 0)
                            {
                                DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY", 0);
                            }
                        }

                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                        {
                            if (Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY")) > 0)
                            {
                                DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY", 0);
                            }
                        }
                    }
                }
                else if(string.Equals(procId, Process.SLITTING) && isKeyInput == true)
                {
                    
                    for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                    {
                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                        {
                            if (Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNTOTQTY")) > 0)
                            {
                                if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, 0) == false)
                                    return;
                                DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "ALL", 0);
                            }
                        }

                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                        {
                            if (Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNTOTQTY")) > 0)
                            {
                                if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_EXCEED, 0) == false)
                                    return;
                                DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "ALL", 0);
                            }
                        }
                    }
                }

                // LOSS UW 연결 수량 가져오기(MMD 공정별 기존불량수량)
                for (int k = 0; k < WIPREASON_GRID.Rows.Count; k++)
                {
                    if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "PRCS_ITEM_CODE"), "PROD_QTY_DEFAULT"))
                    {
                        LossUW_Qty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "RESNQTY"));
                    }
                }

                // 자동계산과 생산량 수기 입력 두가지로 InputQty 별도 변수로 처리
                // LOSS UW 연결수량과 장비수량 합계
                if (isKeyInput == true)
                {
                    LackQty = txtInputQty.Value;
                }
                else
                {
                    LackQty = txtInputQty.Value = (Convert.ToDouble(LossUW_Qty + Convert.ToDecimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "EQPT_END_QTY"))));
                }

                if (Convert.ToDouble(txtInputQty.Value) > Convert.ToDouble(txtParentQty.Value))
                {
                    decimal diffQty = Math.Abs(Util.NVC_Decimal(txtParentQty.Value) - Util.NVC_Decimal(txtInputQty.Value));

                    // 투입량의 제한률 이상 초과하면 입력 금지, 단 INPUT_OVER_RATE가 등록되어있지 않으면 SKIP
                    decimal inputRateQty = Util.NVC_Decimal(Util.NVC_Decimal(txtParentQty.Value) * inputOverrate);

                    if (inputRateQty > 0 && diffQty > inputRateQty)
                    {
                        Util.MessageValidation("SFU3195", new object[] { Util.NVC(inputOverrate * 100) + "%" });//투입량의 %1를 초과하여 입력 불가 [생산량 재 입력 후 진행]
                        isChangeInputFocus = false;
                        return;
                    }

                    if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_EXCEED, diffQty) == false)
                        return;

                    exceedLengthQty = diffQty;

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                    {
                        if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_EXCEED, diffQty) == false)
                            return;
                    }

                    isChangeWipReason = true;
                    SetInputQty();
                    WIPREASON_GRID.Refresh();
                    LOTINFO_GRID.Refresh(false);

                }
                else if (Convert.ToDouble(txtInputQty.Value) < Convert.ToDouble(txtParentQty.Value))
                {
                    LackQty = txtParentQty.Value;
                    double DefaltValue = Convert.ToDouble(txtParentQty.Value) - Convert.ToDouble(txtInputQty.Value);
                    if (DefaltValue < LossLackQty && DefaltValue > 0)
                    {
                        decimal DfatValue = Convert.ToDecimal(DefaltValue);
                        Util.MessageConfirm("SFU8169", (vResult) =>
                        {
                            if (vResult == MessageBoxResult.OK)
                            {
                                if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, DfatValue) == false)
                                    return;

                                exceedLengthQty = DfatValue;

                                if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                                {
                                    if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, DfatValue) == false)
                                        return;
                                }

                                isChangeWipReason = true;
                                SetLengthLackQty(LackQty);
                                WIPREASON_GRID.Refresh();
                                LOTINFO_GRID.Refresh(false);

                                //실적확정시 길이초과 Validation Chack시 'True' 처리를 위함
                                exceedLengthQty = 0;
                            }
                            else
                            {
                                txtInputQty.Value = 0;
                            }
                        }, new object[] { Convert.ToString(Math.Round(DefaltValue, 2)) + txtUnit.Text });
                    }
                    else
                    {
                        SetInputQty();
                        GetSumDefectQty();
                    }
                }
                else
                {
                    SetInputQty();
                    GetSumDefectQty();
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void SetLotAutoSelected()
        {
            if (LARGELOT_GRID.Visibility == Visibility.Visible)
            {
                if (LARGELOT_GRID != null && LARGELOT_GRID.Rows.Count > 0)
                {
                    C1.WPF.DataGrid.DataGridCell currCell = LARGELOT_GRID.GetCell(0, LARGELOT_GRID.Columns["CHK"].Index);

                    if (currCell != null && currCell.Presenter != null && currCell.Presenter.Content != null)
                    {
                        LARGELOT_GRID.SelectedIndex = currCell.Row.Index;
                        LARGELOT_GRID.CurrentCell = currCell;

                        // 일단 코터는 대LOT만 자동으로 선택해주게 변경
                        /*
                        System.Windows.Threading.DispatcherTimer timer = new System.Windows.Threading.DispatcherTimer();
                        timer.Interval = TimeSpan.FromSeconds(1d);
                        timer.Tick += (timeSender, arg) =>
                        {
                            timer.Stop();

                            if (PRODLOT_GRID != null && PRODLOT_GRID.Rows.Count > 0)
                            {
                                for (int i = 0; i < PRODLOT_GRID.Rows.Count; i++)
                                {
                                    if (string.Equals(DataTableConverter.GetValue(PRODLOT_GRID.Rows[i].DataItem, "WIPSTAT"), Wip_State.PROC))
                                    {
                                        C1.WPF.DataGrid.DataGridCell currCell2 = PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index);

                                        if (currCell2 != null && currCell2.Presenter != null && currCell2.Presenter.Content != null)
                                        {
                                            PRODLOT_GRID.SelectedIndex = currCell2.Row.Index;
                                            PRODLOT_GRID.CurrentCell = currCell2;
                                        }
                                        break;
                                    }
                                }
                            }
                        };
                        timer.Start();
                        */
                    }
                }
            }
            // 롤플레스 대기, 설비완공 자동으로 선택해주게 변경 2018-01-06
            if (PRODLOT_GRID.Visibility == Visibility.Visible)
            {
                if (PRODLOT_GRID != null && PRODLOT_GRID.Rows.Count > 0)
                {
                    C1.WPF.DataGrid.DataGridCell currCell = PRODLOT_GRID.GetCell(0, PRODLOT_GRID.Columns["CHK"].Index);

                    if (currCell != null && currCell.Presenter != null && currCell.Presenter.Content != null)
                    {
                        PRODLOT_GRID.SelectedIndex = currCell.Row.Index;
                        PRODLOT_GRID.CurrentCell = currCell;

                        #region # Roll Map

                        //if (string.Equals(WIPSTATUS, Wip_State.EQPT_END))
                        //    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                        //else
                        //    (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;

                        if (string.Equals(procId, Process.ROLL_PRESSING))
                        {
                            if (string.Equals(WIPSTATUS, Wip_State.EQPT_END) || string.Equals(WIPSTATUS, Wip_State.PROC))
                            {
                                (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                            }
                            else
                            {
                                (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
                            }
                        }
                        else if (string.Equals(procId, Process.COATING))
                        {
                            if (string.Equals(WIPSTATUS, Wip_State.EQPT_END))
                                (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = true;
                            else
                                (grdSearch.Children[0] as UcSearch).btnRollMap.IsEnabled = false;
                        }

                        #endregion

                    }
                }
            }
            //

            if (PRODLOT_GRID != null && PRODLOT_GRID.Rows.Count > 0)
            {
                for (int i = 0; i < PRODLOT_GRID.Rows.Count; i++)
                {
                    if (string.Equals(DataTableConverter.GetValue(PRODLOT_GRID.Rows[i].DataItem, "WIPSTAT"), Wip_State.PROC))
                    {
                        C1.WPF.DataGrid.DataGridCell currCell = PRODLOT_GRID.GetCell(i, PRODLOT_GRID.Columns["CHK"].Index);

                        if (currCell != null && currCell.Presenter != null && currCell.Presenter.Content != null)
                        {
                            PRODLOT_GRID.SelectedIndex = currCell.Row.Index;
                            PRODLOT_GRID.CurrentCell = currCell;
                        }
                        break;
                    }
                }
            }
        }

        private void SetInputQtyByEqptEndQty(double eqptEndQty)
        {
            if (isRollMapEquipment == true && isCoaterAfterProcess == true)
                return;

            if (String.Equals(WIPSTATUS, Wip_State.EQPT_END) && IsAreaCommonCodeUse("SET_EQPT_QTY_TO_INPUT_QTY", procId))
            {
                double parentQty = Convert.ToDouble(txtParentQty.Value);

                if (eqptEndQty > parentQty)
                {
                    isChangeInputFocus = true;

                    decimal diffQty = Math.Abs(Util.NVC_Decimal(parentQty) - Util.NVC_Decimal(eqptEndQty));
                    decimal inputRateQty = Util.NVC_Decimal(Util.NVC_Decimal(parentQty) * inputOverrate);

                    if (inputRateQty > 0 && diffQty > inputRateQty)
                    {
                        Util.MessageValidation("SFU3195", new object[] { Util.NVC(inputOverrate * 100) + "%" });//투입량의 %1를 초과하여 입력 불가 [생산량 재 입력 후 진행]
                        isChangeInputFocus = false;
                        return;
                    }

                    // CSR : E20230525-001029
                    if (!IsAreaCommonCodeUse("PROD_PROC_AUTO_CALC", procId))
                    {
                        //길이초과 수량 반올림
                        diffQty = Math.Round(diffQty);
                    }

                    //차이수량(생산량-투입량) %1 만큼 길이초과로 등록 하시겠습니까?
                    Util.MessageConfirm("SFU1921", (vResult) =>
                    {
                        if (vResult == MessageBoxResult.OK)
                        {
                            try
                            {
                                //생산량 = 투입수량 + 길이초과수량
                                txtInputQty.Value = Convert.ToDouble(Util.NVC_Decimal(parentQty) + diffQty);

                                if (!SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_EXCEED, diffQty))
                                {
                                    return;
                                }
                                isChangeWipReason = true;

                                exceedLengthQty = diffQty;
                                SetInputQty();

                                WIPREASON_GRID.Refresh();
                                LOTINFO_GRID.Refresh(false);
                            }
                            catch (Exception ex)
                            {
                                Util.MessageException(ex);
                            }
                            finally
                            {
                                isChangeInputFocus = false;
                            }
                        }
                        else
                        {
                            isChangeInputFocus = false;
                        }
                    }, new object[] { Convert.ToString(diffQty) + txtUnit.Text });
                }
                // CSR : [E20230525-001029] - 길이부족 계산
                else if (eqptEndQty < parentQty && string.Equals(WIPSTATUS, Wip_State.EQPT_END) && IsAreaCommonCodeUse("PROD_PROC_AUTO_CALC", procId))
                {
                    double DefaltValue = parentQty - eqptEndQty;

                    if (DefaltValue > 0)
                    {
                        decimal DfatValue = Convert.ToDecimal(DefaltValue);
                        Util.MessageConfirm("SFU8450", (vResult) =>
                        {
                            if (vResult == MessageBoxResult.OK)
                            {
                                try
                                {
                                    if (!SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, DfatValue))
                                        return;

                                    if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                                    {
                                        if (!SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, DfatValue))
                                            return;
                                    }
                                    txtInputQty.Value = parentQty;

                                    isChangeWipReason = true;
                                    SetCalcAutoRefresh();

                                    WIPREASON_GRID.Refresh();
                                    LOTINFO_GRID.Refresh(false);
                                    
                                }
                                catch (Exception ex)
                                {
                                    Util.MessageException(ex);
                                }
                                finally
                                {
                                    isChangeInputFocus = false;
                                }
                            }
                            else
                            {
                                isChangeInputFocus = false;
                            }
                        }, new object[] { DefaltValue + txtUnit.Text });
                    }
                    else
                    {
                        SetInputQty();
                    }
                }
            }
        }

        bool ValidateConfirm()
        {
            if (!ValidateInputQtyLimit())
                return false;

            if (!ValidateProductQty())
                return false;

            if (!ValidWorkTime())
                return false;

            if (!ValidEndTime())
                return false;

            if (!ValidShift())
                return false;

            if (!ValidOperator())
                return false;

            if (!ValidOverProdQty())
                return false;

            if (!ValidConfirmQty())
                return false;

            if (!procId.Equals(Process.PRE_MIXING))
                if (!ValidVersion())
                    return false;

            if (!procId.Equals(Process.PRE_MIXING) && !procId.Equals(Process.MIXING) && !procId.Equals(Process.SRS_MIXING))
                if (!ValidLaneQty())
                    return false;

            if (string.Equals(procId, Process.SRS_COATING))
                if (!ValidInOutQty())
                    return false;

            if (!ValidQualityRequired())
                return false;

            if (!ValidQualitySpecRequired())
                return false;

            if (!ValidDataCollect())
                return false;

            if (string.Equals(procId, Process.COATING) && CheckTestCut() == false) return false; //nathan 2024.01.10 롤맵 코터 수불 실적 적용

            /*
            if (procId.Equals(Process.BACK_WINDER))
            {
                if (txtRemainQty.Value != 0)
                {
                    Util.Alert("SFU1475");      //닛산의 경우 Final Cut이어야 합니다.
                    return false;
                }
            }
            */

            if (procId.Equals(Process.ROLL_PRESSING)) //대LOT의 첫번째 롤프레스 일 경우
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LOTID", typeof(string));

                DataRow row = dt.NewRow();
                row["LOTID"] = _LOTID;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_WIPATTR_QAFLAG", "INDATA", "RSLTDT", dt);

                string wipseq = Convert.ToString(result.Rows[0]["WIPSEQ"]);

                if (result.Rows.Count == 0)
                {
                    Util.MessageValidation("SFU1382");  //LOT이 WIPATTR테이블에 없습니다. 
                    return false;
                }

                if (Convert.ToString(result.Rows[0]["QA_INSP_TRGT_FLAG"]).Equals("Y"))
                {
                    DataTable IndataTable = new DataTable();
                    IndataTable.Columns.Add("LANGID", typeof(string));
                    IndataTable.Columns.Add("AREAID", typeof(string));
                    IndataTable.Columns.Add("PROCID", typeof(string));
                    IndataTable.Columns.Add("LOTID", typeof(string));
                    IndataTable.Columns.Add("WIPSEQ", typeof(string));
                    IndataTable.Columns.Add("CLCT_PONT_CODE", typeof(string));

                    DataRow Indata = IndataTable.NewRow();
                    Indata["LANGID"] = LoginInfo.LANGID;
                    Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                    Indata["PROCID"] = procId;
                    Indata["LOTID"] = _LOTID;
                    Indata["WIPSEQ"] = wipseq;

                    Indata["CLCT_PONT_CODE"] = null;
                    IndataTable.Rows.Add(Indata);

                    result = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_WIPDATACOLLECT_LOT", "INDATA", "RSLTDT", IndataTable);

                    if (result.Rows.Count == 0)
                        result = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_PROC_CLCTITEM", "INDATA", "RSLTDT", IndataTable);

                    if ( result.Rows.Count > 0)
                    {
                        // [E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                        DataRow[] inspRows;

                        if (result.Select("INSP_ITEM_ID = 'E3000-0001'").Count() > 0)
                        {
                            inspRows = result.Select("INSP_ITEM_ID = 'E3000-0001'").Count() > 0 ? result.Select("INSP_ITEM_ID = 'E3000-0001'") : result.Select("INSP_ITEM_ID = 'SI516'");
                        }
                        else
                        {
                            inspRows = result.Select("INSP_ITEM_ID = 'SI022'").Count() > 0 ? result.Select("INSP_ITEM_ID = 'SI022'") : result.Select("INSP_ITEM_ID = 'SI516'");
                        }

                        foreach (DataRow inspRow in inspRows)
                        {
                            if (inspRow["CLCTVAL01"].Equals("") && !Util.NVC(inspRow["CLSS_NAME1"]).Contains("HG"))
                            {
                                Util.MessageValidation("SFU1603");  //샘플링 진행/마우저 두께를 모두 기입 바랍니다.
                                return false;
                            }
                        }
                    }

                    bool isQASamplingQtyZero = false;
                    DataRow[] defectRows = (WIPREASON_GRID.ItemsSource as DataView).Table.Select("ACTID = 'CHARGE_PROD_LOT' AND RESNCODE = 'PS01S04'");
                    foreach (DataRow dr in defectRows)
                    {
                        decimal resnQty = Util.NVC_Decimal(dr["RESNQTY"]);
                        if (resnQty == 0 || resnQty < 0)
                        {
                            isQASamplingQtyZero = true;
                            break;
                        }
                    }
                    if (isQASamplingQtyZero)
                    {
                        LGC.GMES.MES.CMM001.Popup.CMM_ELEC_QA_SMPL_QTY_CHK popup = new LGC.GMES.MES.CMM001.Popup.CMM_ELEC_QA_SMPL_QTY_CHK();
                        popup.FrameOperation = FrameOperation;

                        object[] Parameters = new object[1];
                        Parameters[0] = _LOTID;

                        C1WindowExtension.SetParameters(popup, Parameters);
                        this.Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                    }


                    /*
                    for (int i = 0; i < result.Rows.Count; i++)
                    {
                        // 타 항목 추가로 두께(HG제외)한 항목만 체크하도록 아래와 같이 변경 처리 [2017-12-27]
                        // 요청사항으로 HG는 필수항목에서 제외해달라는 요청이 와서 제외 [2017-05-23]
                        if (result.Rows[i]["CLCTVAL01"].Equals("") && ((string.Equals(result.Rows[i]["INSP_ITEM_ID"], "SI022") || string.Equals(result.Rows[i]["INSP_ITEM_ID"], "SI516")) && !Util.NVC(result.Rows[i]["CLSS_NAME1"]).Contains("HG")))
                        {
                            Util.MessageValidation("SFU1603");  //샘플링 진행/마우저 두께를 모두 기입 바랍니다.
                            return false;
                        }
                    }
                    */
                }

                if (!ValidateSpec())
                    return false;

            }

            // 자동차 2동 NISSAN 특화기능 [2017.04월 지나면 삭제O]
            // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
            if (string.Equals(LoginInfo.CFG_AREA_ID, "E6") && (string.Equals(procId, Process.REWINDER) || string.Equals(procId, Process.LASER_ABLATION) || string.Equals(procId, Process.BACK_WINDER)))
                if (!ValidDefectTagInput())
                    return false;

            return true;
        }

        bool ValidateSpec()
        {
            DataTable dt = new DataTable();
            dt.Columns.Add("LANGID", typeof(string));
            dt.Columns.Add("AREAID", typeof(string));
            dt.Columns.Add("LOTID", typeof(string));

            DataRow row = dt.NewRow();
            row["LANGID"] = LoginInfo.LANGID;
            row["AREAID"] = LoginInfo.CFG_AREA_ID;
            row["LOTID"] = _LOTID;
            dt.Rows.Add(row);

            DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_INSP_ITEM_SPEC", "INDATA", "RSLTDT", dt);
            if (result.Rows.Count != 0)
            {
                for (int i = 0; i < result.Rows.Count; i++)
                {
                    if (Convert.ToString(result.Rows[i]["CLCTVAL01"]).Equals("") || Util.NVC_Decimal(result.Rows[i]["CLCTVAL01"]) == 0)
                    {
                        Util.MessageValidation("SFU2886", new object[] { Util.NVC(result.Rows[i]["INSP_CLCTNAME"]) });  //{%1} 품질 값을 넣어주세요
                        return false;
                    }
                }
            }
            return true;
        }


        private bool ValidateConfirmSlitter()
        {
            if (LOTINFO_GRID.GetRowCount() < 1)
            {
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1702"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.None);    //실적 Lot을 선택 해 주세요.
                return false;
            }

            if (!ValidateProductQty())
                return false;

            if (!ValidEndTime())
                return false;

            if (!ValidShift())
                return false;

            if (!ValidOperator())
                return false;

            if (!ValidVersion())
                return false;

            if (!ValidLaneQty())
                return false;

            if (!ValidCutOverProdQty())
                return false;

            if (!ValidConfirmQty())
                return false;

            // 불량태크 입력 시 특이사항 입력 여부 체크 (자동불량TAG기능 추가로 자동차동만 적용) [2019-01-24]
            if (!ValidDefectTagRemark())
                return false;

            if (!ValidQualityRequired())
                return false;

            if (!ValidQualitySpecRequired())
                return false;

            if (!ValidDataCollect())
                return false;

            #region [POSTACTION]
            //2022-12-29 오화백 EP 동추가
            if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EA") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
            {
                if (!ConfirmdPostAction())
                    return false;
            }
            #endregion

            return true;
        }

        bool ValidateConfirmSingleCoater()
        {
            // C20210722-000438  실적 오기입 방지를 위한 기능 추가 건 2021.08.03
            decimal iResnQty = 0;        //불량수량

            if (procId.Equals(Process.COATING))
            {
                for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                {
                    iResnQty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY"));

                    //불량수량이 1000 이상 또는 소숫점여부 확인
                    if (iResnQty > 1000 || (!(iResnQty == (int)iResnQty)))
                    {
                        return false;
                    }
                }
            }

            return true;
        }

        bool CheckMtrl()
        {
            try
            {
                if (procId.Equals(Process.SRS_MIXING) || procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING) || procId.Equals(Process.PRE_MIXING))   // 선분산 MIXER도 해당로직 태우지 않음 (2017-01-31)
                    return true;

                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow indata = inTable.NewRow();
                indata["LOTID"] = _LOTID;
                inTable.Rows.Add(indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync(GetCheckMaterialBizRuleName(), "INDATA", "RSLTDT", inTable);

                if (string.Equals(procId, Process.MIXING) && dt.Rows[0]["CNT"].ToString().Equals("0"))
                {
                    // Modify : 2016.12.10 *********************
                    /*
                    string sMsg = string.Empty;

                    if (procId.Equals(Process.MIXING))
                        sMsg = "활물질 자재 등록을 해주세요.";
                    else if (procId.Equals(Process.PRE_MIXING))
                        sMsg = "자재 등록을 해주세요.";
                    else
                        sMsg = "등록된 SLURRY가 없습니다.";
                    LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage(sMsg), null, "Info", MessageBoxButton.OK, MessageBoxIcon.None);
                    */
                    //******************************************

                    Util.MessageValidation("활물질 자재 등록을 해주세요.");
                    return false;
                }

                return true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        bool ValidateProductQty()
        {
            DataTable dt = DataTableConverter.Convert(LOTINFO_GRID.ItemsSource);
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING))
            {
                if (Util.NVC_Decimal(dt.Rows[0]["INPUTQTY"]) <= 0)
                {
                    Util.MessageValidation("SFU1617");  //생산수량을 확인하십시오.
                    return false;
                }
            }
            else
            {
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    if (Util.NVC_Decimal(dt.Rows[i]["INPUTQTY"]) <= 0)
                    {
                        Util.MessageValidation("SFU1617");  //생산수량을 확인하십시오.
                        return false;
                    }
                }
            }
            return true;
        }

        private string IsAutoChangeWorkOrder()
        {
            string rtnMsg = string.Empty;
            try
            {
                C1DataGrid workOrder = null;
                string woID = string.Empty;

                if (string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.SRS_MIXING))
                    workOrder = (grdWorkOrder.Children[0] as UC_WORKORDER_MX).dgWorkOrder;
                else
                    workOrder = (grdWorkOrder.Children[0] as UC_WORKORDER).dgWorkOrder;

                for (int i = 0; i < workOrder.Rows.Count; i++)
                {
                    if (Convert.ToBoolean(DataTableConverter.GetValue(workOrder.Rows[i].DataItem, "CHK")))
                    {
                        woID = Util.NVC(DataTableConverter.GetValue(workOrder.Rows[i].DataItem, "WO_DETL_ID"));
                        break;
                    }
                }

                if (string.IsNullOrEmpty(woID))
                    return rtnMsg;

                DataSet indataSet = new DataSet();

                DataTable inEqpData = indataSet.Tables.Add("IN_EQP");
                inEqpData.Columns.Add("SRCTYPE", typeof(string));
                inEqpData.Columns.Add("IFMODE", typeof(string));
                inEqpData.Columns.Add("EQPTID", typeof(string));
                inEqpData.Columns.Add("USERID", typeof(string));
                inEqpData.Columns.Add("WO_DETL_ID", typeof(string));

                DataRow inEqpDataRow = inEqpData.NewRow();
                inEqpDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                inEqpDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                inEqpDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                inEqpDataRow["USERID"] = LoginInfo.USERID;
                inEqpDataRow["WO_DETL_ID"] = woID;
                inEqpData.Rows.Add(inEqpDataRow);

                DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_AUTOCHANGE_WO_DETL_ID_ELEC", "IN_EQP", null, indataSet);
                //DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_AUTOCHANGE_WO_DETL_ID_ELEC", "IN_EQP", "OUT_WO", indataSet);

                //DataTable msg = dsRslt.Tables["OUT_WO"];
                //if (msg.Rows[0]["WO_CHANGE"].Equals("1"))
                //{
                //    rtnMsg = MessageDic.Instance.GetMessage("SFU3439", Util.NVC(msg.Rows[0]["WORKDT_NEXT"]), Util.NVC(msg.Rows[0]["WO_DETL_ID_NEW"]));
                //    GetWorkOrder(); // 작업지시 재 조회
                //}
                GetWorkOrderNotClear(); // 작업지시 재 조회
            }
            catch (Exception ex)
            {
                //Util.MessageException(ex);
                if (!string.IsNullOrEmpty(Util.NVC(ex.Data["DATA"])) && !string.IsNullOrEmpty(Util.NVC(ex.Data["PARA"])))
                    rtnMsg = MessageDic.Instance.GetMessage(Util.NVC(ex.Data["DATA"]), Util.NVC(ex.Data["PARA"]).Split(":".ToArray(), StringSplitOptions.RemoveEmptyEntries));
                else
                    rtnMsg = MessageDic.Instance.GetMessage(Util.NVC(ex.Data["DATA"]));
            }
            return rtnMsg;
        }

        private void SetUnMountCore(int position)
        {
            try
            {
                string sEqpt_Pstn_ID = string.Empty;
                DataTable dt = GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
                
                if (dt.Rows.Count > 0)
                {
                    int iIdx = 0;
                    foreach (DataRow _iRow in dt.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'"))
                    {
                        if (iIdx != position)
                        {
                            sEqpt_Pstn_ID = Convert.ToString(_iRow["EQPT_MOUNT_PSTN_ID"]);
                            break;
                        }
                        iIdx++;
                    }
                }

                if (string.IsNullOrEmpty(sEqpt_Pstn_ID))
                    return;

                DataSet indataSet = new DataSet();

                DataTable IndataTable = indataSet.Tables.Add("IN_EQP");
                IndataTable.Columns.Add("SRCTYPE", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("USERID", typeof(string));

                DataRow inDataRow = IndataTable.NewRow();
                inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                inDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                inDataRow["EQPT_MOUNT_PSTN_ID"] = sEqpt_Pstn_ID;
                inDataRow["PROCID"] = procId;
                inDataRow["USERID"] = LoginInfo.USERID;
                IndataTable.Rows.Add(inDataRow);

                new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_UNMOUNT_SLURRY_CT", "INDATA", null, indataSet);
            }
            catch (Exception ex) { };
        }

        // 단면코터 TOP Core 탈착처리(WO 변경 시 자동탈착처리)
        private void SetUnMountTopCore(string sPstn)
        {
            try
            {
                DataSet indataSet = new DataSet();

                DataTable IndataTable = indataSet.Tables.Add("IN_EQP");
                IndataTable.Columns.Add("SRCTYPE", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("USERID", typeof(string));

                DataRow inDataRow = IndataTable.NewRow();
                inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                inDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                inDataRow["EQPT_MOUNT_PSTN_ID"] = sPstn;
                inDataRow["PROCID"] = procId;
                inDataRow["USERID"] = LoginInfo.USERID;
                IndataTable.Rows.Add(inDataRow);

                new ClientProxy().ExecuteServiceSync_Multi("BR_PRD_REG_UNMOUNT_SLURRY_CT", "INDATA", null, indataSet);
            }
            catch (Exception ex) { };
        }

        private bool ValidaWorkOrderPlanQty()
        {
            if (isCoaterAfterProcess == false)
            {
                try
                {
                    C1DataGrid workOrder = null;
                    string woID = string.Empty;
                    decimal planQty = 0;
                    decimal prodQty = 0;

                    if (string.Equals(procId, Process.MIXING) || string.Equals(procId, Process.PRE_MIXING) || string.Equals(procId, Process.SRS_MIXING))
                        workOrder = (grdWorkOrder.Children[0] as UC_WORKORDER_MX).dgWorkOrder;
                    else
                        workOrder = (grdWorkOrder.Children[0] as UC_WORKORDER).dgWorkOrder;

                    for (int i = 0; i < workOrder.Rows.Count; i++)
                    {
                        if (Convert.ToBoolean(DataTableConverter.GetValue(workOrder.Rows[i].DataItem, "CHK")))
                        {
                            planQty += Util.NVC_Decimal(DataTableConverter.GetValue(workOrder.Rows[i].DataItem, "INPUT_QTY"));
                            woID = Util.NVC(DataTableConverter.GetValue(workOrder.Rows[i].DataItem, "WO_DETL_ID"));
                            break;
                        }
                    }

                    if (planQty > 0)
                    {
                        DataTable dt = new DataTable();
                        dt.Columns.Add("EQSGID", typeof(string));
                        dt.Columns.Add("PROCID", typeof(string));
                        dt.Columns.Add("WO_DETL_ID", typeof(string));

                        DataRow row = dt.NewRow();
                        row["EQSGID"] = EQUIPMENTSEGMENT_COMBO.SelectedValue;
                        row["PROCID"] = procId;
                        row["WO_DETL_ID"] = woID;
                        dt.Rows.Add(row);

                        DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_ELEC_PROD_QTY", "INDATA", "RSLTDT", dt);

                        if (result.Rows.Count > 0)
                            if (!string.IsNullOrEmpty(Util.NVC(result.Rows[0]["WIPQTY"])))
                                prodQty = Util.NVC_Decimal(result.Rows[0]["WIPQTY"]);

                        if (prodQty > planQty)
                            return false;
                    }
                }
                catch(Exception ex) { Util.MessageException(ex); }
            }
            return true;
        }

        private decimal GetPatternLength(string prodID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["PRODID"] = prodID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE", "INDATA", "RSLTDT", IndataTable);

                if (result.Rows.Count > 0)
                {
                    foreach (DataRow row in result.Rows)
                        if (string.Equals(row["PROD_VER_CODE"], txtVersion.Text) && !string.IsNullOrEmpty(Util.NVC(row["PTN_LEN"])))
                            return Util.NVC_Decimal(row["PTN_LEN"]);

                    if (!string.IsNullOrEmpty(Util.NVC(result.Rows[0]["PTN_LEN"])))
                        return Util.NVC_Decimal(result.Rows[0]["PTN_LEN"]);
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
            return 1;
        }

        private DataTable GetPrintCount(string sLotID, string sProcID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                Indata["PROCID"] = sProcID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_PROCESS_LOT_LABEL_COUNT", "INDATA", "RSLTDT", IndataTable);

                return result;
            }
            catch (Exception ex) { }

            return new DataTable();
        }

        private string GetLotProdVerCode(string sLotID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                    return Util.NVC(result.Rows[0]["PROD_VER_CODE"]);
            }
            catch (Exception ex) { }

            return "";
        }

        private string GetLotPetLinkFlag(string sLotID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                    return Util.NVC(result.Rows[0]["PET_LINK_FLAG"]);
            }
            catch (Exception ex) { }

            return "";
        }

        private string GetEioAttr(string sEqptID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("EQPTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["EQPTID"] = sEqptID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_EIOATTR", "RQSTDT", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                    return Util.NVC(result.Rows[0]["WO_DETL_ID"]);
            }
            catch (Exception ex) { }

            return "";
        }
        private bool IsHeatProcessPrintOutCheck(string sLotID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                Indata["PROCID"] = Process.HEAT_TREATMENT;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_CHK_WIP_HT_ISS_HIST_CARD", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0 && Util.NVC_Decimal(result.Rows[0]["WAIT_CONF_LOTQTY"]) == 0)
                    return true;   
            }
            catch (Exception ex) { }

            return false;
        }

        private DataTable GetMergeInfo(string sLotID, string sProcID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                Indata["PROCID"] = sProcID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_MERGE_LOT_HIST", "INDATA", "RSLTDT", IndataTable);

                return result;
            }
            catch (Exception ex) { }

            return new DataTable();
        }

        private string GetProdVerCode(string sProdID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = sProdID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count == 1)
                    return Util.NVC(result.Rows[0]["PROD_VER_CODE"]);
            }
            catch (Exception ex) { }

            return "";
        }

        private void SetSRSLotHistoryInfo(string sLotID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR_FOR_INOUT_QTY", "INDATA", "RSLTDT", IndataTable);
                
                if ( result != null && result.Rows.Count > 0)
                {
                    txtSrs1Qty.Value = Convert.ToDouble(result.Rows[0]["SRS1_QTY"]);
                    txtSrs2Qty.Value = Convert.ToDouble(result.Rows[0]["SRS2_QTY"]);
                    txtSrs3Qty.Value = Convert.ToDouble(result.Rows[0]["SRS3_QTY"]);
                    cboPet.SelectedValue = Util.NVC(result.Rows[0]["PROTECT_FILM_TYPE_CODE"]);
                }
            }
            catch (Exception ex) { }
        }

        private bool ValidateInputQtyLimit()
        {
            //if (!string.Equals(procId, Process.MIXING) && !string.Equals(procId, Process.SRS_MIXING) && !string.Equals(procId, Process.PRE_MIXING))
            if (isCoaterAfterProcess == true)
                return true;

            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("EQPTID", typeof(string));

                DataRow row = dt.NewRow();
                row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_MIXER_INPUT_VALID", "INDATA", "RSLTDT", dt);

                if (result.Rows.Count > 0)
                {
                    // CWA요청으로 Validation 조건 변경 [2019-06-02]
                    decimal inputQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

                    if (string.Equals(txtUnit.Text, "EA") && string.Equals(procId, Process.COATING))
                    {
                        inputQty = inputQty * GetPatternLength(_PRODID);
                    }

                    if (!string.IsNullOrEmpty(Util.NVC(result.Rows[0]["LOT_PROD_MAX_QTY"])) && !string.IsNullOrEmpty(Util.NVC(result.Rows[0]["LOT_PROD_MIN_QTY"])))
                    {
                        if (Util.NVC_Decimal(result.Rows[0]["LOT_PROD_MAX_QTY"]) < inputQty || Util.NVC_Decimal(result.Rows[0]["LOT_PROD_MIN_QTY"]) > inputQty)
                        {
                            Util.MessageValidation("SFU3359");    //입력 가능한 생산량 범위를 벗어났습니다.
                            return false;
                        }
                    }
                    else if (!string.IsNullOrEmpty(Util.NVC(result.Rows[0]["LOT_PROD_MAX_QTY"])))
                    {
                        if (Util.NVC_Decimal(result.Rows[0]["LOT_PROD_MAX_QTY"]) < inputQty)
                        {
                            Util.MessageValidation("SFU3359");
                            return false;
                        }
                    }
                    else if (!string.IsNullOrEmpty(Util.NVC(result.Rows[0]["LOT_PROD_MIN_QTY"])))
                    {
                        if (Util.NVC_Decimal(result.Rows[0]["LOT_PROD_MIN_QTY"]) > inputQty)
                        {
                            Util.MessageValidation("SFU3359");
                            return false;
                        }
                    }
                }
                return true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        private DataTable GetMixerPreData()
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("EQSGID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Indata["PROCID"] = procId;
                Indata["EQPTID"] = _EQPTID;
                Indata["PRODID"] = _PRODID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_MIXER_BEFORE_QTY", "INDATA", "RSLTDT", IndataTable);

                return result;
            }
            catch (Exception ex) { }

            return new DataTable();
        }

        private DataTable GetBackCoaterInputMaterialValid(string sLotID, string sCoatingSideType)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("OUT_FLAG", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;

                if (string.Equals(sCoatingSideType, "B"))
                    Indata["OUT_FLAG"] = "Y";

                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_SINGLE_CT_INPUT_VALID", "INDATA", "RSLTDT", IndataTable);

                return result;
            }
            catch (Exception ex) { }

            return new DataTable();
        }

        private void SetProcWipReasonData()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LANGID", typeof(string));
                dt.Columns.Add("CUTID", typeof(string));
                dt.Columns.Add("WIPSEQ", typeof(string));

                DataRow dataRow = dt.NewRow();
                dataRow["LANGID"] = LoginInfo.LANGID;
                dataRow["CUTID"] = _CUTID;

                int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                if (iRow < 0)
                    dataRow["WIPSEQ"] = 1;
                else
                    dataRow["WIPSEQ"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));

                dt.Rows.Add(dataRow);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_PROC_WIPREASON", "INDATA", "RSLTDT", dt);

                if (procResnDt == null)
                    procResnDt = new DataTable();

                procResnDt.Clear();
                procResnDt = result.Copy();

                if ( result != null && result.Rows.Count > 0)
                {
                    // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                    int iCount = isResnCountUse == true ? 1 : 0;

                    for (int i = WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount); i < WIPREASON_GRID.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                    {
                        DataRow[] rows = result.Select("LOTID = '" + WIPREASON_GRID.Columns[i].Name + "'");
                        for (int j = 0; j < WIPREASON_GRID.Rows.Count; j++)
                        {
                            if (rows.Length == 0)
                                break;

                            foreach (DataRow row in rows)
                            {
                                if ( string.Equals(WIPREASON_GRID.Columns[i].Name, row["LOTID"]) && string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "RESNCODE"), row["RESNCODE"]))
                                {
                                    DataTableConverter.SetValue(WIPREASON_GRID.Rows[j].DataItem, WIPREASON_GRID.Columns[i].Name, row["RESNQTY"]);
                                    GetSumCutDefectQty(WIPREASON_GRID, j, i);
                                    continue;
                                }
                            }
                        }
                    }
                    WIPREASON_GRID.Refresh(false);
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void SetCalDate()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("EQPTID", typeof(string));

                DataRow row = dt.NewRow();
                row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("BR_PRD_GET_CALDATE_EQPTID", "INDATA", "OUTDATA", dt);

                if (result.Rows.Count > 0 && !string.IsNullOrEmpty(Util.NVC(result.Rows[0]["CALDATE"])))
                {
                    txtWorkDate.Text = Convert.ToDateTime(result.Rows[0]["CALDATE"]).ToString("yyyy-MM-dd");
                    txtWorkDate.Tag = Convert.ToDateTime(result.Rows[0]["CALDATE"]).ToString("yyyy-MM-dd HH:mm:ss");
                }
                else
                {
                    txtWorkDate.Text = DateTime.Now.ToString("yyyy-MM-dd");
                    txtWorkDate.Tag = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private bool ValidConfirmLotCheck()
        {
            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

            if (iRow < 0)
            {
                Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                return false;
            }

            try
            {
                string sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));

                if ( string.IsNullOrEmpty(sLotID))
                {
                    Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                    return false;
                }

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;

                IndataTable.Rows.Add(Indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIP_WITH_ATTR", "INDATA", "RSLTDT", IndataTable);

                if( dt != null && dt.Rows.Count > 0 && !string.Equals(procId, dt.Rows[0]["PROCID"]) && (string.Equals(INOUT_TYPE.IN, dt.Rows[0]["WIP_TYPE_CODE"]) || string.Equals(INOUT_TYPE.INOUT, dt.Rows[0]["WIP_TYPE_CODE"])))
                {
                    Util.MessageValidation("SFU5066");  // 이미 실적 확정 된 LOT입니다.
                    return false;
                }

            }
            catch (Exception ex) { Util.MessageException(ex); }

            return true;
        }

        private bool ValidBeforeQtyCurrQty()
        {
            int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");
            string sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
            
            DataTable dtResult = GetAreaCommonCode("ELTR_MIXER_OUTPUT_DIFF_STD_QTY","USE_YN");
            string qty = DataTableConverter.GetValue(dgLotInfo.Rows[dgLotInfo.TopRows.Count].DataItem, "INPUTQTY").ToString();
            if (dtResult != null && dtResult.Rows.Count != 0)
            {
                if (isMixerOutputDiffSTDQty(sLotID, Convert.ToDouble(qty), Convert.ToDouble(dtResult.Rows[0]["ATTR1"].ToString())))
                    return false;
            }

            return true;
        }
            

        private bool isMixerOutputDiffSTDQty(string sLotID, double qty, double gap_qty)
        {
            bool isInterlock = false;

            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("LOTID", typeof(string));
            IndataTable.Columns.Add("QTY", typeof(double));
            IndataTable.Columns.Add("GAP_QTY", typeof(double));

            DataRow Indata = IndataTable.NewRow();
            Indata["LOTID"] = LOTID;
            Indata["QTY"] = qty;
            Indata["GAP_QTY"] = gap_qty;
            IndataTable.Rows.Add(Indata);

            try
            {
                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_GET_OUTPUT_DIFF_STD_QTY", "INDATA", "OUTDATA", IndataTable);

                if (dtResult.Rows[0]["PASS_YN"].ToString() == "N")
                    isInterlock = true;

            } catch (Exception ex) {
                Util.MessageException(ex);
                isInterlock = true;
            }

            return isInterlock;
        }

        private DataTable GetAreaCommonCode(string sComTypeCode, string sComCode)
        {
            DataTable dtResult = null;

            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("AREAID", typeof(string));
                RQSTDT.Columns.Add("COM_TYPE_CODE", typeof(string));
                RQSTDT.Columns.Add("COM_CODE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["AREAID"] = LoginInfo.CFG_AREA_ID;
                dr["COM_TYPE_CODE"] = sComTypeCode;
                dr["COM_CODE"] = sComCode;
                RQSTDT.Rows.Add(dr);

                dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_FOR_AREA", "RQSTDT", "RSLTDT", RQSTDT);

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }

            return dtResult;
        }

        // 롤프레스 자주검사 저장 시 복사해서 붙여넣다가 실수하는 경우 방어를 위하여 로직 추가 (자동차1,2동 요청사항) [2019-01-07]
        private bool ValidInspectionDataCheck(C1DataGrid dataGrid)
        {    // 2022-12-29 오화백 EP동 추가
            if ((string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP")) && string.Equals(procId, Process.ROLL_PRESSING))
            {
                int iRow = new Util().GetDataGridCheckFirstRowIndex(PRODLOT_GRID, "CHK");

                if (iRow < 0)
                {
                    Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                    return true;
                }

                try
                {
                    string sLotID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "LOTID"));
                    string sProdID = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "PRODID"));

                    if (string.IsNullOrEmpty(sLotID))
                    {
                        Util.MessageValidation("SFU1632");  //선택된 LOT이 없습니다.
                        return true;
                    }

                    DataTable IndataTable = new DataTable();
                    IndataTable.Columns.Add("EQSGID", typeof(string));
                    IndataTable.Columns.Add("PROCID", typeof(string));
                    IndataTable.Columns.Add("EQPTID", typeof(string));
                    IndataTable.Columns.Add("PRODID", typeof(string));
                    IndataTable.Columns.Add("LOTID", typeof(string));

                    DataRow Indata = IndataTable.NewRow();
                    Indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                    Indata["PROCID"] = procId ;
                    Indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                    Indata["PRODID"] = sProdID;
                    Indata["LOTID"] = sLotID;

                    IndataTable.Rows.Add(Indata);

                    DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_WIPDATACOLLECT_PRE_SAVE_LOT", "RQSTDT", "RSLTDT", IndataTable);

                    if (dt != null && dt.Rows.Count > 0)
                    {
                        DataView view = DataTableConverter.Convert(dataGrid.ItemsSource).DefaultView;
                        //view.RowFilter = @"ISNULL(CLCTVAL01, '') <> '' AND (CLCTITEM LIKE '" + "SI022" + "'" + "OR CLCTITEM LIKE '" + "SI516" + "'" + ")";

                        // [E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                        view.RowFilter = @"(CLCTITEM LIKE '" + "SI022%" + "'" + "OR CLCTITEM LIKE '" + "E3000-0001%" + "'" + "OR CLCTITEM LIKE '" + "SI516%" + "'" + ")";
                        DataTable qualData =  view.ToTable(false);

                        bool isQualValidate = false;
                        foreach (DataRow qualRow in  qualData.Rows)
                        {
                            if (isQualValidate == true)
                                break;

                            // 두께HG는 비교대상 아님
                            if (Util.NVC(qualRow["CLSS_NAME1"]).Contains("HG"))
                                continue;

                            foreach (DataRow targetRow in dt.Rows)
                            {
                                if (string.Equals(Util.NVC(qualRow["CLCTITEM"]), Util.NVC(targetRow["CLCTITEM"])))
                                {
                                    if (!string.Equals(Util.NVC(qualRow["CLCTVAL01"]), Util.NVC(targetRow["CLCTVAL01"])))
                                        isQualValidate = true;

                                    break;
                                }
                            }
                        }

                        return isQualValidate;
                    }
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
            return true;
        }

        private bool ValidDataCollect()
        {
            if (isChangeWipReason)
            {
                //Util.MessageValidation("SFU2900");  //불량/Loss/물청 정보를 저장하세요.
                //return false;
            }

            if (isChangeQuality)
            {
                Util.MessageValidation("SFU1999");  //품질 정보를 저장하세요.
                return false;
            }

            if (isChangeMaterial)
            {
                Util.MessageValidation("SFU1818");  //자재 정보를 저장하세요.
                return false;
            }

            if (isChagneDefectTag)
            {
                Util.MessageValidation("SFU3409");  //불량태그 정보를 저장하세요.
                return false;
            }

            if (isChangeColorTag)
            {
                Util.MessageValidation("SFU3410");  //색지 정보를 저장하세요.
                return false;
            }

            if (isChangeRemark)
            {
                Util.MessageValidation("SFU2977");  //특이사항 정보를 저장하세요.
                return false;
            }

            if (isChangeCotton)
            {
                Util.MessageValidation("SFU4913");  //면상태일지 정보를 저장하세요.
                return false;
            }

            // [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 추가 요청 건
            if (isTWS_LOADING_TRACKING)
            {
                if (string.Equals(procId, Process.COATING))
                {
                    if ((isSaveTWS_Loading == false && isPassSaveTWS_LOADING_TRACKING == false
                        && (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility == Visibility.Visible))
                    {
                        string item = "TWS loading " + ObjectDic.Instance.GetObjectName("작업자입력");
                        Util.MessageValidation("FM_ME_0251", new object[] { item });  //필수항목누락 : %1
                        return false;
                    }
                    //[E20240722-000098] [소형파우치형전극기술P] TWS-GMES 연동 시스템 수정 업데이트 요청 건(3rd)
                    else if ((isSaveTWS_Loading == true
                        && (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility == Visibility.Visible))
                    {
                        isSilentlySave = true;
                        OnClickSaveTWS_Loading(null, null); 
                    }
                }

                if (string.Equals(procId, Process.INS_COATING)
                    || string.Equals(procId, Process.ROLL_PRESSING)
                    || string.Equals(procId, Process.LASER_ABLATION)
                    || string.Equals(procId, Process.SLITTING)
                    || string.Equals(procId, Process.HEAT_TREATMENT))
                {

                    #region [E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
                    if (isAutoSetRollDir == true 
                        ||( isSaveTWS_LOADING_TRACKING == false && isPassSaveTWS_LOADING_TRACKING == false
                        && (grdDataCollect.Children[0] as UcDataCollect).tiRollDirection.Visibility == Visibility.Visible))
                    {
                        UcDataCollect thisUDC = grdDataCollect.Children[0] as UcDataCollect;
                        if ((thisUDC.rbOutputRollLaneForward.IsChecked.Value == false && thisUDC.rbOutputRollLaneReverse.IsChecked.Value == false)
                            || (thisUDC.rbRolloutUp.IsChecked.Value == false && thisUDC.rbRolloutDown.IsChecked.Value == false)
                            || (thisUDC.rbRollinUp.IsChecked.Value == false && thisUDC.rbRollinDown.IsChecked.Value == false)
                            || (thisUDC.rbInputRollLaneForward.IsChecked.Value == false && thisUDC.rbInputRollLaneReverse.IsChecked.Value == false))
                        {
                            //Util.MessageValidation("SFU0000");  //Roll 방향 정보를 저장하세요.
                            Util.MessageValidation("SFU8116", ObjectDic.Instance.GetObjectName("SAVE_ROLL방향"));
                            return false;
                        }
                        else
                        {
                            //자동세팅이 아닌 경우 롤방향 정보 직접 저장요청
                            if (isAutoSetRollDir == false && isSaveTWS_LOADING_TRACKING == false && isPassSaveTWS_LOADING_TRACKING == false
                                && (grdDataCollect.Children[0] as UcDataCollect).tiRollDirection.Visibility == Visibility.Visible)
                            {
                                //Util.MessageValidation("SFU0000");  //Roll 방향 정보를 저장하세요.
                                Util.MessageValidation("SFU8116", ObjectDic.Instance.GetObjectName("SAVE_ROLL방향"));
                                return false;
                            }

                            //[PreAction] Roll 방향 정보 자동 저장
                            isSilentlySave = true;
                            SetTWS_LOADING_TRACKING();
                            isSaveTWS_LOADING_TRACKING = true;
                        }
                    }
                    #endregion
                }

            }

            #region [POSTACTION]
            if (isChangePostAction)
            {
                Util.MessageValidation("SFU2977");  //특이사항 정보를 저장하세요.
                return false;
            }

            //if (!ValidPostAction())
            //{
            //    Util.MessageValidation("SFU2977");  //특이사항 정보를 저장하세요.
            //    return false;
            //}
            #endregion
            return true;
        }

        #region [POSTACTION]
        private bool ValidPostAction()
        {
            DataTable dt = DataTableConverter.Convert(POSTHOLD_GRID.ItemsSource);
            DataRow[] dr = dt.Select("LANENUM <> 'ALL' AND POST_HOLD = 'True'");

            foreach (DataRow dRow in dr)
            {
                if (string.IsNullOrEmpty(Util.NVC(dRow["REMARK"]).Split('|')[0]))
                {
                    Util.MessageValidation("SFU1993");  //특이사항을 입력하세요
                    return false;
                }
            }
            return true;
        }

        private bool ConfirmdPostAction()
        {
            DataTable postHold = DataTableConverter.Convert(POSTHOLD_GRID.ItemsSource);
            if (!ValidPostAction())
                return false;
            // 슬리터 2차 추가  2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
            {
                DataTable savedposthold = getSavedPostAction(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "CUT_ID")));
                DataTable preposthold = getPostAction(Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "CUT_ID")));

                DataRow[] dr = preposthold.Select("POST_HOLD = 'True'");

                if (dr.Length > 0 && savedposthold.Rows.Count == 0)
                {
                    Util.MessageValidation("SFU2977"); // 특이사항 정보를 저장하세요.
                    return false;
                }

                foreach (DataRow dRow in dr)
                {
                    foreach (DataRow dRow1 in savedposthold.Rows)
                    {
                        if (string.Equals(Util.NVC(dRow["LOTID"]), Util.NVC(dRow1["LOTID"])) && string.IsNullOrEmpty(Util.NVC(dRow1["NOTE"]).Split('|')[0]))
                        {
                            Util.MessageValidation("SFU1993"); // 특이사항을 입력하세요.
                            return false;
                        }
                    }
                }
            }
            return true;
        }
        #endregion

        private bool ValidQualityRequired()
        {
            if (QUALITY_GRID.Visibility == Visibility.Visible && QUALITY2_GRID.Visibility != Visibility.Visible && QUALITY_GRID.Rows.Count > 0)
            {
                DataView view = DataTableConverter.Convert(QUALITY_GRID.ItemsSource).DefaultView;
                view.RowFilter = "MAND_INSP_ITEM_FLAG = 'Y'";
                DataTable dt = view.ToTable(true, "INSP_ITEM_ID");

                foreach (DataRow row in dt.Rows)
                {
                    string sItemName = string.Empty;
                    bool isValid = false;
                    DataRow[] filterRows = DataTableConverter.Convert(QUALITY_GRID.ItemsSource).Select("INSP_ITEM_ID = '" + Util.NVC(row["INSP_ITEM_ID"]) + "'");
                    foreach (DataRow subRow in filterRows)
                    {
                        sItemName = Util.NVC(subRow["INSP_ITEM_NAME"]);
                        if (!string.IsNullOrEmpty(Util.NVC(subRow["CLCTVAL01"])) && !string.Equals(Util.NVC(subRow["CLCTVAL01"]), Double.NaN.ToString()))
                        {
                            isValid = true;
                            break;
                        }
                    }

                    if (isValid == false)
                    {
                        Util.MessageValidation("SFU3601", sItemName);   //해당 품질정보[%1]는 필수값이기 때문에 한 항목이라도 측정값의 입력이 필요합니다.
                        return false;
                    }
                }
            }

            if (QUALITY2_GRID.Visibility == Visibility.Visible && QUALITY2_GRID.Rows.Count > 0)
            {
                DataView view = DataTableConverter.Convert(QUALITY2_GRID.ItemsSource).DefaultView;
                view.RowFilter = "MAND_INSP_ITEM_FLAG = 'Y'";
                DataTable dt = view.ToTable(true, "INSP_ITEM_ID");

                foreach (DataRow row in dt.Rows)
                {
                    string sItemName = string.Empty;
                    bool isValid = false;
                    DataRow[] filterRows = DataTableConverter.Convert(QUALITY2_GRID.ItemsSource).Select("INSP_ITEM_ID = '" + Util.NVC(row["INSP_ITEM_ID"]) + "'");
                    foreach (DataRow subRow in filterRows)
                    {
                        sItemName = Util.NVC(subRow["INSP_ITEM_NAME"]);
                        if (!string.IsNullOrEmpty(Util.NVC(subRow["CLCTVAL01"])) && !string.Equals(Util.NVC(subRow["CLCTVAL01"]), Double.NaN.ToString()))
                        {
                            isValid = true;
                            break;
                        }
                    }

                    if (isValid == false)
                    {
                        Util.MessageValidation("SFU3601", sItemName);   //해당 품질정보[%1]는 필수값이기 때문에 한 항목이라도 측정값의 입력이 필요합니다.
                        return false;
                    }
                }
            }
            return true;
        }

        // 상/하한값 필수 입력 체크 Validation 추가 [2018-07-18]
        private bool ValidQualitySpecRequired()
        {
            if (QUALITY_GRID.Visibility == Visibility.Visible && QUALITY2_GRID.Visibility != Visibility.Visible && QUALITY_GRID.Rows.Count > 0)
            {
                DataView view = DataTableConverter.Convert(QUALITY_GRID.ItemsSource).DefaultView;
                view.RowFilter = "SPEC_USE_MAND_INSP_ITEM_FLAG = 'Y'";
                DataTable dt = view.ToTable(true, "INSP_ITEM_ID");

                foreach (DataRow row in dt.Rows)
                {
                    string sItemName = string.Empty;
                    DataRow[] filterRows = DataTableConverter.Convert(QUALITY_GRID.ItemsSource).Select("INSP_ITEM_ID = '" + Util.NVC(row["INSP_ITEM_ID"]) + "'");
                    foreach (DataRow subRow in filterRows)
                    {
                        sItemName = Util.NVC(subRow["INSP_ITEM_NAME"]);
                        if ((!string.IsNullOrEmpty(Util.NVC(subRow["USL"])) || !string.IsNullOrEmpty(Util.NVC(subRow["LSL"]))) && (string.IsNullOrEmpty(Util.NVC(subRow["CLCTVAL01"])) || string.Equals(Util.NVC(subRow["CLCTVAL01"]), Double.NaN.ToString())))
                        {
                            Util.MessageValidation("SFU4985", sItemName);   //해당 품질정보[%1]는 상/하한 값이 존재하는 경우 측정값이 필수로 지정되어 있어 측정값 입력이 필요합니다.
                            return false;
                        }
                    }
                }
            }

            if (QUALITY2_GRID.Visibility == Visibility.Visible && QUALITY2_GRID.Rows.Count > 0)
            {
                DataView view = DataTableConverter.Convert(QUALITY2_GRID.ItemsSource).DefaultView;
                view.RowFilter = "SPEC_USE_MAND_INSP_ITEM_FLAG = 'Y'";
                DataTable dt = view.ToTable(true, "INSP_ITEM_ID");

                foreach (DataRow row in dt.Rows)
                {
                    string sItemName = string.Empty;
                    string itemName = string.Empty;
                    DataRow[] filterRows = DataTableConverter.Convert(QUALITY2_GRID.ItemsSource).Select("INSP_ITEM_ID = '" + Util.NVC(row["INSP_ITEM_ID"]) + "'");
                    foreach (DataRow subRow in filterRows)
                    {
                        sItemName = Util.NVC(subRow["INSP_ITEM_NAME"]);
                        if ((!string.IsNullOrEmpty(Util.NVC(subRow["USL"])) || !string.IsNullOrEmpty(Util.NVC(subRow["LSL"]))) && (string.IsNullOrEmpty(Util.NVC(subRow["CLCTVAL01"])) || string.Equals(Util.NVC(subRow["CLCTVAL01"]), Double.NaN.ToString())))
                        {
                            Util.MessageValidation("SFU4985", sItemName);   //해당 품질정보[%1]는 상/하한 값이 존재하는 경우 측정값이 필수로 지정되어 있어 측정값 입력이 필요합니다.
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        private bool ValidQualitySpec(string validType)
        {
            bool bRet = true;
            try
            {
                DataTable qualityList = QUALITY_GRID.ItemsSource == null ? null : ((DataView)QUALITY_GRID.ItemsSource).ToTable();
                DataTable qualityList2 = QUALITY2_GRID.ItemsSource == null ? null : ((DataView)QUALITY2_GRID.ItemsSource).ToTable();
                string LSL = string.Empty;
                string USL = string.Empty;
                string AUTO_HOLD_FLAG = string.Empty;
                string CLCTVAL = string.Empty;

                if (qualityList != null && qualityList.Rows.Count > 0)
                {
                    for (int i = 0; i < qualityList.Rows.Count; i++)
                    {
                        LSL = qualityList.Rows[i]["LSL"].ToString();
                        USL = qualityList.Rows[i]["USL"].ToString();
                        AUTO_HOLD_FLAG = qualityList.Rows[i]["AUTO_HOLD_FLAG"].ToString();

                        //yield LSL USL => 또 팝업 => 예를 누르면 실적확정되면서 무조건 홀드

                        if (!qualityList.Rows[i]["CLCTVAL01"].ToString().Equals("NaN"))
                        {
                            CLCTVAL = qualityList.Rows[i]["CLCTVAL01"].ToString();
                        }

                        if (!String.IsNullOrWhiteSpace(LSL) && !String.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            //validType이 Hold면 자동보류여부를 체크하고
                            //아니면 체크 안하고
                            if (Util.NVC_Int(LSL) > 0 && Util.NVC_Int(LSL) > Util.NVC_Int(CLCTVAL) && (( validType.Equals("Hold") && AUTO_HOLD_FLAG.Equals("Y") ) || validType.Equals("Auth"))) 
                            {
                                bRet = false;
                            }
                        }
                        if (!String.IsNullOrWhiteSpace(USL) && !String.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            if (Util.NVC_Int(USL) > 0 && Util.NVC_Int(USL) < Util.NVC_Int(CLCTVAL) && ((validType.Equals("Hold") && AUTO_HOLD_FLAG.Equals("Y")) || validType.Equals("Auth")))
                            {
                                bRet = false;
                            }
                        }
                    }
                }

                if (qualityList2 != null && qualityList2.Rows.Count > 0)
                {
                    for (int j = 0; j < qualityList2.Rows.Count; j++)
                    {
                        LSL = qualityList2.Rows[j]["LSL"].ToString();
                        USL = qualityList2.Rows[j]["USL"].ToString();
                        AUTO_HOLD_FLAG = qualityList2.Rows[j]["AUTO_HOLD_FLAG"].ToString();

                        if (!qualityList2.Rows[j]["CLCTVAL01"].ToString().Equals("NaN"))
                        {
                            CLCTVAL = qualityList2.Rows[j]["CLCTVAL01"].ToString();
                        }

                        if (!String.IsNullOrWhiteSpace(LSL) && !String.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            if (Util.NVC_Int(LSL) > 0 && Util.NVC_Int(LSL) > Util.NVC_Int(CLCTVAL) && ((validType.Equals("Hold") && AUTO_HOLD_FLAG.Equals("Y")) || validType.Equals("Auth")))
                            {
                                bRet = false;
                            }
                        }
                        if (!String.IsNullOrWhiteSpace(USL) && !String.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            if (Util.NVC_Int(USL) > 0 && Util.NVC_Int(USL) < Util.NVC_Int(CLCTVAL) && ((validType.Equals("Hold") && AUTO_HOLD_FLAG.Equals("Y")) || validType.Equals("Auth")))
                            {
                                bRet = false;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                bRet = true;
            }

            return bRet;
        }

        private bool ValidQualitySpecExists()
        {
            bool bRet = true;
            try
            {
                DataTable qualityList = QUALITY_GRID.ItemsSource == null ? null : ((DataView)QUALITY_GRID.ItemsSource).ToTable();
                DataTable qualityList2 = QUALITY2_GRID.ItemsSource == null ? null : ((DataView)QUALITY2_GRID.ItemsSource).ToTable();
                string LSL = string.Empty;
                string USL = string.Empty;
                string AUTO_HOLD_FLAG = string.Empty;
                string CLCTVAL = string.Empty;
                string SPEC_TYPE_CODE = string.Empty;  //201.03.11 추가

                if (qualityList != null && qualityList.Rows.Count > 0)
                {
                    for (int i = 0; i < qualityList.Rows.Count; i++)
                    {
                        LSL = qualityList.Rows[i]["LSL"].ToString();
                        USL = qualityList.Rows[i]["USL"].ToString();
                        AUTO_HOLD_FLAG = qualityList.Rows[i]["AUTO_HOLD_FLAG"].ToString();
                        SPEC_TYPE_CODE = qualityList.Rows[i]["SPEC_TYPE_CODE"].ToString();  //2021.03.11 추가

                        if (!qualityList.Rows[i]["CLCTVAL01"].ToString().Equals("NaN"))
                        {
                            CLCTVAL = qualityList.Rows[i]["CLCTVAL01"].ToString();
                        }

                        if (AUTO_HOLD_FLAG.Equals("Y") && !string.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            if (SPEC_TYPE_CODE == "B")
                            {
                                if (string.IsNullOrWhiteSpace(LSL) || string.IsNullOrWhiteSpace(USL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                            else if (SPEC_TYPE_CODE == "U")
                            {
                                if (string.IsNullOrWhiteSpace(USL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                            else if (SPEC_TYPE_CODE == "L")
                            {
                                if (string.IsNullOrWhiteSpace(LSL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                        }
                    }
                }

                if (qualityList2 != null && qualityList2.Rows.Count > 0)
                {
                    for (int j = 0; j < qualityList2.Rows.Count; j++)
                    {
                        LSL = qualityList2.Rows[j]["LSL"].ToString();
                        USL = qualityList2.Rows[j]["USL"].ToString();
                        AUTO_HOLD_FLAG = qualityList2.Rows[j]["AUTO_HOLD_FLAG"].ToString();
                        SPEC_TYPE_CODE = qualityList2.Rows[j]["SPEC_TYPE_CODE"].ToString(); //2021.03.11 추가

                        if (!qualityList2.Rows[j]["CLCTVAL01"].ToString().Equals("NaN"))
                        {
                            CLCTVAL = qualityList2.Rows[j]["CLCTVAL01"].ToString();
                        }

                        if (AUTO_HOLD_FLAG.Equals("Y") && !String.IsNullOrWhiteSpace(CLCTVAL))
                        {
                            if (SPEC_TYPE_CODE == "B")
                            {
                                if (string.IsNullOrWhiteSpace(LSL) || string.IsNullOrWhiteSpace(USL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                            else if (SPEC_TYPE_CODE == "U")
                            {
                                if (string.IsNullOrWhiteSpace(USL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                            else if (SPEC_TYPE_CODE == "L")
                            {
                                if (string.IsNullOrWhiteSpace(LSL))
                                {
                                    bRet = false;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                bRet = true;
            }

            return bRet;
        }

        private bool ValidLabelPass()
        {
            bool bRet = true;
            DataTable dt = new DataTable();
            dt.Columns.Add("LOTID");
            dt.Columns.Add("EQPTID");

            DataRow dr = dt.NewRow();
            dr["LOTID"] = _CUTID;
            dr["EQPTID"] = _EQPTID;
            dt.Rows.Add(dr);

            DataTable rslt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_DATA_ECLCT", "INDATA", "OUTDATA", dt);

            if(rslt != null && rslt.Rows.Count > 0)
            {
                bRet = false;
            }
            else
            {
                bRet = true;
            }
            return bRet;
        }

        private void CheckGoodQty(Action callback)
        {
            try
            {
                DataTable dt = DataTableConverter.Convert(LOTINFO_GRID.ItemsSource);
                // 코터 공정은 양품량 0이면 실적 확정 안되게
                if (string.Equals(txtInputQty.Tag, "C"))
                {
                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        if (Util.NVC_Decimal(dt.Rows[i]["GOODQTY"]) <= 0)
                        {
                            Util.MessageConfirm("SFU8500", result =>
                            {
                                if (result == MessageBoxResult.OK)
                                {
                                    callback();
                                }
                                else return;
                            });
                        }
                        else callback();
                    }
                }

                else if (procId.Equals(Process.SLITTING))
                {
                    double goodQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                    if (goodQty < 0)
                    {
                        Util.MessageConfirm("SFU9020", result =>
                        {
                            if (result == MessageBoxResult.OK)
                            {
                                callback();
                            }
                            else return;
                        });
                    }
                    else callback();
                }
                else callback();
            }
            catch (Exception ex)
            {
            }
        }
        


        private void CheckLabelPassHold(Action callback)
        {
            try
            {
                //라벨링 패스 기능은 기존에도 활성화 되어 있었음
                _LABEL_PASS_HOLD_FLAG = "Y";

                DataTable dt = new DataTable();
                dt.Columns.Add("LANGID");
                dt.Columns.Add("CMCDTYPE");
                dt.Columns.Add("CMCODE");

                DataRow dr = dt.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = "LABEL_PASS_HOLD_CHECK";
                dr["CMCODE"] = LoginInfo.CFG_AREA_ID;
                dt.Rows.Add(dr);

                DataTable rslt = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "INDATA", "OUTDATA", dt);

                if (rslt != null && rslt.Rows.Count > 0)
                {
                    if (!ValidLabelPass())
                    {
                        LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU8218"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                        {
                            //홀드
                            //전극의 모든 실적확정 로직에 플래그를 넣어서 Y면 자주검사스펙 홀드를 통과하도록하고 N이면 넘긴다
                            //MMD 동별 자주검사에서 자동홀드여부도 Y로 바꿔야 한다.
                            //또한 홀드를 걸 항목에 대해서만 LSL USL을 등록한다.
                            if (result == MessageBoxResult.OK)
                            {
                                _LABEL_PASS_HOLD_FLAG = "Y";
                            }
                            else
                            {
                                _LABEL_PASS_HOLD_FLAG = "N";
                            }
                            callback();
                        });
                    }
                    else
                    {
                        callback();
                    }
                }
                else
                {
                    callback();
                }
            }
            catch(Exception ex)
            {

            }
        }

        private void CheckSpecOutHold(Action callback)
        {
            try
            {
                //자동보류여부에 체크되어 있으면 무조건 홀드를 건다.
                if (!ValidQualitySpec("Hold"))
                {
                    //자동HOLD되도록 설정된 품질검사 결과가 기준치를 만족하지 못했습니다. 완성랏이 홀드됩니다. 계속하시겠습니까?
                    LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU8185"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                    {
                        if (result == MessageBoxResult.OK)
                        {
                            callback();
                        }
                    });
                }
                else
                {
                    if (!ValidQualitySpecExists())
                    {
                        //LSL, USL 미설정되어 계속 진행할 경우 완성LOT이 HOLD처리 됩니다. 계속하시겠습니까?
                        LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU8186"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                        {
                            if (result == MessageBoxResult.OK)
                            {
                                callback();
                            }
                        });
                    }
                    else
                    {
                        callback();
                    }
                }
            }
            catch (Exception ex)
            {
            }
        }

        private void CheckAuthValidation(Action callback)
        {
            try
            {
                // AD 인증 기능 추가 [2019-08-21]
                DataTable confirmDt = GetConfirmAuthVaildation();

                if (confirmDt != null && confirmDt.Rows.Count > 0)
                {
                    // 강제 인터락 체크 (이거는 공용 메세지로 공유하니 필요 시 MES MESSAGE 코드 별도 추가 필요)
                    if (string.Equals(confirmDt.Rows[0]["VALIDATION_FLAG"], "Y"))
                    {
                        // 실적확정은 자동 Interlock 기능에 의하여 보류 되었습니다. [%1]
                        Util.MessageValidation("SFU5125", new object[] { Util.NVC(confirmDt.Rows[0]["RSLT_CNFM_TYPE_CODE"]) });
                        return;
                    }

                    // AD 인증 체크
                    if (string.Equals(confirmDt.Rows[0]["AD_CHK_FLAG"], "Y"))
                    {
                        LGC.GMES.MES.CMM001.CMM_COM_AUTH_CONFIRM authConfirm = new LGC.GMES.MES.CMM001.CMM_COM_AUTH_CONFIRM();
                        authConfirm.FrameOperation = FrameOperation;
                        authConfirm.sContents = Util.NVC(confirmDt.Rows[0]["DISP_MSG"]);
                        if (authConfirm != null)
                        {
                            // SBC AD 인증
                            if (string.Equals(confirmDt.Rows[0]["AD_CHK_TYPE_CODE"], "SBC_AD"))
                            {
                                object[] Parameters = new object[1];
                                Parameters[0] = Util.NVC(confirmDt.Rows[0]["AUTHID"]);

                                C1WindowExtension.SetParameters(authConfirm, Parameters);

                            }
                            else if (string.Equals(confirmDt.Rows[0]["AD_CHK_TYPE_CODE"], "LGCHEM_AD"))
                            {
                                object[] Parameters = new object[2];
                                Parameters[0] = Util.NVC(confirmDt.Rows[0]["AUTHID"]);
                                Parameters[1] = "lgchem.com";

                                C1WindowExtension.SetParameters(authConfirm, Parameters);
                            }
                            authConfirm.Closed += new EventHandler(OnCloseAuthConfirm);
                            this.Dispatcher.BeginInvoke(new Action(() => authConfirm.ShowModal()));
                        }
                    }
                    else
                    {
                        callback();
                    }
                }
                else
                {
                    callback();
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private bool ValidDefectTagRemark()
        {
             //2022-12-29 오화백 EP 동 추가
            if ( string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EA") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
            {
                DataTable dt = DataTableConverter.Convert(WIPREASON_GRID.ItemsSource).DefaultView.ToTable();
                DataRow[] row = dt.Select(string.Format("RESNCODE = '{0}'", new object[] { "P999000APC" }));  // 기타 불량 태그 하드코딩

                if (row != null && row.Length > 0)
                {
                    // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                    int iCount = isResnCountUse == true ? 1 : 0;

                    int index = 1;
                    for (int i = WIPREASON_GRID.Columns["ALL"].Index + (1 + iCount); i < WIPREASON_GRID.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                    {
                        // 불량TAG수 메일링 11개 기준으로 10개 초과시에만 Validation 적용 [2019-02-08]
                        if (!string.IsNullOrEmpty(Util.NVC(row[0][i])) && Util.NVC_Int(row[0][i]) >= 11)
                        {
                            // 공통 특이사항이 입력되어 있으면 PASS
                            if (!string.IsNullOrWhiteSpace(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[0].DataItem, "REMARK"))))
                                return true;

                            // 개별 특이사항 체크
                            if (string.IsNullOrWhiteSpace(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[index].DataItem, "REMARK"))))
                            {
                                Util.MessageValidation("SFU6012", new object[] { DataTableConverter.GetValue(REMARK_GRID.Rows[index].DataItem, "LOTID") }); // 불량 특이사항을 입력 하세요.[%1]
                                return false;
                            }
                        }
                        index++;
                    }
                }
            }
            return true;
        }

        private bool ValidDefectTagInput()
        {
            for( int i = 0; i < DEFECT_TAG_GRID.Rows.Count; i++)
            {
                string sTagValue = Util.NVC(DataTableConverter.GetValue(DEFECT_TAG_GRID.Rows[i].DataItem, "CLCTVAL01"));
                if ( string.IsNullOrEmpty(sTagValue) || Util.NVC_Decimal(sTagValue) <= 0)
                {
                    Util.MessageValidation("SFU3412");  //불량태그 수량을 전부 입력하세요.
                    return false;
                }
            }

            return true;
        }

        private bool ValidWorkTime()
        {
            if (string.IsNullOrEmpty(txtStartDateTime.Text))
            {
                Util.MessageValidation("SFU1696");  //시작시간 정보가 없습니다.
                return false;
            }

            double totalMin = (Convert.ToDateTime(txtEndDateTime.Text) - Convert.ToDateTime(txtStartDateTime.Text)).TotalMinutes;
            //txtWorkTime.Value = (dtpEndDateTime.DateTime.Value - Convert.ToDateTime(txtStartDateTime.Text)).TotalMinutes;

            if (totalMin < 0)
            {
                Util.MessageValidation("SFU1219");  //가동시간을 확인 하세요.
                return false;
            }
            return true;
        }

        private bool ValidEndTime()
        {
            //if (System.DateTime.Now < dtpEndDateTime.DateTime.Value)
            /*
            if (System.DateTime.Now < Convert.ToDateTime(txtEndDateTime.Text))
            {
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1912"), null, "Info", MessageBoxButton.OK, MessageBoxIcon.None);    //종료시간을 확인 하세요.
                return false;
            }
            */
            return true;
        }
        private bool ValidShift()
        {
            if (string.IsNullOrEmpty(txtShift.Text.Trim()))
            {
                Util.MessageValidation("SFU1845");  //작업조를 입력하세요.
                return false;
            }

            return true;
        }

        private bool ValidOperator()
        {
            if (string.IsNullOrEmpty(txtWorker.Text.Trim()))
            {
                Util.MessageValidation("SFU1843");  //작업자를 입력 해 주세요.
                return false;
            }

            return true;
        }

        private bool ValidVersion()
        {
            if (string.IsNullOrEmpty(txtVersion.Text.Trim()))
            {
                Util.MessageValidation("SFU1218");  //Version 정보를 입력 하세요.
                return false;
            }
            return true;
        }

        private bool ValidLaneQty()
        {
            if (string.IsNullOrEmpty(Util.NVC(txtLaneQty.Value)) || txtLaneQty.Value < 1)
            {
                Util.MessageValidation("SFU1351");  //Lane 정보가 없습니다
                return false;
            }
            return true;
        }

        private bool ValidLaneWrongQty()
        {

            //슬리터 2차 추가 2021-09-15 by 오화백
            if (!procId.Equals(Process.PRE_MIXING) && !procId.Equals(Process.MIXING) && !procId.Equals(Process.SRS_MIXING) && !procId.Equals(Process.SLITTING) && !procId.Equals("E4200") && !procId.Equals(Process.SRS_SLITTING) && !procId.Equals(Process.HEAT_TREATMENT))
            {
                if (procId.Equals(Process.HALF_SLITTING))
                {
                    for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        if (Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LANE_QTY")) == 1)
                            return false;
                }
                else
                {
                    if (txtLaneQty.Value == 1)
                        return false;
                }
            }
            return true;
        }

        private bool ValidOverProdQty()
        {
            double inputQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
            double lossQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));

            if ( inputQty < lossQty)
            {
                Util.MessageValidation("SFU3236");
                return false;
            }
            return true;
        }

        private bool ValidConfirmQty()
        {
            decimal inputQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

            if (isCoaterAfterProcess)
            {
                if (exceedLengthQty > 0)
                {
                    // 투입량 <> (생산량 - 길이초과) 여야 확정 가능
                    if (Util.NVC_Decimal(txtParentQty.Value) != (inputQty - exceedLengthQty))
                    {
                        Util.MessageValidation("SFU3417");  //길이초과 입력 시 잔량이 0이어야 합니다.
                        return false;
                    }
                }
            }
            return true;
        }

        private bool ValidCutOverProdQty()
        {
            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
            {
                // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                int iCount = isResnCountUse == true ? 1 : 0;

                double inputQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

                for (int i = WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount); i < WIPREASON_GRID.Columns["COSTCENTERID"].Index; i += (2 + iCount))
                {
                    if (inputQty < SumDefectQty(WIPREASON_GRID, WIPREASON_GRID.Columns[i].Name))
                    {
                        Util.MessageValidation("SFU3236");
                        return false;
                    }
                }
            }
            return true;
        }

        private bool ValidInOutQty()
        {
            if ( txtSrs3Qty.Value > 0 && txtSrs2Qty.Value == 0 )
            {
                Util.MessageValidation("SFU3725");  //Mid수량이 입력된 상태에서 Out수량을 입력히지 않으면 실적확정이 불가능 합니다. (In/Out수량 확인 후 진행)
                return false;
            }
            return true;
        }

        private void permitRatePopup_Closed(object sender, DataSet inDataSet, string bizRuleName, string inDataTableName)
        {
            try
            {
                CMM_PERMIT_RATE popup = sender as CMM_PERMIT_RATE;
                if (popup != null && popup.DialogResult == MessageBoxResult.OK)
                {
                    // 허용비율 사유 팝업 데이터 리턴 
                    dtPermitRateReturn.Clear();
                    dtPermitRateReturn = popup.PERMIT_RATE.Copy();
                    permitRateUerReturn = popup.UserID;
                    permitRateDeptReturn = popup.DeptID;

                    // 실적 확정 프로세스 
                    ConfirmAfterLeavePermitRateReason(inDataSet, bizRuleName, inDataTableName);

                    // 불량 초과 사유 입력 
                    BR_PRD_REG_PERMIT_RATE_OVER_HIST();
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        // 불량비율 초과 사유 입력 Biz 
        private void BR_PRD_REG_PERMIT_RATE_OVER_HIST()
        {
            try
            {
                DataTable dtLotInfo = dtPermitRateReturn.DefaultView.ToTable(true, new string[] { "LOTID", "WIPSEQ" });
                //string lotID = dtPermitRateReturn.Rows[0]["LOTID"].ToString();
                //GetWipSeq(lotID, string.Empty); // 전역변수: _WIPSEQ 세팅 
                string rLotID = "";

                DataSet indataSet = new DataSet();
                DataTable inTable = indataSet.Tables.Add("INDATA");
                inTable.Columns.Add("SRCTYPE", typeof(string));
                inTable.Columns.Add("IFMODE", typeof(string));
                inTable.Columns.Add("EQPTID", typeof(string));
                inTable.Columns.Add("USERID", typeof(string));
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIPSEQ", typeof(string));

                DataTable inRESN = indataSet.Tables.Add("IN_RESN");
                inRESN.Columns.Add("PERMIT_RATE", typeof(decimal));
                inRESN.Columns.Add("ACTID", typeof(string));
                inRESN.Columns.Add("RESNCODE", typeof(string));
                inRESN.Columns.Add("RESNQTY", typeof(decimal));
                inRESN.Columns.Add("OVER_QTY", typeof(decimal));
                inRESN.Columns.Add("REQ_USERID", typeof(string));
                inRESN.Columns.Add("REQ_DEPTID", typeof(string));
                inRESN.Columns.Add("DIFF_RSN_CODE", typeof(string));
                inRESN.Columns.Add("NOTE", typeof(string));

                foreach (DataRow lotRow in dtLotInfo.Rows)
                {
                    inTable.Rows.Clear();
                    inRESN.Rows.Clear();

                    rLotID = lotRow["LOTID"].ToString();

                    DataRow newRow = inTable.NewRow();
                    newRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                    newRow["IFMODE"] = IFMODE.IFMODE_OFF;
                    newRow["EQPTID"] = null; 
                    newRow["USERID"] = LoginInfo.USERID;
                    newRow["LOTID"] = rLotID;
                    newRow["WIPSEQ"] = lotRow["WIPSEQ"].ToString();
                    inTable.Rows.Add(newRow);
                    newRow = null;

                    foreach (DataRow retRow in dtPermitRateReturn.Rows)
                    {
                        
                        if (rLotID.Equals(retRow["LOTID"]))
                        {
                            newRow = inRESN.NewRow();
                            newRow["PERMIT_RATE"] = Util.NVC_Decimal(retRow["PERMIT_RATE"]);
                            newRow["ACTID"] = retRow["ACTID"].ToString();
                            newRow["RESNCODE"] = retRow["RESNCODE"].ToString();
                            newRow["RESNQTY"] = Util.NVC_Decimal(retRow["RESNQTY"]);
                            newRow["OVER_QTY"] = Util.NVC_Decimal(retRow["OVER_QTY"]);
                            newRow["REQ_USERID"] = permitRateUerReturn;
                            newRow["REQ_DEPTID"] = permitRateDeptReturn;
                            newRow["DIFF_RSN_CODE"] = retRow["SPCL_RSNCODE"].ToString();
                            newRow["NOTE"] = retRow["RESNNOTE"].ToString();
                            inRESN.Rows.Add(newRow);
                        }
                    }

                    string inTableNames = String.Join(",", indataSet.Tables.Cast<DataTable>().ToArray().Select(i => i.TableName));

                    new ClientProxy().ExecuteService_Multi("BR_PRD_REG_PERMIT_RATE_OVER_HIST", inTableNames, null, (bizResult, bizException) =>
                    {
                        try
                        {
                            if (bizException != null)
                            {
                                Util.MessageException(bizException);
                                return;
                            }
                            //Util.AlertInfo("정상 처리 되었습니다.");
                            //Util.MessageInfo("SFU1275");
                        }
                        catch (Exception ex)
                        {
                            Util.MessageException(ex);
                        }
                        finally
                        {

                        }
                    }, indataSet);
                    // 연속 호출시 선행 서비스 파라미터 덮어씀 방지 (ytkim29. 2024-02-14) 
                    System.Threading.Thread.Sleep(100);
                }

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        // 실적확정전 허용비율(%) 초과 데이터 구함 
        private DataTable GetPermitRateOverData()
        {
            DataTable dtLotInfo = DataTableConverter.Convert(LOTINFO_GRID.ItemsSource);
            decimal eqpEndQty = Util.NVC_Decimal(dtLotInfo.Rows[0]["EQPT_END_QTY"]); // 장비수량

            // 코터 공정의 경우 불량/LOSS/물품청구 TOP, BACK 자료 모두 존재할 경우, 입력 수량의 1/2로 처리함 
            decimal halfDevide = 2.0m;
            bool isHalfTopInCoater = false;
            if ((procId.Equals(Process.COATING) /*|| procId.Equals(Process.INS_COATING) */) // 코터, 단면코터, 절연코터는 해당 안됨 
                && WIPREASON2_GRID.ItemsSource != null)
            {
                isHalfTopInCoater = true;
            }

            DataTable dtPermitRate = new DataTable();

            foreach (DataRow rowLot in dtLotInfo.Rows)
            {
                DataTable dtTemp1 = new DataTable();
                DataTable dtTemp2 = new DataTable();

                string lotID = rowLot["LOTID"].ToString();
                GetWipSeq(lotID, string.Empty); // 전역변수: _WIPSEQ 세팅 
                string wipSeq = String.IsNullOrEmpty(_WIPSEQ) ? null : _WIPSEQ;

                string resnQtyName = "RESNQTY"; // 수량 컬럼명 
                
                // 슬리팅 공정의 경우, 각 태그 (실제 LOTID별) 수량 체크 
                if (procId.Equals(Process.SLITTING) || procId.Equals(Process.TWO_SLITTING) || procId.Equals(Process.HALF_SLITTING))
                {
                    resnQtyName = lotID;
                }

                List<DataRow> permitRateDataRow = DataTableConverter.Convert(WIPREASON_GRID.ItemsSource)
                .AsEnumerable()
                .Where(row => Util.NVC_Decimal(row["PERMIT_RATE"]) > 0 && Math.Truncate(eqpEndQty * (Util.NVC_Decimal(row["PERMIT_RATE"]) / 100)) < (isHalfTopInCoater ? Util.NVC_Decimal(row[resnQtyName]) / halfDevide : Util.NVC_Decimal(row[resnQtyName])))
                .ToList<DataRow>();

                List<DataRow> permitRateDataRow2 = DataTableConverter.Convert(WIPREASON2_GRID.ItemsSource)
                    .AsEnumerable().Where(row => Util.NVC_Decimal(row["PERMIT_RATE"]) > 0 && Math.Truncate(eqpEndQty * (Util.NVC_Decimal(row["PERMIT_RATE"]) / 100)) < Util.NVC_Decimal(row[resnQtyName]))
                    .ToList<DataRow>();

                dtTemp1 = permitRateDataRow.Any() ? permitRateDataRow.CopyToDataTable() : DataTableConverter.Convert(WIPREASON_GRID.ItemsSource).Clone();
                dtTemp2 = permitRateDataRow2.Any() ? permitRateDataRow2.CopyToDataTable() : DataTableConverter.Convert(WIPREASON2_GRID.ItemsSource).Clone();

                if (!dtTemp1.Columns.Contains("LOTID")) { dtTemp1.Columns.Add(new DataColumn { ColumnName = "LOTID", DefaultValue = lotID }); }
                if (!dtTemp2.Columns.Contains("LOTID")) { dtTemp2.Columns.Add(new DataColumn { ColumnName = "LOTID", DefaultValue = lotID }); }

                if (!dtTemp1.Columns.Contains("WIPSEQ")) { dtTemp1.Columns.Add(new DataColumn { ColumnName = "WIPSEQ", DefaultValue = wipSeq }); }
                if (!dtTemp2.Columns.Contains("WIPSEQ")) { dtTemp2.Columns.Add(new DataColumn { ColumnName = "WIPSEQ", DefaultValue = wipSeq }); }

                dtPermitRate.Merge(dtTemp1);
                dtPermitRate.Merge(dtTemp2);

            }
            return dtPermitRate;
        }

        // 실적확정시 불량 초과 사유 팝업 미실행 (아직 반영전 공정에 쓰임) 
        private DataTable GetPermitRateEmptyData()
        {
            return new DataTable();
        }


        // 허용비율(%) 초과 사유 입력 팝업 실행 
        private void SetPermitRateOverHis(DataTable dtPermitRate, DataSet inDataSet, string bizRuleName, string inDataTableName)
        {
            DataTable dtLotInfo = DataTableConverter.Convert(LOTINFO_GRID.ItemsSource);
            decimal eqpEndQty = Util.NVC_Decimal(dtLotInfo.Rows[0]["EQPT_END_QTY"]); // 장비수량 
            string lotID = dtLotInfo.Rows[0]["LOTID"].ToString(); // 의미 없음 
            //GetWipSeq(lotID, string.Empty); // 전역변수: _WIPSEQ 세팅 // 의미 없음 

            // 불량발생 수량 컬럼명 
            string resnQtyName = "RESNQTY";

            //if (procId.Equals(Process.SLITTING) || procId.Equals(Process.TWO_SLITTING) || procId.Equals(Process.HALF_SLITTING))
            //{
            //    resnQtyName = "RESNTOTQTY";
            //}

            // 허용 불량수량 초과 사유 입력 창 실행 
            CMM_PERMIT_RATE permitRatePopup = new CMM_PERMIT_RATE();
            permitRatePopup.FrameOperation = this.FrameOperation;

            DataTable input = new DataTable();
            input.Columns.Add("LOTID", typeof(string));
            input.Columns.Add("WIPSEQ", typeof(string));

            input.Columns.Add("ACTID", typeof(string));
            input.Columns.Add("ACTNAME", typeof(string));
            input.Columns.Add("RESNCODE", typeof(string));

            input.Columns.Add("RESNNAME", typeof(string));
            input.Columns.Add("DFCT_CODE_DETL_NAME", typeof(string));
            input.Columns.Add("RESNQTY", typeof(string));
            input.Columns.Add("PERMIT_RATE", typeof(string));
            input.Columns.Add("OVER_QTY", typeof(string));
            input.Columns.Add("SPCL_RSNCODE", typeof(string));
            input.Columns.Add("SPCL_RSNCODE_NAME", typeof(string));
            input.Columns.Add("RESNNOTE", typeof(string));

            foreach (DataRow row in dtPermitRate.Rows)
            {
                if (procId.Equals(Process.SLITTING) || procId.Equals(Process.TWO_SLITTING) || procId.Equals(Process.HALF_SLITTING))
                {
                    resnQtyName = row["LOTID"].ToString();
                }

                // 초과 수량 계산 : 소수점 3자리까지 올림해서 보여준다. ex) 0.6723 => 0.673
                decimal d1 = Util.NVC_Decimal(row[resnQtyName]); // 장비수량 
                if (procId.Equals(Process.COATING) && WIPREASON2_GRID.ItemsSource != null) // 코터 공정의 경우 불량 수량 1/2 
                {
                    d1 = d1 / 2;  
                }
                decimal d2 = Util.NVC_Decimal(row["PERMIT_RATE"]); // 허용비율 
                decimal d3 = d1 - ((eqpEndQty * d2) / 100); // 초과 수량 (소수점 그대로) 


                DataRow newRow = input.NewRow();
                newRow["LOTID"] = row["LOTID"];
                newRow["WIPSEQ"] = row["WIPSEQ"];
                newRow["ACTID"] = row["ACTID"];
                newRow["ACTNAME"] = row["ACTNAME"];
                newRow["RESNCODE"] = row["RESNCODE"];
                newRow["RESNNAME"] = row["RESNNAME"];
                newRow["DFCT_CODE_DETL_NAME"] = null; // 필수 x
                newRow["RESNQTY"] = String.Format("{0:0.000}", Util.NVC_Decimal(row[resnQtyName]));
                newRow["PERMIT_RATE"] = String.Format("{0:0.00}", row["PERMIT_RATE"]);
                //newRow["OVER_QTY"] = String.Format("{0:0.000}", Util.NVC_Decimal(row[resnQtyName]) - Math.Truncate(eqpEndQty * (Util.NVC_Decimal(row["PERMIT_RATE"]) / 100)));
                newRow["OVER_QTY"] = Math.Ceiling(d3 * 1000) / 1000; // 초과수량 소수점 4자리에서 3자리로 반올림 
                input.Rows.Add(newRow);
            }

            object[] parameters = new object[2];
            parameters[0] = lotID;
            parameters[1] = input;
            C1WindowExtension.SetParameters(permitRatePopup, parameters);

            permitRatePopup.Closed += (sender, e) => { permitRatePopup_Closed(sender, inDataSet, bizRuleName, inDataTableName); };
            Dispatcher.BeginInvoke(new Action(() => permitRatePopup.ShowModal()));
        }

        // 불량 허용비율 초과 사유 입력 후 실적 확정 
        private void ConfirmAfterLeavePermitRateReason(DataSet inDataSet, string bizRuleName, string inDataTableName)
        {
            if (isRollDirCtn)
                SetWipAttrRollDir();

            if (procId.Equals(Process.SLITTING))
            {
                if (isBarCodePrint)
                {
                    SaveDefectCheckUpDate("N");
                    isBarCodePrint = false;
                }
            }

            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
            {
                if (ex != null)
                {
                    Util.MessageException(ex);
                    return;
                }
                isConfirm = true;
                if (procId.Equals(Process.COATING))
                {
                    isSlurryPopup = true;
                }
                REFRESH = true;
            }, inDataSet);
        }


        void ConfirmProcess(bool isLastBatch = false)
        {  
            string listData = string.Empty;

            // END TIME을 현재 시간으로 넣기 위하여 DB에서 조회
            string sEndTime = GetCurrentTime().ToString("yyyy-MM-dd HH:mm:ss");

            // TOP 정보 추가 (생산량과 설비완료수량 차이가 30이상인 경우 확인) => SRS 코터/슬리터 제외 요청 들어옴
            string topInfo = string.Empty;

            if (!string.Equals(procId, Process.SRS_COATING) && !string.Equals(procId, Process.SRS_SLITTING))
            {
                decimal prodQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                decimal eqptEndQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "EQPT_END_QTY"));

                if (Math.Abs((prodQty - eqptEndQty)) >= 30)
                    topInfo = MessageDic.Instance.GetMessage("SFU3468", txtUnit.Text);  // 설비 양품량과 생산량 차이가 30M이상입니다.\n실물 수량이 정말 맞습니까?
            }

            // LANE수 정보 표시 (믹서는 이전 확정 수량 VALIDATION)
            string addMessage = string.Empty;

            // 설비 LOSS 체크
            DataTable dtEqpLossInfo = Util.Get_EqpLossInfo(Util.NVC(EQUIPMENT_COMBO.SelectedValue), procId);

            if (dtEqpLossInfo != null && dtEqpLossInfo.Rows.Count > 0)
            {
                int iLossCnt = Util.NVC_Int(dtEqpLossInfo.Rows[0]["CNT"]);

                if (iLossCnt > 0)
                {
                    string sInfo = string.Empty;
                    string sLossInfo = string.Empty;

                    for (int iCnt = 0; iCnt < dtEqpLossInfo.Rows.Count; iCnt++)
                    {
                        sInfo = dtEqpLossInfo.Rows[iCnt]["JOBDATE"].ToString() + " : " + dtEqpLossInfo.Rows[iCnt]["NOINPUT_CNT"].ToString();
                        sLossInfo = sLossInfo + "\n" + sInfo;
                    }
                    addMessage = MessageDic.Instance.GetMessage("SFU3501", new object[] { sLossInfo });
                }
            }

            if (procId.Equals(Process.PRE_MIXING) || procId.Equals(Process.MIXING) || procId.Equals(Process.SRS_MIXING))
            {
                DataTable dt = GetMixerPreData();
                if ( dt.Rows.Count > 0 )
                {
                    decimal goodQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                    decimal mixOutQty = string.IsNullOrEmpty(Util.NVC(dt.Rows[0]["WIPQTY_ED"])) ? 0 : Util.NVC_Decimal(dt.Rows[0]["WIPQTY_ED"]);

                    if (Math.Abs(goodQty - mixOutQty) > 10)
                    {
                        if (string.IsNullOrEmpty(addMessage))
                            addMessage = MessageDic.Instance.GetMessage("SFU3602", Util.NVC(dt.Rows[0]["LOTID"])); // 이전 확정 생산LOT[%1]의 수량보다 ±10KG 초과하였습니다.
                        else
                            addMessage += "\n" + MessageDic.Instance.GetMessage("SFU3602", Util.NVC(dt.Rows[0]["LOTID"])); // 이전 확정 생산LOT[%1]의 수량보다 ±10KG 초과하였습니다.
                    }
                }
            }
            else
            {
                if (ValidLaneWrongQty() == false)
                {
                    if (string.IsNullOrEmpty(addMessage))
                        addMessage = MessageDic.Instance.GetMessage("SFU3470"); // 알림 : 현재 LANE수가 1입니다.
                    else
                        addMessage += "\n" + MessageDic.Instance.GetMessage("SFU3470"); // 알림 : 현재 LANE수가 1입니다.
                }

                // 단면코터에 한해서는 이상 있는 부분에 대해서는 추가 인폼 추가 [2017-09-19] ==> 소형 1동 투입자재 엉망으로 하는 문제로 인하여 구현
                if (string.Equals(procId, Process.COATING) && isSingleCoater == true && string.Equals(COATTYPE_COMBO.SelectedValue, "T"))
                {
                    // 단면 TOP에 FOIL 자재로 LOT이 존재하면 안됨
                    string sLot = string.Empty;
                    DataTable inputValid = GetBackCoaterInputMaterialValid(_LOTID, Util.NVC(COATTYPE_COMBO.SelectedValue));
                    if (inputValid != null && inputValid.Rows.Count > 0)
                    {
                        foreach (DataRow row in inputValid.Rows)
                            sLot += Util.NVC(row["INPUT_LOTID"]) + ",";

                        addMessage += string.IsNullOrEmpty(addMessage) ? MessageDic.Instance.GetMessage("SFU4118", string.IsNullOrEmpty(sLot) ? sLot : sLot.Substring(0, (sLot.Length - 1)))
                            : "\n" + MessageDic.Instance.GetMessage("SFU4118", string.IsNullOrEmpty(sLot) ? sLot : sLot.Substring(0, (sLot.Length - 1)));   //해당 Top코터에서는 Top Lot[%1]을 Core에 장착 할 수 없습니다. 투입자재 탭에서 투입된 Foil삭제 후 수동으로 추가 바랍니다.
                    }
                }
                else if (string.Equals(procId, Process.COATING) && isSingleCoater == true && string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                {
                    // 단면 BACK에 TOP LOT이 하나도 존재하지 않음면 안됨
                    DataTable inputValid = GetBackCoaterInputMaterialValid(_LOTID, Util.NVC(COATTYPE_COMBO.SelectedValue));
                    if (inputValid == null || inputValid.Rows.Count == 0)
                        addMessage += string.IsNullOrEmpty(addMessage) ? MessageDic.Instance.GetMessage("SFU4119") : "\n" + MessageDic.Instance.GetMessage("SFU4119");  //해당 Back코터에서 투입처리 된 Top Lot이 없습니다. 투입자재 탭에서 수동으로 사용하실 Top Lot를 저장하시고 진행 바랍니다.

                    // 첫 번째 CUT일 경우 TOP LOT의 버전과 비교하여 INFORM 처리 [2018-05-24]
                    string sCutNo = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "CUT"));
                    if (inputValid != null && inputValid.Rows.Count > 0 && string.Equals(sCutNo, "1"))
                    {
                        foreach(DataRow inputRow in inputValid.Rows )
                        {
                            if (!string.Equals(txtVersion.Text, Util.NVC(inputRow["PROD_VER_CODE"])))
                            {
                                addMessage += string.IsNullOrEmpty(addMessage) ? MessageDic.Instance.GetMessage("SFU4936", new object[] { Util.NVC(inputRow["INPUT_LOTID"]), Util.NVC(inputRow["PROD_VER_CODE"]), txtVersion.Text }) : 
                                    "\n" + MessageDic.Instance.GetMessage("SFU4936", new object[] { Util.NVC(inputRow["INPUT_LOTID"]), Util.NVC(inputRow["PROD_VER_CODE"]), txtVersion.Text });  //투입된 Top Lot[%1]의 버전정보[%2]가 실적확정 할 버전[%3]과 다르니 확인하시고 실적확정 하시기 바랍니다.
                                break;
                            }
                        }
                    }

                }
                else if ( string.Equals(procId, Process.HALF_SLITTING))
                {
                    // H/S공정 설비양품량 > 확정양품량 일 경우 인폼 추가 [2018-01-17]
                    double eqptQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "EQPT_END_QTY"));
                    double goodQty = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                    if (eqptQty > 0 && eqptQty > goodQty)
                        addMessage += string.IsNullOrEmpty(addMessage) ? MessageDic.Instance.GetMessage("SFU4474", new object[] { eqptQty, goodQty }) : "\n" + MessageDic.Instance.GetMessage("SFU4474", new object[] { eqptQty, goodQty });  //설비수량[%1]이 양품량[%2]보다 많습니다. 불량/LOSS수량등 입력되지 않았는지 확인 바랍니다.
                }
            }

            // REMARK 필요 정보 취합 [2017-05-24]
            Dictionary<string, string> remarkInfo = GetRemarkConvert();
            if (remarkInfo.Count == 0)
            {
                Util.MessageValidation("SFU3484"); // 특이사항 정보를 확인 바랍니다.
                return;
            }

            // HOLD 특이사항 정보 취합 [2019-04-24]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            Dictionary<string, string> postremarkInfo = GetPostRemarkConvert();
            if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) )
            {
                // 2022-12-29 오화백 EP 동 추가
                if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                {
                    if (postremarkInfo.Count == 0)
                    {
                        Util.MessageValidation("SFU3484"); // 특이사항 정보를 확인 바랍니다.
                        return;
                    }
                }
            }
            
            // COATER BACK을 포함한 COATER 이후 공정은 해당 로직 적용 ( 2017-01-17 ) CR-16
            Dictionary<int, string> finalCutInfo = null;
            if (isCoaterAfterProcess)
            {
                finalCutInfo = CheckFinalCutLot();
                if (bool.Parse(finalCutInfo[0]) == false)
                    return;
            }

            if (procId.Equals(Process.PRE_MIXING))
            {
                //실적 확정 하시겠습니까?
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1706"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                {
                    if (vResult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inDataTable.Columns.Add("SHIFT", typeof(string));
                        inDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inDataTable.Columns.Add("MILL_COUNT", typeof(Int32));
                        inDataTable.Columns.Add("USERID", typeof(string));
                        inDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inDataRow = null;

                        inDataRow = inDataTable.NewRow();
                        inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inDataRow["EQPTID"] = _EQPTID;
                        inDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inDataRow["SHIFT"] = txtShift.Tag;
                        //inDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        //inDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        inDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        inDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inDataRow["MILL_COUNT"] = Util.NVC_Int(txtBeadMillCount.Value);
                        inDataRow["USERID"] = LoginInfo.USERID;
                        //inDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);
                        inDataTable.Rows.Add(inDataRow);

                        DataRow inLotDataRow = null;

                        DataTable InLotdataTable = inDataSet.Tables.Add("INLOT");
                        InLotdataTable.Columns.Add("LOTID", typeof(string));
                        InLotdataTable.Columns.Add("INPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("OUTPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("RESNQTY", typeof(decimal));

                        inLotDataRow = InLotdataTable.NewRow();
                        inLotDataRow["LOTID"] = _LOTID;
                        inLotDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        inLotDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                        InLotdataTable.Rows.Add(inLotDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_PM";
                        string inDataTableName = "INDATA,INLOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)

                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_PM", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }
                    }
                }
                , false, false, topInfo);
            }
            else if (procId.Equals(Process.MIXING))
            {
                //실적 확정 하시겠습니까?
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1706"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                {
                    if (vResult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inDataTable.Columns.Add("SHIFT", typeof(string));
                        inDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inDataTable.Columns.Add("USERID", typeof(string));
                        inDataTable.Columns.Add("CALDATE", typeof(DateTime));
                        inDataTable.Columns.Add("LAST_FLAG", typeof(string));     // 서은석 차장님 요청으로 BATCH 자동 연계를 위하여 마지막 BATCH추가 [2018-09-06]

                        DataRow inDataRow = null;

                        inDataRow = inDataTable.NewRow();
                        inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inDataRow["EQPTID"] = _EQPTID;
                        inDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inDataRow["SHIFT"] = txtShift.Tag;
                        //inDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        //inDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        inDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        inDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inDataRow["USERID"] = LoginInfo.USERID;
                        //inDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);
                        inDataRow["LAST_FLAG"] = isLastBatch == true ? "Y" : "N";

                        inDataTable.Rows.Add(inDataRow);

                        DataRow inLotDataRow = null;

                        DataTable InLotdataTable = inDataSet.Tables.Add("INLOT");
                        InLotdataTable.Columns.Add("LOTID", typeof(string));
                        InLotdataTable.Columns.Add("INPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("OUTPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("RESNQTY", typeof(decimal));

                        inLotDataRow = InLotdataTable.NewRow();
                        inLotDataRow["LOTID"] = _LOTID;
                        inLotDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        inLotDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                        InLotdataTable.Rows.Add(inLotDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_MX";
                        string inDataTableName = "INDATA,INLOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)

                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_MX", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }
                    }
                }, false, false, topInfo);
            }
            else if (procId.Equals(Process.SRS_MIXING))
            {
                //실적 확정 하시겠습니까?
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("SFU1706"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                {
                    if (vResult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inDataTable.Columns.Add("SHIFT", typeof(string));
                        inDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inDataTable.Columns.Add("USERID", typeof(string));
                        inDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inDataRow = null;

                        inDataRow = inDataTable.NewRow();
                        inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inDataRow["EQPTID"] = _EQPTID;
                        inDataRow["PROD_VER_CODE"] = Util.NVC(txtVersion.Text);
                        inDataRow["SHIFT"] = txtShift.Tag;
                        //inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        //inDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        inDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        inDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inDataRow["USERID"] = LoginInfo.USERID;
                        //inDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inDataTable.Rows.Add(inDataRow);

                        DataRow inLotDataRow = null;

                        DataTable InLotdataTable = inDataSet.Tables.Add("INLOT");
                        InLotdataTable.Columns.Add("LOTID", typeof(string));
                        InLotdataTable.Columns.Add("INPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("OUTPUTQTY", typeof(decimal));
                        InLotdataTable.Columns.Add("RESNQTY", typeof(decimal));

                        inLotDataRow = InLotdataTable.NewRow();
                        inLotDataRow["LOTID"] = _LOTID;
                        inLotDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        inLotDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                        InLotdataTable.Rows.Add(inLotDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_SX";
                        string inDataTableName = "INDATA,INLOT";

                        // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                        // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                        if (isRollDirCtn)
                            SetWipAttrRollDir();

                        new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                        {
                            if (ex != null)
                            {
                                //Util.AlertByBiz("BR_PRD_REG_END_LOT_SX", ex.Message, ex.ToString());
                                Util.MessageException(ex);
                                return;
                            }
                            isConfirm = true;
                            REFRESH = true;

                        }, inDataSet);
                    }
                }, false, false, topInfo);
            }
            else if (procId.Equals(Process.COATING))
            {
                if (isSingleCoater)
                {
                    string ListData = string.Empty;

                    //실적확정 FIFO : 이전 Cut 장비완료 Validation 
                    DataTable inTable = new DataTable();
                    inTable = new DataTable();
                    inTable.Columns.Add("LOTID", typeof(string));

                    DataRow indata = inTable.NewRow();
                    indata = inTable.NewRow();
                    indata["LOTID"] = _LOTID;
                    inTable.Rows.Add(indata);

                    DataTable Fifodt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPTEND_LOT_CT", "INDATA", "RSLTDT", inTable);

                    if (Fifodt.Rows.Count > 0)
                    {
                        if (!Fifodt.Rows[0]["LOTID"].ToString().Equals(_LOTID))
                        {
                            Util.MessageValidation("SFU2046", new object[] { Fifodt.Rows[0]["LOTID"].ToString() });
                            return;
                        }
                    }

                    // 단면코터 BACK은 공통 CONFIRM 분기 ( 2017-01-17 )
                    if (string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                    {
                        string _ValueToMessage = string.Empty;

                        if (chkFinalCut.IsChecked.Value)
                        {
                            inTable = new DataTable();
                            inTable.Columns.Add("LOTID", typeof(string));

                            indata = inTable.NewRow();
                            indata["LOTID"] = _LOTID;
                            inTable.Rows.Add(indata);

                            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CHILDLOT_LIST", "INDATA", "RSLTDT", inTable);

                            if (dt.Rows.Count > 0)
                            {
                                for (int i = 0; i < dt.Rows.Count; ++i)
                                    if (i == 0)
                                        ListData = string.Concat(ListData, " ", dt.Rows[i]["LOTID"].ToString());
                                    else
                                        ListData = string.Concat(ListData, ", ", dt.Rows[i]["LOTID"].ToString());
                            }

                            _ValueToMessage = MessageDic.Instance.GetMessage("SFU2043", new object[] { _LOTID });    //확정 하려는{0} LOT은 FINAL CUT 입니다.\r\n확정 하시면 대랏은 종결처리되며, LOT 추가/삭제는 불가합니다.\r\n저장 하시겠습니까?
                        }
                        else
                        {
                            _ValueToMessage = MessageDic.Instance.GetMessage("SFU1241");    //저장하시겠습니까?
                        }

                        LGC.GMES.MES.ControlsLibrary.MessageBox.Show(_ValueToMessage, addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                        //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult, isHold) =>
                        {
                            if (vResult == MessageBoxResult.OK)
                            {
                                #region CONFIRM MESSAGE
                                // 자동 Loss 처리 여부
                                /*
                                if (bool.Parse(finalCutInfo[2]) == true)
                                {
                                    if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                        return;

                                    SaveDefect(WIPREASON_GRID);

                                    if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                                    {
                                        if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                            return;

                                        SaveDefect(WIPREASON2_GRID);
                                    }
                                    isChangeWipReason = false;
                                }
                                */

                                //실적확정
                                DataSet inDataSet = null;
                                inDataSet = new DataSet();

                                DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");

                                inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                                inLotDataTable.Columns.Add("IFMODE", typeof(string));
                                inLotDataTable.Columns.Add("EQPTID", typeof(string));
                                inLotDataTable.Columns.Add("LOTID", typeof(string));
                                inLotDataTable.Columns.Add("INPUTQTY", typeof(string));
                                inLotDataTable.Columns.Add("OUTPUTQTY", typeof(string));
                                inLotDataTable.Columns.Add("RESNQTY", typeof(string));
                                inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                                inLotDataTable.Columns.Add("SHIFT", typeof(string));
                                inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                                inLotDataTable.Columns.Add("WIPNOTE", typeof(string));
                                inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                                inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                                inLotDataTable.Columns.Add("LAST_FLAG", typeof(string));
                                inLotDataTable.Columns.Add("COAT_SIDE_TYPE", typeof(string));
                                inLotDataTable.Columns.Add("USERID", typeof(string));
                                inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                                inLotDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                                inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                                DataRow inLotDataRow = null;
                                inLotDataRow = inLotDataTable.NewRow();
                                inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                                inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                                inLotDataRow["EQPTID"] = _EQPTID;
                                inLotDataRow["LOTID"] = _LOTID;
                                inLotDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                                inLotDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                                inLotDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                                inLotDataRow["PROD_VER_CODE"] = Util.NVC(txtVersion.Text);
                                inLotDataRow["SHIFT"] = Util.NVC(txtShift.Tag);
                                //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                                //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                                inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                                //inLotDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                                inLotDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                                inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text);
                                inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag);
                                //inLotDataRow["LAST_FLAG"] = bool.Parse(finalCutInfo[1]) == true ? "Y" : "N";    // FINAL CUT 여부 (이거는 다른거랑 반대라 이렇게 처리함)
                                inLotDataRow["LAST_FLAG"] = chkFinalCut.IsChecked.Value == true ? "Y" : "N";
                                inLotDataRow["COAT_SIDE_TYPE"] = COATTYPE_COMBO.SelectedValue;
                                inLotDataRow["USERID"] = LoginInfo.USERID;
                                inLotDataRow["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                                inLotDataRow["LANE_QTY"] = txtLaneQty.Value;
                                //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                                inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                                /*
                                if (isHold == true)  // HOLD_YN필수값 확인
                                {
                                }
                                */

                                inLotDataTable.Rows.Add(inLotDataRow);

                                /*
                                DataTable input = inDataSet.Tables.Add("IN_INPUT");
                                input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                                input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                                input.Columns.Add("INPUT_LOTID", typeof(string));

                                DataTable dtCoater = GetCurrentMount(_EQPTID);

                                int iIdx = 0;
                                foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'"))
                                {
                                    if (iIdx == 0)
                                    {
                                        Grid coreGrid = txtCore1.Parent as Grid;
                                        if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtCore1.Text;

                                            if (string.IsNullOrEmpty(txtCore1.Text))
                                            {
                                                Util.MessageValidation("SFU2987", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                    else if (iIdx == 1)
                                    {
                                        Grid coreGrid = txtCore2.Parent as Grid;
                                        if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtCore2.Text;

                                            if (string.IsNullOrEmpty(txtCore2.Text))
                                            {
                                                Util.MessageValidation("SFU2987", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                }

                                if (iIdx == 0)
                                {
                                    Util.MessageValidation("SFU1831");
                                    return;
                                }

                                iIdx = 0;
                                foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE = 'ASL'"))
                                {
                                    if (iIdx == 0)
                                    {
                                        if (txtSlurry1.Visibility == Visibility.Visible)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtSlurry1.Text;

                                            if (string.IsNullOrEmpty(txtSlurry1.Text))
                                            {
                                                Util.MessageValidation("SFU2988", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                    else if (iIdx == 1)
                                    {
                                        if (txtSlurry2.Visibility == Visibility.Visible)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtSlurry2.Text;

                                            if (string.IsNullOrEmpty(txtSlurry2.Text))
                                            {
                                                Util.MessageValidation("SFU2988", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                }

                                if (iIdx == 0)
                                {
                                    Util.MessageValidation("SFU1831");
                                    return;
                                }
                                */
                                #endregion

                                string bizRuleName = "BR_PRD_REG_END_LOT_CT_SINGLE";
                                string inDataTableName = "INDATA, ";

                                DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                                if (dtPermitRateOverData.Rows.Count > 0)
                                {
                                    SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                                }
                                else
                                {
                                    // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                                    // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                                    if (isRollDirCtn)
                                        SetWipAttrRollDir();

                                    new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, searchException) =>
                                    {
                                        if (searchException != null)
                                        {
                                            //Util.AlertByBiz("BR_PRD_REG_END_LOT_CT_SINGLE", searchException.Message, searchException.ToString());
                                            Util.MessageException(searchException);
                                            return;
                                        }
                                        isConfirm = true;
                                        isSlurryPopup = true;
                                        REFRESH = true;

                                    }, inDataSet);
                                }
                            }
                        }, false, false, topInfo);
                        //}, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
                    } // end of if (string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                    else
                    {
                        string _ValueToMessage = string.Empty;

                        if (chkFinalCut.IsChecked.Value)
                        {
                            inTable = new DataTable();
                            inTable.Columns.Add("LOTID", typeof(string));

                            indata = inTable.NewRow();
                            indata["LOTID"] = _LOTID;
                            inTable.Rows.Add(indata);

                            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CHILDLOT_LIST", "INDATA", "RSLTDT", inTable);

                            if (dt.Rows.Count > 0)
                            {
                                for (int i = 0; i < dt.Rows.Count; ++i)
                                    if (i == 0)
                                        ListData = string.Concat(ListData, " ", dt.Rows[i]["LOTID"].ToString());
                                    else
                                        ListData = string.Concat(ListData, ", ", dt.Rows[i]["LOTID"].ToString());
                            }

                            _ValueToMessage = MessageDic.Instance.GetMessage("SFU2043", new object[] { _LOTID });    //확정 하려는{0} LOT은 FINAL CUT 입니다.\r\n확정 하시면 대랏은 종결처리되며, LOT 추가/삭제는 불가합니다.\r\n저장 하시겠습니까?
                        }
                        else
                        {
                            _ValueToMessage = MessageDic.Instance.GetMessage("SFU1241");    //저장하시겠습니까?
                        }

                        LGC.GMES.MES.ControlsLibrary.MessageBox.Show(_ValueToMessage, addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                        {
                            if (vResult == MessageBoxResult.OK)
                            {
                                #region CONFIRM MESSAGE
                                //실적확정
                                DataSet inDataSet = null;
                                inDataSet = new DataSet();

                                DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                                inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                                inLotDataTable.Columns.Add("IFMODE", typeof(string));
                                inLotDataTable.Columns.Add("EQPTID", typeof(string));
                                inLotDataTable.Columns.Add("LOTID", typeof(string));
                                inLotDataTable.Columns.Add("INPUTQTY", typeof(string));
                                inLotDataTable.Columns.Add("OUTPUTQTY", typeof(string));
                                inLotDataTable.Columns.Add("RESNQTY", typeof(string));
                                inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                                inLotDataTable.Columns.Add("SHIFT", typeof(string));
                                inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                                inLotDataTable.Columns.Add("WIPNOTE", typeof(string));
                                inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                                inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                                inLotDataTable.Columns.Add("LAST_FLAG", typeof(string));
                                inLotDataTable.Columns.Add("COAT_SIDE_TYPE", typeof(string));
                                inLotDataTable.Columns.Add("USERID", typeof(string));
                                inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                                inLotDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                                inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                                indata = inLotDataTable.NewRow();
                                indata["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                                indata["IFMODE"] = IFMODE.IFMODE_OFF;
                                indata["EQPTID"] = _EQPTID;
                                indata["LOTID"] = _LOTID;
                                indata["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                                indata["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                                indata["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                                indata["PROD_VER_CODE"] = Util.NVC(txtVersion.Text);
                                indata["SHIFT"] = Util.NVC(txtShift.Tag);
                                //indata["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                                //indata["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                                indata["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                                //indata["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                                indata["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                                indata["WRK_USER_NAME"] = Util.NVC(txtWorker.Text);
                                indata["WRK_USERID"] = Util.NVC(txtWorker.Tag);
                                indata["LAST_FLAG"] = chkFinalCut.IsChecked.Value == true ? "Y" : "N";
                                indata["COAT_SIDE_TYPE"] = COATTYPE_COMBO.SelectedValue;
                                indata["USERID"] = LoginInfo.USERID;
                                indata["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                                indata["LANE_QTY"] = txtLaneQty.Value;
                                //indata["CALDATE"] = dtpWorkDate.DateTime;
                                indata["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                                inLotDataTable.Rows.Add(indata);

                                /*
                                DataTable input = inDataSet.Tables.Add("IN_INPUT");
                                input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                                input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                                input.Columns.Add("INPUT_LOTID", typeof(string));

                                DataTable dtCoater = GetCurrentMount(_EQPTID);

                                int iIdx = 0;
                                foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'"))
                                {
                                    if (iIdx == 0)
                                    {
                                        Grid coreGrid = txtCore1.Parent as Grid;
                                        if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtCore1.Text;

                                            if (string.IsNullOrEmpty(txtCore1.Text))
                                            {
                                                Util.MessageValidation("SFU2987", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                    else if (iIdx == 1)
                                    {
                                        Grid coreGrid = txtCore2.Parent as Grid;
                                        if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtCore2.Text;

                                            if (string.IsNullOrEmpty(txtCore2.Text))
                                            {
                                                Util.MessageValidation("SFU2987", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                }

                                if (iIdx == 0)
                                {
                                    Util.MessageValidation("SFU1831");
                                    return;
                                }

                                iIdx = 0;
                                foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE = 'ASL'"))
                                {
                                    if (iIdx == 0)
                                    {
                                        if (txtSlurry1.Visibility == Visibility.Visible)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtSlurry1.Text;

                                            if (string.IsNullOrEmpty(txtSlurry1.Text))
                                            {
                                                Util.MessageValidation("SFU2988", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                    else if (iIdx == 1)
                                    {
                                        if (txtSlurry2.Visibility == Visibility.Visible)
                                        {
                                            DataRow inInputRow = inInputRow = input.NewRow();
                                            inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                            inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                            inInputRow["INPUT_LOTID"] = txtSlurry2.Text;

                                            if (string.IsNullOrEmpty(txtSlurry2.Text))
                                            {
                                                Util.MessageValidation("SFU2988", _EQPTID);
                                                return;
                                            }
                                            input.Rows.Add(inInputRow);
                                        }
                                        iIdx++;
                                    }
                                }

                                if (iIdx == 0)
                                {
                                    Util.MessageValidation("SFU1831");
                                    return;
                                }
                                */
                                #endregion

                                string bizRuleName = "BR_PRD_REG_END_LOT_CT_SINGLE";
                                string inDataTableName = "INDATA";

                                DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                                if (dtPermitRateOverData.Rows.Count > 0)
                                {
                                    SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                                }
                                else
                                {
                                    // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                                    // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                                    if (isRollDirCtn)
                                        SetWipAttrRollDir();

                                    new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, searchException) =>
                                    {
                                        if (searchException != null)
                                        {
                                            Util.MessageException(searchException);
                                            //Util.AlertByBiz("BR_PRD_REG_END_LOT_CT_SINGLE", searchException.Message, searchException.ToString());
                                            return;
                                        }
                                        isConfirm = true;
                                        isSlurryPopup = true;
                                        REFRESH = true;

                                    }, inDataSet);
                                }
                            }
                        }, false, false, topInfo);
                    }
                } // end of if (isSingleCoater)
                else
                {
                    string ListData = string.Empty;

                    //실적확정 FIFO : 이전 Cut 장비완료 Validation 
                    DataTable inTable = new DataTable();
                    inTable = new DataTable();
                    inTable.Columns.Add("LOTID", typeof(string));

                    DataRow indata = inTable.NewRow();
                    indata = inTable.NewRow();
                    indata["LOTID"] = _LOTID;
                    inTable.Rows.Add(indata);

                    DataTable Fifodt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPTEND_LOT_CT", "INDATA", "RSLTDT", inTable);

                    if (Fifodt.Rows.Count > 0)
                    {
                        if (!Fifodt.Rows[0]["LOTID"].ToString().Equals(_LOTID))
                        {
                            Util.MessageValidation("SFU2046", new object[] { Fifodt.Rows[0]["LOTID"].ToString() });
                            return;
                        }
                    }

                    string _ValueToMessage = string.Empty;

                    if (chkFinalCut.IsChecked.Value)
                    {
                        inTable = new DataTable();
                        inTable.Columns.Add("LOTID", typeof(string));

                        indata = inTable.NewRow();
                        indata["LOTID"] = _LOTID;
                        inTable.Rows.Add(indata);

                        DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CHILDLOT_LIST", "INDATA", "RSLTDT", inTable);

                        if (dt.Rows.Count > 0)
                        {
                            for (int i = 0; i < dt.Rows.Count; ++i)
                                if (i == 0)
                                    ListData = string.Concat(ListData, " ", dt.Rows[i]["LOTID"].ToString());
                                else
                                    ListData = string.Concat(ListData, ", ", dt.Rows[i]["LOTID"].ToString());
                        }

                        _ValueToMessage = MessageDic.Instance.GetMessage("SFU2043", new object[] { _LOTID });    //확정 하려는{0} LOT은 FINAL CUT 입니다.\r\n확정 하시면 대랏은 종결처리되며, LOT 추가/삭제는 불가합니다.\r\n저장 하시겠습니까?
                    }
                    else
                    {
                        _ValueToMessage = MessageDic.Instance.GetMessage("SFU1241");    //저장하시겠습니까?
                    }

                    LGC.GMES.MES.ControlsLibrary.MessageBox.Show(_ValueToMessage, addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (vResult) =>
                    {
                        if (vResult == MessageBoxResult.OK)
                        {
                            #region CONFIRM MESSAGE
                            //실적확정
                            DataSet inDataSet = null;
                            inDataSet = new DataSet();

                            DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                            inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                            inLotDataTable.Columns.Add("IFMODE", typeof(string));
                            inLotDataTable.Columns.Add("EQPTID", typeof(string));
                            inLotDataTable.Columns.Add("LOTID", typeof(string));
                            inLotDataTable.Columns.Add("INPUTQTY", typeof(string));
                            inLotDataTable.Columns.Add("OUTPUTQTY", typeof(string));
                            inLotDataTable.Columns.Add("RESNQTY", typeof(string));
                            inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                            inLotDataTable.Columns.Add("SHIFT", typeof(string));
                            inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                            inLotDataTable.Columns.Add("WIPNOTE", typeof(string));
                            inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                            inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                            inLotDataTable.Columns.Add("USERID", typeof(string));
                            inLotDataTable.Columns.Add("LAST_FLAG", typeof(string));
                            inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                            inLotDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                            inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));
                            inLotDataTable.Columns.Add("HOLD_YN", typeof(string));

                            indata = inLotDataTable.NewRow();
                            indata["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                            indata["IFMODE"] = IFMODE.IFMODE_OFF;
                            indata["EQPTID"] = _EQPTID;
                            indata["LOTID"] = _LOTID;
                            indata["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                            indata["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                            indata["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                            indata["PROD_VER_CODE"] = Util.NVC(txtVersion.Text);
                            indata["SHIFT"] = Util.NVC(txtShift.Tag);
                            //indata["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                            //indata["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                            indata["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                            //indata["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                            indata["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                            indata["LAST_FLAG"] = chkFinalCut.IsChecked.Value == true ? "Y" : "N";
                            indata["WRK_USER_NAME"] = Util.NVC(txtWorker.Text);
                            indata["WRK_USERID"] = Util.NVC(txtWorker.Tag);
                            indata["USERID"] = LoginInfo.USERID;
                            indata["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                            indata["LANE_QTY"] = txtLaneQty.Value;
                            //indata["CALDATE"] = dtpWorkDate.DateTime;
                            indata["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);
                            indata["HOLD_YN"] = _IS_POSTING_HOLD;

                            inLotDataTable.Rows.Add(indata);

                            DataTable inInputDataTable = inDataSet.Tables.Add("IN_INPUT");
                            inInputDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            inInputDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                            inInputDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                            DataTable inRollQtyDataTable = inDataSet.Tables.Add("IN_ROLLQTY");
                            inRollQtyDataTable.Columns.Add("INQTY",typeof(string));
                            inRollQtyDataTable.Columns.Add("OUTQTY", typeof(string));
                            inRollQtyDataTable.Columns.Add("PROTECT_FILM_TYPE_CODE", typeof(string));
                            inRollQtyDataTable.Columns.Add("THIRDQTY", typeof(string));
                            /*
                            DataTable input = inDataSet.Tables.Add("IN_INPUT");
                            input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                            input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                            input.Columns.Add("INPUT_LOTID", typeof(string));

                            DataTable dtCoater = GetCurrentMount(_EQPTID);

                            int iIdx = 0;
                            foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'"))
                            {
                                if (iIdx == 0)
                                {
                                    Grid coreGrid = txtCore1.Parent as Grid;
                                    if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                    {
                                        DataRow inInputRow = inInputRow = input.NewRow();
                                        inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                        inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                        inInputRow["INPUT_LOTID"] = txtCore1.Text;

                                        if ( string.IsNullOrEmpty(txtCore1.Text))
                                        {
                                            Util.MessageValidation("SFU2987", _EQPTID);
                                            return;
                                        }
                                        input.Rows.Add(inInputRow);
                                    }
                                    iIdx++;
                                }
                                else if (iIdx == 1)
                                {
                                    Grid coreGrid = txtCore2.Parent as Grid;
                                    if (((RadioButton)coreGrid.Children[coreGrid.Children.Count - 1]).IsChecked == true)
                                    {
                                        DataRow inInputRow = inInputRow = input.NewRow();
                                        inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                        inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                        inInputRow["INPUT_LOTID"] = txtCore2.Text;

                                        if (string.IsNullOrEmpty(txtCore2.Text))
                                        {
                                            Util.MessageValidation("SFU2987", _EQPTID);
                                            return;
                                        }
                                        input.Rows.Add(inInputRow);
                                    }
                                    iIdx++;
                                }
                            }

                            if (iIdx == 0)
                            {
                                Util.MessageValidation("SFU1831");
                                return;
                            }

                            iIdx = 0;
                            foreach (DataRow _iRow in dtCoater.Select("PRDT_CLSS_CODE = 'ASL'"))
                            {
                                if (iIdx == 0)
                                {
                                    if (txtSlurry1.Visibility == Visibility.Visible)
                                    {
                                        DataRow inInputRow = inInputRow = input.NewRow();
                                        inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                        inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                        inInputRow["INPUT_LOTID"] = txtSlurry1.Text;

                                        if (string.IsNullOrEmpty(txtSlurry1.Text))
                                        {
                                            Util.MessageValidation("SFU2988", _EQPTID);
                                            return;
                                        }
                                        input.Rows.Add(inInputRow);
                                    }
                                    iIdx++;
                                }
                                else if (iIdx == 1)
                                {
                                    if (txtSlurry2.Visibility == Visibility.Visible)
                                    {
                                        DataRow inInputRow = inInputRow = input.NewRow();
                                        inInputRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(_iRow["EQPT_MOUNT_PSTN_ID"]);
                                        inInputRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                                        inInputRow["INPUT_LOTID"] = txtSlurry2.Text;

                                        if (string.IsNullOrEmpty(txtSlurry2.Text))
                                        {
                                            Util.MessageValidation("SFU2988", _EQPTID);
                                            return;
                                        }
                                        input.Rows.Add(inInputRow);
                                    }
                                    iIdx++;
                                }
                            }

                            if (iIdx == 0)
                            {
                                Util.MessageValidation("SFU1831");
                                return;
                            }
                            */

                            #endregion

                            string bizRuleName = "BR_PRD_REG_END_LOT_CT";
                            string inDataTableName = "INDATA,IN_INPUT,IN_ROLLQTY";

                            DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                            if (dtPermitRateOverData.Rows.Count > 0)
                            {
                                SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                            }
                            else
                            {
                                // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                                // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                                if (isRollDirCtn)
                                    SetWipAttrRollDir();

                                new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, searchException) =>
                                {
                                    if (searchException != null)
                                    {
                                        //Util.AlertByBiz("BR_PRD_REG_END_LOT_CT", searchException.Message, searchException.ToString());
                                        Util.MessageException(searchException);
                                        return;
                                    }
                                    isConfirm = true;
                                    isSlurryPopup = true;
                                    REFRESH = true;
                                }, inDataSet);
                            }
                        }
                    }, false, false, topInfo);
                }
            }
            else if (procId.Equals(Process.SRS_COATING))
            {
                if (string.IsNullOrEmpty(cboPet.Text))
                {
                    Util.MessageValidation("SFU3445");  //보호필름이 선택되지 않았습니다.
                    return;
                }

                if (Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY")) != Convert.ToDouble(Util.NVC_Decimal(txtSrs1Qty.Value) + Util.NVC_Decimal(txtSrs2Qty.Value) + Util.NVC_Decimal(txtSrs3Qty.Value)))
                {
                    Util.MessageValidation("SFU1233");  //양품량과 1st/2nd/3rd 합계 수량이 다릅니다.
                    return;
                }

                if ( string.IsNullOrEmpty(txtBatchId.Text))
                {
                    Util.MessageValidation("SFU1561");  //배치ID가 없습니다.
                    return;
                }


                //실적확인 이전 생산버전 재선택의 경우 LANE, LANE_PTN 재적용***
                //SetDefect(_LOTID);
                //*************************************************************
                string _ValueToMessage = string.Empty;

                //실적확정 FIFO : 이전 Cut 장비완료 Validation 
                DataTable inTable = new DataTable();
                inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow indata = inTable.NewRow();
                indata = inTable.NewRow();
                indata["LOTID"] = _LOTID;
                inTable.Rows.Add(indata);

                DataTable dtFifo = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPTEND_LOT_CT", "INDATA", "RSLTDT", inTable);

                if (dtFifo.Rows.Count > 0)
                {
                    if (dtFifo.Rows[0]["LOTID"].ToString().Equals(_LOTID))
                    {
                        Util.MessageValidation("SFU2046", new object[] { dtFifo.Rows[0]["LOTID"].ToString() });
                        return;
                    }
                }

                if (chkFinalCut.IsChecked.Value)
                {
                    DataTable zinTable = new DataTable();
                    zinTable.Columns.Add("LOTID", typeof(string));

                    DataRow zindata = zinTable.NewRow();
                    zindata["LOTID"] = _LOTID;
                    zinTable.Rows.Add(zindata);

                    DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CHILDLOT_LIST", "INDATA", "RSLTDT", zinTable);

                    if (dt.Rows.Count > 0)
                    {
                        for (int i = 0; i < dt.Rows.Count; ++i)
                            if (i == 0)
                                listData = string.Concat(listData, " ", dt.Rows[i]["LOTID"].ToString());
                            else
                                listData = string.Concat(listData, ", ", dt.Rows[i]["LOTID"].ToString());
                    }

                    _ValueToMessage = MessageDic.Instance.GetMessage("SFU2041", new object[] { _LOTID });    //확정 하려는 {0} LOT은 FINAL CUT 입니다.\r\n확정 하시면 대랏은 종결처리되며, LOT 추가/삭제는 불가합니다.\r\n실적 확정 하시겠습니까?
                }
                else
                {
                    _ValueToMessage = MessageDic.Instance.GetMessage("SFU1706");    //실적 확정 하시겠습니까?
                }

                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(_ValueToMessage, addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        DataSet inDataSet = new DataSet();

                        DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                        inDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inDataTable.Columns.Add("IFMODE", typeof(string));
                        inDataTable.Columns.Add("EQPTID", typeof(string));
                        inDataTable.Columns.Add("LOTID", typeof(string));
                        inDataTable.Columns.Add("INPUTQTY", typeof(string));
                        inDataTable.Columns.Add("OUTPUTQTY", typeof(string));
                        inDataTable.Columns.Add("RESNQTY", typeof(string));
                        inDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inDataTable.Columns.Add("SHIFT", typeof(string));
                        inDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inDataTable.Columns.Add("USERID", typeof(string));
                        inDataTable.Columns.Add("LAST_FLAG", typeof(string));
                        inDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                        inDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                        inDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inDataTable.Columns.Add("CALDATE", typeof(DateTime));
                        inDataTable.Columns.Add("HOLD_YN", typeof(string));

                        indata = inDataTable.NewRow();
                        indata["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        indata["IFMODE"] = IFMODE.IFMODE_OFF;
                        indata["EQPTID"] = _EQPTID;
                        indata["LOTID"] = _LOTID;
                        indata["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        indata["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        indata["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                        indata["PROD_VER_CODE"] = Util.NVC(txtVersion.Text);
                        indata["SHIFT"] = Util.NVC(txtShift.Tag);
                        //indata["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //indata["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        indata["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        //indata["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        indata["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        indata["LAST_FLAG"] = chkFinalCut.IsChecked.Value == true ? "Y" : "N";
                        indata["USERID"] = LoginInfo.USERID;
                        indata["LANE_PTN_QTY"] = Util.NVC_Decimal(txtLanePatternQty.Value);
                        indata["LANE_QTY"] = Util.NVC_Decimal(txtLaneQty.Value);
                        indata["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        indata["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        //indata["CALDATE"] = dtpWorkDate.DateTime;
                        indata["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);
                        indata["HOLD_YN"] = _IS_POSTING_HOLD;

                        inDataTable.Rows.Add(indata);

                        DataTable mtrlDataTable = inDataSet.Tables.Add("IN_INPUT");
                        mtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        mtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        mtrlDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inDataRow = null;

                        inDataRow = mtrlDataTable.NewRow();
                        inDataRow["EQPT_MOUNT_PSTN_ID"] = "";
                        inDataRow["EQPT_MOUNT_PSTN_STATE"] = "";
                        inDataRow["INPUT_LOTID"] = "";
                        mtrlDataTable.Rows.Add(inDataRow);

                        DataTable sDataTable = inDataSet.Tables.Add("IN_ROLLQTY");
                        sDataTable.Columns.Add("INQTY", typeof(string));
                        sDataTable.Columns.Add("OUTQTY", typeof(string));
                        sDataTable.Columns.Add("PROTECT_FILM_TYPE_CODE", typeof(string));
                        sDataTable.Columns.Add("THIRDQTY", typeof(string));

                        inDataRow = null;

                        inDataRow = sDataTable.NewRow();
                        inDataRow["INQTY"] = Util.NVC(txtSrs1Qty.Value);
                        inDataRow["OUTQTY"] = Util.NVC(txtSrs2Qty.Value);
                        inDataRow["PROTECT_FILM_TYPE_CODE"] = Util.NVC(cboPet.SelectedValue);
                        inDataRow["THIRDQTY"] = Util.NVC(txtSrs3Qty.Value);
                        sDataTable.Rows.Add(inDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_CT";
                        string inDataTableName = "INDATA,IN_INPUT,IN_ROLLQTY";

                        // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                        // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                        if (isRollDirCtn)
                            SetWipAttrRollDir();

                        new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                        {
                            if (ex != null)
                            {
                                //Util.AlertByBiz("BR_PRD_REG_END_LOT_CT", ex.Message, ex.ToString());
                                Util.MessageException(ex);
                                return;
                            }
                            isConfirm = true;
                            REFRESH = true;

                        }, inDataSet);
                    }
                }, false, false, topInfo);
            }
            else if (procId.Equals(Process.HALF_SLITTING))
            {
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult, isHold) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet inDataSet = null;
                        inDataSet = new DataSet();

                        DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                        inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inLotDataTable.Columns.Add("IFMODE", typeof(string));
                        inLotDataTable.Columns.Add("EQPTID", typeof(string));
                        inLotDataTable.Columns.Add("USERID", typeof(string));
                        inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inLotDataTable.Columns.Add("SHIFT", typeof(string));
                        inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inLotDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inLotDataTable.Columns.Add("CUTYN", typeof(string));
                        inLotDataTable.Columns.Add("REMAINQTY", typeof(string));
                        inLotDataTable.Columns.Add("LANE_QTY", typeof(double));
                        inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(double));
                        inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inLotDataRow = null;
                        inLotDataRow = inLotDataTable.NewRow();
                        inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inLotDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                        inLotDataRow["USERID"] = LoginInfo.USERID;
                        inLotDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inLotDataRow["SHIFT"] = txtShift.Tag;
                        //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        //inLotDataRow["WIPNOTE"] = txtWipNote == null ? string.Empty : txtWipNote.Text;
                        //inLotDataRow["CUTYN"] = chkFinalCut.IsChecked.Value == true ? "N" : "Y";
                        //inLotDataRow["REMAINQTY"] = txtRemainQty.Value;

                        inLotDataRow["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부
                        inLotDataRow["REMAINQTY"] = finalCutInfo[6];

                        inLotDataRow["LANE_QTY"] = txtLaneQty.Value;
                        inLotDataRow["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                        //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inLotDataTable.Rows.Add(inLotDataRow);

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        DataTable inPLotDataTable = inDataSet.Tables.Add("IN_INPUT");
                        inPLotDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        inPLotDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        inPLotDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inPLotDataRow = null;
                        inPLotDataRow = inPLotDataTable.NewRow();
                        inPLotDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(EQUIPMENT_COMBO.SelectedValue.ToString());
                        inPLotDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                        inPLotDataRow["INPUT_LOTID"] = _LOTIDPR;
                        inPLotDataTable.Rows.Add(inPLotDataRow);

                        DataTable inLotDetail = inDataSet.Tables.Add("IN_LOT");
                        inLotDetail.Columns.Add("LOTID", typeof(string));
                        inLotDetail.Columns.Add("INPUTQTY", typeof(decimal));
                        inLotDetail.Columns.Add("OUTPUTQTY", typeof(decimal));
                        inLotDetail.Columns.Add("RESNQTY", typeof(decimal));
                        inLotDetail.Columns.Add("WIPNOTE", typeof(string));

                        string sLotID = string.Empty;
                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            DataRow inLotDetailDataRow = null;
                            inLotDetailDataRow = inLotDetail.NewRow();

                            sLotID = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                            inLotDetailDataRow["LOTID"] = sLotID;
                            inLotDetailDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                            inLotDetailDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));
                            inLotDetailDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                            //inLotDetailDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i - 1].DataItem, "REMARK"));
                            inLotDetailDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i - 1].DataItem, "LOTID"))];
                            inLotDetail.Rows.Add(inLotDetailDataRow);
                        }
                        #endregion

                        string bizRuleName = GetEndLotBizRuleName();
                        string inDataTableName = "INDATA,IN_INPUT,IN_LOT,IN_OUTLOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz(GetEndLotBizRuleName(), ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.INS_COATING) || procId.Equals(Process.INS_SLIT_COATING))
            {
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult, isHold) =>
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet inDataSet = null;
                        inDataSet = new DataSet();

                        DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                        inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inLotDataTable.Columns.Add("IFMODE", typeof(string));
                        inLotDataTable.Columns.Add("EQPTID", typeof(string));
                        inLotDataTable.Columns.Add("LOTID", typeof(string));
                        inLotDataTable.Columns.Add("INPUTQTY", typeof(double));
                        inLotDataTable.Columns.Add("OUTPUTQTY", typeof(double));
                        inLotDataTable.Columns.Add("RESNQTY", typeof(double));
                        inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inLotDataTable.Columns.Add("SHIFT", typeof(string));
                        inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inLotDataTable.Columns.Add("WIPNOTE", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inLotDataTable.Columns.Add("COAT_SIDE_TYPE", typeof(string));
                        inLotDataTable.Columns.Add("USERID", typeof(string));
                        inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inLotDataRow = null;
                        inLotDataRow = inLotDataTable.NewRow();
                        inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inLotDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                        inLotDataRow["LOTID"] = DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOTID");
                        inLotDataRow["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDataRow["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        inLotDataRow["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LOSSQTY"));
                        inLotDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inLotDataRow["SHIFT"] = txtShift.Tag;
                        //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        //inLotDataRow["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        inLotDataRow["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inLotDataRow["COAT_SIDE_TYPE"] = COATTYPE_COMBO.SelectedValue;
                        inLotDataRow["USERID"] = LoginInfo.USERID;
                        //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inLotDataTable.Rows.Add(inLotDataRow);

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        DataTable inPLotDataTable = inDataSet.Tables.Add("IN_INPUT");
                        inPLotDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        inPLotDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        inPLotDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inPLotDataRow = null;
                        inPLotDataRow = inPLotDataTable.NewRow();
                        inPLotDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(EQUIPMENT_COMBO.SelectedValue.ToString());
                        inPLotDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                        inPLotDataRow["INPUT_LOTID"] = DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "LOTID").ToString();
                        inPLotDataTable.Rows.Add(inPLotDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_IC";
                        string inDataTableName = "INDATA,IN_INPUT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)

                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_IC", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }

                        
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.ROLL_PRESSING))
            {
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage(sMsg), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result, isHold) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet indataSet = new DataSet();
                        DataTable inData = indataSet.Tables.Add("INDATA");
                        inData.Columns.Add("SRCTYPE", typeof(string));
                        inData.Columns.Add("IFMODE", typeof(string));
                        inData.Columns.Add("EQPTID", typeof(string));
                        inData.Columns.Add("USERID", typeof(string));
                        inData.Columns.Add("PROD_VER_CODE", typeof(string));
                        inData.Columns.Add("SHIFT", typeof(string));
                        inData.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inData.Columns.Add("WRK_USER_NAME", typeof(string));
                        inData.Columns.Add("WRK_USERID", typeof(string));
                        inData.Columns.Add("WIPNOTE", typeof(string));
                        inData.Columns.Add("CUTYN", typeof(string));
                        inData.Columns.Add("REMAINQTY", typeof(string));
                        inData.Columns.Add("REPROC_YN", typeof(string));
                        inData.Columns.Add("LANE_QTY", typeof(string));
                        inData.Columns.Add("LANE_PTN_QTY", typeof(string));
                        inData.Columns.Add("CALDATE", typeof(DateTime));
                        inData.Columns.Add("HOLD_YN", typeof(string));   // # RollMap Hold 처리

                        DataRow row = inData.NewRow();
                        row["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        row["IFMODE"] = "OFF";
                        row["EQPTID"] = _EQPTID;//cboEquipment.SelectedValue.ToString();
                        row["USERID"] = LoginInfo.USERID;
                        row["PROD_VER_CODE"] = txtVersion.Text;
                        row["SHIFT"] = txtShift.Tag;
                        //row["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //row["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        row["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        row["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        row["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        //row["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        //row["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];

                        // 특이사항 저장 오류 수정 [2019-04-24]
                        // 2022-12-29 오화백 EP 동 추가
                        if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                            row["WIPNOTE"] = postremarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        else
                            row["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];

                        //if (txtWipNote != null)
                        //row["WIPNOTE"] = DBNull.Value;
                        //row["CUTYN"] = chkFinalCut.IsChecked.Value == true ? "N" : "Y";
                        //row["REMAINQTY"] = txtRemainQty.Value;
                        row["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부


                        row["REMAINQTY"] = finalCutInfo[6];
                        if (chkExtraPress.IsChecked == true)
                            row["REPROC_YN"] = "Y";
                        else
                            row["REPROC_YN"] = "N";

                        row["LANE_QTY"] = txtLaneQty.Value;
                        row["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                        //row["CALDATE"] = dtpWorkDate.DateTime;
                        row["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);
                        row["HOLD_YN"] = _IS_POSTING_HOLD;   // # RollMap Hold 처리
                        //  row["REPROC_YN"] = cut.Equals("Y") ? "Y" : "N";

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        indataSet.Tables["INDATA"].Rows.Add(row);

                        DataTable input = indataSet.Tables.Add("IN_INPUT");
                        input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        input.Columns.Add("INPUT_LOTID", typeof(string));

                        DataTable eqpt_mount = new DataTable();
                        eqpt_mount.Columns.Add("EQPTID", typeof(string));

                        DataRow eqpt_mount_row = eqpt_mount.NewRow();
                        eqpt_mount_row["EQPTID"] = _EQPTID;
                        eqpt_mount.Rows.Add(eqpt_mount_row);

                        DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                        if (EQPT_PSTN_ID.Rows.Count < 0)
                        {
                            Util.MessageValidation("SFU1398");  //MMD에 설비 투입을 입력해주세요.
                            return;
                        }

                        row = input.NewRow();
                        row["EQPT_MOUNT_PSTN_ID"] = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"];
                        row["EQPT_MOUNT_PSTN_STATE"] = "A";
                        row["INPUT_LOTID"] = DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "LOTID_PR");
                        input.Rows.Add(row);

                        DataTable InLot = indataSet.Tables.Add("INLOT");
                        InLot.Columns.Add("LOTID", typeof(string));
                        InLot.Columns.Add("INPUTQTY", typeof(string));
                        InLot.Columns.Add("OUTPUTQTY", typeof(string));
                        InLot.Columns.Add("RESNQTY", typeof(string));

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            row = InLot.NewRow();
                            row["LOTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                            row["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                            row["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));
                            row["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                            indataSet.Tables["INLOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_RP_UI";
                        string inDataTableName = "INDATA,IN_INPUT,IN_LOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (sResult, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_RP_UI", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, indataSet);
                        }
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.TAPING))
            {
                //if (!ValidateConfirm())
                //    return;

                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result, isHold) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet indataSet = new DataSet();
                        DataTable inData = indataSet.Tables.Add("INDATA");
                        inData.Columns.Add("SRCTYPE", typeof(string));
                        inData.Columns.Add("IFMODE", typeof(string));
                        inData.Columns.Add("EQPTID", typeof(string));
                        inData.Columns.Add("PROD_VER_CODE", typeof(string));
                        inData.Columns.Add("SHIFT", typeof(string));
                        inData.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inData.Columns.Add("WRK_USER_NAME", typeof(string));
                        inData.Columns.Add("WRK_USERID", typeof(string));
                        inData.Columns.Add("WIPNOTE", typeof(string));
                        inData.Columns.Add("USERID", typeof(string));
                        inData.Columns.Add("CUTYN", typeof(string));
                        inData.Columns.Add("REMAINQTY", typeof(string));
                        inData.Columns.Add("LANE_QTY", typeof(string));
                        inData.Columns.Add("LANE_PTN_QTY", typeof(string));
                        inData.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow row = inData.NewRow();
                        row["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        row["IFMODE"] = "OFF";
                        row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                        row["USERID"] = LoginInfo.USERID;
                        row["PROD_VER_CODE"] = txtVersion.Text;
                        row["SHIFT"] = txtShift.Tag;
                        //row["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //row["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        row["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        row["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        row["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        //row["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        row["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        //row["CUTYN"] = chkFinalCut.IsChecked.Value == true ? "N" : "Y";
                        //row["REMAINQTY"] = txtRemainQty.Value;
                        row["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부

                        row["REMAINQTY"] = finalCutInfo[6];

                        row["LANE_QTY"] = txtLaneQty.Value;
                        row["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                        //row["CALDATE"] = dtpWorkDate.DateTime;
                        row["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        indataSet.Tables["INDATA"].Rows.Add(row);

                        DataTable input = indataSet.Tables.Add("IN_INPUT");
                        input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        input.Columns.Add("INPUT_LOTID", typeof(string));

                        DataTable eqpt_mount = new DataTable();
                        eqpt_mount.Columns.Add("EQPTID", typeof(string));

                        DataRow eqpt_mount_row = eqpt_mount.NewRow();
                        eqpt_mount_row["EQPTID"] = _EQPTID;
                        eqpt_mount.Rows.Add(eqpt_mount_row);

                        DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                        if (EQPT_PSTN_ID.Rows.Count < 0)
                        {
                            Util.MessageValidation("SFU1398");  //MMD에 설비 투입을 입력해주세요.
                            return;
                        }

                        row = input.NewRow();
                        row["EQPT_MOUNT_PSTN_ID"] = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"];
                        row["EQPT_MOUNT_PSTN_STATE"] = "A";
                        row["INPUT_LOTID"] = _LOTIDPR;

                        input.Rows.Add(row);

                        DataTable inLot = indataSet.Tables.Add("IN_LOT");
                        inLot.Columns.Add("LOTID", typeof(string));
                        inLot.Columns.Add("INPUTQTY", typeof(string));
                        inLot.Columns.Add("OUTPUTQTY", typeof(string));
                        inLot.Columns.Add("RESNQTY", typeof(string));

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            row = inLot.NewRow();
                            row["LOTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                            row["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                            row["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));
                            row["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                            indataSet.Tables["IN_LOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_TP_UI";
                        string inDataTableName = "INDATA,IN_INPUT,IN_LOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (sResult, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_TP_UI", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, indataSet);
                        }
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
            else if (procId.Equals(Process.REWINDER) || procId.Equals(Process.LASER_ABLATION) || procId.Equals(Process.BACK_WINDER))
            {
                //if (!ValidateConfirm())
                //    return;

                /*
                string sMsg = string.Empty;
                sMsg = "실적 확정 하시겠습니까?";

                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage(sMsg), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) =>
                */
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result, isHold) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet indataSet = new DataSet();
                        DataTable inData = indataSet.Tables.Add("INDATA");
                        inData.Columns.Add("SRCTYPE", typeof(string));
                        inData.Columns.Add("IFMODE", typeof(string));
                        inData.Columns.Add("EQPTID", typeof(string));
                        inData.Columns.Add("PROD_VER_CODE", typeof(string));
                        inData.Columns.Add("SHIFT", typeof(string));
                        inData.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inData.Columns.Add("WRK_USER_NAME", typeof(string));
                        inData.Columns.Add("WRK_USERID", typeof(string));
                        inData.Columns.Add("WIPNOTE", typeof(string));
                        inData.Columns.Add("USERID", typeof(string));
                        inData.Columns.Add("CUTYN", typeof(string));
                        inData.Columns.Add("REMAINQTY", typeof(string));
                        inData.Columns.Add("LANE_QTY", typeof(int));
                        inData.Columns.Add("LANE_PTN_QTY", typeof(int));
                        inData.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow row = inData.NewRow();
                        row["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        row["IFMODE"] = "OFF";
                        row["EQPTID"] = _EQPTID;//cboEquipment.SelectedValue.ToString();
                        row["PROD_VER_CODE"] = txtVersion.Text;
                        row["SHIFT"] = txtShift.Tag;
                        //row["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //row["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        row["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        row["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        row["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        //row["WIPNOTE"] = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK"));
                        row["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        row["USERID"] = LoginInfo.USERID;

                        //row["CUTYN"] = chkFinalCut.IsChecked.Value == true ? "N" : "Y";
                        //row["REMAINQTY"] = txtRemainQty.Value;
                        row["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부

                        row["REMAINQTY"] = finalCutInfo[6];
                        row["LANE_QTY"] = txtLaneQty.Value;
                        row["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                        //row["CALDATE"] = dtpWorkDate.DateTime;
                        row["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        indataSet.Tables["INDATA"].Rows.Add(row);

                        DataTable input = indataSet.Tables.Add("IN_INPUT");
                        input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        input.Columns.Add("INPUT_LOTID", typeof(string));

                        DataTable eqpt_mount = new DataTable();
                        eqpt_mount.Columns.Add("EQPTID", typeof(string));

                        DataRow eqpt_mount_row = eqpt_mount.NewRow();
                        eqpt_mount_row["EQPTID"] = _EQPTID;
                        eqpt_mount.Rows.Add(eqpt_mount_row);

                        DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                        if (EQPT_PSTN_ID.Rows.Count <= 0)
                        {
                            Util.MessageValidation("SFU1398");  //MMD에 설비 투입을 입력해주세요.
                            return;
                        }

                        row = input.NewRow();
                        row["EQPT_MOUNT_PSTN_ID"] = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"];
                        row["EQPT_MOUNT_PSTN_STATE"] = "A";
                        row["INPUT_LOTID"] = _LOTIDPR;
                        input.Rows.Add(row);

                        DataTable InLot = indataSet.Tables.Add("INLOT");
                        InLot.Columns.Add("LOTID", typeof(string));
                        InLot.Columns.Add("INPUTQTY", typeof(string));
                        InLot.Columns.Add("OUTPUTQTY", typeof(string));
                        InLot.Columns.Add("RESNQTY", typeof(string));

                        if ( string.Equals(procId, Process.BACK_WINDER))
                            InLot.Columns.Add("CLCTQTY", typeof(string));

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            row = InLot.NewRow();
                            row["LOTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                            row["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                            row["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));
                            row["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));

                            if (string.Equals(procId, Process.BACK_WINDER))
                            {
                                decimal iTotalTagQty = 0;
                                for (int j = 0; j < DEFECT_TAG_GRID.Rows.Count; j++)
                                    iTotalTagQty += Util.NVC_Decimal(DataTableConverter.GetValue(DEFECT_TAG_GRID.Rows[j].DataItem, "CLCTVAL01"));

                                row["CLCTQTY"] = Util.NVC(iTotalTagQty);
                            }
                            indataSet.Tables["INLOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = (procId.Equals(Process.REWINDER) || procId.Equals(Process.LASER_ABLATION)) ? "BR_PRD_REG_END_LOT_SI_UI" : "BR_PRD_REG_END_LOT_BW_UI";
                        string inDataTableName = "INDATA,IN_INPUT,IN_LOT";

                        // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                        // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                        if (isRollDirCtn)
                            SetWipAttrRollDir();

                        // 2022.11.04  강호운 : C20221107-000542 - LASER_ABLATION 공정추가
                        new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (sResult, ex) =>
                        {
                            if (ex != null)
                            {
                                //Util.AlertByBiz("BR_PRD_REG_END_LOT_SI_UI", ex.Message, ex.ToString());
                                Util.MessageException(ex);
                                return;
                            }
                            isConfirm = true;
                            REFRESH = true;

                        }, indataSet);
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.SLITTING))
            {
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult, isHold) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        // SLITTER 실적 확정 CUT기준으로 변경 ( 2017-01-21 ) CR-53
                        DataSet inDataSet = null;
                        inDataSet = new DataSet();

                        DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                        inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inLotDataTable.Columns.Add("IFMODE", typeof(string));
                        inLotDataTable.Columns.Add("EQPTID", typeof(string));
                        inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inLotDataTable.Columns.Add("SHIFT", typeof(string));
                        inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inLotDataTable.Columns.Add("USERID", typeof(string));
                        inLotDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                        inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                        inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inLotDataRow = null;
                        inLotDataRow = inLotDataTable.NewRow();
                        inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inLotDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                        inLotDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inLotDataRow["SHIFT"] = txtShift.Tag;
                        //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inLotDataRow["USERID"] = LoginInfo.USERID;
                        inLotDataRow["LANE_QTY"] = 1; // txtLaneQty.Value;
                        inLotDataRow["LANE_PTN_QTY"] = 1; // txtLanePatternQty.Value;
                        //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inLotDataTable.Rows.Add(inLotDataRow);

                        DataTable inLotDetail = inDataSet.Tables.Add("IN_CUTLOT");
                        inLotDetail.Columns.Add("CUT_ID", typeof(string));
                        inLotDetail.Columns.Add("INPUTQTY", typeof(decimal));
                        inLotDetail.Columns.Add("LABEL_PASS_HOLD_FLAG", typeof(string));

                        DataRow inLotDetailDataRow = null;
                        inLotDetailDataRow = inLotDetail.NewRow();
                        inLotDetailDataRow["CUT_ID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "CUT_ID"));
                        if (bool.Parse(finalCutInfo[2]) == true)
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) + Convert.ToDouble(finalCutInfo[5]);
                        else
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDetailDataRow["LABEL_PASS_HOLD_FLAG"] = string.IsNullOrEmpty(_LABEL_PASS_HOLD_FLAG) ? "Y" : _LABEL_PASS_HOLD_FLAG;
                        inLotDetail.Rows.Add(inLotDetailDataRow);

                        DataTable inPLotDataTable = inDataSet.Tables.Add("IN_PRLOT");
                        inPLotDataTable.Columns.Add("LOTID", typeof(string));
                        inPLotDataTable.Columns.Add("OUTQTY", typeof(string));
                        inPLotDataTable.Columns.Add("CUTYN", typeof(string));

                        DataRow inPLotDataRow = null;
                        inPLotDataRow = inPLotDataTable.NewRow();

                        DataRowView prodRowView = PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem as DataRowView;
                        //string prc = Util.NVC(DataTableConverter.GetValue(prodRowView, "WIPSTAT"));
                        //string lot = Util.NVC(DataTableConverter.GetValue(prodRowView, "LOTID"));
                        //string lotpr = Util.NVC(DataTableConverter.GetValue(prodRowView, "LOTID_PR"));

                        inPLotDataRow["LOTID"] = _LOTIDPR;
                        inPLotDataRow["OUTQTY"] = finalCutInfo[6];
                        inPLotDataRow["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        inPLotDataTable.Rows.Add(inPLotDataRow);

                        DataTable inMtrlDataTable = inDataSet.Tables.Add("IN_INPUT");
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        inMtrlDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inMtrlDataRow = null;
                        inMtrlDataRow = inMtrlDataTable.NewRow();
                        inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
                        inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                        //inMtrlDataRow["INPUT_LOTID"] = prc.Equals("PROC") ? lot : lotpr;
                        inMtrlDataRow["INPUT_LOTID"] = _LOTIDPR;
                        inMtrlDataTable.Rows.Add(inMtrlDataRow);

                        DataTable inRemartTable = inDataSet.Tables.Add("IN_OUTLOT");
                        inRemartTable.Columns.Add("OUT_LOTID", typeof(string));
                        inRemartTable.Columns.Add("WIPNOTE", typeof(string));

                        DataTable dt = ((DataView)REMARK_GRID.ItemsSource).Table;
                        DataRow row = null;
                        for ( int i = 1; i < dt.Rows.Count; i++)
                        //foreach (DataRow _iRow in dt.Rows)
                        {
                            row = inRemartTable.NewRow();
                            row["OUT_LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);
                            //row["WIPNOTE"] = Util.NVC(_iRow["REMARK"]);
                            // 특이사항 저장 오류 수정 [2019-04-24]
                            //2022 12 29 오화백 EP동 추가
                            if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                                row["WIPNOTE"] = postremarkInfo[Util.NVC(dt.Rows[i]["LOTID"])];
                            else
                                row["WIPNOTE"] = remarkInfo[Util.NVC(dt.Rows[i]["LOTID"])];
                            inDataSet.Tables["IN_OUTLOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_CUTID_SL";
                        string inDataTableName = "INDATA,IN_CUTLOT,IN_PRLOT,IN_INPUT,IN_OUTLOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            // C20220406-000241 - 자동차 1, 2동 전극 슬리터 바코드 불량수, Tag수 표시
                            if (isBarCodePrint)
                            {
                                SaveDefectCheckUpDate("N");
                                isBarCodePrint = false;
                            }

                            //new ClientProxy().ExecuteService_Multi("BR_PRD_REG_END_LOT_SL", "INDATA,INLOT,IN_PRLOT,IN_INPUT", null, (result, ex) =>
                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_CUTID_SL", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }

                        
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            //슬리터 2차 추가  2021-09-15 by 오화백
            else if (procId.Equals("E4200"))
            {
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult, isHold) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        // SLITTER 실적 확정 CUT기준으로 변경 ( 2017-01-21 ) CR-53
                        DataSet inDataSet = null;
                        inDataSet = new DataSet();

                        DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                        inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inLotDataTable.Columns.Add("IFMODE", typeof(string));
                        inLotDataTable.Columns.Add("EQPTID", typeof(string));
                        inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inLotDataTable.Columns.Add("SHIFT", typeof(string));
                        inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inLotDataTable.Columns.Add("USERID", typeof(string));
                        inLotDataTable.Columns.Add("LANE_QTY", typeof(decimal));
                        inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(decimal));
                        inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inLotDataRow = null;
                        inLotDataRow = inLotDataTable.NewRow();
                        inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inLotDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                        inLotDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inLotDataRow["SHIFT"] = txtShift.Tag;
                        //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inLotDataRow["USERID"] = LoginInfo.USERID;
                        inLotDataRow["LANE_QTY"] = 1; // txtLaneQty.Value;
                        inLotDataRow["LANE_PTN_QTY"] = 1; // txtLanePatternQty.Value;
                        //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inLotDataTable.Rows.Add(inLotDataRow);

                        DataTable inLotDetail = inDataSet.Tables.Add("IN_CUTLOT");
                        inLotDetail.Columns.Add("CUT_ID", typeof(string));
                        inLotDetail.Columns.Add("INPUTQTY", typeof(decimal));
                        inLotDetail.Columns.Add("LABEL_PASS_HOLD_FLAG", typeof(string));

                        DataRow inLotDetailDataRow = null;
                        inLotDetailDataRow = inLotDetail.NewRow();
                        inLotDetailDataRow["CUT_ID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "CUT_ID"));
                        if (bool.Parse(finalCutInfo[2]) == true)
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) + Convert.ToDouble(finalCutInfo[5]);
                        else
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDetailDataRow["LABEL_PASS_HOLD_FLAG"] = string.IsNullOrEmpty(_LABEL_PASS_HOLD_FLAG) ? "Y" : _LABEL_PASS_HOLD_FLAG;
                        inLotDetail.Rows.Add(inLotDetailDataRow);

                        DataTable inPLotDataTable = inDataSet.Tables.Add("IN_PRLOT");
                        inPLotDataTable.Columns.Add("LOTID", typeof(string));
                        inPLotDataTable.Columns.Add("OUTQTY", typeof(string));
                        inPLotDataTable.Columns.Add("CUTYN", typeof(string));

                        DataRow inPLotDataRow = null;
                        inPLotDataRow = inPLotDataTable.NewRow();

                        DataRowView prodRowView = PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem as DataRowView;
                        //string prc = Util.NVC(DataTableConverter.GetValue(prodRowView, "WIPSTAT"));
                        //string lot = Util.NVC(DataTableConverter.GetValue(prodRowView, "LOTID"));
                        //string lotpr = Util.NVC(DataTableConverter.GetValue(prodRowView, "LOTID_PR"));

                        inPLotDataRow["LOTID"] = _LOTIDPR;
                        inPLotDataRow["OUTQTY"] = finalCutInfo[6];
                        inPLotDataRow["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        inPLotDataTable.Rows.Add(inPLotDataRow);

                        DataTable inMtrlDataTable = inDataSet.Tables.Add("IN_INPUT");
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        inMtrlDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inMtrlDataRow = null;
                        inMtrlDataRow = inMtrlDataTable.NewRow();
                        inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
                        inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                        //inMtrlDataRow["INPUT_LOTID"] = prc.Equals("PROC") ? lot : lotpr;
                        inMtrlDataRow["INPUT_LOTID"] = _LOTIDPR;
                        inMtrlDataTable.Rows.Add(inMtrlDataRow);

                        DataTable inRemartTable = inDataSet.Tables.Add("IN_OUTLOT");
                        inRemartTable.Columns.Add("OUT_LOTID", typeof(string));
                        inRemartTable.Columns.Add("WIPNOTE", typeof(string));

                        DataTable dt = ((DataView)REMARK_GRID.ItemsSource).Table;
                        DataRow row = null;
                        for (int i = 1; i < dt.Rows.Count; i++)
                        //foreach (DataRow _iRow in dt.Rows)
                        {
                            row = inRemartTable.NewRow();
                            row["OUT_LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);
                            //row["WIPNOTE"] = Util.NVC(_iRow["REMARK"]);
                            // 특이사항 저장 오류 수정 [2019-04-24]
                            // 2022-12-29 오화백 EP 동 추가
                            if (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EP"))
                                row["WIPNOTE"] = postremarkInfo[Util.NVC(dt.Rows[i]["LOTID"])];
                            else
                                row["WIPNOTE"] = remarkInfo[Util.NVC(dt.Rows[i]["LOTID"])];
                            inDataSet.Tables["IN_OUTLOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_CUTID_SL";
                        string inDataTableName = "INDATA,IN_CUTLOT,IN_PRLOT,IN_INPUT,IN_OUTLOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            //new ClientProxy().ExecuteService_Multi("BR_PRD_REG_END_LOT_SL", "INDATA,INLOT,IN_PRLOT,IN_INPUT", null, (result, ex) =>
                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_CUTID_SL", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.SRS_SLITTING))
            {
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("실적 확정 하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), null, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult, isHold) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        // SLITTER 실적 확정 CUT기준으로 변경 ( 2017-01-21 ) CR-53
                        DataSet inDataSet = null;
                        inDataSet = new DataSet();

                        DataTable inLotDataTable = inDataSet.Tables.Add("INDATA");
                        inLotDataTable.Columns.Add("SRCTYPE", typeof(string));
                        inLotDataTable.Columns.Add("IFMODE", typeof(string));
                        inLotDataTable.Columns.Add("EQPTID", typeof(string));
                        inLotDataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                        inLotDataTable.Columns.Add("SHIFT", typeof(string));
                        inLotDataTable.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inLotDataTable.Columns.Add("WRK_USER_NAME", typeof(string));
                        inLotDataTable.Columns.Add("WRK_USERID", typeof(string));
                        inLotDataTable.Columns.Add("USERID", typeof(string));
                        inLotDataTable.Columns.Add("LANE_QTY", typeof(Int32));
                        inLotDataTable.Columns.Add("LANE_PTN_QTY", typeof(Int32));
                        inLotDataTable.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow inLotDataRow = null;
                        inLotDataRow = inLotDataTable.NewRow();
                        inLotDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        inLotDataRow["IFMODE"] = IFMODE.IFMODE_OFF;
                        inLotDataRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                        inLotDataRow["PROD_VER_CODE"] = txtVersion.Text;
                        inLotDataRow["SHIFT"] = txtShift.Tag;
                        //inLotDataRow["WIPDTTM_ED"] = dtpEndDateTime.DateTime;
                        //inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(txtEndDateTime.Text);
                        inLotDataRow["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        inLotDataRow["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        inLotDataRow["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        inLotDataRow["USERID"] = LoginInfo.USERID;
                        inLotDataRow["LANE_QTY"] = 1; // txtLaneQty.Value;
                        inLotDataRow["LANE_PTN_QTY"] = 1;// txtLanePatternQty.Value;
                        //inLotDataRow["CALDATE"] = dtpWorkDate.DateTime;
                        inLotDataRow["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        inLotDataTable.Rows.Add(inLotDataRow);

                        DataTable inLotDetail = inDataSet.Tables.Add("IN_CUTLOT");
                        inLotDetail.Columns.Add("CUT_ID", typeof(string));
                        inLotDetail.Columns.Add("INPUTQTY", typeof(decimal));

                        DataRow inLotDetailDataRow = null;
                        inLotDetailDataRow = inLotDetail.NewRow();
                        inLotDetailDataRow["CUT_ID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "CUT_ID"));
                        if (bool.Parse(finalCutInfo[2]) == true)
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) + Convert.ToDouble(finalCutInfo[5]);
                        else
                            inLotDetailDataRow["INPUTQTY"] = Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        inLotDetail.Rows.Add(inLotDetailDataRow);

                        DataTable inPLotDataTable = inDataSet.Tables.Add("IN_PRLOT");
                        inPLotDataTable.Columns.Add("LOTID", typeof(string));
                        inPLotDataTable.Columns.Add("OUTQTY", typeof(string));
                        inPLotDataTable.Columns.Add("CUTYN", typeof(string));

                        DataRow inPLotDataRow = null;
                        inPLotDataRow = inPLotDataTable.NewRow();
                        inPLotDataRow["LOTID"] = _LOTIDPR;
                        inPLotDataRow["OUTQTY"] = finalCutInfo[6];
                        inPLotDataRow["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        inPLotDataTable.Rows.Add(inPLotDataRow);

                        DataTable inMtrlDataTable = inDataSet.Tables.Add("IN_INPUT");
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        inMtrlDataTable.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        inMtrlDataTable.Columns.Add("INPUT_LOTID", typeof(string));

                        DataRow inMtrlDataRow = null;
                        inMtrlDataRow = inMtrlDataTable.NewRow();
                        inMtrlDataRow["EQPT_MOUNT_PSTN_ID"] = GetEqptCurrentMtrl(Util.NVC(EQUIPMENT_COMBO.SelectedValue));
                        inMtrlDataRow["EQPT_MOUNT_PSTN_STATE"] = "A";
                        //inMtrlDataRow["INPUT_LOTID"] = _LOTID;
                        inMtrlDataRow["INPUT_LOTID"] = _LOTIDPR;
                        inMtrlDataTable.Rows.Add(inMtrlDataRow);

                        DataTable inRemartTable = inDataSet.Tables.Add("IN_OUTLOT");
                        inRemartTable.Columns.Add("OUT_LOTID", typeof(string));
                        inRemartTable.Columns.Add("WIPNOTE", typeof(string));

                        DataTable dt = ((DataView)REMARK_GRID.ItemsSource).Table;
                        DataRow row = null;
                        for (int i = 1; i < dt.Rows.Count; i++)
                        //foreach (DataRow _iRow in dt.Rows)
                        {
                            row = inRemartTable.NewRow();
                            row["OUT_LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);
                            //row["WIPNOTE"] = Util.NVC(_iRow["REMARK"]);
                            row["WIPNOTE"] = remarkInfo[Util.NVC(dt.Rows[i]["LOTID"])];
                            inDataSet.Tables["IN_OUTLOT"].Rows.Add(row);
                        }

                        DataTable inPetDataTable = inDataSet.Tables.Add("IN_PET");
                        inPetDataTable.Columns.Add("PROTECT_FILM_TYPE_CODE", typeof(string));

                        DataRow inPetDataRow = null;
                        inPetDataRow = inPetDataTable.NewRow();
                        inPetDataRow["PROTECT_FILM_TYPE_CODE"] = Util.NVC(cboPet.SelectedValue);
                        inPetDataTable.Rows.Add(inPetDataRow);
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_CUTID_SS";
                        string inDataTableName = "INDATA,IN_CUTLOT,IN_PRLOT,IN_INPUT,IN_OUTLOT,IN_PET";

                        DataTable dtPermitRateOverData = GetPermitRateEmptyData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            //new ClientProxy().ExecuteService_Multi("BR_PRD_REG_END_LOT_SS", "INDATA,INLOT,IN_PRLOT,IN_PET,IN_INPUT", null, (result, ex) =>
                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (result, ex) =>
                            {
                                if (ex != null)
                                {
                                    //Util.AlertByBiz("BR_PRD_REG_END_LOT_CUTID_SS", ex.Message, ex.ToString());
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, inDataSet);
                        }

                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
            else if (procId.Equals(Process.HEAT_TREATMENT))
            {
                LGC.GMES.MES.ControlsLibrary.MessageBox.Show(finalCutInfo[4], bool.Parse(finalCutInfo[3]), false, ObjectDic.Instance.GetObjectName("HOLD여부"), addMessage, "Confirm", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result, isHold) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        #region CONFIRM MESSAGE
                        // 자동 Loss 처리 여부
                        if (bool.Parse(finalCutInfo[2]) == true)
                        {
                            if (SetLossLot(WIPREASON_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                return;

                            SaveDefect(WIPREASON_GRID);

                            if (WIPREASON2_GRID.Visibility == Visibility.Visible)
                            {
                                if (SetLossLot(WIPREASON2_GRID, ITEM_CODE_LEN_LACK, Util.NVC_Decimal(finalCutInfo[5])) == false)
                                    return;

                                SaveDefect(WIPREASON2_GRID);
                            }
                            isChangeWipReason = false;
                        }

                        DataSet indataSet = new DataSet();
                        DataTable inData = indataSet.Tables.Add("INDATA");
                        inData.Columns.Add("SRCTYPE", typeof(string));
                        inData.Columns.Add("IFMODE", typeof(string));
                        inData.Columns.Add("EQPTID", typeof(string));
                        inData.Columns.Add("PROD_VER_CODE", typeof(string));
                        inData.Columns.Add("SHIFT", typeof(string));
                        inData.Columns.Add("WIPDTTM_ED", typeof(DateTime));
                        inData.Columns.Add("WRK_USER_NAME", typeof(string));
                        inData.Columns.Add("WRK_USERID", typeof(string));
                        inData.Columns.Add("WIPNOTE", typeof(string));
                        inData.Columns.Add("USERID", typeof(string));
                        inData.Columns.Add("CUTYN", typeof(string));
                        inData.Columns.Add("REMAINQTY", typeof(string));
                        inData.Columns.Add("LANE_QTY", typeof(string));
                        inData.Columns.Add("LANE_PTN_QTY", typeof(string));
                        inData.Columns.Add("CALDATE", typeof(DateTime));

                        DataRow row = inData.NewRow();
                        row["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                        row["IFMODE"] = "OFF";
                        row["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
                        row["USERID"] = LoginInfo.USERID;
                        row["PROD_VER_CODE"] = txtVersion.Text;
                        row["SHIFT"] = txtShift.Tag;
                        row["WIPDTTM_ED"] = Convert.ToDateTime(sEndTime);
                        row["WRK_USER_NAME"] = Util.NVC(txtWorker.Text.ToString());
                        row["WRK_USERID"] = Util.NVC(txtWorker.Tag.ToString());
                        row["WIPNOTE"] = remarkInfo[Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))];
                        row["CUTYN"] = bool.Parse(finalCutInfo[1]) == true ? "N" : "Y";    // FINAL CUT 여부
                        row["REMAINQTY"] = finalCutInfo[6];
                        row["LANE_QTY"] = txtLaneQty.Value;
                        row["LANE_PTN_QTY"] = txtLanePatternQty.Value;
                        row["CALDATE"] = Convert.ToDateTime(txtWorkDate.Tag);

                        if (isHold == true)  // HOLD_YN필수값 확인
                        {
                        }

                        indataSet.Tables["INDATA"].Rows.Add(row);

                        DataTable input = indataSet.Tables.Add("IN_INPUT");
                        input.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
                        input.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
                        input.Columns.Add("INPUT_LOTID", typeof(string));

                        DataTable eqpt_mount = new DataTable();
                        eqpt_mount.Columns.Add("EQPTID", typeof(string));

                        DataRow eqpt_mount_row = eqpt_mount.NewRow();
                        eqpt_mount_row["EQPTID"] = _EQPTID;
                        eqpt_mount.Rows.Add(eqpt_mount_row);

                        DataTable EQPT_PSTN_ID = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_MOUNT_PSTN_ID", "RQSTDT", "RSLTDT", eqpt_mount);

                        if (EQPT_PSTN_ID.Rows.Count < 0)
                        {
                            Util.MessageValidation("SFU1398");  //MMD에 설비 투입을 입력해주세요.
                            return;
                        }

                        row = input.NewRow();
                        row["EQPT_MOUNT_PSTN_ID"] = EQPT_PSTN_ID.Rows[0]["EQPT_MOUNT_PSTN_ID"];
                        row["EQPT_MOUNT_PSTN_STATE"] = "A";
                        row["INPUT_LOTID"] = _LOTIDPR;

                        input.Rows.Add(row);

                        DataTable inLot = indataSet.Tables.Add("IN_LOT");
                        inLot.Columns.Add("LOTID", typeof(string));
                        inLot.Columns.Add("INPUTQTY", typeof(string));
                        inLot.Columns.Add("OUTPUTQTY", typeof(string));
                        inLot.Columns.Add("RESNQTY", typeof(string));

                        for (int i = LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                        {
                            row = inLot.NewRow();
                            row["LOTID"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID"));
                            row["INPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "INPUTQTY"));
                            row["OUTPUTQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "GOODQTY"));
                            row["RESNQTY"] = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOSSQTY"));
                            indataSet.Tables["IN_LOT"].Rows.Add(row);
                        }
                        #endregion

                        string bizRuleName = "BR_PRD_REG_END_LOT_HT_UI";
                        string inDataTableName = "INDATA,IN_INPUT,IN_LOT";

                        DataTable dtPermitRateOverData = GetPermitRateOverData(); // 허용비율 초과목록 
                        if (dtPermitRateOverData.Rows.Count > 0)
                        {
                            SetPermitRateOverHis(dtPermitRateOverData, inDataSet, bizRuleName, inDataTableName);
                        }
                        else
                        {
                            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
                            // 동별코드 등록된 공정만 실행 (동별코드 : MNG_ROLL_DIR_AREA)
                            if (isRollDirCtn)
                                SetWipAttrRollDir();

                            new ClientProxy().ExecuteService_Multi(bizRuleName, inDataTableName, null, (sResult, ex) =>
                            {
                                if (ex != null)
                                {
                                    Util.MessageException(ex);
                                    return;
                                }
                                isConfirm = true;
                                REFRESH = true;

                            }, indataSet);
                        }
                    }
                }, false, Util.NVC_Decimal(finalCutInfo[5]) > 0 ? true : false, topInfo);
            }
        }
        #region [POSTACTION]
        private DataTable getPostAction(string CUT_ID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("CUT_ID", typeof(string));
                //IndataTable.Columns.Add("HOLD_FLAG", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["CUT_ID"] = CUT_ID;
                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_CHK_POST_HOLD_ELTR", "INDATA", "RSLTDT", IndataTable);

                return dtResult;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return null;
            }
        }
        private DataTable getSavedPostAction(string CUT_ID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("CUT_ID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["CUT_ID"] = CUT_ID;
                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_SEL_POST_HOLD_CUT_ID", "INDATA", "RSLTDT", IndataTable);

                return dtResult;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return null;
            }
        }
        #endregion

        string GetEqptCurrentMtrl(string sEqptID)
        {
            try
            {
                string MountMTRL = string.Empty;
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("EQPTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["EQPTID"] = sEqptID;
                IndataTable.Rows.Add(Indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_CURR_MOUNT_MTRL", "INDATA", "RSLTDT", IndataTable);

                if (dt.Rows.Count == 0)
                    return "";

                MountMTRL = dt.Rows[0]["EQPT_MOUNT_PSTN_ID"].ToString();
                return MountMTRL;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return "";
            }
        }

        #region # Roll Map
        private bool IsEquipmentAttr(string sEqptID)
        {
            try
            {
                DataRow[] dr = Util.getEquipmentAttr(sEqptID).Select();
                if (dr?.Length > 0)
                {
                    if (string.Equals(Util.NVC(dr[0]["ROLLMAP_EQPT_FLAG"]), "Y"))
                        return true;
                }
            }
            catch (Exception ex) { }

            return false;
        }

        private bool IsRollMapResultApply()
        {
            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("PROCID", typeof(string));
                RQSTDT.Columns.Add("EQSGID", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["PROCID"] = procId;
                dr["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_PROCESSEQUIPMENTSEGMENT", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null & dtResult.Rows.Count > 0)
                    if (string.Equals(dtResult.Rows[0]["ROLLMAP_SBL_APPLY_FLAG"], "Y"))
                        return true;
            }
            catch (Exception ex) { }

            return false;
        }

        private void SelectRollMapLot(string sLotID)
        {
            try
            {
                if (isOriginRollMapEquipment == true)
                {
                    bool isRollMapModeChange = false;

                    const string bizRuleName = "BR_PRD_CHK_ROLLMAP_LOT";
                    DataTable inTable = new DataTable();
                    inTable.Columns.Add("LOTID", typeof(string));
                    inTable.Columns.Add("WIPSEQ", typeof(decimal));

                    DataRow dr = inTable.NewRow();
                    dr["LOTID"] = sLotID;
                    dr["WIPSEQ"] = 1;
                    inTable.Rows.Add(dr);

                    DataTable result = new ClientProxy().ExecuteServiceSync(bizRuleName, "INDATA", "OUTDATA", inTable);

                    if (result != null && result.Rows.Count > 0)
                    {
                        // 실적 연계 여부에 따라 처리 변경 [2021-10-18]
                        if (isRollMapResultLink == true)
                        {
                            if (string.Equals(result.Rows[0]["ROLLMAP_LOT_YN"], "Y"))
                            {
                                if (isRollMapEquipment == false)
                                    isRollMapModeChange = true;

                                isRollMapEquipment = true;
                            }
                            else
                            {
                                if (isRollMapEquipment == true)
                                    isRollMapModeChange = true;

                                isRollMapEquipment = false;
                            }

                            if (isRollMapModeChange == true)
                                VisibleRollMapMode();
                        }
                        else
                        {
                            isRollMapEquipment = false;
                            VisibleRollMapMode();

                            if (string.Equals(result.Rows[0]["ROLLMAP_LOT_YN"], "Y"))
                                (grdSearch.Children[0] as UcSearch).btnRollMap.Visibility = Visibility.Visible;
                        }

                    }
                }
                setRollmapResultLinkBtn();  //nathan 2023.12.13 롤맵 코터 수불 실적 적용
            }
            catch (Exception)
            {

            }
        }

        private DataTable GetEquipmentCode(string lotId, string wipSeq)
        {
            DataTable inTable = new DataTable { TableName = "RQSTDT" };
            inTable.Columns.Add("EQPTID", typeof(string));
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("WIPSEQ", typeof(decimal));

            DataRow dr = inTable.NewRow();
            //dr["EQPTID"] = equipmentCode;
            dr["LOTID"] = lotId;
            dr["WIPSEQ"] = wipSeq;
            inTable.Rows.Add(dr);

            return new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_VW_WIPHISTORY", "RQSTDT", "RSLTDT", inTable);
        }

        private DataTable GetRollMapInputLotCode(string lotId)
        {
            DataTable inTable = new DataTable { TableName = "RQSTDT"};
            inTable.Columns.Add("LANGID", typeof(string));
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("WIPSEQ", typeof(decimal));
            inTable.Columns.Add("EQPT_MEASR_PSTN_ID", typeof(string));

            DataRow dr = inTable.NewRow();
            dr["LANGID"] = LoginInfo.LANGID;
            dr["LOTID"] = lotId;
            dr["WIPSEQ"] = 1;
            dr["EQPT_MEASR_PSTN_ID"] = "UW";
            inTable.Rows.Add(dr);

            return new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_ROLLMAP_COLLECT_INFO", "RQSTDT", "RSLTDT", inTable);
        }

        private string GetLotUnitCode()
        {
            try
            {
                const string bizRuleName = "DA_PRD_SEL_VW_LOT";

                DataTable inTable = new DataTable { TableName = "RQSTDT" };
                inTable.Columns.Add("LOTID", typeof(string));

                DataRow dr = inTable.NewRow();
                dr["LOTID"] = _LOTID;
                inTable.Rows.Add(dr);
                DataTable result = new ClientProxy().ExecuteServiceSync(bizRuleName, "RQSTDT", "RSLTDT", inTable);

                if (CommonVerify.HasTableRow(result))
                {
                    return result.Rows[0]["LOTUID"].GetString();
                }
                else
                {
                    return string.Empty;
                }

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return string.Empty;
            }
        }

        #endregion

        void SetLabelLot()
        {
            if (LoginInfo.CFG_SERIAL_PRINT == null || LoginInfo.CFG_SERIAL_PRINT.Rows.Count < 1)
            {
                Util.MessageValidation("SFU2003"); // 프린트 환경 설정값이 없습니다.
                return;
            }
            try
            {
                DataTable LabelDT = new DataTable();
                LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                if (LoginInfo.CFG_LABEL_AUTO.Equals("Y"))
                    foreach (DataRow _iRow in LabelDT.Rows)
                        Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        // AD 인증 체크 기능 [2019-08-21]
        private DataTable GetConfirmAuthVaildation()
        {
            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("LANGID", typeof(string));
            IndataTable.Columns.Add("SHOPID", typeof(string));
            IndataTable.Columns.Add("AREAID", typeof(string));
            IndataTable.Columns.Add("EQSGID", typeof(string));
            IndataTable.Columns.Add("PROCID", typeof(string));
            IndataTable.Columns.Add("EQPTID", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["LANGID"] = LoginInfo.LANGID;
            Indata["SHOPID"] = LoginInfo.CFG_SHOP_ID;
            Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
            Indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
            Indata["PROCID"] = procId;
            Indata["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            IndataTable.Rows.Add(Indata);

             DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CNFM_AUTH", "INDATA", "RSLTDT", IndataTable);

            if (dt != null && dt.Rows.Count > 0)
            {
                // 인증 여부
                bool isAuthConfirm = true;

                // Input용 데이터 테이블 ( INPUTVALUE : 비교할 대상 값, CHK_VALUE1 : SPEC1, CHK_VALUE2 : SPEC2 )
                DataTable inputTable = new DataTable();
                inputTable.Columns.Add("CHK_VALUE1", typeof(decimal));
                inputTable.Columns.Add("CHK_VALUE2", typeof(decimal));
                inputTable.Columns.Add("INPUTVALUE", typeof(decimal));

                foreach (DataRow row in dt.Rows)
                {
                    inputTable.Clear();

                    if (!string.IsNullOrEmpty(Util.NVC(row["CHK_VALUE1"])) || !string.IsNullOrEmpty(Util.NVC(row["CHK_VALUE2"])))
                    {
                        DataRow dataRow = inputTable.NewRow();
                        dataRow["CHK_VALUE1"] = row["CHK_VALUE1"];
                        dataRow["CHK_VALUE2"] = row["CHK_VALUE2"];
                        inputTable.Rows.Add(dataRow);
                    }

                    if (string.Equals(row["RSLT_CNFM_TYPE_CODE"], "CNFM_GOOD_QTY_LIMIT"))
                    {
                        // 양품량 기준 체크
                        inputTable.Rows[0]["INPUTVALUE"] = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "GOODQTY"));
                        isAuthConfirm = CheckLimitValue(Util.NVC(row["CHK_TYPE_CODE"]), inputTable);

                    }
                    else if (string.Equals(row["RSLT_CNFM_TYPE_CODE"], "CNFM_PROD_QTY_LIMIT"))
                    {
                        inputTable.Rows[0]["INPUTVALUE"] = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));
                        isAuthConfirm = CheckLimitValue(Util.NVC(row["CHK_TYPE_CODE"]), inputTable);
                    }
                    else if (string.Equals(row["RSLT_CNFM_TYPE_CODE"], "QA_SPEC_LIMIT"))
                    {
                        // USL,LSL 제한 체크
                        isAuthConfirm = ValidQualitySpec("Auth");
                    }
                    else if (string.Equals(row["RSLT_CNFM_TYPE_CODE"], "QA_AVG_LIMIT"))
                    {
                        // 품질평균값 제한 체크

                    }
                    //LANE 수 체크 관련 체크 로직 _ 2022.04.04 ysh76  
                    else if (string.Equals(row["RSLT_CNFM_TYPE_CODE"], "CNFM_COAT_LANE_CHK"))
                    {
                        isAuthConfirm = ValidVerLaneQtyChk(Util.NVC(row["CHK_TYPE_CODE"]));
                    }

                    // 인증이 필요한 경우 전체 정보 전달
                    if (isAuthConfirm == false)
                    {
                        DataTable outTable = dt.Clone();
                        // MES 2.0 ItemArray 위치 오류 Patch
                        //outTable.Rows.Add(row.ItemArray);
                        outTable.AddDataRow(row);
                        return outTable;
                    }
                }
            }
            return new DataTable();
        }

        private bool CheckLimitValue(string sCheckType, DataTable inputTable)
        {
            foreach (DataRow row in inputTable.Rows)
            {
                switch (sCheckType)
                {
                    case "LOWER":           // SPEC LOWER
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) < Util.NVC_Decimal(row["CHK_VALUE1"]))
                            return false;

                        break;
                    case "UPPER":           // SPEC UPPER
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) > Util.NVC_Decimal(row["CHK_VALUE1"]))
                            return false;

                        break;
                    case "BOTH":            // SPEC IN
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) > Util.NVC_Decimal(row["CHK_VALUE1"]) &&
                            Util.NVC_Decimal(row["INPUTVALUE"]) < Util.NVC_Decimal(row["CHK_VALUE2"]))
                            return false;

                            break;

                    case "NOT_BOTH":        // SPEC OUT
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) < Util.NVC_Decimal(row["CHK_VALUE1"]) &&
                            Util.NVC_Decimal(row["INPUTVALUE"]) > Util.NVC_Decimal(row["CHK_VALUE2"]))
                            return false;

                        break;
                    case "VALUE":           
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) == Util.NVC_Decimal(row["CHK_VALUE1"]))
                            return false;

                        break;
                    case "NOT_VAULE":
                        if (Util.NVC_Decimal(row["INPUTVALUE"]) != Util.NVC_Decimal(row["CHK_VALUE1"]))
                            return false;

                        break;
                    default:
                        break;
                }
            }
            return true;
        }

        private string ValidateRollPressAlarm()
        {
            string rtnLotIDs = "";

            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("AREAID", typeof(string));
            IndataTable.Columns.Add("PROCID", typeof(string));
            IndataTable.Columns.Add("EQPTID", typeof(string));
            IndataTable.Columns.Add("DAYS", typeof(string));
            IndataTable.Columns.Add("MINUTES", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
            Indata["PROCID"] = procId;
            Indata["EQPTID"] = EQUIPMENT_COMBO.SelectedValue.ToString();
            Indata["DAYS"] = _RollPressStartIntervalDays;
            Indata["MINUTES"] = _RollPressEndIntervalMinutes;
            IndataTable.Rows.Add(Indata);

            try
            {
                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PRD_GET_INNER_PACKING_RP", "RQSTDT", "RSLTDT", IndataTable);

                if (dtResult.Rows.Count > 0)
                {
                    int roofcnt = 5; // 5개까지만 메시지 박스보여주고 그이상이면 6개부터는 ...로 처리함

                    if (dtResult.Rows.Count < roofcnt)
                    {
                        roofcnt = dtResult.Rows.Count;
                    }

                    for (int i = 0; i < roofcnt; i++)
                    {
                        rtnLotIDs += dtResult.Rows[i]["LOTID"].ToString() + ",";
                    }

                    rtnLotIDs = rtnLotIDs.Substring(0, rtnLotIDs.Length - 1);

                    if (dtResult.Rows.Count > 5)
                    {
                        rtnLotIDs += "...";
                    }
                }                
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }

            return rtnLotIDs;
        }

        private void CheckRollPressAlarm()
        {
            DataTable dtResult = GetAreaCommonCode("ELTR_ROLLPRESS_INNER_PACKING_CHK", "USE_YN");
            if (dtResult != null && dtResult.Rows.Count != 0)
            {
                _RollPressStartIntervalDays = dtResult.Rows[0]["ATTR1"].ToString();
                _RollPressEndIntervalMinutes = dtResult.Rows[0]["ATTR2"].ToString();
                TimerSettingRollPress();
            }
        }

        #endregion Methods

        #region [Defect / DataCollect / Material / Slurry  / Wip Note ]
        #region Defect
        protected virtual void OnDataCollectGridCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count)
            {
                C1DataGrid caller = sender as C1DataGrid;

                if (ValidateDefect(sender as C1DataGrid))
                {
                    if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
                    {
                        DefectChange(caller, caller.CurrentCell.Row.Index, caller.CurrentCell.Column.Index);
                    }
                    else
                    {
                        // 청주1동 특화 M -> P 변환 로직 [2017-05-15]
                        if (string.Equals(caller.CurrentCell.Column.Name, "CONVRESNQTY") && string.Equals(txtUnit.Text, "EA"))
                            DataTableConverter.SetValue(e.Cell.Row.DataItem, "RESNQTY",
                                Convert.ToDouble(GetIntFormatted(Util.NVC_Decimal(DataTableConverter.GetValue(e.Cell.Row.DataItem, "CONVRESNQTY")) / convRate)));

                        if (isRollMapEquipment && (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING)))
                        {
                            SetWipReasonCommittedEdit(sender, e);
                        }
                            

                        GetSumDefectQty();
                    }

                    switch (caller.Name)
                    {
                        case "dgWipReason":
                        case "dgWipReason2":
                            isChangeWipReason = true;
                            break;

                        case "dgQuality":
                            isChangeQuality = true;
                            break;

                        //case "dgMaterial":
                        //    isChangeMaterial = true;
                        //    break;

                        case "dgRemark":
                            isChangeRemark = true;
                            break;
                    }

                    SetExceedLength();
                    LOTINFO_GRID.Refresh(false);
                    _LOSSQTY = string.Empty;
                    _GOODQTY = string.Empty;
                    _CHARGEQTY = string.Empty;
                }
            }
        }

        protected virtual void OnDataCollectGridBeginningEdit(object sender, C1.WPF.DataGrid.DataGridBeginningEditEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                //슬리터 2차 추가 2021-09-15 by 오화백
                if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                {
                    if (dataGrid.Columns["ALL"].Index < e.Column.Index && dataGrid.Columns["COSTCENTERID"].Index > e.Column.Index)
                    {
                        if (string.Equals(DataTableConverter.GetValue(e.Row.DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK") ||
                            string.Equals(DataTableConverter.GetValue(e.Row.DataItem, "PRCS_ITEM_CODE"), "LENGTH_EXCEED"))
                        {
                            e.Cancel = true;
                            dataGrid.BeginEdit(e.Row.Index, dataGrid.Columns["ALL"].Index);
                        }
                    }
                }

                // Roll Map 설비인 경우 이벤트 추가
                if (isRollMapEquipment)
                {
                    if (string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.COATING))
                    {
                        if (string.Equals(e.Column.Name, "COUNTQTY") && !string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y"))
                            e.Cancel = true;

                        if ((string.Equals(e.Column.Name, "COUNTQTY") || string.Equals(e.Column.Name, "DFCT_TAG_QTY") || string.Equals(e.Column.Name, "RESN_TOT_CHK") || string.Equals(e.Column.Name, "RESNQTY")) &&
                            (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "DFCT_QTY_CHG_BLOCK_FLAG"), "Y") || string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "TOP_LOSS_BAS_DFCT_APPLY_FLAG"), "Y")))
                            e.Cancel = true;

                        if (string.Equals(e.Column.Name, "RESN_TOT_CHK") && string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "CHARGE_PROD_LOT"))
                            e.Cancel = true;

                        // RollMap용 수량 변경 금지 처리 [2021-07-27]
                        if (string.Equals(e.Column.Name, "RESNQTY") && 
                            (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "PRCS_ITEM_CODE"), "GRP_QTY_DIST") ||
                             string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "DFCT_QTY_UI_CHG_BLOCK_FLAG"), "Y")))
                            e.Cancel = true;

                        /*
                        if (string.Equals(procId, Process.COATING))
                        {
                            // 미확정-미확정-기타 (Top), 초기조건조정-폭/로딩/미스매치(Back), 재조건조정-(Back)-Loading 인 경우 수정불가
                            string[] targetarray = new string[] { "MZZ01Z01E61", "PL18LD3", "PL19LA1" };

                            if (string.Equals(e.Column.Name, "RESNQTY") && targetarray.Contains(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "RESNCODE").GetString()))
                            {
                                e.Cancel = true;
                            }
                        }
                        else if (string.Equals(procId, Process.ROLL_PRESSING))
                        {
                            // 미확정-미확정-기타(MZZ01Z01999), Sample-자주검사(PL08L29), Sample-QA검사(PS01S04) 아닌경우 수정불가
                            string[] targetarray = new string[] { "MZZ01Z01999", "PL08L29", "PS01S04" };

                            if (string.Equals(e.Column.Name, "RESNQTY") && !targetarray.Contains(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "RESNCODE").GetString()))
                            {
                                e.Cancel = true;
                            }
                            else
                            {
                                e.Cancel = false;
                            }
                        }
                        */
                    }
                }

            }
        }
        #region[POSTACTION]
        protected virtual void OnDataCollectGridPostHoldCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            if (e.Cell.Row != null)
                isChangePostAction = true;

            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                if (e.Cell.Column.Name.Contains("POST_HOLD"))
                {
                    if (e.Cell.Row.Index.Equals(0))
                    {
                        DataTable dt = ((DataView)POSTHOLD_GRID.ItemsSource).Table;
                        DataRow dr = dt.Select().FirstOrDefault();
                        string sColumnName = e.Cell.Column.Name;
                        bool hold = Convert.ToBoolean(dr[sColumnName]);
                        if (dr != null)
                        {
                            foreach (DataRow dRow in dt.Rows)
                            {
                                dRow[sColumnName] = hold;
                            }
                        }
                        Util.GridSetData(POSTHOLD_GRID, dt, FrameOperation);
                    }
                }
            }
        }
        #endregion
        private DataTable GetDefectDataByLot(string LotId)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("RESNPOSITION", typeof(string));
                IndataTable.Columns.Add("CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["LOTID"] = LotId;
                Indata["RESNPOSITION"] = null;

                if ( string.Equals(LoginInfo.CFG_AREA_ID, "E6"))
                    Indata["CODE"] = "BAS";

                IndataTable.Rows.Add(Indata);

                //C20210222-000365 불량/Loss항목 표준화 적용 DA_PRD_SEL_ACTIVITYREASON_ELEC -> BR_PRD_SEL_ACTIVITYREASON_ELEC 변경
                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_SEL_ACTIVITYREASON_ELEC", "INDATA", "RSLTDT", IndataTable);

                return dtResult;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return null;
            }
        }
        #endregion

        #region Quality
        void GetQualityList(object SelectedItem)
        {
            try
            {
                DataTable _topDT = new DataTable();
                DataTable _backDT = new DataTable();

                DataRowView rowview = SelectedItem as DataRowView;

                if (rowview == null)
                    return;

                Util.gridClear(QUALITY_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("WIPSEQ", typeof(string));
                IndataTable.Columns.Add("CLCT_PONT_CODE", typeof(string));
                IndataTable.Columns.Add("VER_CODE", typeof(string));
                IndataTable.Columns.Add("LANEQTY", typeof(Int16));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PROCID"] = procId;
                Indata["LOTID"] = rowview["LOTID"].ToString();
                Indata["WIPSEQ"] = rowview["WIPSEQ"].ToString();
                Indata["CLCT_PONT_CODE"] = procId.Equals(Process.COATING) || procId.Equals(Process.INS_COATING) ? "T" : null;
                //Indata["CLCT_PONT_CODE"] = procId.Equals(Process.COATING) ? "TOP" : (procId.Equals(Process.ROLL_PRESSING) ? "MU" : null);
                if (!string.IsNullOrEmpty(txtVersion.Text))
                    Indata["VER_CODE"] = txtVersion.Text;

                if (_LANEQTY != null && Convert.ToInt16(_LANEQTY) > 0 )
                    Indata["LANEQTY"] = _LANEQTY;
                IndataTable.Rows.Add(Indata);

                if (IsAreaCommonCodeUse("ELEC_LOT_QCA_INFO_ADD_TWS", "USE_YN") && procId.Equals(Process.COATING))
                {
                    _topDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_PROC_CLCTITEM_ADD_TWS", "INDATA", "RSLTDT", IndataTable);
                    Util.GridSetData(QUALITY_GRID, _topDT, FrameOperation, true);
                }
                else
                {
                    _topDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_WIPDATACOLLECT_LOT", "INDATA", "RSLTDT", IndataTable);

                    if (_topDT.Rows.Count == 0)
                    {
                        _topDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_PROC_CLCTITEM", "INDATA", "RSLTDT", IndataTable);
                        Util.GridSetData(QUALITY_GRID, _topDT, FrameOperation, true);
                    }
                    else
                    {
                        Util.GridSetData(QUALITY_GRID, _topDT, FrameOperation, true);
                    }
                }

                _Util.SetDataGridMergeExtensionCol(QUALITY_GRID, new string[] { "CLSS_NAME1", "CLSS_NAME2" }, DataGridMergeMode.VERTICALHIERARCHI);
                _Util.SetDataGridMergeExtensionCol(QUALITY_GRID, new string[] { "MEAN" }, DataGridMergeMode.VERTICALHIERARCHI);

                if (QUALITY2_GRID.Visibility == Visibility.Visible)
                {
                    Util.gridClear(QUALITY2_GRID);

                    DataTable backTable = new DataTable();
                    backTable.Columns.Add("LANGID", typeof(string));
                    backTable.Columns.Add("AREAID", typeof(string));
                    backTable.Columns.Add("PROCID", typeof(string));
                    backTable.Columns.Add("LOTID", typeof(string));
                    backTable.Columns.Add("WIPSEQ", typeof(string));
                    backTable.Columns.Add("CLCT_PONT_CODE", typeof(string));
                    backTable.Columns.Add("VER_CODE", typeof(string));
                    backTable.Columns.Add("LANEQTY", typeof(Int16));

                    DataRow backdata = backTable.NewRow();
                    backdata["LANGID"] = LoginInfo.LANGID;
                    backdata["AREAID"] = LoginInfo.CFG_AREA_ID;
                    backdata["PROCID"] = procId;
                    backdata["LOTID"] = rowview["LOTID"].ToString();
                    backdata["WIPSEQ"] = rowview["WIPSEQ"].ToString();
                    backdata["CLCT_PONT_CODE"] = procId.Equals(Process.COATING) || procId.Equals(Process.INS_COATING) ? "B" : null;
                    // backdata["CLCT_PONT_CODE"] = procId.Equals(Process.COATING) ? "BACK" : "HG";

                    if (!string.IsNullOrEmpty(txtVersion.Text))
                        backdata["VER_CODE"] = txtVersion.Text;

                    if (_LANEQTY != null && Convert.ToInt16(_LANEQTY) > 0)
                        backdata["LANEQTY"] = _LANEQTY;

                    backTable.Rows.Add(backdata);

                    if (IsAreaCommonCodeUse("ELEC_LOT_QCA_INFO_ADD_TWS", "USE_YN") && procId.Equals(Process.COATING))
                    {
                        _backDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_PROC_CLCTITEM_ADD_TWS", "INDATA", "RSLTDT", backTable);
                    }
                    else
                    {
                        _backDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_WIPDATACOLLECT_LOT", "INDATA", "RSLTDT", backTable);

                        if (_backDT.Rows.Count == 0)
                        {
                            _backDT = new ClientProxy().ExecuteServiceSync("DA_QCA_SEL_PROC_CLCTITEM", "INDATA", "RSLTDT", backTable);
                        }
                    }

                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.SRS_COATING))
                    {
                        if (string.Equals(QUALITY2_GRID.Columns[QUALITY2_GRID.Columns.Count - 1].Name, "INSP_CONV_RATE"))
                            QUALITY2_GRID.Columns.RemoveAt(QUALITY2_GRID.Columns.Count - 1);

                        if (string.Equals(QUALITY2_GRID.Columns[QUALITY2_GRID.Columns.Count - 1].Name, "CLCTVAL02"))
                            QUALITY2_GRID.Columns.RemoveAt(QUALITY2_GRID.Columns.Count - 1);

                        _backDT.Columns.Add("CLCTVAL02", typeof(double));
                        Util.SetGridColumnNumeric(QUALITY2_GRID, "CLCTVAL02", null, ObjectDic.Instance.GetObjectName("입력값"), true, true, true, false, -1, HorizontalAlignment.Center, Visibility.Visible, GetUnitFormatted(), false, false, false);
                        Util.SetGridColumnNumeric(QUALITY2_GRID, "INSP_CONV_RATE", null, ObjectDic.Instance.GetObjectName("변환율"), true, true, true, true, -1, HorizontalAlignment.Center, Visibility.Visible, "F2", false, false);

                        QUALITY2_GRID.LoadedCellPresenter += OnLoaded2CellPresenter;
                        QUALITY2_GRID.UnloadedCellPresenter += OnUnloaded2CellPresenter;
                    }
                    Util.GridSetData(QUALITY2_GRID, _backDT, FrameOperation, true);
                    _Util.SetDataGridMergeExtensionCol(QUALITY2_GRID, new string[] { "CLSS_NAME1", "CLSS_NAME2" }, DataGridMergeMode.VERTICALHIERARCHI);

                    //화면에 출력되는 index 변경하여 컬럼 순서 변경 2022-06-15
                    QUALITY2_GRID.Columns["CLCTVAL02"].DisplayIndex = QUALITY2_GRID.Columns.Count - 3;
                    QUALITY2_GRID.Columns["INSP_CONV_RATE"].DisplayIndex = QUALITY2_GRID.Columns.Count - 2;

                }
            }
            catch (Exception ex)
            {
                LGC.GMES.MES.ControlsLibrary.MessageBox.ShowKeyEnter(MessageDic.Instance.GetMessage(ex.Message), ex.Message, "Info", MessageBoxButton.OK, MessageBoxIcon.None);
            }
        }

        protected virtual void OnLoaded2CellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.SRS_COATING))
                    {
                        if (e.Cell != null && e.Cell.Presenter != null)
                        {
                            if (e.Cell.Row.Type == DataGridRowType.Item)
                            {
                                if (e != null && e.Cell != null && e.Cell.Presenter != null)
                                {
                                    //if (string.Equals(e.Cell.Column.Name, "CLCTVAL02") && !(DataTableConverter.GetValue(dataGrid.Rows[e.Cell.Row.Index].DataItem, "CLCTITEM").ToString().Split('-')[0].Equals("SI016") || DataTableConverter.GetValue(dataGrid.Rows[e.Cell.Row.Index].DataItem, "CLCTITEM").ToString().Split('-')[0].Equals("SI017")))

                                    if (string.Equals(e.Cell.Column.Name, "INSP_CONV_RATE"))
                                    {
                                        e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                        e.Cell.Presenter.FontWeight = FontWeights.Bold;

                                        if (Convert.ToDouble(e.Cell.Value) == 1)
                                            e.Cell.Presenter.Background = new SolidColorBrush(Colors.LightGray);
                                        else
                                            e.Cell.Presenter.Background = new SolidColorBrush(Colors.LightGreen);
                                    }
                                }
                            }
                        }
                    }
                }));
            }
        }

        protected virtual void OnUnloaded2CellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.SRS_COATING))
                    {
                        if (e.Cell != null && e.Cell.Presenter != null)
                        {
                            if (e.Cell.Row.Type == DataGridRowType.Item)
                            {
                                if (e != null && e.Cell != null && e.Cell.Presenter != null)
                                {
                                    if (string.Equals(e.Cell.Column.Name, "INSP_CONV_RATE"))
                                    {
                                        e.Cell.Presenter.Foreground = null;
                                        e.Cell.Presenter.FontWeight = FontWeights.Normal;
                                        e.Cell.Presenter.Background = null;
                                    }
                                }
                            }
                        }
                    }
                }));
            }
        }

        //20180405 조용수 면상태일지
        private void GetCottonList(object SelectedItem)
        {
            DataTable _cottonDT = new DataTable();

            DataRowView rowview = SelectedItem as DataRowView;

            if (rowview == null)
                return;

            Util.gridClear(COTTON_GRID);

            DataTable IndataTable = new DataTable();
            IndataTable.Columns.Add("CUT_ID", typeof(string));
            IndataTable.Columns.Add("WIPSEQ", typeof(string));

            DataRow Indata = IndataTable.NewRow();
            Indata["CUT_ID"] = rowview["CUT_ID"].ToString();
            Indata["WIPSEQ"] = rowview["WIPSEQ"].ToString();
            IndataTable.Rows.Add(Indata);

            _cottonDT = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_SLIT_CHK_DATA", "INDATA", "RSLTDT", IndataTable);
            Util.GridSetData(COTTON_GRID, _cottonDT, FrameOperation, true);
        }
        //
        private void GetColorList(object SelectedItem)
        {
            try
            {
                DataTable _colorDT = new DataTable();

                DataRowView rowview = SelectedItem as DataRowView;

                if (rowview == null)
                    return;

                Util.gridClear(COLOR_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("WIPSEQ", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["LOTID"] = rowview["LOTID"].ToString();
                Indata["PROCID"] = procId;
                Indata["EQPTID"] = null;
                Indata["WIPSEQ"] = rowview["WIPSEQ"].ToString();
                IndataTable.Rows.Add(Indata);

                _colorDT = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_COLORTAG_LOT", "INDATA", "RSLTDT", IndataTable);

                if (_colorDT.Rows.Count == 0)
                {
                    Indata["EQPTID"] = _EQPTID;

                    _colorDT = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_COLORTAG", "INDATA", "RSLTDT", IndataTable);
                    Util.GridSetData(COLOR_GRID, _colorDT, FrameOperation, true);
                }
                else
                {
                    Util.GridSetData(COLOR_GRID, _colorDT, FrameOperation, true);
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetDefectTagList(string sLotID)
        {
            try
            {
                if (string.IsNullOrEmpty(sLotID))
                    return;

                Util.gridClear(DEFECT_TAG_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["LOTID"] = sLotID;
                Indata["EQPTID"] = null;
                Indata["PROCID"] = procId;
                IndataTable.Rows.Add(Indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_DEFECT_TAG_LOT", "INDATA", "RSLTDT", IndataTable);

                if (dt.Rows.Count == 0)
                {
                    Indata["LOTID"] = _LOTIDPR;

                    dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_DEFECT_TAG_LOT", "INDATA", "RSLTDT", IndataTable);

                    if (dt.Rows.Count == 0)
                    {
                        Indata["EQPTID"] = _EQPTID;

                        dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_DEFECT_TAG", "INDATA", "RSLTDT", IndataTable);
                        Util.GridSetData(DEFECT_TAG_GRID, dt, FrameOperation, true);
                    }
                    else
                    {
                        Util.GridSetData(DEFECT_TAG_GRID, dt, FrameOperation, true);
                    }
                }
                else
                {
                    Util.GridSetData(DEFECT_TAG_GRID, dt, FrameOperation, true);
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void SetDefectTagInfo(string sLotID)
        {
            try
            {
                if (string.IsNullOrEmpty(sLotID))
                    return;

                Util.gridClear(DEFECT_TAG_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_QUALITY_DEFECT_TAG_LOT", "INDATA", "RSLTDT", IndataTable);

                if (dt.Rows.Count == 0)
                    return;

                bool isChageTag = false;
                foreach (DataRow row in dt.Rows)
                {
                    for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                    {
                        if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNCODE"), row["RESNCODE"]))
                        {
                            DataTableConverter.SetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY", row["CLCTVAL01"]);
                            isChageTag = true;
                            continue;
                        }
                    }
                }

                if (isChageTag)
                    isChangeWipReason = true;
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        // 장착 자재 FOIL, SLURRY 정보 조회 (ACTIVE CORE는 FOIL의 RADIO BUTTON으로 표시)
        private void GetCurrentMount(string sEqptID, string sCoatSide)
        {
            try
            {
                txtCore1.Text = string.Empty;
                txtCore1.Tag = null;
                txtCore2.Text = string.Empty;
                txtCore2.Tag = null;
                txtSlurry1.Text = string.Empty;
                txtSlurry1.Tag = null;
                txtSlurry2.Text = string.Empty;
                txtSlurry2.Tag = null;

                if (isDoubleLayer)
                {
                    txtSlurry11.Text = string.Empty;
                    txtSlurry11.Tag = null;
                    txtSlurry22.Text = string.Empty;
                    txtSlurry22.Tag = null;
                }

                DataTable dtMain = GetCurrentMount(sEqptID);
                Grid grid = null;

                if (dtMain.Rows.Count > 0)
                {
                    int iIdx = 0;

                    // SET FOIL
                    foreach (DataRow _iRow in dtMain.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'"))
                    {
                        if (iIdx == 0)
                        {
                            txtCore1.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtCore1.Tag = "DUMMY";

                            grid = txtCore1.Parent as Grid;
                            if (string.Equals(_iRow["INPUT_STATE_CODE"], "A"))
                                ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked = true;
                            else
                                ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked = false;

                            iIdx++;
                        }
                        else if (iIdx == 1)
                        {
                            txtCore2.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtCore2.Tag = "DUMMY";

                            grid = txtCore2.Parent as Grid;
                            if (string.Equals(_iRow["INPUT_STATE_CODE"], "A"))
                                ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked = true;
                            else
                                ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked = false;

                            break;
                        }
                    }

                    // 단면코터 BACK일시 현재 INPUT_LOTID 자동지정 ( LOT START 시점이 아니면 의미 없음 )
                    //if (isSingleCoater == true)
                    //{
                    //    if (dtMain.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'").Length > 0 && string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                    //        txtCore1.Text = Convert.ToString(LOTID);
                    //}

                    // SET SLURRY
                    iIdx = 0;

                    foreach (DataRow _iRow in dtMain.Select("PRDT_CLSS_CODE = 'ASL'"))
                    {
                        if (iIdx == 0)
                        {
                            txtSlurry1.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtSlurry1.Tag = Convert.ToString(_iRow["MTRLID"]);

                            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                            //_sLotType = Convert.ToString(_iRow["LOTTYPE"]);
                            //_sLotTypeName = Convert.ToString(_iRow["LOTYNAME"]);

                            iIdx++;
                        }
                        else if (iIdx == 1)
                        {
                            txtSlurry2.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtSlurry2.Tag = Convert.ToString(_iRow["MTRLID"]);

                            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                            //_sLotType = Convert.ToString(_iRow["LOTTYPE"]);
                            //_sLotTypeName = Convert.ToString(_iRow["LOTYNAME"]);

                            iIdx++;
                        }
                        else if (iIdx == 2)
                        {
                            txtSlurry11.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtSlurry11.Tag = Convert.ToString(_iRow["MTRLID"]);

                            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                            //_sLotType = Convert.ToString(_iRow["LOTTYPE"]);
                            //_sLotTypeName = Convert.ToString(_iRow["LOTYNAME"]);

                            iIdx++;
                        }
                        else if (iIdx == 3)
                        {
                            txtSlurry22.Text = Convert.ToString(_iRow["INPUT_LOTID"]);
                            txtSlurry22.Tag = Convert.ToString(_iRow["MTRLID"]);

                            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                            //_sLotType = Convert.ToString(_iRow["LOTTYPE"]);
                            //_sLotTypeName = Convert.ToString(_iRow["LOTYNAME"]);

                            break;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private DataTable GetCurrentMount(string sEqptID)
        {
            DataTable dt = new DataTable();
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("EQPTID", typeof(string));

                if (isSingleCoater)
                    IndataTable.Columns.Add("COATING_SIDE_TYPE_CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["EQPTID"] = sEqptID;

                if (isSingleCoater)
                    Indata["COATING_SIDE_TYPE_CODE"] = null;

                IndataTable.Rows.Add(Indata);

                dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_EQPT_CURR_MOUNT_MTRL_CT", "INDATA", "RSLTDT", IndataTable);
            }
            catch (Exception ex) { Util.MessageException(ex); }

            return dt;
        }
        private void SetMountChange()
        {
            // DATA SET
            LGC.GMES.MES.ControlsLibrary.MessageBox.Show(MessageDic.Instance.GetMessage("해당 자재를 변경하시겠습니까?"), null, "Info", MessageBoxButton.OKCancel, MessageBoxIcon.None, (sresult) =>
            {
                if (sresult == MessageBoxResult.OK)
                {
                    SaveMountChange();
                }
            });
        }

        private void SaveMountChange(bool IsCurrentFoil = true, bool IsSlurryTerm = false, bool IsCoreTerm = false, bool IsTopSlurryChange = true, bool IsBackSlurryChange = true,            
            bool IsAcoreChange = true, bool IsBcoreChange = true,
            bool IsTopSlurryL1Change = true, bool IsBackSlurryL1Change = true)
        {
            DataTable mountDt = GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue));

            BizDataSet bizRule = new BizDataSet();
            DataSet indataSet = new DataSet();

            DataTable inDataTable = indataSet.Tables.Add("INDATA");
            inDataTable.Columns.Add("SRCTYPE", typeof(string));
            inDataTable.Columns.Add("IFMODE", typeof(string));
            inDataTable.Columns.Add("EQPTID", typeof(string));
            inDataTable.Columns.Add("USERID", typeof(string));

            DataTable inProduct = indataSet.Tables.Add("INPUT_LOT");
            inProduct.Columns.Add("EQPT_MOUNT_PSTN_ID", typeof(string));
            inProduct.Columns.Add("EQPT_MOUNT_PSTN_STATE", typeof(string));
            inProduct.Columns.Add("MTRLID", typeof(string));
            inProduct.Columns.Add("INPUT_LOTID", typeof(string));
            inProduct.Columns.Add("TERM_FLAG", typeof(string));

            DataTable inTable = indataSet.Tables["INDATA"];
            DataRow newRow = inTable.NewRow();
            newRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
            newRow["IFMODE"] = IFMODE.IFMODE_OFF;
            newRow["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            newRow["USERID"] = LoginInfo.USERID;

            inTable.Rows.Add(newRow);
            Grid grid = null;

            DataTable inMaterial = indataSet.Tables["INPUT_LOT"];

            // PSTN ID QUERY해서 변경하여 변경된것만 체크 후 저장하게 변경 ( 2017-01-23 )
            DataRow[] rows = mountDt.Copy().Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL'");

            if (rows.Length <= 0)
            {
                Util.MessageValidation("SFU2987", new object[] { EQUIPMENT_COMBO.SelectedValue });  //해당 설비({%1})의 등록된 Foil정보가 존재하지 않습니다.
                return;
            }

            // SET CORE
            if (txtCore1.Visibility == Visibility.Visible && rows.Length > 0 && IsCurrentFoil == true && IsAcoreChange == true)
            {
                newRow = null;
                newRow = inMaterial.NewRow();

                grid = txtCore1.Parent as Grid;

                newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[0]["EQPT_MOUNT_PSTN_ID"]);
                newRow["EQPT_MOUNT_PSTN_STATE"] = ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked == true ? !string.IsNullOrEmpty(txtCore1.Text.Trim()) ? "A" : "S" : "S";
                newRow["MTRLID"] = txtCore1.Tag;
                newRow["INPUT_LOTID"] = txtCore1.Text;
                newRow["TERM_FLAG"] = IsCoreTerm ? "Y" : string.Empty;
                inMaterial.Rows.Add(newRow);
            }

            if (txtCore2.Visibility == Visibility.Visible && rows.Length > 1 && IsCurrentFoil == true && IsBcoreChange == true)
            {
                newRow = null;
                newRow = inMaterial.NewRow();

                grid = txtCore2.Parent as Grid;

                newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[1]["EQPT_MOUNT_PSTN_ID"]);
                newRow["EQPT_MOUNT_PSTN_STATE"] = ((RadioButton)grid.Children[grid.Children.Count - 1]).IsChecked == true ? !string.IsNullOrEmpty(txtCore2.Text.Trim()) ? "A" : "S" : "S";
                newRow["MTRLID"] = txtCore2.Tag;
                newRow["INPUT_LOTID"] = txtCore2.Text;
                newRow["TERM_FLAG"] = IsCoreTerm ? "Y" : string.Empty;

                inMaterial.Rows.Add(newRow);
            }

            // SET SLURRY
            rows = null;
            rows = mountDt.Copy().Select("PRDT_CLSS_CODE = 'ASL'");

            if (rows.Length <= 0)
            {
                Util.MessageValidation("SFU2988", new object[] { EQUIPMENT_COMBO.SelectedValue });  //해당 설비({%1})의 등록된 Slurry정보가 존재하지 않습니다.
                return;
            }

            if (txtSlurry1.Visibility == Visibility.Visible && rows.Length > 0 && IsTopSlurryChange == true)
            {
                newRow = null;
                newRow = inMaterial.NewRow();

                newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[0]["EQPT_MOUNT_PSTN_ID"]);
                newRow["EQPT_MOUNT_PSTN_STATE"] = !string.IsNullOrEmpty(txtSlurry1.Text) ? "A" : "S";
                newRow["MTRLID"] = txtSlurry1.Tag;
                newRow["INPUT_LOTID"] = txtSlurry1.Text;
                newRow["TERM_FLAG"] = IsSlurryTerm ? "Y" : string.Empty;

                inMaterial.Rows.Add(newRow);
            }

            if (txtSlurry2.Visibility == Visibility.Visible && rows.Length > 1 && IsBackSlurryChange == true)
            {
                newRow = null;
                newRow = inMaterial.NewRow();

                newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[1]["EQPT_MOUNT_PSTN_ID"]);
                newRow["EQPT_MOUNT_PSTN_STATE"] = !string.IsNullOrEmpty(txtSlurry2.Text) ? "A" : "S";
                newRow["MTRLID"] = txtSlurry2.Tag;
                newRow["INPUT_LOTID"] = txtSlurry2.Text;
                newRow["TERM_FLAG"] = IsSlurryTerm ? "Y" : string.Empty;

                inMaterial.Rows.Add(newRow);
            }

            if (!isSingleCoater)
            {
                if (txtSlurry11.Visibility == Visibility.Visible && rows.Length > 2 && IsTopSlurryL1Change == true)
                {
                    newRow = null;
                    newRow = inMaterial.NewRow();

                    newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[2]["EQPT_MOUNT_PSTN_ID"]);
                    newRow["EQPT_MOUNT_PSTN_STATE"] = !string.IsNullOrEmpty(txtSlurry11.Text) ? "A" : "S";
                    newRow["MTRLID"] = txtSlurry11.Tag;
                    newRow["INPUT_LOTID"] = txtSlurry11.Text;
                    newRow["TERM_FLAG"] = IsSlurryTerm ? "Y" : string.Empty;

                    inMaterial.Rows.Add(newRow);
                }

                if (txtSlurry22.Visibility == Visibility.Visible && rows.Length > 3 && IsBackSlurryL1Change == true)
                {
                    newRow = null;
                    newRow = inMaterial.NewRow();

                    newRow["EQPT_MOUNT_PSTN_ID"] = Util.NVC(rows[3]["EQPT_MOUNT_PSTN_ID"]);
                    newRow["EQPT_MOUNT_PSTN_STATE"] = !string.IsNullOrEmpty(txtSlurry22.Text) ? "A" : "S";
                    newRow["MTRLID"] = txtSlurry22.Tag;
                    newRow["INPUT_LOTID"] = txtSlurry22.Text;
                    newRow["TERM_FLAG"] = IsSlurryTerm ? "Y" : string.Empty;

                    inMaterial.Rows.Add(newRow);
                }
            }
            if (inMaterial.Rows.Count == 0)
                return;

            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_START_USE_MTRL_LOT_CT", "INDATA,INPUT_LOT", null, (result, ex) =>
            {
                if (ex != null)
                {
                    //Util.AlertByBiz("BR_PRD_REG_START_USE_MTRL_LOT_CT", ex.Message, ex.ToString());
                    Util.MessageException(ex);
                    return;
                }

                Util.MessageInfo("SFU1275");    //정상 처리 되었습니다.

                if (isSingleCoater)
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), Util.NVC(COATTYPE_COMBO.SelectedValue));
                else
                    GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue), "");

            }, indataSet);
        }

        private DataTable GetProcessVersion(string sLotID, string sModlID)
        {
            // VERSION, LANE수를 룰에 따라 가져옴 [2017-02-17]
            DataTable dt = new DataTable();
            try
            {
                DataTable inTable = new DataTable();
                inTable.Columns.Add("EQSGID", typeof(string));
                inTable.Columns.Add("PROCID", typeof(string));
                inTable.Columns.Add("EQPTID", typeof(string));
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("MODLID", typeof(string));
                inTable.Columns.Add("PROCSTATE", typeof(string));
                inTable.Columns.Add("TOPLOTID", typeof(string));

                DataRow indata = inTable.NewRow();
                indata["EQSGID"] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                indata["PROCID"] = procId;
                indata["EQPTID"] = _EQPTID;
                indata["LOTID"] = sLotID;
                indata["MODLID"] = sModlID;

                if (isCoaterAfterProcess)
                    indata["PROCSTATE"] = "Y";

                if (string.Equals(procId, Process.COATING) && isSingleCoater && string.Equals(COATTYPE_COMBO.SelectedValue, "B"))
                {
                    //indata["PROCSTATE"] = "Y";

                    DataTable mountDt = GetCurrentMount(Util.NVC(EQUIPMENT_COMBO.SelectedValue));

                    if (mountDt.Rows.Count > 0)
                    {
                        DataRow[] rows = mountDt.Select("PRDT_CLSS_CODE <> 'ASL' AND MTRL_CLSS_CODE = 'MFL' AND INPUT_STATE_CODE = 'A'");
                        if (rows.Length > 0)
                            indata["TOPLOTID"] = Util.NVC(rows[0]["INPUT_LOTID"]);
                    }
                }

                inTable.Rows.Add(indata);

                dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_LOT_INFO_DEFAULT", "INDATA", "RSLTDT", inTable);
            }
            catch (Exception ex) { Util.MessageException(ex); }

            return dt;
        }

        // RESN 횟수 추가로 공통코드로 추가 (C20190416_75868) [2019-04-16]
        private string GetCommonCode(string sCodeType, string sCodeName)
        {
            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("CMCDTYPE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = sCodeType;
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE", "RQSTDT", "RSLTDT", RQSTDT);

                foreach (DataRow row in dtResult.Rows)
                    if (string.Equals(sCodeName, row["CBO_CODE"]))
                        return Util.NVC(row["ATTRIBUTE1"]);
            }
            catch (Exception ex) { }

            return "";
        }

        private bool IsAreaCommonCodeUse(string sCodeType, string sCodeName)
        {
            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("AREAID", typeof(string));
                RQSTDT.Columns.Add("COM_TYPE_CODE", typeof(string));
                RQSTDT.Columns.Add("COM_CODE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["AREAID"] = LoginInfo.CFG_AREA_ID;
                dr["COM_TYPE_CODE"] = sCodeType;
                dr["COM_CODE"] = sCodeName;
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_FOR_AREA", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                    return true;
            }
            catch (Exception ex) { }

            return false;
        }

        private bool IsCommoncodeUse(string sCodeType,  string sCmCode)
        {
            bool bFlag = false;

            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("CMCDTYPE", typeof(String));
                RQSTDT.Columns.Add("CMCODE", typeof(String));

                DataRow dr = RQSTDT.NewRow();
                dr["CMCDTYPE"] = sCodeType;
                dr["CMCODE"] = sCmCode;
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult.Rows.Count > 0)
                    bFlag = true;

                return bFlag;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        private bool IsCommoncodeAttrUse(string sCodeType, string sCmCode, string[] sAttribute)
        {
            try
            {
                string[] sColumnArr = { "ATTRIBUTE1", "ATTRIBUTE2", "ATTRIBUTE3", "ATTRIBUTE4", "ATTRIBUTE5" };

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                RQSTDT.Columns.Add("CMCODE", typeof(string));
                for (int i = 0; i < sColumnArr.Length; i++)
                    RQSTDT.Columns.Add(sColumnArr[i], typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = sCodeType;
                dr["CMCODE"] = (sCmCode == string.Empty ? null : sCmCode);
                for (int i = 0; i < sAttribute.Length; i++)
                    dr[sColumnArr[i]] = string.IsNullOrEmpty(sAttribute[i]) ? (object)DBNull.Value : sAttribute[i];
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL_BY_ATTRIBUTES", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    if (sCodeType == "PROD_QTY_DEFAULT_AREA_PROC")
                        LossLackQty = (Util.NVC(dtResult.Rows[0]["ATTRIBUTE5"].ToString()) == "" ? 50 : Convert.ToDouble(dtResult.Rows[0]["ATTRIBUTE5"].ToString()));
                    else if (sCodeType == "DEFECT_COLUMN_VISIBILITY")
                        sBarCodeTagChk = (Util.NVC(dtResult.Rows[0]["ATTRIBUTE3"].ToString()) == "" ? "Y" : dtResult.Rows[0]["ATTRIBUTE3"].ToString());  

                    return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }
        /// <summary>
        /// 믹서 코터 배치 연계 고도화 사이트 여부(동기준) - 공통코드(ROLLMAP_MIX_COT_LINK_ADVANCE_SITE)
        /// </summary>
        private bool IsMixCotLinkedAdvanceSite()
        {
            try
            {
                string eqptId = Util.NVC(EQUIPMENT_COMBO.SelectedValue);

                if (eqptId.IsNullOrEmpty())
                    return false;

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                RQSTDT.Columns.Add("CMCODE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = "ROLLMAP_MIX_COT_LINK_ADVANCE_SITE";
                dr["CMCODE"] = LoginInfo.CFG_AREA_ID;
                
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                    return true;
                else
                    return false;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }
        // C20221212-000326 - SMPL Print Count 가져오기 -2023.02.21
        private int GetProcSmplBarPrtFlagAttribute3()
        {

            int iProcSmplBarPrtCnt = 0;
            string sCodeType;
            string sCmCode;
            string[] sAttribute = { LoginInfo.CFG_AREA_ID, procId };


            sCodeType = "PROC_SMPL_BAR_PRT_FLAG";
            sCmCode = null;

            try
            {
                string[] sColumnArr = { "ATTRIBUTE1", "ATTRIBUTE2", "ATTRIBUTE3", "ATTRIBUTE4", "ATTRIBUTE5" };

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                RQSTDT.Columns.Add("CMCODE", typeof(string));
                for (int i = 0; i < sColumnArr.Length; i++)
                    RQSTDT.Columns.Add(sColumnArr[i], typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = sCodeType;
                dr["CMCODE"] = (sCmCode == string.Empty ? null : sCmCode);
                for (int i = 0; i < sAttribute.Length; i++)
                    dr[sColumnArr[i]] = string.IsNullOrEmpty(sAttribute[i]) ? (object)DBNull.Value : sAttribute[i];
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL_BY_ATTRIBUTES", "RQSTDT", "RSLTDT", RQSTDT);

                iProcSmplBarPrtCnt = 0;

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    iProcSmplBarPrtCnt = Util.NVC_Int(dtResult.Rows[0]["ATTRIBUTE3"].ToString());

                    //공통 코드 속성3 , 미입력 및 -값 이면 0, 양수이면 수치값만큼 추가 인쇄
                    if (iProcSmplBarPrtCnt < 1)
                    {
                        iProcSmplBarPrtCnt = 0;
                    };

                }
                else
                {
                    iProcSmplBarPrtCnt = 0;
                }

                return iProcSmplBarPrtCnt;
            }
            catch (Exception ex)
            {
                // Util.MessageException(ex);
                iProcSmplBarPrtCnt = 0;
                return iProcSmplBarPrtCnt;
            }
        }
        // [E20230228-000007] CSR - Marking logic in GMES
        private string GetCutLotSampleQAFalg(string sLotID, string sProcID)
        {
            try
            {

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                Indata["PROCID"] = sProcID;
                IndataTable.Rows.Add(Indata);


                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_SAMPLE_TARGET_CT", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                    return Util.NVC(result.Rows[0]["SAMPLE_FLAG"]);
            }
            catch (Exception ex)
            {
                return "";
            }

            return "";
        }

        // [E20230127-000272] 코터 공정진척 2번컷 특이사항 자동 입력 건
        private string GetUnstblSectionWupNote(string sAreaID, string sProcID, string sLotID)
        {
            try
            {

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));


                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = sAreaID;
                Indata["PROCID"] = sProcID;
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);


                DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_TB_MMD_AREA_COM_CODE_UNSTBL_WIPNOTE", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                    return Util.NVC(result.Rows[0]["ATTR4"]);
            }
            catch (Exception ex)
            {
                return "";
            }

            return "";
        }

        // [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청
        private bool IsAreaCommoncodeAttrUse(string sCodeType, string sCodeName, string[] sAttribute)
        {
            try
            {
                string[] sColumnArr = { "ATTR1", "ATTR2", "ATTR3", "ATTR4", "ATTR5" };

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("AREAID", typeof(string));
                RQSTDT.Columns.Add("COM_TYPE_CODE", typeof(string));
                RQSTDT.Columns.Add("COM_CODE", typeof(string));
                RQSTDT.Columns.Add("USE_FLAG", typeof(string));
                for (int i = 0; i < sColumnArr.Length; i++)
                    RQSTDT.Columns.Add(sColumnArr[i], typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["AREAID"] = LoginInfo.CFG_AREA_ID;
                dr["COM_TYPE_CODE"] = sCodeType;
                dr["COM_CODE"] = !string.IsNullOrEmpty(sCodeName) ? sCodeName : null;
                dr["USE_FLAG"] = 'Y';
                for (int i = 0; i < sAttribute.Length; i++)
                    dr[sColumnArr[i]] = string.IsNullOrEmpty(sAttribute[i]) ? (object)DBNull.Value : sAttribute[i];
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_ATTR", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                    return true;

                return false;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        // [E20231103-001744] [ESMI] 공정진척(R/N/S) 화면의 시작취소/장비완료취소 버튼 접근 제한 요청
        private bool CheckButtonPermissionGroupByBtnGroupID(string sBtnGrpID)
        {
            try
            {
                bool bRet = false;

                DataTable inTable = new DataTable();
                inTable.Columns.Add("USERID", typeof(string));
                inTable.Columns.Add("AREAID", typeof(string));
                inTable.Columns.Add("PROCID", typeof(string));
                inTable.Columns.Add("EQGRID", typeof(string));

                DataRow dtRow = inTable.NewRow();
                dtRow["USERID"] = LoginInfo.USERID;
                dtRow["AREAID"] = LoginInfo.CFG_AREA_ID;
                dtRow["PROCID"] = procId;
                inTable.Rows.Add(dtRow);

                DataTable dtRslt = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_BTN_PERMISSION_GRP_V01", "INDATA", "OUTDATA", inTable);

                if (CommonVerify.HasTableRow(dtRslt))
                {
                    DataRow[] drs = dtRslt.Select("BTN_PMS_GRP_CODE = '" + sBtnGrpID + "'");
                    if (drs?.Length > 0)
                        bRet = true;
                }

                if (bRet == false)
                {
                    string objectmessage = string.Empty;

                    if (sBtnGrpID == "CANCEL_LOTSTART_W")
                        objectmessage = ObjectDic.Instance.GetObjectName("시작취소");
                    else if (sBtnGrpID == "CANCEL_EQPT_END_W")
                        objectmessage = ObjectDic.Instance.GetObjectName("장비완료취소");
                    else if (sBtnGrpID == "CONFIRM_W")
                        objectmessage = ObjectDic.Instance.GetObjectName("실적확정");
                    else if (sBtnGrpID == "EQPT_END_W")
                        objectmessage = ObjectDic.Instance.GetObjectName("장비완료");

                    Util.MessageValidation("SFU3520", LoginInfo.USERID, objectmessage);     // 해당 USER[%1]는 권한[%2]을 가지고 있지 않습니다.
                }

                return bRet;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        #endregion

        #region Material
        private void GetMaterial(string sLotID)
        {
            try
            {
                Util.gridClear(INPUTMTRL_GRID);

                string bizRuleName;
                if (isRollMapEquipment && string.Equals(procId, Process.COATING))
                {
                    bizRuleName = "DA_PRD_SEL_CONSUME_MATERIAL2_RM"; // DA_PRD_SEL_ROLLMAP_CONSUME_SLURRY
                }
                else
                {
                    // CSR : C20220713-000401 - 테이핑 공정
                    if (string.Equals(procId, Process.TAPING))
                    {
                        bizRuleName = "DA_PRD_SEL_CONSUME_MATERIAL_MO";
                        SetGridComboItemTP(INPUTMTRL_GRID.Columns["MTRLID"], sLotID);
                    }
                    else
                    {
                        bizRuleName = "DA_PRD_SEL_CONSUME_MATERIAL2";
                        SetGridComboItem(INPUTMTRL_GRID.Columns["MTRLID"], _WORKORDER);
                    }
                }

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LANGID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));

                if (isRollMapEquipment && string.Equals(procId, Process.COATING))
                {
                    IndataTable.Columns.Add("EQPTID", typeof(string));
                    IndataTable.Columns.Add("WIPSEQ", typeof(string));
                }

                if (string.Equals(procId, Process.TAPING))
                {
                    IndataTable.Columns.Add("MTRLTYPE", typeof(string));
                }

                DataRow Indata = IndataTable.NewRow();
                Indata["LANGID"] = LoginInfo.LANGID;
                Indata["LOTID"] = sLotID;

                if (isRollMapEquipment && string.Equals(procId, Process.COATING))
                {
                    Indata["EQPTID"] = _EQPTID;
                    Indata["WIPSEQ"] = _WIPSEQ;
                }

                if (string.Equals(procId, Process.TAPING))
                {
                    Indata["MTRLTYPE"] = "MTP";
                }
                IndataTable.Rows.Add(Indata);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync(bizRuleName, "INDATA", "RSLTDT", IndataTable);

                Util.GridSetData(INPUTMTRL_GRID, dtResult, FrameOperation, true);
                //INPUTMTRL_GRID.ItemsSource = DataTableConverter.Convert(dtResult);
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        private void GetMaterialHistory()
        {
            if (isRollMapEquipment && string.Equals(procId, Process.ROLL_PRESSING))
            {
                const string bizRuleName = "DA_PRD_SEL_ROLLMAP_CONSUME_ROLL";

                DataTable inTable = new DataTable("RQSTDT");
                inTable.Columns.Add("LANGID", typeof(string));
                inTable.Columns.Add("EQPTID", typeof(string));
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIPSEQ", typeof(string));

                DataRow dr = inTable.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["EQPTID"] = _EQPTID;
                dr["LOTID"] = _LOTID;
                dr["WIPSEQ"] = _WIPSEQ;
                inTable.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync(bizRuleName, "RQSTDT", "RSLTDT", inTable);
                Util.GridSetData(INPUTMTRLHIST_GRID, dtResult, FrameOperation, true);
            }
        }

        //20170109 유관수 자재표시 규격 추가
        protected virtual void OnMaterialCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            try
            {
                if (!INPUTMTRL_GRID.CurrentCell.IsEditing)
                {
                    if (INPUTMTRL_GRID.CurrentCell.Column.Name.Equals("MTRLID"))
                    {
                        string sMTRLNAME;
                        string vMTRLID = Util.NVC(DataTableConverter.GetValue(INPUTMTRL_GRID.CurrentRow.DataItem, "MTRLID"));

                        if (vMTRLID.Equals(""))
                        {
                            return;
                        }
                        else
                        {
                            DataTable dt = new DataTable();
                            dt.Columns.Add("MTRLID", typeof(string));

                            DataRow row = dt.NewRow();
                            row["MTRLID"] = vMTRLID;
                            dt.Rows.Add(row);

                            DataTable result = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_MATERIAL_MTRLDESC", "INDATA", "RSLTDT", dt);
                            if (result.Rows.Count > 0)
                            {
                                sMTRLNAME = result.Rows[0]["MTRLDESC"].ToString();
                                DataTableConverter.SetValue(INPUTMTRL_GRID.Rows[INPUTMTRL_GRID.SelectedIndex].DataItem, "MTRLDESC", sMTRLNAME);

                                DataTable dt2 = (INPUTMTRL_GRID.ItemsSource as DataView).Table;
                                Util.GridSetData(INPUTMTRL_GRID, dt2, FrameOperation, true);

                            }
                        }
                    }
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }
        }

        // LOSS 횟수 지정을 위해서 하단의 2개 이벤트 추가 (2017-01-09)
        protected virtual void OnDataGridBeginningEdit(object sender, C1.WPF.DataGrid.DataGridBeginningEditEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
            // 횟수 전 공정 추가로 수정 (C20190416_75868) [2019-04-16]
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (isResnCountUse == true && (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING)))
            {
                //if (string.Equals(dataGrid.Name, "dgLoss") || string.Equals(dataGrid.Name, "dgLoss2") ||
                //    string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "LOSS_LOT"))
                if (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "DEFECT_LOT") ||
                    string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "LOSS_LOT"))
                {
                    if (string.Equals(e.Column.Name, "COUNTQTY") && string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y") &&
                        string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "LINK_DETL_RSN_CODE_TYPE"))))
                        return;
                }

                if (string.Equals(e.Column.Name, "COUNTQTY"))
                    e.Cancel = true;
            }
            // 슬리터 2차 추가 2021-09-15 by 오화백
            else if (isResnCountUse == true && (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING)))
            {
                if (string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "DEFECT_LOT") ||
                    string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "ACTID"), "LOSS_LOT"))
                {
                    if (e.Column.Name.Length == 13 && e.Column.Name.Contains("NUM") == true && string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y") &&
                        string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(dataGrid.Rows[e.Row.Index].DataItem, "LINK_DETL_RSN_CODE_TYPE"))))
                        return;
                }

                if (e.Column.Name.Length == 13 && e.Column.Name.Contains("NUM") == true)
                    e.Cancel = true;
            }
        }

        protected virtual void OnDataGridKeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.Key == Key.LeftCtrl)
                {
                    Util.MessageValidation("SFU3180");  //복사 및 붙여넣기 금지.
                    return;
                }
            }
            catch (Exception ex)
            {
                throw (ex);
            }
        }
        
        protected virtual void OnLoadedLotInfoCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (e.Cell != null && e.Cell.Presenter != null)
                    {
                        if (e.Cell.Row.Type == DataGridRowType.Bottom)
                        {
                            if (e != null && e.Cell != null && e.Cell.Presenter != null)
                            {
                                if (!string.Equals(procId, Process.PRE_MIXING) && !string.Equals(procId, Process.MIXING) && !string.Equals(procId, Process.SRS_MIXING))
                                {
                                    if (LOTINFO_GRID.GetRowCount() > 0)
                                    {
                                        if (e.Cell.Column.Visibility == Visibility.Visible)
                                        {
                                            TextBlock sContents = e.Cell.Presenter.Content as TextBlock;

                                            int iSourceIdx = e.Cell.Row.Index - (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) + LOTINFO_GRID.TopRows.Count;

                                            if (DataTableConverter.Convert(LOTINFO_GRID.ItemsSource).Columns.Contains(e.Cell.Column.Name))
                                            {
                                                string sValue = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[iSourceIdx].DataItem, e.Cell.Column.Name));

                                                /*
                                                if (string.Equals(e.Cell.Column.Name, "GOODPTNQTY"))
                                                {
                                                    string sGoodQty = (LOTINFO_GRID.GetCell(e.Cell.Row.Index, LOTINFO_GRID.Columns["GOODQTY"].Index).Presenter.Content as TextBlock).Text;
                                                    string sLaneQty = string.Empty;

                                                    if ( isCoaterAfterProcess)
                                                        sLaneQty = Util.NVC(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "LANE_QTY"));
                                                    else
                                                        sLaneQty = Util.NVC(txtLaneQty.Value);

                                                    sContents.Text = GetUnitFormatted(Math.Round(Convert.ToDouble(Util.NVC_Decimal(string.IsNullOrEmpty(sGoodQty) ? "0" : sGoodQty) * 
                                                        Util.NVC_Decimal(string.IsNullOrEmpty(sLaneQty) ? "0" : sLaneQty))), "M");
                                                }
                                                */
                                                if (string.Equals(e.Cell.Column.Name, "LANE_QTY"))
                                                {
                                                    sContents.Text = sValue;
                                                }
                                                else
                                                {
                                                    if (e.Cell.Column.GetType() == typeof(DataGridNumericColumn))
                                                        sContents.Text = GetUnitFormatted(Convert.ToDouble(Util.NVC_Decimal(string.IsNullOrEmpty(sValue) ? "0" : sValue) * convRate), "EA");
                                                    else
                                                        sContents.Text = sValue;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }));
            }
        }

        protected virtual void OnLoadedCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (e.Cell != null && e.Cell.Presenter != null)
                    {
                        if (e.Cell.Row.Type == DataGridRowType.Item)
                        {
                            if (e != null && e.Cell != null && e.Cell.Presenter != null)
                            {
                                //if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                                // 횟수 전 공정 추가로 수정 (C20190416_75868)  [2019-04-16]
                                // 슬리터 2차 추가  2021-09-15  by 오화백 
                                if (isResnCountUse == true && (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING)))
                                {
                                    if (string.Equals(e.Cell.Column.Name, "COUNTQTY") && !string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Cell.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y"))
                                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.LightGray);
                                }
                                // 슬리터 2차 추가 2021-09-15 by 오화백
                                else if (isResnCountUse == true && (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING)))
                                {
                                    if (e.Cell.Column.Name.Length == 13 && e.Cell.Column.Name.Contains("NUM") == true && !string.Equals(DataTableConverter.GetValue(dataGrid.Rows[e.Cell.Row.Index].DataItem, "WRK_COUNT_MNGT_FLAG"), "Y"))
                                        e.Cell.Presenter.Background = new SolidColorBrush(Colors.LightGray);
                                }
                            }
                        }
                    }
                }));
            }
        }

        protected virtual void OnUnLoadedCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (e.Cell != null && e.Cell.Presenter != null)
                    {
                        if (e.Cell.Row.Type == DataGridRowType.Item)
                        {
                            if (e != null && e.Cell != null && e.Cell.Presenter != null)
                            {
                                if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.BACK_COATING))
                                    e.Cell.Presenter.Background = null;
                            }
                        }
                    }
                }));
            }
        }

        protected virtual void OnLoadedWipReasonCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                if (e.Cell.Row.Type == DataGridRowType.Bottom)
                {
                    StackPanel panel = e.Cell.Presenter.Content as StackPanel;
                    ContentPresenter presenter = panel.Children[0] as ContentPresenter;

                    if (e.Cell.Column.Index == dataGrid.Columns["ACTNAME"].Index)
                    {
                        if (e.Cell.Row.Index == (dataGrid.Rows.Count - 2))
                            presenter.Content = ObjectDic.Instance.GetObjectName("불량수량");
                        else if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                            presenter.Content = ObjectDic.Instance.GetObjectName("양품수량");
                    }
                    else if (e.Cell.Column.Index == dataGrid.Columns["RESNTOTQTY"].Index)
                    {
                        if (LOTINFO_GRID.GetRowCount() > 0)
                            if (e.Cell.Row.Index == (dataGrid.Rows.Count - 2))
                                presenter.Content = GetUnitFormatted((Util.NVC_Decimal(presenter.Content) - (exceedLengthQty * LOTINFO_GRID.GetRowCount())));
                            else if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                                presenter.Content = GetUnitFormatted((Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) * LOTINFO_GRID.GetRowCount()) - (Util.NVC_Decimal(presenter.Content) - (exceedLengthQty * LOTINFO_GRID.GetRowCount())));
                    }
                    /*
                    else if (dataGrid.Columns["ALL"].Index < e.Cell.Column.Index && dataGrid.Columns["COSTCENTERID"].Index > e.Cell.Column.Index)
                    {
                        if (LOTINFO_GRID.GetRowCount() > 0)
                        {
                            if (e.Cell.Row.Index == (dataGrid.Rows.Count - 2))
                                presenter.Content = GetUnitFormatted(Convert.ToDouble(presenter.Content) - exceedLengthQty);
                            else if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                                presenter.Content = GetUnitFormatted(Convert.ToDouble(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) - (Convert.ToDouble(presenter.Content) - exceedLengthQty));
                        }
                    }
                    */
                    else
                    {
                        if (LOTINFO_GRID.GetRowCount() > 0)
                        {
                            if (e.Cell.Row.Index == (dataGrid.Rows.Count - 2))
                                presenter.Content = GetUnitFormatted(Util.NVC_Decimal(presenter.Content) - exceedLengthQty);
                            else if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                                presenter.Content = GetUnitFormatted(Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY")) - (Util.NVC_Decimal(presenter.Content) - exceedLengthQty));
                        }
                    }
                }
            }
        }
        
        protected virtual void OnLoadedProdLotCellPresenter(object sender, DataGridCellEventArgs e)
        {
            this.Dispatcher.BeginInvoke(new Action(() =>
            {
                if (e == null || sender == null)
                    return;

                C1DataGrid dg = sender as C1DataGrid;
                C1.WPF.DataGrid.DataGridCell cell = e.Cell as C1.WPF.DataGrid.DataGridCell;

                if (dg == null || cell == null || cell.Presenter == null)
                    return;

                if (Util.NVC(e.Cell.Column.Name).IsNullOrEmpty())
                    return;

                // 2020.07.07 공정 Interlock - 범례 표시 공정이 아닌 경우 보완 
                if (WIPCOLORLEGEND == null)
                    return;

                // 2020.07.06 공정 Interlock - 4M 검증 Sample 전극버전(Z로 같이 사용)의 경우 녹색으로 표시 기능 추가
                SolidColorBrush scbZVersionBack = new SolidColorBrush();
                SolidColorBrush scbZVersionFore = new SolidColorBrush();

                SolidColorBrush scbCutBack = new SolidColorBrush();
                SolidColorBrush scbCutFore = new SolidColorBrush();

                foreach (DataRow dr in WIPCOLORLEGEND.Rows)
                {
                    if (dr["COLOR_BACK"].ToString().IsNullOrEmpty() || dr["COLOR_FORE"].ToString().IsNullOrEmpty())
                    {
                        continue;
                    }

                    if (dr["CODE"].ToString().Equals("Z_VER"))
                    {
                        scbZVersionBack = new BrushConverter().ConvertFromString(dr["COLOR_BACK"].ToString()) as SolidColorBrush;
                        scbZVersionFore = new BrushConverter().ConvertFromString(dr["COLOR_FORE"].ToString()) as SolidColorBrush;
                    }
                    else if (dr["CODE"].ToString().Equals("CUT"))
                    {
                        scbCutBack = new BrushConverter().ConvertFromString(dr["COLOR_BACK"].ToString()) as SolidColorBrush;
                        scbCutFore = new BrushConverter().ConvertFromString(dr["COLOR_FORE"].ToString()) as SolidColorBrush;
                    }

                }
              
                if (string.Equals(procId, Process.COATING))
                {
                    if ( (e.Cell.Column.Name.Equals("LOTID") && Util.NVC(DataTableConverter.GetValue(cell.Row.DataItem, "CUT")).Equals("1") )
                    || (e.Cell.Column.Name.Equals("LOTID") && string.Equals(GetCutLotSampleQAFalg(Util.NVC(DataTableConverter.GetValue(dg.Rows[e.Cell.Row.Index].DataItem, "LOTID")), Process.COATING), "Y"))) // [E20230228-000007] CSR - Marking logic in GMES
                    {
                        e.Cell.Presenter.SelectedBackground = scbCutBack;
                        e.Cell.Presenter.Background = scbCutBack;
                        e.Cell.Presenter.Foreground = scbCutFore;
                    }
                    else if (e.Cell.Column.Name.Equals("LOTID") && ((DataRowView)e.Cell.Row.DataItem).DataView.Table.Columns["COATERVER"] != null &&
                                Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Length >= 1 &&
                                Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Substring(0, 1).Equals("Z"))
                    {
                        e.Cell.Presenter.Background = scbZVersionBack;
                        e.Cell.Presenter.Foreground = scbZVersionFore;
                    }
                    else
                    {
                        e.Cell.Presenter.SelectedBackground = dg.SelectedBackground;
                        e.Cell.Presenter.Background = dg.Background;
                        e.Cell.Presenter.Foreground = dg.Foreground;
                    }
                }
                else if (string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.TAPING))
                {
                    if (e.Cell.Column.Name.Equals("LOTID") && !Util.NVC(DataTableConverter.GetValue(cell.Row.DataItem, "QA_INSP_TRGT_FLAG")).IsNullOrEmpty() &&
                            Util.NVC(DataTableConverter.GetValue(cell.Row.DataItem, "QA_INSP_TRGT_FLAG")).Equals("Y"))
                    {
                        e.Cell.Presenter.SelectedBackground = scbCutBack;
                        e.Cell.Presenter.Background = scbCutBack;
                        e.Cell.Presenter.Foreground = scbCutFore;
                    }
                    else if (e.Cell.Column.Name.Equals("LOTID_PR") && Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "WIPSTAT")).Equals(Wip_State.WAIT) &&
                            ((DataRowView)e.Cell.Row.DataItem).DataView.Table.Columns["COATERVER"] != null &&
                            Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Length >= 1 &&
                            Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Substring(0, 1).Equals("Z"))
                    {
                        e.Cell.Presenter.Background = scbZVersionBack;
                        e.Cell.Presenter.Foreground = scbZVersionFore;
                    }
                    else if (e.Cell.Column.Name.Equals("LOTID") && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "WIPSTAT")).Equals(Wip_State.WAIT) &&
                            ((DataRowView)e.Cell.Row.DataItem).DataView.Table.Columns["COATERVER"] != null &&
                            Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Length >= 1 &&
                            Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Substring(0, 1).Equals("Z"))
                    {
                        e.Cell.Presenter.Background = scbZVersionBack;
                        e.Cell.Presenter.Foreground = scbZVersionFore;
                    }
                    else
                    {
                        e.Cell.Presenter.SelectedBackground = dg.SelectedBackground;
                        e.Cell.Presenter.Background = dg.Background;
                        e.Cell.Presenter.Foreground = dg.Foreground;
                    }

                }
                //슬리터 2차 추가  2021-09-15 by 오화백
                else if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                {
                    //슬리터 
                    if (e.Cell.Column.Name.Equals("CUT_ID") && !Util.NVC(DataTableConverter.GetValue(cell.Row.DataItem, "QA_INSP_TRGT_FLAG")).IsNullOrEmpty() &&
                               Util.NVC(DataTableConverter.GetValue(cell.Row.DataItem, "QA_INSP_TRGT_FLAG")).Equals("Y"))
                    {
                        e.Cell.Presenter.SelectedBackground = scbCutBack;
                        e.Cell.Presenter.Background = scbCutBack;
                        e.Cell.Presenter.Foreground = scbCutFore;
                    }
                    else if (e.Cell.Column.Name.Equals("LOTID_PR") && Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "WIPSTAT")).Equals(Wip_State.WAIT) &&
                               ((DataRowView)e.Cell.Row.DataItem).DataView.Table.Columns["COATERVER"] != null &&
                               Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Length >= 1 &&
                               Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Substring(0, 1).Equals("Z"))
                    {
                        e.Cell.Presenter.Background = scbZVersionBack;
                        e.Cell.Presenter.Foreground = scbZVersionFore;
                    }
                    else if (e.Cell.Column.Name.Equals("CUT_ID") && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "WIPSTAT")).Equals(Wip_State.WAIT) &&
                                ((DataRowView)e.Cell.Row.DataItem).DataView.Table.Columns["COATERVER"] != null &&
                                Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Length >= 1 &&
                                Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "COATERVER")).Substring(0, 1).Equals("Z"))
                    {
                        e.Cell.Presenter.Background = scbZVersionBack;
                        e.Cell.Presenter.Foreground = scbZVersionFore;
                    }
                    else
                    {
                        e.Cell.Presenter.SelectedBackground = dg.SelectedBackground;
                        e.Cell.Presenter.Background = dg.Background;
                        e.Cell.Presenter.Foreground = dg.Foreground;
                    }
                }
            }));
        }
        protected virtual void OnUnloadedProdLotCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                if (e.Cell != null && e.Cell.Presenter != null)
                {
                    if (e.Cell.Row.Type == DataGridRowType.Item)
                    {
                        if (e != null && e.Cell != null && e.Cell.Presenter != null)
                        {
                            //슬리터 2차 추가  2021-09-15 by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                            {
                                if (!string.Equals(e.Cell.Column.Name, "CUT_ID"))
                                {
                                    e.Cell.Presenter.SelectedBackground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromArgb(255, 255, 208, 218));
                                    e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                                }
                            }
                            else
                            {
                                if (dataGrid.Columns["LOTID"].Index != e.Cell.Column.Index)
                                {
                                    e.Cell.Presenter.SelectedBackground = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromArgb(255, 255, 208, 218));
                                    e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                                }
                            }
                        }
                    }
                }
            }
        }
        private void ClctaMean()
        {
            if (string.Equals(procId, Process.ROLL_PRESSING))
            {
                    DataTable dataCollect = DataTableConverter.Convert(QUALITY_GRID.ItemsSource);

                    decimal sumValue = 0;
                    decimal sumValue2 = 0;
                    decimal sumValue3 = 0;
                    decimal sumValue4 = 0;
                    int iHGcount1 = 0;
                    int iHGcount2 = 0;
                    int iHGcount3 = 0;
                    int iHGcount4 = 0;
                    int rowcount = 0;
                    decimal cslValue1 = 0;
                    decimal cslValue2 = 0;
                    decimal cslValue3 = 0;
                    decimal cslValue4 = 0;
                    int roll_avg1 = 0;
                    int roll_avg2 = 0;
                    int meanIndex = QUALITY_GRID.Columns["MEAN"].Index;
                    

                try
                {

                    DataTable RQSTDT = new DataTable();
                    RQSTDT.TableName = "RQSTDT";
                    RQSTDT.Columns.Add("LANGID", typeof(string));
                    RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                    RQSTDT.Columns.Add("CMCODE", typeof(string));

                    DataRow dr = RQSTDT.NewRow();
                    dr["LANGID"] = LoginInfo.LANGID;
                    dr["CMCDTYPE"] = "ELEC_ROLLPRESS_MEAN";
                    dr["CMCODE"] = LoginInfo.CFG_AREA_ID;
                    RQSTDT.Rows.Add(dr);

                    DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

                    roll_avg1 = Int16.Parse(dtResult.Rows[0]["ATTRIBUTE1"].ToString());
                    roll_avg2 = Int16.Parse(dtResult.Rows[0]["ATTRIBUTE2"].ToString());
                }
                catch (Exception ex)
                {

                }

                foreach (DataRow row in dataCollect.Rows)
                    { 
                        //[E20240430-000729] 자주검사 코드 임시 하드코팅 처리
                        if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue1 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount1++;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue2 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount2++;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {                            
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue1 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount1++;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {                            
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue2 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue2 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount2++;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {
                            
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue3 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue3 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount3++;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG"))
                        {
                            
                            if (!string.IsNullOrEmpty(Util.NVC(row["CLCTVAL01"])))
                            {
                                if (!string.Equals(Util.NVC(row["CLCTVAL01"]), Double.NaN.ToString()))
                                {
                                    sumValue4 += Util.NVC_Decimal(row["CLCTVAL01"]);
                                    cslValue4 += Util.NVC_Decimal(row["CSL"]);
                                    iHGcount4++;
                                }
                            }
                        }
                    }

                    foreach (DataRow row in dataCollect.Rows)
                    {

                        if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue > 0 && iHGcount1 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue / iHGcount1)));

                            if ((((Util.NVC_Decimal(cslValue1) / iHGcount1)) + roll_avg1 < (sumValue / iHGcount1)) && sumValue > 0 && iHGcount1 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue1) / iHGcount1)) - roll_avg2 > (sumValue / iHGcount1)) && sumValue > 0 && iHGcount1 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "E3000-0001") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue2 > 0 && iHGcount2 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue2 / iHGcount2)));

                            if ((((Util.NVC_Decimal(cslValue2) / iHGcount2)) + roll_avg1 < (sumValue2 / iHGcount2)) && sumValue2 > 0 && iHGcount2 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue2) / iHGcount2)) - roll_avg2 > (sumValue2 / iHGcount2)) && sumValue2 > 0 && iHGcount2 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        else if(string.Equals(row["INSP_ITEM_ID"], "SI022") && Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue > 0 && iHGcount1 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue / iHGcount1)));

                            if ((((Util.NVC_Decimal(cslValue1) / iHGcount1)) + roll_avg1 < (sumValue / iHGcount1)) && sumValue > 0 && iHGcount1 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue1) / iHGcount1)) - roll_avg2 > (sumValue / iHGcount1)) && sumValue > 0 && iHGcount1 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI022") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue2 > 0 && iHGcount2 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue2 / iHGcount2)));

                            if ((((Util.NVC_Decimal(cslValue2) / iHGcount2)) + roll_avg1 < (sumValue2 / iHGcount2)) && sumValue2 > 0 && iHGcount2 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue2) / iHGcount2)) - roll_avg2 > (sumValue2 / iHGcount2)) && sumValue2 > 0 && iHGcount2 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue3 > 0 && iHGcount3 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue3 / iHGcount3)));
                            if ((((Util.NVC_Decimal(cslValue3) / iHGcount3)) + roll_avg1 < (sumValue3 / iHGcount3)) && sumValue3 > 0 && iHGcount3 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue3) / iHGcount3)) - roll_avg2 > (sumValue3 / iHGcount3)) && sumValue3 > 0 && iHGcount3 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        else if (string.Equals(row["INSP_ITEM_ID"], "SI516") && !Util.NVC(row["CLSS_NAME1"]).Contains("HG") && sumValue4 > 0 && iHGcount4 > 0)
                        {
                            C1.WPF.DataGrid.DataGridCell currentAvgCell = QUALITY_GRID.GetCell(rowcount, meanIndex);
                            DataTableConverter.SetValue(QUALITY_GRID.Rows[rowcount].DataItem, "MEAN", Util.NVC_Decimal(GetUnitFormatted(sumValue4 / iHGcount4)));
                            if ((((Util.NVC_Decimal(cslValue4) / iHGcount4)) + roll_avg1 < (sumValue4 / iHGcount4)) && sumValue4 > 0 && iHGcount4 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else if ((((Util.NVC_Decimal(cslValue4) / iHGcount4)) - roll_avg2 > (sumValue4 / iHGcount4)) && sumValue4 > 0 && iHGcount4 > 0 && currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                            {
                                currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                currentAvgCell.Presenter.FontWeight = FontWeights.Bold;
                            }
                            else
                            {
                                if (currentAvgCell.Presenter != null && roll_avg1 > 0 && roll_avg2 > 0)
                                {
                                    currentAvgCell.Presenter.Background = new SolidColorBrush(Colors.White);
                                    currentAvgCell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    currentAvgCell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                        rowcount++;
                    }                
            }            
        }
        protected virtual void OnLoadedDgQualitynCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;
            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (e.Cell != null && e.Cell.Presenter != null)
                    {
                        if (e.Cell.Row.Type == DataGridRowType.Item)
                        {
                            if (string.Equals(e.Cell.Column.Name, "LSL") || string.Equals(e.Cell.Column.Name, "USL"))
                            {
                                e.Cell.Presenter.Background = new SolidColorBrush((Color)System.Windows.Media.ColorConverter.ConvertFromString("#FFF3F0F0"));
                            }
                            //else if (string.Equals(e.Cell.Column.Name, "CLCTVAL01") || string.Equals(e.Cell.Column.Name, "CLCTVAL02"))
                            else if (string.Equals(e.Cell.Column.Name, "CLCTVAL01"))
                            {
                                StackPanel panel = e.Cell.Presenter.Content as StackPanel;
                                C1.WPF.DataGrid.DataGridCellPresenter p = panel.Parent as C1.WPF.DataGrid.DataGridCellPresenter;
                                C1.WPF.DataGrid.C1DataGrid grid;
                                grid = p.DataGrid;

                                string sCode = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "INSP_VALUE_TYPE_CODE"));
                                string sValue = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "CLCTVAL01"));
                                string sLSL = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "LSL"));
                                string sUSL = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "USL"));
                                string sCSL = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "CSL"));
                                string sLSL_Limit = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "LSL_LIMIT"));
                                string sUSL_Limit = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "USL_LIMIT"));
                                string isEnable = Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, "ISENABLE"));
                                //int roll_avg1 = 0;
                                //int roll_avg2 = 0;
                                //int iRowIdx = 0;
                                //int iMeanColldx = 0;

                                //iMeanColldx = QUALITY_GRID.Columns["MEAN"].Index;
                                //C1.WPF.DataGrid.DataGridCell currentAvgCell = grid.GetCell(iRowIdx, iMeanColldx);
                                //iRowIdx = p.Cell.Row.Index;

                                if (panel != null)
                                {
                                    if (string.Equals(sCode, "NUM"))
                                    {
                                        C1NumericBox numeric = panel.Children[0] as C1NumericBox;

                                        // 재설정
                                        if (string.Equals(txtUnit.Text, "EA"))
                                            numeric.Format = "F1";
                                        else
                                            numeric.Format = GetUnitFormatted();

                                        // SRS요청으로 동별 LIMIT값 설정 [2017-11-30]
                                        if (!string.IsNullOrEmpty(sLSL_Limit) && Util.NVC_Decimal(sLSL_Limit) > 0)
                                            numeric.Minimum = Convert.ToDouble(sLSL_Limit);
                                        else
                                            numeric.Minimum = Double.NegativeInfinity;

                                        if (!string.IsNullOrEmpty(sUSL_Limit) && Util.NVC_Decimal(sUSL_Limit) > 0)
                                            numeric.Maximum = Convert.ToDouble(sUSL_Limit);
                                        else
                                            numeric.Maximum = Double.PositiveInfinity;

                                        if (numeric != null && !string.IsNullOrWhiteSpace(Util.NVC(numeric.Value)) &&  !string.Equals(Util.NVC(numeric.Value), Double.NaN.ToString()))
                                        {
                                            // 프레임버그로 값 재 설정 [2017-12-06]
                                            // 액셀 붙여넣기 기능으로 빈칸이 입력될 경우 Convert클래스 이용 시 오류 발생 문제로 체크용 Function 교체 [2019-01-28]
                                            if (!string.IsNullOrWhiteSpace(sValue) && !string.Equals(sValue, "NaN"))
                                            {
                                                //소수점Separator에 따라 분기(우크라이나 언어)
                                                if (sValue.Contains(CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator))
                                                    numeric.Value = Convert.ToDouble(sValue, CultureInfo.CurrentCulture.NumberFormat);
                                                else
                                                    numeric.Value = Convert.ToDouble(sValue, CultureInfo.InvariantCulture.NumberFormat);
                                            }

                                            if (sLSL != "" && Util.NVC_Decimal(numeric.Value) < Util.NVC_Decimal(sLSL))
                                            {
                                                e.Cell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                                e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                                e.Cell.Presenter.FontWeight = FontWeights.Bold;
                                            }

                                            else if (sUSL != "" && Util.NVC_Decimal(numeric.Value) > Util.NVC_Decimal(sUSL))
                                            {
                                                e.Cell.Presenter.Background = new SolidColorBrush(Colors.Red);
                                                e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.White);
                                                e.Cell.Presenter.FontWeight = FontWeights.Bold;
                                            }
                                            else
                                            {
                                                e.Cell.Presenter.Background = new SolidColorBrush(Colors.White);
                                                e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                                e.Cell.Presenter.FontWeight = FontWeights.Normal;
                                            }
                                        }
                                        if (isEnable.Equals("False"))
                                        {
                                            e.Cell.Presenter.Background = new SolidColorBrush((Color)System.Windows.Media.ColorConverter.ConvertFromString("#EBEBEB"));
                                        }
                                        numeric.IsKeyboardFocusWithinChanged -= OnDataCollectGridFocusChanged;
                                        numeric.IsKeyboardFocusWithinChanged += OnDataCollectGridFocusChanged;
                                        numeric.PreviewKeyDown -= OnDataCollectGridPreviewItmeKeyDown;
                                        numeric.PreviewKeyDown += OnDataCollectGridPreviewItmeKeyDown;
                                        numeric.LostKeyboardFocus -= OnDataCollectGridGotKeyboardLost;
                                        numeric.LostKeyboardFocus += OnDataCollectGridGotKeyboardLost;
                                    }
                                }
                            }

                            else
                            {
                                e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                e.Cell.Presenter.FontWeight = FontWeights.Normal;
                            }
                        }

                        if (string.Equals(procId, Process.ROLL_PRESSING))
                        {                            
                            ClctaMean();
                            QUALITY_GRID.Columns["MEAN"].Visibility = Visibility.Visible;
                            if (e.Cell.Row.Type == DataGridRowType.Bottom)
                            {
                                StackPanel panel = e.Cell.Presenter.Content as StackPanel;
                                ContentPresenter presenter = panel.Children[0] as ContentPresenter;

                                if (e.Cell.Column.Index == dataGrid.Columns["CLSS_NAME1"].Index)
                                {
                                    if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                                        presenter.Content = ObjectDic.Instance.GetObjectName("평균");
                                }
                                else if (e.Cell.Column.Index == dataGrid.Columns["CLCTVAL01"].Index) // 측정값
                                {
                                    decimal sumValue = 0;
                                    if (e.Cell.Row.Index == (dataGrid.Rows.Count - 1))
                                        if (presenter.Content.ToString().Equals("NaN") || presenter.Content.ToString().Equals("非数字"))
                                        {
                                            foreach (C1.WPF.DataGrid.DataGridRow row in dataGrid.Rows)
                                                if (!string.Equals(Util.NVC(DataTableConverter.GetValue(row.DataItem, "CLCTVAL01")), Double.NaN.ToString()))
                                                    sumValue += string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(row.DataItem, "CLCTVAL01"))) ? 0 : Util.NVC_Decimal(DataTableConverter.GetValue(row.DataItem, "CLCTVAL01"));

                                            if (sumValue == 0)
                                                presenter.Content = 0;
                                            else
                                                presenter.Content = Util.NVC_Decimal(GetUnitFormatted(sumValue / (dataGrid.Rows.Count - dataGrid.BottomRows.Count), "EA"));
                                        }
                                }
                            }
                        }
                    }
                }));
            }
        }

        protected virtual void OnUnLoadedDgQualitynCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid != null)
            {
                dataGrid.Dispatcher.BeginInvoke(new Action(() =>
                {
                    if (e.Cell != null && e.Cell.Presenter != null)
                    {
                        if (e.Cell.Row.Type == DataGridRowType.Item)
                        {
                            if (e != null && e.Cell != null && e.Cell.Presenter != null)
                            {
                                e.Cell.Presenter.Background = null;

                                if (!string.Equals(e.Cell.Column.Name, "LSL") && !string.Equals(e.Cell.Column.Name, "USL"))
                                {
                                    e.Cell.Presenter.Foreground = new SolidColorBrush(Colors.Black);
                                    e.Cell.Presenter.FontWeight = FontWeights.Normal;
                                }
                            }
                        }
                    }
                }));
            }
        }

        #endregion

        #region Color Tag, Defect Tag
        protected virtual void OnDataCollectGridDefectTagComittedEdit(object sender, DataGridCellEventArgs e)
        {
            if (e.Cell.Row != null && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, DEFECT_TAG_GRID.Columns[e.Cell.Column.Index].Name)).Equals("") &&
                    Util.NVC_Decimal(DataTableConverter.GetValue(e.Cell.Row.DataItem, DEFECT_TAG_GRID.Columns[e.Cell.Column.Index].Name)) > 0)
                isChagneDefectTag = true;
        }

        protected virtual void OnDataCollectGridColorTagCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            if (e.Cell.Row != null && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, COLOR_GRID.Columns[e.Cell.Column.Index].Name)).Equals("") &&
                 Util.NVC_Decimal(DataTableConverter.GetValue(e.Cell.Row.DataItem, COLOR_GRID.Columns[e.Cell.Column.Index].Name)) > 0)
                isChangeColorTag = true;
        }
        #endregion

        #region WIP Note
        protected virtual void OnDataCollectGridRemarkCommittedEdit(object sender, DataGridCellEventArgs e)
        {
            if (e.Cell.Row != null && !Util.NVC(DataTableConverter.GetValue(e.Cell.Row.DataItem, REMARK_GRID.Columns[e.Cell.Column.Index].Name)).Equals(""))
            {
                isChangeRemark = true;
            }

            if (REMARK_GRID.Rows.Count < 1) return;
            if (e.Cell.Row.Index != 0) return;

            string strAll = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[e.Cell.Row.Index].DataItem, REMARK_GRID.Columns[e.Cell.Column.Index].Name));
            string strTmp = "";
            for (int i = 1; i < REMARK_GRID.Rows.Count; i++)
            {
                strTmp = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i].DataItem, REMARK_GRID.Columns[e.Cell.Column.Index].Name));

                if (!string.IsNullOrEmpty(strTmp))
                    strTmp += " " + strAll;
                else
                    strTmp = strAll;

                DataTableConverter.SetValue(REMARK_GRID.Rows[i].DataItem, REMARK_GRID.Columns[e.Cell.Column.Index].Name, strTmp);
            }
            DataTableConverter.SetValue(REMARK_GRID.Rows[0].DataItem, REMARK_GRID.Columns[e.Cell.Column.Index].Name, "");
        }

        protected virtual void OnLoadedRemarkCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;
            if (dataGrid != null)
            {
                if (e.Cell.Row.Index == 0 && e.Cell.Column.Index == 1)
                {
                    Grid grid = e.Cell.Presenter.Content as Grid;

                    if (grid != null)
                    {
                        TextBox remarkText = grid.Children[0] as TextBox;

                        if (remarkText != null)
                        {
                            remarkText.LostKeyboardFocus -= OnRemarkLostKeyboardFocus;
                            remarkText.LostKeyboardFocus += OnRemarkLostKeyboardFocus;
                        }
                    }
                }
                else if ( e.Cell.Row.Index > 0 && e.Cell.Column.Index == 1)
                {
                    Grid grid = e.Cell.Presenter.Content as Grid;

                    if (grid != null)
                    {
                        TextBox remarkText = grid.Children[0] as TextBox;

                        if (remarkText != null)
                        {
                            remarkText.LostKeyboardFocus -= OnRemarkChildLostKeyboardFocus;
                            remarkText.LostKeyboardFocus += OnRemarkChildLostKeyboardFocus;
                        }
                    }
                }
            }
        }

        private void OnRemarkLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {
            if (REMARK_GRID.Rows.Count < 1) return;

            TextBox remarkText = sender as TextBox;

            if ( remarkText != null && !string.IsNullOrEmpty(remarkText.Text))
            {
                isChangeRemark = true;

                /*
                string strAll = Util.NVC(remarkText.Text);
                string strTmp = "";
                for (int i = 1; i < REMARK_GRID.Rows.Count; i++)
                {
                    strTmp = Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i].DataItem, "REMARK"));

                    if (!string.IsNullOrEmpty(strTmp))
                        strTmp += " " + strAll;
                    else
                        strTmp = strAll;

                    DataTableConverter.SetValue(REMARK_GRID.Rows[i].DataItem, "REMARK", strTmp);
                }
                DataTableConverter.SetValue(REMARK_GRID.Rows[0].DataItem, "REMARK", "");
                */
            }
        }

        private void OnRemarkChildLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {
            if (REMARK_GRID.Rows.Count < 1) return;

            TextBox remarkText = sender as TextBox;

            if (remarkText != null && !string.IsNullOrEmpty(remarkText.Text))
                isChangeRemark = true;
        }

        #region [POSTACTION]
        protected virtual void OnLoadedPostHoldCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;
            if (dataGrid != null)
            {
                if (e.Cell.Row.Index == 0 && e.Cell.Column.Index == 3)
                {
                    Grid grid = e.Cell.Presenter.Content as Grid;

                    if (grid != null)
                    {
                        TextBox remarkText = grid.Children[0] as TextBox;

                        if (remarkText != null)
                        {
                            remarkText.LostKeyboardFocus -= OnPostHoldLostKeyboardFocus;
                            remarkText.LostKeyboardFocus += OnPostHoldLostKeyboardFocus;
                        }
                    }
                }
                else if (e.Cell.Row.Index > 0 && e.Cell.Column.Index == 3)
                {
                    Grid grid = e.Cell.Presenter.Content as Grid;

                    if (grid != null)
                    {
                        TextBox remarkText = grid.Children[0] as TextBox;

                        if (remarkText != null)
                        {
                            remarkText.LostKeyboardFocus -= OnPostHoldChildLostKeyboardFocus;
                            remarkText.LostKeyboardFocus += OnPostHoldChildLostKeyboardFocus;
                        }
                    }
                }
            }
        }

        private void OnPostHoldLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {
            if (POSTHOLD_GRID.Rows.Count < 1) return;

            TextBox remarkText = sender as TextBox;

            if (remarkText != null && !string.IsNullOrEmpty(remarkText.Text))
            {
                isChangePostAction = true;

            }
        }

        private void OnPostHoldChildLostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)
        {
            if (POSTHOLD_GRID.Rows.Count < 1) return;

            TextBox remarkText = sender as TextBox;

            if (remarkText != null && !string.IsNullOrEmpty(remarkText.Text))
                isChangePostAction = true;
        }
        #endregion
        private void BindingWipNote(DataTable dt)
        {
            //if (REMARK_GRID.GetRowCount() > 0) return;

            //C20210928-000558 Slitter Process adds NG TAG columns in remark
            //슬리터 불량/LOSS 저장시 특이사항 재조회 실행
            if (!isRemarkNgTag)
                if (REMARK_GRID.GetRowCount() > 0) return;

            DataTable dtRemark = new DataTable();

            dtRemark.Columns.Add("LOTID", typeof(String));
            dtRemark.Columns.Add("DFCT_TAG_QTY", typeof(String));
            dtRemark.Columns.Add("REMARK", typeof(String));
            DataRow inDataRow = null;
            inDataRow = dtRemark.NewRow();
            inDataRow["LOTID"] = ObjectDic.Instance.GetObjectName("공통특이사항");
            inDataRow["DFCT_TAG_QTY"] = 0;

            if (dt.Rows.Count > 0)
            {
                string[] sWipNote = GetWIPNOTE(Util.NVC(dt.Rows[0]["LOTID"])).Split('|');
                if (sWipNote.Length > 1)
                    inDataRow["REMARK"] = sWipNote[1];
            }
            dtRemark.Rows.Add(inDataRow);

            foreach (DataRow _row in dt.Rows)
            {
                inDataRow = dtRemark.NewRow();
                inDataRow["LOTID"] = Util.NVC(_row["LOTID"]);

                //C20210928-000558 Slitter Process adds NG TAG columns in remark
                //동별공통코드로 관리로 변경 2021-10-29
                if (isRemarkNgTag)
                    inDataRow["DFCT_TAG_QTY"] = GetNgTagQty(Util.NVC(_row["LOTID"]), Util.NVC(_row["WIPSEQ"]));
                else
                    inDataRow["DFCT_TAG_QTY"] = 0;

                inDataRow["REMARK"] = GetWIPNOTE(Util.NVC(_row["LOTID"])).Split('|')[0];
                dtRemark.Rows.Add(inDataRow);
            }
            Util.GridSetData(REMARK_GRID, dtRemark, FrameOperation);

            // SLITTER가 아닌 경우 공통특이사항은 숨김
            // 슬리터 2차 추가 2021-09-15 by 오화백
            if (!string.Equals(procId, Process.SLITTING) && !string.Equals(procId, "E4200") && !string.Equals(procId, Process.SRS_SLITTING) && !string.Equals(procId, Process.HALF_SLITTING))
                REMARK_GRID.Rows[0].Visibility = Visibility.Collapsed;

            //C20210928-000558 Slitter Process adds NG TAG columns in remark
            //동별공통코드로 관리로 변경 2021-10-29
            if (isRemarkNgTag)
                REMARK_GRID.Columns["DFCT_TAG_QTY"].Visibility = Visibility.Visible;

            //[E20230127-000272] 코터 공정진척 2번컷 특이사항 자동 입력 건
            if (string.Equals(procId, Process.COATING))
            {
                if (REMARK_GRID != null && REMARK_GRID.GetRowCount() > 1)  //REMARK_GRID.Rows[0] :공통특이사항,REMARK_GRID.Rows[1] : LOTID
                {
                    if (string.Equals(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "REMARK")), ""))
                    {
                        DataTableConverter.SetValue(REMARK_GRID.Rows[1].DataItem, "REMARK", GetUnstblSectionWupNote(LoginInfo.CFG_AREA_ID, procId, Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[1].DataItem, "LOTID"))));
                    }
                }
            }
        }

        private void GetRemarkNgTagSelect()
        {
            //C20210928-000558 Slitter Process adds NG TAG columns in remark
            //동별 공통코드 조회 2021-10-29 
            DataTable dtAreaCom = new DataTable();
            dtAreaCom.Columns.Add("AREAID", typeof(string));
            dtAreaCom.Columns.Add("COM_TYPE_CODE", typeof(string));
            dtAreaCom.Columns.Add("COM_CODE", typeof(string));

            DataRow drArea = dtAreaCom.NewRow();
            drArea["AREAID"] = LoginInfo.CFG_AREA_ID;
            drArea["COM_TYPE_CODE"] = "REMARK_NG_TAG_COL_USE";
            drArea["COM_CODE"] = procId;

            dtAreaCom.Rows.Add(drArea);

            DataTable dtAreaResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_FOR_AREA", "RQSTDT", "RSLTDT", dtAreaCom);

            if (dtAreaResult.Rows.Count > 0)
            {
                isRemarkNgTag = true;
            }
            else
            {
                isRemarkNgTag = false;
            }
        }

        private string GetWIPNOTE(string sLotID)
        {
            DataTable inTable = new DataTable();
            inTable.Columns.Add("LOTID", typeof(string));

            DataRow indata = inTable.NewRow();
            indata["LOTID"] = sLotID;
            inTable.Rows.Add(indata);

            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_WIPHISTORYATTR_WIPNOTE", "INDATA", "RSLTDT", inTable);
            if (dt.Rows.Count > 0)
            {
                return Util.NVC(dt.Rows[0]["WIP_NOTE"]);
            }
            else
            {
                return "";
            }
        }

        private string GetNgTagQty(string sLotID, string sWipSeq)
        {
            DataTable inTable = new DataTable();
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("WIPSEQ", typeof(string));

            DataRow indata = inTable.NewRow();
            indata["LOTID"] = sLotID;
            indata["WIPSEQ"] = sWipSeq;
            inTable.Rows.Add(indata);

            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_LOT_NG_TAG_QTY", "RQSTST", "RSLTDT", inTable);

            if (dt.Rows.Count > 0)
            {
                return Util.NVC(dt.Rows[0]["DFCT_TAG_QTY"]);
            }
            else
            {
                return "";
            }
        }

        #region[POSTACTION]
        private void BindPostHold(string LOTID, string CUT_ID) 
        {
            // 폴란드 2차 추가 2021-09-15 by 오화백
            // 2022-12-29 오화백 EP 동 추가
            //if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) && (string.Equals(LoginInfo.CFG_AREA_ID, "E5") || string.Equals(LoginInfo.CFG_AREA_ID, "E6") || string.Equals(LoginInfo.CFG_AREA_ID, "EA") || string.Equals(LoginInfo.CFG_AREA_ID, "EP")))
            // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
            if ((string.Equals(procId, Process.ROLL_PRESSING) || string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200")) && (string.Equals(_RemarkHoldUseFlag, "Y")))
            {
                DataTable _postholdDT = new DataTable();

                Util.gridClear(POSTHOLD_GRID);

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));
                IndataTable.Columns.Add("CUT_ID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = LOTID; 
                Indata["CUT_ID"] = CUT_ID; 
                IndataTable.Rows.Add(Indata);

                _postholdDT = new ClientProxy().ExecuteServiceSync("BR_PRD_CHK_POST_HOLD_ELTR", "INDATA", "RSLTDT", IndataTable);

                if (_postholdDT == null || _postholdDT.Rows.Count == 0)  // [E20230906-001181] [LGESWA PI Team] HOLD check box - UI Standarization
                {
                    // Util.MessageInfo("SFU9207"); // 기준정보가 없습니다. 
                    return;
                }

                DataTable _dt = new DataTable();
                _dt.Columns.Add("LOTID", typeof(string));
                _dt.Columns.Add("LANENUM", typeof(string));
                _dt.Columns.Add("DFCT_TAG_QTY", typeof(String));
                _dt.Columns.Add("POST_HOLD", typeof(string));
                _dt.Columns.Add("REMARK", typeof(string));

                var remark = new List<string>();
                DataRow dRow = null;
                for (int i = 0; i < _postholdDT.Rows.Count; i++)
                {
                    dRow = _dt.NewRow();
                    dRow["LOTID"] = Util.NVC(_postholdDT.Rows[i]["LOTID"]);
                    dRow["LANENUM"] = Util.NVC(_postholdDT.Rows[i]["LANENUM"]);
                    dRow["POST_HOLD"] = Util.NVC(_postholdDT.Rows[i]["POST_HOLD"]);

                    if (!string.IsNullOrEmpty(Util.NVC(_postholdDT.Rows[i]["HOLD_DESC"]).Split('|')[0]))
                        remark.Add(Util.NVC(_postholdDT.Rows[i]["HOLD_DESC"]).Split('|')[0]);
                    else
                        remark.Add(GetWIPNOTE(Util.NVC(_postholdDT.Rows[i]["LOTID"])).Split('|')[0]);

                    //C20210928-000558 Slitter Process adds NG TAG columns in remark
                    //동별공통코드로 관리로 변경 2021-10-29
                    if (isRemarkNgTag)
                        dRow["DFCT_TAG_QTY"] = GetNgTagQty(Util.NVC(_postholdDT.Rows[i]["LOTID"]), "1");
                    else
                        dRow["DFCT_TAG_QTY"] = 0;

                    dRow["REMARK"] = remark[0];
                    _dt.Rows.Add(dRow);
                    remark.Clear();
                }

                DataRow dr = _dt.NewRow();
                dr[0] = ObjectDic.Instance.GetObjectName("공통특이사항");
                dr[1] = "ALL";
                string[] sWipNote = GetWIPNOTE(Util.NVC(_postholdDT.Rows[0]["LOTID"])).Split('|');
                if (sWipNote.Length > 1)
                    dr["REMARK"] = sWipNote[1];

                _dt.Rows.InsertAt(dr, 0);

                Util.GridSetData(POSTHOLD_GRID, _dt, FrameOperation);
                
                // SLITTER가 아닌 경우 공통특이사항은 숨김
                if (string.Equals(procId, Process.ROLL_PRESSING))
                    POSTHOLD_GRID.Rows[0].Visibility = Visibility.Collapsed;

                //C20210928-000558 Slitter Process adds NG TAG columns in remark
                //동별공통코드로 관리로 변경 2021-10-29
                if (isRemarkNgTag)
                    POSTHOLD_GRID.Columns["DFCT_TAG_QTY"].Visibility = Visibility.Visible;
            }
        }
        #endregion
        #endregion

        #region Final Cut Method
        private bool IsFinalProcess()
        {
            // 현재 작업중인 LOT이 마지막 공정인지 체크 [2017-02-16]
            DataTable inTable = new DataTable();
            inTable.Columns.Add("PR_LOTID", typeof(string));
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("PROCID", typeof(string));

            DataRow indata = inTable.NewRow();
            indata["PR_LOTID"] = _LOTIDPR;
            indata["LOTID"] = _LOTID;
            indata["PROCID"] = procId;

            inTable.Rows.Add(indata);

            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CUTLOT_ELEC", "INDATA", "RSLTDT", inTable);

            if (dt.Select("CUT_SEQNO > 1").Length == 0)
                return true;

            return false;
        }

        private Dictionary<string, string> GetRemarkConvert()
        {
            Dictionary<string, string> remarkInfo = new Dictionary<string, string>();
            if (REMARK_GRID.Rows.Count > 0)
            {
                System.Text.StringBuilder sRemark = new System.Text.StringBuilder();
                for (int i = 1; i < REMARK_GRID.Rows.Count; i++)
                {
                    sRemark.Clear();

                    // 1. 특이사항
                    sRemark.Append(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i].DataItem, "REMARK")));
                    sRemark.Append("|");

                    // 2. 공통특이사항
                    // 슬리터 2차 추가 2021-09-15 by 오화백
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200") || string.Equals(procId, Process.SRS_SLITTING) || string.Equals(procId, Process.HALF_SLITTING))
                        sRemark.Append(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[0].DataItem, "REMARK")));
                    sRemark.Append("|");

                    if (string.Equals(procId, Process.COATING) || string.Equals(procId, Process.ROLL_PRESSING))
                    {
                        // 롤맵 Hold 기능 추가 Start//////////////////////////////////////////////////////////////////////
                        if (!holdLotClassCode.IsNullOrEmpty() && holdLotClassCode.Count > 0)
                        {
                            string lotId = _LOTID;
                            string holdClassCode = holdLotClassCode[lotId];
                            string holdMessage = string.Empty;
                            
                            holdMessage = GetMessageWithSubstitution(holdClassCode.Trim(), lotId);
                            sRemark.Append(holdMessage);
                            sRemark.Append("|");
                        }
                        // 롤맵 Hold 기능 추가 End//////////////////////////////////////////////////////////////////////
                    }

                    // 3. 조정횟수
                    if (WIPREASON_GRID.Visibility == Visibility.Visible && WIPREASON_GRID.Columns["COUNTQTY"] != null)
                        for (int j = 0; j < WIPREASON_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY"))) &&
                                    Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY")) > 0)
                                sRemark.Append(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "RESNNAME")) + " : " +
                                    Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY")) + ",");

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Columns["COUNTQTY"] != null)
                        for (int j = 0; j < WIPREASON2_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY"))) &&
                                    Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY")) > 0)
                                sRemark.Append(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "RESNNAME")) + " : " +
                                    Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY")) + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);
                    sRemark.Append("|");

                    // 4. 압연횟수
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                        sRemark.Append(Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRESSCOUNT")));
                    sRemark.Append("|");

                    // 5.색지정보
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                        for (int j = 0; j < COLOR_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01"))) &&
                                Util.NVC_Decimal(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01")) > 0)
                                    sRemark.Append(Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTNAME")) + " : " +
                                        Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01")) + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);
                    sRemark.Append("|");

                    // 6.합권이력
                    DataTable mergeInfo = GetMergeInfo(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i].DataItem, "LOTID")), procId);
                    if (mergeInfo.Rows.Count > 0)
                        foreach(DataRow row in mergeInfo.Rows)
                            sRemark.Append(Util.NVC(row["LOTID"]) + " : " + GetUnitFormatted(row["LOT_QTY"]) + txtUnit.Text + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);

                    remarkInfo.Add(Util.NVC(DataTableConverter.GetValue(REMARK_GRID.Rows[i].DataItem, "LOTID")), sRemark.ToString());
                }
            }
            return remarkInfo;
        }

        private Dictionary<string, string> GetPostRemarkConvert()
        {
            Dictionary<string, string> remarkInfo = new Dictionary<string, string>();
            if (POSTHOLD_GRID.Rows.Count > 0)
            {
                System.Text.StringBuilder sRemark = new System.Text.StringBuilder();
                for (int i = 1; i < POSTHOLD_GRID.Rows.Count; i++)
                {
                    sRemark.Clear();

                    // 1. 특이사항
                    sRemark.Append(Util.NVC(DataTableConverter.GetValue(POSTHOLD_GRID.Rows[i].DataItem, "REMARK")));
                    sRemark.Append("|");

                    // 2. 공통특이사항
                    // 슬리터 2차 추가  2021-09-15 by 오화백
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                        sRemark.Append(Util.NVC(DataTableConverter.GetValue(POSTHOLD_GRID.Rows[0].DataItem, "REMARK")));
                    sRemark.Append("|");

                    // 3. 조정횟수
                    if (WIPREASON_GRID.Visibility == Visibility.Visible && WIPREASON_GRID.Columns["COUNTQTY"] != null)
                        for (int j = 0; j < WIPREASON_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY"))) &&
                                    Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY")) > 0)
                                sRemark.Append(Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "RESNNAME")) + " : " +
                                    Util.NVC(DataTableConverter.GetValue(WIPREASON_GRID.Rows[j].DataItem, "COUNTQTY")) + ",");

                    if (WIPREASON2_GRID.Visibility == Visibility.Visible && WIPREASON2_GRID.Columns["COUNTQTY"] != null)
                        for (int j = 0; j < WIPREASON2_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY"))) &&
                                    Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY")) > 0)
                                sRemark.Append(Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "RESNNAME")) + " : " +
                                    Util.NVC(DataTableConverter.GetValue(WIPREASON2_GRID.Rows[j].DataItem, "COUNTQTY")) + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);
                    sRemark.Append("|");

                    // 4. 압연횟수
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                        sRemark.Append(Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRESSCOUNT")));
                    sRemark.Append("|");

                    // 5.색지정보
                    if (string.Equals(procId, Process.ROLL_PRESSING))
                        for (int j = 0; j < COLOR_GRID.Rows.Count; j++)
                            if (!string.IsNullOrEmpty(Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01"))) &&
                                Util.NVC_Decimal(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01")) > 0)
                                sRemark.Append(Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTNAME")) + " : " +
                                    Util.NVC(DataTableConverter.GetValue(COLOR_GRID.Rows[j].DataItem, "CLCTVAL01")) + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);
                    sRemark.Append("|");

                    // 6.합권이력
                    DataTable mergeInfo = GetMergeInfo(Util.NVC(DataTableConverter.GetValue(POSTHOLD_GRID.Rows[i].DataItem, "LOTID")), procId);
                    if (mergeInfo.Rows.Count > 0)
                        foreach (DataRow row in mergeInfo.Rows)
                            sRemark.Append(Util.NVC(row["LOTID"]) + " : " + GetUnitFormatted(row["LOT_QTY"]) + txtUnit.Text + ",");

                    if (string.Equals(sRemark.ToString().Substring(sRemark.ToString().Length - 1, 1), ","))
                        sRemark.Remove(sRemark.ToString().Length - 1, 1);

                    remarkInfo.Add(Util.NVC(DataTableConverter.GetValue(POSTHOLD_GRID.Rows[i].DataItem, "LOTID")), sRemark.ToString());
                }
            }
            return remarkInfo;
        }

        private Dictionary<int, string> CheckFinalCutLot()
        {
            // 자동 FINAL CUT 여부 [2017-01-13]
            // 0 : Confirm 여부, 1 : Final Cut 여부, 2  : Loss 처리 여부, 3 : Hold 표시 여부, 4 : Confirm Message, 5 : 잔량[팝업], 6 : 잔량[길이부족차감] 
            DataTable inTable = new DataTable();
            inTable.Columns.Add("PR_LOTID", typeof(string));
            inTable.Columns.Add("LOTID", typeof(string));
            inTable.Columns.Add("PROCID", typeof(string));

            DataRow indata = inTable.NewRow();
            indata["PR_LOTID"] = _LOTIDPR;
            indata["LOTID"] = _LOTID;
            indata["PROCID"] = procId;

            inTable.Rows.Add(indata);

            DataTable dt = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CUTLOT_ELEC", "INDATA", "RSLTDT", inTable);

             if (dt.Rows.Count <= 1)
            {
                Util.MessageValidation("SFU1707");  //실적 확정할 대상이 없습니다.
                return new Dictionary<int, string> { { 0, bool.FalseString } };
            }

            string sLotID = string.Empty;
            string sLackMesg = string.Empty;  //길이부족 메시지

            decimal iOutQty = 0;         // 생산 수량
            decimal iTotQty = 0;         // 투입 LOT 수량
            decimal iResQty = 0;         // 투입 LOT 처리 이후 최종 수량
            decimal iLackQty = 0;        // 길이부족-반제품 수량

            bool isFinalOper = false;   // 마지막 CUT 여부

            // 투입 Lot 수량 저장
            iOutQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));   // 생산수량
            iTotQty = Util.NVC_Decimal(dt.Rows[0]["WIPQTY"]);

            //슬리터 길이부족시 30m 이상이면 실적 확정시 Popup 메시지
            //슬리터 2차 추가 2021-09-15 by 오화백
            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
            {
                for (int k = 0; k < WIPREASON_GRID.Rows.Count; k++)
                {
                    if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "PRCS_ITEM_CODE"), "LENGTH_LACK"))
                    {
                        iLackQty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "RESNTOTQTY"));

                        if ((Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[k].DataItem, "RESNTOTQTY"))  / Convert.ToDecimal(txtLaneQty.Value)) > 30)
                        {
                            sLackMesg = "(" + MessageDic.Instance.GetMessage("SFU8316", new object[] { iOutQty - iLackQty }) + ")";
                        }
                    }
                }
            }

            // 실적확정해야 할 1번째 LOT이 처음 확정할 LOT인지 체크
            DataRow[] rows = dt.Select("CUT_SEQNO = 1");
            if (rows.Length == ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) - LOTINFO_GRID.TopRows.Count))
            {
                bool isDupplicate = false;
                for (int i = 0 + LOTINFO_GRID.TopRows.Count; i < (LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count); i++)
                {

                    for (int j = 0; j < rows.Length; j++)
                    {
                        if (string.Equals(rows[j]["LOTID"], DataTableConverter.GetValue(LOTINFO_GRID.Rows[i].DataItem, "LOTID")))
                        {
                            isDupplicate = true;
                            break;
                        }
                    }
                }
                if (isDupplicate == false)
                {
                    Util.MessageValidation("SFU2898", new object[] { rows[0]["LOTID"] });   //LOT[{%1}]을 먼저 실적 확정 하세요.
                    return new Dictionary<int, string> { { 0, bool.FalseString } };
                }
            }
            else
            {
                Util.MessageValidation("SFU2898", new object[] { rows[0]["LOTID"] });   //LOT[{%1}]을 먼저 실적 확정 하세요.
                return new Dictionary<int, string> { { 0, bool.FalseString } };
            }

            // 마지막 실적 확정인지 체크
            if (dt.Select("CUT_SEQNO > 1").Length == 0)
                isFinalOper = true;

            iResQty = Util.NVC_Decimal(GetUnitFormatted(iTotQty - (iOutQty - exceedLengthQty)));

            // 길이초과로 등록된 수량 감안해서 -수량인 경우 체크
            if (iResQty < 0)
            {
                Util.MessageValidation("SFU1614");
                return new Dictionary<int, string> { { 0, bool.FalseString } };
            }

            if (isFinalOper)
            {
                if (iResQty > 0)
                {
                    /*
                    if (iResQty > 50)
                    {
                        // BIZ HOLD 처리 때문에 잠시 메세지 변경 ( 2017-01-17 )
                        //return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.FalseString }, { 2, bool.FalseString }, { 3, bool.TrueString },
                        //    { 4, MessageDic.Instance.GetMessage(string.Format("투입LOT 잔량 {0}이 HOLD 체크에 따라 HOLD/대기 처리됩니다.\r\n실적확정하시겠습니까?",
                        //                                            new object[] { iResQty })) }, { 5, Util.NVC(iResQty) } };
                        return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.FalseString }, { 2, bool.FalseString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1964", new object[] { iResQty + txtUnit.Text }) }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(iResQty) } };   //투입LOT 잔량 {0}가 대기됩니다.\n실적확정 하시겠습니까?
                    }
                    else
                    {
                        return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.TrueString }, { 2, bool.TrueString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1853", new object[] { iResQty + txtUnit.Text }) }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(0) } };     //잔량 {0}이 길이부족으로 등록되고, 투입LOT 잔량이 없습니다.\r\n실적확정 하시겠습니까?
                    }
                    */
                    return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.FalseString }, { 2, bool.FalseString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1964", new object[] { iResQty + txtUnit.Text }) + "\r" + sLackMesg }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(iResQty) } };   //투입LOT 잔량 {0}가 대기됩니다.\n실적확정 하시겠습니까?
                }
                else
                {
                    return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.TrueString }, { 2, bool.FalseString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1965") + "\r" + sLackMesg }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(iResQty) } };     //투입LOT 잔량이 없습니다.\r\n실적확정하시겠습니까?
                }
            }
            else
            {
                if (iResQty > 0)
                {
                    return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.FalseString }, { 2, bool.FalseString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1963", new object[] { iResQty + txtUnit.Text }) + "\r" + sLackMesg }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(iResQty) } };   //투입LOT 잔량 {0}이 남게 됩니다.\r\n실적확정하시겠습니까?
                }
                else
                {
                    if (isRollMapEquipment == true)
                    {
                        // ROLLMAP 실적 처리의 경우 다음LOT이 존재하고 투입LOT 잔량이 0인 경우도 확정 가능하도록 수정
                        return new Dictionary<int, string> { { 0, bool.TrueString }, { 1, bool.TrueString }, { 2, bool.FalseString }, { 3, bool.FalseString },
                            { 4, MessageDic.Instance.GetMessage("SFU1965") + "\r" + sLackMesg }, { 5, Util.NVC(iResQty) }, { 6, Util.NVC(iResQty) } };     //투입LOT 잔량이 없습니다.\r\n실적확정하시겠습니까?
                    }
                    else
                    {
                        //Util.Alert("SFU1483");      //다음 완성LOT이 존재하여 실적확정 불가합니다.
                        Util.MessageValidation("SFU1483");  //다음 완성LOT이 존재하여 실적확정 불가합니다.
                        return new Dictionary<int, string> { { 0, bool.FalseString } };
                    }
                }
            }
        }
        
        private bool SetLossLot(C1DataGrid dg, string sItemCode, decimal iLossQty)
        {
            bool isLossValid = false;
            DataTable dt = (dg.ItemsSource as DataView).Table;
            if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
            {
                // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                int iCount = isResnCountUse == true ? 1 : 0;

                for (int iCol = dg.Columns["ALL"].Index + (1 + iCount); iCol < dg.Columns["COSTCENTERID"].Index; iCol += (2 + iCount))
                {
                    string sublotid = dg.Columns[iCol + 1].Name;

                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        if (string.Equals(dt.Rows[i]["ACTID"], "LOSS_LOT") && string.Equals(dt.Rows[i]["PRCS_ITEM_CODE"], sItemCode))
                        {
                            DataTableConverter.SetValue(dg.Rows[i].DataItem, sublotid, iLossQty);
                            DefectChange(dg, i, iCol + 1);
                            isLossValid = true;
                            break;
                        }
                    }
                }
            }
            else
            {
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    if (string.Equals(dt.Rows[i]["ACTID"], "LOSS_LOT") && string.Equals(dt.Rows[i]["PRCS_ITEM_CODE"], sItemCode))
                    {
                        DataTableConverter.SetValue(dg.Rows[i].DataItem, "RESNQTY", iLossQty);
                        GetSumDefectQty(dg);
                        isLossValid = true;
                        break;
                    }
                }
            }

            if (isLossValid == false)
                Util.MessageValidation("SFU3196", new object[] { string.Equals(sItemCode, ITEM_CODE_LEN_LACK) ?
                    ObjectDic.Instance.GetObjectName("길이부족") : ObjectDic.Instance.GetObjectName("길이초과") }); //해당 MMD에 {%1}에 관련된 속성이 지정되지 않아 자동Loss를 등록할 수 없습니다.

            return isLossValid;
        }

        private void SetExceedLength()
        {
            if (isCoaterAfterProcess)
            {
                // 전 공정 횟수 관리를 위하여 로직 변경 (C20190416_75868 ) [2019-04-17]
                int iCount = isResnCountUse == true ? 1 : 0;

                for (int i = 0; i < WIPREASON_GRID.Rows.Count; i++)
                {
                    if (string.Equals(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "PRCS_ITEM_CODE"), ITEM_CODE_LEN_EXCEED))
                    {
                        if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
                            exceedLengthQty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, "RESNQTY"));
                        else
                            exceedLengthQty = Util.NVC_Decimal(DataTableConverter.GetValue(WIPREASON_GRID.Rows[i].DataItem, WIPREASON_GRID.Columns[WIPREASON_GRID.Columns["ALL"].Index + (2 + iCount)].Name));
                        break;
                    }
                }

                if (exceedLengthQty >= 0)
                {
                    // 롤맵 설비의 경우에는 길이초과 존재 시 포함하여 투입량 계산하도록 수정 [2021-11-04]
                    if (isRollMapEquipment == true)
                    {
                        txtInputQty.Value = txtParentQty.Value + Convert.ToDouble(exceedLengthQty);
                        SetInputQty();
                    }

                    decimal inputQty = Util.NVC_Decimal(txtParentQty.Value);
                    decimal prodQty = Util.NVC_Decimal(DataTableConverter.GetValue(LOTINFO_GRID.Rows[LOTINFO_GRID.TopRows.Count].DataItem, "INPUTQTY"));

                    if (prodQty > 0)
                        txtRemainQty.Value = Convert.ToDouble(inputQty - (prodQty - Util.NVC_Decimal(exceedLengthQty)));
                }
            }
        }

        private void SetSlitterInOutQty()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LOTID", typeof(string));

                DataRow row = dt.NewRow();
                row["LOTID"] =_LOTIDPR;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_LOTATTR_FOR_INOUT_QTY", "INDATA", "RSLTDT", dt);

                if (result.Rows.Count > 0)
                {
                    decimal srs1Qty = Util.NVC_Decimal(result.Rows[0]["SRS1_QTY"]);
                    decimal srs2Qty = Util.NVC_Decimal(result.Rows[0]["SRS2_QTY"]);
                    decimal srs3Qty = Util.NVC_Decimal(result.Rows[0]["SRS3_QTY"]);

                    if (chkInOut != null && chkInOut.IsChecked == true && srs1Qty > 0 && srs2Qty > 0 && srs3Qty > 0 && Util.NVC_Decimal(txtParentQty.Value) == (srs1Qty + srs2Qty + srs3Qty))
                        txtInputQty.Value = Convert.ToDouble(srs1Qty + srs2Qty + srs3Qty);
                    else if (chkInOut != null && chkInOut.IsChecked == true && Util.NVC_Decimal(txtParentQty.Value) == (srs1Qty + srs2Qty) && srs3Qty == 0)
                        txtInputQty.Value = Convert.ToDouble(srs1Qty + srs2Qty);
                    else if (Util.NVC_Decimal(txtParentQty.Value) == (srs1Qty + srs2Qty) && srs3Qty == 0)
                        txtInputQty.Value = Convert.ToDouble(srs2Qty);
                    else if (Util.NVC_Decimal(txtParentQty.Value) < (srs1Qty + srs2Qty) && Util.NVC_Decimal(txtParentQty.Value) >= srs1Qty && srs3Qty == 0)
                        txtInputQty.Value = Convert.ToDouble(srs1Qty);
                }
            }
            catch (Exception ex) { }
        }

        private int GetSamplingLabelQty()
        {
            if (string.Equals(procId, Process.ROLL_PRESSING))
                if (LoginInfo.CFG_ETC.Rows.Count > 0 && LoginInfo.CFG_ETC.Rows[0].ItemArray.Length >= 3 && !string.IsNullOrEmpty(LoginInfo.CFG_ETC.Rows[0]?[CustomConfig.CONFIGTABLE_ETC_SAMPLE_COPIES].ToString()) &&
                    Util.NVC_Int(LoginInfo.CFG_ETC.Rows[0]?[CustomConfig.CONFIGTABLE_ETC_SAMPLE_COPIES].ToString()) > 1)
                    if (string.Equals(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "QA_INSP_TRGT_FLAG"), "Y"))

                        return Util.NVC_Int(LoginInfo.CFG_ETC.Rows[0]?[CustomConfig.CONFIGTABLE_ETC_SAMPLE_COPIES].ToString());
            return 1;
        }

        #region

        #endregion
        // 샘플링 라벨발행 수량 / 출하처(자동차 롤프레스,슬리터)
        // 슬리터 2차 추가 2021-09-15 by 오화백
        private Dictionary<int, string> getSamplingLabelInfo(string sLotID)
        {
            if ((string.Equals(procId, Process.ROLL_PRESSING) || (string.Equals(procId, Process.SLITTING)) || (string.Equals(procId, "E4200"))) && string.Equals(getQAInspectFlag(sLotID), "Y"))
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("SHOPID", typeof(string));
                IndataTable.Columns.Add("PROCID", typeof(string));
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["SHOPID"] = LoginInfo.CFG_SHOP_ID;
                Indata["PROCID"] = procId;
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_LOT_SAMPLE_CHK_LOT_T1", "INDATA", "OUT_DATA", IndataTable);

                if (dtMain != null && dtMain.Rows.Count > 0)
                    return new Dictionary<int, string> { { Util.NVC_Int(dtMain.Rows[0]["OUT_PRINTCNT"]), Util.NVC(dtMain.Rows[0]["OUT_COMPANY"]) } };
            }

            return new Dictionary<int, string> { { 1, string.Empty }};
        }

        private string getQAInspectFlag(string sLotID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIPATTR", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count == 1)
                    return Util.NVC(string.Equals(procId, Process.ROLL_PRESSING) ? result.Rows[0]["QA_INSP_TRGT_FLAG"] : result.Rows[0]["SLIT_QA_INSP_TRGT_FLAG"]);
            }
            catch (Exception ex) { }

            return "";
        }

        private void SetSaveProductQty()
        {
            try
            {
                DataTable dt = new DataTable();
                dt.Columns.Add("LOTID", typeof(string));

                DataRow row = dt.NewRow();
                row["LOTID"] = _LOTID;
                dt.Rows.Add(row);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_WIPATTR_FOR_PROD_QTY", "INDATA", "RSLTDT", dt);

                if (result.Rows.Count > 0)
                    if (Util.NVC_Decimal(result.Rows[0]["PROD_QTY"]) > 0)
                        txtInputQty.Value = Convert.ToDouble(result.Rows[0]["PROD_QTY"]);
            }
            catch (Exception ex) {}
        }

        private void SetInitProductQty()
        {
            DataTable inDataTable = new DataTable();
            inDataTable.Columns.Add("LOTID", typeof(string));
            inDataTable.Columns.Add("PROD_QTY", typeof(decimal));

            DataRow inLotDetailDataRow = inDataTable.NewRow();
            inLotDetailDataRow["LOTID"] = _LOTID;
            inLotDetailDataRow["PROD_QTY"] = DBNull.Value;
            inDataTable.Rows.Add(inLotDetailDataRow);

            new ClientProxy().ExecuteService("DA_BAS_UPD_WIPATTR_FOR_PROD_QTY", "INDATA", null, inDataTable, (result, Returnex) =>
            {
                try
                {
                    if (Returnex != null)
                        return;
                }
                catch (Exception ex) {}
            });
        }
        #endregion

        #region Roll Direction
        protected virtual void OnClickSaveRollDir(object sender, RoutedEventArgs e)
        {
            //SetRollDir();

            #region [E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
            try
            {
                if ((isTWS_LOADING_TRACKING)
                    && (string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.ROLL_PRESSING)
                       || string.Equals(procId, Process.LASER_ABLATION) || string.Equals(procId, Process.SLITTING)
                       || string.Equals(procId, Process.HEAT_TREATMENT)))
                {
                    if (string.IsNullOrEmpty(_LOTID) == true)
                    {
                        Util.MessageValidation("SFU2957");  //진행중인 작업을 선택하세요.
                        return;
                    }

                    RadioButton rbOutputRollLaneForward = (grdDataCollect.Children[0] as UcDataCollect).rbOutputRollLaneForward;
                    RadioButton rbOutputRollLaneReverse = (grdDataCollect.Children[0] as UcDataCollect).rbOutputRollLaneReverse;
                    if ((rbOutputRollLaneReverse.IsChecked.Value == true || rbOutputRollLaneForward.IsChecked.Value == true) == false)
                    {
                        Util.MessageValidation("SFU8116", ObjectDic.Instance.GetObjectName("ROLL방향"));
                        return;
                    }

                    SetTWS_LOADING_TRACKING(); // 내부에 SetRollDir(); 포함
                }
                else
                {
                    SetRollDir();
                }
            }
            catch (Exception ex) { }
            #endregion
        }

        private void GetRollDir()
        {
            string eqptId = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            RadioButton rbRolloutUp = (grdDataCollect.Children[0] as UcDataCollect).rbRolloutUp;
            RadioButton rbRolloutDown = (grdDataCollect.Children[0] as UcDataCollect).rbRolloutDown;
            RadioButton rbRollinUp = (grdDataCollect.Children[0] as UcDataCollect).rbRollinUp;
            RadioButton rbRollinDown = (grdDataCollect.Children[0] as UcDataCollect).rbRollinDown;

            if (eqptId.Equals("SELECT"))
            {
                rbRolloutUp.IsChecked = false;
                rbRolloutDown.IsChecked = false;
                rbRollinUp.IsChecked = false;
                rbRollinDown.IsChecked = false;
                return;
            }

            //eqptid로 비즈 호출하여 값을 가져온다.
            DataTable rqstDt = new DataTable();
            rqstDt.Columns.Add("EQPTID", typeof(string));

            DataRow rqstDr = rqstDt.NewRow();
            rqstDr["EQPTID"] = eqptId;
            rqstDt.Rows.Add(rqstDr);

            DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_EIOATTR_ROLL_DIR", "INDATA", "RSLTDT", rqstDt);
            if(result != null && result.Rows.Count > 0)
            {
                isAutoSetRollDir = false;

                string rollinDir = Util.NVC(result.Rows[0]["INPUT_SECTION_ROLL_DIRCTN"]);
                string rolloutDir = Util.NVC(result.Rows[0]["EM_SECTION_ROLL_DIRCTN"]);

                if (rolloutDir.Equals("U"))
                {
                    rbRolloutUp.IsChecked = true;
                }
                else if (rolloutDir.Equals("D"))
                {
                    rbRolloutDown.IsChecked = true;
                }
                else
                {
                    rbRolloutUp.IsChecked = false;
                    rbRolloutDown.IsChecked = false;
                }

                if (rollinDir.Equals("U"))
                {
                    rbRollinUp.IsChecked = true;
                }
                else if (rollinDir.Equals("D"))
                {
                    rbRollinDown.IsChecked = true;
                }
                else
                {
                    rbRollinUp.IsChecked = false;
                    rbRollinDown.IsChecked = false;
                }
            }

            //[E20240206-000574] 로딩 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 
            if (isTWS_LOADING_TRACKING)
            {
                GetTWS_LOADING_TRACKING(_LOTID);

                //[E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
                SetTWS_RULE_PROCESS_EQPT_ROLL_DIR(procId, _LOTID);
            }
        }

        private void SetRollDir()
        {
            string eqptId = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            RadioButton rbRolloutUp = (grdDataCollect.Children[0] as UcDataCollect).rbRolloutUp;
            RadioButton rbRolloutDown = (grdDataCollect.Children[0] as UcDataCollect).rbRolloutDown;
            RadioButton rbRollinUp = (grdDataCollect.Children[0] as UcDataCollect).rbRollinUp;
            RadioButton rbRollinDown = (grdDataCollect.Children[0] as UcDataCollect).rbRollinDown;

            if (eqptId.Equals("SELECT"))
            {
                //설비를 선택하세요
                Util.MessageValidation("SFU1673");
                return;
            }

            string rolloutDir = "";
            string rollinDir = "";

            if (rbRolloutUp.IsChecked.HasValue && rbRolloutDown.IsChecked.HasValue)
            {
                if (rbRolloutUp.IsChecked.Value)
                {
                    rolloutDir = "U";
                }
                else if (rbRolloutDown.IsChecked.Value)
                {
                    rolloutDir = "D";
                }
            }

            if (rbRollinUp.IsChecked.HasValue && rbRollinDown.IsChecked.HasValue)
            {
                if (rbRollinUp.IsChecked.Value)
                {
                    rollinDir = "U";
                }
                else if (rbRollinDown.IsChecked.Value)
                {
                    rollinDir = "D";
                }
            }

            //eqptid로 비즈 호출하여 값을 세팅한다.
            DataSet inDataSet = new DataSet();

            DataTable rqstDt = inDataSet.Tables.Add("INDATA");
            rqstDt.Columns.Add("AREAID", typeof(string));
            rqstDt.Columns.Add("EQPTID", typeof(string));
            rqstDt.Columns.Add("PROCID", typeof(string));
            rqstDt.Columns.Add("INPUT_SECTION_ROLL_DIRCTN", typeof(string));
            rqstDt.Columns.Add("EM_SECTION_ROLL_DIRCTN", typeof(string));
            rqstDt.Columns.Add("ROLL_DIR_INIT_FLAG", typeof(string));
            rqstDt.Columns.Add("USERID", typeof(string));

            DataRow rqstDr = rqstDt.NewRow();
            rqstDr["AREAID"] = LoginInfo.CFG_AREA_ID;
            rqstDr["EQPTID"] = eqptId;
            rqstDr["PROCID"] = procId;
            rqstDr["INPUT_SECTION_ROLL_DIRCTN"] = rollinDir;
            rqstDr["EM_SECTION_ROLL_DIRCTN"] = rolloutDir;
            rqstDr["ROLL_DIR_INIT_FLAG"] = 'N';
            rqstDr["USERID"] = LoginInfo.USERID;
            
            rqstDt.Rows.Add(rqstDr);

            // CSR : C20210720-000108 추가 
            DataTable dtRollDir = inDataSet.Tables.Add("IN_LOT");
            dtRollDir.Columns.Add("LOTID", typeof(string));

            DataTable dtLot = ((DataView)LOTINFO_GRID.ItemsSource).Table;
            DataRow drLot = null;
            for (int i = 0; i < dtLot.Rows.Count; i++)
            {
                drLot = dtRollDir.NewRow();
                drLot["LOTID"] = Util.NVC(dtLot.Rows[i]["LOTID"]);
                dtRollDir.Rows.Add(drLot);
            }

            //new ClientProxy().ExecuteService_Multi("BR_PRD_REG_EIOATTR_ROLL_DIR", "INDATA,", null, rqstDt, (result, ex) =>
            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_EIOATTR_ROLL_DIR", "INDATA, IN_LOT", null, (result, ex) =>
            {
                if(ex != null)
                {
                    Util.MessageException(ex);
                    return;
                }

                GetRollDir();
                if (isSilentlySave == false) Util.MessageInfo("SFU1270");
            }, inDataSet);
        }

        private void SetWipAttrRollDir()
        {
            // CSR : C20210720-000108 Lot별로 WipAttr 속성값 저장 
            string eqptId = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            
            DataSet inDataSet = new DataSet();

            DataTable dtRoll = inDataSet.Tables.Add("INDATA");
            dtRoll.Columns.Add("AREAID", typeof(string));
            dtRoll.Columns.Add("EQPTID", typeof(string));
            dtRoll.Columns.Add("PROCID", typeof(string));
            dtRoll.Columns.Add("ROLL_DIR_INIT_FLAG", typeof(string));

            DataRow drRoll = dtRoll.NewRow();
            drRoll["AREAID"] = LoginInfo.CFG_AREA_ID;
            drRoll["EQPTID"] = eqptId;
            drRoll["PROCID"] = procId;
            drRoll["ROLL_DIR_INIT_FLAG"] = 'Y';
            dtRoll.Rows.Add(drRoll);

            new ClientProxy().ExecuteService_Multi("BR_PRD_REG_WIPATTR_ROLL_DIR", "INDATA", null, (result, ex) =>
            {
                if (ex != null)
                {
                    Util.MessageException(ex);
                    return;
                }
            }, inDataSet);
        }
        #endregion

        #region EQPT FAULTY
        private void GetEqptDfctData(object SelectedItem)
        {
            try
            {
                DataRowView rowview = SelectedItem as DataRowView;

                if (rowview == null)
                    return;

                if(EQPT_DFCT_GRID.Visibility != Visibility.Visible)
                {
                    return;
                }

                Util.gridClear(EQPT_DFCT_GRID);

                DataTable inTable = new DataTable();
                inTable.Columns.Add("LANGID", typeof(string));
                inTable.Columns.Add("EQPTID", typeof(string));
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIPSEQ", typeof(string));

                DataRow newRow = inTable.NewRow();
                newRow["LANGID"] = LoginInfo.LANGID;
                newRow["EQPTID"] = _EQPTID;
                newRow["LOTID"] = _LOTID; //rowview["LOTID"].ToString();
                newRow["WIPSEQ"] = _WIPSEQ; //rowview["WIPSEQ"].ToString();

                inTable.Rows.Add(newRow);

                new ClientProxy().ExecuteService("DA_EQP_SEL_EQPTDFCT_INFO", "INDATA", "OUTDATA", inTable, (searchResult, searchException) =>
                {
                    try
                    {
                        if (searchException != null)
                        {
                            Util.MessageException(searchException);
                            return;
                        }

                        Util.GridSetData(EQPT_DFCT_GRID, searchResult, FrameOperation, true);
                    }
                    catch (Exception ex)
                    {
                        Util.MessageException(ex);
                    }
                }
                );
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }
        #endregion
        #endregion

        #region Biz Rule
        string GetStartLotBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E2500":
                default:
                    bizRuleName = "BR_PRD_REG_START_LOT_HS_EIF";
                    break;
            }

            return bizRuleName;
        }
        string GetLargeLotBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E2000":
                //case "E2300":
                //case "E4500":
                case "S2000":
                default:
                    bizRuleName = "DA_PRD_SEL_COATMLOT_LOT";
                    break;
            }

            return bizRuleName;
        }

        string GetProdLotBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E0500":
                case "E1000":
                case "S1000":
                    bizRuleName = "DA_PRD_SEL_WIP_MX";
                    break;

                case "E2000":
                case "E2300":
                case "E4500":
                case "S2000":
                    bizRuleName = "DA_PRD_SEL_WIP_CT";
                    break;

                case "E4000":
                case "E4200": //슬리터 2차 추가  2021-09-15 by 오화백
                case "S4000":
                    //bizRuleName = "DA_PRD_SEL_WIP_SL";
                    bizRuleName = "DA_PRD_SEL_WIP_CUT_SL";
                    break;

                case "E2500":
                case "E3000":
                    if (WIPSTATUS.Equals("WAIT"))
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_RP_WIP_WAIT";
                    else
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_RP";
                    break;

                case "E3500":
                    if (WIPSTATUS.Equals("WAIT"))
                        bizRuleName = "DA_PRD_SEL_WIP_TP";
                    else
                        bizRuleName = "DA_PRD_SEL_TAPPING_LOTINFO";
                    break;

                case "E3300": //LASER ABLITION
                case "E3800":
                    if (WIPSTATUS.Equals("WAIT"))
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_SI_WIP_WAIT";
                    else
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_RW";
                    break;

                case "E3900":
                    if (WIPSTATUS.Equals(Wip_State.WAIT))
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_BW_WAIT";
                    else
                        bizRuleName = "DA_PRD_SEL_PRODUCTLOT_BW";
                    break;

                case "E4600":
                    bizRuleName = "DA_PRD_SEL_WIP_HT";
                    break;

                default:
                    bizRuleName = "DA_PRD_SEL_WIP_HS";
                    break;
            }

            return bizRuleName;
        }

        string GetResultLotBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E2500":
                case "E3000":
                    bizRuleName = "DA_PRD_SEL_CHILDLOT_INFO_RP";
                    break;

                case "E3500":
                case "E2300":
                case "E4500":
                case "E4600":
                    bizRuleName = "DA_PRD_SEL_WIP_CHILD_TP";
                    break;

                case "E3300": //LASER ABLITION
                case "E3800":
                    bizRuleName = "DA_PRD_SEL_CHILDLOT_INFO_RW";
                    break;

                case "E3900":
                    bizRuleName = "DA_PRD_SEL_CHILDLOT_INFO_BW";
                    break;

                case "E2000":
                case "E4000":
                case "S4000":
                case "E4200":  //슬리터 2차 추가  2021-09-15 by 오화백
                    bizRuleName = "DA_PRD_SEL_RUNLOT_SL"; //Add : 2016.12.13, Slitter | SRS Slitter Biz 추가
                    break;

                default:
                    bizRuleName = "DA_PRD_SEL_RUNLOT_HS";
                    break;
            }

            return bizRuleName;
        }

        string GetEndLotBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E2500":
                default:
                    bizRuleName = "BR_PRD_REG_END_LOT_HS_UI";
                    break;
            }

            return bizRuleName;
        }

        string GetCheckMaterialBizRuleName()
        {
            string bizRuleName;

            switch (procId)
            {
                case "E1000":
                    bizRuleName = "DA_PRD_SEL_CHKMTRL_MX";
                    break;

                case "E2000":
                default:
                    bizRuleName = "DA_PRD_SEL_CHKMTRL_CT";
                    break;
            }

            return bizRuleName;
        }
        #endregion

        #region warning & block util
        private string GetMessageAsOne(Dictionary<string, object[]> msgId)
        {
            string message = string.Empty;
            int cnt = 1;

            foreach (KeyValuePair<string, object[]> pair in msgId)
            {
                string tmpMsg = MessageDic.Instance.GetMessage(pair.Key, pair.Value);
                tmpMsg = tmpMsg.Replace("\\r\\n", Environment.NewLine).Replace("\\n", Environment.NewLine);
                tmpMsg = cnt.ToString() + ". " + tmpMsg;
                if (msgId.Count > cnt)
                {
                    tmpMsg += Environment.NewLine;
                }

                message += tmpMsg;
                cnt++;
            }
            return string.IsNullOrEmpty(message) ? message : message.Substring(0, message.Length - 1);
        }

        private void MessageWarning(Dictionary<string, object[]> warningMsgId, Action callback)
        {
            string message = GetMessageAsOne(warningMsgId);

            if (!string.IsNullOrEmpty(message))
            {
                ControlsLibrary.MessageBox.Show(message, "", "Caution", MessageBoxButton.OKCancel, MessageBoxIcon.None, (result) => {
                    if (result == MessageBoxResult.OK)
                    {
                        callback();
                    }
                });
            }
            else
            {
                callback();
            }
        }

        private bool MessageBlock(Dictionary<string, object[]> blockMsgId)
        {
            bool result = true;
            string message = GetMessageAsOne(blockMsgId);

            if (!string.IsNullOrEmpty(message))
            {
                ControlsLibrary.MessageBox.Show(message, "", "Caution", MessageBoxButton.OK, MessageBoxIcon.None, null);
                result = false;
            }

            return result;
        }
        #endregion

        #region Coater Slurry Popup
        private void GetCoaterSlurryPopup(string Cot_LOTID)
        {
            // CSR : [C20211216-000385] - Coater slurry replacement and MMD conversion management

            string sWOID = string.Empty;
            string sPRODID = string.Empty;
            string sLLType = string.Empty;
            string sLLTypeNAME = string.Empty;
            string sPLType = string.Empty;
            string sPLTypeNAME = string.Empty;
            string sSlurry_Lot1 = string.Empty;
            string sSlurry_Lot2 = string.Empty;
            string sChkSlurry = string.Empty;
            string sMessage = string.Empty;

            int iChkFlag = 0;

            bool isPopup = false; //Popup 진행여부

            MessageBoxButton Msgbtn = new MessageBoxButton();

            UC_WORKORDER wo = grdWorkOrder.Children[0] as UC_WORKORDER;

            int idx = new Util().GetDataGridCheckFirstRowIndex(wo.dgWorkOrder, "CHK");

            if (idx > -1 && string.Equals(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "EIO_WO_SEL_STAT"), "Y"))
            {
                sWOID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "WOID"));
                sPRODID = Util.NVC(DataTableConverter.GetValue(wo.dgWorkOrder.Rows[idx].DataItem, "PRODID"));
            }

            if (string.IsNullOrEmpty(sWOID))
            {
                //Util.MessageValidation("SFU1635");  //선택된 W/O가 없습니다.
                isSlurryPopup = false;
                return;
            }

            if (txtSlurry1.Visibility == Visibility.Visible)
                sSlurry_Lot1 = txtSlurry1.Text;

            if (txtSlurry2.Visibility == Visibility.Visible)
                sSlurry_Lot2 = txtSlurry2.Text;

            if (string.IsNullOrEmpty(sSlurry_Lot2))
                sSlurry_Lot2 = sSlurry_Lot1;

            if (string.IsNullOrEmpty(sSlurry_Lot1))
            {
                isSlurryPopup = false;
                return;
            }

            DataTable dtIndata = new DataTable();
            dtIndata.Columns.Add("AREAID", typeof(string));
            dtIndata.Columns.Add("EQPTID", typeof(string));
            dtIndata.Columns.Add("SLURRY_LOTID1", typeof(string));
            dtIndata.Columns.Add("SLURRY_LOTID2", typeof(string));
            dtIndata.Columns.Add("MTRLID", typeof(string));
            dtIndata.Columns.Add("PRODID", typeof(string));
            dtIndata.Columns.Add("COT_LOTID", typeof(string));
            dtIndata.Columns.Add("USERID", typeof(string));

            DataRow dr = dtIndata.NewRow();
            dr["AREAID"] = LoginInfo.CFG_AREA_ID;
            dr["EQPTID"] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
            dr["SLURRY_LOTID1"] = sSlurry_Lot1;
            dr["SLURRY_LOTID2"] = sSlurry_Lot2;
            dr["MTRLID"] = txtSlurry1.Tag;
            dr["PRODID"] = sPRODID;
            dr["COT_LOTID"] = Cot_LOTID;
            dr["USERID"] = LoginInfo.USERID;

            dtIndata.Rows.Add(dr);

            DataTable dtRslt = new ClientProxy().ExecuteServiceSync("BR_PRD_CHK_COATER_SLURRY_SUM", "RQSTDT", "RSLTDT", dtIndata);

            // 조회 데이터가 없으면 Popup 실행하지 않음
            if (dtRslt == null || dtRslt.Rows.Count == 0)
            {
                isSlurryPopup = false;
                return;
            }

            // Slurry 재고량과 Coater 총 생산량 비교 값
            for (int i = 0; i < dtRslt.Rows.Count; i++)
            {
                if (dtRslt.Rows[i]["MIX_COA_YN"].ToString() == "Y")
                {
                    sChkSlurry = dtRslt.Rows[i]["LOTID"].ToString();
                    isPopup = true;

                    iChkFlag++;
                }
            }

            if (!isPopup)
            {
                isSlurryPopup = false;
                return;
            }

            // Top & Back 둘다 Slurry 양품량 보다 Coater 생산량이 초과면 메시지만 표기
            if (iChkFlag == 2)
            {
                sMessage = MessageDic.Instance.GetMessage("SFU8471");

                Msgbtn = MessageBoxButton.OK;
            }
            else
            {
                string sLotID = string.Empty;
                if (txtSlurry1.Text == sChkSlurry)
                    if (txtSlurry1.Visibility == Visibility.Visible && txtSlurry2.Visibility == Visibility.Visible)
                        sLotID = "TOP ( " + sChkSlurry + " )";
                    else
                        sLotID = "SLURRY ( " + sChkSlurry + " )";
                else
                    sLotID = "BACK ( " + sChkSlurry + " )";

                sMessage = MessageDic.Instance.GetMessage("SFU8470", new object[] { sLotID });
                Msgbtn = MessageBoxButton.OKCancel;
            }
            
            LGC.GMES.MES.ControlsLibrary.MessageBox.Show(sMessage, null, "Confirm", Msgbtn, MessageBoxIcon.None, (result) =>
            {
                if (result == MessageBoxResult.OK)
                {
                    isSlurryPopup = false;

                    if (iChkFlag != 2)
                    {
                        CMM_ELEC_SLURRY popup = new CMM_ELEC_SLURRY();
                        popup.FrameOperation = FrameOperation;

                        if (EQUIPMENT_COMBO.SelectedIndex > 0 && !string.IsNullOrEmpty(sWOID))
                        {
                            object[] Parameters = new object[8];
                            Parameters[0] = procId;
                            Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                            Parameters[2] = Util.NVC(sWOID);
                            Parameters[3] = Util.NVC(EQUIPMENT_COMBO.SelectedValue);
                            Parameters[4] = (txtSlurry1.Text == sChkSlurry) ? 0 : 1;
                            Parameters[5] = (txtSlurry1.Text == sChkSlurry) ? txtSlurry1.Text : txtSlurry2.Text;
                            Parameters[6] = isSingleCoater == true ? "Y" : "N";
                            Parameters[7] = Util.NVC(DataTableConverter.GetValue(EQUIPMENT_COMBO.SelectedItem, "WIDE_ROLL_FLAG"));
                            //CSR C20210518-000221 코팅 공정진척 시, 투입 Slurry Lot 유형에 대한 Validation
                            //Type코드와 명칭
                            //Parameters[8] = Util.NVC(sPLType) != string.Empty ? Util.NVC(sPLType) : Util.NVC(sLLType);
                            //Parameters[9] = Util.NVC(sPLType) != string.Empty ? Util.NVC(sPLTypeNAME) : Util.NVC(sLLTypeNAME);

                            C1WindowExtension.SetParameters(popup, Parameters);

                            popup.Closed += new EventHandler(OnClickSlurryClose);
                            Dispatcher.BeginInvoke(new Action(() => popup.ShowModal()));
                            popup.CenterOnScreen();
                        }
                    }
                }
                else
                {
                    isSlurryPopup = false;
                }
            });
        }
        #endregion

        #region LANE 체크
        /// <summary>
        /// 버전 LANE 체크 
        ///  -. MMD LANE 정보와 입력 LANE 정보 일치여부 판단. _ 2022.04.05 ysh76
        /// </summary>
        /// <returns></returns>
        private bool ValidVerLaneQtyChk(string chk_type)
        {
            bool bRet = true;

            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("PROD_VER_CODE", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Indata["PROD_VER_CODE"] = Util.NVC(Util.NVC(txtVersion.Text));
                IndataTable.Rows.Add(Indata);

                DataTable dtMain = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_CONV_RATE_V01", "INDATA", "RSLTDT", IndataTable);
                //조건에 맞는 정보가 없다면 true
                if (dtMain.Rows.Count == 0)
                {
                    return bRet;
                }

                int verLaneQty = Util.NVC_Int(dtMain.Rows[0]["LANE_QTY"]);
                //INPUTVALUE는 사용자가 입력한 LANE 수, CHK_VALUE1 는 GPLM MMD LANE 수
                dtMain.BeginInit();
                dtMain.Columns.Add("INPUTVALUE", typeof(decimal));
                dtMain.Columns.Add("CHK_VALUE1", typeof(decimal));
                dtMain.Rows[0]["CHK_VALUE1"] = Util.NVC_Decimal(verLaneQty);
                dtMain.Rows[0]["INPUTVALUE"] = Util.NVC_Decimal(txtLaneQty.Value);
                dtMain.EndInit();
                dtMain.AcceptChanges();

                //실적 확정권한체크에서 CNFM_COAT_LANE_CHK 마스터 정보에 의한 value 정보 체크
                bRet = CheckLimitValue(chk_type, dtMain);

            }
            catch (Exception ex)
            {


            }

            return bRet;
        }
        #endregion

        #region 슬리터공정 샘플링 체크
        private bool GetSlitSampChk(string CUT_ID)
        {
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("CUT_ID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["CUT_ID"] = CUT_ID;
                IndataTable.Rows.Add(Indata);

                DataTable dtSlitSamp = new ClientProxy().ExecuteServiceSync("BR_PRD_SEL_SLIT_SAMP_CUT_ID", "INDATA", "RSLTDT", IndataTable);

                if (dtSlitSamp != null && dtSlitSamp.Rows.Count > 0)
                    return true;

                return false;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }
        #endregion

        #region 바코드 발행 실행
        private void GetBarCodePrint()
        {
            DataTable printDT = GetPrintCount(_LOTID, procId);

            if (printDT.Rows.Count > 0 && Util.NVC_Decimal(printDT.Rows[0]["PRT_COUNT1"]) > 0)
            {
                // 이미 해당 공정에서 발행된 Lot인데 재 발행하시겠습니까?
                Util.MessageConfirm("SFU3463", (sresult) =>
                {
                    if (sresult == MessageBoxResult.OK)
                    {
                        try
                        {
                            #region [샘플링 출하거래처 추가]
                            // SAMPLING용 발행 매수 추가
                            int iSamplingCount;

                            DataTable LabelDT = new DataTable();
                            LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                            //슬리터2차 추가  2021-09-15  by 오화백
                            if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                            {
                                DataTable sampleDT = new DataTable();
                                sampleDT.Columns.Add("CUT_ID", typeof(string));
                                sampleDT.Columns.Add("LOTID", typeof(string));
                                sampleDT.Columns.Add("COMPANY", typeof(string));
                                DataRow dRow = null;

                                foreach (DataRow _iRow in LabelDT.Rows)
                                {
                                    iSamplingCount = 0;
                                    string[] sCompany = null;
                                    foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                    {
                                        iSamplingCount = Util.NVC_Int(items.Key);
                                        sCompany = Util.NVC(items.Value).Split(',');
                                    }
                                    for (int i = 0; i < iSamplingCount; i++)
                                    {
                                        dRow = sampleDT.NewRow();
                                        dRow["CUT_ID"] = _iRow["CUT_ID"];
                                        dRow["LOTID"] = _iRow["LOTID"];
                                        dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                        sampleDT.Rows.Add(dRow);
                                    }
                                }
                                var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                                for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                                    for (int i = 0; i < sortdt.Rows.Count; i++)
                                        Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                            }
                            else
                            {
                                //C20210415-000402 [2021-06-22]
                                int iFirstCutCNT = 0;

                                if (string.Equals(procId, Process.COATING) && (_CUT == "1"))
                                    iFirstCutCNT = LoginInfo.CFG_LABEL_FIRST_CUT_COPIES;

                                for (int ii = 0; ii < (LoginInfo.CFG_LABEL_COPIES + iFirstCutCNT); ii++)
                                    foreach (DataRow _iRow in LabelDT.Rows)
                                    {
                                        iSamplingCount = 0;
                                        string[] sCompany = null;
                                        foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                        {
                                            iSamplingCount = Util.NVC_Int(items.Key);
                                            sCompany = Util.NVC(items.Value).Split(',');
                                        }

                                        for (int i = 0; i < iSamplingCount; i++)
                                            Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId, i > sCompany.Length - 1 ? "" : sCompany[i]);
                                    }
                            }
                            #endregion
                        }
                        catch (Exception ex) { Util.MessageException(ex); }
                    }
                });
            }
            else
            {
                try
                {
                    DataTable LabelDT = new DataTable();
                    LabelDT = (LOTINFO_GRID.ItemsSource as DataView).Table;

                    // S/L공정은 Default 라벨 발행 매수 포함해서 출력해달라고 자동차2동 요청 [2018-07-10]
                    // 슬리터 2차 추가  2021-09-15 by 오화백
                    if (string.Equals(procId, Process.SLITTING) || string.Equals(procId, "E4200"))
                    {
                        #region [샘플링 출하거래처 추가]
                        // SAMPLING용 발행 매수 추가
                        int iSamplingCount;
                        DataTable sampleDT = new DataTable();
                        sampleDT.Columns.Add("CUT_ID", typeof(string));
                        sampleDT.Columns.Add("LOTID", typeof(string));
                        sampleDT.Columns.Add("COMPANY", typeof(string));
                        DataRow dRow = null;

                        foreach (DataRow _iRow in LabelDT.Rows)
                        {
                            iSamplingCount = 0;
                            string[] sCompany = null;
                            foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                            {
                                iSamplingCount = Util.NVC_Int(items.Key);
                                sCompany = Util.NVC(items.Value).Split(',');
                            }
                            for (int i = 0; i < iSamplingCount; i++)
                            {
                                dRow = sampleDT.NewRow();
                                dRow["CUT_ID"] = _iRow["CUT_ID"];
                                dRow["LOTID"] = _iRow["LOTID"];
                                dRow["COMPANY"] = i > sCompany.Length - 1 ? "" : sCompany[i];
                                sampleDT.Rows.Add(dRow);
                            }
                        }
                        //sampleDT.DefaultView.Sort = "CUT_ID ASC, COMPANY ASC";
                        var sortdt = sampleDT.AsEnumerable().OrderBy(x => x.Field<string>("CUT_ID") + x.Field<string>("COMPANY")).CopyToDataTable();
                        for (int ii = 0; ii < LoginInfo.CFG_LABEL_COPIES; ii++)
                            for (int i = 0; i < sortdt.Rows.Count; i++)
                                Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(sortdt.DefaultView[i]["LOTID"]), procId, Util.NVC(sortdt.DefaultView[i]["COMPANY"]));
                        #endregion
                    }
                    else
                    {
                        //foreach (DataRow _iRow in LabelDT.Rows)
                        //    Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId);

                        //C20210415-000402 [2021-06-22]
                        int iFirstCutCNT = 0;

                        if (string.Equals(procId, Process.COATING) && (_CUT == "1"))
                            iFirstCutCNT = LoginInfo.CFG_LABEL_FIRST_CUT_COPIES;

                        int iSamplingCount;
                        for (int ii = 0; ii < (LoginInfo.CFG_LABEL_COPIES + iFirstCutCNT); ii++)
                            foreach (DataRow _iRow in LabelDT.Rows)
                            {
                                iSamplingCount = 0;
                                string[] sCompany = null;
                                foreach (KeyValuePair<int, string> items in getSamplingLabelInfo(Util.NVC(_iRow["LOTID"])))
                                {
                                    iSamplingCount = Util.NVC_Int(items.Key);
                                    sCompany = Util.NVC(items.Value).Split(',');
                                }

                                for (int i = 0; i < iSamplingCount; i++)
                                    Util.PrintLabel_Elec(FrameOperation, loadingIndicator, Util.NVC(_iRow["LOTID"]), procId, i > sCompany.Length - 1 ? "" : sCompany[i]);
                            }
                    }
                }
                catch (Exception ex) { Util.MessageException(ex); }
            }
        }
        #endregion
        #region 품질 spec over 여부 알람 처리
        //C20220713-000423 상/하한 초과하여 측정값 입력시 알람 팝업 생성 (오창 자동차)
        private void WarningQualitySpecChk(Dictionary<string, object[]> msgId)
        {
            if (IsAreaCommonCodeUse("ELEC_SPEC_OVER_ALAM_USE", procId))
            {
                if (!ValidQualitySpec("Auth"))
                {
                    msgId.Add("SFU8192", null);
                }
            }
        }
        #endregion

        #region 롤맵 Hold 기능 추가 Start
        private string GetMessageWithSubstitution(string messageId, params object[] parameters)
        {
            DataTable dtMessage = GetMessageFromCommonCode(messageId);
            string message = string.Empty;

            if (CommonVerify.HasTableRow(dtMessage))
            {
                message = dtMessage.Rows[0]["CMCDNAME"].ToString();
            }
            message = message.Replace("\\r\\n", Environment.NewLine).Replace("\\n", Environment.NewLine);
            if (message.IndexOf("%1", StringComparison.Ordinal) > -1)
            {
                for (int i = 0; i < parameters.Length; i++)
                {
                    message = message.Replace("%" + (i + 1), parameters[i].ToString());
                }
            }
            else
            {
                message = MessageDic.Instance.GetMessage(messageId, parameters);
            }

            return message;
        }

        private DataTable GetMessageFromCommonCode(string messageId)
        {
            DataTable dt = new DataTable("RQSTDT");
            dt.Columns.Add("LANGID", typeof(string));
            dt.Columns.Add("CMCDTYPE", typeof(string));
            dt.Columns.Add("CMCODE", typeof(string));

            DataRow dr = dt.NewRow();
            dr["LANGID"] = LoginInfo.LANGID;
            dr["CMCDTYPE"] = "ROLLMAP_HOLD_CONDITION_MSG";
            dr["CMCODE"] = null;
            dt.Rows.Add(dr);

            DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", dt);

            if (CommonVerify.HasTableRow(dtResult))
            {

                var resultCmcode = (from t in dtResult.AsEnumerable()
                                    where messageId.Equals(t.Field<string>("CMCODE"))
                                    orderby t.GetValue("CMCDSEQ").GetDecimal() ascending
                                    select t);
                if (resultCmcode.Any())
                {
                    return resultCmcode.CopyToDataTable();
                }
                else
                {
                    return null;
                }
            }
            else
            {
                return null;
            }
        }
        #endregion

        #region 롤맵 코터 수불 적용
        //nathan 2023.12.13 롤맵 코터 수불 실적 적용 - start
        private void setRollmapResultLinkBtn()
        {
            (grdDataCollect.Children[0] as UcDataCollect).btnRollMapUpdate.Visibility = Visibility.Collapsed;

            if (LOTID == "") return; // 여기서는 LOTID 이후에는 _LOTID, 조회 후에 LOTID 에 PR_LOTID 가 들어감.
            if (isRollMapResultLink == false) return;
            if (isRollMapEquipment == false) return;
            if (WIPSTATUS != "EQPT_END") return;
            // 롤프레스 공정은 롤맵2.0 실적 적용 대상이 현재 아님(2024.11.04) 코터 공정에 한하여 롤맵수정 버튼 속성 지정 함.
            if (!string.Equals(procId, Process.COATING)) return;

            (grdDataCollect.Children[0] as UcDataCollect).btnRollMapUpdate.Visibility = Visibility.Visible;

        }

        private void btnRollMapUpdate_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (_EQPTID == "") return;
                if (_LOTID == "") return;
                // RollMap 실적 수정 Popup Call
                
                object[] Parameters = new object[10];
                Parameters[0] = PROCID;
                Parameters[1] = Util.NVC(EQUIPMENTSEGMENT_COMBO.SelectedValue);
                Parameters[2] = _EQPTID;
                Parameters[3] = _LOTID;
                Parameters[4] = _WIPSEQ;
                Parameters[5] = _LANEQTY;
                Parameters[6] = "";
                Parameters[7] = txtVersion != null ? Util.NVC(txtVersion.Text) : null;
                Parameters[8] = "N"; //Test Cut Visible false
                Parameters[9] = "N"; //Search Mode False

                // RollMap 실적 수정 Popup Call
                if (PROCID == Process.COATING)
                {
                    CMM_RM_CT_RESULT popupRollMapUpdate = new CMM_RM_CT_RESULT { FrameOperation = FrameOperation };

                    if (popupRollMapUpdate != null)
                    {


                        C1WindowExtension.SetParameters(popupRollMapUpdate, Parameters);

                        if (popupRollMapUpdate != null)
                        {
                            popupRollMapUpdate.ShowModal();
                            popupRollMapUpdate.CenterOnScreen();
                            popupRollMapUpdate.Closed += new EventHandler(PopupRollMapUpdate_Closed);
                        }
                    }
                }
                else if (PROCID == Process.ROLL_PRESSING)
                {
                    CMM_RM_RP_RESULT popupRollMapUpdate = new CMM_RM_RP_RESULT { FrameOperation = FrameOperation };

                    if (popupRollMapUpdate != null)
                    {
                        C1WindowExtension.SetParameters(popupRollMapUpdate, Parameters);

                        if (popupRollMapUpdate != null)
                        {
                            popupRollMapUpdate.ShowModal();
                            popupRollMapUpdate.CenterOnScreen();
                            popupRollMapUpdate.Closed += new EventHandler(PopupRollMapUpdate_RP_Closed);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }

        }

        private void PopupRollMapUpdate_Closed(object sender, EventArgs e)
        {
            ///////////////////// ROLLMAP 실적 수정시 불량/LOSS/물품청구 재조회
            CMM_RM_CT_RESULT popup = sender as CMM_RM_CT_RESULT;
            if (popup.IsUpdated)
            {
                GetLotInfo(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem);

                if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectList();
                else if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectListMultiLane();
                //GetDefectList();
                //SelectDefectSync((grdDataCollect.Children[0] as UcDataCollect).dgWipReason, "DEFECT_TOP");
                //SelectDefectSync((grdDataCollect.Children[0] as UcDataCollect).dgWipReason2, "DEFECT_BACK");

                //SumDefectQty();

            }
        }

        private void PopupRollMapUpdate_RP_Closed(object sender, EventArgs e)
        {
            ///////////////////// ROLLMAP 실적 수정시 불량/LOSS/물품청구 재조회
            CMM_RM_RP_RESULT popup = sender as CMM_RM_RP_RESULT;
            if (popup.IsUpdated)
            {
                GetLotInfo(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem);

                if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) == LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectList();
                else if ((LOTINFO_GRID.Rows.Count - LOTINFO_GRID.BottomRows.Count) > LOTINFO_GRID.TopRows.Count + 1)
                    GetDefectListMultiLane();
                //GetDefectList();
                //SelectDefectSync((grdDataCollect.Children[0] as UcDataCollect).dgWipReason, "DEFECT_TOP");
                //SelectDefectSync((grdDataCollect.Children[0] as UcDataCollect).dgWipReason2, "DEFECT_BACK");

                //SumDefectQty();

            }
        }

        private bool ValidationRollMapLotNextProcessMove()
        {
            try
            {
                const string bizRuleName = "BR_PRD_CHK_ROLLMAP_LOT_NEXT_PROC_MOVE";
                DataTable inTable = new DataTable();
                inTable.Columns.Add("LOTID", typeof(string));
                inTable.Columns.Add("WIPSEQ", typeof(decimal));

                DataRow dr = inTable.NewRow();
                dr["LOTID"] = Util.NVC(_LOTID);
                dr["WIPSEQ"] = Util.NVC(_WIPSEQ);
                inTable.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync(bizRuleName, "INDATA", null, inTable);
                return true;
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }

        private void btnSaveTestCut_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidationTestCut((grdDataCollect.Children[0] as UcDataCollect).dgTestCut)) return;

            if ((grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyY.IsChecked == true)
            {
                // 선택한 항목을 Loss로 반영하시겠습니까?
                Util.MessageConfirm("SFU5173", (result) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        SaveTestCut((grdDataCollect.Children[0] as UcDataCollect).dgTestCut);
                    }
                });
            }
            else if ((grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyN.IsChecked == true)
            {
                // 전체 항목을 Loss 미반영 하시겠습니까?
                Util.MessageConfirm("SFU5174", (result) =>
                {
                    if (result == MessageBoxResult.OK)
                    {
                        SaveTestCut((grdDataCollect.Children[0] as UcDataCollect).dgTestCut);
                    }
                });
            }
        }

        private bool ValidationTestCut(C1DataGrid dg)
        {
            // Loss 반영 – YES : 체크박스 선택유무 확인, Loss Code 선택 확인 후 체크한 항목을 Loss로 반영하시겠습니까? 메시지
            if (dg.GetRowCount() <= 0)
            {
                Util.MessageValidation("SFU1886");     // 정보가 없습니다.
                return false;
            }

            // Loss 반영
            if ((grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyY.IsChecked == true)
            {
                List<DataRow> drList = dg.GetCheckedDataRow("CHK");
                if (drList.Count == 0)
                {
                    Util.MessageValidation("SFU1651");  // 선택된 항목이 없습니다.
                    return false;
                }

                if (!string.IsNullOrEmpty((grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text) && Convert.ToDecimal((grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text) != 0 && (grdDataCollect.Children[0] as UcDataCollect).cboTCTopLoss.SelectedIndex < 1)
                {
                    Util.MessageValidation("SFU1639");  // 선택된 불량코드가 없습니다
                    return false;
                }

                if (!string.IsNullOrEmpty((grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text) && Convert.ToDecimal((grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text) != 0 && (grdDataCollect.Children[0] as UcDataCollect).cboTCBackLoss.SelectedIndex < 1)
                {
                    Util.MessageValidation("SFU1639");  // 선택된 불량코드가 없습니다
                    return false;
                }
            }

            return true;
        }

        private void dgTestCut_LoadedCellPresenter(object sender, DataGridCellEventArgs e)
        {
            C1DataGrid dataGrid = sender as C1DataGrid;

            if (dataGrid == null) return;
        }

        private void chkTestCut_Checked(object sender, System.Windows.RoutedEventArgs e)
        {

        }

        /// <summary>
        /// Test Cut Loss 반영 여부 저장
        /// </summary>
        /// <param name="dg"></param>
        private void SaveTestCut(C1DataGrid dg)
        {
            try
            {
                if (dg.GetRowCount() <= 0) return;

                dg.EndEdit(true);

                DataSet ds = new DataSet();

                DataTable dtData = new DataTable("IN_DATA");
                dtData.Columns.Add("OUTPUT_LOTID", typeof(string));
                dtData.Columns.Add("WIPSEQ", typeof(decimal));
                dtData.Columns.Add("TOP_LOSS_CODE", typeof(string));
                dtData.Columns.Add("BACK_LOSS_CODE", typeof(string));
                dtData.Columns.Add("REMARKS", typeof(string));
                dtData.Columns.Add("USERID", typeof(string));
                dtData.Columns.Add("CNFM_USERID", typeof(string));
                dtData.Columns.Add("EQPTID", typeof(string));

                DataRow dr = dtData.NewRow();
                dr["OUTPUT_LOTID"] = _LOTID;
                dr["WIPSEQ"] = _WIPSEQ;
                if (!string.IsNullOrEmpty((grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text) && Convert.ToDecimal((grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text) != 0)
                    dr["TOP_LOSS_CODE"] = Util.GetCondition((grdDataCollect.Children[0] as UcDataCollect).cboTCTopLoss);
                else
                    dr["TOP_LOSS_CODE"] = string.Empty;
                if (!string.IsNullOrEmpty((grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text) && Convert.ToDecimal((grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text) != 0)
                    dr["BACK_LOSS_CODE"] = Util.GetCondition((grdDataCollect.Children[0] as UcDataCollect).cboTCBackLoss);
                else
                    dr["BACK_LOSS_CODE"] = string.Empty;        // dr["TOP_LOSS_CODE"] = string.Empty;

                dr["USERID"] = LoginInfo.USERID;
                dr["CNFM_USERID"] = LoginInfo.USERID;
                dr["EQPTID"] = _EQPTID;
                dtData.Rows.Add(dr);

                DataTable dtCut = new DataTable("IN_CUT");
                dtCut.Columns.Add("CUT_RPT_DTTM", typeof(DateTime));
                dtCut.Columns.Add("LOSS_APPLY_FLAG", typeof(string));

                for (int i = 2; i < dg.Rows.Count; i++)
                {
                    dr = dtCut.NewRow();
                    dr["CUT_RPT_DTTM"] = dg.GetValue(i, "CUT_RPT_DTTM");
                    dr["LOSS_APPLY_FLAG"] = ((grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyN.IsChecked == true) ? "N" : (dg.GetValue(i, "CHK").ToString().Equals("True") || dg.GetValue(i, "CHK").ToString().Equals("1")) ? "Y" : "N";
                    dtCut.Rows.Add(dr);
                }

                ds.Tables.Add(dtData);
                ds.Tables.Add(dtCut);

                //ShowLoadingIndicator();

                new ClientProxy().ExecuteService_Multi("BR_PRD_REG_TEST_CUT_APPLY_LOSS", "IN_DATA,IN_CUT", null, (bizResult, bizException) =>
                {
                    try
                    {
                        //HiddenLoadingIndicator();

                        if (bizException != null)
                        {
                            Util.MessageException(bizException);
                            return;
                        }

                        _isTestCutApply = true;

                        Util.MessageInfo("SFU3532");     // 저장 되었습니다
                        SelectTestCut(dg);
                    }
                    catch (Exception ex)
                    {
                        //HiddenLoadingIndicator();
                        Util.MessageException(ex);
                    }
                }, ds);
            }
            catch (Exception ex)
            {
                //HiddenLoadingIndicator();
                Util.MessageException(ex);
            }
        }

        /// <summary>
        /// Test Cut 이력 조회
        /// </summary>
        /// <param name="dg"></param>
        private void SelectTestCut(C1DataGrid dg)
        {
            try
            {
                if ((grdDataCollect.Children[0] as UcDataCollect).tiTestcut.Visibility == Visibility.Collapsed) return;

                Util.gridClear(dg);

                DataTable dt = new DataTable();
                dt.Columns.Add("LANGID", typeof(string));
                dt.Columns.Add("OUTPUT_LOTID", typeof(string));

                DataRow newRow = dt.NewRow();
                newRow["LANGID"] = LoginInfo.LANGID;
                newRow["OUTPUT_LOTID"] = Util.NVC(_LOTID);
                dt.Rows.Add(newRow);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_PRD_SEL_TB_SFC_TEST_CUT_HIST", "RQSTDT", "RSLTDT", dt);

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    Util.GridSetData(dg, dtResult, FrameOperation);
                    DataRow dr = dtResult.Rows[0];
                    if (dr["LOSS_APPLY_CNFM_FLAG"].Equals("Y"))
                    {
                        _isTestCutApply = true;
                        (grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text = (string.IsNullOrEmpty(dr["SUM_TOP_LOSS_QTY"].ToString())) ? "0" : dr["SUM_TOP_LOSS_QTY"].ToString();
                        (grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text = (string.IsNullOrEmpty(dr["SUM_BACK_LOSS_QTY"].ToString())) ? "0" : dr["SUM_BACK_LOSS_QTY"].ToString();
                        (grdDataCollect.Children[0] as UcDataCollect).txtConfirmTime.Text = dr["CNFM_DTTM"].ToString();
                        (grdDataCollect.Children[0] as UcDataCollect).cboTCTopLoss.SelectedValue = (string.IsNullOrEmpty(dr["TOP_LOSS_CODE"]?.ToString())) ? "SELECT" : dr["TOP_LOSS_CODE"].ToString();
                        (grdDataCollect.Children[0] as UcDataCollect).cboTCBackLoss.SelectedValue = (string.IsNullOrEmpty(dr["BACK_LOSS_CODE"]?.ToString())) ? "SELECT" : dr["BACK_LOSS_CODE"].ToString();

                        DataRow[] drN = dtResult.Select("LOSS_APPLY_FLAG = 'N'");
                        if (dtResult.Rows.Count == drN.Length)
                            (grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyN.IsChecked = true;
                        else
                            (grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyY.IsChecked = true;
                    }
                    else
                    {
                        _isTestCutApply = false;
                        (grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyY.IsChecked = true;
                    }
                }
                else
                {
                    (grdDataCollect.Children[0] as UcDataCollect).rdoTCApplyY.IsChecked = true;
                    _isTestCutApply = true; //Test Cut 이력 없을 경우 true 처리
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        protected virtual void dgTestCut_CurrentCellChanged(object sender, DataGridCellEventArgs e)
        {
            switch ((sender as C1DataGrid).Name)
            {
                case "dgTestCut":
                    this.Dispatcher.BeginInvoke(new Action(() =>
                    {
                        C1DataGrid dg = sender as C1DataGrid;

                        if (e.Cell != null && e.Cell.Presenter != null && e.Cell.Presenter.Content != null)
                        {
                            CheckBox chk = e.Cell.Presenter.Content as CheckBox;

                            if (chk != null)
                            {
                                switch (Convert.ToString(e.Cell.Column.Name))
                                {
                                    case "CHK":
                                        if (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter != null &&
                                           dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox) != null &&
                                           (dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked.HasValue &&
                                           !(bool)(dg.GetCell(e.Cell.Row.Index, e.Cell.Column.Index).Presenter.Content as CheckBox).IsChecked)
                                        {
                                            DataTableConverter.SetValue(dg.Rows[e.Cell.Row.Index].DataItem, "CHK", true);
                                            chk.IsChecked = true;

                                            List<DataRow> drList = (grdDataCollect.Children[0] as UcDataCollect).dgTestCut.GetCheckedDataRow("CHK");

                                            decimal dSumTopLoss = drList.Sum(row => row.GetValue("DTL_TOP_LOSS").GetDecimal());
                                            decimal dSumBackLoss = drList.Sum(row => row.GetValue("DTL_BACK_LOSS").GetDecimal());

                                            (grdDataCollect.Children[0] as UcDataCollect).txtTCTopLossQty.Text = dSumTopLoss.ToString();
                                            (grdDataCollect.Children[0] as UcDataCollect).txtTCBackLossQty.Text = dSumBackLoss.ToString();
                                        }
                                        break;
                                }
                            }
                        }
                    }));
                    break;
            }
        }

        private void SetControlTestCut()
        {
            if ((grdDataCollect.Children[0] as UcDataCollect).tiTestcut.Visibility == Visibility.Collapsed) return;

            SelectLossCombo((grdDataCollect.Children[0] as UcDataCollect).cboTCTopLoss, "DEFECT_TOP");
            SelectLossCombo((grdDataCollect.Children[0] as UcDataCollect).cboTCBackLoss, "DEFECT_BACK");
        }

        private void SelectLossCombo(C1ComboBox cb, string sResnposition)
        {
            try
            {
                cb.ItemsSource = null;

                const string bizRuleName = "DA_PRD_SEL_ACTIVITYREASON_ELEC";
                string[] arrColumn = { "LANGID", "AREAID", "LOTID", "ACTID", "RESNPOSITION" };
                string[] arrCondition = { LoginInfo.LANGID, LoginInfo.CFG_AREA_ID, Util.NVC(_LOTID), "LOSS_LOT", sResnposition };
                string selectedValueText = "RESNCODE";
                string displayMemberText = "RESNNAME";

                CommonCombo.CommonBaseCombo(bizRuleName, cb, arrColumn, arrCondition, CommonCombo.ComboStatus.SELECT, selectedValueText, displayMemberText, selectedValue: "SELECT");
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        public bool CheckTestCut()
        {
            try
            {
                //TEST CUT 이력 존재하는데 LOSS 반영 여부 미확정 일 때
                if (!_isTestCutApply)
                {
                    Util.MessageValidation("SFU5172");     // Test Cut 이력이 존재합니다. Loss 반영 여부를 선택해 주세요.
                    (grdDataCollect.Children[0] as UcDataCollect).tcDataCollect.SelectedItem = (grdDataCollect.Children[0] as UcDataCollect).tiTestcut;
                    return false;
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }

            return true;
        }

        //nathan 2023.12.13 롤맵 코터 수불 실적 적용 - end   
        #endregion

        #region RollPressTimer 관련 : TimerSettingRollPress(), _rollPressTimer_Tick()

        private void TimerSettingRollPress()
        {
            if (_rollPressTimer != null)
            {
                _rollPressTimer.Tick += _rollPressTimer_Tick;
                _rollPressTimer.Interval = new TimeSpan(0, 5, 0); //반복주기 5분으로 설정
                _rollPressTimer.Start();
            }
        }


        private void _rollPressTimer_Tick(object sender, EventArgs e)
        {
            if (sender == null)
                return;

            isTimerTabCkRollPress = false;
            //Menuid 값 가져오기
            string MENUID = Convert.ToString(DataTableConverter.GetValue(DataContext, "MENUID"));
            //Tab중 롤프레스 공정 UI화면 존재 확인
            foreach (Grid tmp in Util.FindVisualChildren<System.Windows.Controls.Grid>(Application.Current.MainWindow))
            {
                if (tmp.Name == "grdMain")
                {
                    foreach (UIElement ui in tmp.Children)
                    {
                        C1TabControl tabCtrl = ui as C1TabControl;

                        if (tabCtrl != null)
                        {
                            for (int i = 0; i < tabCtrl.Items.Count; i++)
                            {
                                C1TabItem tabItem = tabCtrl.Items[i] as C1TabItem;

                                if (MENUID.Equals(DataTableConverter.GetValue(tabItem.DataContext, "MENUID")))
                                {
                                    isTimerTabCkRollPress = true;
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            //롤프레스 공정진척 UI 종료되면 Timer Stop처리
            if (isTimerTabCkRollPress == false)
            {
                _rollPressTimer.Stop();
                return;
            }

            string delayLotIDs = "";
            DispatcherTimer dpcTmr = sender as DispatcherTimer;
            dpcTmr?.Dispatcher.BeginInvoke(new Action(() =>
            {
                try
                {
                    dpcTmr.Stop();
                    if (Math.Abs(dpcTmr.Interval.TotalSeconds) < 1) return;

                    //메시지 팝업 이중 처리 방지
                    if (isTimerPopupRollPress == true)
                        return;

                    delayLotIDs = ValidateRollPressAlarm();

                    if (delayLotIDs.IsNotEmpty())
                    {
                        Util.MessageInfo("101614", (result) =>
                        {
                            if (result == MessageBoxResult.OK)
                            {
                                isTimerPopupRollPress = false;
                            }
                        }, new object[] { _RollPressEndIntervalMinutes, delayLotIDs , isTimerPopupRollPress = true });
                    }

                }
                catch (Exception ex)
                {
                    Util.MessageException(ex);
                }
                finally
                {
                    if (dpcTmr.Interval.TotalSeconds > 0)
                    {
                        dpcTmr.Start();
                    }
                }
            }));
        }

        private static void DoEvents()
        {
            Application.Current.Dispatcher.Invoke(DispatcherPriority.Background, new ThreadStart(delegate { }));
        }

        #endregion

        #region [E20240206-000574] 인라인 데이터(TWS) 연동을 위한 ESNJ MES(전극,조립) 시스템 기능 추가 요청 건
        private void OnClickSaveTWS_Loading(object sender, RoutedEventArgs e)
        {
            C1DataGrid dgTWS = (grdDataCollect.Children[0] as UcDataCollect).dgTWS_Loading;
            if (dgTWS.GetRowCount() <= 0)
            {
                Util.MessageValidation("SFU1886");     // 정보가 없습니다.
                return ;
            }

            try
            {
                DataSet inDataSet = new DataSet();

                DataTable inDataTable = inDataSet.Tables.Add("INDATA");
                inDataTable.Columns.Add("SRCTYPE", typeof(string));
                inDataTable.Columns.Add("IFMODE", typeof(string));
                inDataTable.Columns.Add("EQPTID", typeof(string));
                inDataTable.Columns.Add("LOTID", typeof(string));
                inDataTable.Columns.Add("REEL_NO", typeof(string));
                inDataTable.Columns.Add("LOAD_WEIGHT", typeof(decimal));
                inDataTable.Columns.Add("USERID", typeof(string));

                DataRow inDataRow = null;

                DataTable dt = ((DataView)dgTWS.ItemsSource).Table;

                foreach (DataRow row in dt.Rows)
                {
                    if (string.IsNullOrEmpty(row["LOAD_WEIGHT"].ToString())
                        || row["LOAD_WEIGHT"].Equals("NaN") ||  row["LOAD_WEIGHT"].Equals(System.DBNull.Value)) continue;  

                    inDataRow = inDataTable.NewRow();
                    inDataRow["SRCTYPE"] = SRCTYPE.SRCTYPE_UI;
                    inDataRow["IFMODE"]  = null;
                    inDataRow["EQPTID"]  = _EQPTID;
                    inDataRow["LOTID"]   = _LOTID;
                    inDataRow["REEL_NO"] = Util.NVC(row["REEL_NO"]);
                    inDataRow["LOAD_WEIGHT"] = Util.NVC_Decimal(row["LOAD_WEIGHT"]);
                    inDataRow["USERID"] = LoginInfo.USERID;

                    inDataTable.Rows.Add(inDataRow);
                }

                // 사용자 확정값이 모두 있는지 확인
                if (dt.Rows.Count != inDataTable.Rows.Count)
                {
                    string item = ObjectDic.Instance.GetObjectName("작업자 KEY-IN LOADING값");
                    Util.MessageValidation("FM_ME_0251", new object[] { item });  //필수항목누락 : %1
                    return;
                }

                DataSet dsRslt = new ClientProxy().ExecuteServiceSync_Multi("BR_REG_TB_SFC_COATING_TWS_LOAD_MEASR", "INDATA", null, inDataSet);

                //[E20240722-000098] [소형파우치형전극기술P] TWS-GMES 연동 시스템 수정 업데이트 요청 건(3rd)
                if (isSilentlySave == false)
                {
                    Thread.Sleep(500);

                    isSaveTWS_Loading = true;
                    if (isSaveTWS_Loading) GetTWS_Load(_LOTID);

                    Util.MessageInfo("SFU1270");    //저장되었습니다.
                }
            }
            catch (Exception ex) { Util.MessageException(ex); }

        }

        private void GetTWS_Load(string sLotID)
        {
            try
            {
                C1TabItem tabItem = (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading;
                if (tabItem.Visibility.Equals(Visibility.Collapsed)) return;

                DoEvents();

                C1DataGrid dgTWS = (grdDataCollect.Children[0] as UcDataCollect).dgTWS_Loading;
                Util.gridClear(dgTWS);

                int iTwsCount = 0;

                DataTable dtRslt = new DataTable();
                try
                {
                    //TWS Data 수 확인
                    iTwsCount = GetTWS_Count(sLotID);

                    DataTable dtRqst = new DataTable();
                    dtRqst.Columns.Add("LOTID", typeof(string));

                    DataRow dr = dtRqst.NewRow();
                    dr["LOTID"] = sLotID;

                    dtRqst.Rows.Add(dr);

                    dtRslt = new ClientProxy().ExecuteServiceSync("DA_SEL_TB_SFC_COATING_TWS_LOAD_MEASR", "INDATA", "OUTDATA", dtRqst);
                    if (dtRslt.Rows.Count > 0)
                    {
                        if (dtRslt.Columns.Contains("UNIT") == false) dtRslt.Columns.Add("UNIT", typeof(string));
                    }
                    else
                    {
                        throw new Exception("GetTWS_Load Error");
                    }

                    // TWS Data 수와 설비 Data 수가 일치하지 않을 경우 작업자 수동입력 유도
                    if (dtRslt.Rows.Count < iTwsCount)
                    {
                        for (int i = 0; i < iTwsCount; i++)
                        {
                            if ( (i+1) > dtRslt.Rows.Count || dtRslt.Rows[i]["REEL_NO"].Equals((i + 1).ToString()) == false )
                            {
                                DataRow drRslt = dtRslt.NewRow();
                                drRslt["LOTID"] = sLotID;
                                drRslt["REEL_NO"] = (i + 1).ToString();
                                drRslt["EQPT_LOAD_WEIGHT"] = DBNull.Value;
                                drRslt["LOAD_WEIGHT"] = DBNull.Value;

                                if ((i + 1) > dtRslt.Rows.Count)
                                    dtRslt.Rows.Add(drRslt);
                                else
                                {
                                    dtRslt.Rows.InsertAt(drRslt, i);
                                }
                            }
                        }
                    }
                    #region [E20240722-000098]  [소형파우치형전극기술P] TWS-GMES 연동 시스템 수정 업데이트 요청 건(3rd)
                    // TWS Data 수와 설비 Data 수 보다 많은 경우 제외 - [REEL_NO]에 매핑 순서값으로 사용
                    else if (dtRslt.Rows.Count > iTwsCount)
                    {
                        dtRslt.AcceptChanges();
                        for (int i = 0; i < dtRslt.Rows.Count; i++)
                        {
                            if (i >= (iTwsCount == 0 ? 8: iTwsCount))
                                dtRslt.Rows[i].Delete();
                        }
                        dtRslt.AcceptChanges();
                    }
                    #endregion
                }
                catch (Exception e)
                {
                    //Util.MessageException(e);

                    dtRslt = new DataTable();
                    dtRslt.Columns.Add("LOTID", typeof(string));
                    dtRslt.Columns.Add("REEL_NO", typeof(string));
                    dtRslt.Columns.Add("EQPT_LOAD_WEIGHT", typeof(string));
                    dtRslt.Columns.Add("LOAD_WEIGHT", typeof(string));
                    dtRslt.Columns.Add("UNIT", typeof(string));

                    if ((iTwsCount > 0) == false) iTwsCount = 8;

                    for (int i = 0; i < iTwsCount; i++)
                    {
                        DataRow drRslt = dtRslt.NewRow();
                        drRslt["LOTID"] = sLotID;
                        drRslt["REEL_NO"] = (i + 1).ToString();
                        drRslt["EQPT_LOAD_WEIGHT"] = DBNull.Value;
                        drRslt["LOAD_WEIGHT"] = DBNull.Value;

                        dtRslt.Rows.Add(drRslt);
                    }
                }

                Util.GridSetData(dgTWS, dtRslt, FrameOperation);

                // 설비값을 자동으로 작업자 확인 값으로 입력 및 설비값 저장확인
                isSaveTWS_Loading = true;
                foreach (C1.WPF.DataGrid.DataGridRow _iRow in dgTWS.Rows)
                {
                    _iRow.DataItem.SetValue("UNIT", "㎎/25㎠");

                    if (_iRow.DataItem.GetValue("LOAD_WEIGHT").Equals(DBNull.Value))
                    {
                        _iRow.DataItem.SetValue("LOAD_WEIGHT", _iRow.DataItem.GetValue("EQPT_LOAD_WEIGHT"));
                        isSaveTWS_Loading = false;
                    }
                }

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private int GetTWS_Count(string sLotID)
        {
            int iTWS_Count = 0;
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                IndataTable.Columns.Add("USE_FLAG", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Indata["PROD_VER_CODE"] = _VERSION;
                Indata["USE_FLAG"] = "Y";
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_PRDT_CONV_RATE_V01", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                {
                    iTWS_Count = Convert.ToInt32(result.Rows[0]["LANE_QTY"]) * Convert.ToInt32(result.Rows[0]["LANE_PTN_QTY"]);
                }
            }
            catch (Exception ex) { iTWS_Count = Int32.Parse(Util.NVC(txtLaneQty.Value))*2; }

            return iTWS_Count;
        }

        private int GetLANE_PTN_QTY(string sLotID)
        {
            int iLANE_PTN_QT = 0;
            try
            {
                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("AREAID", typeof(string));
                IndataTable.Columns.Add("PRODID", typeof(string));
                IndataTable.Columns.Add("PROD_VER_CODE", typeof(string));
                IndataTable.Columns.Add("USE_FLAG", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["AREAID"] = LoginInfo.CFG_AREA_ID;
                Indata["PRODID"] = Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[PRODLOT_GRID.SelectedIndex].DataItem, "PRODID"));
                Indata["PROD_VER_CODE"] = _VERSION;
                Indata["USE_FLAG"] = "Y";
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_PRDT_CONV_RATE_V01", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                {
                    iLANE_PTN_QT = Convert.ToInt32(result.Rows[0]["LANE_PTN_QTY"]);
                }
            }
            catch (Exception ex) { iLANE_PTN_QT = 2; }

            return iLANE_PTN_QT;
        }

        private void rbRollDirectCheck(object sender, RoutedEventArgs e)
        {
            RadioButton rb = sender as RadioButton;
            //choiceTextBlock.Text = "You chose: " + rb.GroupName + ": " + rb.Name;

            string rbName = rb.Name;
            bool isChecked = rb.IsChecked.Value;
            if (isTWS_LOADING_TRACKING)
            {
                /* GroupName (RadioButtonName1 / RadioButtonName2)
                  1 : rollout_radio ( rbRolloutUp / rbRolloutDown )
                  2 : rollin_radio  ( rbRollinUp  / rbRollinDown  )
                  3 : input_roll_lane_radio ( rbInputRollLaneFoward / rbInputRollLaneReverse )
                  4 (자동산출) : output_roll_lane_radio ( rbOutputRollLaneFoward / rbOutputRollLaneReverse )
                */

                //RollOptions _RollOptions = new RollOptions();
                //LGC.GMES.MES.ControlsLibrary.MessageBox.Show(string.Format("RollIn : {0}, RollOut : {1}, RollLaneIn : {3}, , RollLaneOut : {4}", _RollOptions.RollIn, _RollOptions.RollOut, _RollOptions.RollLaneIn, _RollOptions.RollLaneOut));
                UcDataCollect thisUDC = grdDataCollect.Children[0] as UcDataCollect;

                RadioButton rbRolloutUp = thisUDC.rbRolloutUp;
                RadioButton rbRolloutDown = thisUDC.rbRolloutDown;
                RadioButton rbRollinUp = thisUDC.rbRollinUp;
                RadioButton rbRollinDown = thisUDC.rbRollinDown;

                RadioButton rbInputRollLaneForward = thisUDC.rbInputRollLaneForward;
                RadioButton rbInputRollLaneReverse = thisUDC.rbInputRollLaneReverse;
                RadioButton rbOutputRollLaneForward = thisUDC.rbOutputRollLaneForward;
                RadioButton rbOutputRollLaneReverse = thisUDC.rbOutputRollLaneReverse;

                //if (isSaveTWS_LOADING_TRACKING == true)
                {
                    if (isAutoSetRollDir == true)
                    {
                        //자동으로 세팅된 값입니다 바꾸시겠습니까 ?
                        Util.MessageConfirm("SFU3901", (result) =>
                        {
                            if (result != MessageBoxResult.OK)
                            {
                                isAutoSetRollDir = false;

                                rb.IsChecked = !rb.IsChecked.Value;
                                if (rbName == "rbRolloutUp")
                                    rbRolloutDown.IsChecked = !rbRolloutDown.IsChecked;
                                else if (rbName == "rbRolloutDown")
                                    rbRolloutUp.IsChecked = !rbRolloutUp.IsChecked;
                                else if (rbName == "rbRollinUp")
                                    rbRollinDown.IsChecked = !rbRollinDown.IsChecked;
                                else if (rbName == "rbRollinDown")
                                    rbRollinUp.IsChecked = !rbRollinUp.IsChecked;
                                else if (rbName == "rbInputRollLaneForward")
                                    rbInputRollLaneReverse.IsChecked = !rbInputRollLaneReverse.IsChecked;
                                else if (rbName == "rbInputRollLaneReverse")
                                    rbInputRollLaneForward.IsChecked = !rbInputRollLaneForward.IsChecked;

                                isAutoSetRollDir = true;

                                return;
                            }
                            else
                            {
                                isAutoSetRollDir = false;
                            }
                        });
                    }
                }

                if ((rbRolloutUp.IsChecked.Value || rbRolloutDown.IsChecked.Value)
                    && (rbRollinUp.IsChecked.Value || rbRollinDown.IsChecked.Value)
                    && (rbInputRollLaneForward.IsChecked.Value || rbInputRollLaneReverse.IsChecked.Value))
                {
                    string strRollout = "", strRollin="", strInputRollLane="" ;

                    if (rbRolloutUp.IsChecked.Value == true)        strRollout = "U";
                    else if (rbRolloutDown.IsChecked.Value == true) strRollout = "D";

                    if (rbRollinUp.IsChecked.Value == true)         strRollin = "U";
                    else if (rbRollinDown.IsChecked.Value == true)  strRollin = "D";

                    if (rbInputRollLaneForward.IsChecked.Value == true)        strInputRollLane = "F";
                    else if (rbInputRollLaneReverse.IsChecked.Value == true)  strInputRollLane = "R";

                    if (string.IsNullOrEmpty(strRollout) || string.IsNullOrEmpty(strRollin) || string.IsNullOrEmpty(strInputRollLane))
                        return;
                    else
                    {
                        string[] sAttribute = { strInputRollLane, strRollin, strRollout };
                        DataTable dtResult = GetAreaCommoncodeAttr("ELTR_TWS_LANE_POS_DIR_RULE", null, sAttribute);

                        if (dtResult != null && dtResult.Rows.Count > 0)
                        {
                            if (dtResult.Rows[0]["ATTR4"].ToString() == "F") rbOutputRollLaneForward.IsChecked = true;
                            if (dtResult.Rows[0]["ATTR4"].ToString() == "R") rbOutputRollLaneReverse.IsChecked = true;
                        }
                    }
                }
                else return;
                
            }
        }

        private DataTable GetAreaCommoncodeAttr(string sCodeType, string sCodeName, string[] sAttribute)
        {
            try
            {
                string[] sColumnArr = { "ATTR1", "ATTR2", "ATTR3", "ATTR4", "ATTR5" };

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("AREAID", typeof(string));
                RQSTDT.Columns.Add("COM_TYPE_CODE", typeof(string));
                RQSTDT.Columns.Add("COM_CODE", typeof(string));
                RQSTDT.Columns.Add("USE_FLAG", typeof(string));
                for (int i = 0; i < sColumnArr.Length; i++)
                    RQSTDT.Columns.Add(sColumnArr[i], typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["AREAID"] = LoginInfo.CFG_AREA_ID;
                dr["COM_TYPE_CODE"] = sCodeType;
                dr["COM_CODE"] = !string.IsNullOrEmpty(sCodeName) ? sCodeName : null;
                dr["USE_FLAG"] = 'Y';
                for (int i = 0; i < sAttribute.Length; i++)
                    dr[sColumnArr[i]] = string.IsNullOrEmpty(sAttribute[i]) ? (object)DBNull.Value : sAttribute[i];
                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_ATTR", "RQSTDT", "RSLTDT", RQSTDT);

                return dtResult;
            }
            catch (Exception ex) { }

            return null;
        }

        private void SetTWS_LOADING_TRACKING()
        {
            try
            {
                UcDataCollect thisUDC     = grdDataCollect.Children[0] as UcDataCollect;

                RadioButton rbRolloutUp   = thisUDC.rbRolloutUp;
                RadioButton rbRolloutDown = thisUDC.rbRolloutDown;
                RadioButton rbRollinUp    = thisUDC.rbRollinUp;
                RadioButton rbRollinDown  = thisUDC.rbRollinDown;

                RadioButton rbInputRollLaneForward  = thisUDC.rbInputRollLaneForward;
                RadioButton rbInputRollLaneReverse  = thisUDC.rbInputRollLaneReverse;
                RadioButton rbOutputRollLaneForward = thisUDC.rbOutputRollLaneForward;
                RadioButton rbOutputRollLaneReverse = thisUDC.rbOutputRollLaneReverse;

                if ((rbOutputRollLaneReverse.IsChecked.HasValue || rbOutputRollLaneForward.IsChecked.HasValue) == false) return;

                string strRollout = "", strRollin = "", strInputRollLane = "", strOutputRollLane = "";

                if (rbRolloutUp.IsChecked.Value == true) strRollout = "U";
                else if (rbRolloutDown.IsChecked.Value == true) strRollout = "D";

                if (rbRollinUp.IsChecked.Value == true) strRollin = "U";
                else if (rbRollinDown.IsChecked.Value == true) strRollin = "D";

                if (rbInputRollLaneForward.IsChecked.Value == true) strInputRollLane = "F";
                else if (rbInputRollLaneReverse.IsChecked.Value == true) strInputRollLane = "R";

                if (rbOutputRollLaneForward.IsChecked.Value == true) strOutputRollLane = "F";
                else if (rbOutputRollLaneReverse.IsChecked.Value == true) strOutputRollLane = "R";

                if (string.IsNullOrEmpty(strRollout) && string.IsNullOrEmpty(strRollin)) // && string.IsNullOrEmpty(strInputRollLane) && string.IsNullOrEmpty(strOutputRollLane))
                    return;


                //비즈 호출하여 값을 세팅한다.
                DataSet inDataSet = new DataSet();

                int iLANE_PTN_QTY = GetLANE_PTN_QTY(_LOTID);

                DataTable rqstDt = inDataSet.Tables.Add("INDATA");
                rqstDt.Columns.Add("AREAID", typeof(string));
                rqstDt.Columns.Add("LOTID", typeof(string));
                rqstDt.Columns.Add("PROCID", typeof(string));
                rqstDt.Columns.Add("INPUT_SECTION_ROLL_DIRCTN", typeof(string));
                rqstDt.Columns.Add("EM_SECTION_ROLL_DIRCTN", typeof(string));
                rqstDt.Columns.Add("INPUT_SECTION_ROLL_LANE_DIRCTN", typeof(string));
                rqstDt.Columns.Add("EM_SECTION_ROLL_LANE_DIRCTN", typeof(string));
                rqstDt.Columns.Add("LOTIDPR", typeof(string));
                rqstDt.Columns.Add("LANE_NO", typeof(Int32));
                rqstDt.Columns.Add("LANE_PTN_QT", typeof(Int32));
                rqstDt.Columns.Add("USERID", typeof(string));

                DataRow rqstDr = null;
                if (string.Equals(procId, Process.SLITTING))
                {
                    //Slitting 공정로직
                    DataTable dt = ((DataView)POSTHOLD_GRID.ItemsSource).Table;

                    if (REMARK_GRID.GetRowCount() < 1) return;

                    // REMARK_GRID 에서 0 은 공통항목이므로 1부터 시작
                    for (int i = 1; i < dt.Rows.Count; i++)
                    {
                        rqstDr = rqstDt.NewRow();
                        rqstDr["AREAID"] = LoginInfo.CFG_AREA_ID;
                        rqstDr["LOTID"] = Util.NVC(dt.Rows[i]["LOTID"]);
                        rqstDr["PROCID"] = procId;
                        rqstDr["INPUT_SECTION_ROLL_DIRCTN"] = strRollin;
                        rqstDr["EM_SECTION_ROLL_DIRCTN"] = strRollout;
                        rqstDr["INPUT_SECTION_ROLL_LANE_DIRCTN"] = strInputRollLane;
                        rqstDr["EM_SECTION_ROLL_LANE_DIRCTN"] = strOutputRollLane;
                        rqstDr["LOTIDPR"] = _LOTIDPR;
                        rqstDr["LANE_NO"] = Util.NVC_NUMBER(dt.Rows[i]["LANENUM"].ToString().Trim().Split(' ')[0]);
                        rqstDr["LANE_PTN_QT"] = iLANE_PTN_QTY;
                        rqstDr["USERID"] = LoginInfo.USERID;

                        rqstDt.Rows.Add(rqstDr);
                    }
                }
                else
                {
                    rqstDr = rqstDt.NewRow();
                    rqstDr["AREAID"] = LoginInfo.CFG_AREA_ID;
                    rqstDr["LOTID"] = _LOTID;
                    rqstDr["PROCID"] = procId;
                    rqstDr["INPUT_SECTION_ROLL_DIRCTN"] = strRollin;
                    rqstDr["EM_SECTION_ROLL_DIRCTN"] = strRollout;
                    rqstDr["INPUT_SECTION_ROLL_LANE_DIRCTN"] = strInputRollLane;
                    rqstDr["EM_SECTION_ROLL_LANE_DIRCTN"] = strOutputRollLane;
                    rqstDr["LOTIDPR"] = _LOTIDPR;
                    //rqstDr["LANE_NO"]
                    rqstDr["USERID"] = LoginInfo.USERID;

                    rqstDt.Rows.Add(rqstDr);
                }

                new ClientProxy().ExecuteService_Multi("BR_PRD_REG_TB_SFC_WIP_TWS_LOAD", "INDATA", null, (result, ex) =>
                {
                    if (ex != null)
                    {
                        if (isPassSaveTWS_LOADING_TRACKING)
                        { 
                            SetRollDir();
                        }
                        else
                            Util.MessageException(ex);

                        return;
                    }

                    isSaveTWS_LOADING_TRACKING = true;

                    SetRollDir();

                }, inDataSet);
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void GetTWS_LOADING_TRACKING(string sLotID, bool isLOTID_PR = false)
        {
            try
            {
                UcDataCollect thisUDC     = grdDataCollect.Children[0] as UcDataCollect;

                RadioButton rbRolloutUp   = thisUDC.rbRolloutUp;
                RadioButton rbRolloutDown = thisUDC.rbRolloutDown;
                RadioButton rbRollinUp    = thisUDC.rbRollinUp;
                RadioButton rbRollinDown  = thisUDC.rbRollinDown;

                RadioButton rbInputRollLaneForward  = thisUDC.rbInputRollLaneForward;
                RadioButton rbInputRollLaneReverse  = thisUDC.rbInputRollLaneReverse;
                RadioButton rbOutputRollLaneForward = thisUDC.rbOutputRollLaneForward;
                RadioButton rbOutputRollLaneReverse = thisUDC.rbOutputRollLaneReverse;

                // 모든 라디오버튼 초기화
                {
                    rbInputRollLaneForward.IsChecked = false;
                    rbInputRollLaneReverse.IsChecked = false;
                    rbOutputRollLaneForward.IsChecked = false;
                    rbOutputRollLaneReverse.IsChecked = false;

                    rbRollinUp.IsChecked    = false;
                    rbRollinDown.IsChecked  = false;
                    rbRolloutUp.IsChecked   = false;
                    rbRolloutDown.IsChecked = false;
                }

                if (string.IsNullOrEmpty(sLotID) == true) return;

                DataTable IndataTable = new DataTable();
                IndataTable.Columns.Add("LOTID", typeof(string));

                DataRow Indata = IndataTable.NewRow();
                Indata["LOTID"] = sLotID;
                IndataTable.Rows.Add(Indata);

                DataTable result = new ClientProxy().ExecuteServiceSync("DA_SEL_TB_SFC_WIP_TWS_LOAD", "INDATA", "RSLTDT", IndataTable);

                if (result != null && result.Rows.Count > 0)
                {
                    isAutoSetRollDir = false;

                    string strRollout = "", strRollin = "", strInputRollLane = "", strOutputRollLane = "";

                    strInputRollLane = Util.NVC(result.Rows[0]["INPUT_SECTION_ROLL_LANE_DIRCTN"]);
                    strRollin = Util.NVC(result.Rows[0]["INPUT_SECTION_ROLL_DIRCTN"]);
                    strRollout = Util.NVC(result.Rows[0]["EM_SECTION_ROLL_DIRCTN"]);
                    strOutputRollLane = Util.NVC(result.Rows[0]["EM_SECTION_ROLL_LANE_DIRCTN"]);

                    //Util.NVC(DataTableConverter.GetValue(PRODLOT_GRID.Rows[iRow].DataItem, "WIPSEQ"));

                    // 이전 LOT 인 경우 방향 전환(Output->Input) 
                    if (isLOTID_PR == true || _WIPSEQ.Equals(Util.NVC(result.Rows[0]["LASTWIPSEQ"])) == false)
                    {
                        if (strOutputRollLane.Equals("F"))      rbInputRollLaneForward.IsChecked = true;
                        else if (strOutputRollLane.Equals("R")) rbInputRollLaneReverse.IsChecked = true;

                        return;
                    }
                    else
                    {
                        if (strInputRollLane.Equals("F"))      rbInputRollLaneForward.IsChecked = true;
                        else if (strInputRollLane.Equals("R")) rbInputRollLaneReverse.IsChecked = true;

                        if (strOutputRollLane.Equals("F"))      rbOutputRollLaneForward.IsChecked = true;
                        else if (strOutputRollLane.Equals("R")) rbOutputRollLaneReverse.IsChecked = true;

                        if (string.IsNullOrEmpty(strRollin) || string.IsNullOrEmpty(strRollout)
                            || string.IsNullOrEmpty(strInputRollLane) || string.IsNullOrEmpty(strOutputRollLane))
                            isSaveTWS_LOADING_TRACKING = false;
                        else
                            isSaveTWS_LOADING_TRACKING = true;
                    }


                    if (strRollin.Equals("U"))      rbRollinUp.IsChecked = true;
                    else if (strRollin.Equals("D")) rbRollinDown.IsChecked = true;

                    if (strRollout.Equals("U"))      rbRolloutUp.IsChecked = true;
                    else if (strRollout.Equals("D")) rbRolloutDown.IsChecked = true;

                }
            }
            catch (Exception ex) { }
        }

        private void cboEquipmentSegment_SelectedValueChanged(object sender, PropertyChangedEventArgs<object> e)
        {
            C1ComboBox cbobox = sender as C1ComboBox;

            if (cbobox != null && cbobox.SelectedValue.Equals("") || cbobox.SelectedValue.Equals("SELECT")) return;

            CheckLineUseTWS(cbobox.SelectedValue.ToString());
            SetVisibleObject_TWS();
        }

        private void CheckLineUseTWS(string sEQSGID)
        {
            try
            {
                isTWS_LOADING_TRACKING = false;
                isPassSaveTWS_LOADING_TRACKING = false;
                isAutoSetRollDir = false;

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("EQSGID", typeof(string));
 
                DataRow dr = RQSTDT.NewRow();
                dr["EQSGID"] = sEQSGID;

                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_TB_MMD_AREA_COM_CODE_TWS_LINE", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    isTWS_LOADING_TRACKING = true;
                    if (dtResult.Rows[0]["ATTR1"].ToString() == "P") isPassSaveTWS_LOADING_TRACKING = true;
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }

        private void SetVisibleObject_TWS()
        {
            if (isTWS_LOADING_TRACKING == true)
            {
                //TWS_Loading 
                if (string.Equals(procId, Process.COATING))
                    (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility = Visibility.Visible;
                else
                    (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility = Visibility.Collapsed;

                //ROLL방향 - 투입롤 Lane 방향, 배출롤 Lane 방향 표시
                if (string.Equals(procId, Process.INS_COATING) || string.Equals(procId, Process.ROLL_PRESSING)
                    || string.Equals(procId, Process.LASER_ABLATION) || string.Equals(procId, Process.SLITTING)
                    || string.Equals(procId, Process.HEAT_TREATMENT))
                {
                    Grid gd = (grdDataCollect.Children[0] as UcDataCollect).gdRollDirection;
                    gd.RowDefinitions[1].Height = new GridLength(0, GridUnitType.Auto);
                    gd.RowDefinitions[2].Height = new GridLength(13, GridUnitType.Pixel);
                    gd.RowDefinitions[6].Height = new GridLength(13, GridUnitType.Pixel);
                    gd.RowDefinitions[7].Height = new GridLength(0, GridUnitType.Auto);
                    gd.RowDefinitions[8].Height = new GridLength(13, GridUnitType.Pixel);
                    gd.RowDefinitions[9].Height = new GridLength(0, GridUnitType.Auto);
                }
                else
                {
                    Grid gd = (grdDataCollect.Children[0] as UcDataCollect).gdRollDirection;
                    gd.RowDefinitions[1].Height = new GridLength(0);
                    gd.RowDefinitions[2].Height = new GridLength(0);
                    gd.RowDefinitions[6].Height = new GridLength(0);
                    gd.RowDefinitions[7].Height = new GridLength(0);
                    gd.RowDefinitions[8].Height = new GridLength(0);
                    gd.RowDefinitions[9].Height = new GridLength(0);
                }
            }
            else
            {
                (grdDataCollect.Children[0] as UcDataCollect).tiTWS_Loading.Visibility = Visibility.Collapsed;

                Grid gd = (grdDataCollect.Children[0] as UcDataCollect).gdRollDirection;
                gd.RowDefinitions[1].Height = new GridLength(0);
                gd.RowDefinitions[2].Height = new GridLength(0);
                gd.RowDefinitions[6].Height = new GridLength(0);
                gd.RowDefinitions[7].Height = new GridLength(0);
                gd.RowDefinitions[8].Height = new GridLength(0);
                gd.RowDefinitions[9].Height = new GridLength(0);
            }
        }
        #endregion

        #region [E20240502-001076] Mixer 원재료 Tracking 기능 개선 : Mixer 원재료 Lot 누락 Validation 기능 적용 여부
        /// <summary>
        /// Mixer 원재료 Lot 누락 Validation 기능 적용 여부
        /// </summary>
        private void CheckUseElecMtrlLotValidation()
        {
            try
            {
                _isELEC_MTRL_LOT_VALID_YN = false;

                DataTable RQSTDT = new DataTable();
                RQSTDT.TableName = "RQSTDT";
                RQSTDT.Columns.Add("LANGID", typeof(string));
                RQSTDT.Columns.Add("CMCDTYPE", typeof(string));
                RQSTDT.Columns.Add("CMCODE", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LANGID"] = LoginInfo.LANGID;
                dr["CMCDTYPE"] = "ELEC_MTRL_LOT_VALID_YN";
                dr["CMCODE"] = LoginInfo.CFG_AREA_ID;

                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("DA_BAS_SEL_COMMONCODE_TBL", "RQSTDT", "RSLTDT", RQSTDT);

                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    if (dtResult != null && dtResult.Rows.Count > 0)
                    {
                        if (dtResult.Rows[0]["ATTRIBUTE1"].ToString().Equals("Y"))
                            _isELEC_MTRL_LOT_VALID_YN = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
            }
        }
        /// <summary>
        /// Mixer 원재료 Lot 누락 존재 유무 Check
        /// </summary>
        /// <returns></returns>
        private bool CheckMissedElecMtrlLot()
        {
            try
            {
                DataTable RQSTDT = new DataTable();
                RQSTDT.Columns.Add("LOTID", typeof(string));
                RQSTDT.Columns.Add("WOID", typeof(string));
                RQSTDT.Columns.Add("EQPTID", typeof(string));
                RQSTDT.Columns.Add("PRODID", typeof(string));
                RQSTDT.Columns.Add("PROCID", typeof(string));

                DataRow dr = RQSTDT.NewRow();
                dr["LOTID"] = Util.NVC(_LOTID);
                dr["WOID"] = Util.NVC(_WORKORDER);
                dr["EQPTID"] = Util.NVC(_EQPTID);
                dr["PRODID"] = Util.NVC(_PRODID);
                dr["PROCID"] = Util.NVC(procId);

                RQSTDT.Rows.Add(dr);

                DataTable dtResult = new ClientProxy().ExecuteServiceSync("BR_PRD_CHK_INPUT_LOT_MISSED", "RQSTDT", "RSLTDT", RQSTDT);

                //미 투입자재 존재하면
                if (dtResult != null && dtResult.Rows.Count > 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }

            }
            catch (Exception ex)
            {
                Util.MessageException(ex);
                return false;
            }
        }
        private void PopupInputMaterial()
        {

            CMM_ELEC_MISSED_MTRL_INPUT_LOT popupInputMaterial = new CMM_ELEC_MISSED_MTRL_INPUT_LOT { FrameOperation = FrameOperation };

            if (popupInputMaterial != null)
            {
                // [E20240712-001591]
                //object[] Parameters = new object[5];
                object[] Parameters = new object[6];

                Parameters[0] = Util.NVC(_LOTID);
                Parameters[1] = Util.NVC(_WORKORDER);
                Parameters[2] = Util.NVC(_EQPTID);
                Parameters[3] = Util.NVC(procId);
                Parameters[4] = Util.NVC(_PRODID);

                // [E20240712-001591]
                Parameters[5] = "D";

                C1WindowExtension.SetParameters(popupInputMaterial, Parameters);

                popupInputMaterial.Closed += new EventHandler(PopupInputMaterial_Closed);
                this.Dispatcher.BeginInvoke(new Action(() => popupInputMaterial.ShowModal()));
                popupInputMaterial.BringToFront();
            }
        }

        private void PopupInputMaterial_Closed(object sender, EventArgs e)
        {
            CMM_ELEC_MISSED_MTRL_INPUT_LOT popup = sender as CMM_ELEC_MISSED_MTRL_INPUT_LOT;

            if (popup != null && popup.DialogResult == MessageBoxResult.OK)
            {
                if (popup.bSaveConfirm == true) // PopUp에서 저장을 했을 경우 투입자재 재조회
                {
                    GetMaterialSummary(_LOTID, _WORKORDER);
                }
            }
        }

        #endregion

        #region [E20240715-000063] 전극공정진척 Roll in & Roll out 방향 기본 세팅값을 시스템 상 미리 표기
        private void SetTWS_RULE_PROCESS_EQPT_ROLL_DIR(string ProcessID, string sLotID)
        {
            if (string.IsNullOrEmpty(ProcessID) || string.IsNullOrEmpty(sLotID)) return;

            UcDataCollect thisUDC = grdDataCollect.Children[0] as UcDataCollect;

            RadioButton rbRolloutUp   = thisUDC.rbRolloutUp;
            RadioButton rbRolloutDown = thisUDC.rbRolloutDown;
            RadioButton rbRollinUp    = thisUDC.rbRollinUp;
            RadioButton rbRollinDown  = thisUDC.rbRollinDown;
            RadioButton rbInputRollLaneForward = thisUDC.rbInputRollLaneForward;
            RadioButton rbInputRollLaneReverse = thisUDC.rbInputRollLaneReverse;

            string sComeCode = string.Format("{0}_{1}", ProcessID, sLotID.Substring(1,1));
            string strRollin = "", strRollout = "";

            DataTable dtResult = _Util.GetAreaCommonCodeUse("TWS_RULE_PROCESS_EQPT_ROLL_DIR", sComeCode);

            if (dtResult != null && dtResult.Rows.Count > 0)
            {
                strRollin = dtResult.Rows[0]["ATTR1"].ToString();
                strRollout = dtResult.Rows[0]["ATTR2"].ToString();

                // 자동 세팅값과 일치할 때 자동세팅한 것으로 간주한다
                if ((string.IsNullOrEmpty(strRollin) == false) && (string.IsNullOrEmpty(strRollout) == false))
                {
                    bool check1 = false, check2 = false;

                    if (strRollin == "U" && rbRollinUp.IsChecked == true) check1 = true;
                    if (strRollin == "D" && rbRollinDown.IsChecked == true) check1 = true;
                    if (strRollout == "U" && rbRolloutUp.IsChecked == true) check2 = true;
                    if (strRollout == "D" && rbRolloutDown.IsChecked == true) check2 = true;

                    if (check1 & check2)
                    {
                        isAutoSetRollDir = true;
                    }
                    else
                    {
                        // 자동세팅을 무시하고 저장된 값으로 간주한다
                        isAutoSetRollDir = false;
                    }
                }

                //저장된 롤 방향이 있으면 자동세팅하지 않는다
                if (isAutoSetRollDir == false && isSaveTWS_LOADING_TRACKING == false)
                {

                    if (string.IsNullOrEmpty(strRollin) == false)
                    {
                        if (strRollin == "U")      rbRollinUp.IsChecked = true;
                        else if (strRollin == "D") rbRollinDown.IsChecked = true;
                    }

                    if (string.IsNullOrEmpty(strRollout) == false)
                    {
                        if (strRollout == "U")      rbRolloutUp.IsChecked = true;
                        else if (strRollout == "D") rbRolloutDown.IsChecked = true;
                    }

                    if ((rbRolloutUp.IsChecked.Value || rbRolloutDown.IsChecked.Value)
                        && (rbRollinUp.IsChecked.Value || rbRollinDown.IsChecked.Value)
                        && (rbInputRollLaneForward.IsChecked.Value || rbInputRollLaneReverse.IsChecked.Value))
                    {
                        isAutoSetRollDir = true;
                    }
                }
            }
        }
        #endregion
    }
}
